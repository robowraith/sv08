===== Config file =====
[save_variables]
filename = ~/demon_vars.cfg

[gcode_macro _KAMP_Settings]
description = This macro contains all adjustable settings for KAMP
variable_verbose_enable = True
variable_purge_height = 0.8
variable_tip_distance = 5
variable_purge_margin = 20
variable_purge_amount = 30
variable_flow_rate = 12
variable_smart_park_height = 10
gcode = 
	
	{action_respond_info(" Running the KAMP_Settings macro does nothing, it is only used for storing KAMP settings. ")}

[gcode_macro LINE_PURGE]
description = A purge macro that adapts to be near your actual printed objects
gcode = 
	
	{% set travel_speed = (printer.toolhead.max_velocity) * 30 | float %}
	{% set cross_section = printer.configfile.settings.extruder.max_extrude_cross_section | float %}
	
	
	{% if printer.firmware_retraction is defined %}
	{% set RETRACT = G10 | string %}
	{% set UNRETRACT = G11 | string %}
	{% else %}
	{% set RETRACT = 'G1 E-.5 F2100' | string %}
	{% set UNRETRACT = 'G1 E.5 F2100' | string %}
	{% endif %}
	
	
	{% set verbose_enable = printer["gcode_macro _KAMP_Settings"].verbose_enable | abs %}
	{% set purge_height = printer["gcode_macro _KAMP_Settings"].purge_height | float %}
	{% set tip_distance = printer["gcode_macro _KAMP_Settings"].tip_distance | float %}
	{% set purge_margin = printer["gcode_macro _KAMP_Settings"].purge_margin | float %}
	{% set purge_amount = printer["gcode_macro _KAMP_Settings"].purge_amount | float %}
	{% set flow_rate = printer["gcode_macro _KAMP_Settings"].flow_rate | float %}
	
	
	
	{% set all_points = printer.exclude_object.objects | map(attribute='polygon') | sum(start=[]) %}
	{% set purge_x_min = (all_points | map(attribute=0) | min | default(0)) %}
	{% set purge_x_max = (all_points | map(attribute=0) | max | default(0)) %}
	{% set purge_y_min = (all_points | map(attribute=1) | min | default(0)) %}
	{% set purge_y_max = (all_points | map(attribute=1) | max | default(0)) %}
	
	{% set purge_x_center = ([((purge_x_max + purge_x_min) / 2) - (purge_amount / 2), 0] | max) %}
	{% set purge_y_center = ([((purge_y_max + purge_y_min) / 2) - (purge_amount / 2), 0] | max) %}
	
	{% set purge_x_origin = ([purge_x_min - purge_margin, 0] | max) %}
	{% set purge_y_origin = ([purge_y_min - purge_margin, 0] | max) %}
	
	
	{% set purge_move_speed = (flow_rate / 5.0) * 60 | float %}
	
	{% if cross_section < 5 %}
	
	{action_respond_info("[Extruder] max_extrude_cross_section is insufficient for purge, please set it to 5 or greater. Purge skipped.")}
	
	{% else %}
	
	{% if verbose_enable == True %}
	
	{action_respond_info("Moving filament tip {}mms".format(
	(tip_distance),
	)) }
	{% endif %}
	
	{% if printer.firmware_retraction is defined %}
	{action_respond_info("KAMP purge is using firmware retraction.")}
	{% else %}
	{action_respond_info("KAMP purge is not using firmware retraction, it is recommended to configure it.")}
	{% endif %}
	
	{% if purge_y_origin > 0 %}
	
	{action_respond_info("KAMP purge starting at {}, {} and purging {}mm of filament, requested flow rate is {}mm3/s.".format(
	(purge_x_center),
	(purge_y_origin),
	(purge_amount),
	(flow_rate),
	)) }
	
	{% else %}
	
	{action_respond_info("KAMP purge starting at {}, {} and purging {}mm of filament, requested flow rate is {}mm3/s.".format(
	(purge_x_origin),
	(purge_y_center),
	(purge_amount),
	(flow_rate),
	)) }
	
	{% endif %}
	
	SAVE_GCODE_STATE NAME=Prepurge_State
	
	{% if purge_y_origin > 0 %}
	
	G92 E0
	G0 F{travel_speed}
	G90
	G0 X{purge_x_center} Y{purge_y_origin}
	G0 Z{purge_height}
	M83
	G1 E{tip_distance} F{purge_move_speed}
	G1 X{purge_x_center + purge_amount} E{purge_amount} F{purge_move_speed}
	{RETRACT}
	G0 X{purge_x_center + purge_amount + 10} F{travel_speed}
	G92 E0
	M82
	G0 Z{purge_height * 2} F{travel_speed}
	
	{% else %}
	
	G92 E0
	G0 F{travel_speed}
	G90
	G0 X{purge_x_origin} Y{purge_y_center}
	G0 Z{purge_height}
	M83
	G1 E{tip_distance} F{purge_move_speed}
	G1 Y{purge_y_center + purge_amount} E{purge_amount} F{purge_move_speed}
	{RETRACT}
	G0 Y{purge_y_center + purge_amount + 10} F{travel_speed}
	G92 E0
	M82
	G0 Z{purge_height * 2} F{travel_speed}
	
	{% endif %}
	
	RESTORE_GCODE_STATE NAME=Prepurge_State
	
	{% endif %}

[gcode_macro SMART_PARK]
description = Parks your printhead near the print area for pre-print hotend heating.
gcode = 
	
	{% set kamp_settings = printer["gcode_macro _KAMP_Settings"] %}
	{% set z_height = kamp_settings.smart_park_height | float %}
	{% set purge_margin = kamp_settings.purge_margin | float %}
	{% set verbose_enable = kamp_settings.verbose_enable | abs %}
	{% set center_x = printer.toolhead.axis_maximum.x / 2 | float %}
	{% set center_y = printer.toolhead.axis_maximum.y / 2 | float %}
	{% set axis_minimum_x = printer.toolhead.axis_minimum.x | float %}
	{% set axis_minimum_y = printer.toolhead.axis_minimum.y | float %}
	{% set all_points = printer.exclude_object.objects | map(attribute='polygon') | sum(start=[]) %}
	{% set x_min = all_points | map(attribute=0) | min | default(center_x) %}
	{% set y_min = all_points | map(attribute=1) | min | default(center_y) %}
	{% set travel_speed = (printer.toolhead.max_velocity) * 30 | float %}
	
	{% if purge_margin > 0 and x_min != center_x and y_min != center_y %}
	{% set x_min = [ x_min - purge_margin , x_min ] | min %}
	{% set y_min = [ y_min - purge_margin , y_min ] | min %}
	{% set x_min = [ x_min , axis_minimum_x ] | max %}
	{% set y_min = [ y_min , axis_minimum_y ] | max %}
	{% endif %}
	
	
	{% if verbose_enable == True %}
	
	{ action_respond_info("Smart Park location: {},{}.".format(
	(x_min),
	(y_min),
	)) }
	
	{% endif %}
	
	SAVE_GCODE_STATE NAME=Presmartpark_State
	
	G90
	{% if printer.toolhead.position.z < z_height %}
	G0 Z{z_height}
	{% endif %}
	G0 X{x_min} Y{y_min} F{travel_speed}
	G0 Z{z_height}
	
	RESTORE_GCODE_STATE NAME=Presmartpark_State

[gcode_macro _WAIT_Variable]
variable_count = 300
variable_duration = 2
variable_waiting = False
gcode = 

[delayed_gcode WAIT_Delayed]
gcode = 
	{% set count = printer["gcode_macro _WAIT_Variable"].count|int %}
	{% set duration = printer["gcode_macro _WAIT_Variable"].duration|int %}
	M117 Heat soak Timer... {((duration * count) / 60)|round(1)} minutes left.
	SET_GCODE_VARIABLE MACRO=_WAIT_Variable VARIABLE=count VALUE={count-1}
	{% if count > 0 %} _WAIT_Loop  {% endif %}
	{% if count == 0 %}
	
	SET_GCODE_VARIABLE MACRO=_WAIT_Variable VARIABLE=waiting VALUE=False
	M118 Reached the end, do final action
	
	{% endif %}

[gcode_macro _WAIT_Loop]
gcode = 
	{% set count = printer["gcode_macro _WAIT_Variable"].count|int %}
	{% set duration = printer["gcode_macro _WAIT_Variable"].duration|int %}
	UPDATE_DELAYED_GCODE ID=WAIT_Delayed DURATION={duration}
	{% if  count % 2 == 0 %}
	SET_LED LED=Screen_Colour INDEX=1 RED=1 GREEN=0.2392 BLUE=0 WHITE=0
	SET_LED LED=Screen_Colour INDEX=2 RED=1 GREEN=0.2392 BLUE=0 WHITE=0
	SET_LED LED=Screen_Colour INDEX=3 RED=0.051 GREEN=0.0118 BLUE=0 WHITE=0
	
	
	{% else %}
	SET_LED LED=Screen_Colour INDEX=1 RED=1 GREEN=0.2392 BLUE=0 WHITE=0
	SET_LED LED=Screen_Colour INDEX=2 RED=0.051 GREEN=0.0118 BLUE=0 WHITE=0
	SET_LED LED=Screen_Colour INDEX=3 RED=1 GREEN=0.2392 BLUE=0 WHITE=0
	
	
	
	
	{% endif %}

[gcode_macro TIMER_Start]
gcode = 
	{% set MINUTES = params.MINUTES|default(15)|int %}
	{% set duration = printer["gcode_macro _WAIT_Variable"].duration|int %}
	{% set count = (MINUTES * 60) / duration %}
	SET_GCODE_VARIABLE MACRO=_WAIT_Variable VARIABLE=waiting VALUE=True
	SET_GCODE_VARIABLE MACRO=_WAIT_Variable VARIABLE=count VALUE={count}
	UPDATE_DELAYED_GCODE ID=WAIT_Delayed DURATION={duration}

[gcode_macro TIMER_Stop]
gcode = 
	{% if printer["gcode_macro _WAIT_Variable"].waiting %}
	M118 STOPPING LOOP, SETTING COUNT TO 0
	SET_GCODE_VARIABLE MACRO=_WAIT_Variable VARIABLE=count VALUE=0
	UPDATE_DELAYED_GCODE ID=WAIT_Delayed DURATION=1
	STATUS_READY
	
	{% else %}
	M118 Not in waiting state, nothing to do.
	{% endif %}

[gcode_macro _HEAT_WAIT]
description = Heating cycle waiting routine
gcode = 
	{% set MINUTES = params.MINUTES|default(10)|int %}
	{% set MSG = params.MSG|default("Heat Soak...")|string %}
	{% for i in range(0, MINUTES) %}
	M117 {MSG} {MINUTES-i} minute remaining.
	{% for s in range(0, 60) %}
	SET_LED LED=Screen_Colour INDEX=1 RED=1 GREEN=0.2392 BLUE=0 WHITE=0
	SET_LED LED=Screen_Colour INDEX=2 RED=1 GREEN=0.2392 BLUE=0 WHITE=0
	SET_LED LED=Screen_Colour INDEX=3 RED=0.051 GREEN=0.0118 BLUE=0 WHITE=0
	
	
	G4 P500
	SET_LED LED=Screen_Colour INDEX=1 RED=1 GREEN=0.2392 BLUE=0 WHITE=0
	SET_LED LED=Screen_Colour INDEX=2 RED=0.051 GREEN=0.0118 BLUE=0 WHITE=0
	SET_LED LED=Screen_Colour INDEX=3 RED=1 GREEN=0.2392 BLUE=0 WHITE=0
	
	
	
	G4 P500
	{% endfor %}
	{% endfor %}
	M117
	RESPOND TYPE=COMMAND MSG="{MSG} Finished."

[gcode_macro _LED_vars]
variable_colors = {
	'logo': {
	'busy': {'r': 0.4, 'g': 0.0, 'b': 0.0, 'w': 0.0},
	'cleaning': {'r': 0.0, 'g': 0.02, 'b': 0.5, 'w': 0.0},
	'calibrating_z': {'r': 1.0, 'g': 0.8, 'b': 0.0, 'w': 0.0},
	'heating': {'r': 0.2784, 'g': 0.0667, 'b': 0.0, 'w': 0.0},
	'homing': {'r': 0.0392, 'g': 0.6, 'b': 0.0, 'w': 0.0},
	'leveling': {'r': 0.5, 'g': 0.1, 'b': 0.4, 'w': 0.0},
	'meshing': {'r': 0.0, 'g': 1.0, 'b': 1.0, 'w': 0.0},
	'off': {'r': 0.0, 'g': 0.0, 'b': 0.0, 'w': 0.0},
	'printing': {'r': 1.0, 'g': 0.0, 'b': 0.0, 'w': 0.0},
	'standby': {'r': 0.6, 'g': 0.6, 'b': 0.6, 'w': 0.6},
	},
	'nozzle': {
	'heating': {'r': 0.2784, 'g': 0.0667, 'b': 0.0, 'w': 0.0},
	'off': {'r': 0.0, 'g': 0.0, 'b': 0.0, 'w': 0.0},
	'on': {'r': 0.8, 'g': 0.8, 'b': 0.8, 'w':1.0},
	'standby': {'r': 0.8, 'g': 0.8, 'b': 0.8, 'w':0.0},
	},
	'thermal': {
	'hot': {'r': 1.0, 'g': 0.0, 'b': 0.0, 'w': 0.0},
	'cold': {'r': 0.3, 'g': 0.0, 'b': 0.3, 'w': 0.0}
	}
	}
variable_logo_led_name = "Screen_Colour"
variable_logo_idx = "2,3"
variable_nozzle_led_name = "Screen_Colour"
variable_nozzle_idx = "1"
gcode = 

[gcode_macro _set_SCREEN_LEDs]
gcode = 
	{% set red = params.RED|default(0)|float %}
	{% set green = params.GREEN|default(0)|float %}
	{% set blue = params.BLUE|default(0)|float %}
	{% set white = params.WHITE|default(0)|float %}
	{% set led = params.LED|string %}
	{% set idx = (params.IDX|string).split(',') %}
	{% set transmit_last = params.TRANSMIT|default(1) %}
	
	{% for led_index in idx %}
	{% set transmit=transmit_last if loop.last else 0 %}
	set_led led={led} red={red} green={green} blue={blue} white={white} index={led_index} transmit={transmit}
	{% endfor %}

[gcode_macro _set_SCREEN_LEDs_by_name]
gcode = 
	{% set leds_name = params.LEDS %}
	{% set color_name = params.COLOR %}
	{% set color = printer["gcode_macro _LED_vars"].colors[leds_name][color_name] %}
	{% set led = printer["gcode_macro _LED_vars"][leds_name + "_led_name"] %}
	{% set idx = printer["gcode_macro _LED_vars"][leds_name + "_idx"] %}
	{% set transmit = params.TRANSMIT|default(1) %}
	
	_set_SCREEN_LEDs led={led} red={color.r} green={color.g} blue={color.b} white={color.w} idx="{idx}" transmit={transmit}

[gcode_macro _set_logo_leds]
gcode = 
	{% set red = params.RED|default(0)|float %}
	{% set green = params.GREEN|default(0)|float %}
	{% set blue = params.BLUE|default(0)|float %}
	{% set white = params.WHITE|default(0)|float %}
	{% set led = printer["gcode_macro _LED_vars"].logo_led_name %}
	{% set idx = printer["gcode_macro _LED_vars"].logo_idx %}
	{% set transmit=params.TRANSMIT|default(1) %}
	
	_set_SCREEN_LEDs led={led} red={red} green={green} blue={blue} white={white} idx="{idx}" transmit={transmit}

[gcode_macro _set_nozzle_leds]
gcode = 
	{% set red = params.RED|default(0)|float %}
	{% set green = params.GREEN|default(0)|float %}
	{% set blue = params.BLUE|default(0)|float %}
	{% set white = params.WHITE|default(0)|float %}
	{% set led = printer["gcode_macro _LED_vars"].nozzle_led_name %}
	{% set idx = printer["gcode_macro _LED_vars"].nozzle_idx %}
	{% set transmit=params.TRANSMIT|default(1) %}
	
	_set_SCREEN_LEDs led={led} red={red} green={green} blue={blue} white={white} idx="{idx}" transmit={transmit}

[gcode_macro set_logo_leds_off]
gcode = 
	{% set transmit=params.TRANSMIT|default(1) %}
	_set_logo_leds red=0 blue=0 green=0 white=0 transmit={transmit}

[gcode_macro set_nozzle_leds_on]
gcode = 
	{% set transmit=params.TRANSMIT|default(1) %}
	_set_SCREEN_LEDs_by_name leds="nozzle" color="on" transmit={transmit}

[gcode_macro set_nozzle_leds_off]
gcode = 
	{% set transmit=params.TRANSMIT|default(1) %}
	_set_SCREEN_LEDs_by_name leds="nozzle" color="off" transmit={transmit}

[gcode_macro status_off]
gcode = 
	set_logo_leds_off transmit=0
	set_nozzle_leds_off

[gcode_macro status_ready]
gcode = 
	_set_SCREEN_LEDs_by_name leds="logo" color="standby" transmit=0
	_set_SCREEN_LEDs_by_name leds="nozzle" color="standby" transmit=1

[gcode_macro status_busy]
gcode = 
	_set_SCREEN_LEDs_by_name leds="logo" color="busy" transmit=0
	set_nozzle_leds_on

[gcode_macro status_heating]
gcode = 
	_set_SCREEN_LEDs_by_name leds="logo" color="heating" transmit=0
	_set_SCREEN_LEDs_by_name leds="nozzle" color="heating" transmit=1

[gcode_macro status_leveling]
gcode = 
	_set_SCREEN_LEDs_by_name leds="logo" color="leveling" transmit=0
	set_nozzle_leds_on

[gcode_macro status_homing]
gcode = 
	_set_SCREEN_LEDs_by_name leds="logo" color="homing" transmit=0
	set_nozzle_leds_on

[gcode_macro status_cleaning]
gcode = 
	_set_SCREEN_LEDs_by_name leds="logo" color="cleaning" transmit=0
	set_nozzle_leds_on

[gcode_macro status_meshing]
gcode = 
	_set_SCREEN_LEDs_by_name leds="logo" color="meshing" transmit=0
	set_nozzle_leds_on

[gcode_macro status_calibrating_z]
gcode = 
	_set_SCREEN_LEDs_by_name leds="logo" color="calibrating_z" transmit=0
	set_nozzle_leds_on

[gcode_macro status_printing]
gcode = 
	_set_SCREEN_LEDs_by_name leds="logo" color="printing" transmit=0
	set_nozzle_leds_on

[gcode_shell_command demon_user_settings_file_extract]
command = /usr/bin/bash /home/biqu/printer_data/config/Demon_Klipper_Essentials_Unified/Other_Files/Demon_User_Files_Updater/Demon_User_Settings.sh
timeout = 10
verbose = True

[gcode_macro _DEMON_USER_SETTINGS_FILE_EXTRACT]
description = Extracts Demon Files
gcode = 
	{% set svv = printer.save_variables.variables %}
	
	RUN_SHELL_COMMAND CMD=demon_user_settings_file_extract
	M400
	RESPOND TYPE=command MSG="action:prompt_end"
	M400
	SAVE_VARIABLE VARIABLE=updated_settings VALUE=True
	M400
	RESTART

[gcode_macro _USER_SETTINGS_FILE_PROMPT]
gcode = 
	RESPOND TYPE=command MSG="action:prompt_begin Demon Klipper Essentials Update"
	RESPOND TYPE=command MSG="action:prompt_text I see you're using a new version! The Demon User Settings file needs extracting, click EXTRACT to continue. Files will be placed in a new directory called Demon_User_Files inside your config directory were you are free to edit them without dirtying the Demon install."
	RESPOND TYPE=command MSG="action:prompt_text Click CANCEL to do this manually by creating the directory & copying/editing the files yourself."
	RESPOND TYPE=command MSG="action:prompt_text If you EXTRACT & the directory/file already exist your current files will be moved to a new directory called Previous_Versions & will have numbered backups made if needed, you may need to refresh your browser to reveal new items. Klipper will restart."
	RESPOND TYPE=command MSG="action:prompt_text NOTE: You need to have installed Kiauh G-Code Shell Command Extension for this to work."
	RESPOND TYPE=command MSG="action:prompt_text WARNING! YOU MUST EDIT THE NEW FILE TO YOUR OLD VALUES, NEW FILES ARE AT DEFAULT VALUES!!!"
	RESPOND TYPE=command MSG="action:prompt_footer_button CANCEL|RESPOND TYPE=command MSG=action:prompt_end"
	RESPOND TYPE=command MSG="action:prompt_footer_button EXTRACT|_DEMON_USER_SETTINGS_FILE_EXTRACT|error"
	RESPOND TYPE=command MSG="action:prompt_show"

[gcode_shell_command demon_user_cleaner_file_extract]
command = /usr/bin/bash /home/biqu/printer_data/config/Demon_Klipper_Essentials_Unified/Other_Files/Demon_User_Files_Updater/Demon_User_Cleaner.sh
timeout = 10
verbose = True

[gcode_macro _DEMON_USER_CLEANER_FILE_EXTRACT]
description = Extracts Demon Files
gcode = 
	{% set svv = printer.save_variables.variables %}
	
	RUN_SHELL_COMMAND CMD=demon_user_cleaner_file_extract
	M400
	RESPOND TYPE=command MSG="action:prompt_end"
	M400
	SAVE_VARIABLE VARIABLE=updated_cleaner VALUE=True
	M400
	RESTART

[gcode_macro _USER_CLEANER_FILE_PROMPT]
gcode = 
	RESPOND TYPE=command MSG="action:prompt_begin Demon Klipper Essentials Update"
	RESPOND TYPE=command MSG="action:prompt_text I see you're using a new version! The Demon User Settings Cleaner Variables file needs extracting, click EXTRACT to continue. Files will be placed in a new directory called Demon_User_Files inside your config directory were you are free to edit them without dirtying the Demon install."
	RESPOND TYPE=command MSG="action:prompt_text Click CANCEL to do this manually by creating the directory & copying/editing the files yourself."
	RESPOND TYPE=command MSG="action:prompt_text If you EXTRACT & the directory/file already exist your current files will be moved to a new directory called Previous_Versions & will have numbered backups made if needed, you may need to refresh your browser to reveal new items. Klipper will restart."
	RESPOND TYPE=command MSG="action:prompt_text NOTE: You need to have installed Kiauh G-Code Shell Command Extension for this to work."
	RESPOND TYPE=command MSG="action:prompt_text WARNING! YOU MUST EDIT THE NEW FILE TO YOUR OLD VALUES, NEW FILES ARE AT DEFAULT VALUES!!!"
	RESPOND TYPE=command MSG="action:prompt_footer_button CANCEL|RESPOND TYPE=command MSG=action:prompt_end"
	RESPOND TYPE=command MSG="action:prompt_footer_button EXTRACT|_DEMON_USER_CLEANER_FILE_EXTRACT|error"
	RESPOND TYPE=command MSG="action:prompt_show"

[gcode_shell_command demon_user_expansion_file_extract]
command = /usr/bin/bash /home/biqu/printer_data/config/Demon_Klipper_Essentials_Unified/Other_Files/Demon_User_Files_Updater/Demon_User_Expansion.sh
timeout = 10
verbose = True

[gcode_macro _DEMON_USER_EXPANSION_FILE_EXTRACT]
description = Extracts Demon Files
gcode = 
	{% set svv = printer.save_variables.variables %}
	
	RUN_SHELL_COMMAND CMD=demon_user_expansion_file_extract
	M400
	RESPOND TYPE=command MSG="action:prompt_end"
	M400
	SAVE_VARIABLE VARIABLE=updated_expansion VALUE=True
	M400
	RESTART

[gcode_macro _USER_EXPANSION_FILE_PROMPT]
gcode = 
	RESPOND TYPE=command MSG="action:prompt_begin Demon Klipper Essentials Update"
	RESPOND TYPE=command MSG="action:prompt_text I see you're using a new version! The Demon User Custom Expansion file needs extracting, click EXTRACT to continue. Files will be placed in a new directory called Demon_User_Files inside your config directory were you are free to edit them without dirtying the Demon install."
	RESPOND TYPE=command MSG="action:prompt_text Click CANCEL to do this manually by creating the directory & copying/editing the files yourself."
	RESPOND TYPE=command MSG="action:prompt_text If you EXTRACT & the directory/file already exist your current files will be moved to a new directory called Previous_Versions & will have numbered backups made if needed, you may need to refresh your browser to reveal new items. Klipper will restart."
	RESPOND TYPE=command MSG="action:prompt_text NOTE: You need to have installed Kiauh G-Code Shell Command Extension for this to work."
	RESPOND TYPE=command MSG="action:prompt_text WARNING! YOU MUST EDIT THE NEW FILE TO YOUR OLD VALUES, NEW FILES ARE AT DEFAULT VALUES!!!"
	RESPOND TYPE=command MSG="action:prompt_footer_button CANCEL|RESPOND TYPE=command MSG=action:prompt_end"
	RESPOND TYPE=command MSG="action:prompt_footer_button EXTRACT|_DEMON_USER_EXPANSION_FILE_EXTRACT|error"
	RESPOND TYPE=command MSG="action:prompt_show"

[gcode_shell_command demon_prepare_user_files]
command = /usr/bin/bash /home/biqu/printer_data/config/Demon_Klipper_Essentials_Unified/Other_Files/Demon_User_Files_Updater/First_Boot_Demon_User_Files.sh
timeout = 10
verbose = True

[gcode_macro _PREPARE_USER_FILES]
description = Extracts Demon Files
gcode = 
	{% set svv = printer.save_variables.variables %}
	
	RUN_SHELL_COMMAND CMD=demon_prepare_user_files
	M400
	RESPOND TYPE=command MSG="action:prompt_end"
	M400
	SAVE_VARIABLE VARIABLE=first_boot VALUE=False
	SAVE_VARIABLE VARIABLE=first_boot_msg VALUE=True
	SAVE_VARIABLE VARIABLE=version_dvars_updated VALUE=False
	M400
	RESTART

[gcode_macro _USER_FILE_PROMPT]
gcode = 
	RESPOND TYPE=command MSG="action:prompt_begin Demon Klipper Essentials Update"
	RESPOND TYPE=command MSG="action:prompt_text I see you're new here! Welcome aboard! The Demon User Files need extracting, click EXTRACT to continue. Files will be placed in a new directory called Demon_User_Files inside your config directory were you are free to edit them without dirtying the Demon install."
	RESPOND TYPE=command MSG="action:prompt_text Click CANCEL to do this manually by creating the directory & copying/editing the files yourself."
	RESPOND TYPE=command MSG="action:prompt_text If you EXTRACT & the directory/file already exist your current files will be moved to a new directory called Previous_Versions & will have numbered backups made if needed, you may need to refresh your browser to reveal new items. Klipper will restart."
	RESPOND TYPE=command MSG="action:prompt_text NOTE: You need to have installed Kiauh G-Code Shell Command Extension for this to work."
	RESPOND TYPE=command MSG="action:prompt_text WARNING! YOU MUST EDIT THE NEW FILE TO YOUR OLD VALUES, NEW FILES ARE AT DEFAULT VALUES!!!"
	RESPOND TYPE=command MSG="action:prompt_footer_button CANCEL|RESPOND TYPE=command MSG=action:prompt_end"
	RESPOND TYPE=command MSG="action:prompt_footer_button EXTRACT|_PREPARE_USER_FILES|error"
	RESPOND TYPE=command MSG="action:prompt_show"

[gcode_shell_command demon_vars_file_extract]
command = /usr/bin/bash /home/biqu/printer_data/config/Demon_Klipper_Essentials_Unified/Other_Files/Demon_User_Files_Updater/Demon_Vars_Updater.sh
timeout = 10
verbose = True

[gcode_macro _DEMON_VARS_FILE_EXTRACT]
description = Extracts Demon Files
gcode = 
	{% set svv = printer.save_variables.variables %}
	
	RUN_SHELL_COMMAND CMD=demon_vars_file_extract
	M400
	RESPOND TYPE=command MSG="action:prompt_end"
	UPDATE_DELAYED_GCODE ID=_DVARS_SET DURATION=2
	G4 P3000
	RESTART

[gcode_macro _DEMON_VARS_PROMPT]
gcode = 
	RESPOND TYPE=command MSG="action:prompt_begin Demon Klipper Essentials Update"
	RESPOND TYPE=command MSG="action:prompt_text I see you're using a new version! The Demon_Vars file needs extracting, click EXTRACT to continue. The file will be updated."
	RESPOND TYPE=command MSG="action:prompt_text Click CANCEL to do this manually by copying the file yourself."
	RESPOND TYPE=command MSG="action:prompt_text NOTE: You need to have installed Kiauh G-Code Shell Command Extension for this to work."
	RESPOND TYPE=command MSG="action:prompt_text WARNING! YOU MUST EDIT THE NEW FILE TO YOUR OLD VALUES, NEW FILES ARE AT DEFAULT VALUES!!!"
	RESPOND TYPE=command MSG="action:prompt_footer_button CANCEL|RESPOND TYPE=command MSG=action:prompt_end"
	RESPOND TYPE=command MSG="action:prompt_footer_button EXTRACT|_DEMON_VARS_FILE_EXTRACT|error"
	RESPOND TYPE=command MSG="action:prompt_show"

[delayed_gcode _DVARS_SET]
gcode = 
	{% set svv = printer.save_variables.variables %}
	SAVE_VARIABLE VARIABLE=first_boot VALUE=False
	SAVE_VARIABLE VARIABLE=version_dvars_updated VALUE=True

[delayed_gcode _UPDATED]
initial_duration = 1
gcode = 
	{% set svv = printer.save_variables.variables %}
	
	{% if svv.first_boot != False %}
	SAVE_VARIABLE VARIABLE=using_shell VALUE=True
	RESPOND TYPE=COMMAND MSG="WARNING: Demon User Files not in new location."
	_EXTRACT_USER_FILES_CONFIRM
	
	{% else %}
	{% if svv.first_boot_msg != False %}
	SAVE_VARIABLE VARIABLE=first_boot_msg VALUE=False
	RESPOND TYPE=COMMAND MSG="WARNING: USER SETTINGS FILES HAVE BEEN EXTRACTED! Don't forget to use the include command to bring them into your system!"
	_USER_FILES_REMINDER
	{% endif %}
	
	{% if svv.updated_settings == True %}
	SAVE_VARIABLE VARIABLE=updated_settings VALUE=False
	RESPOND TYPE=COMMAND MSG="WARNING: USER SETTINGS FILE HAS BEEN UPDATED! Default settings are in effect, be sure to update your old values to this file!"
	_UPDATE_USER_SETTINGS_CONFIRM
	{% endif %}
	
	{% if svv.updated_cleaner == True %}
	SAVE_VARIABLE VARIABLE=updated_cleaner VALUE=False
	RESPOND TYPE=COMMAND MSG="WARNING: USER SETTINGS CLEANER VARIABLES FILE HAS BEEN UPDATED! Default settings are in effect, be sure to update your old values to this file!"
	_UPDATE_USER_CLEANER_CONFIRM
	{% endif %}
	
	{% if svv.updated_expansion == True %}
	SAVE_VARIABLE VARIABLE=updated_expansion VALUE=False
	RESPOND TYPE=COMMAND MSG="WARNING: USER CUSTOM EXANSIONS FILE HAS BEEN UPDATED! Default settings are in effect, be sure to update your old values to this file!"
	_UPDATE_USER_EXPANSION_CONFIRM
	{% endif %}
	
	{% if svv.version_dvars_updated == True %}
	SAVE_VARIABLE VARIABLE=version_dvars_updated VALUE=False
	RESPOND TYPE=COMMAND MSG="WARNING: Demon_Vars FILE HAS BEEN UPDATED! Default settings are in effect!"
	_UPDATE_DEMON_VARS_CONFIRM
	{% endif %}
	{% endif %}

[gcode_macro _EXTRACT_USER_FILES_CONFIRM]
gcode = 
	SAVE_VARIABLE VARIABLE=first_boot VALUE=False
	SAVE_VARIABLE VARIABLE=first_boot_msg VALUE=True
	SAVE_VARIABLE VARIABLE=version_dvars_updated VALUE=False
	RESPOND TYPE=command MSG="action:prompt_begin Demon Klipper Essentials Unified"
	RESPOND TYPE=command MSG="action:prompt_text CONGRATS: YOUR DEMON MACROS ARE ONLINE!"
	RESPOND TYPE=command MSG="action:prompt_text I see you're new here! Welcome aboard! You may need to refresh your browser to reveal new items. Don't forget to use the include command to bring them into your system!"
	RESPOND TYPE=command MSG="action:prompt_text Files are found in a new directories called Demon_Klipper_Essentials_Unified & Demon_User_Files inside your config directory."
	RESPOND TYPE=command MSG="action:prompt_text Don't forget to check you added the save_variables section in your printer.cfg! You NEED to do that for things to work correctly!"
	RESPOND TYPE=command MSG="action:prompt_footer_button LETS GET STARTED!|RESPOND TYPE=command MSG=action:prompt_end|error"
	RESPOND TYPE=command MSG="action:prompt_show"

[gcode_macro _USER_FILES_REMINDER]
gcode = 
	SAVE_VARIABLE VARIABLE=first_boot_msg VALUE=False
	RESPOND TYPE=command MSG="action:prompt_begin Demon Klipper Essentials Update"
	RESPOND TYPE=command MSG="action:prompt_text Just checking in, hope it's going well"
	RESPOND TYPE=command MSG="action:prompt_text Reminder, don't forget to use the include command for the new Demon_User_File directory!"
	RESPOND TYPE=command MSG="action:prompt_text Files are found in a new directory called Demon_User_Files inside your config directory."
	RESPOND TYPE=command MSG="action:prompt_footer_button YEAH GOT IT COVERED|RESPOND TYPE=command MSG=action:prompt_end|error"
	RESPOND TYPE=command MSG="action:prompt_show"

[gcode_macro _UPDATE_USER_SETTINGS_CONFIRM]
gcode = 
	RESPOND TYPE=command MSG="action:prompt_begin Demon Klipper Essentials Update"
	RESPOND TYPE=command MSG="action:prompt_text WARNING: The Demon User Settings file has been UPDATED! Default settings are in effect, be sure to update your old values to this file! Click CONFIRM to confirm you understand this!"
	RESPOND TYPE=command MSG="action:prompt_footer_button CONFIRM|RESPOND TYPE=command MSG=action:prompt_end|error"
	RESPOND TYPE=command MSG="action:prompt_show"

[gcode_macro _UPDATE_USER_CLEANER_CONFIRM]
gcode = 
	RESPOND TYPE=command MSG="action:prompt_begin Demon Klipper Essentials Update"
	RESPOND TYPE=command MSG="action:prompt_text WARNING: The Demon User Settings Cleaner Variables file has been UPDATED! Default settings are in effect, be sure to update your old values to this file! Click CONFIRM to confirm you understand this!"
	RESPOND TYPE=command MSG="action:prompt_footer_button CONFIRM|RESPOND TYPE=command MSG=action:prompt_end|error"
	RESPOND TYPE=command MSG="action:prompt_show"

[gcode_macro _UPDATE_USER_EXPANSION_CONFIRM]
gcode = 
	RESPOND TYPE=command MSG="action:prompt_begin Demon Klipper Essentials Update"
	RESPOND TYPE=command MSG="action:prompt_text WARNING: The Demon User Custom Expansions file has been UPDATED! Default settings are in effect, be sure to update your old values to this file! Click CONFIRM to confirm you understand this!"
	RESPOND TYPE=command MSG="action:prompt_footer_button CONFIRM|RESPOND TYPE=command MSG=action:prompt_end|error"
	RESPOND TYPE=command MSG="action:prompt_show"

[gcode_macro _UPDATE_DEMON_VARS_CONFIRM]
gcode = 
	RESPOND TYPE=command MSG="action:prompt_begin Demon Klipper Essentials Update"
	RESPOND TYPE=command MSG="action:prompt_text WARNING: The Demon_Vars file has been UPDATED! Default settings are in effect! Click CONFIRM to confirm you understand this!"
	
	RESPOND TYPE=command MSG="action:prompt_footer_button CONFIRM|RESPOND TYPE=command MSG=action:prompt_end|error"
	RESPOND TYPE=command MSG="action:prompt_show"

[gcode_shell_command disk_space_check]
command = /usr/bin/bash /home/biqu/printer_data/config/Demon_Klipper_Essentials_Unified/Other_Files/Demon_User_Files_Updater/Demon_Disk_Space_Checker.sh
timeout = 10
verbose = True

[gcode_macro _DISK_SPACE_CHECK]
description = Checks free space
gcode = 
	RUN_SHELL_COMMAND CMD=disk_space_check

[gcode_macro _LOW_SPACE_PROMPT]
gcode = 
	RESPOND TYPE=command MSG="action:prompt_begin DEMON_Disk_Space_Check!"
	RESPOND TYPE=command MSG="action:prompt_text WARNING: LOW STORAGE SPACE! Free up space now!"
	RESPOND TYPE=command MSG="action:prompt_footer_button GOT IT|RESPOND TYPE=command MSG=action:prompt_end|error"
	RESPOND TYPE=command MSG="action:prompt_show"

[virtual_sdcard]
path = ~/printer_data/gcodes
on_error_gcode = CANCEL_PRINT

[pause_resume]

[display_status]

[respond]

[gcode_macro CANCEL_PRINT]
description = 
rename_existing = CANCEL_PRINT_BASE
gcode = 
	{% set x_park = printer['gcode_macro _global_var'].cancel_park.x|float %}
	{% set y_park = printer['gcode_macro _global_var'].cancel_park.y|float %}
	{% set z_park = printer['gcode_macro _global_var'].cancel_park.z|float %}
	{% set z_lift_max = printer['gcode_macro _global_var'].z_maximum_lifting_distance %}
	{% set e_restract = printer['gcode_macro _global_var'].cancel_park.e|float %}
	{% set e_mintemp  = printer.configfile.settings['extruder'].min_extrude_temp %}
	
	CANCEL_PRINT_BASE
	
	M117 Print canceled!
	G91
	{% if printer['filament_switch_sensor filament_sensor'].enabled == True and
	printer['filament_switch_sensor filament_sensor'].filament_detected == True
	%}
	{% if (printer.extruder.target != 0 and printer.extruder.temperature >= printer.extruder.target) or
	printer.extruder.temperature >= e_mintemp
	%}
	G1 E-{e_restract} F500
	{% else %}
	{action_respond_info("Nozzle not hot enough")}
	{% endif %}
	{% endif %}
	
	{%if (printer.gcode_move.position.z + 10) < z_lift_max %}
	G1 Z+10 F3000
	{% else %}
	G1 Z+{(z_lift_max - printer.gcode_move.position.z)} F3000
	{% endif %}
	G90
	G1 X{x_park} Y{y_park} F9000
	
	TURN_OFF_HEATERS
	_ALL_FAN_OFF
	
	CLEAR_PAUSE
	M84 X Y Z E
	
	M117 Ready
	{action_respond_info("Cancel Print Success!")}
	SET_GCODE_VARIABLE MACRO=START_PRINT VARIABLE=state VALUE='"Prepare"'
	SET_GCODE_VARIABLE MACRO=START_PRINT VARIABLE=record_extruder_temp VALUE=0
	SET_GCODE_VARIABLE MACRO=START_PRINT VARIABLE=max_record_extruder_temp VALUE=0

[gcode_macro PAUSE]
description = Pause the actual running print
rename_existing = PAUSE_BASE
gcode = 
	{% if printer.pause_resume.is_paused == False %}
	{% set x_park = printer['gcode_macro _global_var'].pause_park.x|float %}
	{% set y_park = printer['gcode_macro _global_var'].pause_park.y|float %}
	{% set e_restract = printer['gcode_macro _global_var'].pause_park.e|float %}
	{% set z_lift_max = printer['gcode_macro _global_var'].z_maximum_lifting_distance %}
	
	{% set state = params.STATE if 'filament_change' in params.STATE else 'normal' %}
	
	{action_respond_info("Pause Print!")}
	
	PAUSE_BASE
	M117 Pause Print!!!
	G91
	{% if (printer.gcode_move.position.z + 5) < z_lift_max %}
	G1 Z+5 F3000
	{% else %}
	G1 Z+{(z_lift_max - printer.gcode_move.position.z)} F3000
	{% endif %}
	G90
	{% if printer.gcode_move.position.x != x_park and
	printer.gcode_move.position.y != y_park
	%}
	G1 X{x_park} Y{y_park} F{printer["gcode_macro _global_var"].pause_resume_travel_speed * 60}
	{% endif %}
	
	M104 S{printer.extruder.target}
	
	{% if state == 'normal' %}
	{% if (printer.extruder.temperature + 5 >= printer.extruder.target) and (printer.extruder.temperature >= printer.configfile.settings['extruder'].min_extrude_temp) %}
	{% if printer['filament_switch_sensor filament_sensor'].enabled == True and
	printer['filament_switch_sensor filament_sensor'].filament_detected == True
	%}
	G91
	G1 E-{e_restract} F300
	G90
	{% elif printer['filament_switch_sensor filament_sensor'].enabled == True and
	printer['filament_switch_sensor filament_sensor'].filament_detected != True %}
	G91
	G1 E+95 F300
	G1 E-10 F1500
	G1 E-20 F600
	M400
	G4 P3000
	G1 E-50 F300
	G90
	{% endif %}
	{% endif %}
	{% elif state == 'filament_change' %}
	{% if (printer.extruder.temperature + 5 >= printer.extruder.target) and (printer.extruder.temperature >= printer.configfile.settings['extruder'].min_extrude_temp) %}
	G91
	G1 E+25 F300
	G1 E-10 F1500
	G1 E-20 F600
	M400
	G4 P3000
	G1 E-50 F300
	G90
	{% endif %}
	{% endif %}
	{% endif %}
variable_state = 'normal'

[gcode_macro RESUME]
description = Pause the actual running print
rename_existing = RESUME_BASE
variable_last_extruder_temp = {'restore': False, 'temp': 0}
variable_restore_idle_timeout = 0
variable_idle_state = False
gcode = 
	{% set e_restract = printer['gcode_macro _global_var'].pause_park.e|float %}
	{% set extruder_target_temp = printer.extruder.target|int %}
	
	{% set state = params.STATE if 'filament_change' in params.STATE else 'normal' %}
	
	{% if state == 'filament_change' %}
	{% if printer["filament_switch_sensor filament_sensor"].enable == True and
	printer["filament_switch_sensor filament_sensor"].filament_detected != True
	%}
	{action_respond_info("Please Insert filament in Sensor!")}
	{% else %}
	{% if printer.extruder.temperature + 5 >= printer.extruder.target %}
	G91
	G1 E30 F300
	G1 E10 F150
	G90
	{% else %}
	M104 S{extruder_target_temp}
	{action_respond_info("Nozzle not hot enough!")}
	{action_respond_info("Nozzle heating...")}
	M109 S{extruder_target_temp}
	G91
	G1 E30 F300
	G1 E10 F150
	G90
	{% endif %}
	{action_respond_info("Print resumming!")}
	RESUME_BASE
	{% endif %}
	{% elif state == 'normal' %}
	{% if printer['filament_switch_sensor filament_sensor'].enable != True and
	printer['filament_switch_sensor filament_sensor'].filament_detected != True
	%}
	{action_respond_info("Please Insert filament in Sensor!")}
	{% else %}
	{action_respond_info("Print resumming!")}
	G91
	G1 E{e_restract} F300
	G90
	M117 Printing now!!!
	RESUME_BASE
	{% endif %}
	{% endif %}
variable_state = 'normal'

[gcode_macro SET_PAUSE_NEXT_LAYER]
description = Enable a pause if the next layer is reached
gcode = 
	{% set pause_next_layer = printer['gcode_macro SET_PRINT_STATS_INFO'].pause_next_layer %}
	{% set ENABLE = params.ENABLE|default(1)|int != 0 %}
	{% set MACRO = params.MACRO|default(pause_next_layer.call, True) %}
	SET_GCODE_VARIABLE MACRO=SET_PRINT_STATS_INFO VARIABLE=pause_next_layer VALUE="{{ 'enable': ENABLE, 'call': MACRO }}"

[gcode_macro SET_PAUSE_AT_LAYER]
description = Enable/disable a pause if a given layer number is reached
gcode = 
	{% set pause_at_layer = printer['gcode_macro SET_PRINT_STATS_INFO'].pause_at_layer %}
	{% set ENABLE = params.ENABLE|int != 0 if params.ENABLE is defined
	else params.LAYER is defined %}
	{% set LAYER = params.LAYER|default(pause_at_layer.layer)|int %}
	{% set MACRO = params.MACRO|default(pause_at_layer.call, True) %}
	SET_GCODE_VARIABLE MACRO=SET_PRINT_STATS_INFO VARIABLE=pause_at_layer VALUE="{{ 'enable': ENABLE, 'layer': LAYER, 'call': MACRO }}"

[gcode_macro SET_PRINT_STATS_INFO]
rename_existing = SET_PRINT_STATS_INFO_BASE
description = Overwrite, to get pause_next_layer and pause_at_layer feature
variable_pause_next_layer = { 'enable': False, 'call': "PAUSE" }
variable_pause_at_layer = { 'enable': False, 'layer': 0, 'call': "PAUSE" }
gcode = 
	{% if pause_next_layer.enable %}
	RESPOND TYPE=echo MSG='{"%s, forced by pause_next_layer" % pause_next_layer.call}'
	{pause_next_layer.call}
	SET_PAUSE_NEXT_LAYER ENABLE=0
	{% elif pause_at_layer.enable and params.CURRENT_LAYER is defined and params.CURRENT_LAYER|int == pause_at_layer.layer %}
	RESPOND TYPE=echo MSG='{"%s, forced by pause_at_layer [%d]" % (pause_at_layer.call, pause_at_layer.layer)}'
	{pause_at_layer.call}
	SET_PAUSE_AT_LAYER ENABLE=0
	{% endif %}
	SET_PRINT_STATS_INFO_BASE {rawparams}

[gcode_macro _TOOLHEAD_PARK_PAUSE_CANCEL]
description = Helper: park toolhead used in PAUSE and CANCEL_PRINT
gcode = 
	
	{% set client = printer['gcode_macro _CLIENT_VARIABLE']|default({}) %}
	{% set velocity = printer.configfile.settings.pause_resume.recover_velocity %}
	{% set use_custom     = client.use_custom_pos|default(false)|lower == 'true' %}
	{% set custom_park_x  = client.custom_park_x|default(0.0) %}
	{% set custom_park_y  = client.custom_park_y|default(0.0) %}
	{% set park_dz        = client.custom_park_dz|default(2.0)|abs %}
	{% set sp_hop         = client.speed_hop|default(15) * 60 %}
	{% set sp_move        = client.speed_move|default(velocity) * 60 %}
	
	{% set origin    = printer.gcode_move.homing_origin %}
	{% set act       = printer.gcode_move.gcode_position %}
	{% set max       = printer.toolhead.axis_maximum %}
	{% set cone      = printer.toolhead.cone_start_z|default(max.z) %}
	{% set round_bed = True if printer.configfile.settings.printer.kinematics is in ['delta','polar','rotary_delta','winch']
	else False %}
	
	{% set z_min = params.Z_MIN|default(0)|float %}
	{% set z_park = [[(act.z + park_dz), z_min]|max, (max.z - origin.z)]|min %}
	{% set x_park = params.X       if params.X is defined
	else custom_park_x  if use_custom
	else 0.0            if round_bed
	else (max.x - 5.0) %}
	{% set y_park = params.Y       if params.Y is defined
	else custom_park_y  if use_custom
	else (max.y - 5.0)  if round_bed and z_park < cone
	else 0.0            if round_bed
	else (max.y - 5.0) %}
	
	_CLIENT_RETRACT
	{% if "xyz" in printer.toolhead.homed_axes %}
	G90
	G1 Z{z_park} F{sp_hop}
	G1 X{x_park} Y{y_park} F{sp_move}
	{% if not printer.gcode_move.absolute_coordinates %} G91 {% endif %}
	{% else %}
	RESPOND TYPE=echo MSG='Printer not homed'
	{% endif %}

[gcode_macro _CLIENT_EXTRUDE]
description = Extrudes, if the extruder is hot enough
gcode = 
	
	{% set client = printer['gcode_macro _CLIENT_VARIABLE']|default({}) %}
	{% set use_fw_retract = (client.use_fw_retract|default(false)|lower == 'true') and (printer.firmware_retraction is defined) %}
	{% set length = params.LENGTH|default(client.unretract)|default(1.0)|float %}
	{% set speed = params.SPEED|default(client.speed_unretract)|default(35) %}
	{% set absolute_extrude = printer.gcode_move.absolute_extrude %}
	
	{% if printer.toolhead.extruder != '' %}
	{% if printer[printer.toolhead.extruder].can_extrude %}
	{% if use_fw_retract %}
	{% if length < 0 %}
	G10
	{% else %}
	G11
	{% endif %}
	{% else %}
	M83
	G1 E{length} F{(speed|float|abs) * 60}
	{% if absolute_extrude %}
	M82
	{% endif %}
	{% endif %}
	{% else %}
	RESPOND TYPE=echo MSG='{"\"%s\" not hot enough" % printer.toolhead.extruder}'
	{% endif %}
	{% endif %}

[gcode_macro _CLIENT_RETRACT]
description = Retracts, if the extruder is hot enough
gcode = 
	{% set client = printer['gcode_macro _CLIENT_VARIABLE']|default({}) %}
	{% set length = params.LENGTH|default(client.retract)|default(1.0)|float %}
	{% set speed = params.SPEED|default(client.speed_retract)|default(35) %}
	
	_CLIENT_EXTRUDE LENGTH=-{length|float|abs} SPEED={speed|float|abs}

[gcode_macro _CLIENT_LINEAR_MOVE]
description = Linear move with save and restore of the gcode state
gcode = 
	{% set x_move = "X" ~ params.X if params.X is defined else "" %}
	{% set y_move = "Y" ~ params.Y if params.Y is defined else "" %}
	{% set z_move = "Z" ~ params.Z if params.Z is defined else "" %}
	{% set e_move = "E" ~ params.E if params.E is defined else "" %}
	{% set rate = "F" ~ params.F if params.F is defined else "" %}
	{% set ABSOLUTE = params.ABSOLUTE | default(0) | int != 0 %}
	{% set ABSOLUTE_E = params.ABSOLUTE_E | default(0) | int != 0 %}
	SAVE_GCODE_STATE NAME=_client_movement
	{% if x_move or y_move or z_move %}
	G9{ 0 if ABSOLUTE else 1 }
	{% endif %}
	{% if e_move %}
	M8{ 2 if ABSOLUTE_E else 3 }
	{% endif %}
	G1 { x_move } { y_move } { z_move } { e_move } { rate }
	RESTORE_GCODE_STATE NAME=_client_movement

[gcode_macro _CLIENT_VARIABLE]
variable_use_custom_pos = False
variable_custom_park_x = 0.0
variable_custom_park_y = 0.0
variable_custom_park_dz = 2.0
variable_retract = 1.0
variable_cancel_retract = 5.0
variable_speed_retract = 35.0
variable_unretract = 1.0
variable_speed_unretract = 35.0
variable_speed_hop = 15.0
variable_speed_move = 100.0
variable_park_at_cancel = False
variable_park_at_cancel_x = None
variable_park_at_cancel_y = None
variable_use_fw_retract = False
variable_idle_timeout = 600
variable_runout_sensor = "filament_switch_sensor filament_sensor"
variable_user_pause_macro = "_DEMON_PAUSE"
variable_user_resume_macro = "_DEMON_RESUME"
variable_user_cancel_macro = "_DEMON_CANCEL"
gcode = 

[gcode_macro mainled_on]
gcode = 
	SET_LED LED=main_led WHITE=1

[gcode_macro mainled_off]
gcode = 
	SET_LED LED=main_led WHITE=0

[force_move]
enable_force_move = True

[gcode_macro _global_var]
variable_pause_park = {'x': 0, 'y': 0, 'z': 10, 'e': 1}
variable_cancel_park = {'x': 0, 'y': 350, 'z': 10, 'e': 1}
variable_z_maximum_lifting_distance = 345
variable_pause_resume_travel_speed = 150
variable_bed_mesh_calibrate_target_temp = 60
variable_load_filament_extruder_temp = 230
variable_heat_soak_time = 0
gcode = 

[gcode_macro START_PRINT]
description = 
variable_state = 'Prepare'
variable_record_extruder_temp = 0
variable_max_record_extruder_temp = 0
gcode = 
	{% set bedtemp = params.BED_TEMP|default(60)|int %}
	{% set hotendtemp = params.EXTRUDER_TEMP|default(230)|int %}
	{% set heatsoak = params.HEATSOAK|default(True)|int %}
	{% set heatsoak_time = printer['gcode_macro _global_var'].heat_soak_time|default(0)|int %}
	{% set mesh_name = "default" %}
	
	{% set extruder_target_temp = 125 %}
	
	{% set bed_target_temp = bedtemp|int %}
	
	M400
	
	CLEAR_PAUSE
	
	G90
	{% if state == 'Prepare' %}
	
	{action_respond_info("Prepare!")}
	
	{% if printer['filament_switch_sensor filament_sensor'].enable == True and
	printer['filament_switch_sensor filament_sensor'].filament_detected != True
	%}
	M117 No filament!
	{action_respond_info("Please Insert filament in Sensor!")}
	CANCEL_PRINT
	{% endif %}
	
	{% if printer.extruder.temperature < extruder_target_temp %}
	M117 Nozzle pre-heating...
	{action_respond_info("Nozzle pre-heating...")}
	M109 S{extruder_target_temp}
	{% endif %}
	
	{% if printer.toolhead.homed_axes|lower != "xyz" %}
	G28
	{% endif %}
	
	
	
	
	{action_respond_info("Check Heating!")}
	
	{% if printer.heater_bed.temperature < bed_target_temp %}
	M117 Bed heating...
	{action_respond_info("Bed heating...")}
	M190 S{bed_target_temp}
	{% endif %}
	
	M140 S{bed_target_temp}
	M104 S{extruder_target_temp}
	
	
	{% if heatsoak == True %}
	M117 Short Heat Soak
	G4 P{heatsoak_time * 60000}
	{% endif %}
	
	{% if printer.quad_gantry_level.applied|lower != 'true' %}
	M117 QGL
	QUAD_GANTRY_LEVEL_BASE
	M117 Home Z after QGL
	G28 Z
	
	
	{% endif %}
	
	
	M117 Bed Mesh
	BED_MESH_CALIBRATE_BASE ADAPTIVE=1
	
	
	M117 Final Heating...
	{action_respond_info("Final heating...")}
	M140 S{bedtemp}
	M104 S{hotendtemp}
	M190 S{bedtemp}
	M109 S{hotendtemp};wait for extruder temp
	
	SET_GCODE_VARIABLE MACRO=START_PRINT VARIABLE=state VALUE='"Start"'
	UPDATE_DELAYED_GCODE ID=_print_start_wait DURATION=0.5
	
	{% elif state == 'Start' %}
	M117 Printing
	{action_respond_info("Start!")}
	{% endif %}

[gcode_macro END_PRINT]
description = 
variable_state = 'normal'
gcode = 
	{% set z_max = printer['gcode_macro _global_var'].z_maximum_lifting_distance|int %}
	{% set e_mintemp  = printer.configfile.settings['extruder'].min_extrude_temp %}
	
	M400
	SET_GCODE_VARIABLE MACRO=START_PRINT VARIABLE=state VALUE='"Prepare"'
	SET_GCODE_VARIABLE MACRO=START_PRINT VARIABLE=record_extruder_temp VALUE=0
	SET_GCODE_VARIABLE MACRO=START_PRINT VARIABLE=max_record_extruder_temp VALUE=0
	
	M117 Done
	G91
	{% if printer['filament_switch_sensor filament_sensor'].enable == True and
	printer['filament_switch_sensor filament_sensor'].filament_detected == True
	%}
	{% if (printer.extruder.target != 0 and printer.extruder.temperature >= printer.extruder.target) or
	printer.extruder.temperature >= e_mintemp
	%}
	G1 E-2 F2700
	G1 E-2 Z0.2 F2400
	{% endif %}
	{% endif %}
	
	{% if (printer.gcode_move.position.z + 25) < z_max %}
	G1 Z+25 F3000
	{% else %}
	G1 Z+{(z_max - printer.gcode_move.position.z)} F3000
	{% endif %}
	G90
	G1 X0 Y360 F9000
	
	_ALL_FAN_OFF
	TURN_OFF_HEATERS
	
	M84 X Y Z E
	
	M220 S100
	M221 S100
	
	CLEAR_PAUSE
	
	{action_respond_info("Finish Print!")}

[gcode_macro _IDLE_TIMEOUT]
gcode = 
	{% if printer.print_stats.state == "paused" %}
	RESPOND TYPE=echo MSG="No operations in 10min!"
	{% else %}
	M84
	TURN_OFF_HEATERS
	{% endif %}

[delayed_gcode exhaust_fan_off]
gcode = 
	SET_FAN_SPEED FAN=exhaust_fan SPEED=0

[gcode_macro _ALL_FAN_OFF]
gcode = 
	M106 S0
	
	
	M107

[gcode_macro CLEAN_NOZZLE]
gcode = 
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	{% set clean_vars = printer["gcode_macro _CLEAN_VARIABLES"] %}
	{% set heat = params.HEAT_TO_CLEAN|default('No')|string %}
	{% set cool = params.COOL_AFTER_CLEAN|default('No')|string %}
	{% set cool_temp = params.COOL_TEMP|default(0)|int %}
	
	{% if clean_vars.have_you_set_this_up != True %}
	{action_raise_error("This error is caused by you not setting up this feature before first use. Check demon_user_settings file & set this feature up correctly for your printer!")}
	
	{% else %}
	
	{% if start_vars.nozzle_cleaner == True %}
	G90
	M83
	{% if heat|lower in ['yes', 'true'] %}
	{% if printer.print_stats.state not in ['printing', 'paused'] %}
	SET_DISPLAY_TEXT MSG="Heating to clean nozzle {clean_vars.nozzle_pre_temp}c"
	RESPOND TYPE=COMMAND MSG="Heating to clean nozzle {clean_vars.nozzle_pre_temp}c"
	SET_HEATER_TEMPERATURE HEATER=extruder TARGET={clean_vars.nozzle_pre_temp}
	TEMPERATURE_WAIT SENSOR=extruder MINIMUM={clean_vars.nozzle_pre_temp - 5} MAXIMUM={clean_vars.nozzle_pre_temp + 50}
	
	{% elif printer.print_stats.state in ['printing', 'paused'] %}
	SET_DISPLAY_TEXT MSG="Clean heating option denied, print in progress!"
	RESPOND TYPE=COMMAND MSG="Clean heating option denied, print in progress!"
	{% endif %}
	{% endif %}
	
	_CONDITIONAL_HOME
	
	SET_DISPLAY_TEXT MSG="Cleaning Nozzle"
	RESPOND TYPE=COMMAND MSG="Cleaning Nozzle"
	
	{% if start_vars.neopixel_led == True %}
	STATUS_CLEANING
	{% endif %}
	
	{% if clean_vars.random_clean_x == False and clean_vars.random_clean_y == False %}
	G0 X{clean_vars.linear_clean_start_x} Y{clean_vars.linear_clean_start_y} F{clean_vars.clean_travel_speed * 60|int}
	G0 Z{clean_vars.linear_clean_start_z} F4000
	M400
	
	{% if clean_vars.linear_clean_axis in ['X', 'x']|string %}
	{% for passes in range(1, (clean_vars.linear_pass_count)) %}
	_LINEAR_STEP_CONTROL_X
	{% endfor %}
	
	{% elif clean_vars.linear_clean_axis in ['Y', 'y']|string %}
	{% for passes in range(1, (clean_vars.linear_pass_count)) %}
	_LINEAR_STEP_CONTROL_Y
	{% endfor %}
	{% endif %}
	
	{% elif clean_vars.random_clean_x == True or clean_vars.random_clean_y == True %}
	
	G0 X{clean_vars.start_x} Y{clean_vars.start_y} F{clean_vars.clean_travel_speed * 60|int}
	G0 Z{clean_vars.start_z} F4000
	M400
	
	{% for passes in range(1, (clean_vars.pass_count)) %}
	_step_control
	{% endfor %}
	{% endif %}
	
	G0 Z{clean_vars.park_z} F4000
	{% if printer.print_stats.state != 'printing' %}
	G0 X{clean_vars.end_position_x} Y{clean_vars.end_position_y}
	G0 X{clean_vars.park_x} Y{clean_vars.park_y} Z{clean_vars.park_z} F4000
	{% endif %}
	M117
	M400
	{% if start_vars.neopixel_led == True %}
	STATUS_READY
	{% endif %}
	
	{% if cool|lower in ['yes', 'true'] %}
	{% if printer.print_stats.state not in ['printing', 'paused'] %}
	SET_DISPLAY_TEXT MSG="Post nozzle clean cooling to {cool_temp}c"
	RESPOND TYPE=COMMAND MSG="Post nozzle clean cooling to {cool_temp}c"
	SET_HEATER_TEMPERATURE HEATER=extruder TARGET={cool_temp}
	M117
	
	{% elif printer.print_stats.state in ['printing', 'paused'] %}
	SET_DISPLAY_TEXT MSG="Cooling denied, print in progress!"
	RESPOND TYPE=COMMAND MSG="Cooling denied, print in progress!"
	{% endif %}
	{% endif %}
	
	_SAVE
	
	{% else %}
	{action_raise_error("This error is caused by the nozzle_cleaner variable not being enabled, check the demon_user_settings file!")}
	{% endif %}
	
	{% endif %}

[gcode_macro CENTER]
gcode = 
	G0  X175 Y175 F5000

[gcode_macro _CALIBRATION_ZOFFSET]
gcode = 
	M117 Calibrate Offset
	QUAD_GANTRY_LEVEL
	M140 S65
	G4 P500
	CLEAN_NOZZLE
	G4 P500
	M117 Z-offset calibration
	Z_OFFSET_CALIBRATION
	Z_OFFSET_APPLY_PROBE
	M400
	G4 P3000
	SAVE_CONFIG

[delayed_gcode _auto_zoffset]
gcode = 
	SAVE_VARIABLE VARIABLE=offsetadjust VALUE={'%05.2f' % (0)}
	_CALIBRATION_ZOFFSET

[gcode_macro _Delay_Calibrate]
gcode = 
	UPDATE_DELAYED_GCODE ID=_auto_zoffset DURATION=1.0

[delayed_gcode TEST_BELT]
initial_duration = 0.3
gcode = 
	{% set x_freq = printer.save_variables.variables.x_freq|float %}
	{% set y_freq = printer.save_variables.variables.y_freq|float %}
	{% set show_freq = printer.save_variables.variables.show_freq %}
	{% if show_freq == 1 %}
	M117 x {x_freq}, y {y_freq}
	SAVE_VARIABLE VARIABLE=show_freq VALUE=0
	{% endif %}

[gcode_macro QUAD_GANTRY_LEVEL]
rename_existing = QUAD_GANTRY_LEVEL_BASE
gcode = 
	{% set mesh_name = "default" %}
	{% set mesh_calibrate_temp = printer['gcode_macro _global_var'].bed_mesh_calibrate_target_temp|int %}
	{% set current_target_temp  = printer.heater_bed.target|int %}
	
	{action_respond_info("Check Heating!")}
	{% if printer.heater_bed.temperature != mesh_calibrate_temp %}
	{action_respond_info("The bed target temperature was not reached!")}
	{action_respond_info("Bed heating...")}
	{% if current_target_temp <= mesh_calibrate_temp %}
	M190 S{mesh_calibrate_temp}
	{% else %}
	M190 S{current_target_temp}
	{% endif %}
	{% endif %}
	
	{% if printer.toolhead.homed_axes|lower != "xyz" %}
	G28
	{% endif %}
	
	QUAD_GANTRY_LEVEL_BASE
	
	{% if current_target_temp == 0 %}
	M140 S0
	{% endif %}

[gcode_macro PROBE_CALIBRATE]
rename_existing = PROBE_CALIBRATE_BASE
gcode = 
	{% set current_target_temp  = printer.heater_bed.target|int %}
	{% set z_offset_calibrate_temp = printer['gcode_macro _global_var'].bed_mesh_calibrate_target_temp|int %}
	
	{action_respond_info("z_offset_calibrate")}
	{% if printer.heater_bed.temperature != z_offset_calibrate_temp %}
	M140 S{z_offset_calibrate_temp}
	{action_respond_info("The bed target temperature was not reached!")}
	{action_respond_info("Bed heating...")}
	M190 S{z_offset_calibrate_temp}
	{% endif %}
	
	G28
	PROBE_CALIBRATE_BASE
	TESTZ z=-4

[gcode_macro BED_MESH_CALIBRATE]
rename_existing = BED_MESH_CALIBRATE_BASE
gcode = 
	
	{% set mesh_name = "default" %}
	{% set mesh_calibrate_temp = printer['gcode_macro _global_var'].bed_mesh_calibrate_target_temp|int %}
	{% set current_target_temp  = printer.heater_bed.target|int %}
	
	{action_respond_info("Check Heating!")}
	{% if printer.heater_bed.temperature != mesh_calibrate_temp %}
	{action_respond_info("The bed target temperature was not reached!")}
	{action_respond_info("Bed heating...")}
	{% if current_target_temp <= mesh_calibrate_temp %}
	M190 S{mesh_calibrate_temp}
	{% else %}
	M190 S{current_target_temp}
	{% endif %}
	{% endif %}
	
	{% if printer.toolhead.homed_axes|lower != "xyz" %}
	G28
	{% endif %}
	
	BED_MESH_CLEAR
	
	BED_MESH_CALIBRATE_BASE ADAPTIVE=1
	
	{% if current_target_temp == 0 %}
	M140 S0
	{% endif %}

[gcode_macro G34]
gcode = 
	BED_MESH_CLEAR
	{% if printer.toolhead.homed_axes|lower != "xyz" %}
	G28
	{% else %}
	G28 Z
	{% endif %}
	QUAD_GANTRY_LEVEL
	G28 Z
	G0 X175 Y175 Z30 F3600

[delayed_gcode bed_mesh_init]
initial_duration = .01
gcode = 
	BED_MESH_PROFILE LOAD=default

[delayed_gcode _print_start_wait]
gcode = 
	{% if printer['gcode_macro START_PRINT'].state == 'Heating'%}
	{action_respond_info("Prepare->Heating!")}
	{% elif printer['gcode_macro START_PRINT'].state == 'Start' %}
	{action_respond_info("Heating->Start!")}
	{% endif %}
	
	{% if printer['gcode_macro START_PRINT'].execute|lower != 'false' %}
	START_PRINT
	{% endif %}

[delayed_gcode _resume_wait]
gcode = 
	{% if printer['gcode_macro RESUME'].execute|lower != 'false' %}
	RESUME
	{% endif %}

[gcode_macro LOAD_FILAMENT]
gcode = 
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	{% set core_vars = printer["gcode_macro _CORE_VARS"] %}
	{% set ceal = printer["gcode_macro CUSTOM_EXPANSION_ACTIVE_LIST"] %}
	{% set speed = params.SPEED_MMsec|default(7)|float * 60 %}
	{% set temp = params.TEMP|default(250)|int %}
	{% set cool = params.COOL|default('No')|string %}
	{% set cool_temp = params.COOL_TEMP|default(160)|int %}
	{% set max_velocity = printer.configfile.settings['extruder'].max_extrude_only_velocity * 60 %}
	
	_MAX_EXTRUDE_CHECK
	
	SAVE_GCODE_STATE NAME=load_state
	
	_ENCODER_FEED_CHECK_PREP
	M400
	
	{% if ceal.ceal_master_enable == True %}
	{% if ceal.pre_load == True %}
	_CUSTOM_PRE_LOAD {rawparams}
	{% endif %}
	{% endif %}
	
	{% if printer.print_stats.state not in ['printing', 'paused'] %}
	{% if "xyz" not in printer.toolhead.homed_axes %}
	{% if core_vars.last_known_z|float < 50|float %}
	Z_ASCENDER HEIGHT={(50 - core_vars.last_known_z|float)}
	{% endif %}
	
	{% else %}
	{% if printer.toolhead.position.z|float < start_vars.filament_change_park_min_z|float %}
	G90
	G0 Z{start_vars.filament_change_park_min_z} F3600
	{% endif %}
	G0 X{start_vars.filament_change_park_x} Y{start_vars.filament_change_park_y} F9000
	{% endif %}
	
	SET_DISPLAY_TEXT MSG="Load hotend heating..."
	RESPOND TYPE=COMMAND MSG="Load hotend heating..."
	SET_HEATER_TEMPERATURE HEATER=extruder TARGET={temp}
	TEMPERATURE_WAIT SENSOR=extruder MINIMUM={temp|int -2} MAXIMUM={temp|int + 5}
	M117
	{% endif %}
	
	M83
	G92 E0
	G1 E{start_vars.load_length} F{max_velocity}
	M400
	_ENCODER_FEED_CHECK
	
	G1 E{start_vars.load_purge_length} F{speed}
	
	
	{% if cool|lower in ['yes', 'true'] %}
	{% if printer.print_stats.state not in ['printing', 'paused'] and (temp >= printer.configfile.settings['extruder'].min_extrude_temp) %}
	SET_DISPLAY_TEXT MSG="Post load hotend cooling..."
	RESPOND TYPE=COMMAND MSG="Post load hotend cooling..."
	SET_HEATER_TEMPERATURE HEATER=extruder TARGET={cool_temp}
	
	
	
	M117
	
	{% elif printer.print_stats.state in ['printing', 'paused'] %}
	SET_DISPLAY_TEXT MSG="Load cooling denied, print in progress!"
	RESPOND TYPE=COMMAND MSG="Load cooling denied, print in progress!"
	{% endif %}
	{% endif %}
	
	{% if ceal.ceal_master_enable == True %}
	{% if ceal.post_load == True %}
	_CUSTOM_POST_LOAD {rawparams}
	{% endif %}
	{% endif %}
	
	RESTORE_GCODE_STATE NAME=load_state
	{% if "xyz" in printer.toolhead.homed_axes %}
	_SAVE
	{% endif %}

[gcode_macro UNLOAD_FILAMENT]
gcode = 
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	{% set core_vars = printer["gcode_macro _CORE_VARS"] %}
	{% set ceal = printer["gcode_macro CUSTOM_EXPANSION_ACTIVE_LIST"] %}
	{% set speed = params.SPEED_MMsec|default(7)|float * 60 %}
	{% set temp = params.TEMP|default(250)|int %}
	{% set cool = params.COOL|default('No')|string %}
	{% set cool_temp = params.COOL_TEMP|default(160)|int %}
	{% set max_velocity = printer.configfile.settings['extruder'].max_extrude_only_velocity * 60 %}
	
	_MAX_EXTRUDE_CHECK
	
	SAVE_GCODE_STATE NAME=unload_state
	
	_ENCODER_FEED_CHECK_PREP
	M400
	
	{% if ceal.ceal_master_enable == True %}
	{% if ceal.pre_unload == True %}
	_CUSTOM_PRE_UNLOAD {rawparams}
	{% endif %}
	{% endif %}
	
	{% if printer.print_stats.state not in ['printing', 'paused'] %}
	{% if "xyz" not in printer.toolhead.homed_axes %}
	{% if core_vars.last_known_z|float < 50|float %}
	Z_ASCENDER HEIGHT={(50 - core_vars.last_known_z|float)}
	{% endif %}
	
	{% else %}
	{% if printer.toolhead.position.z|float < start_vars.filament_change_park_min_z|float %}
	G90
	G0 Z{start_vars.filament_change_park_min_z} F3600
	{% endif %}
	G0 X{start_vars.filament_change_park_x} Y{start_vars.filament_change_park_y} F9000
	{% endif %}
	
	SET_DISPLAY_TEXT MSG="Unload hotend heating..."
	RESPOND TYPE=COMMAND MSG="Unload hotend heating..."
	SET_HEATER_TEMPERATURE HEATER=extruder TARGET={temp}
	TEMPERATURE_WAIT SENSOR=extruder MINIMUM={temp|int -2} MAXIMUM={temp|int + 5}
	M117
	{% endif %}
	
	M83
	G92 E0
	G1 E{start_vars.unload_purge_length} F{speed}
	M400
	_ENCODER_FEED_CHECK
	G1 E-5 F{max_velocity}
	G4 P8000
	
	G1 E-{start_vars.unload_length} F{max_velocity}
	
	{% if cool|lower in ['yes', 'true'] %}
	{% if printer.print_stats.state not in ['printing', 'paused'] and (temp >= printer.configfile.settings['extruder'].min_extrude_temp) %}
	SET_DISPLAY_TEXT MSG="Post unload hotend cooling..."
	RESPOND TYPE=COMMAND MSG="Post unload hotend cooling..."
	SET_HEATER_TEMPERATURE HEATER=extruder TARGET={cool_temp}
	
	
	
	M117
	
	{% elif printer.print_stats.state in ['printing', 'paused'] %}
	SET_DISPLAY_TEXT MSG="Unload cooling denied, print in progress!"
	RESPOND TYPE=COMMAND MSG="Unload cooling denied, print in progress!"
	{% endif %}
	{% endif %}
	
	{% if ceal.ceal_master_enable == True %}
	{% if ceal.post_unload == True %}
	_CUSTOM_POST_UNLOAD {rawparams}
	{% endif %}
	{% endif %}
	
	RESTORE_GCODE_STATE NAME=unload_state
	{% if "xyz" in printer.toolhead.homed_axes %}
	_SAVE
	{% endif %}

[gcode_macro M109]
rename_existing = M99109
gcode = 
	{% set s = params.S|float %}
	M104 {% for p in params %}{'%s%s' % (p, params[p])}{% endfor %}
	{% if s != 0 %}
	TEMPERATURE_WAIT SENSOR=extruder MINIMUM={s-1} MAXIMUM={s+1}
	{% endif %}

[gcode_macro M190]
rename_existing = M99190
gcode = 
	{% set s = params.S|float %}
	M140 {% for p in params %}{'%s%s' % (p, params[p])}{% endfor %}
	{% if s != 0 %}
	TEMPERATURE_WAIT SENSOR=heater_bed MINIMUM={s-1} MAXIMUM={s+1}
	{% endif %}

[gcode_macro M600]
gcode = 
	PAUSE STATE=filament_change

[gcode_macro GET_TIMELAPSE_SETUP]
description = Print the Timelapse setup
gcode = 
	{% set tl = printer['gcode_macro TIMELAPSE_TAKE_FRAME'] %}
	{% set output_txt = ["Timelapse Setup:"] %}
	{% set _dummy = output_txt.append("enable: %s" % tl.enable) %}
	{% set _dummy = output_txt.append("park: %s" % tl.park.enable) %}
	{% if tl.park.enable %}
	{% set _dummy = output_txt.append("park position: %s time: %s s" % (tl.park.pos, tl.park.time)) %}
	{% set _dummy = output_txt.append("park cord x:%s y:%s dz:%s" % (tl.park.coord.x, tl.park.coord.y, tl.park.coord.dz)) %}
	{% set _dummy = output_txt.append("travel speed: %s mm/s" % tl.speed.travel) %}
	{% endif %}
	{% set _dummy = output_txt.append("fw_retract: %s" % tl.extruder.fw_retract) %}
	{% if not tl.extruder.fw_retract %}
	{% set _dummy = output_txt.append("retract: %s mm speed: %s mm/s" % (tl.extruder.retract, tl.speed.retract)) %}
	{% set _dummy = output_txt.append("extrude: %s mm speed: %s mm/s" % (tl.extruder.extrude, tl.speed.extrude)) %}
	{% endif %}
	{% set _dummy = output_txt.append("verbose: %s" % tl.verbose) %}
	{action_respond_info(output_txt|join("\n"))}

[gcode_macro _SET_TIMELAPSE_SETUP]
description = Set user parameters for timelapse
gcode = 
	{% set tl = printer['gcode_macro TIMELAPSE_TAKE_FRAME'] %}
	
	{% set min = printer.toolhead.axis_minimum %}
	{% set max = printer.toolhead.axis_maximum %}
	{% set round_bed = True if printer.configfile.settings.printer.kinematics is in ['delta','polar','rotary_delta','winch']
	else False %}
	{% set park = {'min'   : {'x': (min.x / 1.42)|round(3) if round_bed else min.x|round(3),
	'y': (min.y / 1.42)|round(3) if round_bed else min.y|round(3)},
	'max'   : {'x': (max.x / 1.42)|round(3) if round_bed else max.x|round(3),
	'y': (max.y / 1.42)|round(3) if round_bed else max.y|round(3)},
	'center': {'x': (max.x-(max.x-min.x)/2)|round(3),
	'y': (max.y-(max.y-min.y)/2)|round(3)}} %}
	
	{% if params.ENABLE %}
	{% if params.ENABLE|lower is in ['true', 'false'] %}
	SET_GCODE_VARIABLE MACRO=TIMELAPSE_TAKE_FRAME VARIABLE=enable VALUE={True if params.ENABLE|lower == 'true' else False}
	{% else %}
	{action_raise_error("ENABLE=%s not supported. Allowed values are [True, False]" % params.ENABLE|capitalize)}
	{% endif %}
	{% endif %}
	{% if params.VERBOSE %}
	{% if params.VERBOSE|lower is in ['true', 'false'] %}
	SET_GCODE_VARIABLE MACRO=TIMELAPSE_TAKE_FRAME VARIABLE=verbose VALUE={True if params.VERBOSE|lower == 'true' else False}
	{% else %}
	{action_raise_error("VERBOSE=%s not supported. Allowed values are [True, False]" % params.VERBOSE|capitalize)}
	{% endif %}
	{% endif %}
	{% if params.CUSTOM_POS_X %}
	{% if params.CUSTOM_POS_X|float >= min.x and params.CUSTOM_POS_X|float <= max.x %}
	{% set _dummy = tl.park.custom.update({'x':params.CUSTOM_POS_X|float|round(3)}) %}
	{% else %}
	{action_raise_error("CUSTOM_POS_X=%s must be within [%s - %s]" % (params.CUSTOM_POS_X, min.x, max.x))}
	{% endif %}
	{% endif %}
	{% if params.CUSTOM_POS_Y %}
	{% if params.CUSTOM_POS_Y|float >= min.y and params.CUSTOM_POS_Y|float <= max.y %}
	{% set _dummy = tl.park.custom.update({'y':params.CUSTOM_POS_Y|float|round(3)}) %}
	{% else %}
	{action_raise_error("CUSTOM_POS_Y=%s must be within [%s - %s]" % (params.CUSTOM_POS_Y, min.y, max.y))}
	{% endif %}
	{% endif %}
	{% if params.CUSTOM_POS_DZ %}
	{% if params.CUSTOM_POS_DZ|float >= min.z and params.CUSTOM_POS_DZ|float <= max.z %}
	{% set _dummy = tl.park.custom.update({'dz':params.CUSTOM_POS_DZ|float|round(3)}) %}
	{% else %}
	{action_raise_error("CUSTOM_POS_DZ=%s must be within [%s - %s]" % (params.CUSTOM_POS_DZ, min.z, max.z))}
	{% endif %}
	{% endif %}
	{% if params.PARK_ENABLE %}
	{% if params.PARK_ENABLE|lower is in ['true', 'false'] %}
	{% set _dummy = tl.park.update({'enable':True if params.PARK_ENABLE|lower == 'true' else False}) %}
	{% else %}
	{action_raise_error("PARK_ENABLE=%s not supported. Allowed values are [True, False]" % params.PARK_ENABLE|capitalize)}
	{% endif %}
	{% endif %}
	{% if params.PARK_POS %}
	{% if params.PARK_POS|lower is in ['center','front_left','front_right','back_left','back_right','custom','x_only','y_only'] %}
	{% set dic = {'center'      : {'x': park.center.x   , 'y': park.center.y   , 'dz': 1                },
	'front_left'  : {'x': park.min.x      , 'y': park.min.y      , 'dz': 0                },
	'front_right' : {'x': park.max.x      , 'y': park.min.y      , 'dz': 0                },
	'back_left'   : {'x': park.min.x      , 'y': park.max.y      , 'dz': 0                },
	'back_right'  : {'x': park.max.x      , 'y': park.max.y      , 'dz': 0                },
	'custom'      : {'x': tl.park.custom.x, 'y': tl.park.custom.y, 'dz': tl.park.custom.dz},
	'x_only'      : {'x': tl.park.custom.x, 'y': 'none'          , 'dz': tl.park.custom.dz},
	'y_only'      : {'x': 'none'          , 'y': tl.park.custom.y, 'dz': tl.park.custom.dz}} %}
	{% set _dummy = tl.park.update({'pos':params.PARK_POS|lower}) %}
	{% set _dummy = tl.park.update({'coord':dic[tl.park.pos]}) %}
	{% else %}
	{action_raise_error("PARK_POS=%s not supported. Allowed values are [CENTER, FRONT_LEFT, FRONT_RIGHT, BACK_LEFT, BACK_RIGHT, CUSTOM, X_ONLY, Y_ONLY]"
	% params.PARK_POS|upper)}
	{% endif %}
	{% endif %}
	{% if params.PARK_TIME %}
	{% if params.PARK_TIME|float >= 0.0 %}
	{% set _dummy = tl.park.update({'time':params.PARK_TIME|float|round(3)}) %}
	{% else %}
	{action_raise_error("PARK_TIME=%s must be a positive number" % params.PARK_TIME)}
	{% endif %}
	{% endif %}
	SET_GCODE_VARIABLE MACRO=TIMELAPSE_TAKE_FRAME VARIABLE=park VALUE="{tl.park}"
	{% if params.TRAVEL_SPEED %}
	{% if params.TRAVEL_SPEED|float > 0.0 %}
	{% set _dummy = tl.speed.update({'travel':params.TRAVEL_SPEED|float|round(3)}) %}
	{% else %}
	{action_raise_error("TRAVEL_SPEED=%s must be larger than 0" % params.TRAVEL_SPEED)}
	{% endif %}
	{% endif %}
	{% if params.RETRACT_SPEED %}
	{% if params.RETRACT_SPEED|float > 0.0 %}
	{% set _dummy = tl.speed.update({'retract':params.RETRACT_SPEED|float|round(3)}) %}
	{% else %}
	{action_raise_error("RETRACT_SPEED=%s must be larger than 0" % params.RETRACT_SPEED)}
	{% endif %}
	{% endif %}
	{% if params.EXTRUDE_SPEED %}
	{% if params.EXTRUDE_SPEED|float > 0.0 %}
	{% set _dummy = tl.speed.update({'extrude':params.EXTRUDE_SPEED|float|round(3)}) %}
	{% else %}
	{action_raise_error("EXTRUDE_SPEED=%s must be larger than 0" % params.EXTRUDE_SPEED)}
	{% endif %}
	{% endif %}
	SET_GCODE_VARIABLE MACRO=TIMELAPSE_TAKE_FRAME VARIABLE=speed VALUE="{tl.speed}"
	{% if params.EXTRUDE_DISTANCE %}
	{% if params.EXTRUDE_DISTANCE|float >= 0.0 %}
	{% set _dummy = tl.extruder.update({'extrude':params.EXTRUDE_DISTANCE|float|round(3)}) %}
	{% else %}
	{action_raise_error("EXTRUDE_DISTANCE=%s must be specified as positiv number" % params.EXTRUDE_DISTANCE)}
	{% endif %}
	{% endif %}
	{% if params.RETRACT_DISTANCE %}
	{% if params.RETRACT_DISTANCE|float >= 0.0 %}
	{% set _dummy = tl.extruder.update({'retract':params.RETRACT_DISTANCE|float|round(3)}) %}
	{% else %}
	{action_raise_error("RETRACT_DISTANCE=%s must be specified as positiv number" % params.RETRACT_DISTANCE)}
	{% endif %}
	{% endif %}
	{% if params.FW_RETRACT %}
	{% if params.FW_RETRACT|lower is in ['true', 'false'] %}
	{% if 'firmware_retraction' in printer.configfile.settings %}
	{% set _dummy = tl.extruder.update({'fw_retract': True if params.FW_RETRACT|lower == 'true' else False}) %}
	{% else %}
	{% set _dummy = tl.extruder.update({'fw_retract':False}) %}
	{% if params.FW_RETRACT|capitalize == 'True' %}
	{action_raise_error("[firmware_retraction] not defined in printer.cfg. Can not enable fw_retract")}
	{% endif %}
	{% endif %}
	{% else %}
	{action_raise_error("FW_RETRACT=%s not supported. Allowed values are [True, False]" % params.FW_RETRACT|capitalize)}
	{% endif %}
	{% endif %}
	SET_GCODE_VARIABLE MACRO=TIMELAPSE_TAKE_FRAME VARIABLE=extruder VALUE="{tl.extruder}"
	{% if printer.configfile.settings['gcode_macro pause'] is defined %}
	{% set _dummy = tl.macro.update({'pause': printer.configfile.settings['gcode_macro pause'].rename_existing}) %}
	{% endif %}
	{% if printer.configfile.settings['gcode_macro resume'] is defined %}
	{% set _dummy = tl.macro.update({'resume': printer.configfile.settings['gcode_macro resume'].rename_existing}) %}
	{% endif %}
	SET_GCODE_VARIABLE MACRO=TIMELAPSE_TAKE_FRAME VARIABLE=macro VALUE="{tl.macro}"

[gcode_macro TIMELAPSE_TAKE_FRAME]
description = Take Timelapse shoot
variable_enable = False
variable_takingframe = False
variable_park = {'enable': False,
	'pos'   : 'center',
	'time'  : 0.1,
	'custom': {'x': 0, 'y': 0, 'dz': 0},
	'coord' : {'x': 0, 'y': 0, 'dz': 0}}
variable_extruder = {'fw_retract': False,
	'retract': 1.0,
	'extrude': 1.0}
variable_speed = {'travel': 100,
	'retract': 15,
	'extrude': 15}
variable_verbose = True
variable_check_time = 0.5
variable_restore = {'absolute': {'coordinates': True, 'extrude': True}, 'speed': 1500, 'e':0, 'factor': {'speed': 1.0, 'extrude': 1.0}}
variable_macro = {'pause': 'PAUSE', 'resume': 'RESUME'}
variable_is_paused = False
gcode = 
	{% set hyperlapse = True if params.HYPERLAPSE and params.HYPERLAPSE|lower =='true' else False %}
	{% if enable %}
	{% if (hyperlapse and printer['gcode_macro HYPERLAPSE'].run) or
	(not hyperlapse and not printer['gcode_macro HYPERLAPSE'].run) %}
	{% if park.enable %}
	{% set pos = {'x': 'X' + park.coord.x|string if park.pos != 'y_only' else '',
	'y': 'Y' + park.coord.y|string if park.pos != 'x_only' else '',
	'z': 'Z'+ [printer.gcode_move.gcode_position.z + park.coord.dz, printer.toolhead.axis_maximum.z]|min|string} %}
	{% set restore = {'absolute': {'coordinates': printer.gcode_move.absolute_coordinates,
	'extrude'    : printer.gcode_move.absolute_extrude},
	'speed'   : printer.gcode_move.speed,
	'e'       : printer.gcode_move.gcode_position.e,
	'factor'  : {'speed'  : printer.gcode_move.speed_factor,
	'extrude': printer.gcode_move.extrude_factor}} %}
	SET_GCODE_VARIABLE MACRO=TIMELAPSE_TAKE_FRAME VARIABLE=restore VALUE="{restore}"
	{% if not printer[printer.toolhead.extruder].can_extrude %}
	{% if verbose %}{action_respond_info("Timelapse: Warning, minimum extruder temperature not reached!")}{% endif %}
	{% else %}
	{% if extruder.fw_retract %}
	G10
	{% else %}
	M83
	G0 E-{extruder.retract} F{speed.retract * 60}
	{% endif %}
	{% endif %}
	SET_GCODE_VARIABLE MACRO=TIMELAPSE_TAKE_FRAME VARIABLE=is_paused VALUE=True
	{macro.pause}
	SET_GCODE_OFFSET X=0 Y=0
	G90
	{% if "xyz" not in printer.toolhead.homed_axes %}
	{% if verbose %}{action_respond_info("Timelapse: Warning, axis not homed yet!")}{% endif %}
	{% else %}
	G0 {pos.x} {pos.y} {pos.z} F{speed.travel * 60}
	{% endif %}
	SET_GCODE_VARIABLE MACRO=TIMELAPSE_TAKE_FRAME VARIABLE=takingframe VALUE=True
	UPDATE_DELAYED_GCODE ID=_WAIT_TIMELAPSE_TAKE_FRAME DURATION={check_time}
	M400
	{% endif %}
	_TIMELAPSE_NEW_FRAME HYPERLAPSE={hyperlapse}
	{% endif %}
	{% else %}
	{% if verbose %}{action_respond_info("Timelapse: disabled, take frame ignored")}{% endif %}
	{% endif %}

[gcode_macro _TIMELAPSE_NEW_FRAME]
description = action call for timelapse shoot. must be a seperate macro
gcode = 
	{action_call_remote_method("timelapse_newframe",
	macropark=printer['gcode_macro TIMELAPSE_TAKE_FRAME'].park,
	hyperlapse=params.HYPERLAPSE)}

[delayed_gcode _WAIT_TIMELAPSE_TAKE_FRAME]
gcode = 
	{% set tl = printer['gcode_macro TIMELAPSE_TAKE_FRAME'] %}
	{% set factor = {'speed': printer.gcode_move.speed_factor, 'extrude': printer.gcode_move.extrude_factor} %}
	{% if tl.takingframe %}
	UPDATE_DELAYED_GCODE ID=_WAIT_TIMELAPSE_TAKE_FRAME DURATION={tl.check_time}
	{% else %}
	{tl.macro.resume} VELOCITY={tl.speed.travel}
	SET_GCODE_VARIABLE MACRO=TIMELAPSE_TAKE_FRAME VARIABLE=is_paused VALUE=False
	{% if not printer[printer.toolhead.extruder].can_extrude %}
	{action_respond_info("Timelapse: Warning minimum extruder temperature not reached!")}
	{% else %}
	{% if tl.extruder.fw_retract %}
	G11
	{% else %}
	G0 E{tl.extruder.extrude} F{tl.speed.extrude * 60}
	G0 F{tl.restore.speed}
	{% if tl.restore.absolute.extrude %}
	M82
	G92 E{tl.restore.e}
	{% endif %}
	{% endif %}
	{% endif %}
	{% if tl.restore.factor.speed   != factor.speed   %} M220 S{(factor.speed*100)|round(0)}   {% endif %}
	{% if tl.restore.factor.extrude != factor.extrude %} M221 S{(factor.extrude*100)|round(0)} {% endif %}
	{% if not tl.restore.absolute.coordinates %} G91 {% endif %}
	{% endif %}

[gcode_macro HYPERLAPSE]
description = Start/Stop a hyperlapse recording
variable_cycle = 0
variable_run = False
gcode = 
	{% set cycle = params.CYCLE|default(30)|int %}
	{% if params.ACTION and params.ACTION|lower == 'start' %}
	{action_respond_info("Hyperlapse: frames started (Cycle %d sec)" % cycle)}
	SET_GCODE_VARIABLE MACRO=HYPERLAPSE VARIABLE=run VALUE=True
	SET_GCODE_VARIABLE MACRO=HYPERLAPSE VARIABLE=cycle VALUE={cycle}
	UPDATE_DELAYED_GCODE ID=_HYPERLAPSE_LOOP DURATION={cycle}
	TIMELAPSE_TAKE_FRAME HYPERLAPSE=True
	{% elif params.ACTION and params.ACTION|lower == 'stop' %}
	{% if run %}{action_respond_info("Hyperlapse: frames stopped")}{% endif %}
	SET_GCODE_VARIABLE MACRO=HYPERLAPSE VARIABLE=run VALUE=False
	UPDATE_DELAYED_GCODE ID=_HYPERLAPSE_LOOP DURATION=0
	{% else %}
	{action_raise_error("Hyperlapse: No valid input parameter
	Use:
	- HYPERLAPSE ACTION=START [CYCLE=time]
	- HYPERLAPSE ACTION=STOP")}
	{% endif %}

[delayed_gcode _HYPERLAPSE_LOOP]
gcode = 
	UPDATE_DELAYED_GCODE ID=_HYPERLAPSE_LOOP DURATION={printer["gcode_macro HYPERLAPSE"].cycle}
	TIMELAPSE_TAKE_FRAME HYPERLAPSE=True

[gcode_macro TIMELAPSE_RENDER]
description = Render Timelapse video and wait for the result
variable_render = False
variable_run_identifier = 0
gcode = 
	{action_respond_info("Timelapse: Rendering started")}
	{action_call_remote_method("timelapse_render", byrendermacro="True")}
	SET_GCODE_VARIABLE MACRO=TIMELAPSE_RENDER VARIABLE=render VALUE=True
	{printer.configfile.settings['gcode_macro pause'].rename_existing}
	UPDATE_DELAYED_GCODE ID=_WAIT_TIMELAPSE_RENDER DURATION=0.5

[delayed_gcode _WAIT_TIMELAPSE_RENDER]
gcode = 
	{% set ri = printer['gcode_macro TIMELAPSE_RENDER'].run_identifier % 4 %}
	SET_GCODE_VARIABLE MACRO=TIMELAPSE_RENDER VARIABLE=run_identifier VALUE={ri + 1}
	{% if printer['gcode_macro TIMELAPSE_RENDER'].render %}
	M117 Rendering {['-','\\','|','/'][ri]}
	UPDATE_DELAYED_GCODE ID=_WAIT_TIMELAPSE_RENDER DURATION=0.5
	{% else %}
	{action_respond_info("Timelapse: Rendering finished")}
	M117
	{printer.configfile.settings['gcode_macro resume'].rename_existing}
	{% endif %}

[gcode_macro TEST_STREAM_DELAY]
description = Helper macro to find stream and park delay
gcode = 
	{% set min = printer.toolhead.axis_minimum %}
	{% set max = printer.toolhead.axis_maximum %}
	{% set act = printer.toolhead.position %}
	{% set tl = printer['gcode_macro TIMELAPSE_TAKE_FRAME'] %}
	{% if act.z > 5.0 %}
	G0 X{min.x + 5.0} F{tl.speed.travel|int * 60}
	G0 X{(max.x-min.x)/2}
	G4 P{tl.park.time|float * 1000}
	_TIMELAPSE_NEW_FRAME HYPERLAPSE=FALSE
	G0 X{max.x - 5.0}
	{% else %}
	{action_raise_error("Toolhead z %.3f to low. Please place head above z = 5.0" % act.z)}
	{% endif %}

[board_pins]
aliases = 
	
	EXP1_1=PA8,   EXP1_2=PC9,
	EXP1_3=PA10,  EXP1_4=PA9,
	EXP1_5=PC11,  EXP1_6=PC10,
	EXP1_7=PD8,   EXP1_8=PC12,
	EXP1_9=<GND>, EXP1_10=<5V>,
	
	
	EXP2_1=PB14,  EXP2_2=PB13,
	EXP2_3=PC7,   EXP2_4=PB12,
	EXP2_5=PC6,   EXP2_6=PB15,
	EXP2_7=PC8,   EXP2_8=<RST>,
	EXP2_9=<GND>, EXP2_10=<5V>

[display]
lcd_type = uc1701
cs_pin = EXP1_3
a0_pin = EXP1_4
rst_pin = EXP1_5
encoder_pins = ^EXP2_3, ^EXP2_5
click_pin = ^!EXP1_2
contrast = 63
spi_software_miso_pin = EXP2_1
spi_software_mosi_pin = EXP2_6
spi_software_sclk_pin = EXP2_2

[output_pin beeper]
pin = EXP1_1
pwm = False
value = 0

[neopixel Screen_Colour]
pin = EXP1_6
chain_count = 3
color_order = RGB
initial_red = 0.5
initial_green = 0.4
initial_blue = 0.7

[gcode_macro BEEP]
gcode = 
	SET_PIN PIN=beeper VALUE=1
	G4 P10
	SET_PIN PIN=beeper VALUE=0

[menu __resume]
type = list
name = Resume

[menu __resume __resume]
type = command
name = Resume
gcode = 

[menu __resume __cancel]
type = command
name = Cancel
gcode = 

[menu __main]
type = list
name = Main

[menu __main __tune]
type = list
enable = {printer.print_stats.state == "paused" or printer.idle_timeout.state == "Printing"}
name = Tune
index = 1

[menu __main __tune __speed]
type = input
name = Speed: {'%3d' % (menu.input*100)}%
input = {printer.gcode_move.speed_factor}
input_min = 0.01
input_max = 5
input_step = 0.01
realtime = True
gcode = 
	M220 S{'%d' % (menu.input*100)}

[menu __main __tune __flow]
type = input
name = Flow: {'%3d' % (menu.input*100)}%
input = {printer.gcode_move.extrude_factor}
input_min = 0.01
input_max = 2
input_step = 0.01
realtime = True
gcode = 
	M221 S{'%d' % (menu.input*100)}

[menu __main __tune __fanspeed]
type = input
name = Fan speed: {'%3d' % (menu.input*100)}%
input = {printer["fan"].speed}
input_min = 0
input_max = 1
input_step = 0.01
gcode = 
	M106 S{'%d' % (menu.input*255)}

[menu __main __tune __hotend0_target]
type = input
enable = {('extruder' in printer) and ('extruder' in printer.heaters.available_heaters)}
name = {"Ex0:%3.0f (%4.0f)" % (menu.input, printer.extruder.temperature)}
input = {printer.extruder.target}
input_min = 0
input_max = {printer.configfile.config.extruder.max_temp}
input_step = 1
gcode = 
	M104 T0 S{'%.0f' % menu.input}

[menu __main __tune __hotend1_target]
type = input
enable = {('extruder1' in printer) and ('extruder1' in printer.heaters.available_heaters)}
name = {"Ex1:%3.0f (%4.0f)" % (menu.input, printer.extruder1.temperature)}
input = {printer.extruder1.target}
input_min = 0
input_max = {printer.configfile.config.extruder1.max_temp}
input_step = 1
gcode = 
	M104 T1 S{'%.0f' % menu.input}

[menu __main __tune __hotbed_target]
type = input
enable = {'heater_bed' in printer}
name = {"Bed:%3.0f (%4.0f)" % (menu.input, printer.heater_bed.temperature)}
input = {printer.heater_bed.target}
input_min = 0
input_max = {printer.configfile.config.heater_bed.max_temp}
input_step = 1
gcode = 
	M140 S{'%.0f' % menu.input}

[menu __main __tune __exhaustfanonoff]
type = command
name = Exhaust Fan {'ON' if printer['fan_generic exhaust_fan'].speed > 0 else 'OFF'}
enable = {'fan_generic exhaust_fan' in printer}
gcode = 
	{% if printer['fan_generic exhaust_fan'].speed > 0 %}
	SET_FAN_SPEED FAN=exhaust_fan SPEED=0
	{% else %}
	SET_FAN_SPEED FAN=exhaust_fan SPEED=1
	{% endif %}

[menu __main __tune __exhaustfanspeed]
type = input
name = Exhaust Fan:{'%3d' % (menu.input*100)}%
input = {printer["fan_generic exhaust_fan"].speed}
input_min = 0
input_max = 1
input_step = 0.01
gcode = 
	SET_FAN_SPEED FAN=exhaust_fan SPEED={menu.input}

[menu __main __tune __ledonoff]
type = input
enable = {'led main_led' in printer}
name = Dim LED:    {'%3d%s' % (menu.input*100,'%') if menu.input else 'OFF'}
input = {printer['output_pin main_led'].value}
input_min = 0.0
input_max = 1.0
input_step = 0.01
gcode = SET_LED LED=main_led WHITE={menu.input}

[menu __main __tune __save]
type = list
name = "Save"

[menu __main __tune __save __save_config]
type = command
name = "Save & Exit"
gcode = 
	Z_OFFSET_APPLY_PROBE
	SAVE_CONFIG

[menu __main __filament1]
type = list
enable = {('virtual_sdcard' in printer) and (printer.print_stats.state == "printing" or printer.print_stats.state == "paused")}
name = Change filament
index = 2

[menu __main __filament1 __load]
type = command
name = Load Filament
gcode = 
	PAUSE
	SAVE_GCODE_STATE NAME=__filament__load
	LOAD_FILAMENT
	RESTORE_GCODE_STATE NAME=__filament__load
	{menu.exit()}

[menu __main __filament1 __unload]
type = command
name = Unload Filament
gcode = 
	PAUSE
	SAVE_GCODE_STATE NAME=__filament__load
	UNLOAD_FILAMENT
	RESTORE_GCODE_STATE NAME=__filament__load
	{menu.exit()}

[menu __main __resume]
type = command
enable = {('virtual_sdcard' in printer) and printer.print_stats.state == "paused"}
name = Resume printing
index = 3
gcode = 
	M117 Resume printing
	{% if "pause_resume" in printer %}
	RESUME
	{% else %}
	M24
	{% endif %}
	{menu.exit()}

[menu __main __pause]
type = command
enable = {('virtual_sdcard' in printer) and printer.print_stats.state == "printing"}
name = Pause printing
index = 3
gcode = 
	M117 Pause printing
	{% if "pause_resume" in printer %}
	PAUSE
	{% else %}
	M25
	{% endif %}
	{menu.exit()}

[menu __main __cancel]
type = command
enable = {('virtual_sdcard' in printer) and (printer.print_stats.state == "printing" or printer.print_stats.state == "paused")}
name = Cancel printing
index = 3
gcode = 
	
	
	
	{% if 'pause_resume' in printer %}
	CANCEL_PRINT
	{% else %}
	M25
	M27
	M26 S0
	TURN_OFF_HEATERS
	{% if printer.toolhead.position.z <= printer.toolhead.axis_maximum.z - 5 %}
	G91
	G0 Z5 F1000
	G90
	{% endif %}
	{% endif %}
	{menu.exit()}

[menu __main __prepare]
type = list
enable = {not (printer.print_stats.state == "paused" or printer.idle_timeout.state == "Printing")}
name = Prepare
index = 4

[menu __main __prepare __home]
type = command
name = Auto Home
gcode = G28

[menu __main __prepare __preheat_pla]
type = command
enable = {('extruder' in printer) and ('heater_bed' in printer)}
name = Preheat PLA
gcode = 
	M117 Preheat PLA
	M140 S65
	M104 S200
	{menu.back()}

[menu __main __prepare __preheat_petg]
type = command
enable = {('extruder' in printer) and ('heater_bed' in printer)}
name = Preheat PETG
gcode = 
	M117 Preheat PETG
	M140 S75
	M104 S230
	{menu.back()}

[menu __main __prepare __preheat_abs]
type = command
enable = {('extruder' in printer) and ('heater_bed' in printer)}
name = Preheat ABS
gcode = 
	M117 Preheat ABS
	M140 S90
	M104 S260
	{menu.back()}

[menu __main __prepare __cooldown]
type = command
enable = {('extruder' in printer) and ('heater_bed' in printer)}
name = Cooldown
gcode = 
	M117 Cooldown
	M104 S0
	M140 S0
	{menu.back()}

[menu __main __prepare __hotend0_target]
type = input
enable = {'extruder' in printer}
name = {"Ex0:%3.0f (%4.0f)" % (menu.input, printer.extruder.temperature)}
input = {printer.extruder.target}
input_min = 0
input_max = {printer.configfile.config.extruder.max_temp}
input_step = 1
gcode = 
	M104 T0 S{'%.0f' % menu.input}

[menu __main __levelling]
type = list
enable = {not (printer.print_stats.state == "paused" or printer.idle_timeout.state == "Printing")}
name = Levelling
index = 5

[menu __main __levelling __autooffsetz]
type = command
name = Calibrate Zoffset
gcode = 
	_Delay_Calibrate

[menu __main __levelling __quad_gantry_level]
type = command
enable = {('quad_gantry_level' in printer)}
name = Quad Gantry Lvl
gcode = 
	M117 Quad Gantry Lvl
	QUAD_GANTRY_LEVEL
	{menu.exit()}

[menu __main __levelling __bed_mesh]
type = command
enable = {('bed_mesh' in printer)}
name = Bed Mesh
gcode = 
	M117 Bed Mesh
	BED_MESH_CALIBRATE ADAPTIVE=1
	SAVE_CONFIG
	{menu.exit()}

[menu __main __sdcard]
type = vsdlist
enable = {not (printer.print_stats.state == "paused" or printer.idle_timeout.state == "Printing")}
name = Print
index = 6

[menu __main __control2]
type = list
enable = {not (printer.print_stats.state == "paused" or printer.idle_timeout.state == "Printing")}
name = Control
index = 7

[menu __main __control2 __hotend0_target]
type = input
enable = {('extruder' in printer) and ('extruder' in printer.heaters.available_heaters)}
name = {"Ex0:%3.0f (%4.0f)" % (menu.input, printer.extruder.temperature)}
input = {printer.extruder.target}
input_min = 0
input_max = {printer.configfile.config.extruder.max_temp}
input_step = 1
gcode = 
	M104 T0 S{'%.0f' % menu.input}

[menu __main __control2 __hotbed_target]
type = input
enable = {'heater_bed' in printer}
name = {"Bed:%3.0f (%4.0f)" % (menu.input, printer.heater_bed.temperature)}
input = {printer.heater_bed.target}
input_min = 0
input_max = {printer.configfile.config.heater_bed.max_temp}
input_step = 1
gcode = 
	M140 S{'%.0f' % menu.input}

[menu __main __control2 __fanspeed]
type = input
name = Fan speed: {'%3d' % (menu.input*100)}%
input = {printer["fan"].speed}
input_min = 0
input_max = 1
input_step = 0.01
gcode = 
	M106 S{'%d' % (menu.input*255)}

[menu __main __control2 __exhaustfanonoff]
type = command
name = Exhaust Fan {'ON' if printer['fan_generic exhaust_fan'].speed > 0 else 'OFF'}
enable = {'fan_generic exhaust_fan' in printer}
gcode = 
	{% if printer['fan_generic exhaust_fan'].speed > 0 %}
	SET_FAN_SPEED FAN=exhaust_fan SPEED=0
	{% else %}
	SET_FAN_SPEED FAN=exhaust_fan SPEED=1
	{% endif %}

[menu __main __control2 __exhaustfanspeed]
type = input
name = ExhaustFan:{'%3d' % (menu.input*100)}%
input = {printer["fan_generic fan3"].speed}
input_min = 0
input_max = 1
input_step = 0.01
gcode = 
	M106 P3 S{'%d' % (menu.input*255)}
enable = {printer["gcode_macro _START_VARIABLES"].chamber_fan == False}

[menu __main __control2 __ledonoff]
type = input
enable = {'output_pin main_led' in printer}
name = Dim LED:    {'%3d%s' % (menu.input*100,'%') if menu.input else 'OFF'}
input = {printer['output_pin main_led'].value}
input_min = 0.0
input_max = 1.0
input_step = 0.01
gcode = SET_PIN PIN=main_led VALUE={menu.input}

[menu __main __control]
type = list
enable = {not (printer.print_stats.state == "paused" or printer.idle_timeout.state == "Printing")}
name = Move
index = 8

[menu __main __control __disable]
type = command
name = Steppers off
gcode = 
	M84
	M18
	{menu.exit()}

[menu __main __control __home]
type = command
name = Auto Home
gcode = 
	G28
	{menu.exit()}

[menu __main __control __move_10mm]
type = list
name = Move 10mm

[menu __main __control __move_10mm __axis_x]
type = input
name = Move X:{'%05.1f' % menu.input}
input = {printer.gcode_move.gcode_position.x}
input_min = {printer.toolhead.axis_minimum.x}
input_max = {printer.toolhead.axis_maximum.x}
input_step = 10.0
gcode = 
	SAVE_GCODE_STATE NAME=__move__axis
	G90
	G1 X{menu.input}
	RESTORE_GCODE_STATE NAME=__move__axis

[menu __main __control __move_10mm __axis_y]
type = input
name = Move Y:{'%05.1f' % menu.input}
input = {printer.gcode_move.gcode_position.y}
input_min = {printer.toolhead.axis_minimum.y}
input_max = {printer.toolhead.axis_maximum.y}
input_step = 10.0
gcode = 
	SAVE_GCODE_STATE NAME=__move__axis
	G90
	G1 Y{menu.input}
	RESTORE_GCODE_STATE NAME=__move__axis

[menu __main __control __move_10mm __axis_z]
type = input
name = Move Z:{'%05.1f' % menu.input}
input = {printer.gcode_move.gcode_position.z}
input_min = 0
input_max = {printer.toolhead.axis_maximum.z}
input_step = 10.0
gcode = 
	SAVE_GCODE_STATE NAME=__move__axis
	G90
	G1 Z{menu.input}
	RESTORE_GCODE_STATE NAME=__move__axis

[menu __main __control __move_10mm __axis_e]
type = input
name = Move E:{'%+06.1f' % menu.input}
input = 0
input_min = -{printer.configfile.config.extruder.max_extrude_only_distance|default(50)}
input_max = {printer.configfile.config.extruder.max_extrude_only_distance|default(50)}
input_step = 10.0
gcode = 
	SAVE_GCODE_STATE NAME=__move__axis
	M83
	G1 E{menu.input} F240
	RESTORE_GCODE_STATE NAME=__move__axis

[menu __main __control __move_1mm]
type = list
name = Move 1mm

[menu __main __control __move_1mm __axis_x]
type = input
name = Move X:{'%05.1f' % menu.input}
input = {printer.gcode_move.gcode_position.x}
input_min = {printer.toolhead.axis_minimum.x}
input_max = {printer.toolhead.axis_maximum.x}
input_step = 1.0
gcode = 
	SAVE_GCODE_STATE NAME=__move__axis
	G90
	G1 X{menu.input}
	RESTORE_GCODE_STATE NAME=__move__axis

[menu __main __control __move_1mm __axis_y]
type = input
name = Move Y:{'%05.1f' % menu.input}
input = {printer.gcode_move.gcode_position.y}
input_min = {printer.toolhead.axis_minimum.y}
input_max = {printer.toolhead.axis_maximum.y}
input_step = 1.0
gcode = 
	SAVE_GCODE_STATE NAME=__move__axis
	G90
	G1 Y{menu.input}
	RESTORE_GCODE_STATE NAME=__move__axis

[menu __main __control __move_1mm __axis_z]
type = input
enable = {not printer.idle_timeout.state == "Printing"}
name = Move Z:{'%05.1f' % menu.input}
input = {printer.gcode_move.gcode_position.z}
input_min = 0
input_max = {printer.toolhead.axis_maximum.z}
input_step = 1.0
gcode = 
	SAVE_GCODE_STATE NAME=__move__axis
	G90
	G1 Z{menu.input}
	RESTORE_GCODE_STATE NAME=__move__axis

[menu __main __control __move_1mm __axis_e]
type = input
enable = {not printer.idle_timeout.state == "Printing"}
name = Move E:{'%+06.1f' % menu.input}
input = 0
input_min = -{printer.configfile.config.extruder.max_extrude_only_distance|default(50)}
input_max = {printer.configfile.config.extruder.max_extrude_only_distance|default(50)}
input_step = 1.0
gcode = 
	SAVE_GCODE_STATE NAME=__move__axis
	M83
	G1 E{menu.input} F240
	RESTORE_GCODE_STATE NAME=__move__axis

[menu __main __control __move_01mm]
type = list
enable = {not printer.idle_timeout.state == "Printing"}
name = Move 0.1mm

[menu __main __control __move_01mm __axis_x]
type = input
name = Move X:{'%05.1f' % menu.input}
input = {printer.gcode_move.gcode_position.x}
input_min = {printer.toolhead.axis_minimum.x}
input_max = {printer.toolhead.axis_maximum.x}
input_step = 0.1
gcode = 
	SAVE_GCODE_STATE NAME=__move__axis
	G90
	G1 X{menu.input}
	RESTORE_GCODE_STATE NAME=__move__axis

[menu __main __control __move_01mm __axis_y]
type = input
name = Move Y:{'%05.1f' % menu.input}
input = {printer.gcode_move.gcode_position.y}
input_min = {printer.toolhead.axis_minimum.y}
input_max = {printer.toolhead.axis_maximum.y}
input_step = 0.1
gcode = 
	SAVE_GCODE_STATE NAME=__move__axis
	G90
	G1 Y{menu.input}
	RESTORE_GCODE_STATE NAME=__move__axis

[menu __main __control __move_01mm __axis_z]
type = input
enable = {not printer.idle_timeout.state == "Printing"}
name = Move Z:{'%05.1f' % menu.input}
input = {printer.gcode_move.gcode_position.z}
input_min = 0
input_max = {printer.toolhead.axis_maximum.z}
input_step = 0.1
gcode = 
	SAVE_GCODE_STATE NAME=__move__axis
	G90
	G1 Z{menu.input}
	RESTORE_GCODE_STATE NAME=__move__axis

[menu __main __control __move_01mm __axis_e]
type = input
enable = {not printer.idle_timeout.state == "Printing"}
name = Move E:{'%+06.1f' % menu.input}
input = 0
input_min = -{printer.configfile.config.extruder.max_extrude_only_distance|default(50)}
input_max = {printer.configfile.config.extruder.max_extrude_only_distance|default(50)}
input_step = 0.1
gcode = 
	SAVE_GCODE_STATE NAME=__move__axis
	M83
	G1 E{menu.input} F240
	RESTORE_GCODE_STATE NAME=__move__axis

[menu __main __filament]
type = list
enable = {not (printer.print_stats.state == "paused" or printer.idle_timeout.state == "Printing")}
name = Filament
index = 9

[menu __main __filament __load]
type = command
name = Load Filament
gcode = 
	{menu.exit()}
	SAVE_GCODE_STATE NAME=__filament__load
	LOAD_FILAMENT
	RESTORE_GCODE_STATE NAME=__filament__load

[menu __main __filament __unload]
type = command
name = Unload Filament
gcode = 
	{menu.exit()}
	SAVE_GCODE_STATE NAME=__filament__load
	UNLOAD_FILAMENT
	RESTORE_GCODE_STATE NAME=__filament__load

[menu __main __setup]
type = list
enable = {not (printer.print_stats.state == "paused" or printer.idle_timeout.state == "Printing")}
name = Advanced
index = 10

[menu __main __setup __belt_test]
type = command
name = "Belt test"
gcode = 
	M117 Belt test
	G28
	SHAPER_CALIBRATE TEST=1
	FIRMWARE_RESTART

[menu __main __setup __autocalib]
type = command
name = Auto-Calibrate
gcode = 
	M117 Measure Both
	ACCELEROMETER_QUERY
	G28
	SHAPER_CALIBRATE
	SAVE_CONFIG

[menu __main __setup __tuning]
type = command
name = PID tuning
gcode = 
	M117 Tune Hotend PID
	PID_CALIBRATE HEATER=extruder TARGET=210 WRITE_FILE=1
	M117 Tune Hotbed PID
	PID_CALIBRATE HEATER=heater_bed TARGET=60 WRITE_FILE=1
	SAVE_CONFIG

[menu __main __setup __restart]
type = list
name = Restart & Shutdown

[menu __main __setup __restart __host_shutdown]
type = command
enable = {not printer.idle_timeout.state == "Printing"}
name = Shutdown host
gcode = 
	{action_call_remote_method("shutdown_machine")}

[menu __main __info]
type = list
enable = {not (printer.print_stats.state == "paused" or printer.idle_timeout.state == "Printing")}
name = Information

[menu __main __info __version_name]
type = command
name = SV08 Mainline Klipper
gcode = 

[menu __main __info __version]
type = command
name = v0.1b
gcode = 

[menu __main __octoprint]
type = disabled

[menu __main __temp]
type = disabled

[menu __main __filament __hotend0_target]
type = disabled

[menu __main __filament __loadf]
type = disabled

[menu __main __filament __loads]
type = disabled

[menu __main __filament __unloadf]
type = disabled

[menu __main __filament __unloads]
type = disabled

[menu __main __filament __feed]
type = disabled

[gcode_macro _DEMON_ADAPTIVE_PA]
gcode = 
	{% set ext_type = params.TYPE|string %}
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	{% set apa_vars = printer["gcode_macro _APA_VARS"] %}
	
	{% if apa_vars.oapa == 1|int %}
	
	{% elif apa_vars.oapa == 0|int %}
	{% if apa_vars.enable == True %}
	
	{% if ext_type == "Perimeter" and apa_vars.prmtr > 0 %}
	{% if start_vars.apa_readback_enable == True %}
	RESPOND TYPE=COMMAND MSG="PA change APA setting Inner Wall {apa_vars.prmtr}"
	{% endif %}
	SET_PRESSURE_ADVANCE ADVANCE={apa_vars.prmtr}
	
	
	{% elif ext_type == "Perimeter" and apa_vars.prmtr == 0 %}
	{% if start_vars.apa_readback_enable == True %}
	RESPOND TYPE=COMMAND MSG="PA change default setting Inner Wall {apa_vars.default}"
	{% endif %}
	SET_PRESSURE_ADVANCE ADVANCE={apa_vars.default}
	
	
	{% elif ext_type == "ExternalPerimeter" and apa_vars.ext_prmtr > 0 %}
	{% if start_vars.apa_readback_enable == True %}
	RESPOND TYPE=COMMAND MSG="PA change APA setting Outer wall {apa_vars.ext_prmtr}"
	{% endif %}
	SET_PRESSURE_ADVANCE ADVANCE={apa_vars.ext_prmtr}
	
	
	{% elif ext_type == "ExternalPerimeter" and apa_vars.ext_prmtr == 0 %}
	{% if start_vars.apa_readback_enable == True %}
	RESPOND TYPE=COMMAND MSG="PA change default setting Outer wall {apa_vars.default}"
	{% endif %}
	SET_PRESSURE_ADVANCE ADVANCE={apa_vars.default}
	
	
	{% elif ext_type == "InternalInfill" and apa_vars.infill > 0 %}
	{% if start_vars.apa_readback_enable == True %}
	RESPOND TYPE=COMMAND MSG="PA change APA setting Sparse infill {apa_vars.infill}"
	{% endif %}
	SET_PRESSURE_ADVANCE ADVANCE={apa_vars.infill}
	
	
	{% elif ext_type == "InternalInfill" and apa_vars.infill == 0 %}
	{% if start_vars.apa_readback_enable == True %}
	RESPOND TYPE=COMMAND MSG="PA change default setting Sparse infill {apa_vars.default}"
	{% endif %}
	SET_PRESSURE_ADVANCE ADVANCE={apa_vars.default}
	
	
	{% elif ext_type == "SolidInfill" and apa_vars.sld_infill > 0 %}
	{% if start_vars.apa_readback_enable == True %}
	RESPOND TYPE=COMMAND MSG="PA change APA setting Internal solid infill {apa_vars.sld_infill}"
	{% endif %}
	SET_PRESSURE_ADVANCE ADVANCE={apa_vars.sld_infill}
	
	
	{% elif ext_type == "SolidInfill" and apa_vars.sld_infill == 0 %}
	{% if start_vars.apa_readback_enable == True %}
	RESPOND TYPE=COMMAND MSG="PA change default setting Internal solid infill {apa_vars.default}"
	{% endif %}
	SET_PRESSURE_ADVANCE ADVANCE={apa_vars.default}
	
	
	{% elif ext_type == "TopSolidInfill" and apa_vars.top_srfc > 0 %}
	{% if start_vars.apa_readback_enable == True %}
	RESPOND TYPE=COMMAND MSG="PA change APA setting Top surface {apa_vars.top_srfc}"
	{% endif %}
	SET_PRESSURE_ADVANCE ADVANCE={apa_vars.top_srfc}
	
	
	{% elif ext_type == "TopSolidInfill" and apa_vars.top_srfc == 0 %}
	{% if start_vars.apa_readback_enable == True %}
	RESPOND TYPE=COMMAND MSG="PA change default setting Top surface {apa_vars.default}"
	{% endif %}
	SET_PRESSURE_ADVANCE ADVANCE={apa_vars.default}
	
	
	{% elif ext_type not in ["Perimeter", "ExternalPerimeter", "InternalInfill", "SolidInfill", "TopSolidInfill"] %}
	{% if start_vars.apa_readback_enable == True %}
	RESPOND TYPE=COMMAND MSG="PA change default setting for other extrusion types {apa_vars.default}"
	{% endif %}
	SET_PRESSURE_ADVANCE ADVANCE={apa_vars.default}
	
	
	{% endif %}
	
	{% endif %}
	{% endif %}

[gcode_macro _APA_VARS]
variable_default = 0
variable_prmtr = 0
variable_ext_prmtr = 0
variable_infill = 0
variable_sld_infill = 0
variable_top_srfc = 0
variable_fil_type = "PLA"
variable_enable = False
variable_oapa = 0
gcode = 

[gcode_macro _APA_SET]
gcode = 
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	{% set apa_vars = printer["gcode_macro _APA_VARS"] %}
	
	{% if apa_vars.oapa == 1|int %}
	RESPOND TYPE=COMMAND MSG="Orca APA has been detected, Demon APA is now disabled!"
	
	{% elif apa_vars.oapa == 0|int %}
	{% if apa_vars.fil_type == 'PLA' and start_vars.pla_adaptive_pa_enable == True %}
	{% if start_vars.apa_readback_enable == True %}
	RESPOND TYPE=COMMAND MSG="Setting system for PLA APA"
	{% endif %}
	SET_GCODE_VARIABLE MACRO=_APA_VARS VARIABLE=enable VALUE=True
	SET_GCODE_VARIABLE MACRO=_APA_VARS VARIABLE=default VALUE={start_vars.pla_pa|float}
	SET_GCODE_VARIABLE MACRO=_APA_VARS VARIABLE=prmtr VALUE={start_vars.pla_inner_wall_pa|float}
	SET_GCODE_VARIABLE MACRO=_APA_VARS VARIABLE=ext_prmtr VALUE={start_vars.pla_outer_wall_pa|float}
	SET_GCODE_VARIABLE MACRO=_APA_VARS VARIABLE=infill VALUE={start_vars.pla_sparse_infill_pa|float}
	SET_GCODE_VARIABLE MACRO=_APA_VARS VARIABLE=sld_infill VALUE={start_vars.pla_solid_infill_pa|float}
	SET_GCODE_VARIABLE MACRO=_APA_VARS VARIABLE=top_srfc VALUE={start_vars.pla_top_surface_pa|float}
	
	{% if start_vars.apa_readback_enable == True %}
	_APA_READ
	{% endif %}
	
	{% elif apa_vars.fil_type == 'ASA' and start_vars.asa_adaptive_pa_enable == True %}
	{% if start_vars.apa_readback_enable == True %}
	RESPOND TYPE=COMMAND MSG="Setting system for ASA APA"
	{% endif %}
	SET_GCODE_VARIABLE MACRO=_APA_VARS VARIABLE=enable VALUE=True
	SET_GCODE_VARIABLE MACRO=_APA_VARS VARIABLE=default VALUE={start_vars.asa_pa|float}
	SET_GCODE_VARIABLE MACRO=_APA_VARS VARIABLE=prmtr VALUE={start_vars.asa_inner_wall_pa|float}
	SET_GCODE_VARIABLE MACRO=_APA_VARS VARIABLE=ext_prmtr VALUE={start_vars.asa_outer_wall_pa|float}
	SET_GCODE_VARIABLE MACRO=_APA_VARS VARIABLE=infill VALUE={start_vars.asa_sparse_infill_pa|float}
	SET_GCODE_VARIABLE MACRO=_APA_VARS VARIABLE=sld_infill VALUE={start_vars.asa_solid_infill_pa|float}
	SET_GCODE_VARIABLE MACRO=_APA_VARS VARIABLE=top_srfc VALUE={start_vars.asa_top_surface_pa|float}
	
	{% if start_vars.apa_readback_enable == True %}
	_APA_READ
	{% endif %}
	
	{% elif apa_vars.fil_type == 'ABS' and start_vars.abs_adaptive_pa_enable == True %}
	{% if start_vars.apa_readback_enable == True %}
	RESPOND TYPE=COMMAND MSG="Setting system for ABS APA"
	{% endif %}
	SET_GCODE_VARIABLE MACRO=_APA_VARS VARIABLE=enable VALUE=True
	SET_GCODE_VARIABLE MACRO=_APA_VARS VARIABLE=default VALUE={start_vars.abs_pa|float}
	SET_GCODE_VARIABLE MACRO=_APA_VARS VARIABLE=prmtr VALUE={start_vars.abs_inner_wall_pa|float}
	SET_GCODE_VARIABLE MACRO=_APA_VARS VARIABLE=ext_prmtr VALUE={start_vars.abs_outer_wall_pa|float}
	SET_GCODE_VARIABLE MACRO=_APA_VARS VARIABLE=infill VALUE={start_vars.abs_sparse_infill_pa|float}
	SET_GCODE_VARIABLE MACRO=_APA_VARS VARIABLE=sld_infill VALUE={start_vars.abs_solid_infill_pa|float}
	SET_GCODE_VARIABLE MACRO=_APA_VARS VARIABLE=top_srfc VALUE={start_vars.abs_top_surface_pa|float}
	
	{% if start_vars.apa_readback_enable == True %}
	_APA_READ
	{% endif %}
	
	{% elif apa_vars.fil_type == 'PETG' and start_vars.petg_adaptive_pa_enable == True %}
	{% if start_vars.apa_readback_enable == True %}
	RESPOND TYPE=COMMAND MSG="Setting system for PETG APA"
	{% endif %}
	SET_GCODE_VARIABLE MACRO=_APA_VARS VARIABLE=enable VALUE=True
	SET_GCODE_VARIABLE MACRO=_APA_VARS VARIABLE=default VALUE={start_vars.petg_pa|float}
	SET_GCODE_VARIABLE MACRO=_APA_VARS VARIABLE=prmtr VALUE={start_vars.petg_inner_wall_pa|float}
	SET_GCODE_VARIABLE MACRO=_APA_VARS VARIABLE=ext_prmtr VALUE={start_vars.petg_outer_wall_pa|float}
	SET_GCODE_VARIABLE MACRO=_APA_VARS VARIABLE=infill VALUE={start_vars.petg_sparse_infill_pa|float}
	SET_GCODE_VARIABLE MACRO=_APA_VARS VARIABLE=sld_infill VALUE={start_vars.petg_solid_infill_pa|float}
	SET_GCODE_VARIABLE MACRO=_APA_VARS VARIABLE=top_srfc VALUE={start_vars.petg_top_surface_pa|float}
	
	{% if start_vars.apa_readback_enable == True %}
	_APA_READ
	{% endif %}
	
	{% elif apa_vars.fil_type == 'TPU' and start_vars.tpu_adaptive_pa_enable == True %}
	{% if start_vars.apa_readback_enable == True %}
	RESPOND TYPE=COMMAND MSG="Setting system for TPU APA"
	{% endif %}
	SET_GCODE_VARIABLE MACRO=_APA_VARS VARIABLE=enable VALUE=True
	SET_GCODE_VARIABLE MACRO=_APA_VARS VARIABLE=default VALUE={start_vars.tpu_pa|float}
	SET_GCODE_VARIABLE MACRO=_APA_VARS VARIABLE=prmtr VALUE={start_vars.tpu_inner_wall_pa|float}
	SET_GCODE_VARIABLE MACRO=_APA_VARS VARIABLE=ext_prmtr VALUE={start_vars.tpu_outer_wall_pa|float}
	SET_GCODE_VARIABLE MACRO=_APA_VARS VARIABLE=infill VALUE={start_vars.tpu_sparse_infill_pa|float}
	SET_GCODE_VARIABLE MACRO=_APA_VARS VARIABLE=sld_infill VALUE={start_vars.tpu_solid_infill_pa|float}
	SET_GCODE_VARIABLE MACRO=_APA_VARS VARIABLE=top_srfc VALUE={start_vars.tpu_top_surface_pa|float}
	
	{% if start_vars.apa_readback_enable == True %}
	_APA_READ
	{% endif %}
	
	{% elif apa_vars.fil_type not in ["PLA", "ASA", "ABS", "PETG", "TPU"] %}
	{% if start_vars.apa_readback_enable == True %}
	RESPOND TYPE=COMMAND MSG="Unlisted filament file detected. SWITCHING APA OFF"
	{% endif %}
	SET_GCODE_VARIABLE MACRO=_APA_VARS VARIABLE=enable VALUE=False
	SET_GCODE_VARIABLE MACRO=_APA_VARS VARIABLE=default VALUE={printer.configfile.settings.extruder.pressure_advance|float}
	SET_GCODE_VARIABLE MACRO=_APA_VARS VARIABLE=prmtr VALUE=0
	SET_GCODE_VARIABLE MACRO=_APA_VARS VARIABLE=ext_prmtr VALUE=0
	SET_GCODE_VARIABLE MACRO=_APA_VARS VARIABLE=infill VALUE=0
	SET_GCODE_VARIABLE MACRO=_APA_VARS VARIABLE=sld_infill VALUE=0
	SET_GCODE_VARIABLE MACRO=_APA_VARS VARIABLE=top_srfc VALUE=0
	
	{% if start_vars.apa_readback_enable == True %}
	_APA_READ
	{% endif %}
	
	{% else %}
	SET_GCODE_VARIABLE MACRO=_APA_VARS VARIABLE=enable VALUE=False
	SET_GCODE_VARIABLE MACRO=_APA_VARS VARIABLE=default VALUE={printer.configfile.settings.extruder.pressure_advance|float}
	SET_GCODE_VARIABLE MACRO=_APA_VARS VARIABLE=prmtr VALUE=0
	SET_GCODE_VARIABLE MACRO=_APA_VARS VARIABLE=ext_prmtr VALUE=0
	SET_GCODE_VARIABLE MACRO=_APA_VARS VARIABLE=infill VALUE=0
	SET_GCODE_VARIABLE MACRO=_APA_VARS VARIABLE=sld_infill VALUE=0
	SET_GCODE_VARIABLE MACRO=_APA_VARS VARIABLE=top_srfc VALUE=0
	
	{% if start_vars.apa_readback_enable == True %}
	_APA_READ
	{% endif %}
	
	{% endif %}
	{% endif %}

[gcode_macro _APA_READ]
gcode = 
	{% set read_vars = printer["gcode_macro _APA_VARS"] %}
	RESPOND TYPE=COMMAND MSG="APA default {read_vars.default}"
	RESPOND TYPE=COMMAND MSG="APA prmtr {read_vars.prmtr}"
	RESPOND TYPE=COMMAND MSG="APA ext_prmtr {read_vars.ext_prmtr}"
	RESPOND TYPE=COMMAND MSG="APA infill {read_vars.infill}"
	RESPOND TYPE=COMMAND MSG="APA sld_infill {read_vars.sld_infill}"
	RESPOND TYPE=COMMAND MSG="APA top_srfc {read_vars.top_srfc}"
	RESPOND TYPE=COMMAND MSG="APA fil_type {read_vars.fil_type}"
	RESPOND TYPE=COMMAND MSG="APA enable {read_vars.enable}"
	RESPOND TYPE=COMMAND MSG="OAPA state {read_vars.oapa}"

[gcode_macro _ADAPTIVE_PA]
gcode = 
	_DEMON_ADAPTIVE_PA {rawprams}

[gcode_macro _PA_VERSION]
variable_demon_apa = "1.2.0"
gcode = 

[gcode_macro _AES_SYS]
variable_e_stop_armed = False
gcode = 

[gcode_macro _AES_READ]
gcode = 
	{% set aes_vars = printer["gcode_macro _AES_SYS"] %}
	
	{% if aes_vars.e_stop_armed == True %}
	RESPOND TYPE=COMMAND MSG="Homing Z AES System ARMED"
	SET_PIN PIN=AES_SYSTEM_ENABLE_-_KLIPPER_CONTROLLED VALUE=1.0
	{% else %}
	RESPOND TYPE=COMMAND MSG="AES System DISAMRED"
	SET_PIN PIN=AES_SYSTEM_ENABLE_-_KLIPPER_CONTROLLED VALUE=0.0
	{% endif %}

[gcode_macro _AES_VERSION]
variable_demon_aes_ver = "1.1.0"
gcode = 

[gcode_macro _BED_FAN_VARS]
variable_chamber_threshold = 22
variable_chamber_fan = 33
variable_high = 0.55
variable_low = 0.22
variable_cool = True
variable_cool_temp = 25
variable_enable = False
variable_chamber_fan_enable = True
variable_floating_monitor = True
variable_floating_max_speed = 0.50
variable_readback_value = 0
variable_previous_readback_value = 10
variable_previous_chamber_temp = 0
variable_mid_point_temp = 0
variable_mid_point_fan = 0
variable_current_fan_speed = 0.0
variable_previous_floating_fan = 0
variable_macro_used = False
gcode = 

[gcode_macro _FLOATING_FAN]
gcode = 
	{% set bed_vars = printer["gcode_macro _BED_FAN_VARS"] %}
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	{% set core_vars = printer["gcode_macro _CORE_VARS"] %}
	
	{% if core_vars.chamber_thermal_sensor == 0 %}
	{action_raise_error("This error is caused by no correctly named chamber_sensor or temperature controlled chamber_fan being available to the system! Check the system is setup correctly!")}
	
	{% elif core_vars.chamber_thermal_sensor == 1 %}
	{% set thermal_sensor = printer["temperature_fan chamber"].temperature %}
	
	{% elif core_vars.chamber_thermal_sensor == 2 %}
	{% set thermal_sensor = printer["temperature_sensor Chamber_Temp"].temperature %}
	
	{% endif %}
	
	
	{% if bed_vars.readback_value == bed_vars.previous_readback_value %}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=previous_readback_value VALUE={bed_vars.readback_value}
	
	
	
	
	{% if printer["fan_generic Bed_Fans"].speed|float < bed_vars.low|float - 0.01 or printer["fan_generic Bed_Fans"].speed|float > bed_vars.mid_point_fan|float + 0.01 %}
	RESPOND TYPE=COMMAND MSG="Bed Fans Monitor: Floating Fans, fan speed outside floating fans range detected"
	
	{% if bed_vars.previous_floating_fan == 0 %}
	SET_FAN_SPEED FAN=Bed_Fans SPEED={bed_vars.low}
	RESPOND TYPE=COMMAND MSG="Bed Fans Monitor: Floating Fans, resetting to low fan speed"
	
	{% elif bed_vars.previous_floating_fan >= bed_vars.low and bed_vars.previous_floating_fan <= bed_vars.mid_point_fan %}
	SET_FAN_SPEED FAN=Bed_Fans SPEED={bed_vars.previous_floating_fan}
	RESPOND TYPE=COMMAND MSG="Bed Fans Monitor: Floating Fans, resetting to previous fan speed"
	
	{% elif bed_vars.previous_floating_fan > bed_vars.mid_point_fan %}
	SET_FAN_SPEED FAN=Bed_Fans SPEED={bed_vars.mid_point_fan}
	RESPOND TYPE=COMMAND MSG="Bed Fans Monitor: Floating Fans, resetting to floating fan max speed"
	
	{% elif bed_vars.previous_floating_fan < bed_vars.low %}
	SET_FAN_SPEED FAN=Bed_Fans SPEED={bed_vars.low}
	RESPOND TYPE=COMMAND MSG="Bed Fans Monitor: Floating Fans, resetting to low fan speed"
	
	{% endif %}
	
	{% else %}
	
	{% if thermal_sensor <= bed_vars.mid_point_temp|float - 0.1 %}
	{% if start_vars.bed_fans_settings_readback == True %}
	RESPOND TYPE=COMMAND MSG="Bed Fans Monitor: Floating Fans, chamber is colder than mid point target temp"
	{% endif %}
	
	{% if thermal_sensor < bed_vars.previous_chamber_temp|float %}
	{% if start_vars.bed_fans_settings_readback == True %}
	RESPOND TYPE=COMMAND MSG="Bed Fans Monitor: Floating Fans, chamber is colder than previous run"
	{% endif %}
	
	{% if printer["fan_generic Bed_Fans"].speed < bed_vars.mid_point_fan %}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=previous_floating_fan VALUE={("%.2f " % (printer["fan_generic Bed_Fans"].speed))}
	SET_FAN_SPEED FAN=Bed_Fans SPEED={printer["fan_generic Bed_Fans"].speed|float + 0.01}
	
	{% if start_vars.bed_fans_settings_readback == True %}
	RESPOND TYPE=COMMAND MSG="Bed Fans Monitor: Floating Fans, under mid point target, increasing floating fan speed"
	{% endif %}
	{% endif %}
	{% endif %}
	
	{% elif thermal_sensor >= bed_vars.mid_point_temp|float + 0.1 %}
	{% if start_vars.bed_fans_settings_readback == True %}
	RESPOND TYPE=COMMAND MSG="Bed Fans Monitor: Floating Fans, chamber is warmer than mid point target temp"
	{% endif %}
	
	{% if thermal_sensor > bed_vars.previous_chamber_temp|float %}
	{% if start_vars.bed_fans_settings_readback == True %}
	RESPOND TYPE=COMMAND MSG="Bed Fans Monitor: Floating Fans, chamber is warmer than previous run"
	{% endif %}
	
	{% if printer["fan_generic Bed_Fans"].speed > bed_vars.low %}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=previous_floating_fan VALUE={("%.2f " % (printer["fan_generic Bed_Fans"].speed))}
	SET_FAN_SPEED FAN=Bed_Fans SPEED={printer["fan_generic Bed_Fans"].speed|float - 0.01}
	
	{% if start_vars.bed_fans_settings_readback == True %}
	RESPOND TYPE=COMMAND MSG="Bed Fans Monitor: Floating Fans, over mid point target, reducing floating fan speed"
	{% endif %}
	{% endif %}
	{% endif %}
	
	{% endif %}
	{% endif %}
	
	{% else %}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=previous_readback_value VALUE={bed_vars.readback_value}
	{% if start_vars.bed_fans_settings_readback == True %}
	RESPOND TYPE=COMMAND MSG="Bed Fans Monitor: Floating Fans, mode readback value does not equal previous readback value"
	{% endif %}
	
	{% if thermal_sensor < bed_vars.mid_point_temp|float %}
	SET_FAN_SPEED FAN=Bed_Fans SPEED={bed_vars.mid_point_fan}
	{% if start_vars.bed_fans_settings_readback == True %}
	RESPOND TYPE=COMMAND MSG="Bed Fans Monitor: Floating Fans, chamber under mid point target, setting floating fans to scaled maximum"
	{% endif %}
	{% else %}
	SET_FAN_SPEED FAN=Bed_Fans SPEED={bed_vars.low}
	{% if start_vars.bed_fans_settings_readback == True %}
	RESPOND TYPE=COMMAND MSG="Bed Fans Monitor: Floating Fans, chamber under over point target, setting floating fans to low speed scaled minimum"
	{% endif %}
	{% endif %}
	
	BED_FANS_THERMAL_INFO
	
	{% endif %}
	
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=macro_used VALUE=False

[gcode_macro BED_FANS_THERMAL_INFO]
description = Display chamber low & high temperature thresholds & target temp
gcode = 
	{% set bed_vars = printer["gcode_macro _BED_FAN_VARS"] %}
	RESPOND TYPE=COMMAND MSG="Bed Fans theraml thresholds. Mid point chamber target temp {("%.0fc" % (bed_vars.
	mid_point_temp))}. Minimum threshold is {("%.0fc" % (bed_vars.chamber_threshold))}, maximum threshold is {("%.0fc" % (bed_vars.chamber_fan))}."

[gcode_macro BED_FANS_SET_SPEED_INFO]
description = Display Bed Fans low & high power settings as well as Floating Fan
gcode = 
	{% set bed_vars = printer["gcode_macro _BED_FAN_VARS"] %}
	RESPOND TYPE=COMMAND MSG="Bed Fans power range. Low power {("%.0f" % (bed_vars.low|float * 100))}% to floating fans Max Speed {("%.0f" % (bed_vars.
	mid_point_fan|float * 100))}% if active. High speed boost of {("%.0f" % (bed_vars.high|float * 100))}%. Use macro button BED FANS SET SPEED to adjust LOW & HIGH settings"

[gcode_macro FLOATING_FANS_MAX_SPEED_INFO]
description = Display info on how to use Floating Fans Max Speed SCALED_POWER
gcode = 
	{% set bed_vars = printer["gcode_macro _BED_FAN_VARS"] %}
	RESPOND TYPE=COMMAND MSG="Bed Fans Monitor: Floating Fans Max Speed, use macro button for real-time adjustment within set range, this button uses a 0-100% range scaled between your Bed_Fans current low speed value of {("%.0f" % (bed_vars.
	low|float * 100))}%, & your high speed value of {("%.0f" % (bed_vars.high|float * 100))}%. Your current Floating Fans Max Speed is {("%.0f" % (bed_vars.
	mid_point_fan|float * 100))}%. This means your FLOATING FANS MAX SPEED macro button SCALED_POWER setting is {("%.0f" % (bed_vars.floating_max_speed|float * 100))}% of this scaled range."

[gcode_macro _FLOATING_INFO]
gcode = 
	{% set bed_vars = printer["gcode_macro _BED_FAN_VARS"] %}
	RESPOND TYPE=COMMAND MSG="Floating Fans Max Speed. SCALED_POWER value is {("%.0f" % (bed_vars.floating_max_speed|float * 100))}% which equals {("%.0f" % (bed_vars.
	mid_point_fan|float * 100))}% on the BED_FANS slider."

[gcode_macro FLOATING_FANS_MAX_SPEED]
description = Set the max speed made available to your Floating Bed Fans during the print
gcode = 
	{% set bed_vars = printer["gcode_macro _BED_FAN_VARS"] %}
	{% set float_max_speed = params.SCALED_POWER|default(65)|float %}
	
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=macro_used VALUE=True
	
	{% if bed_vars.floating_monitor == True %}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=floating_max_speed VALUE={float_max_speed / 100|float}
	
	
	{% else %}
	RESPOND TYPE=error MSG="Floating fans are not enabled, no changes made. Please check your Demon_user_settings file to enable!"
	{% endif %}

[gcode_macro BED_FANS_SET_SPEED]
description = Set Bed Fans High & Low speeds during the print
gcode = 
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	{% set low_speed = params.LOW_SPEED_PERCENT|default(25)|float %}
	{% set high_speed = params.HIGH_SPEED_PERCENT|default(65)|float %}
	
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=macro_used VALUE=True
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=low VALUE={low_speed / 100|float}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=high VALUE={high_speed / 100|float}

[gcode_macro _BED_FAN_READ]
gcode = 
	{% set bed_vars = printer["gcode_macro _BED_FAN_VARS"] %}
	
	RESPOND TYPE=COMMAND MSG="Bed fans threshold {bed_vars.chamber_threshold}c"
	RESPOND TYPE=COMMAND MSG="Bed fans upper limit {bed_vars.chamber_fan}c"
	RESPOND TYPE=COMMAND MSG="Bed fans high setting {bed_vars.high}"
	RESPOND TYPE=COMMAND MSG="Bed fans low setting {bed_vars.low}"
	RESPOND TYPE=COMMAND MSG="Bed fans Post print cooling {bed_vars.cool}"
	RESPOND TYPE=COMMAND MSG="Bed fans Post print cooling temp {bed_vars.cool_temp}c"
	RESPOND TYPE=COMMAND MSG="Bed fans enable for filament {bed_vars.enable}"
	
	RESPOND TYPE=COMMAND MSG="Bed fans readback value {bed_vars.readback_value}"
	RESPOND TYPE=COMMAND MSG="Bed fans previous readback value {bed_vars.previous_readback_value}"
	RESPOND TYPE=COMMAND MSG="Bed fans current fan {bed_vars.current_fan_speed}"
	RESPOND TYPE=COMMAND MSG="Bed fans actual speed {printer["fan_generic Bed_Fans"].speed}"
	
	RESPOND TYPE=COMMAND MSG="Bed fans temp mid point {bed_vars.mid_point_temp}c"
	RESPOND TYPE=COMMAND MSG="Bed fans previous fan {bed_vars.previous_floating_fan}"
	RESPOND TYPE=COMMAND MSG="Bed fans prev chamber temp {bed_vars.previous_chamber_temp}c"
	RESPOND TYPE=COMMAND MSG="Bed fans max floating fan {bed_vars.floating_max_speed}"
	RESPOND TYPE=COMMAND MSG="Bed mid point fan {bed_vars.mid_point_fan}"

[gcode_macro _BED_FAN_HELPER]
gcode = 
	{% set bed_vars = printer["gcode_macro _BED_FAN_VARS"] %}
	
	{% if bed_vars.readback_value == bed_vars.previous_readback_value %}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=previous_readback_value VALUE={bed_vars.readback_value}
	
	{% if bed_vars.chamber_fan_enable == True %}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=chamber_fan VALUE={printer["temperature_fan chamber"].target}
	{% endif %}
	
	{% if bed_vars.macro_used == True %}
	RESPOND TYPE=COMMAND MSG="Macro used to change Bed Fan speed"
	
	{% else %}
	{% if printer["fan_generic Bed_Fans"].speed|float == bed_vars.current_fan_speed %}
	
	{% elif printer["fan_generic Bed_Fans"].speed|float != bed_vars.current_fan_speed %}
	
	{% if printer["fan_generic Bed_Fans"].speed|float == 0 %}
	RESPOND TYPE=error MSG="The ZERO percent value can NOT be set or modified. To set fans to off use DISBALE_BED_FANS button!"
	
	{% elif printer["fan_generic Bed_Fans"].speed|float > 0.1 and printer["fan_generic Bed_Fans"].speed|float < 0.5 %}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=current_fan_speed VALUE={printer["fan_generic Bed_Fans"].speed|float}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=low VALUE={printer["fan_generic Bed_Fans"].speed|float}
	RESPOND TYPE=COMMAND MSG="Manual slider speed change of under 0.5 detected, applying to LOW_SPEED setting"
	
	{% elif printer["fan_generic Bed_Fans"].speed|float >= 0.5 %}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=current_fan_speed VALUE={printer["fan_generic Bed_Fans"].speed|float}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=high VALUE={printer["fan_generic Bed_Fans"].speed|float}
	RESPOND TYPE=COMMAND MSG="Manual slider speed change of over 0.5 detected, applying to HIGH_SPEED setting"
	
	{% endif %}
	
	{% endif %}
	
	{% endif %}
	
	{% elif bed_vars.readback_value != bed_vars.previous_readback_value %}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=previous_readback_value VALUE={bed_vars.readback_value}
	
	{% if bed_vars.chamber_fan_enable == True %}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=chamber_fan VALUE={printer["temperature_fan chamber"].target}
	{% endif %}
	
	_MONITOR_MESSAGE_READ
	
	{% endif %}
	
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=macro_used VALUE=False

[gcode_macro _MONITOR_FAN_SET]
gcode = 
	
	{% set bed_vars = printer["gcode_macro _BED_FAN_VARS"] %}
	
	{% if bed_vars.readback_value in [1, 4, 5, 7, 8, 9] %}
	SET_FAN_SPEED FAN=Bed_Fans SPEED=0
	
	{% elif bed_vars.readback_value == 2 %}
	SET_FAN_SPEED FAN=Bed_Fans SPEED={bed_vars.high}
	{% elif bed_vars.readback_value == 3 %}
	SET_FAN_SPEED FAN=Bed_Fans SPEED={bed_vars.low}
	
	{% elif bed_vars.readback_value == 6 %}
	SET_FAN_SPEED FAN=Bed_Fans SPEED={bed_vars.low}
	
	{% endif %}

[gcode_macro _MONITOR_MESSAGE_READ]
gcode = 
	
	{% set bed_vars = printer["gcode_macro _BED_FAN_VARS"] %}
	
	{% if bed_vars.readback_value == 1 %}
	RESPOND TYPE=COMMAND MSG="Bed Fans Monitor: Printing, too cold fans set to off while bed heats"
	{% elif bed_vars.readback_value == 2 %}
	RESPOND TYPE=COMMAND MSG="Bed Fans Monitor: Printing, temp under chamber threshold fans set to high speed {bed_vars.high * 100}%"
	{% elif bed_vars.readback_value == 3 %}
	RESPOND TYPE=COMMAND MSG="Bed Fans Monitor: Printing, fans set to low speed {bed_vars.low * 100}%"
	{% elif bed_vars.readback_value == 4 %}
	RESPOND TYPE=COMMAND MSG="Bed Fans Monitor: Printing, fans off due to high chamber temp >{bed_vars.chamber_fan|int}c"
	{% elif bed_vars.readback_value == 5 %}
	RESPOND TYPE=COMMAND MSG="Bed Fans Monitor: Paused, fans auto paused"
	{% elif bed_vars.readback_value == 6 %}
	RESPOND TYPE=COMMAND MSG="Bed Fans Monitor: Cooling post print, fans on low until <{bed_vars.cool_temp|int}c or printer state is changed to Standby"
	{% elif bed_vars.readback_value == 7 %}
	RESPOND TYPE=COMMAND MSG="Bed Fans Monitor: Stopped, fans off"
	{% elif bed_vars.readback_value == 8 %}
	RESPOND TYPE=COMMAND MSG="Bed Fans Monitor: Override on, fans manually paused"
	{% elif bed_vars.readback_value == 9 %}
	RESPOND TYPE=COMMAND MSG="Bed Fans Monitor: Stopped, fans off, Override off"
	
	{% endif %}

[gcode_macro _BED_FAN_SET]
gcode = 
	{% set bed_vars = printer["gcode_macro _BED_FAN_VARS"] %}
	{% set core_vars = printer["gcode_macro _CORE_VARS"] %}
	
	{% if core_vars.chamber_thermal_sensor == 0 %}
	{action_raise_error("This error is caused by no correctly named chamber_sensor or temperature controlled chamber_fan being available to the system! Check the system is setup correctly!")}
	
	{% elif core_vars.chamber_thermal_sensor == 1 %}
	{% set thermal_sensor = printer["temperature_fan chamber"].temperature %}
	
	{% elif core_vars.chamber_thermal_sensor == 2 %}
	{% set thermal_sensor = printer["temperature_sensor Chamber_Temp"].temperature %}
	
	{% endif %}
	
	{% if bed_vars.enable == True %}
	
	{% if printer.heater_bed.temperature < printer.heater_bed.target|int -40 %}
	
	{% if thermal_sensor <= bed_vars.chamber_fan %}
	SET_FAN_SPEED FAN=Bed_Fans SPEED={bed_vars.low}
	RESPOND TYPE=COMMAND MSG="Bed fans set to low while bed heats"
	
	{% elif thermal_sensor > bed_vars.chamber_fan %}
	SET_FAN_SPEED FAN=Bed_Fans SPEED=0
	RESPOND TYPE=COMMAND MSG="Bed fans set to off due to high chamber temp >{bed_vars.chamber_fan}c"
	
	{% endif %}
	
	{% elif printer.heater_bed.temperature >= printer.heater_bed.target|int -40 %}
	
	{% if thermal_sensor <= bed_vars.chamber_threshold %}
	SET_FAN_SPEED FAN=Bed_Fans SPEED={bed_vars.high}
	RESPOND TYPE=COMMAND MSG="Bed fans set to high speed for Heat Soak {bed_vars.high|float * 100.00}%"
	
	{% elif thermal_sensor > bed_vars.chamber_threshold %}
	{% if thermal_sensor <= bed_vars.chamber_fan %}
	SET_FAN_SPEED FAN=Bed_Fans SPEED={bed_vars.low}
	RESPOND TYPE=COMMAND MSG="Bed fans set to low speed {bed_vars.low|float * 100.00}%"
	
	{% elif thermal_sensor > bed_vars.chamber_fan %}
	SET_FAN_SPEED FAN=Bed_Fans SPEED=0
	RESPOND TYPE=COMMAND MSG="Bed fans set to off due to high chamber temp >{bed_vars.chamber_fan}c"
	
	{% endif %}
	
	{% endif %}
	
	{% endif %}
	
	{% else %}
	RESPOND TYPE=COMMAND MSG="Bed Fans disabled in settings"
	
	{% endif %}

[delayed_gcode _BED_FAN_MONITOR]
gcode = 
	{% set bed_vars = printer["gcode_macro _BED_FAN_VARS"] %}
	{% set core_vars = printer["gcode_macro _CORE_VARS"] %}
	
	{% if core_vars.chamber_thermal_sensor == 0 %}
	{action_raise_error("This error is caused by no correctly named chamber_sensor or temperature controlled chamber_fan being available to the system! Check the system is setup correctly!")}
	
	{% elif core_vars.chamber_thermal_sensor == 1 %}
	{% set thermal_sensor = printer["temperature_fan chamber"].temperature %}
	
	{% elif core_vars.chamber_thermal_sensor == 2 %}
	{% set thermal_sensor = printer["temperature_sensor Chamber_Temp"].temperature %}
	
	{% endif %}
	
	{% if bed_vars.enable == True %}
	{% if printer["output_pin DISABLE_BED_FANS"].value == 0 %}
	{% if printer.print_stats.state == "printing" %}
	{% if thermal_sensor < bed_vars.chamber_threshold %}
	{% if printer.heater_bed.temperature <= printer.heater_bed.target|int -5 %}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=readback_value VALUE=1
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=current_fan_speed VALUE=0
	_BED_FAN_HELPER
	_MONITOR_FAN_SET
	UPDATE_DELAYED_GCODE ID=_BED_FAN_MONITOR DURATION=10
	
	
	{% else %}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=readback_value VALUE=2
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=current_fan_speed VALUE={bed_vars.high}
	_BED_FAN_HELPER
	_MONITOR_FAN_SET
	UPDATE_DELAYED_GCODE ID=_BED_FAN_MONITOR DURATION=10
	
	
	{% endif %}
	
	{% elif thermal_sensor >= bed_vars.chamber_threshold %}
	{% if printer.heater_bed.temperature <= printer.heater_bed.target|int -5 %}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=readback_value VALUE=1
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=current_fan_speed VALUE=0
	_BED_FAN_HELPER
	_MONITOR_FAN_SET
	UPDATE_DELAYED_GCODE ID=_BED_FAN_MONITOR DURATION=10
	
	
	{% elif thermal_sensor <= bed_vars.chamber_fan %}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=readback_value VALUE=3
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=current_fan_speed VALUE={bed_vars.low}
	
	{% if bed_vars.floating_monitor == True %}
	
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=mid_point_fan VALUE={("%.2f " % (((bed_vars.high - bed_vars.low) * bed_vars.floating_max_speed) + bed_vars.low|float))}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=mid_point_temp VALUE={(bed_vars.chamber_threshold + bed_vars.chamber_fan) / 2|float}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=previous_chamber_temp VALUE={thermal_sensor|float}
	{% if bed_vars.chamber_fan_enable == True %}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=chamber_fan VALUE={printer["temperature_fan chamber"].target}
	{% endif %}
	_FLOATING_FAN
	
	{% else %}
	_BED_FAN_HELPER
	_MONITOR_FAN_SET
	{% endif %}
	
	UPDATE_DELAYED_GCODE ID=_BED_FAN_MONITOR DURATION=10
	
	
	{% elif thermal_sensor > bed_vars.chamber_fan %}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=readback_value VALUE=4
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=current_fan_speed VALUE=0
	_BED_FAN_HELPER
	_MONITOR_FAN_SET
	UPDATE_DELAYED_GCODE ID=_BED_FAN_MONITOR DURATION=20
	
	
	{% else %}
	M118 oops
	UPDATE_DELAYED_GCODE ID=_BED_FAN_MONITOR DURATION=10
	
	{% endif %}
	
	{% endif %}
	
	{% elif printer.print_stats.state == "paused" %}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=readback_value VALUE=5
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=current_fan_speed VALUE=0
	_BED_FAN_HELPER
	_MONITOR_FAN_SET
	UPDATE_DELAYED_GCODE ID=_BED_FAN_MONITOR DURATION=0
	
	
	
	{% elif printer.print_stats.state in ["complete", "cancelled", "error"] %}
	{% if bed_vars.cool == True and thermal_sensor >= bed_vars.cool_temp %}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=readback_value VALUE=6
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=current_fan_speed VALUE={bed_vars.low}
	_BED_FAN_HELPER
	_MONITOR_FAN_SET
	UPDATE_DELAYED_GCODE ID=_BED_FAN_MONITOR DURATION=10
	
	
	{% else %}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=readback_value VALUE=7
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=current_fan_speed VALUE=0
	_BED_FAN_HELPER
	_MONITOR_FAN_SET
	UPDATE_DELAYED_GCODE ID=_BED_FAN_MONITOR DURATION=0
	
	
	{% endif %}
	
	{% elif printer.print_stats.state == "standby" %}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=readback_value VALUE=7
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=current_fan_speed VALUE=0
	_BED_FAN_HELPER
	_MONITOR_FAN_SET
	UPDATE_DELAYED_GCODE ID=_BED_FAN_MONITOR DURATION=0
	
	
	{% endif %}
	
	{% elif printer["output_pin DISABLE_BED_FANS"].value == 1.0 %}
	{% if printer.print_stats.state in  ["printing", "paused"] %}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=readback_value VALUE=8
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=current_fan_speed VALUE=0
	_BED_FAN_HELPER
	_MONITOR_FAN_SET
	UPDATE_DELAYED_GCODE ID=_BED_FAN_MONITOR DURATION=10
	
	
	{% elif printer.print_stats.state in ["complete", "cancelled", "error"] %}
	{% if bed_vars.cool == True and thermal_sensor >= bed_vars.cool_temp %}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=readback_value VALUE=6
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=current_fan_speed VALUE={bed_vars.low}
	_BED_FAN_HELPER
	_MONITOR_FAN_SET
	UPDATE_DELAYED_GCODE ID=_BED_FAN_MONITOR DURATION=10
	SET_PIN PIN=DISABLE_BED_FANS VALUE=0.00
	
	
	{% else %}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=readback_value VALUE=9
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=current_fan_speed VALUE=0
	_BED_FAN_HELPER
	_MONITOR_FAN_SET
	UPDATE_DELAYED_GCODE ID=_BED_FAN_MONITOR DURATION=0
	SET_PIN PIN=DISABLE_BED_FANS VALUE=0.00
	
	
	{% endif %}
	
	{% elif printer.print_stats.state == "standby" %}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=readback_value VALUE=9
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=current_fan_speed VALUE=0
	_BED_FAN_HELPER
	_MONITOR_FAN_SET
	UPDATE_DELAYED_GCODE ID=_BED_FAN_MONITOR DURATION=0
	SET_PIN PIN=DISABLE_BED_FANS VALUE=0.00
	
	
	{% endif %}
	
	{% else %}
	UPDATE_DELAYED_GCODE ID=_BED_FAN_MONITOR DURATION=10
	
	
	{% endif %}
	
	{% else %}
	RESPOND TYPE=error MSG="Bed Fans disabled in settings"
	
	{% endif %}

[gcode_macro _BED_FANS_VERSION]
variable_demon_bed_fans = "1.3.0"
gcode = 

[gcode_macro _C_HEATER_VARS]
variable_min_thresold = 20
variable_mid_point = 40
variable_max_thresold = 60
gcode = 

[gcode_macro _CHAMBER_HEATER_READ]
gcode = 
	{% set core_vars = printer["gcode_macro _CORE_VARS"] %}
	{% set c_heater_vars = printer["gcode_macro _C_HEATER_VARS"] %}
	
	{% if core_vars.chamber_thermal_sensor == 0 %}
	{action_raise_error("This error is caused by no correctly named chamber sensor being available to the macro! Check the system is setup correctly!")}
	
	{% elif core_vars.chamber_thermal_sensor == 1 %}
	{% set Temp = printer["temperature_fan chamber"].temperature %}
	
	{% elif core_vars.chamber_thermal_sensor == 2 %}
	{% set Temp = printer["temperature_sensor Chamber_Temp"].temperature %}
	
	{% endif %}
	
	RESPOND TYPE=COMMAND MSG="Chamber Heater: Current chamber temp {Temp}c"
	RESPOND TYPE=COMMAND MSG="Chamber Heater: Minimum thresold {c_heater_vars.min_thresold}c"
	RESPOND TYPE=COMMAND MSG="Chamber Heater: Mid point {c_heater_vars.mid_point}c"
	RESPOND TYPE=COMMAND MSG="Chamber Heater: Maximum thresold {c_heater_vars.max_thresold}c"

[gcode_macro _CHAMBER_HEATER_MONITOR]
gcode = 
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	{% set core_vars = printer["gcode_macro _CORE_VARS"] %}
	{% set c_heater_vars = printer["gcode_macro _C_HEATER_VARS"] %}
	
	{% if core_vars.chamber_thermal_sensor == 0 %}
	{action_raise_error("This error is caused by no correctly named chamber sensor being available to the macro! Check the system is setup correctly!")}
	
	{% elif core_vars.chamber_thermal_sensor == 1 %}
	{% set Temp = printer["temperature_fan chamber"].temperature %}
	
	{% elif core_vars.chamber_thermal_sensor == 2 %}
	{% set Temp = printer["temperature_sensor Chamber_Temp"].temperature %}
	
	{% endif %}
	
	
	{% if start_vars.danger_will_robinson != True %}
	{action_raise_error("This error is caused by you not agreeing to full & sole reasonability/liability of using a chamber heater with these macros before first use. Check demon_user_settings file for variable_danger_will_robinson & agree to the terms!")}
	
	{% else %}
	
	{% if printer.print_stats.state not in ["printing", "busy"] %}
	SET_HEATER_TEMPERATURE HEATER=Chamber_Heater TARGET=0
	RESPOND TYPE=COMMAND MSG="Chamber Heater: Not Printing, Chamber Heater Control stopped, setting heater OFF"
	UPDATE_DELAYED_GCODE ID=_CHAMBER_HEAT_CONTROL DURATION=0
	{% if start_vars.heater_neo == True %}
	SET_LED LED="Chamber_Heater_Neopixel" RED=1.0 GREEN=0.0 BLUE=1.0 WHITE=0 SYNC=0 TRANSMIT=1
	{% endif %}
	
	{% else %}
	
	{% if printer["output_pin DISABLE_CHAMBER_HEATER"].value == 0 %}
	
	
	
	{% if Temp >= 23|int and core_vars.filament in ['PLA', 'PLA+'] %}
	SET_HEATER_TEMPERATURE HEATER=Chamber_Heater TARGET=0
	{% if start_vars.heater_neo == True %}
	SET_LED LED="Chamber_Heater_Neopixel" RED=0.0 GREEN=0.1 BLUE=1.0 WHITE=0 SYNC=0 TRANSMIT=1
	{% endif %}
	
	UPDATE_DELAYED_GCODE ID=_CHAMBER_HEAT_CONTROL DURATION=20
	
	{% elif Temp < c_heater_vars.min_thresold %}
	SET_HEATER_TEMPERATURE HEATER=Chamber_Heater TARGET={start_vars.heater_high}
	{% if start_vars.heater_neo == True %}
	SET_LED LED="Chamber_Heater_Neopixel" RED=1.0 GREEN=0.0 BLUE=0 WHITE=0 SYNC=0 TRANSMIT=1
	{% endif %}
	
	UPDATE_DELAYED_GCODE ID=_CHAMBER_HEAT_CONTROL DURATION=20
	
	{% elif Temp >= c_heater_vars.min_thresold and Temp <= c_heater_vars.mid_point %}
	SET_HEATER_TEMPERATURE HEATER=Chamber_Heater TARGET={start_vars.heater_mid}
	{% if start_vars.heater_neo == True %}
	SET_LED LED="Chamber_Heater_Neopixel" RED=1.0 GREEN=0.2 BLUE=0 WHITE=0 SYNC=0 TRANSMIT=1
	{% endif %}
	
	UPDATE_DELAYED_GCODE ID=_CHAMBER_HEAT_CONTROL DURATION=20
	
	{% elif Temp >= c_heater_vars.mid_point and Temp <= c_heater_vars.max_thresold - 5 %}
	SET_HEATER_TEMPERATURE HEATER=Chamber_Heater TARGET={start_vars.heater_low}
	{% if start_vars.heater_neo == True %}
	SET_LED LED="Chamber_Heater_Neopixel" RED=1.0 GREEN=0.6 BLUE=0 WHITE=0 SYNC=0 TRANSMIT=1
	{% endif %}
	
	UPDATE_DELAYED_GCODE ID=_CHAMBER_HEAT_CONTROL DURATION=20
	
	{% elif Temp > c_heater_vars.max_thresold - 2 %}
	SET_HEATER_TEMPERATURE HEATER=Chamber_Heater TARGET=0
	{% if start_vars.heater_neo == True %}
	SET_LED LED="Chamber_Heater_Neopixel" RED=0.0 GREEN=0.1 BLUE=1.0 WHITE=0 SYNC=0 TRANSMIT=1
	{% endif %}
	
	UPDATE_DELAYED_GCODE ID=_CHAMBER_HEAT_CONTROL DURATION=20
	
	{% endif %}
	
	{% elif printer["output_pin DISABLE_CHAMBER_HEATER"].value == 1 %}
	SET_HEATER_TEMPERATURE HEATER=Chamber_Heater TARGET=0
	{% if start_vars.heater_neo == True %}
	SET_LED LED="Chamber_Heater_Neopixel" RED=1.0 GREEN=0.0 BLUE=1.0 WHITE=0 SYNC=0 TRANSMIT=1
	{% endif %}
	
	UPDATE_DELAYED_GCODE ID=_CHAMBER_HEAT_CONTROL DURATION=20
	
	{% endif %}
	{% endif %}
	{% endif %}

[delayed_gcode _CHAMBER_HEAT_CONTROL]
gcode = 
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	
	{% if start_vars.danger_will_robinson != True %}
	{action_raise_error("This error is caused by you not agreeing to full & sole reasonability/liability of using a chamber heater with these macros before first use. Check demon_user_settings file for variable_danger_will_robinson & agree to the terms!")}
	
	{% else %}
	_CHAMBER_HEATER_MONITOR
	
	{% endif %}

[gcode_macro _CHAMBER_HEATER_VERSION]
variable_demon_chamber_heater_ver = "1.1.1"
gcode = 

[gcode_macro LOAD_CLEAN]
gcode = 
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	{% set clean_vars = printer["gcode_macro _CLEAN_VARIABLES"] %}
	{% set ceal = printer["gcode_macro CUSTOM_EXPANSION_ACTIVE_LIST"] %}
	{% set temp = params.TEMP|default(250)|float %}
	{% set speed = params.SPEED_MMsec|default(7)|float * 60 %}
	{% set max_velocity = printer.configfile.settings['extruder'].max_extrude_only_velocity * 60 %}
	
	_MAX_EXTRUDE_CHECK
	
	{% if clean_vars.have_you_set_this_up != True %}
	{action_raise_error("This error is caused by you not setting up this feature before first use. Check demon_user_settings file & set this feature up correctly for your printer!")}
	
	{% elif printer.print_stats.state in ['printing', 'paused'] %}
	RESPOND TYPE=error MSG="Request denied, current printer state is printing/paused"
	
	{% else %}
	
	{% if start_vars.nozzle_cleaner == True and start_vars.purge_bucket == True %}
	SAVE_GCODE_STATE NAME=load_clean_state
	_RUNOUT_SENSOR_CHECK
	M400
	
	{% if ceal.ceal_master_enable == True %}
	{% if ceal.pre_load_clean == True %}
	_CUSTOM_PRE_LOAD_CLEAN {rawparams}
	{% endif %}
	{% endif %}
	
	{% if start_vars.neopixel_led == True %}
	STATUS_HEATING
	{% endif %}
	
	M117 HEATING...
	SET_HEATER_TEMPERATURE HEATER=extruder TARGET={clean_vars.nozzle_pre_temp}
	TEMPERATURE_WAIT SENSOR=extruder MINIMUM={clean_vars.nozzle_pre_temp - 5} MAXIMUM={clean_vars.nozzle_pre_temp + 50}
	
	_CONDITIONAL_HOME
	
	G90
	M83
	{% if start_vars.neopixel_led == True %}
	STATUS_READY
	{% endif %}
	
	
	{% if printer.toolhead.position.z|float < 20 %}
	G0 Z20 F3600
	{% endif %}
	
	_random_spot
	G0 Z{clean_vars.purge_z_park} F3000
	M400
	M117 Heating to Load...
	{% if start_vars.neopixel_led == True %}
	STATUS_HEATING
	{% endif %}
	
	
	SET_HEATER_TEMPERATURE HEATER=extruder TARGET={temp}
	TEMPERATURE_WAIT SENSOR=extruder MINIMUM={temp - 2} MAXIMUM={temp + 5}
	
	M106 S255
	M117 LOADING.....
	{% if start_vars.neopixel_led == True %}
	STATUS_PRINTING
	{% endif %}
	
	_ENCODER_FEED_CHECK_PREP
	
	G92 E0
	G1 E{clean_vars.load_clean_load_dist} F{max_velocity}
	M400
	
	_ENCODER_FEED_CHECK
	
	G1 E{clean_vars.load_clean_purge_dist} F{speed}
	G4 P10000
	
	_random_spot
	
	M107
	
	G1 E-5 F300
	G4 P10000
	
	_random_spot
	
	M106 S255
	
	M400
	M117 Post Load Cooling...
	{% if start_vars.neopixel_led == True %}
	STATUS_HEATING
	{% endif %}
	
	SET_HEATER_TEMPERATURE HEATER=extruder TARGET={clean_vars.nozzle_post_temp}
	TEMPERATURE_WAIT SENSOR=extruder MINIMUM={clean_vars.nozzle_post_temp - 5} MAXIMUM={clean_vars.nozzle_post_temp + 10}
	_random_spot
	
	M107
	M118 WARNING Nozzle Cleaning 5 Seconds...
	M117 WARNING Nozzle Cleaning 5 Seconds...
	G4 P5000
	M118 Nozzle Cleaning...
	M117 Nozzle Cleaning...
	CLEAN_NOZZLE
	
	M400
	M117
	
	SET_HEATER_TEMPERATURE HEATER=extruder TARGET=0
	{% if start_vars.neopixel_led == True %}
	STATUS_READY
	{% endif %}
	
	{% if start_vars.runout_sensor == True %}
	SET_FILAMENT_SENSOR SENSOR=filament_sensor ENABLE=1
	{% endif %}
	
	{% if ceal.ceal_master_enable == True %}
	{% if ceal.post_load_clean == True %}
	_CUSTOM_POST_LOAD_CLEAN {rawparams}
	{% endif %}
	{% endif %}
	
	RESTORE_GCODE_STATE NAME=load_clean_state
	_SAVE
	
	{% else %}
	{action_raise_error("This error is caused by the nozzle_cleaner & purge_bucket both not being enabled Check demon_user_settings file!")}
	{% endif %}
	
	{% endif %}

[gcode_macro UNLOAD_CLEAN]
gcode = 
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	{% set clean_vars = printer["gcode_macro _CLEAN_VARIABLES"] %}
	{% set ceal = printer["gcode_macro CUSTOM_EXPANSION_ACTIVE_LIST"] %}
	{% set temp = params.TEMP|default(250)|float %}
	{% set speed = params.SPEED_MMsec|default(7)|float * 60 %}
	{% set max_velocity = printer.configfile.settings['extruder'].max_extrude_only_velocity * 60 %}
	
	_MAX_EXTRUDE_CHECK
	
	{% if clean_vars.have_you_set_this_up != True %}
	{action_raise_error("This error is caused by you not setting up this feature before first use. Check demon_user_settings file & set this feature up correctly for your printer!")}
	
	{% elif printer.print_stats.state in ['printing', 'paused'] %}
	RESPOND TYPE=error MSG="Request denied, current printer state is printing/paused"
	
	{% else %}
	
	{% if start_vars.nozzle_cleaner == True and start_vars.purge_bucket == True %}
	SAVE_GCODE_STATE NAME=unload_clean_state
	_RUNOUT_SENSOR_CHECK
	M400
	
	{% if ceal.ceal_master_enable == True %}
	{% if ceal.pre_unload_clean == True %}
	_CUSTOM_PRE_LOAD_CLEAN {rawparams}
	{% endif %}
	{% endif %}
	
	{% if start_vars.neopixel_led == True %}
	STATUS_HEATING
	{% endif %}
	
	M117 HEATING...
	SET_HEATER_TEMPERATURE HEATER=extruder TARGET={clean_vars.nozzle_pre_temp}
	TEMPERATURE_WAIT SENSOR=extruder MINIMUM={clean_vars.nozzle_pre_temp - 5} MAXIMUM={clean_vars.nozzle_pre_temp + 50}
	
	_CONDITIONAL_HOME
	
	{% if start_vars.runout_sensor == True %}
	SET_FILAMENT_SENSOR SENSOR=filament_sensor ENABLE=0
	{% endif %}
	
	G90
	M83
	{% if start_vars.neopixel_led == True %}
	STATUS_READY
	{% endif %}
	
	
	{% if printer.toolhead.position.z|float < 20 %}
	G0 Z20 F3600
	{% endif %}
	
	_random_spot
	G0 Z{clean_vars.purge_z_park} F3000
	M400
	M117 Heating to Unload...
	{% if start_vars.neopixel_led == True %}
	STATUS_HEATING
	{% endif %}
	
	SET_HEATER_TEMPERATURE HEATER=extruder TARGET={temp}
	TEMPERATURE_WAIT SENSOR=extruder MINIMUM={temp - 2} MAXIMUM={temp + 5}
	
	M117 UNLOADING.....
	{% if start_vars.neopixel_led == True %}
	STATUS_PRINTING
	{% endif %}
	
	_ENCODER_FEED_CHECK_PREP
	
	G92 E0
	G1 E{clean_vars.unload_clean_purge_dist} F{speed}
	M400
	
	_ENCODER_FEED_CHECK
	
	G4 P5000
	_random_spot
	G1 E-{clean_vars.unload_clean_unload_dist} F{max_velocity}
	M106 S255
	G4 P5000
	_random_spot
	
	M400
	M117 Post Unload Cooling...
	{% if start_vars.neopixel_led == True %}
	STATUS_HEATING
	{% endif %}
	
	SET_HEATER_TEMPERATURE HEATER=extruder TARGET={clean_vars.nozzle_post_temp}
	TEMPERATURE_WAIT SENSOR=extruder MINIMUM={clean_vars.nozzle_post_temp - 5} MAXIMUM={clean_vars.nozzle_post_temp + 10}
	
	M107
	M118 WARNING Nozzle Cleaning 5 Seconds...
	M117 WARNING Nozzle Cleaning 5 Seconds...
	G4 P5000
	M118 Nozzle Cleaning...
	M117 Nozzle Cleaning...
	CLEAN_NOZZLE
	
	M400
	M117
	
	TURN_OFF_HEATERS
	{% if start_vars.neopixel_led == True %}
	STATUS_READY
	{% endif %}
	
	{% if start_vars.runout_sensor == True %}
	SET_FILAMENT_SENSOR SENSOR=filament_sensor ENABLE=1
	{% endif %}
	
	{% if ceal.ceal_master_enable == True %}
	{% if ceal.post_unload_clean == True %}
	_CUSTOM_POST_UNLOAD_CLEAN {rawparams}
	{% endif %}
	{% endif %}
	
	RESTORE_GCODE_STATE NAME=unload_clean_state
	_SAVE
	
	{% else %}
	{action_raise_error("This error is caused by the nozzle_cleaner & purge_bucket both not being enabled. Check demon_user_settings file!")}
	{% endif %}
	
	{% endif %}

[gcode_macro _CLEAN_LOAD_VERSION]
variable_demon_clean_load = "1.9.1"
gcode = 

[gcode_macro _CORE_VARS]
variable_orca_bed_offset = 0.00
variable_offset_reset = False
variable_orca_surface = "High Temp Plate"
variable_filament = "PLA"
variable_layer = 0.2
variable_bed = 0
variable_chamber_thermal_sensor = 0
variable_heat_wait_temp = 10
variable_fan_speed = 0
variable_nm_fan_speed = 0
variable_last_known_z = 0
variable_no_home_z_move = False
gcode = 

[gcode_macro PRINT_START_HEATSOAK_TIMERS]
description = Choose the temps for your PRINT START heatsoak. Any changes not visable in saved file, only in active RAM. Use the readback macro to see current settings!
gcode = 
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	{% set lotimer = params.LOW_TEMP_TIMER|default(0)|int %}
	{% set hitimer = params.HI_TEMP_TIMER|default(0)|int %}
	{% set detimer = params.DEFAULT_TEMP_TIMER|default(0)|int %}
	
	{% if 'LOW_TEMP_TIMER' not in params and 'HI_TEMP_TIMER' not in params and 'DEFAULT_TEMP_TIMER' not in params %}
	RESPOND TYPE=error MSG="Please enter a value to change the setting!"
	
	{% else %}
	{% if 'LOW_TEMP_TIMER' in params %}
	{% if lotimer <= 0 %}
	RESPOND TYPE=COMMAND MSG="Print start heatsoak timer cannot be 0, value of 1 or higher can be accepted. Timer set for 1 minute."
	SET_GCODE_VARIABLE MACRO=_START_VARIABLES VARIABLE=lo_temp_timer VALUE=1
	
	{% elif lotimer >= 1 %}
	RESPOND TYPE=COMMAND MSG="Print start heatsoak. Low temp timer set to {lotimer|int} minutes"
	SET_GCODE_VARIABLE MACRO=_START_VARIABLES VARIABLE=lo_temp_timer VALUE={lotimer|int}
	{% endif %}
	
	{% else %}
	{% endif %}
	
	{% if 'HI_TEMP_TIMER' in params %}
	{% if hitimer <= 0 %}
	RESPOND TYPE=COMMAND MSG="Print start heatsoak timer cannot be 0, value of 1 or higher can be accepted. Timer set for 1 minute."
	SET_GCODE_VARIABLE MACRO=_START_VARIABLES VARIABLE=hi_temp_timer VALUE=1
	
	{% elif hitimer >= 1 %}
	RESPOND TYPE=COMMAND MSG="Print start heatsoak. High temp timer set to {hitimer|int} minutes"
	SET_GCODE_VARIABLE MACRO=_START_VARIABLES VARIABLE=hi_temp_timer VALUE={hitimer|int}
	{% endif %}
	
	{% else %}
	{% endif %}
	
	{% if 'DEFAULT_TEMP_TIMER' in params %}
	{% if detimer <= 0 %}
	RESPOND TYPE=COMMAND MSG="Print start heatsoak timer cannot be 0, value of 1 or higher can be accepted. Timer set for 1 minute."
	SET_GCODE_VARIABLE MACRO=_START_VARIABLES VARIABLE=default_temp_timer VALUE=1
	
	{% elif hitimer >= 1 %}
	RESPOND TYPE=COMMAND MSG="Print start heatsoak. Default temp timer for unassigned profiles set to {detimer|int} minutes"
	SET_GCODE_VARIABLE MACRO=_START_VARIABLES VARIABLE=default_temp_timer VALUE={detimer|int}
	{% endif %}
	
	{% else %}
	{% endif %}
	
	{% endif %}

[gcode_macro NEVERMORE_TOGGLE]
description = Toggle the use of your NEVERMORE fan on & off with each click of this button! State must be set BEFORE you start a print! If you dont have a fan you will get errors on use!
gcode = 
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	
	{% if start_vars.nevermore == False %}
	RESPOND TYPE=error MSG="NEVERMORE FAN ENABLED!"
	SET_GCODE_VARIABLE MACRO=_START_VARIABLES VARIABLE=nevermore VALUE=True
	
	{% elif start_vars.nevermore == True %}
	RESPOND TYPE=error MSG="NEVERMORE FAN DISABLED!"
	SET_GCODE_VARIABLE MACRO=_START_VARIABLES VARIABLE=nevermore VALUE=False
	{% endif %}

[gcode_macro ADAPTIVE_MESHING_TOGGLE]
description = Toggle the use of adaptive besh meshing on & off with each click of this button! State must be set BEFORE you start a print! Must have bed meshes built & stored!
gcode = 
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	
	{% if start_vars.adaptive_meshing == False %}
	RESPOND TYPE=error MSG="ADAPTIVE MESHING IS ON!"
	SET_GCODE_VARIABLE MACRO=_START_VARIABLES VARIABLE=adaptive_meshing VALUE=True
	
	{% elif start_vars.adaptive_meshing == True %}
	RESPOND TYPE=error MSG="ADAPTIVE MESHING IS OFF!"
	SET_GCODE_VARIABLE MACRO=_START_VARIABLES VARIABLE=adaptive_meshing VALUE=False
	{% endif %}

[gcode_macro PURGE_LINE_TOGGLE]
description = Toggle the printing of all PRINT_START purge lines on & off with each click of this button! State must be set BEFORE you start a print!
gcode = 
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	
	{% if start_vars.purge_lines == False %}
	RESPOND TYPE=error MSG="PURGE LINE PRINTING IS ON!"
	SET_GCODE_VARIABLE MACRO=_START_VARIABLES VARIABLE=purge_lines VALUE=True
	
	{% elif start_vars.purge_lines == True %}
	RESPOND TYPE=error MSG="PURGE LINE PRINTING IS OFF!"
	SET_GCODE_VARIABLE MACRO=_START_VARIABLES VARIABLE=purge_lines VALUE=False
	{% endif %}

[gcode_macro PRINT_START_QUICK_SETTINGS_READBACK]
description = Use this macro to see your live Quick Settings! Any changes to these Quick Settings are not visible in the saved macro files. Only in active RAM.
gcode = 
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	
	RESPOND TYPE=COMMAND MSG="Nevermore Enabled: {start_vars.nevermore}"
	RESPOND TYPE=COMMAND MSG="Default temperature heatsoak timer for unassigned profiles is set to {start_vars.default_temp_timer} minutes"
	RESPOND TYPE=COMMAND MSG="Low temperature heatsoak timer is set to {start_vars.lo_temp_timer} minutes"
	RESPOND TYPE=COMMAND MSG="High temperature heatsoak timer is set to {start_vars.hi_temp_timer} minutes"
	RESPOND TYPE=COMMAND MSG="Adaptive meshing is active: {start_vars.adaptive_meshing}"
	RESPOND TYPE=COMMAND MSG="Draw PRINT_START purge line is active: {start_vars.purge_lines}"
	RESPOND TYPE=COMMAND MSG="Heatsoak timer is to be skipped: {start_vars.start_my_print_already}"

[gcode_macro _INITIAL_SETUP]
gcode = 
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	{% set core_vars = printer["gcode_macro _CORE_VARS"] %}
	
	M220 S{start_vars.feed_rate}
	
	{% if core_vars.filament in ['PLA', 'PLA+'] and core_vars.layer|float <0.25%}
	{% if start_vars.disable_set_flow != True %}
	M221 S{start_vars.pla_flow_rate}
	{% endif %}
	SET_PRESSURE_ADVANCE ADVANCE={start_vars.pla_pa} SMOOTH_TIME={start_vars.pla_st}
	
	{% elif core_vars.filament == 'ASA' and core_vars.layer|float <0.25%}
	{% if start_vars.disable_set_flow != True %}
	M221 S{start_vars.asa_flow_rate}
	{% endif %}
	SET_PRESSURE_ADVANCE ADVANCE={start_vars.asa_pa} SMOOTH_TIME={start_vars.asa_st}
	
	{% elif core_vars.filament == 'ABS' and core_vars.layer|float <0.25%}
	{% if start_vars.disable_set_flow != True %}
	M221 S{start_vars.abs_flow_rate}
	{% endif %}
	SET_PRESSURE_ADVANCE ADVANCE={start_vars.abs_pa} SMOOTH_TIME={start_vars.abs_st}
	
	{% elif core_vars.filament in ['PET', 'PETG'] and core_vars.layer|float <0.25%}
	{% if start_vars.disable_set_flow != True %}
	M221 S{start_vars.petg_flow_rate}
	{% endif %}
	SET_PRESSURE_ADVANCE ADVANCE={start_vars.petg_pa} SMOOTH_TIME={start_vars.petg_st}
	
	{% elif core_vars.filament in ['FLEX', 'TPU'] and core_vars.layer|float <0.25%}
	{% if start_vars.disable_set_flow != True %}
	M221 S{start_vars.tpu_flow_rate}
	{% endif %}
	SET_PRESSURE_ADVANCE ADVANCE={start_vars.tpu_pa} SMOOTH_TIME={start_vars.tpu_st}
	
	{% elif core_vars.filament in ['PLA', 'PLA+'] and core_vars.layer|float >0.26%}
	{% if start_vars.disable_set_flow != True %}
	M221 S{start_vars.pla_hi_flow_rate}
	{% endif %}
	SET_PRESSURE_ADVANCE ADVANCE={start_vars.pla_pa} SMOOTH_TIME={start_vars.pla_st}
	
	{% elif core_vars.filament == 'ASA' and core_vars.layer|float >0.26%}
	{% if start_vars.disable_set_flow != True %}
	M221 S{start_vars.asa_hi_flow_rate}
	{% endif %}
	SET_PRESSURE_ADVANCE ADVANCE={start_vars.asa_pa} SMOOTH_TIME={start_vars.asa_st}
	
	{% elif core_vars.filament == 'ABS' and core_vars.layer|float >0.26%}
	{% if start_vars.disable_set_flow != True %}
	M221 S{start_vars.abs_hi_flow_rate}
	{% endif %}
	SET_PRESSURE_ADVANCE ADVANCE={start_vars.abs_pa} SMOOTH_TIME={start_vars.abs_st}
	
	{% elif core_vars.filament in ['PET', 'PETG'] and core_vars.layer|float >0.26%}
	{% if start_vars.disable_set_flow != True %}
	M221 S{start_vars.petg_hi_flow_rate}
	{% endif %}
	SET_PRESSURE_ADVANCE ADVANCE={start_vars.petg_pa} SMOOTH_TIME={start_vars.petg_st}
	
	{% elif core_vars.filament in ['FLEX', 'TPU'] and core_vars.layer|float >0.26%}
	{% if start_vars.disable_set_flow != True %}
	M221 S{start_vars.tpu_hi_flow_rate}
	{% endif %}
	SET_PRESSURE_ADVANCE ADVANCE={start_vars.tpu_pa} SMOOTH_TIME={start_vars.tpu_st}
	
	{% endif %}

[gcode_macro _CHAMBER_SENSOR_DEFINE]
gcode = 
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	{% set core_vars = printer["gcode_macro _CORE_VARS"] %}
	
	{% if start_vars.chamber_fan and start_vars.chamber_sensor == True %}
	{action_raise_error("This error is caused by multiple chamber thermal sensors being set for use in the demon_user_settings file, please disable one sensor & restart the print!")}
	
	{% elif ('temperature_sensor Chamber_Temp' not in printer.configfile.config) and ('temperature_fan chamber' not in printer.configfile.config) %}
	SET_GCODE_VARIABLE MACRO=_CORE_VARS VARIABLE=chamber_thermal_sensor VALUE=3
	
	{% elif ('temperature_fan chamber' in printer.configfile.config) %}
	SET_GCODE_VARIABLE MACRO=_CORE_VARS VARIABLE=chamber_thermal_sensor VALUE=1
	
	{% elif ('temperature_sensor Chamber_Temp' in printer.configfile.config) %}
	SET_GCODE_VARIABLE MACRO=_CORE_VARS VARIABLE=chamber_thermal_sensor VALUE=2
	
	{% endif %}

[gcode_macro _BED_FANS_SETUP]
gcode = 
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	{% set core_vars = printer["gcode_macro _CORE_VARS"] %}
	
	{% if core_vars.filament in ['PLA', 'PLA+'] %}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=chamber_threshold VALUE={start_vars.pla_min_chamber_temp}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=chamber_fan VALUE={start_vars.pla_max_chamber_temp}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=low VALUE={start_vars.pla_bed_fan_low_speed}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=high VALUE={start_vars.pla_bed_fan_high_speed}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=cool VALUE={start_vars.pla_bed_fan_cool}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=cool_temp VALUE={start_vars.post_print_cool}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=enable VALUE={start_vars.pla_bed_fan_enable}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=chamber_fan_enable VALUE={start_vars.chamber_fan}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=floating_monitor VALUE={start_vars.floating_bed_fans}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=floating_max_speed VALUE={start_vars.floating_bed_fans_max}
	M400
	
	{% elif core_vars.filament == 'ASA' %}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=chamber_threshold VALUE={start_vars.asa_min_chamber_temp}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=chamber_fan VALUE={start_vars.asa_max_chamber_temp}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=low VALUE={start_vars.asa_bed_fan_low_speed}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=high VALUE={start_vars.asa_bed_fan_high_speed}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=cool VALUE={start_vars.asa_bed_fan_cool}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=cool_temp VALUE={start_vars.post_print_cool}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=enable VALUE={start_vars.asa_bed_fan_enable}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=chamber_fan_enable VALUE={start_vars.chamber_fan}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=floating_monitor VALUE={start_vars.floating_bed_fans}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=floating_max_speed VALUE={start_vars.floating_bed_fans_max}
	M400
	
	{% elif core_vars.filament == 'ABS' %}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=chamber_threshold VALUE={start_vars.abs_min_chamber_temp}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=chamber_fan VALUE={start_vars.abs_max_chamber_temp}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=low VALUE={start_vars.abs_bed_fan_low_speed}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=high VALUE={start_vars.abs_bed_fan_high_speed}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=cool VALUE={start_vars.abs_bed_fan_cool}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=cool_temp VALUE={start_vars.post_print_cool}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=enable VALUE={start_vars.abs_bed_fan_enable}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=chamber_fan_enable VALUE={start_vars.chamber_fan}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=floating_monitor VALUE={start_vars.floating_bed_fans}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=floating_max_speed VALUE={start_vars.floating_bed_fans_max}
	M400
	
	{% elif core_vars.filament in ['PET', 'PETG'] %}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=chamber_threshold VALUE={start_vars.petg_min_chamber_temp}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=chamber_fan VALUE={start_vars.petg_max_chamber_temp}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=low VALUE={start_vars.petg_bed_fan_low_speed}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=high VALUE={start_vars.petg_bed_fan_high_speed}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=cool VALUE={start_vars.petg_bed_fan_cool}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=cool_temp VALUE={start_vars.post_print_cool}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=enable VALUE={start_vars.petg_bed_fan_enable}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=chamber_fan_enable VALUE={start_vars.chamber_fan}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=floating_monitor VALUE={start_vars.floating_bed_fans}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=floating_max_speed VALUE={start_vars.floating_bed_fans_max}
	M400
	
	{% elif core_vars.filament in ['FLEX', 'TPU'] %}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=chamber_threshold VALUE={start_vars.tpu_min_chamber_temp}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=chamber_fan VALUE={start_vars.tpu_max_chamber_temp}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=low VALUE={start_vars.tpu_bed_fan_low_speed}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=high VALUE={start_vars.tpu_bed_fan_high_speed}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=cool VALUE={start_vars.tpu_bed_fan_cool}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=cool_temp VALUE={start_vars.post_print_cool}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=enable VALUE={start_vars.tpu_bed_fan_enable}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=chamber_fan_enable VALUE={start_vars.chamber_fan}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=floating_monitor VALUE={start_vars.floating_bed_fans}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=floating_max_speed VALUE={start_vars.floating_bed_fans_max}
	M400
	
	{% else %}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=chamber_threshold VALUE={start_vars.default_min_chamber_temp}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=chamber_fan VALUE={start_vars.default_max_chamber_temp}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=low VALUE={start_vars.default_bed_fan_low_speed}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=high VALUE={start_vars.default_bed_fan_high_speed}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=cool VALUE={start_vars.default_bed_fan_cool}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=cool_temp VALUE={start_vars.post_print_cool}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=enable VALUE={start_vars.default_bed_fan_enable}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=chamber_fan_enable VALUE={start_vars.chamber_fan}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=floating_monitor VALUE={start_vars.floating_bed_fans}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=floating_max_speed VALUE={start_vars.floating_bed_fans_max}
	M400
	
	{% endif %}

[gcode_macro _CHAMBER_HEATER_SETUP]
gcode = 
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	{% set core_vars = printer["gcode_macro _CORE_VARS"] %}
	
	{% if core_vars.filament in ['PLA', 'PLA+'] %}
	SET_GCODE_VARIABLE MACRO=_C_HEATER_VARS VARIABLE=min_thresold VALUE={start_vars.pla_min_chamber_temp}
	SET_GCODE_VARIABLE MACRO=_C_HEATER_VARS VARIABLE=max_thresold VALUE={start_vars.pla_max_chamber_temp}
	SET_GCODE_VARIABLE MACRO=_C_HEATER_VARS VARIABLE=mid_point VALUE={(start_vars.pla_min_chamber_temp + start_vars.pla_max_chamber_temp) / 2|float}
	M400
	
	{% elif core_vars.filament == 'ASA' %}
	SET_GCODE_VARIABLE MACRO=_C_HEATER_VARS VARIABLE=min_thresold VALUE={start_vars.asa_min_chamber_temp}
	SET_GCODE_VARIABLE MACRO=_C_HEATER_VARS VARIABLE=max_thresold VALUE={start_vars.asa_max_chamber_temp}
	SET_GCODE_VARIABLE MACRO=_C_HEATER_VARS VARIABLE=mid_point VALUE={(start_vars.asa_min_chamber_temp + start_vars.asa_max_chamber_temp) / 2|float}
	M400
	
	{% elif core_vars.filament == 'ABS' %}
	SET_GCODE_VARIABLE MACRO=_C_HEATER_VARS VARIABLE=min_thresold VALUE={start_vars.abs_min_chamber_temp}
	SET_GCODE_VARIABLE MACRO=_C_HEATER_VARS VARIABLE=max_thresold VALUE={start_vars.abs_max_chamber_temp}
	SET_GCODE_VARIABLE MACRO=_C_HEATER_VARS VARIABLE=mid_point VALUE={(start_vars.abs_min_chamber_temp + start_vars.abs_max_chamber_temp) / 2|float}
	M400
	
	{% elif core_vars.filament in ['PET', 'PETG'] %}
	SET_GCODE_VARIABLE MACRO=_C_HEATER_VARS VARIABLE=min_thresold VALUE={start_vars.petg_min_chamber_temp}
	SET_GCODE_VARIABLE MACRO=_C_HEATER_VARS VARIABLE=max_thresold VALUE={start_vars.petg_max_chamber_temp}
	SET_GCODE_VARIABLE MACRO=_C_HEATER_VARS VARIABLE=mid_point VALUE={(start_vars.petg_min_chamber_temp + start_vars.petg_max_chamber_temp) / 2|float}
	M400
	
	{% elif core_vars.filament in ['FLEX', 'TPU'] %}
	SET_GCODE_VARIABLE MACRO=_C_HEATER_VARS VARIABLE=min_thresold VALUE={start_vars.tpu_min_chamber_temp}
	SET_GCODE_VARIABLE MACRO=_C_HEATER_VARS VARIABLE=max_thresold VALUE={start_vars.tpu_max_chamber_temp}
	SET_GCODE_VARIABLE MACRO=_C_HEATER_VARS VARIABLE=mid_point VALUE={(start_vars.tpu_min_chamber_temp + start_vars.tpu_max_chamber_temp) / 2|float}
	M400
	
	{% else %}
	SET_GCODE_VARIABLE MACRO=_C_HEATER_VARS VARIABLE=min_thresold VALUE={start_vars.default_min_chamber_temp}
	SET_GCODE_VARIABLE MACRO=_C_HEATER_VARS VARIABLE=max_thresold VALUE={start_vars.default_max_chamber_temp}
	SET_GCODE_VARIABLE MACRO=_C_HEATER_VARS VARIABLE=mid_point VALUE={(start_vars.default_min_chamber_temp + start_vars.default_max_chamber_temp) / 2|float}
	M400
	
	{% endif %}

[gcode_macro _CHAMBER_TEMPS_HELPER]
gcode = 
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	{% set core_vars = printer["gcode_macro _CORE_VARS"] %}
	
	{% if core_vars.filament in ['PLA', 'PLA+'] %}
	SET_GCODE_VARIABLE MACRO=_CORE_VARS VARIABLE=heat_wait_temp VALUE={start_vars.pla_min_chamber_temp}
	{% if start_vars.chamber_fan == True %}
	SET_TEMPERATURE_FAN_TARGET temperature_fan="chamber" target={start_vars.pla_max_chamber_temp}
	RESPOND TYPE=COMMAND MSG="Setting Chamber Fan Temp: PLA {start_vars.pla_max_chamber_temp}c"
	{% endif %}
	
	{% elif core_vars.filament == 'ASA' %}
	SET_GCODE_VARIABLE MACRO=_CORE_VARS VARIABLE=heat_wait_temp VALUE={start_vars.asa_min_chamber_temp}
	{% if start_vars.chamber_fan == True %}
	SET_TEMPERATURE_FAN_TARGET temperature_fan="chamber" target={start_vars.asa_max_chamber_temp}
	RESPOND TYPE=COMMAND MSG="Setting Chamber Fan Temp: ASA {start_vars.asa_max_chamber_temp}c"
	{% endif %}
	
	{% elif core_vars.filament == 'ABS' %}
	SET_GCODE_VARIABLE MACRO=_CORE_VARS VARIABLE=heat_wait_temp VALUE={start_vars.abs_min_chamber_temp}
	{% if start_vars.chamber_fan == True %}
	SET_TEMPERATURE_FAN_TARGET temperature_fan="chamber" target={start_vars.abs_max_chamber_temp}
	RESPOND TYPE=COMMAND MSG="Setting Chamber Fan Temp: ABS {start_vars.abs_max_chamber_temp}c"
	{% endif %}
	
	{% elif core_vars.filament in ['PET', 'PETG'] %}
	SET_GCODE_VARIABLE MACRO=_CORE_VARS VARIABLE=heat_wait_temp VALUE={start_vars.petg_min_chamber_temp}
	{% if start_vars.chamber_fan == True %}
	SET_TEMPERATURE_FAN_TARGET temperature_fan="chamber" target={start_vars.petg_max_chamber_temp}
	RESPOND TYPE=COMMAND MSG="Setting Chamber Fan Temp: PETG {start_vars.petg_max_chamber_temp}c"
	{% endif %}
	
	{% elif core_vars.filament in ['FLEX', 'TPU'] %}
	SET_GCODE_VARIABLE MACRO=_CORE_VARS VARIABLE=heat_wait_temp VALUE={start_vars.tpu_min_chamber_temp}
	{% if start_vars.chamber_fan == True %}
	SET_TEMPERATURE_FAN_TARGET temperature_fan="chamber" target={start_vars.tpu_max_chamber_temp}
	RESPOND TYPE=COMMAND MSG="Setting Chamber Fan Temp: TPU {start_vars.tpu_max_chamber_temp}c"
	{% endif %}
	
	{% else %}
	SET_GCODE_VARIABLE MACRO=_CORE_VARS VARIABLE=heat_wait_temp VALUE={start_vars.default_min_chamber_temp}
	{% if start_vars.chamber_fan == True %}
	SET_TEMPERATURE_FAN_TARGET temperature_fan="chamber" target={start_vars.default_max_chamber_temp}
	RESPOND TYPE=COMMAND MSG="Setting Chamber Fan Temp: Default {start_vars.default_max_chamber_temp}c"
	{% endif %}
	
	{% endif %}

[gcode_macro _START_WAIT_AND_TIMER_HANDLING]
gcode = 
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	{% set core_vars = printer["gcode_macro _CORE_VARS"] %}
	
	{% if core_vars.chamber_thermal_sensor == 0 %}
	{action_raise_error("This error is caused by no correctly named chamber_sensor or temperature controlled chamber_fan being available to the system! Check the system is setup correctly!")}
	
	{% elif core_vars.chamber_thermal_sensor == 1 %}
	{% set thermal_sensor = printer["temperature_fan chamber"].temperature %}
	{% set wait_thermal_sensor = "temperature_fan chamber" %}
	
	{% elif core_vars.chamber_thermal_sensor == 2 %}
	{% set thermal_sensor = printer["temperature_sensor Chamber_Temp"].temperature %}
	{% set wait_thermal_sensor = "temperature_sensor Chamber_Temp" %}
	
	{% endif %}
	
	{% if start_vars.chamber_fan and start_vars.chamber_sensor == True %}
	{action_raise_error("This error is caused by you setting both the chamber_fan & chamber_sensor to true. Check demon_user_settings file & set these correctly for your printer!")}
	{% endif %}
	
	{% if start_vars.chamber_fan or start_vars.chamber_sensor == True %}
	{% if thermal_sensor < core_vars.heat_wait_temp %}
	
	{% if start_vars.chamber_temp_wait == True %}
	_Z_PARK
	SET_DISPLAY_TEXT MSG="Waiting For Chamber Temp: {core_vars.heat_wait_temp}c"
	RESPOND TYPE=COMMAND MSG="Waiting For Chamber Temp: {core_vars.heat_wait_temp}c"
	TEMPERATURE_WAIT SENSOR="{wait_thermal_sensor}" MINIMUM={core_vars.heat_wait_temp|float -1}
	RESPOND TYPE=COMMAND MSG="Chamber Temp Reached"
	
	_CONDITIONAL_CLEAN
	G28 Z
	
	{% else %}
	_Z_PARK
	{% if core_vars.filament in ['PLA', 'PLA+', 'PET', 'PETG', 'FLEX', 'TPU'] %}
	_HEAT_WAIT MINUTES={start_vars.lo_temp_timer}
	RESPOND TYPE=COMMAND MSG="Running Low Temp Chamber Timer via sensor"
	{% elif core_vars.filament in ['ASA', 'ABS'] %}
	_HEAT_WAIT MINUTES={start_vars.hi_temp_timer}
	RESPOND TYPE=COMMAND MSG="Running High Temp Chamber Timer via sensor"
	{% else %}
	_HEAT_WAIT MINUTES={start_vars.default_temp_timer}
	RESPOND TYPE=COMMAND MSG="Running Default Temp Chamber Timer via sensor"
	
	_CONDITIONAL_CLEAN
	G28 Z
	
	{% endif %}
	{% endif %}
	
	{% else %}
	SET_DISPLAY_TEXT MSG="Already up to {core_vars.filament} temp, heat soak skipped"
	RESPOND TYPE=COMMAND MSG="Already up to {core_vars.filament} temp, heat soak skipped"
	G4 P5000
	
	{% endif %}
	
	
	{% else %}
	
	{% if core_vars.filament in ['PLA', 'PLA+', 'PET', 'PETG', 'FLEX', 'TPU'] %}
	RESPOND TYPE=COMMAND MSG="Running Low Temp Chamber Timer via Filament Type"
	_Z_PARK
	_HEAT_WAIT MINUTES={start_vars.lo_temp_timer}
	
	{% elif core_vars.filament in ['ASA', 'ABS'] %}
	RESPOND TYPE=COMMAND MSG="Running High Temp Chamber Timer via Filament Type"
	_Z_PARK
	
	_HEAT_WAIT MINUTES={start_vars.hi_temp_timer}
	
	{% else %}
	{% if core_vars.bed|int < 90|int %}
	RESPOND TYPE=COMMAND MSG="Running Low Temp Chamber Timer via File Temps"
	_Z_PARK
	_HEAT_WAIT MINUTES={start_vars.lo_temp_timer}
	
	{% else %}
	RESPOND TYPE=COMMAND MSG="Running High Temp Chamber Timer via File Temps"
	_Z_PARK
	
	_HEAT_WAIT MINUTES={start_vars.hi_temp_timer}
	{% endif %}
	
	{% endif %}
	
	{% endif %}
	
	M107

[gcode_macro _MESH_HANDLING]
gcode = 
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	{% set core_vars = printer["gcode_macro _CORE_VARS"] %}
	
	{% if start_vars.adaptive_meshing == True %}
	
	{% if ('mcu eddy' in printer.configfile.config) or ('probe_eddy_current btt_eddy' in printer) or ('probe_eddy_current eddy' in printer) %}
	BED_MESH_CALIBRATE METHOD=rapid_scan ADAPTIVE=1 ADAPTIVE_MARGIN=10
	M400
	G0 Z{printer["gcode_macro _Z_PARK"].z_park} F3600
	
	{% else %}
	BED_MESH_CALIBRATE ADAPTIVE=1 ADAPTIVE_MARGIN=10
	M400
	{% if 'scanner' in printer %}
	CARTOGRAPHER_TOUCH
	{% endif %}
	{% endif %}
	
	{% if start_vars.klicky_probe == True and printer.configfile.settings.stepper_z.endstop_pin == 'probe:z_virtual_endstop' %}
	Dock_Probe_Unlock
	{% if start_vars.nozzle_cleaner == True %}
	CLEAN_NOZZLE
	{% endif %}
	{% elif start_vars.klicky_probe != True and printer.configfile.settings.stepper_z.endstop_pin == 'probe:z_virtual_endstop' %}
	{% if start_vars.nozzle_cleaner == True %}
	CLEAN_NOZZLE
	{% endif %}
	{% endif %}
	
	{% else %}
	{% if core_vars.filament in ['PLA', 'PLA+'] %}
	{% if 'bed_mesh default' in printer.configfile.config %}
	BED_MESH_PROFILE LOAD="default"
	RESPOND TYPE=COMMAND MSG="Default mesh loaded"
	{% else %}
	{action_raise_error("ERROR: There is no recognised default mesh available, please build & save one to continue!")}
	{% endif %}
	
	{% elif core_vars.filament == 'ASA' %}
	{% if 'bed_mesh ASA' in printer.configfile.config %}
	BED_MESH_PROFILE LOAD="ASA"
	RESPOND TYPE=COMMAND MSG="ASA mesh loaded"
	{% else %}
	{action_raise_error("ERROR: There is no recognised ASA mesh available, please build & save one to continue!")}
	{% endif %}
	
	{% elif core_vars.filament == 'ABS' %}
	{% if 'bed_mesh ABS' in printer.configfile.config %}
	BED_MESH_PROFILE LOAD="ABS"
	RESPOND TYPE=COMMAND MSG="ABS mesh loaded"
	{% else %}
	{action_raise_error("ERROR: There is no recognised ABS mesh available, please build & save one to continue!")}
	{% endif %}
	
	{% elif core_vars.filament in ['PET', 'PETG'] %}
	{% if 'bed_mesh PETG' in printer.configfile.config %}
	BED_MESH_PROFILE LOAD="PETG"
	RESPOND TYPE=COMMAND MSG="PETG mesh loaded"
	{% else %}
	{action_raise_error("ERROR: There is no recognised PETG mesh available, please build & save one to continue!")}
	{% endif %}
	
	{% elif core_vars.filament in ['FLEX', 'TPU'] %}
	{% if 'bed_mesh TPU' in printer.configfile.config %}
	BED_MESH_PROFILE LOAD="TPU"
	RESPOND TYPE=COMMAND MSG="TPU mesh loaded"
	{% else %}
	{action_raise_error("ERROR: There is no recognised TPU mesh available, please build & save one to continue!")}
	{% endif %}
	
	{% else %}
	{% if params.BED|float < 90 %}
	{% if 'bed_mesh default' in printer.configfile.config %}
	BED_MESH_PROFILE LOAD="default"
	RESPOND TYPE=COMMAND MSG="Default mesh by temp loaded"
	{% else %}
	{action_raise_error("ERROR: There is no recognised default mesh available, please build & save one to continue!")}
	{% endif %}
	
	{% else %}
	{% if 'bed_mesh ASA' in printer.configfile.config %}
	BED_MESH_PROFILE LOAD="ASA"
	RESPOND TYPE=COMMAND MSG="ASA mesh by temp loaded"
	
	{% elif 'bed_mesh ABS' in printer.configfile.config %}
	BED_MESH_PROFILE LOAD="ABS"
	RESPOND TYPE=COMMAND MSG="ABS mesh by temp loaded"
	
	{% elif 'bed_mesh ASA' not in printer.configfile.config and 'bed_mesh ABS' not in printer.configfile.config %}
	{action_raise_error("ERROR: There are no recognised high temperature meshes available, please build an ASA or ABS mesh & save it to continue!")}
	{% endif %}
	{% endif %}
	{% endif %}
	
	M400
	{% if 'scanner' in printer %}
	CARTOGRAPHER_TOUCH
	{% endif %}
	{% endif %}

[gcode_macro _ORCA_MULTI_SURFACE_HANDLING]
gcode = 
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	{% set surface = printer["gcode_macro _CORE_VARS"].orca_surface %}
	
	
	
	{% if start_vars.orca_multi_surface == True %}
	{% if surface == 'Cool Plate' %}
	SET_GCODE_VARIABLE MACRO=_CORE_VARS VARIABLE=orca_bed_offset VALUE={start_vars.orca_cool_plate}
	
	{% elif surface == 'High Temp Plate' %}
	SET_GCODE_VARIABLE MACRO=_CORE_VARS VARIABLE=orca_bed_offset VALUE={start_vars.orca_smooth_hi_temp_plate}
	
	{% elif surface == 'Textured PEI Plate' %}
	SET_GCODE_VARIABLE MACRO=_CORE_VARS VARIABLE=orca_bed_offset VALUE={start_vars.orca_textured_pei_plate}
	
	{% elif surface == 'Engineering Plate' %}
	SET_GCODE_VARIABLE MACRO=_CORE_VARS VARIABLE=orca_bed_offset VALUE={start_vars.orca_engineering_plate}
	
	{% elif surface == 'Textured Cool Plate' %}
	SET_GCODE_VARIABLE MACRO=_CORE_VARS VARIABLE=orca_bed_offset VALUE={start_vars.orca_textured_cool_plate}
	
	{% endif %}
	
	{% endif %}

[gcode_macro _Z_OFFSET_HANDLING]
gcode = 
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	
	{% set core_vars = printer["gcode_macro _CORE_VARS"] %}
	
	
	{% if start_vars.orca_multi_surface == True and start_vars.combine_offset == True %}
	{% if core_vars.orca_bed_offset >= -0.165 and core_vars.orca_bed_offset <= 0.165 %}
	{% if core_vars.filament in ['PLA', 'PLA+'] %}
	{% if core_vars.orca_bed_offset == 0.00 %}
	SET_DISPLAY_TEXT MSG="BED TYPE: {core_vars.orca_surface} selected. NO OFFSET APPLIED"
	RESPOND TYPE=COMMAND MSG="BED TYPE: {core_vars.orca_surface} selected. NO OFFSET APPLIED"
	{% elif core_vars.orca_bed_offset != 0.00 %}
	SET_GCODE_OFFSET Z_ADJUST={core_vars.orca_bed_offset} MOVE=1
	SET_DISPLAY_TEXT MSG="BED TYPE: Applying {core_vars.orca_surface} offset adjustment"
	RESPOND TYPE=echo MSG="BED TYPE: Applying {core_vars.orca_surface} offset adjustment"
	
	
	{% endif %}
	
	{% elif start_vars.high_temp_expansion_offset == True and core_vars.filament in ['ASA', 'ABS'] %}
	{% if start_vars.high_temp_offset >= -0.165 and start_vars.high_temp_offset <= 0.165 %}
	{% if core_vars.orca_bed_offset == 0.00 %}
	SET_GCODE_OFFSET Z_ADJUST={start_vars.high_temp_offset} MOVE=1
	SET_DISPLAY_TEXT MSG="REQUESTED HIGH TEMP OFFSET ADJUSTMENT APPLIED"
	RESPOND TYPE=echo MSG="REQUESTED HIGH TEMP OFFSET ADJUSTMENT APPLIED"
	{% elif core_vars.orca_bed_offset != 0.00 %}
	{% if (start_vars.high_temp_offset + core_vars.orca_bed_offset) >= -0.165 and (start_vars.high_temp_offset + core_vars.orca_bed_offset) <= 0.165 %}
	SET_GCODE_OFFSET Z_ADJUST={start_vars.high_temp_offset + core_vars.orca_bed_offset} MOVE=1
	SET_DISPLAY_TEXT MSG="BED TYPE: Applying {core_vars.orca_surface} & High Temp combined offset adjustment"
	RESPOND TYPE=echo MSG="BED TYPE: Applying {core_vars.orca_surface} & High Temp combined offset adjustment"
	{% else %}
	{action_emergency_stop("EMERGENCY STOP! EXCESSIVE HIGH TEMP OFFSET REQUESTED CORRECT IN USER SETTINGS FILE")}
	{% endif %}
	{% endif %}
	{% else %}
	{action_emergency_stop("EMERGENCY STOP! EXCESSIVE HIGH TEMP OFFSET REQUESTED CORRECT IN USER SETTINGS FILE")}
	{% endif %}
	G4 P10000
	
	{% elif start_vars.petg_anti_squish == True and core_vars.filament in ['PET', 'PETG'] %}
	{% if start_vars.petg_offset >= 0.0 and start_vars.petg_offset <= 0.165 %}
	{% if core_vars.orca_bed_offset == 0.00 %}
	SET_GCODE_OFFSET Z_ADJUST={start_vars.petg_offset} MOVE=1
	SET_DISPLAY_TEXT MSG="REQUESTED PETG OFFSET ADJUSTMENT APPLIED"
	RESPOND TYPE=echo MSG="REQUESTED PETG OFFSET ADJUSTMENT APPLIED"
	{% elif core_vars.orca_bed_offset != 0.00 %}
	{% if (start_vars.petg_offset + core_vars.orca_bed_offset) >= -0.165 and (start_vars.petg_offset + core_vars.orca_bed_offset) <= 0.165 %}
	SET_GCODE_OFFSET Z_ADJUST={start_vars.petg_offset + core_vars.orca_bed_offset} MOVE=1
	SET_DISPLAY_TEXT MSG="BED TYPE: Applying {core_vars.orca_surface} & PETG Anti Squish combined offset adjustment"
	RESPOND TYPE=echo MSG="BED TYPE: Applying {core_vars.orca_surface} & PETG Anti Squish combined offset adjustment"
	{% else %}
	{action_emergency_stop("EMERGENCY STOP! NEGATIVE OR EXCESSIVE OFFSET REQUESTED CORRECT IN USER SETTINGS FILE")}
	{% endif %}
	{% endif %}
	{% else %}
	{action_emergency_stop("EMERGENCY STOP! NEGATIVE OR EXCESSIVE OFFSET REQUESTED CORRECT IN USER SETTINGS FILE")}
	{% endif %}
	G4 P10000
	
	{% elif start_vars.tpu_anti_squish == True and core_vars.filament in ['FLEX','TPU'] %}
	{% if start_vars.tpu_offset >= 0.0 and start_vars.tpu_offset <= 0.165 %}
	{% if core_vars.orca_bed_offset == 0.00 %}
	SET_GCODE_OFFSET Z_ADJUST={start_vars.tpu_offset} MOVE=1
	SET_DISPLAY_TEXT MSG="REQUESTED TPU OFFSET ADJUSTMENT APPLIED"
	RESPOND TYPE=echo MSG="REQUESTED TPU OFFSET ADJUSTMENT APPLIED"
	{% elif core_vars.orca_bed_offset != 0.00 %}
	{% if (start_vars.tpu_offset + core_vars.orca_bed_offset) >= -0.165 and (start_vars.tpu_offset + core_vars.orca_bed_offset) <= 0.165 %}
	SET_GCODE_OFFSET Z_ADJUST={start_vars.tpu_offset + core_vars.orca_bed_offset} MOVE=1
	SET_DISPLAY_TEXT MSG="BED TYPE: Applying {core_vars.orca_surface} & TPU Anti Squish combined offset adjustment"
	RESPOND TYPE=echo MSG="BED TYPE: Applying {core_vars.orca_surface} & TPU Anti Squish combined offset adjustment"
	{% else %}
	{action_emergency_stop("EMERGENCY STOP! NEGATIVE OR EXCESSIVE OFFSET REQUESTED CORRECT IN USER SETTINGS FILE")}
	{% endif %}
	
	{% endif %}
	{% else %}
	{action_emergency_stop("EMERGENCY STOP! NEGATIVE OR EXCESSIVE OFFSET REQUESTED CORRECT IN USER SETTINGS FILE")}
	{% endif %}
	G4 P10000
	
	{% elif start_vars.high_temp_expansion_offset == False and core_vars.filament in ['ASA', 'ABS'] %}
	{% if core_vars.orca_bed_offset == 0.00 %}
	SET_DISPLAY_TEXT MSG="BED TYPE: {core_vars.orca_surface} selected. NO OFFSET APPLIED"
	RESPOND TYPE=echo MSG="BED TYPE: {core_vars.orca_surface} selected. NO OFFSET APPLIED"
	{% elif core_vars.orca_bed_offset != 0.00 %}
	SET_GCODE_OFFSET Z_ADJUST={core_vars.orca_bed_offset} MOVE=1
	SET_DISPLAY_TEXT MSG="BED TYPE: {core_vars.orca_surface} selected. REQUESTED BED TYPE OFFSET ADJUSTMENT APPLIED"
	RESPOND TYPE=echo MSG="BED TYPE: {core_vars.orca_surface} selected. REQUESTED BED TYPE OFFSET ADJUSTMENT APPLIED"
	{% endif %}
	
	{% elif start_vars.petg_anti_squish == False and core_vars.filament in ['PET', 'PETG'] %}
	{% if core_vars.orca_bed_offset == 0.00 %}
	SET_DISPLAY_TEXT MSG="BED TYPE: {core_vars.orca_surface} selected. NO OFFSET APPLIED"
	RESPOND TYPE=echo MSG="BED TYPE: {core_vars.orca_surface} selected. NO OFFSET APPLIED"
	{% elif core_vars.orca_bed_offset != 0.00 %}
	SET_GCODE_OFFSET Z_ADJUST={core_vars.orca_bed_offset} MOVE=1
	SET_DISPLAY_TEXT MSG="BED TYPE: {core_vars.orca_surface} selected. REQUESTED BED TYPE OFFSET ADJUSTMENT APPLIED"
	RESPOND TYPE=echo MSG="BED TYPE: {core_vars.orca_surface} selected. REQUESTED BED TYPE OFFSET ADJUSTMENT APPLIED"
	{% endif %}
	
	{% elif start_vars.tpu_anti_squish == True and core_vars.filament in ['FLEX','TPU'] %}
	{% if core_vars.orca_bed_offset == 0.00 %}
	SET_DISPLAY_TEXT MSG="BED TYPE: {core_vars.orca_surface} selected. NO OFFSET APPLIED"
	RESPOND TYPE=echo MSG="BED TYPE: {core_vars.orca_surface} selected. NO OFFSET APPLIED"
	{% elif core_vars.orca_bed_offset != 0.00 %}
	SET_GCODE_OFFSET Z_ADJUST={core_vars.orca_bed_offset} MOVE=1
	SET_DISPLAY_TEXT MSG="BED TYPE: {core_vars.orca_surface} selected. REQUESTED BED TYPE OFFSET ADJUSTMENT APPLIED"
	RESPOND TYPE=echo MSG="BED TYPE: {core_vars.orca_surface} selected. REQUESTED BED TYPE OFFSET ADJUSTMENT APPLIED"
	{% endif %}
	{% endif %}
	
	
	{% else %}
	{action_emergency_stop("EMERGENCY STOP! EXCESSIVE PLATE OFFSET REQUESTED CORRECT IN USER SETTINGS FILE")}
	{% endif %}
	
	
	{% elif start_vars.orca_multi_surface == True and start_vars.combine_offset == False %}
	{% if core_vars.orca_bed_offset >= -0.165 and core_vars.orca_bed_offset <= 0.165 %}
	{% if core_vars.orca_bed_offset == 0.00 %}
	SET_DISPLAY_TEXT MSG="BED TYPE: {core_vars.orca_surface} SELECTED. NO OFFSET APPLIED"
	RESPOND TYPE=COMMAND MSG="BED TYPE: {core_vars.orca_surface} SELECTED. NO OFFSET APPLIED"
	G4 P10000
	{% elif core_vars.orca_bed_offset != 0.00 %}
	SET_GCODE_OFFSET Z_ADJUST={core_vars.orca_bed_offset} MOVE=1
	SET_DISPLAY_TEXT MSG="BED TYPE: {core_vars.orca_surface} selected. REQUESTED BED TYPE OFFSET ADJUSTMENT APPLIED"
	RESPOND TYPE=echo MSG="BED TYPE: {core_vars.orca_surface} selected. REQUESTED BED TYPE OFFSET ADJUSTMENT APPLIED"
	G4 P10000
	{% endif %}
	
	{% else %}
	{action_emergency_stop("EMERGENCY STOP! EXCESSIVE PLATE OFFSET REQUESTED CORRECT IN USER SETTINGS FILE")}
	{% endif %}
	
	
	
	{% elif start_vars.orca_multi_surface == False and start_vars.combine_offset == True %}
	{action_raise_error("This error is caused by variable_orca_multi_surface being set to False when combine_offset is set to True! Check demon_user_settings file!")}
	
	{% elif start_vars.orca_multi_surface == False and start_vars.combine_offset == False %}
	
	{% if start_vars.high_temp_expansion_offset == True and core_vars.filament in ['ASA', 'ABS'] %}
	{% if start_vars.high_temp_offset >= -0.165 and start_vars.high_temp_offset <= 0.165 %}
	SET_GCODE_OFFSET Z_ADJUST={start_vars.high_temp_offset} MOVE=1
	SET_DISPLAY_TEXT MSG="REQUESTED HIGH TEMP OFFSET ADJUSTMENT APPLIED"
	RESPOND TYPE=echo MSG="REQUESTED HIGH TEMP OFFSET ADJUSTMENT APPLIED"
	G4 P10000
	
	{% else %}
	{action_emergency_stop("EMERGENCY STOP! EXCESSIVE HIGH TEMP OFFSET REQUESTED CORRECT IN USER SETTINGS FILE")}
	
	{% endif %}
	
	{% elif start_vars.petg_anti_squish == True and core_vars.filament in ['PET', 'PETG'] %}
	{% if start_vars.petg_offset >= 0.0 and start_vars.petg_offset <= 0.165 %}
	SET_GCODE_OFFSET Z_ADJUST={start_vars.petg_offset} MOVE=1
	SET_DISPLAY_TEXT MSG="REQUESTED PETG OFFSET ADJUSTMENT APPLIED"
	RESPOND TYPE=echo MSG="REQUESTED PETG OFFSET ADJUSTMENT APPLIED"
	G4 P10000
	
	{% else %}
	{action_emergency_stop("EMERGENCY STOP! NEGATIVE OR EXCESSIVE OFFSET REQUESTED CORRECT IN USER SETTINGS FILE")}
	
	{% endif %}
	
	{% elif start_vars.tpu_anti_squish == True and core_vars.filament in ['FLEX','TPU'] %}
	{% if start_vars.tpu_offset >= 0.0 and start_vars.tpu_offset <= 0.165 %}
	SET_GCODE_OFFSET Z_ADJUST={start_vars.tpu_offset} MOVE=1
	SET_DISPLAY_TEXT MSG="REQUESTED TPU OFFSET ADJUSTMENT APPLIED"
	RESPOND TYPE=echo MSG="REQUESTED TPU OFFSET ADJUSTMENT APPLIED"
	G4 P10000
	
	{% else %}
	{action_emergency_stop("EMERGENCY STOP! NEGATIVE OR EXCESSIVE OFFSET REQUESTED CORRECT IN USER SETTINGS FILE")}
	
	{% endif %}
	
	{% endif %}
	
	{% endif %}

[gcode_macro _ORCA_OFFSET_REMOVE]
variable_z = 0.00
gcode = 
	{% set core_vars = printer["gcode_macro _CORE_VARS"] %}
	
	{% if core_vars.orca_bed_offset != 0.00 %}
	SET_GCODE_OFFSET Z=0.00
	SET_DISPLAY_TEXT MSG="Resetting offset due to applied Orca offset modifer"
	RESPOND TYPE=COMMAND MSG="Resetting offset due to applied Orca offset modifer"
	{% endif %}

[gcode_macro _EDDY_OFFSET_REMOVE]
gcode = 
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	
	{% if 'mcu eddy' in printer and 'probe_eddy_current btt_eddy' in printer %}
	{% if printer.gcode_move.homing_origin.z != 0.00 %}
	SET_GCODE_OFFSET Z=0
	RESPOND TYPE=COMMAND MSG="Removing Eddy auto offset"
	{% endif %}
	
	{% else %}
	RESPOND TYPE=COMMAND MSG="USB Eddy probe not present"
	{% endif %}

[gcode_macro _OFFSET_RESET_CONTROL]
gcode = 
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	{% set core_vars = printer["gcode_macro _CORE_VARS"] %}
	
	{% if start_vars.orca_enable == True and core_vars.offset_reset == False %}
	_ORCA_OFFSET_REMOVE
	{% endif %}
	
	{% if core_vars.offset_reset == True %}
	SET_GCODE_OFFSET Z=0.0 MOVE=1
	{% endif %}
	
	{% if start_vars.auto_reset_eddy_offset == True %}
	_EDDY_OFFSET_REMOVE
	{% endif %}

[gcode_macro _START_POS]
gcode = 
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	
	{% if start_vars.start_x_position >= 50 or start_vars.start_y_position >= 50%}
	{action_emergency_stop("EMERGENCY STOP! EXCESSIVE START POSITION REQUESTED CORRECT IN USER SETTINGS FILE")}
	
	{% elif start_vars.purge_line_length|float > 150 %}
	{action_emergency_stop("EMERGENCY STOP! EXCESSIVE PURGE LENGTH REQUESTED CORRECT IN USER SETTINGS FILE")}
	
	{% endif %}
	
	SET_DISPLAY_TEXT MSG="Moving to Start Position"
	RESPOND TYPE=COMMAND MSG="Moving to Start Position"
	G0 Z25 F5000
	G0 X{start_vars.start_x_position} Y{start_vars.start_y_position} F5000
	
	
	G0 Z5.0 F5000
	G0 Z0.5 F150

[gcode_macro _PURGE_LINES]
gcode = 
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	{% set height = (printer.configfile.settings.extruder.nozzle_diameter * 0.75)|float %}
	{% set width = (printer.configfile.settings.extruder.nozzle_diameter * 1.25)|float %}
	{% set filament_area = 3.14159 * (printer.configfile.settings.extruder.filament_diameter ** 2) / 4 %}
	{% set rate = start_vars.purge_line_length * ((width * height) / filament_area) %}
	
	{% if start_vars.purge_lines == False %}
	G0 Z5.0
	SET_DISPLAY_TEXT MSG="Purge lines skipped, Print Start..."
	RESPOND TYPE=COMMAND MSG="Purge lines skipped, Print Start..."
	
	{% elif start_vars.adaptive_meshing == True and start_vars.purge_lines == True %}
	LINE_PURGE
	
	{% elif start_vars.use_kamp_adaptive_purge == True and start_vars.purge_lines == True %}
	LINE_PURGE
	
	{% else %}
	SET_DISPLAY_TEXT MSG="Printing Purge Lines"
	RESPOND TYPE=COMMAND MSG="Printing Purge Lines"
	G90
	G0 Z1.5 F9000
	
	G91
	{% if start_vars.purge_along_y == True %}
	G0 Y7 F9000
	{% else %}
	G0 X7 F9000
	{% endif %}
	
	G90
	G0 Z{height} F1500
	G91
	
	{% if start_vars.purge_along_y == True %}
	G1 Y{start_vars.purge_line_length} E{rate} F1500
	G0 X{width} F5000
	G1 Y-{start_vars.purge_line_length -15} E{rate} F1500
	
	
	{% else %}
	G1 X{start_vars.purge_line_length} E{rate} F1500
	G0 Y{width +0.4} F5000
	G1 X-{start_vars.purge_line_length -15} E{rate} F1500
	
	{% endif %}
	
	G0 Z{height} F9000
	G4 P2000
	G0 X5 Y5 F9000
	G90
	G92 E0.0
	M83
	G0 Z5.0 F9000
	M400
	SET_DISPLAY_TEXT MSG="Print Start..."
	RESPOND TYPE=COMMAND MSG="Print Start..."
	
	{% endif %}

[gcode_macro _NEVERMORE_POST_PRINT]
gcode = 
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	{% set core_vars = printer["gcode_macro _CORE_VARS"] %}
	
	{% if start_vars.nevermore_post_timer == False %}
	{% if start_vars.nevermore_leave_running == False %}
	SET_FAN_SPEED FAN=Nevermore SPEED=0
	RESPOND TYPE=COMMAND MSG="Nevermore post print, fan off."
	{% else %}
	RESPOND TYPE=COMMAND MSG="Nevermore post print, leaving fan on."
	{% endif %}
	
	{% else %}
	{% if core_vars.filament in ['PLA', 'PLA+', 'PET', 'PETG', 'FLEX','TPU'] and start_vars.nevermore_asa_abs_only == True %}
	{% if start_vars.nevermore_leave_running == False %}
	SET_FAN_SPEED FAN=Nevermore SPEED=0
	RESPOND TYPE=COMMAND MSG="Nevermore post print timer bypass, fan off."
	{% else %}
	RESPOND TYPE=COMMAND MSG="Nevermore post print timer bypass, leaving fan on."
	{% endif %}
	
	{% else %}
	RESPOND TYPE=COMMAND MSG="Nevermore post print chamber filteration process started, fan set to {("%.0f" % (start_vars.nevermore_post_speed|float * 100))}%"
	SET_FAN_SPEED FAN=Nevermore SPEED={start_vars.nevermore_post_speed|float}
	_HEAT_WAIT MSG="Nevermore post print chamber filtration timer..." MINUTES={start_vars.nevermore_post_run_time|int}
	M400
	{% if start_vars.nevermore_leave_running == False %}
	SET_FAN_SPEED FAN=Nevermore SPEED=0
	RESPOND TYPE=COMMAND MSG="Nevermore post print timer done, fan off."
	{% else %}
	RESPOND TYPE=COMMAND MSG="Nevermore post print timer done, leaving fan on."
	{% endif %}
	{% endif %}
	
	{% endif %}

[gcode_macro _GOODNIGHT]
gcode = 
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	
	{% if printer.extruder.temperature >= 50 %}
	M106 S255
	SET_DISPLAY_TEXT MSG="Cooling hotend for shutdown"
	RESPOND TYPE=COMMAND MSG="Cooling hotend for shutdown"
	TEMPERATURE_WAIT SENSOR=extruder MAXIMUM=49
	M400
	{% endif %}
	
	M107
	M117 GOODNIGHT...Zzzzzz
	M118 GOODNIGHT...Zzzzzz
	
	{% if start_vars.neopixel_led == True %}
	STATUS_OFF
	{% endif %}
	
	UPDATE_DELAYED_GCODE ID=_DELAY_OFF DURATION=5

[delayed_gcode _DELAY_OFF]
gcode = 
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	
	{% if start_vars.shutdown_relay == True %}
	{% if start_vars.all_in_one_pi == True or start_vars.host_shutdown == True %}
	{action_call_remote_method("shutdown_machine")}
	
	{% elif start_vars.all_in_one_pi == False and start_vars.host_shutdown == False %}
	{action_call_remote_method("set_device_power",device="Printer Power",state="off")}
	{% endif %}
	
	{% else %}
	{action_raise_error("Sorry you have not got a shutdown relay installed. Check the demon_user_settings file hardware options to enable it")}
	{% endif %}

[gcode_macro Power_Down]
description = If you have a mains power relay this will power the relay off & shutdown the client
gcode = 
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	
	{% if start_vars.shutdown_relay == True %}
	{action_call_remote_method("set_device_power",device="Printer Power",state="off")}
	{% else %}
	{action_raise_error("Sorry you have not got a shutdown relay installed. Check the demon_user_settings file hardware options to enable it")}
	{% endif %}

[gcode_macro _CONDITIONAL_CLEAN]
gcode = 
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	
	{% if start_vars.nozzle_cleaner == True %}
	{% if printer.configfile.settings.stepper_z.endstop_pin != 'probe:z_virtual_endstop' or 'smart_effector' in printer or
	('scanner' in printer) %}
	CLEAN_NOZZLE
	{% endif %}
	{% endif %}

[gcode_macro _step_control]
gcode = 
	{% set clean_vars = printer["gcode_macro _CLEAN_VARIABLES"] %}
	{% set rando_x_clean = range((clean_vars.clean_min_x|int), (clean_vars.clean_max_x|int))|random %}
	{% set rando_y_clean = range((clean_vars.clean_min_y|int), (clean_vars.clean_max_y|int))|random %}
	
	G90
	
	{% if clean_vars.random_clean_x == True and clean_vars.random_clean_y == True %}
	G0 X{rando_x_clean|int} Y{rando_y_clean|int} F{clean_vars.pass_spd * 60|int}
	
	{% elif clean_vars.random_clean_x == True and clean_vars.random_clean_y == False %}
	G0 X{rando_x_clean|int} Y{clean_vars.linear_clean_start_y|int} F{clean_vars.pass_spd * 60|int}
	
	{% elif clean_vars.random_clean_x == False and clean_vars.random_clean_y == True %}
	G0 X{clean_vars.linear_clean_start_x|int} Y{rando_y_clean|int} F{clean_vars.pass_spd * 60|int}
	{% endif %}

[gcode_macro _LINEAR_STEP_CONTROL_X]
gcode = 
	{% set clean_vars = printer["gcode_macro _CLEAN_VARIABLES"] %}
	
	G91
	{% if clean_vars.linear_clean_positive_dir == True %}
	G0 X{clean_vars.linear_clean_distance|int} F{clean_vars.pass_spd * 60|int}
	{% else %}
	G0 X-{clean_vars.linear_clean_distance|int} F{clean_vars.pass_spd * 60|int}
	{% endif %}
	G90
	G0 X{clean_vars.linear_clean_start_x|int} F{clean_vars.pass_spd * 60|int}

[gcode_macro _LINEAR_STEP_CONTROL_Y]
gcode = 
	{% set clean_vars = printer["gcode_macro _CLEAN_VARIABLES"] %}
	
	G91
	{% if clean_vars.linear_clean_positive_dir == True %}
	G0 Y{clean_vars.linear_clean_distance|int} F{clean_vars.pass_spd * 60|int}
	{% else %}
	G0 Y-{clean_vars.linear_clean_distance|int} F{clean_vars.pass_spd * 60|int}
	{% endif %}
	G90
	G0 Y{clean_vars.linear_clean_start_y|int} F{clean_vars.pass_spd * 60|int}

[gcode_macro _random_spot]
gcode = 
	{% set clean_vars = printer["gcode_macro _CLEAN_VARIABLES"] %}
	{% set rando_x = range((clean_vars.purge_min_x|int), (clean_vars.purge_max_x|int))|random %}
	
	G0 X{rando_x|int} Y{clean_vars.purge_y_park|int} F9000

[gcode_macro _klicky_check]
gcode = 
	query_probe
	_probe_state action={ params.ACTION }

[gcode_macro _probe_state]
gcode = 
	{% set query_probe_triggered = printer.probe.last_query %}
	{% set action  = params.ACTION|default('') %}
	
	{% if query_probe_triggered %}
	
	{% else %}
	Dock_Probe_Unlock
	{% endif %}

[gcode_macro _KLICKY_UNLOCKER]
gcode = 
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	
	{% if start_vars.klicky_probe == True and printer.configfile.settings.stepper_z.endstop_pin == 'probe:z_virtual_endstop'%}
	RESPOND TYPE=COMMAND MSG="UNLOCKING Klicky Probe!"
	Dock_Probe_Unlock
	{% endif %}

[gcode_macro _HOMING_HELPER]
gcode = 
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	
	{% if start_vars.klicky_probe == True %}
	{% if printer.configfile.settings.stepper_z.endstop_pin == 'probe:z_virtual_endstop' %}
	
	_SET_Z_PARK
	{% if "xyz" not in printer.toolhead.homed_axes %}
	{% if start_vars.neopixel_led == True %}
	STATUS_HOMING
	{% endif %}
	
	SET_DISPLAY_TEXT MSG="Homing..."
	RESPOND TYPE=COMMAND MSG="Homing..."
	G28 X Y
	ATTACH_PROBE_LOCK
	RESPOND TYPE=COMMAND MSG="Klicky Probe is now LOCKED!"
	G28 Z
	{% endif %}
	
	{% else %}
	_CONDITIONAL_HOME
	{% endif %}
	
	{% else %}
	_CONDITIONAL_HOME
	{% endif %}

[gcode_macro _CONDITIONAL_HOME]
gcode = 
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	
	_SET_Z_PARK
	{% if "xyz" not in printer.toolhead.homed_axes %}
	{% if start_vars.neopixel_led == True %}
	STATUS_HOMING
	{% endif %}
	
	SET_DISPLAY_TEXT MSG="Homing..."
	RESPOND TYPE=COMMAND MSG="Homing..."
	
	G28
	
	{% else %}
	{% if start_vars.klicky_probe == True %}
	_klicky_check
	{% endif %}
	{% endif %}
	M117
	M400

[gcode_macro M84]
rename_existing = M84.1
gcode = 
	_SAVE
	M400
	_Z_READER
	M84.1
	UPDATE_DELAYED_GCODE ID=_ACTIVE_Z_MONITOR DURATION=0

[delayed_gcode _ACTIVE_Z_MONITOR]
gcode = 
	{% set core_vars = printer["gcode_macro _CORE_VARS"] %}
	
	{% if 'z' in printer.toolhead.homed_axes and printer.print_stats.state not in ["printing", "paused"] %}
	{% if printer.toolhead.position.z != core_vars.last_known_z %}
	_SAVE
	UPDATE_DELAYED_GCODE ID=_ACTIVE_Z_MONITOR DURATION=10
	{% else %}
	UPDATE_DELAYED_GCODE ID=_ACTIVE_Z_MONITOR DURATION=10
	{% endif %}
	
	{% elif 'z' in printer.toolhead.homed_axes and printer.print_stats.state in ["printing", "paused"] %}
	{% if printer.toolhead.position.z != core_vars.last_known_z %}
	_SAVE
	UPDATE_DELAYED_GCODE ID=_ACTIVE_Z_MONITOR DURATION=30
	{% else %}
	UPDATE_DELAYED_GCODE ID=_ACTIVE_Z_MONITOR DURATION=30
	{% endif %}
	
	{% else %}
	UPDATE_DELAYED_GCODE ID=_ACTIVE_Z_MONITOR DURATION=0
	{% endif %}

[gcode_macro _LOAD]
gcode = 
	{% set svv = printer.save_variables.variables %}
	SET_GCODE_VARIABLE MACRO=_CORE_VARS VARIABLE=last_known_z VALUE={svv.last_known_z}
	RESPOND TYPE=COMMAND MSG="Z Tracker: Last known Z height was {svv.last_known_z}"

[gcode_macro _SAVE]
gcode = 
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	{% set core_vars = printer["gcode_macro _CORE_VARS"] %}
	{% set driver_vars = printer["gcode_macro _DRIVER_VARS"] %}
	{% set svv = printer.save_variables.variables %}
	
	{% if driver_vars.z_lift_move == True %}
	SAVE_VARIABLE VARIABLE=last_known_z VALUE={("%.2f " % (core_vars.last_known_z + start_vars.pre_home_lift))}
	SET_GCODE_VARIABLE MACRO=_CORE_VARS VARIABLE=last_known_z VALUE={("%.2f " % (core_vars.last_known_z + start_vars.pre_home_lift))}
	SET_GCODE_VARIABLE MACRO=_DRIVER_VARS VARIABLE=z_lift_move VALUE=False
	M400
	
	{% elif core_vars.no_home_z_move == True %}
	SAVE_VARIABLE VARIABLE=last_known_z VALUE={("%.2f " % (core_vars.last_known_z))}
	SET_GCODE_VARIABLE MACRO=_CORE_VARS VARIABLE=no_home_z_move VALUE=False
	M400
	
	{% elif 'z' not in printer.toolhead.homed_axes %}
	
	{% else %}
	SET_GCODE_VARIABLE MACRO=_CORE_VARS VARIABLE=last_known_z VALUE={("%.2f " % (printer.toolhead.position.z))}
	SAVE_VARIABLE VARIABLE=last_known_z VALUE={("%.2f " % (printer.toolhead.position.z))}
	
	{% endif %}

[gcode_macro _Z_READER]
gcode = 
	{% set core_vars = printer["gcode_macro _CORE_VARS"] %}
	
	
	RESPOND TYPE=COMMAND MSG="Z Tracker: Current Z height saved as {core_vars.last_known_z}"

[gcode_macro Z_ASCENDER]
description = Raise the toolhead by the selected distance if the printer is homed or not! 100mm max per activation USE WITH CAUTION!
gcode = 
	
	{% set core_vars = printer["gcode_macro _CORE_VARS"] %}
	{% set svv = printer.save_variables.variables %}
	{% set height = params.HEIGHT|default(15)|int %}
	
	{% if 'z' not in printer.toolhead.homed_axes %}
	RESPOND TYPE=COMMAND MSG="WARNING AXES RESET FOR Z LIFT!!"
	RESPOND TYPE=COMMAND MSG="EXTREME CAUTION! As the printer is NOT homed already Z0 will be the current toolhead position for the duration of this move! If commanded the Z axis will be able to pass Z maximum resulting in printer damage!!"
	SET_KINEMATIC_POSITION Z=0
	SET_GCODE_VARIABLE MACRO=_CORE_VARS VARIABLE=no_home_z_move VALUE=True
	M400
	G90
	{% if height in range (0, 101) %}
	{% if core_vars.last_known_z <= (printer.toolhead.axis_maximum.z|int - height|int) - 20 %}
	G0 Z{height} F800
	M400
	RESPOND TYPE=COMMAND MSG="Move complete, now disabling axes"
	SET_GCODE_VARIABLE MACRO=_CORE_VARS VARIABLE=last_known_z VALUE={("%.2f " % (core_vars.last_known_z + height))}
	M400
	M84
	
	{% else %}
	{action_raise_error("Request denied, operation cancelled! As the printer is NOT homed estimated toolhead height is too great for requested move!")}
	{% endif %}
	
	{% else %}
	{action_raise_error("Request denied, operation cancelled! Lift height not in range. The maximum single commanded movement range is 0-100mm")}
	{% endif %}
	
	{% else %}
	G90
	{% if height in range (0, 101) %}
	{% if printer.toolhead.position.z <= (printer.toolhead.axis_maximum.z|int - height|int) - 20 %}
	G0 Z{(printer.toolhead.position.z + height)} F800
	M400
	M400
	_SAVE
	RESPOND TYPE=COMMAND MSG="Move complete!"
	
	{% else %}
	{action_raise_error("Request denied, operation cancelled! Actual toolhead height is too great for requested move!")}
	{% endif %}
	
	{% else %}
	{action_raise_error("Request denied, operation cancelled! Lift height not in range. The maximum single commanded movement range is 0-100mm")}
	{% endif %}
	{% endif %}

[gcode_macro _Z_PARK]
variable_z_park = 30
gcode = 
	{% set x_park = printer.toolhead.axis_maximum.x|float / 2 %}
	{% set y_park = printer.toolhead.axis_maximum.y|float / 2 %}
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	
	{% if start_vars.klicky_probe == True and printer.configfile.settings.stepper_z.endstop_pin == 'probe:z_virtual_endstop' %}
	Dock_Probe_Unlock
	{% endif %}
	
	{% if start_vars.use_custom_park == False %}
	G0 X{x_park} Y{y_park} Z{z_park} F10000
	
	{% else %}
	{% if start_vars.system_choose_z == True %}
	G0 X{start_vars.custom_park_x} Y{start_vars.custom_park_y} Z{z_park} F10000
	{% else %}
	{% if start_vars.custom_park_z|int <= 1|int or start_vars.custom_park_z|int >= (printer.toolhead.axis_maximum.z|int - start_vars.pre_home_lift|int) - 10 %}
	{action_raise_error("Custom Z parking height is to low or too high, change height in the demon user settings file to contiune")}
	{% else %}
	G0 X{start_vars.custom_park_x} Y{start_vars.custom_park_y} Z{start_vars.custom_park_z} F10000
	{% endif %}
	{% endif %}
	{% endif %}
	M400
	_SAVE

[gcode_macro _SET_Z_PARK]
gcode = 
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	{% set zp_vars = printer["gcode_macro _z_park"] %}
	
	{% if start_vars.system_choose_z == True %}
	{% if 'bltouch' in printer.configfile.config %}
	SET_GCODE_VARIABLE MACRO=_Z_PARK VARIABLE=z_park VALUE=25
	
	{% elif 'scanner' in printer %}
	SET_GCODE_VARIABLE MACRO=_Z_PARK VARIABLE=z_park VALUE=25
	
	{% elif 'smart_effctor' in printer %}
	SET_GCODE_VARIABLE MACRO=_Z_PARK VARIABLE=z_park VALUE=25
	
	{% elif ('mcu eddy' in printer.configfile.config) or ('probe_eddy_current btt_eddy' in printer) %}
	SET_GCODE_VARIABLE MACRO=_Z_PARK VARIABLE=z_park VALUE=25
	
	{% elif start_vars.klicky_probe == True or printer.configfile.settings.stepper_z.endstop_pin != 'probe:z_virtual_endstop' %}
	SET_GCODE_VARIABLE MACRO=_Z_PARK VARIABLE=z_park VALUE=50
	
	{% else %}
	SET_GCODE_VARIABLE MACRO=_Z_PARK VARIABLE=z_park VALUE=5
	{% endif %}
	
	{% else %}
	SET_GCODE_VARIABLE MACRO=_Z_PARK VARIABLE=z_park VALUE={start_vars.custom_park_z}
	{% endif %}

[gcode_macro _ADAPTIVE_MANUAL_LEVELLING]
gcode = 
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	
	{% if start_vars.use_manual_levelling == True and ('bed_screws' in printer.configfile.config) and ('screws_tilt_adjust' not in printer.configfile.config) %}
	SET_DISPLAY_TEXT MSG="Manual Gantry Levelling: Bed Screws"
	RESPOND TYPE=COMMAND MSG="Manual Gantry Levelling: Bed Screws"
	{% if start_vars.neopixel_led == True %}
	STATUS_LEVELING
	{% endif %}
	BED_SCREWS_ADJUST
	
	{% elif start_vars.use_manual_levelling == True and ('screws_tilt_adjust' in printer.configfile.config) %}
	SET_DISPLAY_TEXT MSG="Manual Gantry Levelling: Screws Tilt Calculate"
	RESPOND TYPE=COMMAND MSG="Manual Gantry Levelling: Screws Tilt Calculate"
	{% if start_vars.neopixel_led == True %}
	STATUS_LEVELING
	{% endif %}
	SCREWS_TILT_CALCULATE
	
	{% else %}
	{action_raise_error("This error is caused by your printer not having bed_screws or screws_tilt_adjust defined! Please define these sections in the printer.cfg file")}
	
	{% endif %}
	M117

[gcode_macro _ADAPTIVE_LEVELLING]
gcode = 
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	
	{% if start_vars.use_manual_levelling == True %}
	SET_DISPLAY_TEXT MSG="Manaul levelling in use, Print_Start auto levelling bypassed"
	RESPOND TYPE=COMMAND MSG="Manaul levelling in use, Print_Start auto levelling bypassed"
	
	{% else %}
	{% if printer.configfile.settings.printer.kinematics == 'corexy' and ('z_tilt' in printer.configfile.config) %}
	{% if ('quad_gantry_level' not in printer.configfile.config) %}
	SET_DISPLAY_TEXT MSG="Gantry Levelling CoreXY Z Tilt"
	RESPOND TYPE=COMMAND MSG="Gantry Levelling CoreXY Z Tilt"
	{% if start_vars.neopixel_led == True %}
	STATUS_LEVELING
	{% endif %}
	Z_TILT_ADJUST
	M400
	{% endif %}
	
	{% elif printer.configfile.settings.printer.kinematics == 'corexy' and ('quad_gantry_level' in printer.configfile.config) %}
	SET_DISPLAY_TEXT MSG="Gantry Levelling"
	RESPOND TYPE=COMMAND MSG="Gantry Levelling"
	{% if start_vars.neopixel_led == True %}
	STATUS_LEVELING
	{% endif %}
	QUAD_GANTRY_LEVEL
	M400
	
	{% elif printer.configfile.settings.printer.kinematics == 'cartesian' and ('z_tilt' in printer.configfile.config) %}
	SET_DISPLAY_TEXT MSG="Gantry Levelling"
	RESPOND TYPE=COMMAND MSG="Gantry Levelling"
	{% if start_vars.neopixel_led == True %}
	STATUS_LEVELING
	{% endif %}
	Z_TILT_ADJUST
	M400
	
	{% elif printer.configfile.settings.printer.kinematics == 'cartesian' and ('z_tilt' not in printer.configfile.config) %}
	RESPOND TYPE=COMMAND MSG="Levelling system not available, skipping Gantry Levelling"
	
	{% else %}
	{action_raise_error("This error is caused by your printer not supporting this feature! Please enable Manual Levelling in the demon_user_settings.cfg file")}
	
	{% endif %}
	{% endif %}
	M117

[gcode_macro _DEMON_PAUSE]
variable_offset_reset = False
gcode = 
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	{% set ceal = printer["gcode_macro CUSTOM_EXPANSION_ACTIVE_LIST"] %}
	
	{% if printer.toolhead.position.z|float < 50 %}
	G0 Z50 F3600
	{% endif %}
	
	{% if start_vars.kill_fan_on_pause == True %}
	RESPOND TYPE=COMMAND MSG="Parts fan stopping for pause duration"
	SET_GCODE_VARIABLE MACRO=_CORE_VARS VARIABLE=fan_speed VALUE={("%.2f " % (printer["fan"].speed|float))}
	M107
	{% endif %}
	
	{% if ceal.ceal_master_enable == True %}
	{% if ceal.pause == True %}
	_CUSTOM_PAUSE {rawparams}
	{% endif %}
	{% endif %}
	
	_SAVE

[gcode_macro _DEMON_CANCEL]
variable_offset_reset = False
gcode = 
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	{% set core_vars = printer["gcode_macro _CORE_VARS"] %}
	{% set ceal = printer["gcode_macro CUSTOM_EXPANSION_ACTIVE_LIST"] %}
	
	{% if printer.print_stats.state != paused and printer.toolhead.position.z|float < 50 %}
	G0 Z50 F3600
	{% endif %}
	
	_OFFSET_RESET_CONTROL
	
	BED_MESH_CLEAR
	M220 S100
	M221 S100
	SET_VELOCITY_LIMIT ACCEL={printer.configfile.config.printer.max_accel}
	SET_VELOCITY_LIMIT VELOCITY={printer.configfile.config.printer.max_velocity}
	
	{% if start_vars.encoder_runout_sensor == True %}
	SET_FILAMENT_SENSOR SENSOR=encoder_sensor ENABLE=0
	{% endif %}
	
	{% if ceal.ceal_master_enable == True %}
	{% if ceal.cancel == True %}
	_CUSTOM_CANCEL {rawparams}
	{% endif %}
	{% endif %}
	
	_SAVE
	{% if start_vars.z_tracker_reduced_monitoring == False %}
	UPDATE_DELAYED_GCODE ID=_ACTIVE_Z_MONITOR DURATION=1
	{% endif %}

[gcode_macro _DEMON_RESUME]
gcode = 
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	{% set core_vars = printer["gcode_macro _CORE_VARS"] %}
	{% set resume = printer["gcode_macro RESUME"] %}
	{% set ceal = printer["gcode_macro CUSTOM_EXPANSION_ACTIVE_LIST"] %}
	
	{% if start_vars.chamber_heater == True %}
	UPDATE_DELAYED_GCODE ID=_CHAMBER_HEAT_CONTROL DURATION=1
	RESPOND TYPE=COMMAND MSG="Chamber Heater Monitor Active"
	{% endif %}
	
	{% if start_vars.bed_fans == True %}
	UPDATE_DELAYED_GCODE ID=_BED_FAN_MONITOR DURATION=1
	RESPOND TYPE=COMMAND MSG="Bed Fans Monitor Active"
	{% endif %}
	
	{% if start_vars.nevermore == True and resume.idle_state == True %}
	{% if core_vars.nm_fan_speed != 0 %}
	SET_FAN_SPEED FAN=Nevermore SPEED={core_vars.nm_fan_speed|float}
	RESPOND TYPE=COMMAND MSG="Restoring Nevermore fan speed"
	M400
	SET_GCODE_VARIABLE MACRO=_CORE_VARS VARIABLE=nm_fan_speed VALUE=0
	{% endif %}
	{% endif %}
	
	SET_DISPLAY_TEXT MSG="Resuming print!"
	RESPOND TYPE=COMMAND MSG="Resuming print!"
	
	{% if start_vars.kill_fan_on_pause == True %}
	M106 S{("%.0f " % (core_vars.fan_speed|float * 255))}
	RESPOND TYPE=COMMAND MSG="Restoring parts fan speed"
	{% endif %}
	
	{% if ceal.ceal_master_enable == True %}
	{% if ceal.resume == True %}
	_CUSTOM_RESUME {rawparams}
	{% endif %}
	{% endif %}

[gcode_macro _DEMON_IDLE_TIMEOUT]
gcode = 
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	
	{% if start_vars.nevermore == True and printer["fan_generic Nevermore"].speed != 0 %}
	SET_GCODE_VARIABLE MACRO=_CORE_VARS VARIABLE=nm_fan_speed VALUE={printer["fan_generic Nevermore"].speed|float}
	SET_FAN_SPEED FAN=Nevermore SPEED=0
	{% endif %}
	
	{% if printer.print_stats.state == "paused" %}
	{% if start_vars.infinite_pause == True %}
	SET_GCODE_VARIABLE MACRO=RESUME VARIABLE=idle_state VALUE=True
	M107
	SET_HEATER_TEMPERATURE HEATER=extruder TARGET=0
	SET_DISPLAY_TEXT MSG="Idle timeout: Infinite pause running, nozzle powered down, auto re-heat enabled. Waiting for user..."
	RESPOND TYPE=COMMAND MSG="Idle timeout: Infinite pause running, nozzle powered down, auto re-heat enabled. Waiting for user..."
	_SAVE
	
	{% else %}
	SET_DISPLAY_TEXT MSG="PRINT CANCELLED! Pause timed out! Please enable variable_infinite_pause in demon_user_settings.cfg to avoid this & restart your print"
	RESPOND TYPE=COMMAND MSG="PRINT CANCELLED! Pause timed out! Please enable variable_infinite_pause in demon_user_settings.cfg to avoid this & restart your print"
	SET_GCODE_VARIABLE MACRO=_CORE_VARS VARIABLE=nm_fan_speed VALUE=0
	CANCEL_PRINT
	M84
	{% if start_vars.timeout_power == True and start_vars.shutdown_relay == True %}
	_GOODNIGHT
	{% endif %}
	{% endif %}
	
	{% else %}
	SET_DISPLAY_TEXT MSG="Idle Timeout"
	RESPOND TYPE=COMMAND MSG="Idle Timeout"
	TURN_OFF_HEATERS
	M84
	{% if start_vars.timeout_power == True and start_vars.shutdown_relay == True %}
	_GOODNIGHT
	{% endif %}
	
	{% endif %}

[gcode_macro _FIL_CHANGE_PARK]
gcode = 
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	
	SET_DISPLAY_TEXT MSG="Moving to filament change position, use load/unload macros when ready!"
	RESPOND TYPE=COMMAND MSG="Moving to filament change position, use load/unload macros when ready!"
	PAUSE X={start_vars.filament_change_park_x} Y={start_vars.filament_change_park_y} Z_MIN={start_vars.filament_change_park_min_z} RESTORE=0
	_SAVE

[gcode_macro _MAX_EXTRUDE_CHECK]
gcode = 
	{% set max_velocity = printer.configfile.settings['extruder'].max_extrude_only_velocity * 60 %}
	
	{% if max_velocity == 7982.432411074328 %}
	{action_raise_error("Please set a feedrate mm per second max_extrude_only_velocity in your printer.cfg [extruder] section. e.g. max_extrude_only_velocity: 12")}
	{% endif %}
	
	{% if max_velocity > 1260 %}
	{action_raise_error("WARNING! Your printer's max_extrude_only_velocity setting is too high! The operation has been cancelled to prevent damage to your extruder! Reset to a feedrate value below 20mm/s in your printer.cfg [extruder] section")}
	{% endif %}

[gcode_macro _RUNOUT_SENSOR_CHECK]
gcode = 
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	
	{% if start_vars.runout_sensor == True %}
	{% if printer['filament_switch_sensor filament_sensor'].enabled == 1 %}
	{% if not printer["filament_switch_sensor filament_sensor"].filament_detected %}
	{action_raise_error("This error is caused by no being filament loaded! Please load filament & restart the print!")}
	{% else %}
	RESPOND TYPE=COMMAND MSG="Runout sensor: Enabled, filament check passed"
	{% endif %}
	
	{% elif printer['filament_switch_sensor filament_sensor'].enabled != 1 %}
	RESPOND TYPE=COMMAND MSG="Runout sensor: Disabled, filament check skipped"
	{% endif %}
	{% endif %}

[gcode_macro _ENCODER_FEED_CHECK_PREP]
gcode = 
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	
	{% if start_vars.encoder_runout_sensor == True %}
	{% if printer['filament_motion_sensor encoder_sensor'].enabled != 1 %}
	SET_FILAMENT_SENSOR SENSOR=encoder_sensor ENABLE=1
	{% endif %}
	{% endif %}

[gcode_macro _ENCODER_FEED_CHECK]
gcode = 
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	
	{% if start_vars.encoder_runout_sensor == True %}
	{% if not printer["filament_motion_sensor encoder_sensor"].filament_detected %}
	{% if printer.print_stats.state == "paused" %}
	RESPOND TYPE=error MSG="Encoder filament sensor triggered! This error is caused by the filament not being taken up by the extruder, or the nozzle is clogged! Please check filament state & try again!"
	{% else %}
	{action_raise_error("Encoder filament sensor triggered! This error is caused by the filament not being taken up by the extruder, or the nozzle is clogged! Please check filament state & try again!")}
	{% endif %}
	{% endif %}
	
	UPDATE_DELAYED_GCODE ID=_ENCODER_RUNOUT_CONTROL DURATION=5
	{% endif %}

[delayed_gcode _ENCODER_RUNOUT_CONTROL]
gcode = 
	
	{% if printer.print_stats.state not in ['printing', 'paused'] %}
	SET_FILAMENT_SENSOR SENSOR=encoder_sensor ENABLE=0
	UPDATE_DELAYED_GCODE ID=_ENCODER_RUNOUT_CONTROL DURATION=0
	
	{% elif printer.print_stats.state in ['printing', 'paused'] %}
	{% if printer.print_stats.info.current_layer in range(0, 2) %}
	SET_FILAMENT_SENSOR SENSOR=encoder_sensor ENABLE=0
	UPDATE_DELAYED_GCODE ID=_ENCODER_RUNOUT_CONTROL DURATION=10
	{% else %}
	SET_FILAMENT_SENSOR SENSOR=encoder_sensor ENABLE=1
	UPDATE_DELAYED_GCODE ID=_ENCODER_RUNOUT_CONTROL DURATION=0
	RESPOND TYPE=COMMAND MSG="Layer 1 complete, encoder runout sensor enabled"
	{% endif %}
	{% endif %}

[gcode_macro _RESET_FILE_STATE]
gcode = 
	
	{% if printer.print_stats.state not in ["printing", "paused", "busy"] %}
	SDCARD_RESET_FILE
	SET_DISPLAY_TEXT MSG="Printer State reset to Standby"
	G4 P5000
	M117
	{% else %}
	SET_DISPLAY_TEXT MSG="File reset denied, printer is busy"
	RESPOND TYPE=error MSG="File reset denied, printer is busy"
	{% endif %}

[gcode_macro PRINTER_STATUS]
description = Checks the current status of your system!
gcode = 
	{% if "xyz" != printer.toolhead.homed_axes%}
	RESPOND TYPE=COMMAND MSG="Homed Axes: None"
	{% else %}
	RESPOND TYPE=COMMAND MSG="Homed Axes: {printer.toolhead.homed_axes}"
	{% endif %}
	
	{% if printer.print_stats.state == "standby" and printer.idle_timeout.state == "Printing" %}
	RESPOND TYPE=COMMAND MSG="Printer timeout state: Busy"
	{% else %}
	RESPOND TYPE=COMMAND MSG="Printer timeout state: {printer.idle_timeout.state}"
	{% endif %}
	
	RESPOND TYPE=COMMAND MSG="Printer status: {printer.print_stats.state}"
	RESPOND TYPE=COMMAND MSG="Virtual SDcard is active: {printer.virtual_sdcard.is_active}"
	
	{% if printer.print_stats.state in ["printing", "paused"] %}
	RESPOND TYPE=COMMAND MSG="Virtual SDcard print progess in percent: {printer.virtual_sdcard.progress}"
	RESPOND TYPE=COMMAND MSG="File: {printer.print_stats.filename}"
	RESPOND TYPE=COMMAND MSG="Info: {printer.print_stats.info}"
	RESPOND TYPE=COMMAND MSG="{printer.print_stats.message}"
	{% endif %}

[gcode_macro SYSTEM_SENSORS]
description = Shows you the system names of available sensors on your printer
gcode = 
	{ action_respond_info(printer.heaters.available_heaters | join(' | ')) }
	{ action_respond_info(printer.heaters.available_sensors | join(' | ')) }

[delayed_gcode _welcome]
initial_duration = 2
gcode = 
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	{% set svv = printer.save_variables.variables %}
	
	{% if svv.using_shell == True %}
	_DISK_SPACE_CHECK
	{% else %}
	RESPOND TYPE=command MSG="Shell script extension not in use. Disk_Space_Check disbaled."
	{% endif %}
	
	_DEMON_VERSION
	_LOAD
	{% if printer.print_stats.state not in ['printing', 'paused'] %}
	SET_DISPLAY_TEXT MSG="{start_vars.screen_msg}"
	RESPOND TYPE=COMMAND MSG="{start_vars.console_msg}"
	{% endif %}

[delayed_gcode _USER_FILES_CHECK]
initial_duration = 10
gcode = 
	
	{% if not printer["gcode_macro _START_VARIABLES"] %}
	RESPOND TYPE=error MSG="WARNING: The demon_user_settings cfg file is NOT included in the system! Please include this file & set it up BEFORE you try to print!"
	SET_DISPLAY_TEXT MSG="WARNING: The demon_user_settings cfg file is NOT included in the system! Please include this file & set it up BEFORE you try to print!"
	
	{% elif not printer["gcode_macro _CLEAN_VARIABLES"] %}
	RESPOND TYPE=error MSG="WARNING: The demon_user_settings_cleaner_variables cfg file is NOT included in the system! Please include this file & set it up BEFORE you try to print!"
	SET_DISPLAY_TEXT MSG="WARNING: The demon_user_settings_cleaner_variables cfg file is NOT included in the system! Please include this file & set it up BEFORE you try to print!"
	
	{% elif not printer["gcode_macro CUSTOM_EXPANSION_ACTIVE_LIST"] %}
	RESPOND TYPE=error MSG="WARNING: The demon_custom_expansion cfg file is NOT included in the system! Please include this file & set it up BEFORE you try to print!"
	SET_DISPLAY_TEXT MSG="WARNING: The demon_custom_expansion cfg file is NOT included in the system! Please include this file & set it up BEFORE you try to print!"
	{% endif %}
	
	{% if 'force_move' not in printer.configfile.config %}
	RESPOND TYPE=error MSG="WARNING: The force_move printer.cfg section is missing. Please make sure it's correctly added to your printer.cfg!"
	SET_DISPLAY_TEXT MSG="WARNING: The force_move printer.cfg section is missing. Please make sure it's correctly added to your printer.cfg!"
	{% endif %}
	
	{% if 'respond' not in printer.configfile.config %}
	RESPOND TYPE=error MSG="WARNING: The respond printer.cfg section is missing. Please make sure it's correctly added to your printer.cfg!"
	SET_DISPLAY_TEXT MSG="WARNING: The respond printer.cfg section is missing. Please make sure it's correctly added to your printer.cfg!"
	{% endif %}
	
	{% if 'save_variables' not in printer.configfile.config %}
	RESPOND TYPE=error MSG="WARNING: The save_variables printer.cfg section is missing. Please make sure it's correctly added to your printer.cfg!"
	SET_DISPLAY_TEXT MSG="WARNING: The save_variables printer.cfg section is missing. Please make sure it's correctly added to your printer.cfg!"
	{% endif %}
	
	{% if 'exclude_object' not in printer.configfile.config %}
	RESPOND TYPE=error MSG="WARNING: The exclude_object printer.cfg section is missing. Please make sure it's correctly added to your printer.cfg!"
	SET_DISPLAY_TEXT MSG="WARNING: The exclude_object printer.cfg section is missing. Please make sure it's correctly added to your printer.cfg!"
	{% endif %}

[gcode_macro _DEMON_VERSION_MISMATCH]
gcode = 
	{action_raise_error("This error is caused by Demon_version mismatch please check and update your Demon Essentials Macro files!")}

[gcode_macro _DEMON_VERSION]
variable_demon_user_settings_version = "2.9.5"
variable_demon_clnvars_version = "1.1.0"
variable_demon_ceal_version = "1.0.1"
variable_demon_demon_vars_version = "1.0.0"
variable_demon_clean_load_version = "1.9.1"
variable_demon_setup_hlpr_version = "1.5.3"
variable_demon_z_cal_version = "1.6.1"
variable_demon_prpr_menu = "1.2.0"
variable_demon_mesh_bldr_version = "1.5.1"
variable_demon_apa_version = "1.2.0"
variable_demon_bed_fans_version = "1.3.0"
variable_demon_core_version = "1.4.0"
variable_demon_prnt_strt_version = "2.9.5"
variable_demon_chmbr_htr_version = "1.1.1"
variable_demon_aes_version = "1.1.0"
variable_demon_home_ctrl_version = "1.4.0"
gcode = 
	{% set dvv = printer["gcode_macro _DEMON_VERSION_VARS"] %}
	{% set svv = printer.save_variables.variables %}
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	{% set clean_load_ver = printer["gcode_macro _CLEAN_LOAD_VERSION"] %}
	{% set setup_helpers_ver = printer["gcode_macro _SETUP_HELPERS_VERSION"] %}
	{% set z_cal_ver = printer["gcode_macro _Z_CALIBRATION_VERSION"] %}
	{% set prepare_menu_ver = printer["gcode_macro _PREPARE_MENU_VERSION"] %}
	{% set mesh_builder_ver = printer["gcode_macro _MESH_BUILDER_VERSION"] %}
	{% set pa_vars = printer["gcode_macro _PA_VERSION"] %}
	{% set bed_fans_ver = printer["gcode_macro _BED_FANS_VERSION"] %}
	{% set core_ver = printer["gcode_macro _CORE_VERSION"] %}
	{% set print_start_ver = printer["gcode_macro _PRINT_START_VERSION"] %}
	{% set chamber_heater_ver = printer["gcode_macro _CHAMBER_HEATER_VERSION"] %}
	{% set aes_ver = printer["gcode_macro _AES_VERSION"] %}
	{% set home_ver = printer["gcode_macro _HOME_VERSION"] %}
	{% set clean_vars_ver = printer["gcode_macro _CLEAN_VARS_VER"] %}
	{% set ceal_ver = printer["gcode_macro _CEAL_VERSION"] %}
	
	{% if start_vars.demon_version|string != demon_user_settings_version|string %}
	{% if svv.using_shell == True %}
	{% if printer.print_stats.state not in ['printing', 'paused', 'busy'] %}
	_USER_SETTINGS_FILE_PROMPT
	{% else %}
	RESPOND TYPE=error MSG="DEMON_USER_SETTINGS VERSION_MISMATCH"
	_DEMON_VERSION_MISMATCH
	{% endif %}
	{% else %}
	RESPOND TYPE=error MSG="DEMON_USER_SETTINGS VERSION_MISMATCH"
	_DEMON_VERSION_MISMATCH
	{% endif %}
	
	{% elif clean_vars_ver.demon_clean_vars_ver|string != demon_clnvars_version|string %}
	{% if svv.using_shell == True %}
	{% if printer.print_stats.state not in ['printing', 'paused', 'busy'] %}
	_USER_CLEANER_FILE_PROMPT
	{% else %}
	RESPOND TYPE=error MSG="DEMON_USER_SETTINGS_CLEANER_VARIABLES_VERSION_MISMATCH"
	_DEMON_VERSION_MISMATCH
	{% endif %}
	{% else %}
	RESPOND TYPE=error MSG="DEMON_USER_SETTINGS_CLEANER_VARIABLES_VERSION_MISMATCH"
	_DEMON_VERSION_MISMATCH
	{% endif %}
	
	{% elif ceal_ver.demon_ceal|string != demon_ceal_version|string %}
	{% if svv.using_shell == True %}
	{% if printer.print_stats.state not in ['printing', 'paused', 'busy'] %}
	_USER_EXPANSION_FILE_PROMPT
	{% else %}
	RESPOND TYPE=error MSG="DEMON_USER_SETTINGS_CEAL_VERSION_MISMATCH"
	_DEMON_VERSION_MISMATCH
	{% endif %}
	{% else %}
	RESPOND TYPE=error MSG="DEMON_USER_SETTINGS_CEAL_VERSION_MISMATCH"
	_DEMON_VERSION_MISMATCH
	{% endif %}
	
	{% elif svv.version_dvars|string != demon_demon_vars_version|string %}
	{% if svv.using_shell == True %}
	{% if printer.print_stats.state not in ['printing', 'paused', 'busy'] %}
	_DEMON_VARS_PROMPT
	{% else %}
	RESPOND TYPE=error MSG="DEMON_VARS_VERSION_MISMATCH"
	_DEMON_VERSION_MISMATCH
	{% endif %}
	{% else %}
	RESPOND TYPE=error MSG="DEMON_VARS_VERSION_MISMATCH"
	_DEMON_VERSION_MISMATCH
	{% endif %}
	
	{% elif clean_load_ver.demon_clean_load|string != demon_clean_load_version|string %}
	RESPOND TYPE=error MSG="DEMON_CLEAN_LOAD_VERSION_MISMATCH"
	_DEMON_VERSION_MISMATCH
	
	{% elif setup_helpers_ver.demon_setup|string != demon_setup_hlpr_version|string %}
	RESPOND TYPE=error MSG="DEMON_SETUP_HELPERS_VERSION_MISMATCH"
	_DEMON_VERSION_MISMATCH
	
	{% elif z_cal_ver.demon_z_cal|string != demon_z_cal_version|string %}
	RESPOND TYPE=error MSG="DEMON_ZCAL_VERSION_MISMATCH"
	_DEMON_VERSION_MISMATCH
	
	{% elif prepare_menu_ver.demon_prepare_menu|string != demon_prpr_menu|string %}
	RESPOND TYPE=error MSG="DEMON_PREPARE_MENU_VERSION_MISMATCH"
	_DEMON_VERSION_MISMATCH
	
	{% elif mesh_builder_ver.demon_mesh_builder|string != demon_mesh_bldr_version|string %}
	RESPOND TYPE=error MSG="DEMON_MESH_BUILDER_VERSION_MISMATCH"
	_DEMON_VERSION_MISMATCH
	
	{% elif pa_vars.demon_apa|string != demon_apa_version|string %}
	RESPOND TYPE=error MSG="DEMON_PA_VERSION_MISMATCH"
	_DEMON_VERSION_MISMATCH
	
	{% elif bed_fans_ver.demon_bed_fans|string != demon_bed_fans_version|string %}
	RESPOND TYPE=error MSG="DEMON_BED_FANS_VERSION_MISMATCH"
	_DEMON_VERSION_MISMATCH
	
	{% elif core_ver.demon_core_ver|string != demon_core_version|string %}
	RESPOND TYPE=error MSG="DEMON_CORE_VERSION_MISMATCH"
	_DEMON_VERSION_MISMATCH
	
	{% elif print_start_ver.demon_start_ver|string != demon_prnt_strt_version|string %}
	RESPOND TYPE=error MSG="DEMON_PRINT_START_VERSION_MISMATCH"
	_DEMON_VERSION_MISMATCH
	
	{% elif chamber_heater_ver.demon_chamber_heater_ver|string != demon_chmbr_htr_version|string %}
	RESPOND TYPE=error MSG="DEMON_CHAMBER_HEATER_VERSION_MISMATCH"
	_DEMON_VERSION_MISMATCH
	
	{% elif aes_ver.demon_aes_ver|string != demon_aes_version|string %}
	RESPOND TYPE=error MSG="DEMON_AES_VERSION_MISMATCH"
	_DEMON_VERSION_MISMATCH
	
	{% elif home_ver.demon_home_ver|string != demon_home_ctrl_version|string %}
	RESPOND TYPE=error MSG="DEMON_HOME_VERSION_MISMATCH"
	_DEMON_VERSION_MISMATCH
	
	{% else %}
	RESPOND TYPE=COMMAND MSG="PRINTER CHECK: PASSED"
	
	{% endif %}

[gcode_macro _CORE_VERSION]
variable_demon_core_ver = "1.4.0"
gcode = 

[homing_override]
axes = xyz
gcode = 
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	{% set driver_vars = printer["gcode_macro _DRIVER_VARS"] %}
	{% set home_all = 'X' not in params and 'Y' not in params and 'Z' not in params %}
	
	{% if start_vars.klicky_probe == True %}
	{ action_raise_error("You appear to be using Klicky_probe but homing_override is defined in your demon_homing_control.cfg. Please comment out the entire [homing_override] macro to continue") }
	
	{% else %}
	
	_HOME_POWER_SAFETY
	RESPOND TYPE=COMMAND MSG="Homing requested"
	
	{% if driver_vars.definer_executed == False %}
	_DRIVER_DEFINER
	{% else %}
	{% if driver_vars.readback == True %}
	RESPOND TYPE=COMMAND MSG="XY Drivers previously defined"
	{% endif %}
	{% endif %}
	
	{% if start_vars.neopixel_led == True %}
	STATUS_HOMING
	{% endif %}
	
	_SET_Z_PARK
	
	{% if 'z' not in printer.toolhead.homed_axes %}
	{% if 'x' not in printer.toolhead.homed_axes or 'y' not in printer.toolhead.homed_axes %}
	{% if 'Z' in params %}
	{ action_raise_error("Request denied, operation cancelled! Home X & Y axes first before requesting homing Z") }
	
	{% else %}
	
	{% if 'x' in printer.toolhead.homed_axes or 'y' in printer.toolhead.homed_axes %}
	
	{% else %}
	
	
	_Z_LIFT
	
	{% endif %}
	{% endif %}
	{% endif %}
	
	{% else %}
	
	{% if printer.toolhead.position.z|float < 5 %}
	RESPOND TYPE=COMMAND MSG="Z axis <5mm. Raising for safe clearance prior to homing"
	_Z_LIFT
	{% endif %}
	{% endif %}
	
	{% if start_vars.home_y_first == True %}
	{% if home_all or 'Y' in params %}
	_HOME_Y
	{% endif %}
	
	{% if home_all or 'X' in params %}
	_HOME_X
	{% endif %}
	
	{% else %}
	{% if home_all or 'X' in params %}
	_HOME_X
	{% endif %}
	
	{% if home_all or 'Y' in params %}
	_HOME_Y
	{% endif %}
	{% endif %}
	
	{% if home_all or 'Z' in params %}
	
	{% if start_vars.aes_system == True %}
	SET_GCODE_VARIABLE MACRO=_AES_SYS VARIABLE=e_stop_armed VALUE=True
	_AES_READ
	{% endif %}
	
	{% if printer.configfile.settings.stepper_z.endstop_pin == 'probe:z_virtual_endstop' %}
	G90
	{% if start_vars.set_probe_point_default == True %}
	G0 X{printer.toolhead.axis_maximum.x|float / 2} Y{printer.toolhead.axis_maximum.y|float / 2} F{start_vars.homing_movement_travel_speed|int * 60}
	{% else %}
	G0 X{start_vars.set_probe_custom_x|float} Y{start_vars.set_probe_custom_y|float} F{start_vars.homing_movement_travel_speed|int * 60}
	{% endif %}
	
	{% else %}
	G90
	G0 X{start_vars.z_endstop_loaction_x|float} Y{start_vars.z_endstop_loaction_y|float} F{start_vars.homing_movement_travel_speed|int * 60}
	{% endif %}
	
	G28 Z
	M400
	
	{% if printer.configfile.settings.stepper_z.endstop_pin == 'probe:z_virtual_endstop' %}
	G0 Z10 F3600
	{% if 'mcu eddy' in printer.configfile.config or 'probe_eddy_current btt_eddy' in printer %}
	PROBE
	SET_Z_FROM_PROBE
	_Z_PARK
	
	{% else %}
	_Z_PARK
	{% endif %}
	
	{% else %}
	{% if start_vars.post_z_switch_backoff == True %}
	G0 Z{start_vars.post_z_switch_backoff_height|int} F{start_vars.z_lift_speed|int * 60}
	G91
	G0 Y-{start_vars.post_z_switch_backoff_y_dist|int} F{start_vars.homing_movement_travel_speed|int * 60}
	G90
	{% endif %}
	{% endif %}
	
	{% if start_vars.aes_system == True %}
	SET_GCODE_VARIABLE MACRO=_AES_SYS VARIABLE=e_stop_armed VALUE=False
	_AES_READ
	{% endif %}
	
	M400
	_SAVE
	{% if start_vars.z_tracker_reduced_monitoring == False %}
	UPDATE_DELAYED_GCODE ID=_ACTIVE_Z_MONITOR DURATION=1
	{% endif %}
	{% endif %}
	
	
	{% if start_vars.neopixel_led == True %}
	STATUS_READY
	{% endif %}
	
	M117
	
	{% endif %}
	G90

[gcode_macro _HOME_X]
gcode = 
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	{% set driver_vars = printer["gcode_macro _DRIVER_VARS"] %}
	
	{% if driver_vars.definer_executed == False %}
	{action_raise_error("Home_X cancelled. You appear to not have run the _DRIVER_DEFINER macro. This happens when you comment out the demon_homing_control_vx.x.cfg [homing_override] macro, example when using Klicky Probe. Please add _DRIVER_DEFINER to your currently active [homing_override] macro to continue")}
	
	{% elif driver_vars.definer_executed == True %}
	{% if driver_vars.tmc_found_x == True %}
	
	_HOME_POWER_SAFETY
	
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={start_vars.home_power|float}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={start_vars.home_power|float}
	
	G28 X
	G91
	
	{% if printer.configfile.settings.stepper_x.homing_positive_dir == False %}
	G0 X{start_vars.axis_backoff_distance|int} F{start_vars.axis_backoff_speed|int * 60}
	{% else %}
	G0 X-{start_vars.axis_backoff_distance|int} F{start_vars.axis_backoff_speed|int * 60}
	{% endif %}
	
	G4 P{start_vars.axis_register_clear_wait|float * 1000}
	
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={driver_vars.run_x|float}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={driver_vars.run_y|float}
	
	{% else %}
	
	G28 X
	G91
	
	{% if printer.configfile.settings.stepper_x.homing_positive_dir == False %}
	G0 X{start_vars.axis_backoff_distance|int} F{start_vars.axis_backoff_speed|int * 60}
	{% else %}
	G0 X-{start_vars.axis_backoff_distance|int} F{start_vars.axis_backoff_speed|int * 60}
	{% endif %}
	
	{% endif %}
	G90
	{% endif %}

[gcode_macro _HOME_Y]
gcode = 
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	{% set driver_vars = printer["gcode_macro _DRIVER_VARS"] %}
	
	{% if driver_vars.definer_executed == False %}
	{action_raise_error("Home_Y cancelled. You appear to not have run the _DRIVER_DEFINER macro. This happens when you comment out the demon_homing_control_vx.x.cfg [homing_override] macro, example when using Klicky Probe. Please add _DRIVER_DEFINER to your currently active [homing_override] macro to continue")}
	
	{% elif driver_vars.definer_executed == True %}
	{% if driver_vars.tmc_found_y == True %}
	
	_HOME_POWER_SAFETY
	
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={start_vars.home_power|float}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={start_vars.home_power|float}
	
	G28 Y
	G91
	
	{% if printer.configfile.settings.stepper_y.homing_positive_dir == False %}
	G0 Y{start_vars.axis_backoff_distance|int} F{start_vars.axis_backoff_speed|int * 60}
	{% else %}
	G0 Y-{start_vars.axis_backoff_distance|int} F{start_vars.axis_backoff_speed|int * 60}
	{% endif %}
	
	G4 P{start_vars.axis_register_clear_wait|float * 1000}
	
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={driver_vars.run_x|float}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={driver_vars.run_y|float}
	
	{% else %}
	
	G28 Y
	G91
	
	{% if printer.configfile.settings.stepper_y.homing_positive_dir == False %}
	G0 Y{start_vars.axis_backoff_distance|int} F{start_vars.axis_backoff_speed|int * 60}
	{% else %}
	G0 Y-{start_vars.axis_backoff_distance|int} F{start_vars.axis_backoff_speed|int * 60}
	{% endif %}
	
	{% endif %}
	G90
	{% endif %}

[gcode_macro _DRIVER_DEFINER]
gcode = 
	{% set driver_vars = printer["gcode_macro _DRIVER_VARS"] %}
	{% set cf = printer.configfile.config %}
	
	SET_GCODE_VARIABLE MACRO=_DRIVER_VARS VARIABLE=definer_executed VALUE=True
	
	{% if 'tmc2209 stepper_x' not in cf and 'tmc5160 stepper_x' not in cf and 'tmc2208 stepper_x' not in cf and 'tmc2226 stepper_x' not in cf and 'tmc2225 stepper_x'
	not in cf and 'tmc2130 stepper_x' not in cf and 'tmc2240 stepper_x' not in cf and 'tmc2660 stepper_x' not in cf %}
	RESPOND TYPE=COMMAND MSG="DRIVER_DEFINER: No supported UART connected TMC X axis driver detected"
	SET_GCODE_VARIABLE MACRO=_DRIVER_VARS VARIABLE=tmc_found_x VALUE=False
	{% endif %}
	
	{% if 'tmc2209 stepper_y' not in cf and 'tmc5160 stepper_y' not in cf and 'tmc2208 stepper_y' not in cf and 'tmc2226 stepper_y' not in cf and 'tmc2225 stepper_y'
	not in cf and 'tmc2130 stepper_y' not in cf and 'tmc2240 stepper_y' not in cf and 'tmc2660 stepper_y' not in cf %}
	RESPOND TYPE=COMMAND MSG="DRIVER_DEFINER: No supported UART connected TMC Y axis driver detected"
	SET_GCODE_VARIABLE MACRO=_DRIVER_VARS VARIABLE=tmc_found_y VALUE=False
	{% endif %}
	
	{% if 'tmc2209 stepper_x' in printer.configfile.config %}
	SET_GCODE_VARIABLE MACRO=_DRIVER_VARS VARIABLE=run_x VALUE={printer.configfile.config['tmc2209 stepper_x'].run_current|float}
	{% if driver_vars.readback == True %}
	RESPOND TYPE=COMMAND MSG="Defined TMC2209 driver X axis"
	{% endif %}
	
	{% elif 'tmc5160 stepper_x' in printer.configfile.config %}
	SET_GCODE_VARIABLE MACRO=_DRIVER_VARS VARIABLE=run_x VALUE={printer.configfile.config['tmc5160 stepper_x'].run_current|float}
	{% if driver_vars.readback == True %}
	RESPOND TYPE=COMMAND MSG="Defined TMC5160 driver X axis"
	{% endif %}
	
	{% elif 'tmc2208 stepper_x' in printer.configfile.config %}
	SET_GCODE_VARIABLE MACRO=_DRIVER_VARS VARIABLE=run_x VALUE={printer.configfile.config['tmc2208 stepper_x'].run_current|float}
	{% if driver_vars.readback == True %}
	RESPOND TYPE=COMMAND MSG="Defined TMC2208 driver X axis"
	{% endif %}
	
	{% elif 'tmc2226 stepper_x' in printer.configfile.config %}
	SET_GCODE_VARIABLE MACRO=_DRIVER_VARS VARIABLE=run_x VALUE={printer.configfile.config['tmc2226 stepper_x'].run_current|float}
	{% if driver_vars.readback == True %}
	RESPOND TYPE=COMMAND MSG="Defined TMC2226 driver X axis"
	{% endif %}
	
	{% elif 'tmc2225 stepper_x' in printer.configfile.config %}
	SET_GCODE_VARIABLE MACRO=_DRIVER_VARS VARIABLE=run_x VALUE={printer.configfile.config['tmc2225 stepper_x'].run_current|float}
	{% if driver_vars.readback == True %}
	RESPOND TYPE=COMMAND MSG="Defined TMC2225 driver X axis"
	{% endif %}
	
	{% elif 'tmc2130 stepper_x' in printer.configfile.config %}
	SET_GCODE_VARIABLE MACRO=_DRIVER_VARS VARIABLE=run_x VALUE={printer.configfile.config['tmc2130 stepper_x'].run_current|float}
	{% if driver_vars.readback == True %}
	RESPOND TYPE=COMMAND MSG="Defined TMC2130 driver X axis"
	{% endif %}
	
	{% elif 'tmc2240 stepper_x' in printer.configfile.config %}
	SET_GCODE_VARIABLE MACRO=_DRIVER_VARS VARIABLE=run_x VALUE={printer.configfile.config['tmc2240 stepper_x'].run_current|float}
	{% if driver_vars.readback == True %}
	RESPOND TYPE=COMMAND MSG="Defined TMC2240 driver X axis"
	{% endif %}
	
	{% elif 'tmc2660 stepper_x' in printer.configfile.config %}
	SET_GCODE_VARIABLE MACRO=_DRIVER_VARS VARIABLE=run_x VALUE={printer.configfile.config['tmc2660 stepper_x'].run_current|float}
	{% if driver_vars.readback == True %}
	RESPOND TYPE=COMMAND MSG="Defined TMC2660 driver X axis"
	{% endif %}
	
	{% endif %}
	
	{% if 'tmc2209 stepper_y' in printer.configfile.config %}
	SET_GCODE_VARIABLE MACRO=_DRIVER_VARS VARIABLE=run_y VALUE={printer.configfile.config['tmc2209 stepper_y'].run_current|float}
	{% if driver_vars.readback == True %}
	RESPOND TYPE=COMMAND MSG="Defined TMC2209 driver Y axis"
	{% endif %}
	
	{% elif 'tmc5160 stepper_y' in printer.configfile.config %}
	SET_GCODE_VARIABLE MACRO=_DRIVER_VARS VARIABLE=run_y VALUE={printer.configfile.config['tmc5160 stepper_y'].run_current|float}
	{% if driver_vars.readback == True %}
	RESPOND TYPE=COMMAND MSG="Defined TMC5160 driver Y axis"
	{% endif %}
	
	{% elif 'tmc2208 stepper_y' in printer.configfile.config %}
	SET_GCODE_VARIABLE MACRO=_DRIVER_VARS VARIABLE=run_y VALUE={printer.configfile.config['tmc2208 stepper_y'].run_current|float}
	{% if driver_vars.readback == True %}
	RESPOND TYPE=COMMAND MSG="Defined TMC2208 driver Y axis"
	{% endif %}
	
	{% elif 'tmc2226 stepper_y' in printer.configfile.config %}
	SET_GCODE_VARIABLE MACRO=_DRIVER_VARS VARIABLE=run_y VALUE={printer.configfile.config['tmc2226 stepper_y'].run_current|float}
	{% if driver_vars.readback == True %}
	RESPOND TYPE=COMMAND MSG="Defined TMC2226 driver Y axis"
	{% endif %}
	
	{% elif 'tmc2225 stepper_y' in printer.configfile.config %}
	SET_GCODE_VARIABLE MACRO=_DRIVER_VARS VARIABLE=run_y VALUE={printer.configfile.config['tmc2225 stepper_y'].run_current|float}
	{% if driver_vars.readback == True %}
	RESPOND TYPE=COMMAND MSG="Defined TMC2225 driver Y axis"
	{% endif %}
	
	{% elif 'tmc2130 stepper_y' in printer.configfile.config %}
	SET_GCODE_VARIABLE MACRO=_DRIVER_VARS VARIABLE=run_y VALUE={printer.configfile.config['tmc2130 stepper_y'].run_current|float}
	{% if driver_vars.readback == True %}
	RESPOND TYPE=COMMAND MSG="Defined TMC2130 driver Y axis"
	{% endif %}
	
	{% elif 'tmc2240 stepper_y' in printer.configfile.config %}
	SET_GCODE_VARIABLE MACRO=_DRIVER_VARS VARIABLE=run_y VALUE={printer.configfile.config['tmc2240 stepper_y'].run_current|float}
	{% if driver_vars.readback == True %}
	RESPOND TYPE=COMMAND MSG="Defined TMC2240 driver Y axis"
	{% endif %}
	
	{% elif 'tmc2660 stepper_y' in printer.configfile.config %}
	SET_GCODE_VARIABLE MACRO=_DRIVER_VARS VARIABLE=run_y VALUE={printer.configfile.config['tmc2660 stepper_y'].run_current|float}
	{% if driver_vars.readback == True %}
	RESPOND TYPE=COMMAND MSG="Defined TMC2660 driver Y axis"
	{% endif %}
	
	{% endif %}

[gcode_macro _Z_LIFT]
gcode = 
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	{% set core_vars = printer["gcode_macro _CORE_VARS"] %}
	{% set driver_vars = printer["gcode_macro _DRIVER_VARS"] %}
	
	{% if 'z' not in printer.toolhead.homed_axes %}
	{% if core_vars.last_known_z <= (printer.toolhead.axis_maximum.z|int - start_vars.pre_home_lift|int) - 20 %}
	RESPOND TYPE=COMMAND MSG="Raising Z axis for safe clearance prior to homing"
	RESPOND TYPE=COMMAND MSG="WARNING AXES RESET FOR Z LIFT!!"
	SET_KINEMATIC_POSITION Z=0
	SET_GCODE_VARIABLE MACRO=_DRIVER_VARS VARIABLE=z_lift_move VALUE=True
	M400
	G90
	{% if start_vars.pre_home_lift|int in range (0, 21) and start_vars.z_lift_speed|int in range (1, 26) %}
	G0 Z{start_vars.pre_home_lift|int} F{start_vars.z_lift_speed|int * 60}
	M400
	
	M84
	{% else %}
	M84
	{ action_raise_error("Request denied, operation cancelled! Lift height or speed not in range. See demon_user_settings.cfg DEMON HOME CONTROL SETTINGS") }
	{% endif %}
	
	{% else %}
	RESPOND TYPE=COMMAND MSG="Z Axis near maximum, lift skipped"
	{% endif %}
	
	{% else %}
	{% if printer.toolhead.position.z <= (printer.toolhead.axis_maximum.z|int - start_vars.pre_home_lift|int) - 20 %}
	G90
	{% if start_vars.pre_home_lift|int in range (0, 21) and start_vars.z_lift_speed|int in range (1, 26) %}
	RESPOND TYPE=COMMAND MSG="Raising Z axis for safe clearance prior to homing"
	G0 Z{start_vars.pre_home_lift|int} F{start_vars.z_lift_speed|int * 60}
	M400
	{% else %}
	{ action_raise_error("Request denied, operation cancelled! Lift height or speed not in range. See demon_user_settings.cfg DEMON HOME CONTROL SETTINGS") }
	{% endif %}
	{% else %}
	RESPOND TYPE=COMMAND MSG="Z Axis near maximum, lift skipped"
	{% endif %}
	{% endif %}

[gcode_macro _HOME_POWER_SAFETY]
gcode = 
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	
	{% if start_vars.override_home_power_safety == False and start_vars.home_power|float > 1.0 %}
	{ action_raise_error("Request denied, the operation has been cancelled! Your soft home power levels are too high! See demon_user_settings.cfg DEMON HOME CONTROL SETTINGS where you can override this message if you wish") }
	{% endif %}

[gcode_macro _DRIVER_VARS]
variable_readback = True
variable_definer_executed = False
variable_tmc_found_x = True
variable_tmc_found_y = True
variable_run_x = 0.8
variable_run_y = 0.8
variable_z_lift_move = False
gcode = 

[gcode_macro _HOME_VERSION]
variable_demon_home_ver = "1.4.0"
gcode = 

[gcode_macro QUICK_MESH]
description = Build a quick & dirty mesh at current temps. It will NOT level your machine first!! Choose profile name! Compatible with Eddy Probe!
gcode = 
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	{% set profile = params.PROFILE|default('QUICK_MESH')|string %}
	G90
	_SET_Z_PARK
	_HOMING_HELPER
	
	{% if start_vars.neopixel_led == True %}
	STATUS_MESHING
	{% endif %}
	
	{% if 'mcu eddy' in printer.configfile.config or 'probe_eddy_current btt_eddy' in printer %}
	BED_MESH_CALIBRATE PROFILE={profile} METHOD=rapid_scan
	
	{% else %}
	BED_MESH_CALIBRATE PROFILE={profile}
	{% endif %}
	
	_Z_PARK
	
	{% if start_vars.neopixel_led == True %}
	STATUS_READY
	{% endif %}
	
	M117

[gcode_macro HOT_MESH]
description = Build an accurate mesh with the proper full process. Choose profile name & more! Compatible with Eddy Probe!
gcode = 
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	{% set profile = params.PROFILE|default('HOT_MESH')|string %}
	{% set nozzle = params.NOZZLE|default(160)|int %}
	{% set bed = params.BED|default(60)|int %}
	{% set soak = params.HEATSOAK|default('Yes')|string %}
	{% set time = params.TIMER|default(10)|int %}
	
	G90
	_SET_Z_PARK
	{% if start_vars.neopixel_led == True %}
	STATUS_HEATING
	{% endif %}
	
	SET_DISPLAY_TEXT MSG="HEATING..."
	RESPOND TYPE=COMMAND MSG="HEATING..."
	SET_HEATER_TEMPERATURE HEATER=heater_bed TARGET={bed}
	SET_HEATER_TEMPERATURE HEATER=extruder TARGET={nozzle}
	
	SET_DISPLAY_TEXT MSG="Waiting for Nozzle temp..."
	RESPOND TYPE=COMMAND MSG="Waiting for Nozzle temp..."
	TEMPERATURE_WAIT SENSOR=extruder MINIMUM={nozzle|int - 5} MAXIMUM={nozzle|int + 5}
	
	_HOMING_HELPER
	
	SET_DISPLAY_TEXT MSG="Waiting for bed temp..."
	RESPOND TYPE=COMMAND MSG="Waiting for bed temp..."
	TEMPERATURE_WAIT SENSOR=heater_bed MINIMUM={bed|int -2} MAXIMUM={bed|int + 5}
	
	{% if soak|lower in ['yes', 'true'] %}
	RESPOND TYPE=COMMAND MSG="Running Heatsoak timer..."
	_HEAT_WAIT MSG="Hot Mesh heatsoak timer..." MINUTES={time|int}
	M400
	G28 Z
	
	{% elif soak|lower in ['no', 'false'] %}
	RESPOND TYPE=COMMAND MSG="Heatsoak timer skipped"
	
	{% else %}
	RESPOND TYPE=error MSG="Hot Mesh heatsoak timer skipped. User input not recognised! Please use yes/no or true/false"
	{% endif %}
	
	{% if start_vars.nozzle_cleaner == True %}
	CLEAN_NOZZLE
	{% endif %}
	
	{% if start_vars.neopixel_led == True %}
	STATUS_LEVELING
	{% endif %}
	
	{% if start_vars.use_manual_levelling == True %}
	_ADAPTIVE_MANUAL_LEVELLING
	
	{% else %}
	_ADAPTIVE_LEVELLING
	{% endif %}
	
	{% if start_vars.neopixel_led == True %}
	STATUS_MESHING
	{% endif %}
	
	
	{% if 'mcu eddy' in printer.configfile.config or 'probe_eddy_current btt_eddy' in printer %}
	G0 Z10
	BED_MESH_CALIBRATE PROFILE={profile} METHOD=rapid_scan
	G0 Z10
	
	{% else %}
	BED_MESH_CALIBRATE PROFILE={profile}
	{% endif %}
	
	_Z_PARK
	
	{% if start_vars.neopixel_led == True %}
	STATUS_READY
	{% endif %}
	
	TURN_OFF_HEATERS
	M117

[gcode_macro AUTO_BED_MESH_BUILDER]
description = Fully automated 5 mesh builder. Choose which meshes to build, if no values set defaults will used or settings in demon_user_settings! If chamber fan/sensor enabled macro uses TEMPERATURE_WAIT not timers. Compatible with Eddy Probe!
gcode = 
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	{% set mesh_vars = printer["gcode_macro _MESH_BUILDER_VARIABLES"] %}
	{% set x_park = printer.toolhead.axis_maximum.x|float / 2 %}
	{% set y_park = printer.toolhead.axis_maximum.y|float / 2 %}
	{% set build_pla = params.BUILD_PLA|default('Yes')|string %}
	{% set build_tpu = params.BUILD_TPU|default('Yes')|string %}
	{% set build_petg = params.BUILD_PETG|default('Yes')|string %}
	{% set build_asa = params.BUILD_ASA|default('Yes')|string %}
	{% set build_abs = params.BUILD_ABS|default('Yes')|string %}
	{% set nosoak = params.SKIP_HEATSOAK_WAITS|default('No')|string %}
	{% set lotimer = params.LOW_TEMP_TIMER|default(0)|int %}
	{% set hitimer = params.HI_TEMP_TIMER|default(0)|int %}
	{% set lothreshold = params.LO_TEMP_THRESHOLD|default(22)|int %}
	{% set hithreshold = params.HI_TEMP_THRESHOLD|default(42)|int %}
	{% set bedfans = params.USE_BED_FANS|default('No')|string %}
	
	
	
	_CHAMBER_SENSOR_DEFINE
	
	{% if bedfans|lower in ['yes', 'true'] and start_vars.bed_fans == True %}
	
	SET_GCODE_VARIABLE MACRO=_MESH_BUILDER_VARIABLES VARIABLE=use_bed_fans VALUE=True
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=enable VALUE=True
	RESPOND TYPE=COMMAND MSG="Use bed fans: True"
	
	{% elif bedfans|lower in ['yes', 'true'] and start_vars.bed_fans == False %}
	RESPOND TYPE=error MSG="Sorry no bed fans in the system to enable"
	
	{% elif bedfans|lower in ['no', 'false'] and start_vars.bed_fans == True %}
	SET_GCODE_VARIABLE MACRO=_MESH_BUILDER_VARIABLES VARIABLE=use_bed_fans VALUE=False
	RESPOND TYPE=COMMAND MSG="Use bed fans: False"
	
	{% elif bedfans|lower in ['no', 'false'] and start_vars.bed_fans == False %}
	SET_GCODE_VARIABLE MACRO=_MESH_BUILDER_VARIABLES VARIABLE=use_bed_fans VALUE=False
	RESPOND TYPE=COMMAND MSG="Use bed fans: False - no fans available!"
	
	{% else %}
	RESPOND TYPE=error MSG="Mesh Builder. Use bed fans, user input not recognised! Please use yes/no or true/false"
	
	{% endif %}
	
	{% if start_vars.chamber_fan == False and start_vars.chamber_sensor == False %}
	{% if 'LOW_TEMP_TIMER' not in params and 'HI_TEMP_TIMER' not in params %}
	RESPOND TYPE=error MSG="Mesh Builder. No macro button heatsoak timers set, using saved file values. See demon_user_settings"
	{% endif %}
	
	{% if 'LOW_TEMP_TIMER' in params %}
	{% if lotimer <= 0 %}
	RESPOND TYPE=COMMAND MSG="Mesh heatsoak timer cannot be 0, value of 1 or higher can be accepted. Timer set for 1 minute."
	SET_GCODE_VARIABLE MACRO=_MESH_BUILDER_VARIABLES VARIABLE=mesh_lo_temp_timer VALUE=1
	
	{% elif lotimer >= 1 %}
	RESPOND TYPE=COMMAND MSG="Mesh heatsoak. Low temp timer set to {lotimer|int} minutes"
	SET_GCODE_VARIABLE MACRO=_MESH_BUILDER_VARIABLES VARIABLE=mesh_lo_temp_timer VALUE={'LOW_TEMP_TIMER'|int}
	{% endif %}
	
	{% else %}
	{% endif %}
	
	{% if 'HI_TEMP_TIMER' in params %}
	{% if hitimer <= 0 %}
	RESPOND TYPE=COMMAND MSG="Mesh heatsoak timer cannot be 0, value of 1 or higher can be accepted. Timer set for 1 minute."
	SET_GCODE_VARIABLE MACRO=_MESH_BUILDER_VARIABLES VARIABLE=mesh_hi_temp_timer VALUE=1
	
	{% elif hitimer >= 1 %}
	RESPOND TYPE=COMMAND MSG="Mesh heatsoak. High temp timer set to {hitimer|int} minutes"
	SET_GCODE_VARIABLE MACRO=_MESH_BUILDER_VARIABLES VARIABLE=mesh_hi_temp_timer VALUE={hitimer|int}
	{% endif %}
	
	{% else %}
	{% endif %}
	
	{% elif start_vars.chamber_fan == True or start_vars.chamber_sensor == True %}
	RESPOND TYPE=error MSG="Mesh Builder. Chamber fan/sensor detected, using TEMPERATURE_WAIT instead of the timers!"
	
	{% if 'LO_TEMP_THRESHOLD' not in params and 'HI_TEMP_THRESHOLD' not in params %}
	RESPOND TYPE=error MSG="Mesh Builder. No macro button thresholds set, using saved file values. See demon_user_settings"
	{% endif %}
	
	{% if 'LO_TEMP_THRESHOLD' in params %}
	{% if lothreshold in range (15, 41) %}
	RESPOND TYPE=COMMAND MSG="Mesh Builder. Low temp chamber thershold set to {lothreshold|int}c"
	SET_GCODE_VARIABLE MACRO=_MESH_BUILDER_VARIABLES VARIABLE=lo_heat_soak_threshold VALUE={lothreshold|int}
	
	{% else %}
	RESPOND TYPE=error MSG="Mesh Builder. Low temp threshold outside of accepted range, values of 15-40c can be accepted. Low threshold set to saved value"
	{% endif %}
	{% endif %}
	
	{% if 'HI_TEMP_THRESHOLD' in params %}
	{% if hithreshold in range (40, 70) %}
	RESPOND TYPE=COMMAND MSG="Mesh Builder. HIGH temp chamber thershold set to {hithreshold|int}c"
	SET_GCODE_VARIABLE MACRO=_MESH_BUILDER_VARIABLES VARIABLE=hi_heat_soak_threshold VALUE={hithreshold|int}
	
	{% else %}
	RESPOND TYPE=error MSG="Mesh Builder. High temp threshold outside of accepted range, values of 40-70c can be accepted. High threshold set to saved value"
	{% endif %}
	{% endif %}
	
	{% endif %}
	
	{% if build_tpu|lower not in ['yes', 'true'] and build_pla|lower not in ['yes', 'true'] and build_petg|lower not in ['yes', 'true'] and build_asa|lower not in ['yes',
	'true'] and build_abs|lower not in ['yes', 'true'] %}
	{ action_raise_error("No mesh specified, operation cancelled") }
	{% endif %}
	
	
	{% if start_vars.printer_lights == True %}
	{% if printer["Printer_Lights"] != start_vars.printer_lights_print %}
	SET_PIN PIN=Printer_Lights VALUE={start_vars.printer_lights_print}
	{% endif %}
	{% endif %}
	
	SET_DISPLAY_TEXT MSG="Building Bed Meshes PLEASE WAIT...."
	RESPOND TYPE=echo MSG="NOTE: THIS IS A LONG MACRO! IT BUILDS 5 FULL MESHES! DO NOT PRESS SAVE CONFIG! THIS MACRO AUTO SAVES WHEN COMPLETE!! BUILDING WILL START SOON PLEASE WAIT..."
	G4 P20000
	G90
	M83
	SET_GCODE_OFFSET Z=0.0
	BED_MESH_CLEAR
	
	{% if start_vars.neopixel_led == True %}
	STATUS_HEATING
	{% endif %}
	
	{% if printer.configfile.settings.stepper_z.endstop_pin != 'probe:z_virtual_endstop' %}
	SET_HEATER_TEMPERATURE HEATER=extruder TARGET={start_vars.pla_noz_pre}
	TEMPERATURE_WAIT SENSOR=extruder MINIMUM={start_vars.pla_noz_pre|float -5} MAXIMUM={start_vars.pla_noz_pre|float + 5}
	
	{% else %}
	SET_HEATER_TEMPERATURE HEATER=extruder TARGET=90
	
	{% endif %}
	
	_CONDITIONAL_HOME
	
	
	
	{% if build_tpu|lower in ['yes', 'true'] %}
	RESPOND TYPE=COMMAND MSG="Building TPU mesh"
	SET_GCODE_VARIABLE MACRO=_CORE_VARS VARIABLE=filament VALUE='"TPU"'
	_Z_PARK
	{% if start_vars.neopixel_led == True %}
	STATUS_HEATING
	{% endif %}
	
	SET_DISPLAY_TEXT MSG="Waiting For TPU Mesh Bed Temp: {mesh_vars.mesh_tpu_bed_temp}c"
	RESPOND TYPE=echo MSG="Waiting For TPU Mesh Bed Temp: {mesh_vars.mesh_tpu_bed_temp}c"
	SET_HEATER_TEMPERATURE HEATER=heater_bed TARGET={mesh_vars.mesh_tpu_bed_temp}
	TEMPERATURE_WAIT SENSOR=heater_bed MINIMUM={mesh_vars.mesh_tpu_bed_temp|float -2} MAXIMUM={mesh_vars.mesh_tpu_bed_temp|float + 5}
	
	{% if nosoak|lower in ['yes', 'true'] %}
	RESPOND TYPE=error MSG="HEATSAOK SKIPPED this may lead to a less accurate mesh!"
	
	{% elif nosoak|lower in ['no', 'false'] %}
	_WAIT_HANDLING_LOW_TEMP
	
	{% else %}
	RESPOND TYPE=error MSG="Mesh heatsoak. User input not recognised! Running heatsoak. Please use yes/no or true/false"
	_WAIT_HANDLING_LOW_TEMP
	{% endif %}
	
	_PRE_MESH_LEVEL
	{% if start_vars.neopixel_led == True %}
	STATUS_MESHING
	{% endif %}
	
	SET_DISPLAY_TEXT MSG="TPU MESH BUILDING PLEASE WAIT"
	RESPOND TYPE=echo MSG="TPU MESH BUILDING PLEASE WAIT"
	G4 P5000
	
	{% if 'mcu eddy' in printer.configfile.config or 'probe_eddy_current btt_eddy' in printer %}
	BED_MESH_CALIBRATE PROFILE=TPU METHOD=rapid_scan
	{% else %}
	BED_MESH_CALIBRATE PROFILE=TPU
	{% endif %}
	
	SET_DISPLAY_TEXT MSG="DO NOT SAVE CONFIG - MACRO IS STILL RUNNING!"
	RESPOND TYPE=echo MSG="DO NOT SAVE CONFIG - MACRO IS STILL RUNNING!"
	G4 P10000
	
	{% elif build_tpu|lower in ['no', 'false'] %}
	RESPOND TYPE=COMMAND MSG="TPU mesh building skipped"
	
	{% else %}
	RESPOND TYPE=error MSG="TPU Mesh. User input not recognised! Please use yes/no or true/false"
	{% endif %}
	
	
	
	{% if build_pla|lower in ['yes', 'true'] %}
	RESPOND TYPE=COMMAND MSG="Building PLA mesh"
	SET_GCODE_VARIABLE MACRO=_CORE_VARS VARIABLE=filament VALUE='"PLA"'
	_Z_PARK
	{% if start_vars.neopixel_led == True %}
	STATUS_HEATING
	{% endif %}
	
	SET_DISPLAY_TEXT MSG="Waiting For PLA Mesh Bed Temp: {mesh_vars.mesh_pla_bed_temp}c"
	RESPOND TYPE=echo MSG="Waiting For PLA Mesh Bed Temp: {mesh_vars.mesh_pla_bed_temp}c"
	SET_HEATER_TEMPERATURE HEATER=heater_bed TARGET={mesh_vars.mesh_pla_bed_temp}
	TEMPERATURE_WAIT SENSOR=heater_bed MINIMUM={mesh_vars.mesh_pla_bed_temp|float -2} MAXIMUM={mesh_vars.mesh_pla_bed_temp|float + 5}
	
	{% if nosoak|lower in ['yes', 'true'] %}
	RESPOND TYPE=error MSG="HEATSAOK SKIPPED this may lead to a less accurate mesh!"
	
	{% elif nosoak|lower in ['no', 'false'] %}
	_WAIT_HANDLING_LOW_TEMP
	
	{% else %}
	RESPOND TYPE=error MSG="Mesh heatsoak. User input not recognised! Running heatsoak. Please use yes/no or true/false"
	_WAIT_HANDLING_LOW_TEMP
	{% endif %}
	
	_PRE_MESH_LEVEL
	{% if start_vars.neopixel_led == True %}
	STATUS_MESHING
	{% endif %}
	
	SET_DISPLAY_TEXT MSG="PLA MESH BUILDING PLEASE WAIT"
	RESPOND TYPE=echo MSG="PLA MESH BUILDING PLEASE WAIT"
	G4 P5000
	
	{% if 'mcu eddy' in printer.configfile.config or 'probe_eddy_current btt_eddy' in printer %}
	BED_MESH_CALIBRATE PROFILE=default METHOD=rapid_scan
	{% else %}
	BED_MESH_CALIBRATE PROFILE=default
	{% endif %}
	
	SET_DISPLAY_TEXT MSG="DO NOT SAVE CONFIG - MACRO IS STILL RUNNING!"
	RESPOND TYPE=echo MSG="DO NOT SAVE CONFIG - MACRO IS STILL RUNNING!"
	G4 P10000
	
	{% elif build_pla|lower in ['no', 'false'] %}
	RESPOND TYPE=COMMAND MSG="PLA mesh building skipped"
	
	{% else %}
	RESPOND TYPE=error MSG="PLA Mesh. User input not recognised! Please use yes/no or true/false"
	{% endif %}
	
	
	
	{% if build_petg|lower in ['yes', 'true'] %}
	RESPOND TYPE=COMMAND MSG="Building PETG mesh"
	SET_GCODE_VARIABLE MACRO=_CORE_VARS VARIABLE=filament VALUE='"PETG"'
	_Z_PARK
	{% if start_vars.neopixel_led == True %}
	STATUS_HEATING
	{% endif %}
	
	SET_DISPLAY_TEXT MSG="Waiting For PETG Mesh Bed Temp: {mesh_vars.mesh_petg_bed_temp}c"
	RESPOND TYPE=echo MSG="Waiting For PETG Mesh Bed Temp: {mesh_vars.mesh_petg_bed_temp}c"
	SET_HEATER_TEMPERATURE HEATER=heater_bed TARGET={mesh_vars.mesh_petg_bed_temp}
	TEMPERATURE_WAIT SENSOR=heater_bed MINIMUM={mesh_vars.mesh_petg_bed_temp|float -2} MAXIMUM={mesh_vars.mesh_petg_bed_temp|float + 5}
	
	{% if nosoak|lower in ['yes', 'true'] %}
	RESPOND TYPE=error MSG="HEATSAOK SKIPPED this may lead to a less accurate mesh!"
	
	{% elif nosoak|lower in ['no', 'false'] %}
	_WAIT_HANDLING_LOW_TEMP
	
	{% else %}
	RESPOND TYPE=error MSG="Mesh heatsoak. User input not recognised! Running heatsoak. Please use yes/no or true/false"
	_WAIT_HANDLING_LOW_TEMP
	{% endif %}
	
	_PRE_MESH_LEVEL
	{% if start_vars.neopixel_led == True %}
	STATUS_MESHING
	{% endif %}
	
	SET_DISPLAY_TEXT MSG="PETG MESH BUILDING PLEASE WAIT"
	RESPOND TYPE=echo MSG="PETG MESH BUILDING PLEASE WAIT"
	G4 P5000
	
	{% if 'mcu eddy' in printer.configfile.config or 'probe_eddy_current btt_eddy' in printer %}
	BED_MESH_CALIBRATE PROFILE=PETG METHOD=rapid_scan
	{% else %}
	BED_MESH_CALIBRATE PROFILE=PETG
	{% endif %}
	
	SET_DISPLAY_TEXT MSG="DO NOT SAVE CONFIG - MACRO IS STILL RUNNING!"
	RESPOND TYPE=echo MSG="DO NOT SAVE CONFIG - MACRO IS STILL RUNNING!"
	G4 P10000
	
	{% elif build_petg|lower in ['no', 'false'] %}
	RESPOND TYPE=COMMAND MSG="PETG mesh building skipped"
	
	{% else %}
	RESPOND TYPE=error MSG="PETG Mesh. User input not recognised! Please use yes/no or true/false"
	{% endif %}
	
	
	
	{% if build_asa|lower in ['yes', 'true'] %}
	RESPOND TYPE=COMMAND MSG="Building ASA mesh"
	SET_GCODE_VARIABLE MACRO=_CORE_VARS VARIABLE=filament VALUE='"ASA"'
	_Z_PARK
	{% if start_vars.neopixel_led == True %}
	STATUS_HEATING
	{% endif %}
	
	SET_DISPLAY_TEXT MSG="Waiting For ASA Mesh Bed Temp: {mesh_vars.mesh_asa_bed_temp}c"
	RESPOND TYPE=echo MSG="Waiting For ASA Mesh Bed Temp: {mesh_vars.mesh_asa_bed_temp}c"
	SET_HEATER_TEMPERATURE HEATER=heater_bed TARGET={mesh_vars.mesh_asa_bed_temp}
	TEMPERATURE_WAIT SENSOR=heater_bed MINIMUM={mesh_vars.mesh_asa_bed_temp|float -2} MAXIMUM={mesh_vars.mesh_asa_bed_temp|float + 5}
	
	{% if nosoak|lower in ['yes', 'true'] %}
	RESPOND TYPE=error MSG="HEATSAOK SKIPPED this may lead to a less accurate mesh!"
	
	{% elif nosoak|lower in ['no', 'false'] %}
	_WAIT_HANDLING_HIGH_TEMP
	
	{% else %}
	RESPOND TYPE=error MSG="Mesh heatsoak. User input not recognised! Running heatsoak. Please use yes/no or true/false"
	_WAIT_HANDLING_HIGH_TEMP
	{% endif %}
	
	_PRE_MESH_LEVEL
	{% if start_vars.neopixel_led == True %}
	STATUS_MESHING
	{% endif %}
	
	SET_DISPLAY_TEXT MSG="ASA MESH BUILDING PLEASE WAIT"
	RESPOND TYPE=echo MSG="ASA MESH BUILDING PLEASE WAIT"
	G4 P5000
	
	{% if 'mcu eddy' in printer.configfile.config or 'probe_eddy_current btt_eddy' in printer %}
	BED_MESH_CALIBRATE PROFILE=ASA METHOD=rapid_scan
	{% else %}
	BED_MESH_CALIBRATE PROFILE=ASA
	{% endif %}
	
	SET_DISPLAY_TEXT MSG="DO NOT SAVE CONFIG - MACRO IS STILL RUNNING!"
	RESPOND TYPE=echo MSG="DO NOT SAVE CONFIG - MACRO IS STILL RUNNING!"
	G4 P10000
	
	{% elif build_asa|lower in ['no', 'false'] %}
	RESPOND TYPE=COMMAND MSG="ASA mesh building skipped"
	
	{% else %}
	RESPOND TYPE=error MSG="ASA Mesh. User input not recognised! Please use yes/no or true/false"
	{% endif %}
	
	
	
	{% if build_abs|lower in ['yes', 'true'] %}
	RESPOND TYPE=COMMAND MSG="Building ABS mesh"
	SET_GCODE_VARIABLE MACRO=_CORE_VARS VARIABLE=filament VALUE='"ABS"'
	_Z_PARK
	{% if start_vars.neopixel_led == True %}
	STATUS_HEATING
	{% endif %}
	
	SET_DISPLAY_TEXT MSG="Waiting For ABS Mesh Bed Temp: {mesh_vars.mesh_abs_bed_temp}c"
	RESPOND TYPE=echo MSG="Waiting For ABS Mesh Bed Temp: {mesh_vars.mesh_abs_bed_temp}c"
	SET_HEATER_TEMPERATURE HEATER=heater_bed TARGET={mesh_vars.mesh_abs_bed_temp}
	TEMPERATURE_WAIT SENSOR=heater_bed MINIMUM={mesh_vars.mesh_abs_bed_temp|float -2} MAXIMUM={mesh_vars.mesh_abs_bed_temp|float + 5}
	
	{% if nosoak|lower in ['yes', 'true'] %}
	RESPOND TYPE=error MSG="HEATSAOK SKIPPED this may lead to a less accurate mesh!"
	
	{% elif nosoak|lower in ['no', 'false'] %}
	_WAIT_HANDLING_HIGH_TEMP
	
	{% else %}
	RESPOND TYPE=error MSG="Mesh heatsoak. User input not recognised! Running heatsoak. Please use yes/no or true/false"
	_WAIT_HANDLING_HIGH_TEMP
	{% endif %}
	
	_PRE_MESH_LEVEL
	{% if start_vars.neopixel_led == True %}
	STATUS_MESHING
	{% endif %}
	
	SET_DISPLAY_TEXT MSG="ABS MESH BUILDING PLEASE WAIT"
	RESPOND TYPE=echo MSG="ABS MESH BUILDING PLEASE WAIT"
	G4 P5000
	
	{% if 'mcu eddy' in printer.configfile.config or 'probe_eddy_current btt_eddy' in printer %}
	BED_MESH_CALIBRATE PROFILE=ABS METHOD=rapid_scan
	{% else %}
	BED_MESH_CALIBRATE PROFILE=ABS
	{% endif %}
	
	{% elif build_abs|lower in ['no', 'false'] %}
	RESPOND TYPE=COMMAND MSG="ABS mesh building skipped"
	
	{% else %}
	RESPOND TYPE=error MSG="ABS Mesh. User input not recognised! Please use yes/no or true/false"
	{% endif %}
	
	
	
	SET_DISPLAY_TEXT MSG="PARKING TOOLHEAD PLEASE WAIT..."
	RESPOND TYPE=echo MSG="PARKING TOOLHEAD PLEASE WAIT..."
	G4 P10000
	_Z_PARK
	M104 S0
	M140 S0
	M84 X Y E
	M400
	SET_DISPLAY_TEXT MSG="ALL BED MESHES BUILT. MACRO COMPLETE!"
	RESPOND TYPE=echo MSG="ALL BED MESHES BUILT. MACRO COMPLETE!"
	
	{% if mesh_vars.use_bed_fans == True %}
	SET_FAN_SPEED FAN=Bed_Fans SPEED=0
	{% endif %}
	
	
	{% if start_vars.chamber_fan == True %}
	SET_TEMPERATURE_FAN_TARGET temperature_fan="chamber" target={start_vars.post_print_cool}
	{% endif %}
	
	{% if start_vars.printer_lights == True %}
	{% if printer["Printer_Lights"] != start_vars.printer_lights_finish %}
	SET_PIN PIN=Printer_Lights VALUE={start_vars.printer_lights_finish}
	{% if start_vars.neopixel_led == True and start_vars.neopixel_off == True %}
	STATUS_OFF
	{% endif %}
	
	{% endif %}
	{% endif %}
	
	M400
	G4 P5000
	SET_DISPLAY_TEXT MSG="SAVING CONFIG PLEASE WAIT..."
	RESPOND TYPE=echo MSG="SAVING CONFIG PLEASE WAIT..."
	G4 P5000
	SAVE_CONFIG

[gcode_macro _WAIT_HANDLING_LOW_TEMP]
gcode = 
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	{% set mesh_vars = printer["gcode_macro _MESH_BUILDER_VARIABLES"] %}
	{% if start_vars.chamber_fan == True %}
	{% if printer["temperature_fan chamber"].temperature <mesh_vars.lo_heat_soak_threshold %}
	{% if start_vars.chamber_temp_wait == True %}
	{% if mesh_vars.use_bed_fans == True %}
	_BED_FANS_SETUP
	M400
	_BED_FAN_SET
	{% endif %}
	SET_DISPLAY_TEXT MSG="Waiting For Chamber Temp: {mesh_vars.lo_heat_soak_threshold}c"
	RESPOND TYPE=echo MSG="Waiting For Chamber Temp: {mesh_vars.lo_heat_soak_threshold}c"
	TEMPERATURE_WAIT SENSOR="temperature_fan chamber" MINIMUM={mesh_vars.lo_heat_soak_threshold|float}
	{% else %}
	_HEAT_WAIT MINUTES={mesh_vars.mesh_lo_temp_timer}
	{% endif %}
	
	{% else %}
	M117 Already up to temp, heat soak skipped
	G4 P5000
	{% endif %}
	
	{% elif start_vars.chamber_sensor == True %}
	{% if printer["temperature_sensor Chamber_Temp"].temperature <mesh_vars.lo_heat_soak_threshold %}
	{% if start_vars.chamber_temp_wait == True %}
	{% if mesh_vars.use_bed_fans == True %}
	_BED_FANS_SETUP
	M400
	_BED_FAN_SET
	{% endif %}
	SET_DISPLAY_TEXT MSG="Waiting For Chamber Temp: {mesh_vars.lo_heat_soak_threshold}c"
	RESPOND TYPE=echo MSG="Waiting For Chamber Temp: {mesh_vars.lo_heat_soak_threshold}c"
	TEMPERATURE_WAIT SENSOR="temperature_sensor Chamber_Temp" MINIMUM={mesh_vars.lo_heat_soak_threshold|float}
	{% else %}
	_HEAT_WAIT MINUTES={mesh_vars.mesh_lo_temp_timer}
	{% endif %}
	
	{% else %}
	M117 Already up to temp, heat soak skipped
	G4 P5000
	{% endif %}
	
	{% else %}
	_HEAT_WAIT MINUTES={mesh_vars.mesh_lo_temp_timer}
	
	{% endif %}
	
	{% if mesh_vars.use_bed_fans == True %}
	SET_FAN_SPEED FAN=Bed_Fans SPEED=0
	{% endif %}

[gcode_macro _WAIT_HANDLING_HIGH_TEMP]
gcode = 
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	{% set mesh_vars = printer["gcode_macro _MESH_BUILDER_VARIABLES"] %}
	{% if start_vars.chamber_fan == True %}
	{% if printer["temperature_fan chamber"].temperature <mesh_vars.hi_heat_soak_threshold %}
	{% if start_vars.chamber_temp_wait == True %}
	{% if mesh_vars.use_bed_fans == True %}
	M118 bed fans anyone?
	_BED_FANS_SETUP
	M400
	_BED_FAN_SET
	{% endif %}
	SET_DISPLAY_TEXT MSG="Waiting For Chamber Temp: {mesh_vars.hi_heat_soak_threshold}c"
	RESPOND TYPE=echo MSG="Waiting For Chamber Temp: {mesh_vars.hi_heat_soak_threshold}c"
	TEMPERATURE_WAIT SENSOR="temperature_fan chamber" MINIMUM={mesh_vars.hi_heat_soak_threshold|float -2}
	{% else %}
	_HEAT_WAIT MINUTES={mesh_vars.mesh_hi_temp_timer}
	{% endif %}
	
	{% else %}
	SET_DISPLAY_TEXT MSG="Already up to temp, heat soak skipped"
	RESPOND TYPE=COMMAND MSG="Already up to temp, heat soak skipped"
	G4 P5000
	{% endif %}
	
	{% elif start_vars.chamber_sensor == True %}
	{% if printer["temperature_sensor Chamber_Temp"].temperature <mesh_vars.hi_heat_soak_threshold %}
	{% if start_vars.chamber_temp_wait == True %}
	{% if mesh_vars.use_bed_fans == True %}
	_BED_FANS_SETUP
	M400
	_BED_FAN_SET
	
	{% endif %}
	SET_DISPLAY_TEXT MSG="Waiting For Chamber Temp: {mesh_vars.hi_heat_soak_threshold}c"
	RESPOND TYPE=echo MSG="Waiting For Chamber Temp: {mesh_vars.hi_heat_soak_threshold}c"
	TEMPERATURE_WAIT SENSOR="temperature_sensor Chamber_Temp" MINIMUM={mesh_vars.hi_heat_soak_threshold|float -2}
	{% else %}
	_HEAT_WAIT MINUTES={mesh_vars.mesh_hi_temp_timer}
	{% endif %}
	
	{% else %}
	SET_DISPLAY_TEXT MSG="Already up to temp, heat soak skipped"
	RESPOND TYPE=COMMAND MSG="Already up to temp, heat soak skipped"
	G4 P5000
	{% endif %}
	
	{% else %}
	_HEAT_WAIT MINUTES={mesh_vars.mesh_hi_temp_timer}
	
	{% endif %}
	
	{% if mesh_vars.use_bed_fans == True %}
	SET_FAN_SPEED FAN=Bed_Fans SPEED=0
	{% endif %}

[gcode_macro _PRE_MESH_LEVEL]
gcode = 
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	_CONDITIONAL_CLEAN
	{% if start_vars.neopixel_led == True %}
	STATUS_LEVELING
	{% endif %}
	
	G28 Z
	
	_ADAPTIVE_LEVELLING
	_CONDITIONAL_CLEAN
	G28 Z

[gcode_macro _MESH_BUILDER_VERSION]
variable_demon_mesh_builder = "1.5.1"
gcode = 

[gcode_macro Ready_UP_PLA]
description = Ready the printer for printing PLA
gcode = 
	{% set clean_vars = printer["gcode_macro _CLEAN_VARIABLES"] %}
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	
	{% if printer.print_stats.state != "standby" %}
	RESPOND TYPE=error MSG="Request denied, current printer state not Standby"
	
	{% else %}
	{% if start_vars.neopixel_led == True %}
	STATUS_HEATING
	{% endif %}
	
	{% if start_vars.chamber_fan == True or start_vars.chamber_sensor == True %}
	SET_TEMPERATURE_FAN_TARGET TEMPERATURE_FAN=chamber TARGET=28
	{% endif %}
	
	SET_HEATER_TEMPERATURE HEATER=heater_bed TARGET={clean_vars.ready_up_pla_bed}
	M109 S{clean_vars.ready_up_pla_noz}
	_CONDITIONAL_HOME
	
	_CONDITIONAL_CLEAN
	{% endif %}

[gcode_macro Ready_UP_ASA]
description = Ready the printer for printing ASA
gcode = 
	{% set clean_vars = printer["gcode_macro _CLEAN_VARIABLES"] %}
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	
	{% if printer.print_stats.state != "standby" %}
	RESPOND TYPE=error MSG="Request denied, current printer state not Standby"
	
	{% else %}
	{% if start_vars.neopixel_led == True %}
	STATUS_HEATING
	{% endif %}
	
	{% if start_vars.chamber_fan == True or start_vars.chamber_sensor == True %}
	SET_TEMPERATURE_FAN_TARGET TEMPERATURE_FAN=chamber TARGET=55
	{% endif %}
	
	SET_HEATER_TEMPERATURE HEATER=heater_bed TARGET={clean_vars.ready_up_asa_bed}
	M109 S{clean_vars.ready_up_asa_noz}
	_CONDITIONAL_HOME
	
	_CONDITIONAL_CLEAN
	{% endif %}

[gcode_macro Ready_UP_PETG]
description = Ready the printer for printing PETG
gcode = 
	{% set clean_vars = printer["gcode_macro _CLEAN_VARIABLES"] %}
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	
	{% if printer.print_stats.state != "standby" %}
	RESPOND TYPE=error MSG="Request denied, current printer state not Standby"
	
	{% else %}
	{% if start_vars.neopixel_led == True %}
	STATUS_HEATING
	{% endif %}
	
	{% if start_vars.chamber_fan == True or start_vars.chamber_sensor == True %}
	SET_TEMPERATURE_FAN_TARGET TEMPERATURE_FAN=chamber TARGET=28
	{% endif %}
	
	SET_HEATER_TEMPERATURE HEATER=heater_bed TARGET={clean_vars.ready_up_petg_bed}
	M109 S{clean_vars.ready_up_petg_noz}
	_CONDITIONAL_HOME
	
	_CONDITIONAL_CLEAN
	{% endif %}

[gcode_macro Ready_UP_TPU]
description = Ready the printer for printing TPU
gcode = 
	{% set clean_vars = printer["gcode_macro _CLEAN_VARIABLES"] %}
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	
	{% if printer.print_stats.state != "standby" %}
	RESPOND TYPE=error MSG="Request denied, current printer state not Standby"
	
	{% else %}
	{% if start_vars.neopixel_led == True %}
	STATUS_HEATING
	{% endif %}
	
	{% if start_vars.chamber_fan == True or start_vars.chamber_sensor == True %}
	SET_TEMPERATURE_FAN_TARGET TEMPERATURE_FAN=chamber TARGET=28
	{% endif %}
	
	SET_HEATER_TEMPERATURE HEATER=heater_bed TARGET={clean_vars.ready_up_tpu_bed}
	M109 S{clean_vars.ready_up_tpu_noz}
	_CONDITIONAL_HOME
	
	_CONDITIONAL_CLEAN
	{% endif %}

[gcode_macro Ready_UP_CUSTOM]
description = Ready the printer for printing with your settings
gcode = 
	{% set clean_vars = printer["gcode_macro _CLEAN_VARIABLES"] %}
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	{% set noz = params.NOZZLE|default(160)|int %}
	{% set bed = params.BED|default(60)|int %}
	{% set chamber = params.CHAMBER_FAN|default(50)|int %}
	{% set timeout = params.IDLE_TIMEOUT_MINUTES|default(60)|int %}
	{% set park = params.PARK_OVER_BED|default('Yes')|string %}
	
	{% if printer.print_stats.state != "standby" %}
	RESPOND TYPE=error MSG="Request denied, current printer state not Standby"
	
	{% else %}
	{% if start_vars.neopixel_led == True %}
	STATUS_HEATING
	{% endif %}
	
	SET_IDLE_TIMEOUT TIMEOUT={timeout * 60}
	
	{% if start_vars.chamber_fan == True or start_vars.chamber_sensor == True %}
	SET_TEMPERATURE_FAN_TARGET TEMPERATURE_FAN=chamber TARGET={chamber}
	{% endif %}
	
	SET_HEATER_TEMPERATURE HEATER=heater_bed TARGET={bed}
	M109 S{noz}
	_CONDITIONAL_HOME
	
	_CONDITIONAL_CLEAN
	
	{% if park|lower in ['yes', 'true'] %}
	_Z_PARK
	{% endif %}
	
	{% endif %}

[gcode_macro HEATSOAK_TOGGLE]
description = Toggle the PRINT_START Heatsoaks on & off with each click of this button! State must be set BEFORE you start a print!
gcode = 
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	
	{% if start_vars.start_my_print_already == False %}
	RESPOND TYPE=error MSG="PRINT_START HEATSOAKS WILL NOW BE SKIPPED!"
	SET_GCODE_VARIABLE MACRO=_START_VARIABLES VARIABLE=start_my_print_already VALUE=True
	
	{% elif start_vars.start_my_print_already == True %}
	RESPOND TYPE=error MSG="PRINT_START HEATSOAKS ARE NOW ACTIVE!"
	SET_GCODE_VARIABLE MACRO=_START_VARIABLES VARIABLE=start_my_print_already VALUE=False
	{% endif %}

[gcode_macro PRESENT_TOOLHEAD]
description = Moves the toolhead to a position for easy access & maintance
gcode = 
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	{% set x_present = printer.toolhead.axis_maximum.x|float / 2 %}
	{% set y_present = printer.toolhead.axis_minimum.y|float + 25 %}
	{% set z_present = printer.toolhead.axis_maximum.z|float / 2 %}
	
	{% if printer.print_stats.state != "standby" %}
	RESPOND TYPE=error MSG="Present Toolhead request denied, current printer state not Standby"
	
	{% else %}
	_CONDITIONAL_HOME
	{% if start_vars.present_use_default == True %}
	G0 X{x_present} Y{y_present} Z{z_present} F{start_vars.present_speed * 60}
	{% else %}
	{% if start_vars.present_toolhead_z|float < printer.toolhead.axis_maximum.z|float - 35 and
	start_vars.present_toolhead_z|float > printer.toolhead.axis_minimum.z|float + 5 %}
	G0 X{start_vars.present_toolhead_x} Y{start_vars.present_toolhead_y} Z{start_vars.present_toolhead_z} F{start_vars.present_speed * 60}
	
	{% else %}
	RESPOND TYPE=error MSG="Present Toolhead request denied, present_toolhead_z variable set not in accepted range. Please set above 5mm & 35mm less than max Z in the demon_user_settings file."
	{% endif %}
	
	{% endif %}
	
	{% if start_vars.neopixel_led == True %}
	STATUS_READY
	{% endif %}
	
	_SAVE
	
	{% endif %}

[gcode_macro STOW_TOOLHEAD]
description = Stows the toolhead back to a parking position. Uses the clean_vars.park_x/y/z variables in the demon_user_settings file!
gcode = 
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	
	{% if printer.print_stats.state != "standby" %}
	RESPOND TYPE=error MSG="Stow Toolhead request denied, current printer state not Standby"
	
	{% else %}
	{% if start_vars.stow_toolhead_z in range (5, 51) %}
	_CONDITIONAL_HOME
	G0 X{start_vars.stow_toolhead_x|float} Y{start_vars.stow_toolhead_y|float} Z{start_vars.stow_toolhead_z|int} F{start_vars.stow_speed|int * 60}
	{% if start_vars.neopixel_led == True %}
	STATUS_READY
	{% endif %}
	
	_SAVE
	
	{% else %}
	RESPOND TYPE=error MSG="Stow Toolhead request denied, stow_toolhead_z variable not in accepted range. Please set between 5-50mm in the demon_user_settings file."
	{% endif %}
	
	{% endif %}

[gcode_macro _PREPARE_MENU_VERSION]
variable_demon_prepare_menu = "1.2.0"
gcode = 

[gcode_macro PRINT_START]
gcode = 
	
	{% set first_layer_bed = params.BED|int %}
	{% set first_layer_extruder = params.EXTRUDER|float %}
	{% set layer_height = params.LAYER|default(0.2)|float %}
	{% set filament_type = params.FILAMENT|default('PLA')|string %}
	{% set exclude_object = params.EXCLUDE|default(0)|int %}
	{% set oapa = params.OAPA|default(0)|int %}
	{% set surface = params.SURFACE|default('High Temp Plate')|string %}
	
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	{% set ceal = printer["gcode_macro CUSTOM_EXPANSION_ACTIVE_LIST"] %}
	
	
	
	_DEMON_VERSION
	
	{% if ceal.ceal_master_enable == True %}
	{% if ceal.pre_start == True %}
	_CUSTOM_PRE_START {rawparams}
	{% endif %}
	{% endif %}
	
	{% if start_vars.orca_enable == True %}
	SET_GCODE_VARIABLE MACRO=_APA_VARS VARIABLE=fil_type VALUE='"{filament_type}"'
	SET_GCODE_VARIABLE MACRO=_APA_VARS VARIABLE=oapa VALUE={oapa}
	
	_APA_SET
	{% endif %}
	
	SET_GCODE_VARIABLE MACRO=_CORE_VARS VARIABLE=filament VALUE='"{filament_type}"'
	SET_GCODE_VARIABLE MACRO=_CORE_VARS VARIABLE=layer VALUE='"{layer_height}"'
	SET_GCODE_VARIABLE MACRO=_CORE_VARS VARIABLE=bed VALUE='"{first_layer_bed}"'
	
	{% if filament_type not in ['PLA', 'PLA+'] %}
	SET_GCODE_VARIABLE MACRO=_CORE_VARS VARIABLE=offset_reset VALUE=True
	{% endif %}
	
	{% if start_vars.orca_enable == True %}
	{% if start_vars.adaptive_meshing == True and exclude_object != 1%}
	{action_raise_error("This error is caused by the sliced file not having LABEL_OBJECT enabled or by your slicer's start Gcode not being setup correclty! Please disable Adaptive_Meshing in the demon_user_settings.cfg or re-slice the file with it enabled or your start Gcode corrected and restart the print!")}
	{% endif %}
	{% endif %}
	
	{% if start_vars.printer_lights == True %}
	{% if printer["Printer_Lights"] != start_vars.printer_lights_print %}
	SET_PIN PIN=Printer_Lights VALUE={start_vars.printer_lights_print}
	{% endif %}
	{% endif %}
	
	{% if start_vars.neopixel_led == True %}
	STATUS_BUSY
	{% endif %}
	
	
	
	G90
	M83
	M220 S100
	M221 S100
	SET_VELOCITY_LIMIT ACCEL={printer.configfile.config.printer.max_accel}
	SET_VELOCITY_LIMIT VELOCITY={printer.configfile.config.printer.max_velocity}
	{% if 'mcu eddy' not in printer and 'probe_eddy_current btt_eddy' not in printer %}
	SET_GCODE_OFFSET Z=0.0
	{% endif %}
	BED_MESH_CLEAR
	
	
	
	_INITIAL_SETUP
	_CHAMBER_SENSOR_DEFINE
	M400
	_CHAMBER_TEMPS_HELPER
	
	
	
	_RUNOUT_SENSOR_CHECK
	
	{% if start_vars.encoder_runout_sensor == True %}
	SET_FILAMENT_SENSOR SENSOR=encoder_sensor ENABLE=0
	UPDATE_DELAYED_GCODE ID=_ENCODER_RUNOUT_CONTROL DURATION=10
	{% endif %}
	
	
	
	{% if ceal.ceal_master_enable == True %}
	{% if ceal.pre_heating == True %}
	_CUSTOM_PRE_HEATING {rawparams}
	{% endif %}
	{% endif %}
	
	{% if start_vars.neopixel_led == True %}
	STATUS_HEATING
	{% endif %}
	
	SET_HEATER_TEMPERATURE HEATER=heater_bed TARGET={first_layer_bed}
	
	
	
	{% if filament_type in ['PLA', 'PLA+'] %}
	SET_DISPLAY_TEXT MSG="PLA File Detected Hotend Preheat: {start_vars.pla_noz_pre}c"
	RESPOND TYPE=COMMAND MSG="PLA File Detected Hotend Preheat: {start_vars.pla_noz_pre}c"
	SET_HEATER_TEMPERATURE HEATER=extruder TARGET={start_vars.pla_noz_pre}
	TEMPERATURE_WAIT SENSOR=extruder MINIMUM={start_vars.pla_noz_pre|float -2} MAXIMUM={start_vars.pla_noz_pre|float + 5}
	
	{% elif filament_type == 'ASA' %}
	SET_DISPLAY_TEXT MSG="ASA File Detected Hotend Preheat: {start_vars.asa_noz_pre}c"
	RESPOND TYPE=COMMAND MSG="ASA File Detected Hotend Preheat: {start_vars.asa_noz_pre}c"
	SET_HEATER_TEMPERATURE HEATER=extruder TARGET={start_vars.asa_noz_pre}
	TEMPERATURE_WAIT SENSOR=extruder MINIMUM={start_vars.asa_noz_pre|float -2} MAXIMUM={start_vars.asa_noz_pre|float + 5}
	
	{% elif filament_type == 'ABS' %}
	SET_DISPLAY_TEXT MSG="ABS File Detected Hotend Preheat: {start_vars.abs_noz_pre}c"
	RESPOND TYPE=COMMAND MSG="ABS File Detected Hotend Preheat: {start_vars.abs_noz_pre}c"
	SET_HEATER_TEMPERATURE HEATER=extruder TARGET={start_vars.abs_noz_pre}
	TEMPERATURE_WAIT SENSOR=extruder MINIMUM={start_vars.abs_noz_pre|float -2} MAXIMUM={start_vars.abs_noz_pre|float + 5}
	
	{% elif filament_type in ['PET', 'PETG'] %}
	SET_DISPLAY_TEXT MSG="PETG File Detected Hotend Preheat: {start_vars.petg_noz_pre}c"
	RESPOND TYPE=COMMAND MSG="PETG File Detected Hotend Preheat: {start_vars.petg_noz_pre}c"
	SET_HEATER_TEMPERATURE HEATER=extruder TARGET={start_vars.petg_noz_pre}
	TEMPERATURE_WAIT SENSOR=extruder MINIMUM={start_vars.petg_noz_pre|float -2} MAXIMUM={start_vars.petg_noz_pre|float + 5}
	
	{% elif filament_type in ['FLEX', 'TPU'] %}
	SET_DISPLAY_TEXT MSG="TPU File Detected Hotend Preheat: {start_vars.tpu_noz_pre}c"
	RESPOND TYPE=COMMAND MSG="TPU File Detected Hotend Preheat: {start_vars.tpu_noz_pre}c"
	SET_HEATER_TEMPERATURE HEATER=extruder TARGET={start_vars.tpu_noz_pre}
	TEMPERATURE_WAIT SENSOR=extruder MINIMUM={start_vars.tpu_noz_pre|float -2} MAXIMUM={start_vars.tpu_noz_pre|float + 5}
	
	{% elif not filament_type in ['PLA', 'PLA+', 'ASA', 'ABS', 'PET', 'PETG', 'FLEX', 'TPU'] %}
	{% if params.EXTRUDER|float <220 %}
	SET_DISPLAY_TEXT MSG="Hotend Preheat by file temp: {start_vars.default_lo_noz_pre}c"
	RESPOND TYPE=COMMAND MSG="Hotend Preheat by file temp: {start_vars.default_lo_noz_pre}c"
	SET_HEATER_TEMPERATURE HEATER=extruder TARGET={start_vars.default_lo_noz_pre}
	TEMPERATURE_WAIT SENSOR=extruder MINIMUM={start_vars.default_lo_noz_pre|float -2} MAXIMUM={start_vars.default_lo_noz_pre|float + 5}
	
	{% else %}
	SET_DISPLAY_TEXT MSG="Hotend Preheat by file temp: {start_vars.default_hi_noz_pre}c"
	RESPOND TYPE=COMMAND MSG="Hotend Preheat by file temp: {start_vars.default_hi_noz_pre}c"
	SET_HEATER_TEMPERATURE HEATER=extruder TARGET={start_vars.default_hi_noz_pre}
	TEMPERATURE_WAIT SENSOR=extruder MINIMUM={start_vars.default_hi_noz_pre|float -2} MAXIMUM={start_vars.default_hi_noz_pre|float + 5}
	{% endif %}
	{% endif %}
	
	M400
	
	
	
	{% if start_vars.chamber_heater == True %}
	_CHAMBER_HEATER_SETUP
	M400
	_CHAMBER_HEATER_READ
	_CHAMBER_HEATER_MONITOR
	UPDATE_DELAYED_GCODE ID=_CHAMBER_HEAT_CONTROL DURATION=1
	{% endif %}
	
	
	
	{% if start_vars.bed_fans == True %}
	_BED_FANS_SETUP
	M400
	_BED_FAN_SET
	{% endif %}
	
	
	
	{% if start_vars.nevermore == True %}
	
	{% if filament_type in ['PLA', 'PLA+'] %}
	SET_FAN_SPEED FAN=Nevermore SPEED={start_vars.pla_nevermore_start_speed}
	
	{% elif filament_type == 'ASA' %}
	SET_FAN_SPEED FAN=Nevermore SPEED={start_vars.asa_nevermore_start_speed}
	
	{% elif filament_type == 'ABS' %}
	SET_FAN_SPEED FAN=Nevermore SPEED={start_vars.abs_nevermore_start_speed}
	
	{% elif filament_type in ['PET', 'PETG'] %}
	SET_FAN_SPEED FAN=Nevermore SPEED={start_vars.petg_nevermore_start_speed}
	
	{% elif filament_type in ['FLEX', 'TPU'] %}
	SET_FAN_SPEED FAN=Nevermore SPEED={start_vars.tpu_nevermore_start_speed}
	
	{% else %}
	SET_FAN_SPEED FAN=Nevermore SPEED={start_vars.default_nevermore_start_speed}
	{% endif %}
	{% endif %}
	
	
	
	{% if ceal.ceal_master_enable == True %}
	{% if ceal.pre_homing == True %}
	_CUSTOM_PRE_HOMING {rawparams}
	{% endif %}
	{% endif %}
	
	_HOMING_HELPER
	
	
	
	{% if ceal.ceal_master_enable == True %}
	{% if ceal.pre_bed_heating_wait == True %}
	_CUSTOM_PRE_BED_HEATING_WAIT {rawparams}
	{% endif %}
	{% endif %}
	
	{% if start_vars.neopixel_led == True %}
	STATUS_HEATING
	{% endif %}
	
	{% if first_layer_bed != 0 %}
	SET_DISPLAY_TEXT MSG="Waiting For Bed Temp: {first_layer_bed}c"
	RESPOND TYPE=COMMAND MSG="Waiting For Bed Temp: {first_layer_bed}c"
	SET_HEATER_TEMPERATURE HEATER=heater_bed TARGET={first_layer_bed}
	TEMPERATURE_WAIT SENSOR=heater_bed MINIMUM={first_layer_bed|int -2} MAXIMUM={first_layer_bed|int + 5}
	RESPOND TYPE=COMMAND MSG="Bed Temp Reached"
	
	{% else %}
	SET_DISPLAY_TEXT MSG="Bed target is 0c, waiting for bed temp bypassed!"
	RESPOND TYPE=COMMAND MSG="Bed target is 0c, waiting for bed temp bypassed!"
	{% endif %}
	
	{% if start_vars.bed_fans == True %}
	_BED_FAN_SET
	M400
	{% endif %}
	
	{% if start_vars.chamber_heater == True %}
	_CHAMBER_HEATER_MONITOR
	{% endif %}
	
	{% if start_vars.start_my_print_already == False %}
	{% if first_layer_bed == 0 %}
	SET_DISPLAY_TEXT MSG="Bed target is 0c, all timers & waits bypassed!"
	RESPOND TYPE=COMMAND MSG="Bed target is 0c, all timers & waits bypassed!"
	{% else %}
	_START_WAIT_AND_TIMER_HANDLING
	{% endif %}
	
	{% else %}
	SET_DISPLAY_TEXT MSG="Start my print already is active! I'm in a rush, bypassing heat soak commands!"
	RESPOND TYPE=COMMAND MSG="Start my print already is active! I'm in a rush, bypassing heat soak commands!"
	{% endif %}
	
	{% if start_vars.bed_fans == True %}
	_BED_FAN_SET
	{% endif %}
	
	{% if start_vars.chamber_heater == True %}
	_CHAMBER_HEATER_MONITOR
	{% endif %}
	
	
	
	{% if ceal.ceal_master_enable == True %}
	{% if ceal.pre_level == True %}
	_CUSTOM_PRE_LEVEL {rawparams}
	{% endif %}
	{% endif %}
	
	
	
	
	
	
	_ADAPTIVE_LEVELLING
	_CONDITIONAL_CLEAN
	
	{% if 'probe_eddy_current eddy' in printer and 'probe_pressure' in printer %}
	_START_PROBE_PRESSURE
	CLEAN_NOZZLE
	_START_PROBE_PRESSURE
	{% endif %}
	
	G28 Z
	
	
	
	{% if ceal.ceal_master_enable == True %}
	{% if ceal.pre_mesh == True %}
	_CUSTOM_PRE_MESH {rawparams}
	{% endif %}
	{% endif %}
	
	_MESH_HANDLING
	
	
	
	
	
	{% if start_vars.orca_enable == True %}
	SET_GCODE_VARIABLE MACRO=_CORE_VARS VARIABLE=orca_surface VALUE='"{surface}"'
	_ORCA_MULTI_SURFACE_HANDLING
	{% endif %}
	
	_Z_OFFSET_HANDLING
	
	
	
	{% if start_vars.adaptive_meshing == True or start_vars.use_kamp_smart_park == True %}
	SMART_PARK
	
	{% else %}
	_START_POS
	{% endif %}
	
	
	SET_DISPLAY_TEXT MSG="Heating Hotend: {first_layer_extruder}c"
	RESPOND TYPE=COMMAND MSG="Heating Hotend: {first_layer_extruder}c"
	
	{% if start_vars.neopixel_led == True %}
	STATUS_HEATING
	{% endif %}
	
	SET_HEATER_TEMPERATURE HEATER=extruder TARGET={first_layer_extruder}
	TEMPERATURE_WAIT SENSOR=extruder MINIMUM={first_layer_extruder|float -2} MAXIMUM={first_layer_extruder|float + 5}
	
	
	
	{% if start_vars.nevermore == True %}
	
	{% if filament_type in ['PLA', 'PLA+'] %}
	SET_FAN_SPEED FAN=Nevermore SPEED={start_vars.pla_nevermore_print_speed}
	
	{% elif filament_type == 'ASA' %}
	SET_FAN_SPEED FAN=Nevermore SPEED={start_vars.asa_nevermore_print_speed}
	
	{% elif filament_type == 'ABS' %}
	SET_FAN_SPEED FAN=Nevermore SPEED={start_vars.abs_nevermore_print_speed}
	
	{% elif filament_type in ['PET', 'PETG'] %}
	SET_FAN_SPEED FAN=Nevermore SPEED={start_vars.petg_nevermore_print_speed}
	
	{% elif filament_type in ['FLEX', 'TPU'] %}
	SET_FAN_SPEED FAN=Nevermore SPEED={start_vars.tpu_nevermore_print_speed}
	
	{% else %}
	SET_FAN_SPEED FAN=Nevermore SPEED={start_vars.default_nevermore_print_speed}
	{% endif %}
	{% endif %}
	
	
	
	{% if ceal.ceal_master_enable == True %}
	{% if ceal.pre_print == True %}
	_CUSTOM_PRE_PRINT {rawparams}
	{% endif %}
	{% endif %}
	
	{% if start_vars.neopixel_led == True %}
	STATUS_PRINTING
	{% endif %}
	
	_PURGE_LINES
	
	{% if start_vars.chamber_heater == True %}
	UPDATE_DELAYED_GCODE ID=_CHAMBER_HEAT_CONTROL DURATION=2
	RESPOND TYPE=COMMAND MSG="Chamber Heater Monitor Active"
	{% endif %}
	
	{% if start_vars.bed_fans == True %}
	UPDATE_DELAYED_GCODE ID=_BED_FAN_MONITOR DURATION=1
	RESPOND TYPE=COMMAND MSG="Bed Fans Monitor Active"
	{% endif %}

[gcode_macro PRINT_END]
gcode = 
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	{% set core_vars = printer["gcode_macro _CORE_VARS"] %}
	{% set bed_fan_vars = printer["gcode_macro _BED_FAN_VARS"] %}
	{% set ceal = printer["gcode_macro CUSTOM_EXPANSION_ACTIVE_LIST"] %}
	
	{% if ceal.ceal_master_enable == True %}
	{% if ceal.pre_end == True %}
	_CUSTOM_PRE_END {rawparams}
	{% endif %}
	{% endif %}
	
	G91
	G1 E-2 F2700
	G1 E-2 Z0.2 F2400
	G0 X5 Y5 F12000
	G90
	
	{% if start_vars.encoder_runout_sensor == True %}
	SET_FILAMENT_SENSOR SENSOR=encoder_sensor ENABLE=0
	{% endif %}
	
	{% if printer.toolhead.position.z|float < 50 %}
	G0 Z50 F3600
	{% endif %}
	
	_OFFSET_RESET_CONTROL
	
	{% if start_vars.chamber_heater == True %}
	UPDATE_DELAYED_GCODE ID=_CHAMBER_HEAT_CONTROL DURATION=0
	RESPOND TYPE=COMMAND MSG="Chamber Heater Monitor deactivated, heater off"
	{% if start_vars.heater_neo == True %}
	SET_LED LED="Chamber_Heater_Neopixel" RED=1.0 GREEN=0.0 BLUE=1.0 WHITE=0 SYNC=0 TRANSMIT=1
	{% endif %}
	{% endif %}
	
	TURN_OFF_HEATERS
	
	{% if start_vars.chamber_fan == True %}
	SET_TEMPERATURE_FAN_TARGET temperature_fan="chamber" target={start_vars.post_print_cool}
	{% endif %}
	
	SET_DISPLAY_TEXT MSG="Print Complete!"
	RESPOND TYPE=COMMAND MSG="Print Complete!"
	_TOOLHEAD_PARK_PAUSE_CANCEL
	
	M84
	M220 S100
	M221 S100
	SET_VELOCITY_LIMIT ACCEL={printer.configfile.config.printer.max_accel}
	SET_VELOCITY_LIMIT VELOCITY={printer.configfile.config.printer.max_velocity}
	
	BED_MESH_CLEAR
	
	{% if start_vars.nevermore == True %}
	_NEVERMORE_POST_PRINT
	{% endif %}
	
	{% if ceal.ceal_master_enable == True %}
	{% if ceal.pre_shutdown == True %}
	_CUSTOM_PRE_SHUTDOWN {rawparams}
	{% endif %}
	{% endif %}
	
	{% if start_vars.shutdown_relay == True %}
	{% if printer["output_pin PRINTER_AUTO_OFF"].value == 1.0 %}
	_GOODNIGHT
	
	{% else %}
	M107
	M117
	{% if start_vars.neopixel_led == True %}
	STATUS_READY
	{% endif %}
	{% endif %}
	
	{% else %}
	M107
	M117
	{% if start_vars.neopixel_led == True %}
	STATUS_READY
	{% endif %}
	{% endif %}
	
	{% if start_vars.printer_lights == True %}
	{% if printer["Printer_Lights"] != start_vars.printer_lights_finish %}
	SET_PIN PIN=Printer_Lights VALUE={start_vars.printer_lights_finish}
	{% if start_vars.neopixel_led == True and start_vars.neopixel_off == True %}
	status_off
	{% endif %}
	{% endif %}
	{% endif %}
	
	{% if ceal.ceal_master_enable == True %}
	{% if ceal.post_end == True %}
	_CUSTOM_POST_END {rawparams}
	{% endif %}
	{% endif %}

[gcode_macro _RET_CALI_START]
gcode = 
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	
	_CHAMBER_SENSOR_DEFINE
	
	{% if start_vars.bed_fans == True %}
	_BED_FANS_SETUP
	M400
	_BED_FAN_SET
	{% endif %}
	
	G90
	M83
	SET_GCODE_OFFSET Z=0.0
	BED_MESH_CLEAR
	_CONDITIONAL_CLEAN
	G28 Z
	_ADAPTIVE_LEVELLING
	
	_CONDITIONAL_CLEAN
	G28 Z
	
	{% if start_vars.adaptive_meshing == True %}
	{% if ('mcu eddy' in printer.configfile.config) or ('probe_eddy_current btt_eddy' in printer) or ('probe_eddy_current eddy' in printer) %}
	BED_MESH_CALIBRATE METHOD=rapid_scan ADAPTIVE=1 ADAPTIVE_MARGIN=10
	{% else %}
	BED_MESH_CALIBRATE ADAPTIVE=1 ADAPTIVE_MARGIN=10
	{% endif %}
	
	{% else %}
	BED_MESH_PROFILE LOAD="default"
	{% endif %}
	
	{% if start_vars.neopixel_led == True %}
	STATUS_PRINTING
	{% endif %}
	
	{% if start_vars.adaptive_meshing == True or start_vars.use_kamp_smart_park == True %}
	SMART_PARK
	
	{% else %}
	_START_POS
	{% endif %}
	
	{% if start_vars.neopixel_led == True %}
	STATUS_PRINTING
	{% endif %}
	
	_PURGE_LINES
	
	{% if start_vars.chamber_heater == True %}
	_CHAMBER_HEATER_SETUP
	M400
	UPDATE_DELAYED_GCODE ID=_CHAMBER_HEAT_CONTROL DURATION=1
	RESPOND TYPE=COMMAND MSG="Chamber Heater Monitor Active"
	{% endif %}
	
	{% if start_vars.bed_fans == True %}
	UPDATE_DELAYED_GCODE ID=_BED_FAN_MONITOR DURATION=1
	RESPOND TYPE=COMMAND MSG="Bed Fans Monitor Active"
	{% endif %}
	
	M82
	G92 E0

[gcode_macro _PRINT_START_VERSION]
variable_demon_start_ver = "2.9.5"
gcode = 

[gcode_macro EDDY_TEMP_COMP]
description = Run the BTT Eddy thermal compensation routine. FOR USB/DUO EDDY ONLY!
gcode = 
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	{% set temp = params.NOZ_TEMP|default(220)|int %}
	{% set bedtemp = params.BED_TEMP|default(100)|int %}
	{% set e_tar = params.EDDY_TEMP_TARGET|default(56)|int %}
	{% set e_step = params.EDDY_TEMP_STEP|default(4)|int %}
	
	{% if 'mcu eddy' in printer and 'probe_eddy_current btt_eddy' in printer %}
	_CONDITIONAL_HOME
	G0 X{start_vars.eddy_park_x} Y{start_vars.eddy_park_y} Z20 F9000
	G0 Z5
	SET_IDLE_TIMEOUT TIMEOUT=36000
	SET_DISPLAY_TEXT MSG="Hotend heating..."
	RESPOND TYPE=COMMAND MSG="Hotend heating..."
	SET_HEATER_TEMPERATURE HEATER=extruder TARGET={temp}
	TEMPERATURE_WAIT SENSOR=extruder MINIMUM={temp|int -2} MAXIMUM={temp|int + 5}
	
	{% if start_vars.nozzle_cleaner == True %}
	CLEAN_NOZZLE
	G0 X{start_vars.eddy_park_x} Y{start_vars.eddy_park_y} Z20 F9000
	G0 Z5
	M400
	{% endif %}
	
	SET_DISPLAY_TEXT MSG="HEATING BED TO NEAR MAX...!"
	RESPOND TYPE=COMMAND MSG="HEATING BED TO NEAR MAX...!"
	SET_HEATER_TEMPERATURE HEATER=heater_bed TARGET={bedtemp}
	
	TEMPERATURE_PROBE_CALIBRATE PROBE=btt_eddy TARGET={e_tar} STEP={e_step}
	
	{% else %}
	RESPOND TYPE=error MSG="Operation canceled: USB/DUO BTT Eddy probe not present!"
	{% endif %}

[gcode_macro EDDY_CURRENT_CALIBRATION]
description = Run the BTT Eddy current calibration - Z AXIS MUST BE AT 20mm OFF THE BED!
gcode = 
	
	SET_DISPLAY_TEXT MSG="NOZZLE MUST BE AT 20mm OFF THE BED!"
	RESPOND TYPE=COMMAND MSG="NOZZLE MUST BE AT 20mm OFF THE BED!"
	LDC_CALIBRATE_DRIVE_CURRENT CHIP=btt_eddy

[gcode_macro EDDY_HEIGHT_SETUP]
description = Run the BTT Eddy height setup routine.
gcode = 
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	
	{% if 'xy' not in printer.toolhead.homed_axes %}
	G28 X Y
	{% endif %}
	BED_MESH_CLEAR
	G0 X{start_vars.eddy_park_x} Y{start_vars.eddy_park_y} F9000
	{% if 'z' not in printer.toolhead.homed_axes %}
	SET_KINEMATIC_POSITION Z={printer.toolhead.axis_maximum.z|int -1}
	{% endif %}
	PROBE_EDDY_CURRENT_CALIBRATE CHIP=btt_eddy

[gcode_macro Pressure_Advance_Test_Mode]
description = Automate the standard Klipper settings for testing PA. Click to ready & then print the Klipper PA test. DO NOT USE FOR ORCA SLICER PA TEST FILE!
gcode = 
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	
	_CONDITIONAL_HOME
	
	M117 PRESSURE ADVANCE TEST MODE ACTIVE! NOT FOR ORCA TEST
	M118 PRESSURE ADVANCE TEST MODE ACTIVE! NOT FOR ORCA TEST
	
	SET_VELOCITY_LIMIT SQUARE_CORNER_VELOCITY=1 ACCEL=500
	TUNING_TOWER COMMAND=SET_PRESSURE_ADVANCE PARAMETER=ADVANCE START=0 FACTOR=.005
	
	SET_DISPLAY_TEXT MSG="The KLIPPER pressure_advance value can then be calculated as pressure_advance = start +(plus) measured_height x(multiply) factor. For example, 0 +(plus) 12.90 x(multiply) .005 would be .258 THIS IS NOT FOR ORCA TEST"
	RESPOND TYPE=echo MSG="The KLIPPER pressure_advance value can then be calculated as pressure_advance = start +(plus) measured_height x(multiply) factor. For example, 0 +(plus) 12.90 x(multiply) .005 would be .258 THIS IS NOT FOR ORCA TEST"

[gcode_macro Stepper_Buzz_Cycle]
description = Run a full system or partial system stepper_buzz on each motor one after the other to check setup. Motors always move in a positive direction first then return.
gcode = 
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	{% set buzzX = params.X_BUZZ|default('Yes')|string %}
	{% set buzzY = params.Y_BUZZ|default('Yes')|string %}
	{% set buzzZ = params.Z_BUZZ|default('Yes')|string %}
	{% set buzzZone = params.Z1_BUZZ|default('Yes')|string %}
	{% set buzzZtwo = params.Z2_BUZZ|default('Yes')|string %}
	{% set buzzZthree = params.Z3_BUZZ|default('Yes')|string %}
	
	{% if buzzX|lower not in ['yes', 'true'] and buzzY|lower not in ['yes', 'true'] and buzzZ|lower not in ['yes', 'true'] and buzzZone|lower not in ['yes',
	'true'] and buzzZtwo|lower not in ['yes', 'true'] and buzzZthree|lower not in ['yes', 'true'] %}
	{ action_raise_error("No buzz specified, operation cancelled") }
	{% endif %}
	
	
	{% if start_vars.neopixel_led == True %}
	STATUS_BUSY
	{% endif %}
	
	{% if buzzX|lower in ['yes', 'true'] %}
	M117 Stepper X Buzz Cycle in 10 Seconds!
	M118 Stepper X Buzz Cycle in 10 Seconds!
	G4 P5000
	M117 5 Seconds!
	M118 5 Seconds!
	G4 P3000
	M117 Stepper X! READY GO!
	M118 Stepper X! READY GO!
	G4 P2000
	STEPPER_BUZZ STEPPER=stepper_x
	M400
	
	{% elif buzzX|lower in ['no', 'false'] %}
	RESPOND TYPE=COMMAND MSG="X_BUZZ skipped"
	
	{% else %}
	RESPOND TYPE=error MSG="X_BUZZ skipped. User input not recognised! Please use yes/no or true/false"
	{% endif %}
	
	
	{% if buzzY|lower in ['yes', 'true'] %}
	M117 Stepper Y Buzz Cycle in 10 Seconds
	M118 Stepper Y Buzz Cycle in 10 Seconds
	G4 P5000
	M117 5 Seconds!
	M118 5 Seconds!
	G4 P3000
	M117 Stepper Y! READY GO!
	M118 Stepper Y! READY GO!
	G4 P2000
	STEPPER_BUZZ STEPPER=stepper_y
	M400
	
	{% elif buzzY|lower in ['no', 'false'] %}
	RESPOND TYPE=COMMAND MSG="Y_BUZZ skipped"
	
	{% else %}
	RESPOND TYPE=error MSG="Y_BUZZ skipped. User input not recognised! Please use yes/no or true/false"
	{% endif %}
	
	
	{% if buzzZ|lower in ['yes', 'true'] %}
	M117 Stepper Z Buzz Cycle in 10 Seconds
	M118 Stepper Z Buzz Cycle in 10 Seconds
	G4 P5000
	M117 5 Seconds!
	M118 5 Seconds!
	G4 P3000
	M117 Stepper Z! READY GO!
	M118 Stepper Z! READY GO!
	G4 P2000
	STEPPER_BUZZ STEPPER=stepper_z
	M400
	
	{% elif buzzZ|lower in ['no', 'false'] %}
	RESPOND TYPE=COMMAND MSG="Z_BUZZ skipped"
	
	{% else %}
	RESPOND TYPE=error MSG="Z_BUZZ skipped. User input not recognised! Please use yes/no or true/false"
	{% endif %}
	
	
	{% if buzzZone|lower in ['yes', 'true'] %}
	{% if ('stepper_z1' in printer.configfile.config) %}
	M117 Stepper Z1 Buzz Cycle in 10 Seconds
	M118 Stepper Z1 Buzz Cycle in 10 Seconds
	G4 P5000
	M117 5 Seconds!
	M118 5 Seconds!
	G4 P3000
	M117 Stepper Z1! READY GO!
	M118 Stepper Z1! READY GO!
	G4 P2000
	STEPPER_BUZZ STEPPER=stepper_z1
	M400
	{% else %}
	M118 Stepper Z1 is not available to this system
	{% endif %}
	
	{% elif buzzZone|lower in ['no', 'false'] %}
	RESPOND TYPE=COMMAND MSG="Z1_BUZZ skipped"
	
	{% else %}
	RESPOND TYPE=error MSG="Z1_BUZZ skipped. User input not recognised! Please use yes/no or true/false"
	{% endif %}
	
	
	{% if buzzZtwo|lower in ['yes', 'true'] %}
	{% if ('stepper_z2' in printer.configfile.config) %}
	M117 Stepper Z2 Buzz Cycle in 10 Seconds
	M118 Stepper Z2 Buzz Cycle in 10 Seconds
	G4 P5000
	M117 5 Seconds!
	M118 5 Seconds!
	G4 P3000
	M117 Stepper Z2! READY GO!
	M118 Stepper Z2! READY GO!
	G4 P2000
	STEPPER_BUZZ STEPPER=stepper_z2
	M400
	{% else %}
	M118 Stepper Z2 is not available to this system
	{% endif %}
	
	{% elif buzzZtwo|lower in ['no', 'false'] %}
	RESPOND TYPE=COMMAND MSG="Z2_BUZZ skipped"
	
	{% else %}
	RESPOND TYPE=error MSG="Z2_BUZZ skipped. User input not recognised! Please use yes/no or true/false"
	{% endif %}
	
	
	{% if buzzZthree|lower in ['yes', 'true'] %}
	{% if ('stepper_z3' in printer.configfile.config) %}
	M117 Stepper Z3 Buzz Cycle in 10 Seconds
	M118 Stepper Z2 Buzz Cycle in 10 Seconds
	G4 P5000
	M117 5 Seconds!
	M118 5 Seconds!
	G4 P3000
	M117 Stepper Z3! READY GO!
	M118 Stepper Z3! READY GO!
	G4 P2000
	STEPPER_BUZZ STEPPER=stepper_z3
	M400
	{% else %}
	M118 Stepper Z3 is not available to this system
	{% endif %}
	
	{% elif buzzZthree|lower in ['no', 'false'] %}
	RESPOND TYPE=COMMAND MSG="Z3_BUZZ skipped"
	
	{% else %}
	RESPOND TYPE=error MSG="Z3_BUZZ skipped. User input not recognised! Please use yes/no or true/false"
	{% endif %}
	
	
	M117 CYCLE COMPLETE!
	M118 CYCLE COMPLETE!
	G4 P6000
	M117
	{% if start_vars.neopixel_led == True %}
	STATUS_READY
	{% endif %}

[gcode_macro PID_Tune_Mode]
description = Activates PID tests for the hotend & bed. Choose which to run! Macro auto saves after test. Long test!
gcode = 
	{% set ceal = printer["gcode_macro CUSTOM_EXPANSION_ACTIVE_LIST"] %}
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	{% set noz_temp = params.NOZZLE_TARGET|default(200)|float %}
	{% set bed_temp = params.BED_TARGET|default(60)|float %}
	{% set pid_noz = params.PID_NOZ|default('Yes')|string %}
	{% set pid_bed = params.PID_BED|default('Yes')|string %}
	{% set x_park = printer.toolhead.axis_maximum.x|float / 2 %}
	{% set y_park = printer.toolhead.axis_maximum.y|float / 2 %}
	
	
	
	{% if pid_noz|lower not in ['yes', 'true'] and pid_bed|lower not in ['yes', 'true'] %}
	{ action_raise_error("No PID specified, operation cancelled") }
	{% endif %}
	
	{% if ceal.ceal_master_enable == True %}
	{% if ceal.pre_pid_tune_mode == True %}
	_CUSTOM_PRE_PID_Tune_Mode {rawparams}
	{% endif %}
	{% endif %}
	
	{% if start_vars.neopixel_led == True %}
	STATUS_BUSY
	{% endif %}
	
	G90
	
	M117 PID Tune Mode! Long Test!
	M118 PID Tune Mode! Long Test!
	
	_CONDITIONAL_HOME
	
	M400
	{% if pid_noz|lower in ['yes', 'true'] %}
	G0 X{x_park} Y{y_park} Z5 F9000
	M106 S155
	{% if start_vars.neopixel_led == True %}
	STATUS_HEATING
	{% endif %}
	
	M117 EXTRUDER PID TUNE! PLEASE WAIT!
	M118 EXTRUDER PID TUNE! PLEASE WAIT!
	PID_CALIBRATE HEATER=extruder TARGET={noz_temp}
	M400
	M106 S0
	{% if start_vars.neopixel_led == True %}
	STATUS_BUSY
	{% endif %}
	{% endif %}
	
	{% if pid_bed|lower in ['yes', 'true'] %}
	M117 EXTRUDER TEST END! DONT SAVE YET!!
	M118 EXTRUDER TEST END! DONT SAVE YET!!
	G4 P10000
	G0 Z50 F9000
	{% if start_vars.neopixel_led == True %}
	STATUS_HEATING
	{% endif %}
	
	M117 HEAT BED PID TUNE! LONG TEST PLEASE WAIT!
	M118 HEAT BED PID TUNE! LONG TEST PLEASE WAIT!
	PID_CALIBRATE HEATER=heater_bed TARGET={bed_temp}
	M400
	{% if start_vars.neopixel_led == True %}
	STATUS_BUSY
	{% endif %}
	
	M117 HEAT BED TEST END!
	M118 HEAT BED TEST END!
	{% endif %}
	
	G4 P10000
	
	{% if ceal.ceal_master_enable == True %}
	{% if ceal.post_pid_tune_mode == True %}
	_CUSTOM_POST_PID_Tune_Mode {rawparams}
	{% endif %}
	{% endif %}
	
	M400
	SET_DISPLAY_TEXT MSG="SAVING CONFIG PLEASE WAIT..."
	RESPOND TYPE=echo MSG="SAVING CONFIG PLEASE WAIT..."
	G4 P5000
	SAVE_CONFIG

[gcode_macro Auto_Shaper_Calibrate]
description = Runs the auto shaper test for input shaping
gcode = 
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	
	
	
	_CONDITIONAL_HOME
	
	{% if start_vars.neopixel_led == True %}
	STATUS_BUSY
	{% endif %}
	
	_Z_PARK
	SHAPER_CALIBRATE

[gcode_macro Resonance_Test_X]
description = Runs the input shaper resonance test for the X axis
gcode = 
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	_CONDITIONAL_HOME
	
	{% if start_vars.neopixel_led == True %}
	STATUS_BUSY
	{% endif %}
	
	M117 Testing X axis please wait...
	TEST_RESONANCES AXIS=X
	M117
	{% if start_vars.neopixel_led == True %}
	STATUS_READY
	{% endif %}
	
	M118 To build graph paste this message into your SSH terminal ............................................ ~/klipper/scripts/calibrate_shaper.py /tmp/resonances_x_*.csv -o /tmp/shaper_calibrate_x.png

[gcode_macro Resonance_Test_Y]
description = Runs the input shaper resonance test for the Y axis
gcode = 
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	_CONDITIONAL_HOME
	
	{% if start_vars.neopixel_led == True %}
	STATUS_BUSY
	{% endif %}
	
	M117 Testing Y axis please wait...
	TEST_RESONANCES AXIS=Y
	M117
	{% if start_vars.neopixel_led == True %}
	STATUS_READY
	{% endif %}
	
	M118 To build graph paste this message into your SSH terminal ............................................ ~/klipper/scripts/calibrate_shaper.py /tmp/resonances_y_*.csv -o /tmp/shaper_calibrate_y.png

[gcode_macro _SETUP_HELPERS_VERSION]
variable_demon_setup = "1.5.3"
gcode = 

[gcode_macro MACHINE_LEVEL_COLD]
gcode = 
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	
	{% if printer.configfile.settings.stepper_z.endstop_pin != 'probe:z_virtual_endstop' and 'z' not in printer.toolhead.homed_axes %}
	SET_DISPLAY_TEXT MSG="Heating hotend for homing..."
	RESPOND TYPE=echo MSG="Heating hotend for homing..."
	SET_HEATER_TEMPERATURE HEATER=extruder TARGET={start_vars.pla_noz_pre}
	TEMPERATURE_WAIT SENSOR=extruder MINIMUM={start_vars.pla_noz_pre|float -5} MAXIMUM={start_vars.pla_noz_pre|float + 5}
	{% endif %}
	
	_HOMING_HELPER
	
	{% if printer.configfile.settings.stepper_z.endstop_pin != 'probe:z_virtual_endstop' %}
	M104 S0
	{% endif %}
	
	{% if start_vars.neopixel_led == True %}
	STATUS_LEVELING
	{% endif %}
	
	{% if start_vars.use_manual_levelling == True %}
	_ADAPTIVE_MANUAL_LEVELLING
	
	{% else %}
	_ADAPTIVE_LEVELLING
	
	{% endif %}
	
	_Z_PARK
	
	{% if start_vars.neopixel_led == True %}
	STATUS_READY
	{% endif %}

[gcode_macro MACHINE_LEVEL_HOT]
gcode = 
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	{% set z_cali_vars = printer["gcode_macro _Z_CALIBRATION_VARIABLES"] %}
	{% set bed_temp = params.BED_TEMP|default(60)|float %}
	{% set soak = params.HEATSOAK|default('Yes')|string %}
	{% set time = params.TIMER|default(10)|int %}
	
	G90
	SET_GCODE_OFFSET Z=0.0
	BED_MESH_CLEAR
	{% if start_vars.neopixel_led == True %}
	STATUS_HEATING
	{% endif %}
	
	M117 HEATING...
	SET_HEATER_TEMPERATURE HEATER=heater_bed TARGET={bed_temp}
	
	{% if start_vars.klicky_probe == True %}
	{% if start_vars.neopixel_led == True %}
	STATUS_HEATING
	{% endif %}
	
	SET_HEATER_TEMPERATURE HEATER=extruder TARGET={z_cali_vars.noz_pre_temp}
	TEMPERATURE_WAIT SENSOR=extruder MINIMUM={z_cali_vars.noz_pre_temp - 5} MAXIMUM={z_cali_vars.noz_pre_temp + 5}
	{% endif %}
	_HOMING_HELPER
	
	TEMPERATURE_WAIT SENSOR=heater_bed MINIMUM={bed_temp|int -2} MAXIMUM={bed_temp|int + 5}
	
	{% if soak|lower in ['yes', 'true'] %}
	RESPOND TYPE=COMMAND MSG="Running Heatsoak timer..."
	_HEAT_WAIT MSG="Levelling heatsoak timer..." MINUTES={time|int}
	
	{% elif soak|lower in ['no', 'false'] %}
	RESPOND TYPE=COMMAND MSG="Heatsoak timer skipped"
	
	{% else %}
	RESPOND TYPE=error MSG="Levelling heatsoak timer skipped. User input not recognised! Please use yes/no or true/false"
	{% endif %}
	
	{% if start_vars.nozzle_cleaner == True %}
	CLEAN_NOZZLE
	{% endif %}
	G28 Z
	M104 S0
	
	{% if start_vars.neopixel_led == True %}
	STATUS_LEVELING
	{% endif %}
	
	{% if start_vars.use_manual_levelling == True %}
	_ADAPTIVE_MANUAL_LEVELLING
	
	{% else %}
	_ADAPTIVE_LEVELLING
	
	{% endif %}
	
	_Z_PARK
	
	{% if start_vars.neopixel_led == True %}
	STATUS_READY
	{% endif %}

[gcode_macro Z_Switch_Calibrate_Cold]
gcode = 
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	{% set x_park = printer.toolhead.axis_maximum.x|float / 2 %}
	{% set y_park = printer.toolhead.axis_maximum.y|float / 2 %}
	
	
	
	{% if start_vars.klicky_probe == False or printer.configfile.settings.stepper_z.endstop_pin == 'probe:z_virtual_endstop' %}
	{action_raise_error("This error is caused by your printer not having a Z endstop switch, enable klicky_probe in user settings & define the pin if you have a Z endstop switch")}
	{% else %}
	M117 IMPORTANT! Ensure your nozzle is perfectly clean from filament!
	M118 IMPORTANT! Ensure your nozzle is perfectly clean from filament!
	
	{% if start_vars.neopixel_led == True %}
	STATUS_BUSY
	{% endif %}
	
	G90
	SET_GCODE_OFFSET Z=0.0
	BED_MESH_CLEAR
	
	_HOMING_HELPER
	{% if start_vars.neopixel_led == True %}
	STATUS_LEVELING
	{% endif %}
	
	M117 Gantry Levelling
	
	_ADAPTIVE_LEVELLING
	_Z_PARK
	M117 Time to get that piece of paper!
	
	{% if start_vars.neopixel_led == True %}
	STATUS_CALIBRATING_Z
	{% endif %}
	
	Z_ENDSTOP_CALIBRATE
	{% endif %}

[gcode_macro Z_Switch_Calibrate_Hot]
gcode = 
	
	{% set z_cali_vars = printer["gcode_macro _Z_CALIBRATION_VARIABLES"] %}
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	{% set noz_temp = params.NOZZLE_TEMP|default(200)|float %}
	{% set bed_temp = params.BED_TEMP|default(60)|float %}
	{% set x_park = printer.toolhead.axis_maximum.x|float / 2 %}
	{% set y_park = printer.toolhead.axis_maximum.y|float / 2 %}
	
	
	
	{% if start_vars.klicky_probe == False or printer.configfile.settings.stepper_z.endstop_pin == 'probe:z_virtual_endstop' %}
	{action_raise_error("This error is caused by your printer not having a Z endstop switch, enable klicky_probe in user settings & define the pin if you have a Z endstop switch")}
	{% else %}
	{% if start_vars.neopixel_led == True %}
	STATUS_BUSY
	{% endif %}
	
	G90
	SET_GCODE_OFFSET Z=0.0
	BED_MESH_CLEAR
	
	{% if start_vars.klicky_probe == True %}
	{% if start_vars.neopixel_led == True %}
	STATUS_HEATING
	{% endif %}
	
	SET_DISPLAY_TEXT MSG="Hotend Preheat: {z_cali_vars.noz_pre_temp}c"
	SET_HEATER_TEMPERATURE HEATER=extruder TARGET={z_cali_vars.noz_pre_temp}
	TEMPERATURE_WAIT SENSOR=extruder MINIMUM={z_cali_vars.noz_pre_temp - 5} MAXIMUM={z_cali_vars.noz_pre_temp + 5}
	{% endif %}
	
	_HOMING_HELPER
	
	M117 HEATING PRINTER! PLEASE WAIT!
	{% if start_vars.neopixel_led == True %}
	STATUS_HEATING
	{% endif %}
	
	M190 S{bed_temp}
	
	{% if start_vars.chamber_fan == True %}
	{% if printer["temperature_fan chamber"].temperature <z_cali_vars.heat_soak_threshold %}
	_Z_PARK
	_HEAT_WAIT MINUTES={z_cali_vars.heat_soak_timer}
	{% endif %}
	
	{% elif start_vars.chamber_sensor == True %}
	{% if printer["temperature_sensor Chamber_Temp"].temperature <z_cali_vars.heat_soak_threshold %}
	_Z_PARK
	_HEAT_WAIT MINUTES={z_cali_vars.heat_soak_timer}
	{% endif %}
	
	{% else %}
	_Z_PARK
	_HEAT_WAIT MINUTES={z_cali_vars.heat_soak_timer}
	
	{% endif %}
	
	M117 Heating Nozzle
	M109 S{noz_temp}
	
	_CONDITIONAL_CLEAN
	{% if start_vars.neopixel_led == True %}
	STATUS_LEVELING
	{% endif %}
	
	_ADAPTIVE_LEVELLING
	
	{% if start_vars.nozzle_cleaner == True %}
	CLEAN_NOZZLE
	{% endif %}
	_Z_PARK
	SET_DISPLAY_TEXT MSG="Time to get that piece of paper!"
	RESPOND TYPE=echo MSG="Time to get that piece of paper!"
	
	{% if start_vars.neopixel_led == True %}
	STATUS_CALIBRATING_Z
	{% endif %}
	
	Z_ENDSTOP_CALIBRATE
	{% endif %}

[gcode_macro Z_Probe_Calibrate_Cold]
gcode = 
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	{% set x_park = printer.toolhead.axis_maximum.x|float / 2 %}
	{% set y_park = printer.toolhead.axis_maximum.y|float / 2 %}
	
	
	
	M117 IMPORTANT! Ensure your nozzle is perfectly clean from filament!
	M118 IMPORTANT! Ensure your nozzle is perfectly clean from filament!
	
	{% if start_vars.neopixel_led == True %}
	STATUS_BUSY
	{% endif %}
	
	G90
	SET_GCODE_OFFSET Z=0.0
	BED_MESH_CLEAR
	
	_HOMING_HELPER
	
	{% if start_vars.neopixel_led == True %}
	STATUS_LEVELING
	{% endif %}
	
	_ADAPTIVE_LEVELLING
	_Z_PARK
	SET_DISPLAY_TEXT MSG="Time to get that piece of paper!"
	RESPOND TYPE=echo MSG="Time to get that piece of paper!"
	
	{% if start_vars.neopixel_led == True %}
	STATUS_CALIBRATING_Z
	{% endif %}
	
	{% if 'mcu eddy' in printer.configfile.config or 'probe_eddy_current btt_eddy' in printer %}
	PROBE_EDDY_CURRENT_CALIBRATE CHIP=btt_eddy
	
	{% elif 'scanner' in printer %}
	CARTOGRAPHER_CALIBRATE METHOD=manual
	
	{% else %}
	PROBE_CALIBRATE
	{% endif %}

[gcode_macro Z_Probe_Calibrate_Hot]
gcode = 
	
	{% set z_cali_vars = printer["gcode_macro _Z_CALIBRATION_VARIABLES"] %}
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	{% set noz_temp = params.NOZZLE_TEMP|default(200)|float %}
	{% set bed_temp = params.BED_TEMP|default(60)|float %}
	{% set x_park = printer.toolhead.axis_maximum.x|float / 2 %}
	{% set y_park = printer.toolhead.axis_maximum.y|float / 2 %}
	
	
	
	{% if start_vars.neopixel_led == True %}
	STATUS_BUSY
	{% endif %}
	
	G90
	SET_GCODE_OFFSET Z=0.0
	BED_MESH_CLEAR
	
	{% if start_vars.klicky_probe == True %}
	{% if start_vars.neopixel_led == True %}
	STATUS_HEATING
	{% endif %}
	
	SET_DISPLAY_TEXT MSG="Hotend Preheat: {z_cali_vars.noz_pre_temp}c"
	SET_HEATER_TEMPERATURE HEATER=extruder TARGET={z_cali_vars.noz_pre_temp}
	TEMPERATURE_WAIT SENSOR=extruder MINIMUM={z_cali_vars.noz_pre_temp - 5} MAXIMUM={z_cali_vars.noz_pre_temp + 5}
	{% endif %}
	
	_HOMING_HELPER
	
	SET_DISPLAY_TEXT MSG="HEATING PLEASE WAIT"
	RESPOND TYPE=echo MSG="HEATING PLEASE WAIT"
	{% if start_vars.neopixel_led == True %}
	STATUS_HEATING
	{% endif %}
	
	
	SET_HEATER_TEMPERATURE HEATER=heater_bed TARGET={bed_temp}
	TEMPERATURE_WAIT SENSOR=heater_bed MINIMUM={bed_temp|int -2} MAXIMUM={bed_temp|int + 5}
	
	{% if start_vars.chamber_fan == True %}
	{% if printer["temperature_fan chamber"].temperature <z_cali_vars.heat_soak_threshold %}
	_Z_PARK
	_HEAT_WAIT MINUTES={z_cali_vars.heat_soak_timer}
	{% endif %}
	
	{% elif start_vars.chamber_sensor == True %}
	{% if printer["temperature_sensor Chamber_Temp"].temperature <z_cali_vars.heat_soak_threshold %}
	_Z_PARK
	_HEAT_WAIT MINUTES={z_cali_vars.heat_soak_timer}
	{% endif %}
	
	{% else %}
	_Z_PARK
	_HEAT_WAIT MINUTES={z_cali_vars.heat_soak_timer}
	
	{% endif %}
	
	M117 Heating Nozzle
	M109 S{noz_temp}
	
	_CONDITIONAL_CLEAN
	
	{% if start_vars.neopixel_led == True %}
	STATUS_LEVELING
	{% endif %}
	
	_ADAPTIVE_LEVELLING
	
	SET_DISPLAY_TEXT MSG="Heating Nozzle"
	RESPOND TYPE=echo MSG="Heating Nozzle"
	SET_HEATER_TEMPERATURE HEATER=extruder TARGET={noz_temp}
	TEMPERATURE_WAIT SENSOR=extruder MINIMUM={noz_temp - 5} MAXIMUM={noz_temp + 5}
	
	{% if start_vars.nozzle_cleaner == True %}
	CLEAN_NOZZLE
	{% endif %}
	_Z_PARK
	
	SET_DISPLAY_TEXT MSG="Time to get that piece of paper!"
	RESPOND TYPE=echo MSG="Time to get that piece of paper!"
	
	{% if start_vars.neopixel_led == True %}
	STATUS_CALIBRATING_Z
	{% endif %}
	
	{% if 'mcu eddy' in printer.configfile.config or 'probe_eddy_current btt_eddy' in printer %}
	PROBE_EDDY_CURRENT_CALIBRATE CHIP=btt_eddy
	
	{% elif 'scanner' in printer %}
	CARTOGRAPHER_CALIBRATE METHOD=manual
	
	{% else %}
	PROBE_CALIBRATE
	{% endif %}

[gcode_macro Z_Probe_Accuracy_Cold]
gcode = 
	
	_CONDITIONAL_HOME
	{% if printer.toolhead.position.z|float < 20 %}
	G0 Z20 F3600
	{% endif %}
	_Z_PARK
	PROBE_ACCURACY

[gcode_macro Z_Probe_Accuracy_Hot]
gcode = 
	{% set z_cali_vars = printer["gcode_macro _Z_CALIBRATION_VARIABLES"] %}
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	{% set temp = params.TEMP|default(60)|float %}
	
	G90
	SET_GCODE_OFFSET Z=0.0
	BED_MESH_CLEAR
	
	{% if start_vars.klicky_probe == True %}
	{% if start_vars.neopixel_led == True %}
	STATUS_HEATING
	{% endif %}
	
	SET_DISPLAY_TEXT MSG="Hotend Preheat: {z_cali_vars.noz_pre_temp}c"
	SET_HEATER_TEMPERATURE HEATER=extruder TARGET={z_cali_vars.noz_pre_temp}
	TEMPERATURE_WAIT SENSOR=extruder MINIMUM={z_cali_vars.noz_pre_temp - 5} MAXIMUM={z_cali_vars.noz_pre_temp + 5}
	{% endif %}
	
	_CONDITIONAL_HOME
	{% if printer.toolhead.position.z|float < 20 %}
	G0 Z20 F3600
	{% endif %}
	
	{% if start_vars.klicky_probe == True %}
	M104 S0
	{% endif %}
	
	_Z_PARK
	{% if start_vars.neopixel_led == True %}
	STATUS_HEATING
	{% endif %}
	
	SET_DISPLAY_TEXT MSG="HEATING PLEASE WAIT"
	RESPOND TYPE=echo MSG="HEATING PLEASE WAIT"
	SET_HEATER_TEMPERATURE HEATER=heater_bed TARGET={temp}
	TEMPERATURE_WAIT SENSOR=heater_bed MINIMUM={temp - 5} MAXIMUM={temp + 5}
	{% if start_vars.neopixel_led == True %}
	STATUS_BUSY
	{% endif %}
	
	
	{% if start_vars.chamber_sensor == True %}
	_WAIT_HANDLING_LOW_TEMP
	{% else %}
	_HEAT_WAIT MINUTES={start_vars.lo_temp_timer}
	{% endif %}
	
	PROBE_ACCURACY
	{% if start_vars.neopixel_led == True %}
	STATUS_READY
	{% endif %}

[gcode_macro _Z_CALIBRATION_VERSION]
variable_demon_z_cal = "1.6.1"
gcode = 

[display_template _print_status]
text = 
	{% if printer.display_status.message %}
	{ printer.display_status.message }
	{% elif printer.idle_timeout.printing_time %}
	{% if printer.print_stats.filename %}
	{ printer.print_stats.filename.split('/')[-1] }
	{% else %}
	DEMONWARE Online
	{% endif %}
	{% else %}
	DEMONWARE Online
	{% endif %}

[menu __main __tune __chamber_fan_target]
type = input
name = ChmbrFanTrgt:{'%3d' % (menu.input)}%
enable = {printer["gcode_macro _START_VARIABLES"].chamber_fan == True}
input = {printer["temperature_fan chamber"].target}
input_min = 0
input_max = 100
input_step = 1
gcode = 
	SET_TEMPERATURE_FAN_TARGET temperature_fan="chamber" target={'%d' % (menu.input)}

[menu __main __tune __printer_lights]
type = input
name = LED Pwr: {'%03.0f' % (menu.input)}
input = {printer['output_pin Printer_Lights'].value*100}
input_min = 0
input_max = 100
input_step = 1
gcode = 
	SET_PIN PIN=Printer_Lights VALUE={'%03.2f' % (menu.input/100)}

[menu __main __tune __neo_scrn_printing]
type = command
name = Neo Scrn Print
gcode = 
	STATUS_PRINTING

[menu __main __tune __neo_scrn_off]
type = command
name = Neo Scrn off
gcode = 
	STATUS_OFF

[menu __main __DEMON]
type = list
enable = {not (printer.print_stats.state == "paused" or printer.idle_timeout.state == "Printing")}
index = 1
name = DEMON

[menu __main __DEMON __Heatsoak]
type = input
name = Heatsoak: {'OFF' if menu.input else 'ON'}
input = {printer["gcode_macro _START_VARIABLES"].start_my_print_already}
input_min = 0
input_max = 1
input_step = 1
gcode = 
	SET_GCODE_VARIABLE MACRO=_START_VARIABLES VARIABLE=start_my_print_already VALUE={True if menu.input else False}

[menu __main __DEMON __Adptv_Mesh]
type = input
name = Adptv_Mesh: {'ON' if menu.input else 'OFF'}
input = {printer["gcode_macro _START_VARIABLES"].adaptive_meshing}
input_min = 0
input_max = 1
input_step = 1
gcode = 
	SET_GCODE_VARIABLE MACRO=_START_VARIABLES VARIABLE=adaptive_meshing VALUE={True if menu.input else False}

[menu __main __DEMON __clean_nozzle]
type = command
enable = {printer["gcode_macro _START_VARIABLES"].nozzle_cleaner == True}
name = Clean Nozzle
gcode = 
	CLEAN_NOZZLE

[menu __main __DEMON __present]
type = command
name = Present_Tlhead
gcode = 
	PRESENT_TOOLHEAD

[menu __main __DEMON __stow]
type = command
name = Stow Tlhead
gcode = 
	STOW_TOOLHEAD

[menu __main __DEMON __zascender]
type = input
name = Z Ascender: {'%3d' % (menu.input)}%
input = 15
input_min = 0
input_max = 50
input_step = 1
gcode = 
	Z_ASCENDER HEIGHT={'%d' % (menu.input)}

[menu __main __prepare __rdy_up_cstm]
type = command
name = ReadyUp Custom
index = 1
gcode = 
	READY_UP_CUSTOM

[menu __main __timer]
type = list
enable = {not (printer.print_stats.state == "paused" or printer.idle_timeout.state == "Printing")}
index = 3
name = Timer

[menu __main __timer __timer_start]
type = input
name = Timer Min: {'%3d' % (menu.input)}
input = 10
input_min = 0
input_max = 60
input_step = 1
gcode = 
	TIMER_Start MINUTES={'%d' % (menu.input)}

[menu __main __timer __timer_stop]
type = command
name = Timer Stop
gcode = 
	TIMER_Stop

[menu __main __levelling __probe_cal]
type = command
name = Probe Calibrate
index = 0
gcode = 
	Z_PROBE_CALIBRATE_COLD

[menu __main __levelling __machine_lvl_cld]
type = command
enable = {('quad_gantry_level' in printer)}
name = Machine Lvl Cld
index = 1
gcode = 
	M117 Machine Level Cold
	MACHINE_LEVEL_COLD

[menu __main __levelling __machine_lvl_hot]
type = command
enable = {('quad_gantry_level' in printer)}
name = Machine Lvl Hot
index = 2
gcode = 
	M117 Machine Level Hot
	MACHINE_LEVEL_HOT

[menu __main __levelling __qik_mesh]
type = command
enable = {('bed_mesh' in printer)}
name = Quick Mesh
index = 3
gcode = 
	M117 Quick Mesh
	QUICK_MESH

[menu __main __levelling __hot_mesh]
type = command
enable = {('bed_mesh' in printer)}
name = Hot Mesh
index = 4
gcode = 
	M117 Hot Mesh
	HOT_MESH

[menu __main __control2 __chamber_fan_target]
type = input
name = ChmbrFanTrgt:{'%3d' % (menu.input)}%
enable = {printer["gcode_macro _START_VARIABLES"].chamber_fan == True}
input = {printer["temperature_fan chamber"].target}
input_min = 0
input_max = 100
input_step = 1
gcode = 
	SET_TEMPERATURE_FAN_TARGET temperature_fan="chamber" target={'%d' % (menu.input)}

[menu __main __filament __load_clean]
type = command
enable = {printer["gcode_macro _START_VARIABLES"].nozzle_cleaner == True and printer["gcode_macro _START_VARIABLES"].purge_bucket == True}
name = Load Clean
gcode = 
	LOAD_CLEAN

[menu __main __filament __unload_clean]
type = command
enable = {printer["gcode_macro _START_VARIABLES"].nozzle_cleaner == True and printer["gcode_macro _START_VARIABLES"].purge_bucket == True}
name = Unload Clean
gcode = 
	UNLOAD_CLEAN

[menu __main __lighting]
type = list
index = 7
name = Lighting

[menu __main __lighting __printer_lights]
type = input
name = LED Pwr: {'%03.0f' % (menu.input)}
input = {printer['output_pin Printer_Lights'].value*100}
input_min = 0
input_max = 100
input_step = 1
gcode = 
	SET_PIN PIN=Printer_Lights VALUE={'%03.2f' % (menu.input/100)}

[menu __main __lighting __neo_scrn_rdy]
type = command
name = Neo Scrn Rdy
gcode = 
	STATUS_READY

[menu __main __lighting __neo_scrn_printing]
type = command
name = Neo Scrn Print
gcode = 
	STATUS_PRINTING

[menu __main __lighting __neo_scrn_off]
type = command
name = Neo Scrn off
gcode = 
	STATUS_OFF

[menu __main __power]
type = list
index = 8
name = Power

[menu __main __power __klipper_rstrt]
type = command
name = Klipper Restart
gcode = 
	RESTART

[menu __main __power __host_reboot]
type = command
name = Host Reboot
gcode = 
	{action_call_remote_method("restart_machine")}

[menu __main __power __host_off]
type = command
name = Host ShutDown
gcode = 
	{action_call_remote_method("shutdown_machine")}

[gcode_macro CUSTOM_EXPANSION_ACTIVE_LIST]
variable_ceal_master_enable = False
variable_pre_start = False
variable_pre_heating = False
variable_pre_homing = False
variable_pre_bed_heating_wait = False
variable_pre_level = False
variable_pre_mesh = False
variable_pre_print = False
variable_pre_end = False
variable_pre_shutdown = False
variable_post_end = False
variable_pre_load = False
variable_post_load = False
variable_pre_unload = False
variable_post_unload = False
variable_pre_load_clean = False
variable_post_load_clean = False
variable_pre_unload_clean = False
variable_post_unload_clean = False
variable_pre_pid_tune_mode = False
variable_post_pid_tune_mode = False
variable_pause = False
variable_resume = False
variable_cancel = False
gcode = 

[gcode_macro _CUSTOM_PRE_START]
gcode = 

[gcode_macro _CUSTOM_PRE_HEATING]
gcode = 

[gcode_macro _CUSTOM_PRE_HOMING]
gcode = 

[gcode_macro _CUSTOM_PRE_BED_HEATING_WAIT]
gcode = 

[gcode_macro _CUSTOM_PRE_LEVEL]
gcode = 

[gcode_macro _CUSTOM_PRE_MESH]
gcode = 

[gcode_macro _CUSTOM_PRE_PRINT]
gcode = 

[gcode_macro _CUSTOM_PRE_END]
gcode = 

[gcode_macro _CUSTOM_PRE_SHUTDOWN]
gcode = 

[gcode_macro _CUSTOM_POST_END]
gcode = 

[gcode_macro _CUSTOM_PRE_LOAD]
gcode = 

[gcode_macro _CUSTOM_POST_LOAD]
gcode = 

[gcode_macro _CUSTOM_PRE_UNLOAD]
gcode = 

[gcode_macro _CUSTOM_POST_UNLOAD]
gcode = 

[gcode_macro _CUSTOM_PRE_LOAD_CLEAN]
gcode = 

[gcode_macro _CUSTOM_POST_LOAD_CLEAN]
gcode = 

[gcode_macro _CUSTOM_PRE_UNLOAD_CLEAN]
gcode = 

[gcode_macro _CUSTOM_POST_UNLOAD_CLEAN]
gcode = 

[gcode_macro _CUSTOM_PRE_PID_Tune_Mode]
gcode = 

[gcode_macro _CUSTOM_POST_PID_Tune_Mode]
gcode = 

[gcode_macro _CUSTOM_PAUSE]
gcode = 

[gcode_macro _CUSTOM_RESUME]
gcode = 

[gcode_macro _CUSTOM_CANCEL]
gcode = 

[gcode_macro _CEAL_VERSION]
variable_demon_ceal = "1.0.1"
gcode = 

[gcode_macro _CLEAN_VARIABLES]
variable_have_you_set_this_up = True
variable_random_clean_x = True
variable_random_clean_y = True
variable_clean_travel_speed = 200
variable_pass_spd = 250
variable_end_position_x = 351
variable_end_position_y = 359
variable_park_x = 324
variable_park_y = 360
variable_park_z = 25
variable_linear_pass_count = 6
variable_linear_clean_start_x = 315
variable_linear_clean_start_y = 360
variable_linear_clean_start_z = 0.5
variable_linear_clean_axis = "X"
variable_linear_clean_positive_dir = True
variable_linear_clean_distance = 28
variable_pass_count = 40
variable_start_x = 315
variable_start_y = 360
variable_start_z = 0.5
variable_clean_min_x = 324
variable_clean_max_x = 345
variable_clean_min_y = 358
variable_clean_max_y = 360
variable_nozzle_pre_temp = 180
variable_nozzle_post_temp = 180
variable_load_clean_load_dist = 120
variable_load_clean_purge_dist = 30
variable_unload_clean_unload_dist = 100
variable_unload_clean_purge_dist = 20
variable_purge_min_x = 307
variable_purge_max_x = 340
variable_purge_y_park = 352
variable_purge_z_park = 8
variable_ready_up_pla_noz = 180
variable_ready_up_pla_bed = 60
variable_ready_up_asa_noz = 180
variable_ready_up_asa_bed = 100
variable_ready_up_petg_noz = 180
variable_ready_up_petg_bed = 75
variable_ready_up_tpu_noz = 180
variable_ready_up_tpu_bed = 70
gcode = 

[gcode_macro _CLEAN_VARS_VER]
variable_demon_clean_vars_ver = "1.1.0"
gcode = 

[gcode_macro _START_VARIABLES]
variable_orca_enable = True
variable_orca_multi_surface = True
variable_combine_offset = True
variable_floating_bed_fans = True
variable_floating_bed_fans_max = 0.85
variable_disable_set_flow = False
variable_use_manual_levelling = False
variable_adaptive_meshing = True
variable_use_kamp_adaptive_purge = True
variable_use_kamp_smart_park = True
variable_auto_reset_eddy_offset = False
variable_eddy_park_x = 100
variable_eddy_park_y = 170
variable_z_tracker_reduced_monitoring = False
variable_eddy_verbose = True
variable_apa_readback_enable = False
variable_bed_fans_settings_readback = False
variable_orca_cool_plate = 0.00
variable_orca_engineering_plate = 0.00
variable_orca_smooth_hi_temp_plate = 0.00
variable_orca_textured_pei_plate = -0.03
variable_orca_textured_cool_plate = 0.00
variable_pla_flow_rate = 100
variable_pla_hi_flow_rate = 100
variable_pla_noz_pre = 160
variable_pla_min_chamber_temp = 18
variable_pla_max_chamber_temp = 25
variable_pla_bed_fan_enable = True
variable_pla_bed_fan_cool = True
variable_pla_bed_fan_low_speed = 0.25
variable_pla_bed_fan_high_speed = 0.60
variable_pla_nevermore_start_speed = 1
variable_pla_nevermore_print_speed = 0.5
variable_pla_pa = 0.035
variable_pla_st = 0.03
variable_pla_adaptive_pa_enable = True
variable_pla_inner_wall_pa = 0.030
variable_pla_outer_wall_pa = 0.031
variable_pla_sparse_infill_pa = 0.032
variable_pla_solid_infill_pa = 0.033
variable_pla_top_surface_pa = 0.034
variable_asa_flow_rate = 100
variable_asa_hi_flow_rate = 100
variable_asa_noz_pre = 180
variable_asa_min_chamber_temp = 42
variable_asa_max_chamber_temp = 55
variable_asa_bed_fan_enable = True
variable_asa_bed_fan_cool = False
variable_asa_bed_fan_low_speed = 0.25
variable_asa_bed_fan_high_speed = 0.65
variable_asa_nevermore_start_speed = 1
variable_asa_nevermore_print_speed = 0.5
variable_asa_pa = 0.035
variable_asa_st = 0.03
variable_asa_adaptive_pa_enable = False
variable_asa_inner_wall_pa = 0.030
variable_asa_outer_wall_pa = 0.031
variable_asa_sparse_infill_pa = 0.032
variable_asa_solid_infill_pa = 0.033
variable_asa_top_surface_pa = 0.034
variable_abs_flow_rate = 100
variable_abs_hi_flow_rate = 100
variable_abs_noz_pre = 190
variable_abs_min_chamber_temp = 42
variable_abs_max_chamber_temp = 55
variable_abs_bed_fan_enable = True
variable_abs_bed_fan_cool = False
variable_abs_bed_fan_low_speed = 0.25
variable_abs_bed_fan_high_speed = 0.55
variable_abs_nevermore_start_speed = 1
variable_abs_nevermore_print_speed = 0.5
variable_abs_pa = 0.035
variable_abs_st = 0.03
variable_abs_adaptive_pa_enable = False
variable_abs_inner_wall_pa = 0.030
variable_abs_outer_wall_pa = 0.031
variable_abs_sparse_infill_pa = 0.032
variable_abs_solid_infill_pa = 0.033
variable_abs_top_surface_pa = 0.034
variable_high_temp_expansion_offset = False
variable_high_temp_offset = -0.03
variable_petg_flow_rate = 100
variable_petg_hi_flow_rate = 100
variable_petg_noz_pre = 180
variable_petg_min_chamber_temp = 18
variable_petg_max_chamber_temp = 35
variable_petg_bed_fan_enable = True
variable_petg_bed_fan_cool = True
variable_petg_bed_fan_low_speed = 0.25
variable_petg_bed_fan_high_speed = 0.60
variable_petg_nevermore_start_speed = 1
variable_petg_nevermore_print_speed = 0.5
variable_petg_pa = 0.035
variable_petg_st = 0.03
variable_petg_adaptive_pa_enable = True
variable_petg_inner_wall_pa = 0.030
variable_petg_outer_wall_pa = 0.031
variable_petg_sparse_infill_pa = 0.032
variable_petg_solid_infill_pa = 0.033
variable_petg_top_surface_pa = 0.034
variable_petg_anti_squish = True
variable_petg_offset = 0.015
variable_tpu_flow_rate = 100
variable_tpu_hi_flow_rate = 100
variable_tpu_noz_pre = 160
variable_tpu_min_chamber_temp = 18
variable_tpu_max_chamber_temp = 27
variable_tpu_bed_fan_enable = True
variable_tpu_bed_fan_cool = True
variable_tpu_bed_fan_low_speed = 0.25
variable_tpu_bed_fan_high_speed = 0.6
variable_tpu_nevermore_start_speed = 1
variable_tpu_nevermore_print_speed = 0.5
variable_tpu_pa = 0.035
variable_tpu_st = 0.03
variable_tpu_adaptive_pa_enable = True
variable_tpu_inner_wall_pa = 0.030
variable_tpu_outer_wall_pa = 0.031
variable_tpu_sparse_infill_pa = 0.032
variable_tpu_solid_infill_pa = 0.033
variable_tpu_top_surface_pa = 0.034
variable_tpu_anti_squish = True
variable_tpu_offset = 0.013
variable_default_lo_noz_pre = 180
variable_default_hi_noz_pre = 200
variable_default_chamber_temp = 25
variable_default_temp_timer = 10
variable_default_min_chamber_temp = 20
variable_default_max_chamber_temp = 30
variable_default_bed_fan_enable = True
variable_default_bed_fan_cool = True
variable_default_bed_fan_low_speed = 0.25
variable_default_bed_fan_high_speed = 0.6
variable_default_nevermore_start_speed = 1
variable_default_nevermore_print_speed = 0.5
variable_home_y_first = False
variable_override_home_power_safety = False
variable_home_power = 0.7
variable_pre_home_lift = 20
variable_z_lift_speed = 18
variable_axis_backoff_speed = 35
variable_axis_backoff_distance = 20
variable_axis_register_clear_wait = 2.5
variable_homing_movement_travel_speed = 200
variable_set_probe_point_default = True
variable_set_probe_custom_x = 100
variable_set_probe_custom_y = 100
variable_post_z_switch_backoff = True
variable_post_z_switch_backoff_y_dist = 15
variable_post_z_switch_backoff_height = 25
variable_z_endstop_loaction_x = 8888
variable_z_endstop_loaction_y = 8888
variable_use_custom_park = False
variable_system_choose_z = True
variable_custom_park_x = 8888
variable_custom_park_y = 8888
variable_custom_park_z = 8888
variable_infinite_pause = True
variable_kill_fan_on_pause = True
variable_present_use_default = True
variable_present_toolhead_x = 50
variable_present_toolhead_y = 50
variable_present_toolhead_z = 200
variable_present_speed = 60
variable_stow_toolhead_x = 323
variable_stow_toolhead_y = 340
variable_stow_toolhead_z = 20
variable_stow_speed = 60
variable_filament_change_park_x = 10
variable_filament_change_park_y = 10
variable_filament_change_park_min_z = 50
variable_load_length = 125
variable_load_purge_length = 25
variable_unload_length = 100
variable_unload_purge_length = 25
variable_start_my_print_already = False
variable_chamber_temp_wait = True
variable_post_print_cool = 25
variable_lo_temp_timer = 10
variable_hi_temp_timer = 15
variable_danger_will_robinson = False
variable_heater_neo = False
variable_heater_low = 55
variable_heater_mid = 75
variable_heater_high = 90
variable_nevermore_asa_abs_only = True
variable_nevermore_post_speed = 0.6
variable_nevermore_post_run_time = 5
variable_nevermore_post_timer = True
variable_nevermore_leave_running = False
variable_all_in_one_pi = False
variable_host_shutdown = False
variable_timeout_power = True
variable_feed_rate = 100
variable_printer_lights_print = 1
variable_printer_lights_finish = 0.2
variable_neopixel_off = True
variable_purge_lines = True
variable_purge_along_y = True
variable_start_x_position = 0.6
variable_start_y_position = 12
variable_purge_line_length = 150
variable_klicky_probe = False
variable_chamber_fan = False
variable_chamber_sensor = False
variable_chamber_heater = False
variable_bed_fans = False
variable_runout_sensor = True
variable_encoder_runout_sensor = False
variable_nevermore = False
variable_shutdown_relay = False
variable_printer_lights = False
variable_neopixel_led = False
variable_nozzle_cleaner = True
variable_purge_bucket = False
variable_aes_system = False
variable_screen_msg = "DEMONWARE Online"
variable_console_msg = "Welcome to Demon Essentials! Happy printing! These macros were written by a human, no AI was used in their creation!"
variable_demon_version = "2.9.5"
gcode = 

[gcode_macro _MESH_BUILDER_VARIABLES]
variable_mesh_pla_bed_temp = 60
variable_mesh_asa_bed_temp = 100
variable_mesh_abs_bed_temp = 100
variable_mesh_petg_bed_temp = 75
variable_mesh_tpu_bed_temp = 50
variable_lo_heat_soak_threshold = 22
variable_hi_heat_soak_threshold = 42
variable_mesh_lo_temp_timer = 10
variable_mesh_hi_temp_timer = 10
variable_use_bed_fans = False
gcode = 

[gcode_macro _Z_CALIBRATION_VARIABLES]
variable_noz_pre_temp = 180
variable_heat_soak_timer = 10
variable_heat_soak_threshold = 25
gcode = 

[mcu]
serial = /dev/serial/by-id/usb-Klipper_stm32f103xe_38FFDA053347533828642451-if00
restart_method = command

[mcu extra_mcu]
serial = /dev/serial/by-id/usb-Klipper_stm32f103xe_51FF6B064849824914310967-if00
restart_method = command

[mcu eddy]
serial = /dev/serial/by-id/usb-Klipper_rp2040_50445059389DA01C-if00@
restart_method = command

[probe_eddy_ng btt_eddy]
sensor_type = btt_eddy
i2c_mcu = eddy
i2c_bus = i2c0f
x_offset = -16
y_offset = 11.5

[temperature_sensor btt_eddy_mcu]
sensor_type = temperature_mcu
sensor_mcu = eddy
min_temp = 10
max_temp = 100

[temperature_sensor btt_eddy]
sensor_type = Generic 3950
sensor_pin = eddy:gpio26

[printer]
kinematics = corexy
max_velocity = 700
max_accel = 8200
max_accel_to_decel = 4500
max_z_velocity = 20
max_z_accel = 500
square_corner_velocity = 5.0

[stepper_x]
step_pin = PE2
dir_pin = !PE0
enable_pin = !PE3
rotation_distance = 40
microsteps = 16
full_steps_per_rotation = 200
endstop_pin = tmc2209_stepper_x: virtual_endstop
position_min = 0
position_endstop = 355
position_max = 355
homing_speed = 30
homing_retract_dist = 0
homing_positive_dir = True

[tmc2209 stepper_x]
uart_pin = PE1
interpolate = True
run_current = 1.1
sense_resistor = 0.150
stealthchop_threshold = 0
uart_address = 3
driver_sgthrs = 70
diag_pin = PE15

[stepper_y]
step_pin = PB8
dir_pin = !PB6
enable_pin = !PB9
rotation_distance = 40
microsteps = 16
full_steps_per_rotation = 200
endstop_pin = tmc2209_stepper_y: virtual_endstop
position_min = 0
position_endstop = 364
position_max = 364
homing_speed = 30
homing_retract_dist = 0
homing_positive_dir = true

[tmc2209 stepper_y]
uart_pin = PB7
interpolate = True
run_current = 1.1
sense_resistor = 0.150
stealthchop_threshold = 0
uart_address = 3
driver_sgthrs = 70
diag_pin = PE13

[stepper_z]
step_pin = PC0
dir_pin = PE5
enable_pin = !PC1
rotation_distance = 40
gear_ratio = 80:12
microsteps = 16
endstop_pin = probe:z_virtual_endstop
position_max = 347
position_min = -5
homing_speed = 15.0
homing_retract_dist = 5.0
homing_retract_speed = 15.0
second_homing_speed = 10.0

[tmc2209 stepper_z]
uart_pin = PE6
interpolate = true
run_current = 0.55
sense_resistor = 0.150
stealthchop_threshold = 999999
uart_address = 3

[stepper_z1]
step_pin = PD3
dir_pin = !PD1
enable_pin = !PD4
rotation_distance = 40
gear_ratio = 80:12
microsteps = 16

[tmc2209 stepper_z1]
uart_pin = PD2
interpolate = true
run_current = 0.55
sense_resistor = 0.150
stealthchop_threshold = 999999
uart_address = 3

[stepper_z2]
step_pin = PD7
dir_pin = PD5
enable_pin = !PB5
rotation_distance = 40
gear_ratio = 80:12
microsteps = 16

[tmc2209 stepper_z2]
uart_pin = PD6
interpolate = true
run_current = 0.55
sense_resistor = 0.150
stealthchop_threshold = 999999
uart_address = 3

[stepper_z3]
step_pin = PD11
dir_pin = !PD9
enable_pin = !PD12
rotation_distance = 40
gear_ratio = 80:12
microsteps = 16

[tmc2209 stepper_z3]
uart_pin = PD10
interpolate = true
run_current = 0.55
sense_resistor = 0.150
uart_address = 3
stealthchop_threshold = 999999

[thermistor my_thermistor_e]
temperature1 = 25
resistance1 = 110000
temperature2 = 100
resistance2 = 7008
temperature3 = 220
resistance3 = 435

[extruder]
step_pin = extra_mcu:PA8
dir_pin = extra_mcu:PB8
enable_pin = !extra_mcu: PB11
rotation_distance = 6.5
microsteps = 16
full_steps_per_rotation = 200
nozzle_diameter = 0.400
filament_diameter = 1.75
max_extrude_only_distance = 150
max_extrude_only_velocity = 15
max_extrude_cross_section = 5
heater_pin = extra_mcu:PB9
sensor_type = my_thermistor_e
pullup_resistor = 11500
sensor_pin = extra_mcu:PA5
min_temp = 5
max_temp = 305
max_power = 1.0
min_extrude_temp = 5
pressure_advance = 0.025
pressure_advance_smooth_time = 0.035
control = pid
pid_kp = 29.480
pid_ki = 2.656
pid_kd = 81.805

[tmc2209 extruder]
uart_pin = extra_mcu:PB10
interpolate = True
run_current = 0.8
uart_address = 3
sense_resistor = 0.150

[verify_heater extruder]
max_error = 120
check_gain_time = 30
hysteresis = 5
heating_gain = 2

[filament_switch_sensor filament_sensor]
pause_on_runout = True
event_delay = 3.0
pause_delay = 0.5
switch_pin = PE9

[thermistor my_thermistor]
temperature1 = 25
resistance1 = 100000
temperature2 = 50
resistance2 = 18085.4
temperature3 = 100
resistance3 = 5362.6

[heater_bed]
heater_pin = PA0
sensor_type = my_thermistor
sensor_pin = PC5
max_power = 1.0
min_temp = 5
max_temp = 105
control = pid
pid_kp = 64.154
pid_ki = 0.997
pid_kd = 1032.072

[verify_heater heater_bed]
max_error = 120
check_gain_time = 40
hysteresis = 5
heating_gain = 2

[probe]
pin = extra_mcu:PB6
x_offset = -17
y_offset = 10
z_offset = 2.412

[probe_pressure]
pin = ^!PE12
x_offset = 0
y_offset = 0
z_offset = 0
speed = 1.0

[bed_mesh]
speed = 350
horizontal_move_z = 5
mesh_min = 10,10
mesh_max = 333,340
probe_count = 11,11
algorithm = bicubic
bicubic_tension = 0.4
split_delta_z = 0.01
mesh_pps = 3,3
adaptive_margin = 5
fade_start = 0
fade_end = 10
fade_target = 0

[quad_gantry_level]
gantry_corners = 
	-60,-10
	410,420
points = 
	36,10
	36,320
	346,320
	346,10
speed = 350
horizontal_move_z = 5
retry_tolerance = 0.01
retries = 5
max_adjust = 10

[multi_pin fan_pins]
pins = extra_mcu:PA7, extra_mcu:PB1

[fan]
pin = multi_pin: fan_pins
max_power = 1.0
shutdown_speed = 0
kick_start_time = 0.5
off_below = 0.10

[controller_fan MCU_fan]
pin = PA1
max_power = 1
kick_start_time = 0.5
fan_speed = 1
idle_timeout = 300
heater = extruder, heater_bed
stepper = stepper_x, stepper_y

[heater_fan hotend_fan]
pin = extra_mcu:PA6
max_power = 1.0
kick_start_time = 0.5
heater = extruder
heater_temp = 50
tachometer_pin = extra_mcu:PA1
tachometer_ppr = 1
tachometer_poll_interval = 0.0013

[gcode_arcs]
resolution = 1.0

[output_pin Printer_Lights]
pin = PA3
pwm = 1
value = 1
cycle_time = 0.01
shutdown_value = 0

[temperature_sensor mcu_temp]
sensor_type = temperature_mcu
min_temp = 0
max_temp = 100

[temperature_sensor Host_temp]
sensor_type = temperature_host
min_temp = 0
max_temp = 110

[temperature_sensor Toolhead_Temp]
sensor_type = temperature_mcu
sensor_mcu = extra_mcu

[adxl345]
cs_pin = extra_mcu:PB12

[resonance_tester]
accel_chip = adxl345
probe_points = 
	175, 175, 30
accel_per_hz = 50
min_freq = 1
max_freq = 100
max_smoothing = 0.2
hz_per_sec = 0.5

[input_shaper]
damping_ratio_x = 0.001
damping_ratio_y = 0.001
shaper_type_x = mzv
shaper_freq_x = 35
shaper_type_y = mzv
shaper_freq_y = 35

[idle_timeout]
gcode = 
	_DEMON_IDLE_TIMEOUT
timeout = 3600

[exclude_object]

[bed_mesh default]
version = 1
points = 
	0.525938, 0.345938, 0.232500, 0.221250, 0.207188, 0.205313, 0.193125, 0.224063, 0.260625, 0.341250, 0.468750
	0.381563, 0.235313, 0.204375, 0.180938, 0.174375, 0.162188, 0.162188, 0.201563, 0.239063, 0.300000, 0.358125
	0.308438, 0.206250, 0.154688, 0.126563, 0.115313, 0.109688, 0.126563, 0.146250, 0.184688, 0.260625, 0.322500
	0.306563, 0.209063, 0.144375, 0.098438, 0.071250, 0.060000, 0.076875, 0.090938, 0.146250, 0.225938, 0.311250
	0.318750, 0.210938, 0.127500, 0.074063, 0.039375, 0.034688, 0.045938, 0.075938, 0.140625, 0.229688, 0.333750
	0.359063, 0.225000, 0.126563, 0.069375, 0.030000, 0.022500, 0.028125, 0.068438, 0.130313, 0.225938, 0.365625
	0.334688, 0.215625, 0.131250, 0.071250, 0.025313, 0.027188, 0.031875, 0.070313, 0.138750, 0.224063, 0.349688
	0.291563, 0.198750, 0.106875, 0.048750, 0.010313, -0.000937, -0.001875, 0.035625, 0.113438, 0.201563, 0.320625
	0.265313, 0.151875, 0.069375, 0.002813, -0.046875, -0.063750, -0.061875, -0.011250, 0.061875, 0.157500, 0.278438
	0.361875, 0.184688, 0.098438, 0.020625, -0.036562, -0.067500, -0.069375, -0.023437, 0.051563, 0.151875, 0.343125
	0.530625, 0.320625, 0.169688, 0.082500, 0.022500, 0.009375, 0.015938, 0.064688, 0.144375, 0.259688, 0.488438
x_count = 11
y_count = 11
mesh_x_pps = 3
mesh_y_pps = 3
algo = bicubic
tension = 0.4
min_x = 10.0
max_x = 332.9
min_y = 10.0
max_y = 340.0
=======================
Args: ['/home/biqu/klipper/klippy/klippy.py', '/home/biqu/printer_data/config/printer.cfg', '-I', '/home/biqu/printer_data/comms/klippy.serial', '-l', '/home/biqu/printer_data/logs/klippy.log', '-a', '/home/biqu/printer_data/comms/klippy.sock']
Git version: 'v0.13.0-51-gbfda326c-dirty'
Untracked files: klippy/extras/gcode_shell_command.py, klippy/extras/ldc1612_ng.py, klippy/extras/probe_eddy_ng.py, klippy/extras/probe_pressure.py, klippy/extras/z_offset_calibration.py
Modified files: klippy/extras/bed_mesh.py, src/Makefile
Branch: master
Remote: origin
Tracked URL: https://github.com/Klipper3d/klipper
CPU: 4 core ?
Python: '3.9.2 (default, Mar 20 2025, 02:07:39) \n[GCC 10.2.1 20210110]'
=============== Log rollover at Wed Nov 26 13:59:15 2025 ===============
===== Config file =====
[save_variables]
filename = ~/demon_vars.cfg

[gcode_macro _KAMP_Settings]
description = This macro contains all adjustable settings for KAMP
variable_verbose_enable = True
variable_purge_height = 0.8
variable_tip_distance = 5
variable_purge_margin = 20
variable_purge_amount = 30
variable_flow_rate = 12
variable_smart_park_height = 10
gcode = 
	
	{action_respond_info(" Running the KAMP_Settings macro does nothing, it is only used for storing KAMP settings. ")}

[gcode_macro LINE_PURGE]
description = A purge macro that adapts to be near your actual printed objects
gcode = 
	
	{% set travel_speed = (printer.toolhead.max_velocity) * 30 | float %}
	{% set cross_section = printer.configfile.settings.extruder.max_extrude_cross_section | float %}
	
	
	{% if printer.firmware_retraction is defined %}
	{% set RETRACT = G10 | string %}
	{% set UNRETRACT = G11 | string %}
	{% else %}
	{% set RETRACT = 'G1 E-.5 F2100' | string %}
	{% set UNRETRACT = 'G1 E.5 F2100' | string %}
	{% endif %}
	
	
	{% set verbose_enable = printer["gcode_macro _KAMP_Settings"].verbose_enable | abs %}
	{% set purge_height = printer["gcode_macro _KAMP_Settings"].purge_height | float %}
	{% set tip_distance = printer["gcode_macro _KAMP_Settings"].tip_distance | float %}
	{% set purge_margin = printer["gcode_macro _KAMP_Settings"].purge_margin | float %}
	{% set purge_amount = printer["gcode_macro _KAMP_Settings"].purge_amount | float %}
	{% set flow_rate = printer["gcode_macro _KAMP_Settings"].flow_rate | float %}
	
	
	
	{% set all_points = printer.exclude_object.objects | map(attribute='polygon') | sum(start=[]) %}
	{% set purge_x_min = (all_points | map(attribute=0) | min | default(0)) %}
	{% set purge_x_max = (all_points | map(attribute=0) | max | default(0)) %}
	{% set purge_y_min = (all_points | map(attribute=1) | min | default(0)) %}
	{% set purge_y_max = (all_points | map(attribute=1) | max | default(0)) %}
	
	{% set purge_x_center = ([((purge_x_max + purge_x_min) / 2) - (purge_amount / 2), 0] | max) %}
	{% set purge_y_center = ([((purge_y_max + purge_y_min) / 2) - (purge_amount / 2), 0] | max) %}
	
	{% set purge_x_origin = ([purge_x_min - purge_margin, 0] | max) %}
	{% set purge_y_origin = ([purge_y_min - purge_margin, 0] | max) %}
	
	
	{% set purge_move_speed = (flow_rate / 5.0) * 60 | float %}
	
	{% if cross_section < 5 %}
	
	{action_respond_info("[Extruder] max_extrude_cross_section is insufficient for purge, please set it to 5 or greater. Purge skipped.")}
	
	{% else %}
	
	{% if verbose_enable == True %}
	
	{action_respond_info("Moving filament tip {}mms".format(
	(tip_distance),
	)) }
	{% endif %}
	
	{% if printer.firmware_retraction is defined %}
	{action_respond_info("KAMP purge is using firmware retraction.")}
	{% else %}
	{action_respond_info("KAMP purge is not using firmware retraction, it is recommended to configure it.")}
	{% endif %}
	
	{% if purge_y_origin > 0 %}
	
	{action_respond_info("KAMP purge starting at {}, {} and purging {}mm of filament, requested flow rate is {}mm3/s.".format(
	(purge_x_center),
	(purge_y_origin),
	(purge_amount),
	(flow_rate),
	)) }
	
	{% else %}
	
	{action_respond_info("KAMP purge starting at {}, {} and purging {}mm of filament, requested flow rate is {}mm3/s.".format(
	(purge_x_origin),
	(purge_y_center),
	(purge_amount),
	(flow_rate),
	)) }
	
	{% endif %}
	
	SAVE_GCODE_STATE NAME=Prepurge_State
	
	{% if purge_y_origin > 0 %}
	
	G92 E0
	G0 F{travel_speed}
	G90
	G0 X{purge_x_center} Y{purge_y_origin}
	G0 Z{purge_height}
	M83
	G1 E{tip_distance} F{purge_move_speed}
	G1 X{purge_x_center + purge_amount} E{purge_amount} F{purge_move_speed}
	{RETRACT}
	G0 X{purge_x_center + purge_amount + 10} F{travel_speed}
	G92 E0
	M82
	G0 Z{purge_height * 2} F{travel_speed}
	
	{% else %}
	
	G92 E0
	G0 F{travel_speed}
	G90
	G0 X{purge_x_origin} Y{purge_y_center}
	G0 Z{purge_height}
	M83
	G1 E{tip_distance} F{purge_move_speed}
	G1 Y{purge_y_center + purge_amount} E{purge_amount} F{purge_move_speed}
	{RETRACT}
	G0 Y{purge_y_center + purge_amount + 10} F{travel_speed}
	G92 E0
	M82
	G0 Z{purge_height * 2} F{travel_speed}
	
	{% endif %}
	
	RESTORE_GCODE_STATE NAME=Prepurge_State
	
	{% endif %}

[gcode_macro SMART_PARK]
description = Parks your printhead near the print area for pre-print hotend heating.
gcode = 
	
	{% set kamp_settings = printer["gcode_macro _KAMP_Settings"] %}
	{% set z_height = kamp_settings.smart_park_height | float %}
	{% set purge_margin = kamp_settings.purge_margin | float %}
	{% set verbose_enable = kamp_settings.verbose_enable | abs %}
	{% set center_x = printer.toolhead.axis_maximum.x / 2 | float %}
	{% set center_y = printer.toolhead.axis_maximum.y / 2 | float %}
	{% set axis_minimum_x = printer.toolhead.axis_minimum.x | float %}
	{% set axis_minimum_y = printer.toolhead.axis_minimum.y | float %}
	{% set all_points = printer.exclude_object.objects | map(attribute='polygon') | sum(start=[]) %}
	{% set x_min = all_points | map(attribute=0) | min | default(center_x) %}
	{% set y_min = all_points | map(attribute=1) | min | default(center_y) %}
	{% set travel_speed = (printer.toolhead.max_velocity) * 30 | float %}
	
	{% if purge_margin > 0 and x_min != center_x and y_min != center_y %}
	{% set x_min = [ x_min - purge_margin , x_min ] | min %}
	{% set y_min = [ y_min - purge_margin , y_min ] | min %}
	{% set x_min = [ x_min , axis_minimum_x ] | max %}
	{% set y_min = [ y_min , axis_minimum_y ] | max %}
	{% endif %}
	
	
	{% if verbose_enable == True %}
	
	{ action_respond_info("Smart Park location: {},{}.".format(
	(x_min),
	(y_min),
	)) }
	
	{% endif %}
	
	SAVE_GCODE_STATE NAME=Presmartpark_State
	
	G90
	{% if printer.toolhead.position.z < z_height %}
	G0 Z{z_height}
	{% endif %}
	G0 X{x_min} Y{y_min} F{travel_speed}
	G0 Z{z_height}
	
	RESTORE_GCODE_STATE NAME=Presmartpark_State

[gcode_macro _WAIT_Variable]
variable_count = 300
variable_duration = 2
variable_waiting = False
gcode = 

[delayed_gcode WAIT_Delayed]
gcode = 
	{% set count = printer["gcode_macro _WAIT_Variable"].count|int %}
	{% set duration = printer["gcode_macro _WAIT_Variable"].duration|int %}
	M117 Heat soak Timer... {((duration * count) / 60)|round(1)} minutes left.
	SET_GCODE_VARIABLE MACRO=_WAIT_Variable VARIABLE=count VALUE={count-1}
	{% if count > 0 %} _WAIT_Loop  {% endif %}
	{% if count == 0 %}
	
	SET_GCODE_VARIABLE MACRO=_WAIT_Variable VARIABLE=waiting VALUE=False
	M118 Reached the end, do final action
	
	{% endif %}

[gcode_macro _WAIT_Loop]
gcode = 
	{% set count = printer["gcode_macro _WAIT_Variable"].count|int %}
	{% set duration = printer["gcode_macro _WAIT_Variable"].duration|int %}
	UPDATE_DELAYED_GCODE ID=WAIT_Delayed DURATION={duration}
	{% if  count % 2 == 0 %}
	SET_LED LED=Screen_Colour INDEX=1 RED=1 GREEN=0.2392 BLUE=0 WHITE=0
	SET_LED LED=Screen_Colour INDEX=2 RED=1 GREEN=0.2392 BLUE=0 WHITE=0
	SET_LED LED=Screen_Colour INDEX=3 RED=0.051 GREEN=0.0118 BLUE=0 WHITE=0
	
	
	{% else %}
	SET_LED LED=Screen_Colour INDEX=1 RED=1 GREEN=0.2392 BLUE=0 WHITE=0
	SET_LED LED=Screen_Colour INDEX=2 RED=0.051 GREEN=0.0118 BLUE=0 WHITE=0
	SET_LED LED=Screen_Colour INDEX=3 RED=1 GREEN=0.2392 BLUE=0 WHITE=0
	
	
	
	
	{% endif %}

[gcode_macro TIMER_Start]
gcode = 
	{% set MINUTES = params.MINUTES|default(15)|int %}
	{% set duration = printer["gcode_macro _WAIT_Variable"].duration|int %}
	{% set count = (MINUTES * 60) / duration %}
	SET_GCODE_VARIABLE MACRO=_WAIT_Variable VARIABLE=waiting VALUE=True
	SET_GCODE_VARIABLE MACRO=_WAIT_Variable VARIABLE=count VALUE={count}
	UPDATE_DELAYED_GCODE ID=WAIT_Delayed DURATION={duration}

[gcode_macro TIMER_Stop]
gcode = 
	{% if printer["gcode_macro _WAIT_Variable"].waiting %}
	M118 STOPPING LOOP, SETTING COUNT TO 0
	SET_GCODE_VARIABLE MACRO=_WAIT_Variable VARIABLE=count VALUE=0
	UPDATE_DELAYED_GCODE ID=WAIT_Delayed DURATION=1
	STATUS_READY
	
	{% else %}
	M118 Not in waiting state, nothing to do.
	{% endif %}

[gcode_macro _HEAT_WAIT]
description = Heating cycle waiting routine
gcode = 
	{% set MINUTES = params.MINUTES|default(10)|int %}
	{% set MSG = params.MSG|default("Heat Soak...")|string %}
	{% for i in range(0, MINUTES) %}
	M117 {MSG} {MINUTES-i} minute remaining.
	{% for s in range(0, 60) %}
	SET_LED LED=Screen_Colour INDEX=1 RED=1 GREEN=0.2392 BLUE=0 WHITE=0
	SET_LED LED=Screen_Colour INDEX=2 RED=1 GREEN=0.2392 BLUE=0 WHITE=0
	SET_LED LED=Screen_Colour INDEX=3 RED=0.051 GREEN=0.0118 BLUE=0 WHITE=0
	
	
	G4 P500
	SET_LED LED=Screen_Colour INDEX=1 RED=1 GREEN=0.2392 BLUE=0 WHITE=0
	SET_LED LED=Screen_Colour INDEX=2 RED=0.051 GREEN=0.0118 BLUE=0 WHITE=0
	SET_LED LED=Screen_Colour INDEX=3 RED=1 GREEN=0.2392 BLUE=0 WHITE=0
	
	
	
	G4 P500
	{% endfor %}
	{% endfor %}
	M117
	RESPOND TYPE=COMMAND MSG="{MSG} Finished."

[gcode_macro _LED_vars]
variable_colors = {
	'logo': {
	'busy': {'r': 0.4, 'g': 0.0, 'b': 0.0, 'w': 0.0},
	'cleaning': {'r': 0.0, 'g': 0.02, 'b': 0.5, 'w': 0.0},
	'calibrating_z': {'r': 1.0, 'g': 0.8, 'b': 0.0, 'w': 0.0},
	'heating': {'r': 0.2784, 'g': 0.0667, 'b': 0.0, 'w': 0.0},
	'homing': {'r': 0.0392, 'g': 0.6, 'b': 0.0, 'w': 0.0},
	'leveling': {'r': 0.5, 'g': 0.1, 'b': 0.4, 'w': 0.0},
	'meshing': {'r': 0.0, 'g': 1.0, 'b': 1.0, 'w': 0.0},
	'off': {'r': 0.0, 'g': 0.0, 'b': 0.0, 'w': 0.0},
	'printing': {'r': 1.0, 'g': 0.0, 'b': 0.0, 'w': 0.0},
	'standby': {'r': 0.6, 'g': 0.6, 'b': 0.6, 'w': 0.6},
	},
	'nozzle': {
	'heating': {'r': 0.2784, 'g': 0.0667, 'b': 0.0, 'w': 0.0},
	'off': {'r': 0.0, 'g': 0.0, 'b': 0.0, 'w': 0.0},
	'on': {'r': 0.8, 'g': 0.8, 'b': 0.8, 'w':1.0},
	'standby': {'r': 0.8, 'g': 0.8, 'b': 0.8, 'w':0.0},
	},
	'thermal': {
	'hot': {'r': 1.0, 'g': 0.0, 'b': 0.0, 'w': 0.0},
	'cold': {'r': 0.3, 'g': 0.0, 'b': 0.3, 'w': 0.0}
	}
	}
variable_logo_led_name = "Screen_Colour"
variable_logo_idx = "2,3"
variable_nozzle_led_name = "Screen_Colour"
variable_nozzle_idx = "1"
gcode = 

[gcode_macro _set_SCREEN_LEDs]
gcode = 
	{% set red = params.RED|default(0)|float %}
	{% set green = params.GREEN|default(0)|float %}
	{% set blue = params.BLUE|default(0)|float %}
	{% set white = params.WHITE|default(0)|float %}
	{% set led = params.LED|string %}
	{% set idx = (params.IDX|string).split(',') %}
	{% set transmit_last = params.TRANSMIT|default(1) %}
	
	{% for led_index in idx %}
	{% set transmit=transmit_last if loop.last else 0 %}
	set_led led={led} red={red} green={green} blue={blue} white={white} index={led_index} transmit={transmit}
	{% endfor %}

[gcode_macro _set_SCREEN_LEDs_by_name]
gcode = 
	{% set leds_name = params.LEDS %}
	{% set color_name = params.COLOR %}
	{% set color = printer["gcode_macro _LED_vars"].colors[leds_name][color_name] %}
	{% set led = printer["gcode_macro _LED_vars"][leds_name + "_led_name"] %}
	{% set idx = printer["gcode_macro _LED_vars"][leds_name + "_idx"] %}
	{% set transmit = params.TRANSMIT|default(1) %}
	
	_set_SCREEN_LEDs led={led} red={color.r} green={color.g} blue={color.b} white={color.w} idx="{idx}" transmit={transmit}

[gcode_macro _set_logo_leds]
gcode = 
	{% set red = params.RED|default(0)|float %}
	{% set green = params.GREEN|default(0)|float %}
	{% set blue = params.BLUE|default(0)|float %}
	{% set white = params.WHITE|default(0)|float %}
	{% set led = printer["gcode_macro _LED_vars"].logo_led_name %}
	{% set idx = printer["gcode_macro _LED_vars"].logo_idx %}
	{% set transmit=params.TRANSMIT|default(1) %}
	
	_set_SCREEN_LEDs led={led} red={red} green={green} blue={blue} white={white} idx="{idx}" transmit={transmit}

[gcode_macro _set_nozzle_leds]
gcode = 
	{% set red = params.RED|default(0)|float %}
	{% set green = params.GREEN|default(0)|float %}
	{% set blue = params.BLUE|default(0)|float %}
	{% set white = params.WHITE|default(0)|float %}
	{% set led = printer["gcode_macro _LED_vars"].nozzle_led_name %}
	{% set idx = printer["gcode_macro _LED_vars"].nozzle_idx %}
	{% set transmit=params.TRANSMIT|default(1) %}
	
	_set_SCREEN_LEDs led={led} red={red} green={green} blue={blue} white={white} idx="{idx}" transmit={transmit}

[gcode_macro set_logo_leds_off]
gcode = 
	{% set transmit=params.TRANSMIT|default(1) %}
	_set_logo_leds red=0 blue=0 green=0 white=0 transmit={transmit}

[gcode_macro set_nozzle_leds_on]
gcode = 
	{% set transmit=params.TRANSMIT|default(1) %}
	_set_SCREEN_LEDs_by_name leds="nozzle" color="on" transmit={transmit}

[gcode_macro set_nozzle_leds_off]
gcode = 
	{% set transmit=params.TRANSMIT|default(1) %}
	_set_SCREEN_LEDs_by_name leds="nozzle" color="off" transmit={transmit}

[gcode_macro status_off]
gcode = 
	set_logo_leds_off transmit=0
	set_nozzle_leds_off

[gcode_macro status_ready]
gcode = 
	_set_SCREEN_LEDs_by_name leds="logo" color="standby" transmit=0
	_set_SCREEN_LEDs_by_name leds="nozzle" color="standby" transmit=1

[gcode_macro status_busy]
gcode = 
	_set_SCREEN_LEDs_by_name leds="logo" color="busy" transmit=0
	set_nozzle_leds_on

[gcode_macro status_heating]
gcode = 
	_set_SCREEN_LEDs_by_name leds="logo" color="heating" transmit=0
	_set_SCREEN_LEDs_by_name leds="nozzle" color="heating" transmit=1

[gcode_macro status_leveling]
gcode = 
	_set_SCREEN_LEDs_by_name leds="logo" color="leveling" transmit=0
	set_nozzle_leds_on

[gcode_macro status_homing]
gcode = 
	_set_SCREEN_LEDs_by_name leds="logo" color="homing" transmit=0
	set_nozzle_leds_on

[gcode_macro status_cleaning]
gcode = 
	_set_SCREEN_LEDs_by_name leds="logo" color="cleaning" transmit=0
	set_nozzle_leds_on

[gcode_macro status_meshing]
gcode = 
	_set_SCREEN_LEDs_by_name leds="logo" color="meshing" transmit=0
	set_nozzle_leds_on

[gcode_macro status_calibrating_z]
gcode = 
	_set_SCREEN_LEDs_by_name leds="logo" color="calibrating_z" transmit=0
	set_nozzle_leds_on

[gcode_macro status_printing]
gcode = 
	_set_SCREEN_LEDs_by_name leds="logo" color="printing" transmit=0
	set_nozzle_leds_on

[gcode_shell_command demon_user_settings_file_extract]
command = /usr/bin/bash /home/biqu/printer_data/config/Demon_Klipper_Essentials_Unified/Other_Files/Demon_User_Files_Updater/Demon_User_Settings.sh
timeout = 10
verbose = True

[gcode_macro _DEMON_USER_SETTINGS_FILE_EXTRACT]
description = Extracts Demon Files
gcode = 
	{% set svv = printer.save_variables.variables %}
	
	RUN_SHELL_COMMAND CMD=demon_user_settings_file_extract
	M400
	RESPOND TYPE=command MSG="action:prompt_end"
	M400
	SAVE_VARIABLE VARIABLE=updated_settings VALUE=True
	M400
	RESTART

[gcode_macro _USER_SETTINGS_FILE_PROMPT]
gcode = 
	RESPOND TYPE=command MSG="action:prompt_begin Demon Klipper Essentials Update"
	RESPOND TYPE=command MSG="action:prompt_text I see you're using a new version! The Demon User Settings file needs extracting, click EXTRACT to continue. Files will be placed in a new directory called Demon_User_Files inside your config directory were you are free to edit them without dirtying the Demon install."
	RESPOND TYPE=command MSG="action:prompt_text Click CANCEL to do this manually by creating the directory & copying/editing the files yourself."
	RESPOND TYPE=command MSG="action:prompt_text If you EXTRACT & the directory/file already exist your current files will be moved to a new directory called Previous_Versions & will have numbered backups made if needed, you may need to refresh your browser to reveal new items. Klipper will restart."
	RESPOND TYPE=command MSG="action:prompt_text NOTE: You need to have installed Kiauh G-Code Shell Command Extension for this to work."
	RESPOND TYPE=command MSG="action:prompt_text WARNING! YOU MUST EDIT THE NEW FILE TO YOUR OLD VALUES, NEW FILES ARE AT DEFAULT VALUES!!!"
	RESPOND TYPE=command MSG="action:prompt_footer_button CANCEL|RESPOND TYPE=command MSG=action:prompt_end"
	RESPOND TYPE=command MSG="action:prompt_footer_button EXTRACT|_DEMON_USER_SETTINGS_FILE_EXTRACT|error"
	RESPOND TYPE=command MSG="action:prompt_show"

[gcode_shell_command demon_user_cleaner_file_extract]
command = /usr/bin/bash /home/biqu/printer_data/config/Demon_Klipper_Essentials_Unified/Other_Files/Demon_User_Files_Updater/Demon_User_Cleaner.sh
timeout = 10
verbose = True

[gcode_macro _DEMON_USER_CLEANER_FILE_EXTRACT]
description = Extracts Demon Files
gcode = 
	{% set svv = printer.save_variables.variables %}
	
	RUN_SHELL_COMMAND CMD=demon_user_cleaner_file_extract
	M400
	RESPOND TYPE=command MSG="action:prompt_end"
	M400
	SAVE_VARIABLE VARIABLE=updated_cleaner VALUE=True
	M400
	RESTART

[gcode_macro _USER_CLEANER_FILE_PROMPT]
gcode = 
	RESPOND TYPE=command MSG="action:prompt_begin Demon Klipper Essentials Update"
	RESPOND TYPE=command MSG="action:prompt_text I see you're using a new version! The Demon User Settings Cleaner Variables file needs extracting, click EXTRACT to continue. Files will be placed in a new directory called Demon_User_Files inside your config directory were you are free to edit them without dirtying the Demon install."
	RESPOND TYPE=command MSG="action:prompt_text Click CANCEL to do this manually by creating the directory & copying/editing the files yourself."
	RESPOND TYPE=command MSG="action:prompt_text If you EXTRACT & the directory/file already exist your current files will be moved to a new directory called Previous_Versions & will have numbered backups made if needed, you may need to refresh your browser to reveal new items. Klipper will restart."
	RESPOND TYPE=command MSG="action:prompt_text NOTE: You need to have installed Kiauh G-Code Shell Command Extension for this to work."
	RESPOND TYPE=command MSG="action:prompt_text WARNING! YOU MUST EDIT THE NEW FILE TO YOUR OLD VALUES, NEW FILES ARE AT DEFAULT VALUES!!!"
	RESPOND TYPE=command MSG="action:prompt_footer_button CANCEL|RESPOND TYPE=command MSG=action:prompt_end"
	RESPOND TYPE=command MSG="action:prompt_footer_button EXTRACT|_DEMON_USER_CLEANER_FILE_EXTRACT|error"
	RESPOND TYPE=command MSG="action:prompt_show"

[gcode_shell_command demon_user_expansion_file_extract]
command = /usr/bin/bash /home/biqu/printer_data/config/Demon_Klipper_Essentials_Unified/Other_Files/Demon_User_Files_Updater/Demon_User_Expansion.sh
timeout = 10
verbose = True

[gcode_macro _DEMON_USER_EXPANSION_FILE_EXTRACT]
description = Extracts Demon Files
gcode = 
	{% set svv = printer.save_variables.variables %}
	
	RUN_SHELL_COMMAND CMD=demon_user_expansion_file_extract
	M400
	RESPOND TYPE=command MSG="action:prompt_end"
	M400
	SAVE_VARIABLE VARIABLE=updated_expansion VALUE=True
	M400
	RESTART

[gcode_macro _USER_EXPANSION_FILE_PROMPT]
gcode = 
	RESPOND TYPE=command MSG="action:prompt_begin Demon Klipper Essentials Update"
	RESPOND TYPE=command MSG="action:prompt_text I see you're using a new version! The Demon User Custom Expansion file needs extracting, click EXTRACT to continue. Files will be placed in a new directory called Demon_User_Files inside your config directory were you are free to edit them without dirtying the Demon install."
	RESPOND TYPE=command MSG="action:prompt_text Click CANCEL to do this manually by creating the directory & copying/editing the files yourself."
	RESPOND TYPE=command MSG="action:prompt_text If you EXTRACT & the directory/file already exist your current files will be moved to a new directory called Previous_Versions & will have numbered backups made if needed, you may need to refresh your browser to reveal new items. Klipper will restart."
	RESPOND TYPE=command MSG="action:prompt_text NOTE: You need to have installed Kiauh G-Code Shell Command Extension for this to work."
	RESPOND TYPE=command MSG="action:prompt_text WARNING! YOU MUST EDIT THE NEW FILE TO YOUR OLD VALUES, NEW FILES ARE AT DEFAULT VALUES!!!"
	RESPOND TYPE=command MSG="action:prompt_footer_button CANCEL|RESPOND TYPE=command MSG=action:prompt_end"
	RESPOND TYPE=command MSG="action:prompt_footer_button EXTRACT|_DEMON_USER_EXPANSION_FILE_EXTRACT|error"
	RESPOND TYPE=command MSG="action:prompt_show"

[gcode_shell_command demon_prepare_user_files]
command = /usr/bin/bash /home/biqu/printer_data/config/Demon_Klipper_Essentials_Unified/Other_Files/Demon_User_Files_Updater/First_Boot_Demon_User_Files.sh
timeout = 10
verbose = True

[gcode_macro _PREPARE_USER_FILES]
description = Extracts Demon Files
gcode = 
	{% set svv = printer.save_variables.variables %}
	
	RUN_SHELL_COMMAND CMD=demon_prepare_user_files
	M400
	RESPOND TYPE=command MSG="action:prompt_end"
	M400
	SAVE_VARIABLE VARIABLE=first_boot VALUE=False
	SAVE_VARIABLE VARIABLE=first_boot_msg VALUE=True
	SAVE_VARIABLE VARIABLE=version_dvars_updated VALUE=False
	M400
	RESTART

[gcode_macro _USER_FILE_PROMPT]
gcode = 
	RESPOND TYPE=command MSG="action:prompt_begin Demon Klipper Essentials Update"
	RESPOND TYPE=command MSG="action:prompt_text I see you're new here! Welcome aboard! The Demon User Files need extracting, click EXTRACT to continue. Files will be placed in a new directory called Demon_User_Files inside your config directory were you are free to edit them without dirtying the Demon install."
	RESPOND TYPE=command MSG="action:prompt_text Click CANCEL to do this manually by creating the directory & copying/editing the files yourself."
	RESPOND TYPE=command MSG="action:prompt_text If you EXTRACT & the directory/file already exist your current files will be moved to a new directory called Previous_Versions & will have numbered backups made if needed, you may need to refresh your browser to reveal new items. Klipper will restart."
	RESPOND TYPE=command MSG="action:prompt_text NOTE: You need to have installed Kiauh G-Code Shell Command Extension for this to work."
	RESPOND TYPE=command MSG="action:prompt_text WARNING! YOU MUST EDIT THE NEW FILE TO YOUR OLD VALUES, NEW FILES ARE AT DEFAULT VALUES!!!"
	RESPOND TYPE=command MSG="action:prompt_footer_button CANCEL|RESPOND TYPE=command MSG=action:prompt_end"
	RESPOND TYPE=command MSG="action:prompt_footer_button EXTRACT|_PREPARE_USER_FILES|error"
	RESPOND TYPE=command MSG="action:prompt_show"

[gcode_shell_command demon_vars_file_extract]
command = /usr/bin/bash /home/biqu/printer_data/config/Demon_Klipper_Essentials_Unified/Other_Files/Demon_User_Files_Updater/Demon_Vars_Updater.sh
timeout = 10
verbose = True

[gcode_macro _DEMON_VARS_FILE_EXTRACT]
description = Extracts Demon Files
gcode = 
	{% set svv = printer.save_variables.variables %}
	
	RUN_SHELL_COMMAND CMD=demon_vars_file_extract
	M400
	RESPOND TYPE=command MSG="action:prompt_end"
	UPDATE_DELAYED_GCODE ID=_DVARS_SET DURATION=2
	G4 P3000
	RESTART

[gcode_macro _DEMON_VARS_PROMPT]
gcode = 
	RESPOND TYPE=command MSG="action:prompt_begin Demon Klipper Essentials Update"
	RESPOND TYPE=command MSG="action:prompt_text I see you're using a new version! The Demon_Vars file needs extracting, click EXTRACT to continue. The file will be updated."
	RESPOND TYPE=command MSG="action:prompt_text Click CANCEL to do this manually by copying the file yourself."
	RESPOND TYPE=command MSG="action:prompt_text NOTE: You need to have installed Kiauh G-Code Shell Command Extension for this to work."
	RESPOND TYPE=command MSG="action:prompt_text WARNING! YOU MUST EDIT THE NEW FILE TO YOUR OLD VALUES, NEW FILES ARE AT DEFAULT VALUES!!!"
	RESPOND TYPE=command MSG="action:prompt_footer_button CANCEL|RESPOND TYPE=command MSG=action:prompt_end"
	RESPOND TYPE=command MSG="action:prompt_footer_button EXTRACT|_DEMON_VARS_FILE_EXTRACT|error"
	RESPOND TYPE=command MSG="action:prompt_show"

[delayed_gcode _DVARS_SET]
gcode = 
	{% set svv = printer.save_variables.variables %}
	SAVE_VARIABLE VARIABLE=first_boot VALUE=False
	SAVE_VARIABLE VARIABLE=version_dvars_updated VALUE=True

[delayed_gcode _UPDATED]
initial_duration = 1
gcode = 
	{% set svv = printer.save_variables.variables %}
	
	{% if svv.first_boot != False %}
	SAVE_VARIABLE VARIABLE=using_shell VALUE=True
	RESPOND TYPE=COMMAND MSG="WARNING: Demon User Files not in new location."
	_EXTRACT_USER_FILES_CONFIRM
	
	{% else %}
	{% if svv.first_boot_msg != False %}
	SAVE_VARIABLE VARIABLE=first_boot_msg VALUE=False
	RESPOND TYPE=COMMAND MSG="WARNING: USER SETTINGS FILES HAVE BEEN EXTRACTED! Don't forget to use the include command to bring them into your system!"
	_USER_FILES_REMINDER
	{% endif %}
	
	{% if svv.updated_settings == True %}
	SAVE_VARIABLE VARIABLE=updated_settings VALUE=False
	RESPOND TYPE=COMMAND MSG="WARNING: USER SETTINGS FILE HAS BEEN UPDATED! Default settings are in effect, be sure to update your old values to this file!"
	_UPDATE_USER_SETTINGS_CONFIRM
	{% endif %}
	
	{% if svv.updated_cleaner == True %}
	SAVE_VARIABLE VARIABLE=updated_cleaner VALUE=False
	RESPOND TYPE=COMMAND MSG="WARNING: USER SETTINGS CLEANER VARIABLES FILE HAS BEEN UPDATED! Default settings are in effect, be sure to update your old values to this file!"
	_UPDATE_USER_CLEANER_CONFIRM
	{% endif %}
	
	{% if svv.updated_expansion == True %}
	SAVE_VARIABLE VARIABLE=updated_expansion VALUE=False
	RESPOND TYPE=COMMAND MSG="WARNING: USER CUSTOM EXANSIONS FILE HAS BEEN UPDATED! Default settings are in effect, be sure to update your old values to this file!"
	_UPDATE_USER_EXPANSION_CONFIRM
	{% endif %}
	
	{% if svv.version_dvars_updated == True %}
	SAVE_VARIABLE VARIABLE=version_dvars_updated VALUE=False
	RESPOND TYPE=COMMAND MSG="WARNING: Demon_Vars FILE HAS BEEN UPDATED! Default settings are in effect!"
	_UPDATE_DEMON_VARS_CONFIRM
	{% endif %}
	{% endif %}

[gcode_macro _EXTRACT_USER_FILES_CONFIRM]
gcode = 
	SAVE_VARIABLE VARIABLE=first_boot VALUE=False
	SAVE_VARIABLE VARIABLE=first_boot_msg VALUE=True
	SAVE_VARIABLE VARIABLE=version_dvars_updated VALUE=False
	RESPOND TYPE=command MSG="action:prompt_begin Demon Klipper Essentials Unified"
	RESPOND TYPE=command MSG="action:prompt_text CONGRATS: YOUR DEMON MACROS ARE ONLINE!"
	RESPOND TYPE=command MSG="action:prompt_text I see you're new here! Welcome aboard! You may need to refresh your browser to reveal new items. Don't forget to use the include command to bring them into your system!"
	RESPOND TYPE=command MSG="action:prompt_text Files are found in a new directories called Demon_Klipper_Essentials_Unified & Demon_User_Files inside your config directory."
	RESPOND TYPE=command MSG="action:prompt_text Don't forget to check you added the save_variables section in your printer.cfg! You NEED to do that for things to work correctly!"
	RESPOND TYPE=command MSG="action:prompt_footer_button LETS GET STARTED!|RESPOND TYPE=command MSG=action:prompt_end|error"
	RESPOND TYPE=command MSG="action:prompt_show"

[gcode_macro _USER_FILES_REMINDER]
gcode = 
	SAVE_VARIABLE VARIABLE=first_boot_msg VALUE=False
	RESPOND TYPE=command MSG="action:prompt_begin Demon Klipper Essentials Update"
	RESPOND TYPE=command MSG="action:prompt_text Just checking in, hope it's going well"
	RESPOND TYPE=command MSG="action:prompt_text Reminder, don't forget to use the include command for the new Demon_User_File directory!"
	RESPOND TYPE=command MSG="action:prompt_text Files are found in a new directory called Demon_User_Files inside your config directory."
	RESPOND TYPE=command MSG="action:prompt_footer_button YEAH GOT IT COVERED|RESPOND TYPE=command MSG=action:prompt_end|error"
	RESPOND TYPE=command MSG="action:prompt_show"

[gcode_macro _UPDATE_USER_SETTINGS_CONFIRM]
gcode = 
	RESPOND TYPE=command MSG="action:prompt_begin Demon Klipper Essentials Update"
	RESPOND TYPE=command MSG="action:prompt_text WARNING: The Demon User Settings file has been UPDATED! Default settings are in effect, be sure to update your old values to this file! Click CONFIRM to confirm you understand this!"
	RESPOND TYPE=command MSG="action:prompt_footer_button CONFIRM|RESPOND TYPE=command MSG=action:prompt_end|error"
	RESPOND TYPE=command MSG="action:prompt_show"

[gcode_macro _UPDATE_USER_CLEANER_CONFIRM]
gcode = 
	RESPOND TYPE=command MSG="action:prompt_begin Demon Klipper Essentials Update"
	RESPOND TYPE=command MSG="action:prompt_text WARNING: The Demon User Settings Cleaner Variables file has been UPDATED! Default settings are in effect, be sure to update your old values to this file! Click CONFIRM to confirm you understand this!"
	RESPOND TYPE=command MSG="action:prompt_footer_button CONFIRM|RESPOND TYPE=command MSG=action:prompt_end|error"
	RESPOND TYPE=command MSG="action:prompt_show"

[gcode_macro _UPDATE_USER_EXPANSION_CONFIRM]
gcode = 
	RESPOND TYPE=command MSG="action:prompt_begin Demon Klipper Essentials Update"
	RESPOND TYPE=command MSG="action:prompt_text WARNING: The Demon User Custom Expansions file has been UPDATED! Default settings are in effect, be sure to update your old values to this file! Click CONFIRM to confirm you understand this!"
	RESPOND TYPE=command MSG="action:prompt_footer_button CONFIRM|RESPOND TYPE=command MSG=action:prompt_end|error"
	RESPOND TYPE=command MSG="action:prompt_show"

[gcode_macro _UPDATE_DEMON_VARS_CONFIRM]
gcode = 
	RESPOND TYPE=command MSG="action:prompt_begin Demon Klipper Essentials Update"
	RESPOND TYPE=command MSG="action:prompt_text WARNING: The Demon_Vars file has been UPDATED! Default settings are in effect! Click CONFIRM to confirm you understand this!"
	
	RESPOND TYPE=command MSG="action:prompt_footer_button CONFIRM|RESPOND TYPE=command MSG=action:prompt_end|error"
	RESPOND TYPE=command MSG="action:prompt_show"

[gcode_shell_command disk_space_check]
command = /usr/bin/bash /home/biqu/printer_data/config/Demon_Klipper_Essentials_Unified/Other_Files/Demon_User_Files_Updater/Demon_Disk_Space_Checker.sh
timeout = 10
verbose = True

[gcode_macro _DISK_SPACE_CHECK]
description = Checks free space
gcode = 
	RUN_SHELL_COMMAND CMD=disk_space_check

[gcode_macro _LOW_SPACE_PROMPT]
gcode = 
	RESPOND TYPE=command MSG="action:prompt_begin DEMON_Disk_Space_Check!"
	RESPOND TYPE=command MSG="action:prompt_text WARNING: LOW STORAGE SPACE! Free up space now!"
	RESPOND TYPE=command MSG="action:prompt_footer_button GOT IT|RESPOND TYPE=command MSG=action:prompt_end|error"
	RESPOND TYPE=command MSG="action:prompt_show"

[virtual_sdcard]
path = ~/printer_data/gcodes
on_error_gcode = CANCEL_PRINT

[pause_resume]

[display_status]

[respond]

[gcode_macro CANCEL_PRINT]
description = 
rename_existing = CANCEL_PRINT_BASE
gcode = 
	{% set x_park = printer['gcode_macro _global_var'].cancel_park.x|float %}
	{% set y_park = printer['gcode_macro _global_var'].cancel_park.y|float %}
	{% set z_park = printer['gcode_macro _global_var'].cancel_park.z|float %}
	{% set z_lift_max = printer['gcode_macro _global_var'].z_maximum_lifting_distance %}
	{% set e_restract = printer['gcode_macro _global_var'].cancel_park.e|float %}
	{% set e_mintemp  = printer.configfile.settings['extruder'].min_extrude_temp %}
	
	CANCEL_PRINT_BASE
	
	M117 Print canceled!
	G91
	{% if printer['filament_switch_sensor filament_sensor'].enabled == True and
	printer['filament_switch_sensor filament_sensor'].filament_detected == True
	%}
	{% if (printer.extruder.target != 0 and printer.extruder.temperature >= printer.extruder.target) or
	printer.extruder.temperature >= e_mintemp
	%}
	G1 E-{e_restract} F500
	{% else %}
	{action_respond_info("Nozzle not hot enough")}
	{% endif %}
	{% endif %}
	
	{%if (printer.gcode_move.position.z + 10) < z_lift_max %}
	G1 Z+10 F3000
	{% else %}
	G1 Z+{(z_lift_max - printer.gcode_move.position.z)} F3000
	{% endif %}
	G90
	G1 X{x_park} Y{y_park} F9000
	
	TURN_OFF_HEATERS
	_ALL_FAN_OFF
	
	CLEAR_PAUSE
	M84 X Y Z E
	
	M117 Ready
	{action_respond_info("Cancel Print Success!")}
	SET_GCODE_VARIABLE MACRO=START_PRINT VARIABLE=state VALUE='"Prepare"'
	SET_GCODE_VARIABLE MACRO=START_PRINT VARIABLE=record_extruder_temp VALUE=0
	SET_GCODE_VARIABLE MACRO=START_PRINT VARIABLE=max_record_extruder_temp VALUE=0

[gcode_macro PAUSE]
description = Pause the actual running print
rename_existing = PAUSE_BASE
gcode = 
	{% if printer.pause_resume.is_paused == False %}
	{% set x_park = printer['gcode_macro _global_var'].pause_park.x|float %}
	{% set y_park = printer['gcode_macro _global_var'].pause_park.y|float %}
	{% set e_restract = printer['gcode_macro _global_var'].pause_park.e|float %}
	{% set z_lift_max = printer['gcode_macro _global_var'].z_maximum_lifting_distance %}
	
	{% set state = params.STATE if 'filament_change' in params.STATE else 'normal' %}
	
	{action_respond_info("Pause Print!")}
	
	PAUSE_BASE
	M117 Pause Print!!!
	G91
	{% if (printer.gcode_move.position.z + 5) < z_lift_max %}
	G1 Z+5 F3000
	{% else %}
	G1 Z+{(z_lift_max - printer.gcode_move.position.z)} F3000
	{% endif %}
	G90
	{% if printer.gcode_move.position.x != x_park and
	printer.gcode_move.position.y != y_park
	%}
	G1 X{x_park} Y{y_park} F{printer["gcode_macro _global_var"].pause_resume_travel_speed * 60}
	{% endif %}
	
	M104 S{printer.extruder.target}
	
	{% if state == 'normal' %}
	{% if (printer.extruder.temperature + 5 >= printer.extruder.target) and (printer.extruder.temperature >= printer.configfile.settings['extruder'].min_extrude_temp) %}
	{% if printer['filament_switch_sensor filament_sensor'].enabled == True and
	printer['filament_switch_sensor filament_sensor'].filament_detected == True
	%}
	G91
	G1 E-{e_restract} F300
	G90
	{% elif printer['filament_switch_sensor filament_sensor'].enabled == True and
	printer['filament_switch_sensor filament_sensor'].filament_detected != True %}
	G91
	G1 E+95 F300
	G1 E-10 F1500
	G1 E-20 F600
	M400
	G4 P3000
	G1 E-50 F300
	G90
	{% endif %}
	{% endif %}
	{% elif state == 'filament_change' %}
	{% if (printer.extruder.temperature + 5 >= printer.extruder.target) and (printer.extruder.temperature >= printer.configfile.settings['extruder'].min_extrude_temp) %}
	G91
	G1 E+25 F300
	G1 E-10 F1500
	G1 E-20 F600
	M400
	G4 P3000
	G1 E-50 F300
	G90
	{% endif %}
	{% endif %}
	{% endif %}
variable_state = 'normal'

[gcode_macro RESUME]
description = Pause the actual running print
rename_existing = RESUME_BASE
variable_last_extruder_temp = {'restore': False, 'temp': 0}
variable_restore_idle_timeout = 0
variable_idle_state = False
gcode = 
	{% set e_restract = printer['gcode_macro _global_var'].pause_park.e|float %}
	{% set extruder_target_temp = printer.extruder.target|int %}
	
	{% set state = params.STATE if 'filament_change' in params.STATE else 'normal' %}
	
	{% if state == 'filament_change' %}
	{% if printer["filament_switch_sensor filament_sensor"].enable == True and
	printer["filament_switch_sensor filament_sensor"].filament_detected != True
	%}
	{action_respond_info("Please Insert filament in Sensor!")}
	{% else %}
	{% if printer.extruder.temperature + 5 >= printer.extruder.target %}
	G91
	G1 E30 F300
	G1 E10 F150
	G90
	{% else %}
	M104 S{extruder_target_temp}
	{action_respond_info("Nozzle not hot enough!")}
	{action_respond_info("Nozzle heating...")}
	M109 S{extruder_target_temp}
	G91
	G1 E30 F300
	G1 E10 F150
	G90
	{% endif %}
	{action_respond_info("Print resumming!")}
	RESUME_BASE
	{% endif %}
	{% elif state == 'normal' %}
	{% if printer['filament_switch_sensor filament_sensor'].enable != True and
	printer['filament_switch_sensor filament_sensor'].filament_detected != True
	%}
	{action_respond_info("Please Insert filament in Sensor!")}
	{% else %}
	{action_respond_info("Print resumming!")}
	G91
	G1 E{e_restract} F300
	G90
	M117 Printing now!!!
	RESUME_BASE
	{% endif %}
	{% endif %}
variable_state = 'normal'

[gcode_macro SET_PAUSE_NEXT_LAYER]
description = Enable a pause if the next layer is reached
gcode = 
	{% set pause_next_layer = printer['gcode_macro SET_PRINT_STATS_INFO'].pause_next_layer %}
	{% set ENABLE = params.ENABLE|default(1)|int != 0 %}
	{% set MACRO = params.MACRO|default(pause_next_layer.call, True) %}
	SET_GCODE_VARIABLE MACRO=SET_PRINT_STATS_INFO VARIABLE=pause_next_layer VALUE="{{ 'enable': ENABLE, 'call': MACRO }}"

[gcode_macro SET_PAUSE_AT_LAYER]
description = Enable/disable a pause if a given layer number is reached
gcode = 
	{% set pause_at_layer = printer['gcode_macro SET_PRINT_STATS_INFO'].pause_at_layer %}
	{% set ENABLE = params.ENABLE|int != 0 if params.ENABLE is defined
	else params.LAYER is defined %}
	{% set LAYER = params.LAYER|default(pause_at_layer.layer)|int %}
	{% set MACRO = params.MACRO|default(pause_at_layer.call, True) %}
	SET_GCODE_VARIABLE MACRO=SET_PRINT_STATS_INFO VARIABLE=pause_at_layer VALUE="{{ 'enable': ENABLE, 'layer': LAYER, 'call': MACRO }}"

[gcode_macro SET_PRINT_STATS_INFO]
rename_existing = SET_PRINT_STATS_INFO_BASE
description = Overwrite, to get pause_next_layer and pause_at_layer feature
variable_pause_next_layer = { 'enable': False, 'call': "PAUSE" }
variable_pause_at_layer = { 'enable': False, 'layer': 0, 'call': "PAUSE" }
gcode = 
	{% if pause_next_layer.enable %}
	RESPOND TYPE=echo MSG='{"%s, forced by pause_next_layer" % pause_next_layer.call}'
	{pause_next_layer.call}
	SET_PAUSE_NEXT_LAYER ENABLE=0
	{% elif pause_at_layer.enable and params.CURRENT_LAYER is defined and params.CURRENT_LAYER|int == pause_at_layer.layer %}
	RESPOND TYPE=echo MSG='{"%s, forced by pause_at_layer [%d]" % (pause_at_layer.call, pause_at_layer.layer)}'
	{pause_at_layer.call}
	SET_PAUSE_AT_LAYER ENABLE=0
	{% endif %}
	SET_PRINT_STATS_INFO_BASE {rawparams}

[gcode_macro _TOOLHEAD_PARK_PAUSE_CANCEL]
description = Helper: park toolhead used in PAUSE and CANCEL_PRINT
gcode = 
	
	{% set client = printer['gcode_macro _CLIENT_VARIABLE']|default({}) %}
	{% set velocity = printer.configfile.settings.pause_resume.recover_velocity %}
	{% set use_custom     = client.use_custom_pos|default(false)|lower == 'true' %}
	{% set custom_park_x  = client.custom_park_x|default(0.0) %}
	{% set custom_park_y  = client.custom_park_y|default(0.0) %}
	{% set park_dz        = client.custom_park_dz|default(2.0)|abs %}
	{% set sp_hop         = client.speed_hop|default(15) * 60 %}
	{% set sp_move        = client.speed_move|default(velocity) * 60 %}
	
	{% set origin    = printer.gcode_move.homing_origin %}
	{% set act       = printer.gcode_move.gcode_position %}
	{% set max       = printer.toolhead.axis_maximum %}
	{% set cone      = printer.toolhead.cone_start_z|default(max.z) %}
	{% set round_bed = True if printer.configfile.settings.printer.kinematics is in ['delta','polar','rotary_delta','winch']
	else False %}
	
	{% set z_min = params.Z_MIN|default(0)|float %}
	{% set z_park = [[(act.z + park_dz), z_min]|max, (max.z - origin.z)]|min %}
	{% set x_park = params.X       if params.X is defined
	else custom_park_x  if use_custom
	else 0.0            if round_bed
	else (max.x - 5.0) %}
	{% set y_park = params.Y       if params.Y is defined
	else custom_park_y  if use_custom
	else (max.y - 5.0)  if round_bed and z_park < cone
	else 0.0            if round_bed
	else (max.y - 5.0) %}
	
	_CLIENT_RETRACT
	{% if "xyz" in printer.toolhead.homed_axes %}
	G90
	G1 Z{z_park} F{sp_hop}
	G1 X{x_park} Y{y_park} F{sp_move}
	{% if not printer.gcode_move.absolute_coordinates %} G91 {% endif %}
	{% else %}
	RESPOND TYPE=echo MSG='Printer not homed'
	{% endif %}

[gcode_macro _CLIENT_EXTRUDE]
description = Extrudes, if the extruder is hot enough
gcode = 
	
	{% set client = printer['gcode_macro _CLIENT_VARIABLE']|default({}) %}
	{% set use_fw_retract = (client.use_fw_retract|default(false)|lower == 'true') and (printer.firmware_retraction is defined) %}
	{% set length = params.LENGTH|default(client.unretract)|default(1.0)|float %}
	{% set speed = params.SPEED|default(client.speed_unretract)|default(35) %}
	{% set absolute_extrude = printer.gcode_move.absolute_extrude %}
	
	{% if printer.toolhead.extruder != '' %}
	{% if printer[printer.toolhead.extruder].can_extrude %}
	{% if use_fw_retract %}
	{% if length < 0 %}
	G10
	{% else %}
	G11
	{% endif %}
	{% else %}
	M83
	G1 E{length} F{(speed|float|abs) * 60}
	{% if absolute_extrude %}
	M82
	{% endif %}
	{% endif %}
	{% else %}
	RESPOND TYPE=echo MSG='{"\"%s\" not hot enough" % printer.toolhead.extruder}'
	{% endif %}
	{% endif %}

[gcode_macro _CLIENT_RETRACT]
description = Retracts, if the extruder is hot enough
gcode = 
	{% set client = printer['gcode_macro _CLIENT_VARIABLE']|default({}) %}
	{% set length = params.LENGTH|default(client.retract)|default(1.0)|float %}
	{% set speed = params.SPEED|default(client.speed_retract)|default(35) %}
	
	_CLIENT_EXTRUDE LENGTH=-{length|float|abs} SPEED={speed|float|abs}

[gcode_macro _CLIENT_LINEAR_MOVE]
description = Linear move with save and restore of the gcode state
gcode = 
	{% set x_move = "X" ~ params.X if params.X is defined else "" %}
	{% set y_move = "Y" ~ params.Y if params.Y is defined else "" %}
	{% set z_move = "Z" ~ params.Z if params.Z is defined else "" %}
	{% set e_move = "E" ~ params.E if params.E is defined else "" %}
	{% set rate = "F" ~ params.F if params.F is defined else "" %}
	{% set ABSOLUTE = params.ABSOLUTE | default(0) | int != 0 %}
	{% set ABSOLUTE_E = params.ABSOLUTE_E | default(0) | int != 0 %}
	SAVE_GCODE_STATE NAME=_client_movement
	{% if x_move or y_move or z_move %}
	G9{ 0 if ABSOLUTE else 1 }
	{% endif %}
	{% if e_move %}
	M8{ 2 if ABSOLUTE_E else 3 }
	{% endif %}
	G1 { x_move } { y_move } { z_move } { e_move } { rate }
	RESTORE_GCODE_STATE NAME=_client_movement

[gcode_macro _CLIENT_VARIABLE]
variable_use_custom_pos = False
variable_custom_park_x = 0.0
variable_custom_park_y = 0.0
variable_custom_park_dz = 2.0
variable_retract = 1.0
variable_cancel_retract = 5.0
variable_speed_retract = 35.0
variable_unretract = 1.0
variable_speed_unretract = 35.0
variable_speed_hop = 15.0
variable_speed_move = 100.0
variable_park_at_cancel = False
variable_park_at_cancel_x = None
variable_park_at_cancel_y = None
variable_use_fw_retract = False
variable_idle_timeout = 600
variable_runout_sensor = "filament_switch_sensor filament_sensor"
variable_user_pause_macro = "_DEMON_PAUSE"
variable_user_resume_macro = "_DEMON_RESUME"
variable_user_cancel_macro = "_DEMON_CANCEL"
gcode = 

[gcode_macro mainled_on]
gcode = 
	SET_LED LED=main_led WHITE=1

[gcode_macro mainled_off]
gcode = 
	SET_LED LED=main_led WHITE=0

[force_move]
enable_force_move = True

[gcode_macro _global_var]
variable_pause_park = {'x': 0, 'y': 0, 'z': 10, 'e': 1}
variable_cancel_park = {'x': 0, 'y': 350, 'z': 10, 'e': 1}
variable_z_maximum_lifting_distance = 345
variable_pause_resume_travel_speed = 150
variable_bed_mesh_calibrate_target_temp = 60
variable_load_filament_extruder_temp = 230
variable_heat_soak_time = 0
gcode = 

[gcode_macro START_PRINT]
description = 
variable_state = 'Prepare'
variable_record_extruder_temp = 0
variable_max_record_extruder_temp = 0
gcode = 
	{% set bedtemp = params.BED_TEMP|default(60)|int %}
	{% set hotendtemp = params.EXTRUDER_TEMP|default(230)|int %}
	{% set heatsoak = params.HEATSOAK|default(True)|int %}
	{% set heatsoak_time = printer['gcode_macro _global_var'].heat_soak_time|default(0)|int %}
	{% set mesh_name = "default" %}
	
	{% set extruder_target_temp = 125 %}
	
	{% set bed_target_temp = bedtemp|int %}
	
	M400
	
	CLEAR_PAUSE
	
	G90
	{% if state == 'Prepare' %}
	
	{action_respond_info("Prepare!")}
	
	{% if printer['filament_switch_sensor filament_sensor'].enable == True and
	printer['filament_switch_sensor filament_sensor'].filament_detected != True
	%}
	M117 No filament!
	{action_respond_info("Please Insert filament in Sensor!")}
	CANCEL_PRINT
	{% endif %}
	
	{% if printer.extruder.temperature < extruder_target_temp %}
	M117 Nozzle pre-heating...
	{action_respond_info("Nozzle pre-heating...")}
	M109 S{extruder_target_temp}
	{% endif %}
	
	{% if printer.toolhead.homed_axes|lower != "xyz" %}
	G28
	{% endif %}
	
	
	
	
	{action_respond_info("Check Heating!")}
	
	{% if printer.heater_bed.temperature < bed_target_temp %}
	M117 Bed heating...
	{action_respond_info("Bed heating...")}
	M190 S{bed_target_temp}
	{% endif %}
	
	M140 S{bed_target_temp}
	M104 S{extruder_target_temp}
	
	
	{% if heatsoak == True %}
	M117 Short Heat Soak
	G4 P{heatsoak_time * 60000}
	{% endif %}
	
	{% if printer.quad_gantry_level.applied|lower != 'true' %}
	M117 QGL
	QUAD_GANTRY_LEVEL_BASE
	M117 Home Z after QGL
	G28 Z
	
	
	{% endif %}
	
	
	M117 Bed Mesh
	BED_MESH_CALIBRATE_BASE ADAPTIVE=1
	
	
	M117 Final Heating...
	{action_respond_info("Final heating...")}
	M140 S{bedtemp}
	M104 S{hotendtemp}
	M190 S{bedtemp}
	M109 S{hotendtemp};wait for extruder temp
	
	SET_GCODE_VARIABLE MACRO=START_PRINT VARIABLE=state VALUE='"Start"'
	UPDATE_DELAYED_GCODE ID=_print_start_wait DURATION=0.5
	
	{% elif state == 'Start' %}
	M117 Printing
	{action_respond_info("Start!")}
	{% endif %}

[gcode_macro END_PRINT]
description = 
variable_state = 'normal'
gcode = 
	{% set z_max = printer['gcode_macro _global_var'].z_maximum_lifting_distance|int %}
	{% set e_mintemp  = printer.configfile.settings['extruder'].min_extrude_temp %}
	
	M400
	SET_GCODE_VARIABLE MACRO=START_PRINT VARIABLE=state VALUE='"Prepare"'
	SET_GCODE_VARIABLE MACRO=START_PRINT VARIABLE=record_extruder_temp VALUE=0
	SET_GCODE_VARIABLE MACRO=START_PRINT VARIABLE=max_record_extruder_temp VALUE=0
	
	M117 Done
	G91
	{% if printer['filament_switch_sensor filament_sensor'].enable == True and
	printer['filament_switch_sensor filament_sensor'].filament_detected == True
	%}
	{% if (printer.extruder.target != 0 and printer.extruder.temperature >= printer.extruder.target) or
	printer.extruder.temperature >= e_mintemp
	%}
	G1 E-2 F2700
	G1 E-2 Z0.2 F2400
	{% endif %}
	{% endif %}
	
	{% if (printer.gcode_move.position.z + 25) < z_max %}
	G1 Z+25 F3000
	{% else %}
	G1 Z+{(z_max - printer.gcode_move.position.z)} F3000
	{% endif %}
	G90
	G1 X0 Y360 F9000
	
	_ALL_FAN_OFF
	TURN_OFF_HEATERS
	
	M84 X Y Z E
	
	M220 S100
	M221 S100
	
	CLEAR_PAUSE
	
	{action_respond_info("Finish Print!")}

[gcode_macro _IDLE_TIMEOUT]
gcode = 
	{% if printer.print_stats.state == "paused" %}
	RESPOND TYPE=echo MSG="No operations in 10min!"
	{% else %}
	M84
	TURN_OFF_HEATERS
	{% endif %}

[delayed_gcode exhaust_fan_off]
gcode = 
	SET_FAN_SPEED FAN=exhaust_fan SPEED=0

[gcode_macro _ALL_FAN_OFF]
gcode = 
	M106 S0
	
	
	M107

[gcode_macro CLEAN_NOZZLE]
gcode = 
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	{% set clean_vars = printer["gcode_macro _CLEAN_VARIABLES"] %}
	{% set heat = params.HEAT_TO_CLEAN|default('No')|string %}
	{% set cool = params.COOL_AFTER_CLEAN|default('No')|string %}
	{% set cool_temp = params.COOL_TEMP|default(0)|int %}
	
	{% if clean_vars.have_you_set_this_up != True %}
	{action_raise_error("This error is caused by you not setting up this feature before first use. Check demon_user_settings file & set this feature up correctly for your printer!")}
	
	{% else %}
	
	{% if start_vars.nozzle_cleaner == True %}
	G90
	M83
	{% if heat|lower in ['yes', 'true'] %}
	{% if printer.print_stats.state not in ['printing', 'paused'] %}
	SET_DISPLAY_TEXT MSG="Heating to clean nozzle {clean_vars.nozzle_pre_temp}c"
	RESPOND TYPE=COMMAND MSG="Heating to clean nozzle {clean_vars.nozzle_pre_temp}c"
	SET_HEATER_TEMPERATURE HEATER=extruder TARGET={clean_vars.nozzle_pre_temp}
	TEMPERATURE_WAIT SENSOR=extruder MINIMUM={clean_vars.nozzle_pre_temp - 5} MAXIMUM={clean_vars.nozzle_pre_temp + 50}
	
	{% elif printer.print_stats.state in ['printing', 'paused'] %}
	SET_DISPLAY_TEXT MSG="Clean heating option denied, print in progress!"
	RESPOND TYPE=COMMAND MSG="Clean heating option denied, print in progress!"
	{% endif %}
	{% endif %}
	
	_CONDITIONAL_HOME
	
	SET_DISPLAY_TEXT MSG="Cleaning Nozzle"
	RESPOND TYPE=COMMAND MSG="Cleaning Nozzle"
	
	{% if start_vars.neopixel_led == True %}
	STATUS_CLEANING
	{% endif %}
	
	{% if clean_vars.random_clean_x == False and clean_vars.random_clean_y == False %}
	G0 X{clean_vars.linear_clean_start_x} Y{clean_vars.linear_clean_start_y} F{clean_vars.clean_travel_speed * 60|int}
	G0 Z{clean_vars.linear_clean_start_z} F4000
	M400
	
	{% if clean_vars.linear_clean_axis in ['X', 'x']|string %}
	{% for passes in range(1, (clean_vars.linear_pass_count)) %}
	_LINEAR_STEP_CONTROL_X
	{% endfor %}
	
	{% elif clean_vars.linear_clean_axis in ['Y', 'y']|string %}
	{% for passes in range(1, (clean_vars.linear_pass_count)) %}
	_LINEAR_STEP_CONTROL_Y
	{% endfor %}
	{% endif %}
	
	{% elif clean_vars.random_clean_x == True or clean_vars.random_clean_y == True %}
	
	G0 X{clean_vars.start_x} Y{clean_vars.start_y} F{clean_vars.clean_travel_speed * 60|int}
	G0 Z{clean_vars.start_z} F4000
	M400
	
	{% for passes in range(1, (clean_vars.pass_count)) %}
	_step_control
	{% endfor %}
	{% endif %}
	
	G0 Z{clean_vars.park_z} F4000
	{% if printer.print_stats.state != 'printing' %}
	G0 X{clean_vars.end_position_x} Y{clean_vars.end_position_y}
	G0 X{clean_vars.park_x} Y{clean_vars.park_y} Z{clean_vars.park_z} F4000
	{% endif %}
	M117
	M400
	{% if start_vars.neopixel_led == True %}
	STATUS_READY
	{% endif %}
	
	{% if cool|lower in ['yes', 'true'] %}
	{% if printer.print_stats.state not in ['printing', 'paused'] %}
	SET_DISPLAY_TEXT MSG="Post nozzle clean cooling to {cool_temp}c"
	RESPOND TYPE=COMMAND MSG="Post nozzle clean cooling to {cool_temp}c"
	SET_HEATER_TEMPERATURE HEATER=extruder TARGET={cool_temp}
	M117
	
	{% elif printer.print_stats.state in ['printing', 'paused'] %}
	SET_DISPLAY_TEXT MSG="Cooling denied, print in progress!"
	RESPOND TYPE=COMMAND MSG="Cooling denied, print in progress!"
	{% endif %}
	{% endif %}
	
	_SAVE
	
	{% else %}
	{action_raise_error("This error is caused by the nozzle_cleaner variable not being enabled, check the demon_user_settings file!")}
	{% endif %}
	
	{% endif %}

[gcode_macro CENTER]
gcode = 
	G0  X175 Y175 F5000

[gcode_macro _CALIBRATION_ZOFFSET]
gcode = 
	M117 Calibrate Offset
	QUAD_GANTRY_LEVEL
	M140 S65
	G4 P500
	CLEAN_NOZZLE
	G4 P500
	M117 Z-offset calibration
	Z_OFFSET_CALIBRATION
	Z_OFFSET_APPLY_PROBE
	M400
	G4 P3000
	SAVE_CONFIG

[delayed_gcode _auto_zoffset]
gcode = 
	SAVE_VARIABLE VARIABLE=offsetadjust VALUE={'%05.2f' % (0)}
	_CALIBRATION_ZOFFSET

[gcode_macro _Delay_Calibrate]
gcode = 
	UPDATE_DELAYED_GCODE ID=_auto_zoffset DURATION=1.0

[delayed_gcode TEST_BELT]
initial_duration = 0.3
gcode = 
	{% set x_freq = printer.save_variables.variables.x_freq|float %}
	{% set y_freq = printer.save_variables.variables.y_freq|float %}
	{% set show_freq = printer.save_variables.variables.show_freq %}
	{% if show_freq == 1 %}
	M117 x {x_freq}, y {y_freq}
	SAVE_VARIABLE VARIABLE=show_freq VALUE=0
	{% endif %}

[gcode_macro QUAD_GANTRY_LEVEL]
rename_existing = QUAD_GANTRY_LEVEL_BASE
gcode = 
	{% set mesh_name = "default" %}
	{% set mesh_calibrate_temp = printer['gcode_macro _global_var'].bed_mesh_calibrate_target_temp|int %}
	{% set current_target_temp  = printer.heater_bed.target|int %}
	
	{action_respond_info("Check Heating!")}
	{% if printer.heater_bed.temperature != mesh_calibrate_temp %}
	{action_respond_info("The bed target temperature was not reached!")}
	{action_respond_info("Bed heating...")}
	{% if current_target_temp <= mesh_calibrate_temp %}
	M190 S{mesh_calibrate_temp}
	{% else %}
	M190 S{current_target_temp}
	{% endif %}
	{% endif %}
	
	{% if printer.toolhead.homed_axes|lower != "xyz" %}
	G28
	{% endif %}
	
	QUAD_GANTRY_LEVEL_BASE
	
	{% if current_target_temp == 0 %}
	M140 S0
	{% endif %}

[gcode_macro PROBE_CALIBRATE]
rename_existing = PROBE_CALIBRATE_BASE
gcode = 
	{% set current_target_temp  = printer.heater_bed.target|int %}
	{% set z_offset_calibrate_temp = printer['gcode_macro _global_var'].bed_mesh_calibrate_target_temp|int %}
	
	{action_respond_info("z_offset_calibrate")}
	{% if printer.heater_bed.temperature != z_offset_calibrate_temp %}
	M140 S{z_offset_calibrate_temp}
	{action_respond_info("The bed target temperature was not reached!")}
	{action_respond_info("Bed heating...")}
	M190 S{z_offset_calibrate_temp}
	{% endif %}
	
	G28
	PROBE_CALIBRATE_BASE
	TESTZ z=-4

[gcode_macro BED_MESH_CALIBRATE]
rename_existing = BED_MESH_CALIBRATE_BASE
gcode = 
	
	{% set mesh_name = "default" %}
	{% set mesh_calibrate_temp = printer['gcode_macro _global_var'].bed_mesh_calibrate_target_temp|int %}
	{% set current_target_temp  = printer.heater_bed.target|int %}
	
	{action_respond_info("Check Heating!")}
	{% if printer.heater_bed.temperature != mesh_calibrate_temp %}
	{action_respond_info("The bed target temperature was not reached!")}
	{action_respond_info("Bed heating...")}
	{% if current_target_temp <= mesh_calibrate_temp %}
	M190 S{mesh_calibrate_temp}
	{% else %}
	M190 S{current_target_temp}
	{% endif %}
	{% endif %}
	
	{% if printer.toolhead.homed_axes|lower != "xyz" %}
	G28
	{% endif %}
	
	BED_MESH_CLEAR
	
	BED_MESH_CALIBRATE_BASE ADAPTIVE=1
	
	{% if current_target_temp == 0 %}
	M140 S0
	{% endif %}

[gcode_macro G34]
gcode = 
	BED_MESH_CLEAR
	{% if printer.toolhead.homed_axes|lower != "xyz" %}
	G28
	{% else %}
	G28 Z
	{% endif %}
	QUAD_GANTRY_LEVEL
	G28 Z
	G0 X175 Y175 Z30 F3600

[delayed_gcode bed_mesh_init]
initial_duration = .01
gcode = 
	BED_MESH_PROFILE LOAD=default

[delayed_gcode _print_start_wait]
gcode = 
	{% if printer['gcode_macro START_PRINT'].state == 'Heating'%}
	{action_respond_info("Prepare->Heating!")}
	{% elif printer['gcode_macro START_PRINT'].state == 'Start' %}
	{action_respond_info("Heating->Start!")}
	{% endif %}
	
	{% if printer['gcode_macro START_PRINT'].execute|lower != 'false' %}
	START_PRINT
	{% endif %}

[delayed_gcode _resume_wait]
gcode = 
	{% if printer['gcode_macro RESUME'].execute|lower != 'false' %}
	RESUME
	{% endif %}

[gcode_macro LOAD_FILAMENT]
gcode = 
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	{% set core_vars = printer["gcode_macro _CORE_VARS"] %}
	{% set ceal = printer["gcode_macro CUSTOM_EXPANSION_ACTIVE_LIST"] %}
	{% set speed = params.SPEED_MMsec|default(7)|float * 60 %}
	{% set temp = params.TEMP|default(250)|int %}
	{% set cool = params.COOL|default('No')|string %}
	{% set cool_temp = params.COOL_TEMP|default(160)|int %}
	{% set max_velocity = printer.configfile.settings['extruder'].max_extrude_only_velocity * 60 %}
	
	_MAX_EXTRUDE_CHECK
	
	SAVE_GCODE_STATE NAME=load_state
	
	_ENCODER_FEED_CHECK_PREP
	M400
	
	{% if ceal.ceal_master_enable == True %}
	{% if ceal.pre_load == True %}
	_CUSTOM_PRE_LOAD {rawparams}
	{% endif %}
	{% endif %}
	
	{% if printer.print_stats.state not in ['printing', 'paused'] %}
	{% if "xyz" not in printer.toolhead.homed_axes %}
	{% if core_vars.last_known_z|float < 50|float %}
	Z_ASCENDER HEIGHT={(50 - core_vars.last_known_z|float)}
	{% endif %}
	
	{% else %}
	{% if printer.toolhead.position.z|float < start_vars.filament_change_park_min_z|float %}
	G90
	G0 Z{start_vars.filament_change_park_min_z} F3600
	{% endif %}
	G0 X{start_vars.filament_change_park_x} Y{start_vars.filament_change_park_y} F9000
	{% endif %}
	
	SET_DISPLAY_TEXT MSG="Load hotend heating..."
	RESPOND TYPE=COMMAND MSG="Load hotend heating..."
	SET_HEATER_TEMPERATURE HEATER=extruder TARGET={temp}
	TEMPERATURE_WAIT SENSOR=extruder MINIMUM={temp|int -2} MAXIMUM={temp|int + 5}
	M117
	{% endif %}
	
	M83
	G92 E0
	G1 E{start_vars.load_length} F{max_velocity}
	M400
	_ENCODER_FEED_CHECK
	
	G1 E{start_vars.load_purge_length} F{speed}
	
	
	{% if cool|lower in ['yes', 'true'] %}
	{% if printer.print_stats.state not in ['printing', 'paused'] and (temp >= printer.configfile.settings['extruder'].min_extrude_temp) %}
	SET_DISPLAY_TEXT MSG="Post load hotend cooling..."
	RESPOND TYPE=COMMAND MSG="Post load hotend cooling..."
	SET_HEATER_TEMPERATURE HEATER=extruder TARGET={cool_temp}
	
	
	
	M117
	
	{% elif printer.print_stats.state in ['printing', 'paused'] %}
	SET_DISPLAY_TEXT MSG="Load cooling denied, print in progress!"
	RESPOND TYPE=COMMAND MSG="Load cooling denied, print in progress!"
	{% endif %}
	{% endif %}
	
	{% if ceal.ceal_master_enable == True %}
	{% if ceal.post_load == True %}
	_CUSTOM_POST_LOAD {rawparams}
	{% endif %}
	{% endif %}
	
	RESTORE_GCODE_STATE NAME=load_state
	{% if "xyz" in printer.toolhead.homed_axes %}
	_SAVE
	{% endif %}

[gcode_macro UNLOAD_FILAMENT]
gcode = 
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	{% set core_vars = printer["gcode_macro _CORE_VARS"] %}
	{% set ceal = printer["gcode_macro CUSTOM_EXPANSION_ACTIVE_LIST"] %}
	{% set speed = params.SPEED_MMsec|default(7)|float * 60 %}
	{% set temp = params.TEMP|default(250)|int %}
	{% set cool = params.COOL|default('No')|string %}
	{% set cool_temp = params.COOL_TEMP|default(160)|int %}
	{% set max_velocity = printer.configfile.settings['extruder'].max_extrude_only_velocity * 60 %}
	
	_MAX_EXTRUDE_CHECK
	
	SAVE_GCODE_STATE NAME=unload_state
	
	_ENCODER_FEED_CHECK_PREP
	M400
	
	{% if ceal.ceal_master_enable == True %}
	{% if ceal.pre_unload == True %}
	_CUSTOM_PRE_UNLOAD {rawparams}
	{% endif %}
	{% endif %}
	
	{% if printer.print_stats.state not in ['printing', 'paused'] %}
	{% if "xyz" not in printer.toolhead.homed_axes %}
	{% if core_vars.last_known_z|float < 50|float %}
	Z_ASCENDER HEIGHT={(50 - core_vars.last_known_z|float)}
	{% endif %}
	
	{% else %}
	{% if printer.toolhead.position.z|float < start_vars.filament_change_park_min_z|float %}
	G90
	G0 Z{start_vars.filament_change_park_min_z} F3600
	{% endif %}
	G0 X{start_vars.filament_change_park_x} Y{start_vars.filament_change_park_y} F9000
	{% endif %}
	
	SET_DISPLAY_TEXT MSG="Unload hotend heating..."
	RESPOND TYPE=COMMAND MSG="Unload hotend heating..."
	SET_HEATER_TEMPERATURE HEATER=extruder TARGET={temp}
	TEMPERATURE_WAIT SENSOR=extruder MINIMUM={temp|int -2} MAXIMUM={temp|int + 5}
	M117
	{% endif %}
	
	M83
	G92 E0
	G1 E{start_vars.unload_purge_length} F{speed}
	M400
	_ENCODER_FEED_CHECK
	G1 E-5 F{max_velocity}
	G4 P8000
	
	G1 E-{start_vars.unload_length} F{max_velocity}
	
	{% if cool|lower in ['yes', 'true'] %}
	{% if printer.print_stats.state not in ['printing', 'paused'] and (temp >= printer.configfile.settings['extruder'].min_extrude_temp) %}
	SET_DISPLAY_TEXT MSG="Post unload hotend cooling..."
	RESPOND TYPE=COMMAND MSG="Post unload hotend cooling..."
	SET_HEATER_TEMPERATURE HEATER=extruder TARGET={cool_temp}
	
	
	
	M117
	
	{% elif printer.print_stats.state in ['printing', 'paused'] %}
	SET_DISPLAY_TEXT MSG="Unload cooling denied, print in progress!"
	RESPOND TYPE=COMMAND MSG="Unload cooling denied, print in progress!"
	{% endif %}
	{% endif %}
	
	{% if ceal.ceal_master_enable == True %}
	{% if ceal.post_unload == True %}
	_CUSTOM_POST_UNLOAD {rawparams}
	{% endif %}
	{% endif %}
	
	RESTORE_GCODE_STATE NAME=unload_state
	{% if "xyz" in printer.toolhead.homed_axes %}
	_SAVE
	{% endif %}

[gcode_macro M109]
rename_existing = M99109
gcode = 
	{% set s = params.S|float %}
	M104 {% for p in params %}{'%s%s' % (p, params[p])}{% endfor %}
	{% if s != 0 %}
	TEMPERATURE_WAIT SENSOR=extruder MINIMUM={s-1} MAXIMUM={s+1}
	{% endif %}

[gcode_macro M190]
rename_existing = M99190
gcode = 
	{% set s = params.S|float %}
	M140 {% for p in params %}{'%s%s' % (p, params[p])}{% endfor %}
	{% if s != 0 %}
	TEMPERATURE_WAIT SENSOR=heater_bed MINIMUM={s-1} MAXIMUM={s+1}
	{% endif %}

[gcode_macro M600]
gcode = 
	PAUSE STATE=filament_change

[gcode_macro GET_TIMELAPSE_SETUP]
description = Print the Timelapse setup
gcode = 
	{% set tl = printer['gcode_macro TIMELAPSE_TAKE_FRAME'] %}
	{% set output_txt = ["Timelapse Setup:"] %}
	{% set _dummy = output_txt.append("enable: %s" % tl.enable) %}
	{% set _dummy = output_txt.append("park: %s" % tl.park.enable) %}
	{% if tl.park.enable %}
	{% set _dummy = output_txt.append("park position: %s time: %s s" % (tl.park.pos, tl.park.time)) %}
	{% set _dummy = output_txt.append("park cord x:%s y:%s dz:%s" % (tl.park.coord.x, tl.park.coord.y, tl.park.coord.dz)) %}
	{% set _dummy = output_txt.append("travel speed: %s mm/s" % tl.speed.travel) %}
	{% endif %}
	{% set _dummy = output_txt.append("fw_retract: %s" % tl.extruder.fw_retract) %}
	{% if not tl.extruder.fw_retract %}
	{% set _dummy = output_txt.append("retract: %s mm speed: %s mm/s" % (tl.extruder.retract, tl.speed.retract)) %}
	{% set _dummy = output_txt.append("extrude: %s mm speed: %s mm/s" % (tl.extruder.extrude, tl.speed.extrude)) %}
	{% endif %}
	{% set _dummy = output_txt.append("verbose: %s" % tl.verbose) %}
	{action_respond_info(output_txt|join("\n"))}

[gcode_macro _SET_TIMELAPSE_SETUP]
description = Set user parameters for timelapse
gcode = 
	{% set tl = printer['gcode_macro TIMELAPSE_TAKE_FRAME'] %}
	
	{% set min = printer.toolhead.axis_minimum %}
	{% set max = printer.toolhead.axis_maximum %}
	{% set round_bed = True if printer.configfile.settings.printer.kinematics is in ['delta','polar','rotary_delta','winch']
	else False %}
	{% set park = {'min'   : {'x': (min.x / 1.42)|round(3) if round_bed else min.x|round(3),
	'y': (min.y / 1.42)|round(3) if round_bed else min.y|round(3)},
	'max'   : {'x': (max.x / 1.42)|round(3) if round_bed else max.x|round(3),
	'y': (max.y / 1.42)|round(3) if round_bed else max.y|round(3)},
	'center': {'x': (max.x-(max.x-min.x)/2)|round(3),
	'y': (max.y-(max.y-min.y)/2)|round(3)}} %}
	
	{% if params.ENABLE %}
	{% if params.ENABLE|lower is in ['true', 'false'] %}
	SET_GCODE_VARIABLE MACRO=TIMELAPSE_TAKE_FRAME VARIABLE=enable VALUE={True if params.ENABLE|lower == 'true' else False}
	{% else %}
	{action_raise_error("ENABLE=%s not supported. Allowed values are [True, False]" % params.ENABLE|capitalize)}
	{% endif %}
	{% endif %}
	{% if params.VERBOSE %}
	{% if params.VERBOSE|lower is in ['true', 'false'] %}
	SET_GCODE_VARIABLE MACRO=TIMELAPSE_TAKE_FRAME VARIABLE=verbose VALUE={True if params.VERBOSE|lower == 'true' else False}
	{% else %}
	{action_raise_error("VERBOSE=%s not supported. Allowed values are [True, False]" % params.VERBOSE|capitalize)}
	{% endif %}
	{% endif %}
	{% if params.CUSTOM_POS_X %}
	{% if params.CUSTOM_POS_X|float >= min.x and params.CUSTOM_POS_X|float <= max.x %}
	{% set _dummy = tl.park.custom.update({'x':params.CUSTOM_POS_X|float|round(3)}) %}
	{% else %}
	{action_raise_error("CUSTOM_POS_X=%s must be within [%s - %s]" % (params.CUSTOM_POS_X, min.x, max.x))}
	{% endif %}
	{% endif %}
	{% if params.CUSTOM_POS_Y %}
	{% if params.CUSTOM_POS_Y|float >= min.y and params.CUSTOM_POS_Y|float <= max.y %}
	{% set _dummy = tl.park.custom.update({'y':params.CUSTOM_POS_Y|float|round(3)}) %}
	{% else %}
	{action_raise_error("CUSTOM_POS_Y=%s must be within [%s - %s]" % (params.CUSTOM_POS_Y, min.y, max.y))}
	{% endif %}
	{% endif %}
	{% if params.CUSTOM_POS_DZ %}
	{% if params.CUSTOM_POS_DZ|float >= min.z and params.CUSTOM_POS_DZ|float <= max.z %}
	{% set _dummy = tl.park.custom.update({'dz':params.CUSTOM_POS_DZ|float|round(3)}) %}
	{% else %}
	{action_raise_error("CUSTOM_POS_DZ=%s must be within [%s - %s]" % (params.CUSTOM_POS_DZ, min.z, max.z))}
	{% endif %}
	{% endif %}
	{% if params.PARK_ENABLE %}
	{% if params.PARK_ENABLE|lower is in ['true', 'false'] %}
	{% set _dummy = tl.park.update({'enable':True if params.PARK_ENABLE|lower == 'true' else False}) %}
	{% else %}
	{action_raise_error("PARK_ENABLE=%s not supported. Allowed values are [True, False]" % params.PARK_ENABLE|capitalize)}
	{% endif %}
	{% endif %}
	{% if params.PARK_POS %}
	{% if params.PARK_POS|lower is in ['center','front_left','front_right','back_left','back_right','custom','x_only','y_only'] %}
	{% set dic = {'center'      : {'x': park.center.x   , 'y': park.center.y   , 'dz': 1                },
	'front_left'  : {'x': park.min.x      , 'y': park.min.y      , 'dz': 0                },
	'front_right' : {'x': park.max.x      , 'y': park.min.y      , 'dz': 0                },
	'back_left'   : {'x': park.min.x      , 'y': park.max.y      , 'dz': 0                },
	'back_right'  : {'x': park.max.x      , 'y': park.max.y      , 'dz': 0                },
	'custom'      : {'x': tl.park.custom.x, 'y': tl.park.custom.y, 'dz': tl.park.custom.dz},
	'x_only'      : {'x': tl.park.custom.x, 'y': 'none'          , 'dz': tl.park.custom.dz},
	'y_only'      : {'x': 'none'          , 'y': tl.park.custom.y, 'dz': tl.park.custom.dz}} %}
	{% set _dummy = tl.park.update({'pos':params.PARK_POS|lower}) %}
	{% set _dummy = tl.park.update({'coord':dic[tl.park.pos]}) %}
	{% else %}
	{action_raise_error("PARK_POS=%s not supported. Allowed values are [CENTER, FRONT_LEFT, FRONT_RIGHT, BACK_LEFT, BACK_RIGHT, CUSTOM, X_ONLY, Y_ONLY]"
	% params.PARK_POS|upper)}
	{% endif %}
	{% endif %}
	{% if params.PARK_TIME %}
	{% if params.PARK_TIME|float >= 0.0 %}
	{% set _dummy = tl.park.update({'time':params.PARK_TIME|float|round(3)}) %}
	{% else %}
	{action_raise_error("PARK_TIME=%s must be a positive number" % params.PARK_TIME)}
	{% endif %}
	{% endif %}
	SET_GCODE_VARIABLE MACRO=TIMELAPSE_TAKE_FRAME VARIABLE=park VALUE="{tl.park}"
	{% if params.TRAVEL_SPEED %}
	{% if params.TRAVEL_SPEED|float > 0.0 %}
	{% set _dummy = tl.speed.update({'travel':params.TRAVEL_SPEED|float|round(3)}) %}
	{% else %}
	{action_raise_error("TRAVEL_SPEED=%s must be larger than 0" % params.TRAVEL_SPEED)}
	{% endif %}
	{% endif %}
	{% if params.RETRACT_SPEED %}
	{% if params.RETRACT_SPEED|float > 0.0 %}
	{% set _dummy = tl.speed.update({'retract':params.RETRACT_SPEED|float|round(3)}) %}
	{% else %}
	{action_raise_error("RETRACT_SPEED=%s must be larger than 0" % params.RETRACT_SPEED)}
	{% endif %}
	{% endif %}
	{% if params.EXTRUDE_SPEED %}
	{% if params.EXTRUDE_SPEED|float > 0.0 %}
	{% set _dummy = tl.speed.update({'extrude':params.EXTRUDE_SPEED|float|round(3)}) %}
	{% else %}
	{action_raise_error("EXTRUDE_SPEED=%s must be larger than 0" % params.EXTRUDE_SPEED)}
	{% endif %}
	{% endif %}
	SET_GCODE_VARIABLE MACRO=TIMELAPSE_TAKE_FRAME VARIABLE=speed VALUE="{tl.speed}"
	{% if params.EXTRUDE_DISTANCE %}
	{% if params.EXTRUDE_DISTANCE|float >= 0.0 %}
	{% set _dummy = tl.extruder.update({'extrude':params.EXTRUDE_DISTANCE|float|round(3)}) %}
	{% else %}
	{action_raise_error("EXTRUDE_DISTANCE=%s must be specified as positiv number" % params.EXTRUDE_DISTANCE)}
	{% endif %}
	{% endif %}
	{% if params.RETRACT_DISTANCE %}
	{% if params.RETRACT_DISTANCE|float >= 0.0 %}
	{% set _dummy = tl.extruder.update({'retract':params.RETRACT_DISTANCE|float|round(3)}) %}
	{% else %}
	{action_raise_error("RETRACT_DISTANCE=%s must be specified as positiv number" % params.RETRACT_DISTANCE)}
	{% endif %}
	{% endif %}
	{% if params.FW_RETRACT %}
	{% if params.FW_RETRACT|lower is in ['true', 'false'] %}
	{% if 'firmware_retraction' in printer.configfile.settings %}
	{% set _dummy = tl.extruder.update({'fw_retract': True if params.FW_RETRACT|lower == 'true' else False}) %}
	{% else %}
	{% set _dummy = tl.extruder.update({'fw_retract':False}) %}
	{% if params.FW_RETRACT|capitalize == 'True' %}
	{action_raise_error("[firmware_retraction] not defined in printer.cfg. Can not enable fw_retract")}
	{% endif %}
	{% endif %}
	{% else %}
	{action_raise_error("FW_RETRACT=%s not supported. Allowed values are [True, False]" % params.FW_RETRACT|capitalize)}
	{% endif %}
	{% endif %}
	SET_GCODE_VARIABLE MACRO=TIMELAPSE_TAKE_FRAME VARIABLE=extruder VALUE="{tl.extruder}"
	{% if printer.configfile.settings['gcode_macro pause'] is defined %}
	{% set _dummy = tl.macro.update({'pause': printer.configfile.settings['gcode_macro pause'].rename_existing}) %}
	{% endif %}
	{% if printer.configfile.settings['gcode_macro resume'] is defined %}
	{% set _dummy = tl.macro.update({'resume': printer.configfile.settings['gcode_macro resume'].rename_existing}) %}
	{% endif %}
	SET_GCODE_VARIABLE MACRO=TIMELAPSE_TAKE_FRAME VARIABLE=macro VALUE="{tl.macro}"

[gcode_macro TIMELAPSE_TAKE_FRAME]
description = Take Timelapse shoot
variable_enable = False
variable_takingframe = False
variable_park = {'enable': False,
	'pos'   : 'center',
	'time'  : 0.1,
	'custom': {'x': 0, 'y': 0, 'dz': 0},
	'coord' : {'x': 0, 'y': 0, 'dz': 0}}
variable_extruder = {'fw_retract': False,
	'retract': 1.0,
	'extrude': 1.0}
variable_speed = {'travel': 100,
	'retract': 15,
	'extrude': 15}
variable_verbose = True
variable_check_time = 0.5
variable_restore = {'absolute': {'coordinates': True, 'extrude': True}, 'speed': 1500, 'e':0, 'factor': {'speed': 1.0, 'extrude': 1.0}}
variable_macro = {'pause': 'PAUSE', 'resume': 'RESUME'}
variable_is_paused = False
gcode = 
	{% set hyperlapse = True if params.HYPERLAPSE and params.HYPERLAPSE|lower =='true' else False %}
	{% if enable %}
	{% if (hyperlapse and printer['gcode_macro HYPERLAPSE'].run) or
	(not hyperlapse and not printer['gcode_macro HYPERLAPSE'].run) %}
	{% if park.enable %}
	{% set pos = {'x': 'X' + park.coord.x|string if park.pos != 'y_only' else '',
	'y': 'Y' + park.coord.y|string if park.pos != 'x_only' else '',
	'z': 'Z'+ [printer.gcode_move.gcode_position.z + park.coord.dz, printer.toolhead.axis_maximum.z]|min|string} %}
	{% set restore = {'absolute': {'coordinates': printer.gcode_move.absolute_coordinates,
	'extrude'    : printer.gcode_move.absolute_extrude},
	'speed'   : printer.gcode_move.speed,
	'e'       : printer.gcode_move.gcode_position.e,
	'factor'  : {'speed'  : printer.gcode_move.speed_factor,
	'extrude': printer.gcode_move.extrude_factor}} %}
	SET_GCODE_VARIABLE MACRO=TIMELAPSE_TAKE_FRAME VARIABLE=restore VALUE="{restore}"
	{% if not printer[printer.toolhead.extruder].can_extrude %}
	{% if verbose %}{action_respond_info("Timelapse: Warning, minimum extruder temperature not reached!")}{% endif %}
	{% else %}
	{% if extruder.fw_retract %}
	G10
	{% else %}
	M83
	G0 E-{extruder.retract} F{speed.retract * 60}
	{% endif %}
	{% endif %}
	SET_GCODE_VARIABLE MACRO=TIMELAPSE_TAKE_FRAME VARIABLE=is_paused VALUE=True
	{macro.pause}
	SET_GCODE_OFFSET X=0 Y=0
	G90
	{% if "xyz" not in printer.toolhead.homed_axes %}
	{% if verbose %}{action_respond_info("Timelapse: Warning, axis not homed yet!")}{% endif %}
	{% else %}
	G0 {pos.x} {pos.y} {pos.z} F{speed.travel * 60}
	{% endif %}
	SET_GCODE_VARIABLE MACRO=TIMELAPSE_TAKE_FRAME VARIABLE=takingframe VALUE=True
	UPDATE_DELAYED_GCODE ID=_WAIT_TIMELAPSE_TAKE_FRAME DURATION={check_time}
	M400
	{% endif %}
	_TIMELAPSE_NEW_FRAME HYPERLAPSE={hyperlapse}
	{% endif %}
	{% else %}
	{% if verbose %}{action_respond_info("Timelapse: disabled, take frame ignored")}{% endif %}
	{% endif %}

[gcode_macro _TIMELAPSE_NEW_FRAME]
description = action call for timelapse shoot. must be a seperate macro
gcode = 
	{action_call_remote_method("timelapse_newframe",
	macropark=printer['gcode_macro TIMELAPSE_TAKE_FRAME'].park,
	hyperlapse=params.HYPERLAPSE)}

[delayed_gcode _WAIT_TIMELAPSE_TAKE_FRAME]
gcode = 
	{% set tl = printer['gcode_macro TIMELAPSE_TAKE_FRAME'] %}
	{% set factor = {'speed': printer.gcode_move.speed_factor, 'extrude': printer.gcode_move.extrude_factor} %}
	{% if tl.takingframe %}
	UPDATE_DELAYED_GCODE ID=_WAIT_TIMELAPSE_TAKE_FRAME DURATION={tl.check_time}
	{% else %}
	{tl.macro.resume} VELOCITY={tl.speed.travel}
	SET_GCODE_VARIABLE MACRO=TIMELAPSE_TAKE_FRAME VARIABLE=is_paused VALUE=False
	{% if not printer[printer.toolhead.extruder].can_extrude %}
	{action_respond_info("Timelapse: Warning minimum extruder temperature not reached!")}
	{% else %}
	{% if tl.extruder.fw_retract %}
	G11
	{% else %}
	G0 E{tl.extruder.extrude} F{tl.speed.extrude * 60}
	G0 F{tl.restore.speed}
	{% if tl.restore.absolute.extrude %}
	M82
	G92 E{tl.restore.e}
	{% endif %}
	{% endif %}
	{% endif %}
	{% if tl.restore.factor.speed   != factor.speed   %} M220 S{(factor.speed*100)|round(0)}   {% endif %}
	{% if tl.restore.factor.extrude != factor.extrude %} M221 S{(factor.extrude*100)|round(0)} {% endif %}
	{% if not tl.restore.absolute.coordinates %} G91 {% endif %}
	{% endif %}

[gcode_macro HYPERLAPSE]
description = Start/Stop a hyperlapse recording
variable_cycle = 0
variable_run = False
gcode = 
	{% set cycle = params.CYCLE|default(30)|int %}
	{% if params.ACTION and params.ACTION|lower == 'start' %}
	{action_respond_info("Hyperlapse: frames started (Cycle %d sec)" % cycle)}
	SET_GCODE_VARIABLE MACRO=HYPERLAPSE VARIABLE=run VALUE=True
	SET_GCODE_VARIABLE MACRO=HYPERLAPSE VARIABLE=cycle VALUE={cycle}
	UPDATE_DELAYED_GCODE ID=_HYPERLAPSE_LOOP DURATION={cycle}
	TIMELAPSE_TAKE_FRAME HYPERLAPSE=True
	{% elif params.ACTION and params.ACTION|lower == 'stop' %}
	{% if run %}{action_respond_info("Hyperlapse: frames stopped")}{% endif %}
	SET_GCODE_VARIABLE MACRO=HYPERLAPSE VARIABLE=run VALUE=False
	UPDATE_DELAYED_GCODE ID=_HYPERLAPSE_LOOP DURATION=0
	{% else %}
	{action_raise_error("Hyperlapse: No valid input parameter
	Use:
	- HYPERLAPSE ACTION=START [CYCLE=time]
	- HYPERLAPSE ACTION=STOP")}
	{% endif %}

[delayed_gcode _HYPERLAPSE_LOOP]
gcode = 
	UPDATE_DELAYED_GCODE ID=_HYPERLAPSE_LOOP DURATION={printer["gcode_macro HYPERLAPSE"].cycle}
	TIMELAPSE_TAKE_FRAME HYPERLAPSE=True

[gcode_macro TIMELAPSE_RENDER]
description = Render Timelapse video and wait for the result
variable_render = False
variable_run_identifier = 0
gcode = 
	{action_respond_info("Timelapse: Rendering started")}
	{action_call_remote_method("timelapse_render", byrendermacro="True")}
	SET_GCODE_VARIABLE MACRO=TIMELAPSE_RENDER VARIABLE=render VALUE=True
	{printer.configfile.settings['gcode_macro pause'].rename_existing}
	UPDATE_DELAYED_GCODE ID=_WAIT_TIMELAPSE_RENDER DURATION=0.5

[delayed_gcode _WAIT_TIMELAPSE_RENDER]
gcode = 
	{% set ri = printer['gcode_macro TIMELAPSE_RENDER'].run_identifier % 4 %}
	SET_GCODE_VARIABLE MACRO=TIMELAPSE_RENDER VARIABLE=run_identifier VALUE={ri + 1}
	{% if printer['gcode_macro TIMELAPSE_RENDER'].render %}
	M117 Rendering {['-','\\','|','/'][ri]}
	UPDATE_DELAYED_GCODE ID=_WAIT_TIMELAPSE_RENDER DURATION=0.5
	{% else %}
	{action_respond_info("Timelapse: Rendering finished")}
	M117
	{printer.configfile.settings['gcode_macro resume'].rename_existing}
	{% endif %}

[gcode_macro TEST_STREAM_DELAY]
description = Helper macro to find stream and park delay
gcode = 
	{% set min = printer.toolhead.axis_minimum %}
	{% set max = printer.toolhead.axis_maximum %}
	{% set act = printer.toolhead.position %}
	{% set tl = printer['gcode_macro TIMELAPSE_TAKE_FRAME'] %}
	{% if act.z > 5.0 %}
	G0 X{min.x + 5.0} F{tl.speed.travel|int * 60}
	G0 X{(max.x-min.x)/2}
	G4 P{tl.park.time|float * 1000}
	_TIMELAPSE_NEW_FRAME HYPERLAPSE=FALSE
	G0 X{max.x - 5.0}
	{% else %}
	{action_raise_error("Toolhead z %.3f to low. Please place head above z = 5.0" % act.z)}
	{% endif %}

[board_pins]
aliases = 
	
	EXP1_1=PA8,   EXP1_2=PC9,
	EXP1_3=PA10,  EXP1_4=PA9,
	EXP1_5=PC11,  EXP1_6=PC10,
	EXP1_7=PD8,   EXP1_8=PC12,
	EXP1_9=<GND>, EXP1_10=<5V>,
	
	
	EXP2_1=PB14,  EXP2_2=PB13,
	EXP2_3=PC7,   EXP2_4=PB12,
	EXP2_5=PC6,   EXP2_6=PB15,
	EXP2_7=PC8,   EXP2_8=<RST>,
	EXP2_9=<GND>, EXP2_10=<5V>

[display]
lcd_type = uc1701
cs_pin = EXP1_3
a0_pin = EXP1_4
rst_pin = EXP1_5
encoder_pins = ^EXP2_3, ^EXP2_5
click_pin = ^!EXP1_2
contrast = 63
spi_software_miso_pin = EXP2_1
spi_software_mosi_pin = EXP2_6
spi_software_sclk_pin = EXP2_2

[output_pin beeper]
pin = EXP1_1
pwm = False
value = 0

[neopixel Screen_Colour]
pin = EXP1_6
chain_count = 3
color_order = RGB
initial_red = 0.5
initial_green = 0.4
initial_blue = 0.7

[gcode_macro BEEP]
gcode = 
	SET_PIN PIN=beeper VALUE=1
	G4 P10
	SET_PIN PIN=beeper VALUE=0

[menu __resume]
type = list
name = Resume

[menu __resume __resume]
type = command
name = Resume
gcode = 

[menu __resume __cancel]
type = command
name = Cancel
gcode = 

[menu __main]
type = list
name = Main

[menu __main __tune]
type = list
enable = {printer.print_stats.state == "paused" or printer.idle_timeout.state == "Printing"}
name = Tune
index = 1

[menu __main __tune __speed]
type = input
name = Speed: {'%3d' % (menu.input*100)}%
input = {printer.gcode_move.speed_factor}
input_min = 0.01
input_max = 5
input_step = 0.01
realtime = True
gcode = 
	M220 S{'%d' % (menu.input*100)}

[menu __main __tune __flow]
type = input
name = Flow: {'%3d' % (menu.input*100)}%
input = {printer.gcode_move.extrude_factor}
input_min = 0.01
input_max = 2
input_step = 0.01
realtime = True
gcode = 
	M221 S{'%d' % (menu.input*100)}

[menu __main __tune __fanspeed]
type = input
name = Fan speed: {'%3d' % (menu.input*100)}%
input = {printer["fan"].speed}
input_min = 0
input_max = 1
input_step = 0.01
gcode = 
	M106 S{'%d' % (menu.input*255)}

[menu __main __tune __hotend0_target]
type = input
enable = {('extruder' in printer) and ('extruder' in printer.heaters.available_heaters)}
name = {"Ex0:%3.0f (%4.0f)" % (menu.input, printer.extruder.temperature)}
input = {printer.extruder.target}
input_min = 0
input_max = {printer.configfile.config.extruder.max_temp}
input_step = 1
gcode = 
	M104 T0 S{'%.0f' % menu.input}

[menu __main __tune __hotend1_target]
type = input
enable = {('extruder1' in printer) and ('extruder1' in printer.heaters.available_heaters)}
name = {"Ex1:%3.0f (%4.0f)" % (menu.input, printer.extruder1.temperature)}
input = {printer.extruder1.target}
input_min = 0
input_max = {printer.configfile.config.extruder1.max_temp}
input_step = 1
gcode = 
	M104 T1 S{'%.0f' % menu.input}

[menu __main __tune __hotbed_target]
type = input
enable = {'heater_bed' in printer}
name = {"Bed:%3.0f (%4.0f)" % (menu.input, printer.heater_bed.temperature)}
input = {printer.heater_bed.target}
input_min = 0
input_max = {printer.configfile.config.heater_bed.max_temp}
input_step = 1
gcode = 
	M140 S{'%.0f' % menu.input}

[menu __main __tune __exhaustfanonoff]
type = command
name = Exhaust Fan {'ON' if printer['fan_generic exhaust_fan'].speed > 0 else 'OFF'}
enable = {'fan_generic exhaust_fan' in printer}
gcode = 
	{% if printer['fan_generic exhaust_fan'].speed > 0 %}
	SET_FAN_SPEED FAN=exhaust_fan SPEED=0
	{% else %}
	SET_FAN_SPEED FAN=exhaust_fan SPEED=1
	{% endif %}

[menu __main __tune __exhaustfanspeed]
type = input
name = Exhaust Fan:{'%3d' % (menu.input*100)}%
input = {printer["fan_generic exhaust_fan"].speed}
input_min = 0
input_max = 1
input_step = 0.01
gcode = 
	SET_FAN_SPEED FAN=exhaust_fan SPEED={menu.input}

[menu __main __tune __ledonoff]
type = input
enable = {'led main_led' in printer}
name = Dim LED:    {'%3d%s' % (menu.input*100,'%') if menu.input else 'OFF'}
input = {printer['output_pin main_led'].value}
input_min = 0.0
input_max = 1.0
input_step = 0.01
gcode = SET_LED LED=main_led WHITE={menu.input}

[menu __main __tune __save]
type = list
name = "Save"

[menu __main __tune __save __save_config]
type = command
name = "Save & Exit"
gcode = 
	Z_OFFSET_APPLY_PROBE
	SAVE_CONFIG

[menu __main __filament1]
type = list
enable = {('virtual_sdcard' in printer) and (printer.print_stats.state == "printing" or printer.print_stats.state == "paused")}
name = Change filament
index = 2

[menu __main __filament1 __load]
type = command
name = Load Filament
gcode = 
	PAUSE
	SAVE_GCODE_STATE NAME=__filament__load
	LOAD_FILAMENT
	RESTORE_GCODE_STATE NAME=__filament__load
	{menu.exit()}

[menu __main __filament1 __unload]
type = command
name = Unload Filament
gcode = 
	PAUSE
	SAVE_GCODE_STATE NAME=__filament__load
	UNLOAD_FILAMENT
	RESTORE_GCODE_STATE NAME=__filament__load
	{menu.exit()}

[menu __main __resume]
type = command
enable = {('virtual_sdcard' in printer) and printer.print_stats.state == "paused"}
name = Resume printing
index = 3
gcode = 
	M117 Resume printing
	{% if "pause_resume" in printer %}
	RESUME
	{% else %}
	M24
	{% endif %}
	{menu.exit()}

[menu __main __pause]
type = command
enable = {('virtual_sdcard' in printer) and printer.print_stats.state == "printing"}
name = Pause printing
index = 3
gcode = 
	M117 Pause printing
	{% if "pause_resume" in printer %}
	PAUSE
	{% else %}
	M25
	{% endif %}
	{menu.exit()}

[menu __main __cancel]
type = command
enable = {('virtual_sdcard' in printer) and (printer.print_stats.state == "printing" or printer.print_stats.state == "paused")}
name = Cancel printing
index = 3
gcode = 
	
	
	
	{% if 'pause_resume' in printer %}
	CANCEL_PRINT
	{% else %}
	M25
	M27
	M26 S0
	TURN_OFF_HEATERS
	{% if printer.toolhead.position.z <= printer.toolhead.axis_maximum.z - 5 %}
	G91
	G0 Z5 F1000
	G90
	{% endif %}
	{% endif %}
	{menu.exit()}

[menu __main __prepare]
type = list
enable = {not (printer.print_stats.state == "paused" or printer.idle_timeout.state == "Printing")}
name = Prepare
index = 4

[menu __main __prepare __home]
type = command
name = Auto Home
gcode = G28

[menu __main __prepare __preheat_pla]
type = command
enable = {('extruder' in printer) and ('heater_bed' in printer)}
name = Preheat PLA
gcode = 
	M117 Preheat PLA
	M140 S65
	M104 S200
	{menu.back()}

[menu __main __prepare __preheat_petg]
type = command
enable = {('extruder' in printer) and ('heater_bed' in printer)}
name = Preheat PETG
gcode = 
	M117 Preheat PETG
	M140 S75
	M104 S230
	{menu.back()}

[menu __main __prepare __preheat_abs]
type = command
enable = {('extruder' in printer) and ('heater_bed' in printer)}
name = Preheat ABS
gcode = 
	M117 Preheat ABS
	M140 S90
	M104 S260
	{menu.back()}

[menu __main __prepare __cooldown]
type = command
enable = {('extruder' in printer) and ('heater_bed' in printer)}
name = Cooldown
gcode = 
	M117 Cooldown
	M104 S0
	M140 S0
	{menu.back()}

[menu __main __prepare __hotend0_target]
type = input
enable = {'extruder' in printer}
name = {"Ex0:%3.0f (%4.0f)" % (menu.input, printer.extruder.temperature)}
input = {printer.extruder.target}
input_min = 0
input_max = {printer.configfile.config.extruder.max_temp}
input_step = 1
gcode = 
	M104 T0 S{'%.0f' % menu.input}

[menu __main __levelling]
type = list
enable = {not (printer.print_stats.state == "paused" or printer.idle_timeout.state == "Printing")}
name = Levelling
index = 5

[menu __main __levelling __autooffsetz]
type = command
name = Calibrate Zoffset
gcode = 
	_Delay_Calibrate

[menu __main __levelling __quad_gantry_level]
type = command
enable = {('quad_gantry_level' in printer)}
name = Quad Gantry Lvl
gcode = 
	M117 Quad Gantry Lvl
	QUAD_GANTRY_LEVEL
	{menu.exit()}

[menu __main __levelling __bed_mesh]
type = command
enable = {('bed_mesh' in printer)}
name = Bed Mesh
gcode = 
	M117 Bed Mesh
	BED_MESH_CALIBRATE ADAPTIVE=1
	SAVE_CONFIG
	{menu.exit()}

[menu __main __sdcard]
type = vsdlist
enable = {not (printer.print_stats.state == "paused" or printer.idle_timeout.state == "Printing")}
name = Print
index = 6

[menu __main __control2]
type = list
enable = {not (printer.print_stats.state == "paused" or printer.idle_timeout.state == "Printing")}
name = Control
index = 7

[menu __main __control2 __hotend0_target]
type = input
enable = {('extruder' in printer) and ('extruder' in printer.heaters.available_heaters)}
name = {"Ex0:%3.0f (%4.0f)" % (menu.input, printer.extruder.temperature)}
input = {printer.extruder.target}
input_min = 0
input_max = {printer.configfile.config.extruder.max_temp}
input_step = 1
gcode = 
	M104 T0 S{'%.0f' % menu.input}

[menu __main __control2 __hotbed_target]
type = input
enable = {'heater_bed' in printer}
name = {"Bed:%3.0f (%4.0f)" % (menu.input, printer.heater_bed.temperature)}
input = {printer.heater_bed.target}
input_min = 0
input_max = {printer.configfile.config.heater_bed.max_temp}
input_step = 1
gcode = 
	M140 S{'%.0f' % menu.input}

[menu __main __control2 __fanspeed]
type = input
name = Fan speed: {'%3d' % (menu.input*100)}%
input = {printer["fan"].speed}
input_min = 0
input_max = 1
input_step = 0.01
gcode = 
	M106 S{'%d' % (menu.input*255)}

[menu __main __control2 __exhaustfanonoff]
type = command
name = Exhaust Fan {'ON' if printer['fan_generic exhaust_fan'].speed > 0 else 'OFF'}
enable = {'fan_generic exhaust_fan' in printer}
gcode = 
	{% if printer['fan_generic exhaust_fan'].speed > 0 %}
	SET_FAN_SPEED FAN=exhaust_fan SPEED=0
	{% else %}
	SET_FAN_SPEED FAN=exhaust_fan SPEED=1
	{% endif %}

[menu __main __control2 __exhaustfanspeed]
type = input
name = ExhaustFan:{'%3d' % (menu.input*100)}%
input = {printer["fan_generic fan3"].speed}
input_min = 0
input_max = 1
input_step = 0.01
gcode = 
	M106 P3 S{'%d' % (menu.input*255)}
enable = {printer["gcode_macro _START_VARIABLES"].chamber_fan == False}

[menu __main __control2 __ledonoff]
type = input
enable = {'output_pin main_led' in printer}
name = Dim LED:    {'%3d%s' % (menu.input*100,'%') if menu.input else 'OFF'}
input = {printer['output_pin main_led'].value}
input_min = 0.0
input_max = 1.0
input_step = 0.01
gcode = SET_PIN PIN=main_led VALUE={menu.input}

[menu __main __control]
type = list
enable = {not (printer.print_stats.state == "paused" or printer.idle_timeout.state == "Printing")}
name = Move
index = 8

[menu __main __control __disable]
type = command
name = Steppers off
gcode = 
	M84
	M18
	{menu.exit()}

[menu __main __control __home]
type = command
name = Auto Home
gcode = 
	G28
	{menu.exit()}

[menu __main __control __move_10mm]
type = list
name = Move 10mm

[menu __main __control __move_10mm __axis_x]
type = input
name = Move X:{'%05.1f' % menu.input}
input = {printer.gcode_move.gcode_position.x}
input_min = {printer.toolhead.axis_minimum.x}
input_max = {printer.toolhead.axis_maximum.x}
input_step = 10.0
gcode = 
	SAVE_GCODE_STATE NAME=__move__axis
	G90
	G1 X{menu.input}
	RESTORE_GCODE_STATE NAME=__move__axis

[menu __main __control __move_10mm __axis_y]
type = input
name = Move Y:{'%05.1f' % menu.input}
input = {printer.gcode_move.gcode_position.y}
input_min = {printer.toolhead.axis_minimum.y}
input_max = {printer.toolhead.axis_maximum.y}
input_step = 10.0
gcode = 
	SAVE_GCODE_STATE NAME=__move__axis
	G90
	G1 Y{menu.input}
	RESTORE_GCODE_STATE NAME=__move__axis

[menu __main __control __move_10mm __axis_z]
type = input
name = Move Z:{'%05.1f' % menu.input}
input = {printer.gcode_move.gcode_position.z}
input_min = 0
input_max = {printer.toolhead.axis_maximum.z}
input_step = 10.0
gcode = 
	SAVE_GCODE_STATE NAME=__move__axis
	G90
	G1 Z{menu.input}
	RESTORE_GCODE_STATE NAME=__move__axis

[menu __main __control __move_10mm __axis_e]
type = input
name = Move E:{'%+06.1f' % menu.input}
input = 0
input_min = -{printer.configfile.config.extruder.max_extrude_only_distance|default(50)}
input_max = {printer.configfile.config.extruder.max_extrude_only_distance|default(50)}
input_step = 10.0
gcode = 
	SAVE_GCODE_STATE NAME=__move__axis
	M83
	G1 E{menu.input} F240
	RESTORE_GCODE_STATE NAME=__move__axis

[menu __main __control __move_1mm]
type = list
name = Move 1mm

[menu __main __control __move_1mm __axis_x]
type = input
name = Move X:{'%05.1f' % menu.input}
input = {printer.gcode_move.gcode_position.x}
input_min = {printer.toolhead.axis_minimum.x}
input_max = {printer.toolhead.axis_maximum.x}
input_step = 1.0
gcode = 
	SAVE_GCODE_STATE NAME=__move__axis
	G90
	G1 X{menu.input}
	RESTORE_GCODE_STATE NAME=__move__axis

[menu __main __control __move_1mm __axis_y]
type = input
name = Move Y:{'%05.1f' % menu.input}
input = {printer.gcode_move.gcode_position.y}
input_min = {printer.toolhead.axis_minimum.y}
input_max = {printer.toolhead.axis_maximum.y}
input_step = 1.0
gcode = 
	SAVE_GCODE_STATE NAME=__move__axis
	G90
	G1 Y{menu.input}
	RESTORE_GCODE_STATE NAME=__move__axis

[menu __main __control __move_1mm __axis_z]
type = input
enable = {not printer.idle_timeout.state == "Printing"}
name = Move Z:{'%05.1f' % menu.input}
input = {printer.gcode_move.gcode_position.z}
input_min = 0
input_max = {printer.toolhead.axis_maximum.z}
input_step = 1.0
gcode = 
	SAVE_GCODE_STATE NAME=__move__axis
	G90
	G1 Z{menu.input}
	RESTORE_GCODE_STATE NAME=__move__axis

[menu __main __control __move_1mm __axis_e]
type = input
enable = {not printer.idle_timeout.state == "Printing"}
name = Move E:{'%+06.1f' % menu.input}
input = 0
input_min = -{printer.configfile.config.extruder.max_extrude_only_distance|default(50)}
input_max = {printer.configfile.config.extruder.max_extrude_only_distance|default(50)}
input_step = 1.0
gcode = 
	SAVE_GCODE_STATE NAME=__move__axis
	M83
	G1 E{menu.input} F240
	RESTORE_GCODE_STATE NAME=__move__axis

[menu __main __control __move_01mm]
type = list
enable = {not printer.idle_timeout.state == "Printing"}
name = Move 0.1mm

[menu __main __control __move_01mm __axis_x]
type = input
name = Move X:{'%05.1f' % menu.input}
input = {printer.gcode_move.gcode_position.x}
input_min = {printer.toolhead.axis_minimum.x}
input_max = {printer.toolhead.axis_maximum.x}
input_step = 0.1
gcode = 
	SAVE_GCODE_STATE NAME=__move__axis
	G90
	G1 X{menu.input}
	RESTORE_GCODE_STATE NAME=__move__axis

[menu __main __control __move_01mm __axis_y]
type = input
name = Move Y:{'%05.1f' % menu.input}
input = {printer.gcode_move.gcode_position.y}
input_min = {printer.toolhead.axis_minimum.y}
input_max = {printer.toolhead.axis_maximum.y}
input_step = 0.1
gcode = 
	SAVE_GCODE_STATE NAME=__move__axis
	G90
	G1 Y{menu.input}
	RESTORE_GCODE_STATE NAME=__move__axis

[menu __main __control __move_01mm __axis_z]
type = input
enable = {not printer.idle_timeout.state == "Printing"}
name = Move Z:{'%05.1f' % menu.input}
input = {printer.gcode_move.gcode_position.z}
input_min = 0
input_max = {printer.toolhead.axis_maximum.z}
input_step = 0.1
gcode = 
	SAVE_GCODE_STATE NAME=__move__axis
	G90
	G1 Z{menu.input}
	RESTORE_GCODE_STATE NAME=__move__axis

[menu __main __control __move_01mm __axis_e]
type = input
enable = {not printer.idle_timeout.state == "Printing"}
name = Move E:{'%+06.1f' % menu.input}
input = 0
input_min = -{printer.configfile.config.extruder.max_extrude_only_distance|default(50)}
input_max = {printer.configfile.config.extruder.max_extrude_only_distance|default(50)}
input_step = 0.1
gcode = 
	SAVE_GCODE_STATE NAME=__move__axis
	M83
	G1 E{menu.input} F240
	RESTORE_GCODE_STATE NAME=__move__axis

[menu __main __filament]
type = list
enable = {not (printer.print_stats.state == "paused" or printer.idle_timeout.state == "Printing")}
name = Filament
index = 9

[menu __main __filament __load]
type = command
name = Load Filament
gcode = 
	{menu.exit()}
	SAVE_GCODE_STATE NAME=__filament__load
	LOAD_FILAMENT
	RESTORE_GCODE_STATE NAME=__filament__load

[menu __main __filament __unload]
type = command
name = Unload Filament
gcode = 
	{menu.exit()}
	SAVE_GCODE_STATE NAME=__filament__load
	UNLOAD_FILAMENT
	RESTORE_GCODE_STATE NAME=__filament__load

[menu __main __setup]
type = list
enable = {not (printer.print_stats.state == "paused" or printer.idle_timeout.state == "Printing")}
name = Advanced
index = 10

[menu __main __setup __belt_test]
type = command
name = "Belt test"
gcode = 
	M117 Belt test
	G28
	SHAPER_CALIBRATE TEST=1
	FIRMWARE_RESTART

[menu __main __setup __autocalib]
type = command
name = Auto-Calibrate
gcode = 
	M117 Measure Both
	ACCELEROMETER_QUERY
	G28
	SHAPER_CALIBRATE
	SAVE_CONFIG

[menu __main __setup __tuning]
type = command
name = PID tuning
gcode = 
	M117 Tune Hotend PID
	PID_CALIBRATE HEATER=extruder TARGET=210 WRITE_FILE=1
	M117 Tune Hotbed PID
	PID_CALIBRATE HEATER=heater_bed TARGET=60 WRITE_FILE=1
	SAVE_CONFIG

[menu __main __setup __restart]
type = list
name = Restart & Shutdown

[menu __main __setup __restart __host_shutdown]
type = command
enable = {not printer.idle_timeout.state == "Printing"}
name = Shutdown host
gcode = 
	{action_call_remote_method("shutdown_machine")}

[menu __main __info]
type = list
enable = {not (printer.print_stats.state == "paused" or printer.idle_timeout.state == "Printing")}
name = Information

[menu __main __info __version_name]
type = command
name = SV08 Mainline Klipper
gcode = 

[menu __main __info __version]
type = command
name = v0.1b
gcode = 

[menu __main __octoprint]
type = disabled

[menu __main __temp]
type = disabled

[menu __main __filament __hotend0_target]
type = disabled

[menu __main __filament __loadf]
type = disabled

[menu __main __filament __loads]
type = disabled

[menu __main __filament __unloadf]
type = disabled

[menu __main __filament __unloads]
type = disabled

[menu __main __filament __feed]
type = disabled

[gcode_macro _DEMON_ADAPTIVE_PA]
gcode = 
	{% set ext_type = params.TYPE|string %}
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	{% set apa_vars = printer["gcode_macro _APA_VARS"] %}
	
	{% if apa_vars.oapa == 1|int %}
	
	{% elif apa_vars.oapa == 0|int %}
	{% if apa_vars.enable == True %}
	
	{% if ext_type == "Perimeter" and apa_vars.prmtr > 0 %}
	{% if start_vars.apa_readback_enable == True %}
	RESPOND TYPE=COMMAND MSG="PA change APA setting Inner Wall {apa_vars.prmtr}"
	{% endif %}
	SET_PRESSURE_ADVANCE ADVANCE={apa_vars.prmtr}
	
	
	{% elif ext_type == "Perimeter" and apa_vars.prmtr == 0 %}
	{% if start_vars.apa_readback_enable == True %}
	RESPOND TYPE=COMMAND MSG="PA change default setting Inner Wall {apa_vars.default}"
	{% endif %}
	SET_PRESSURE_ADVANCE ADVANCE={apa_vars.default}
	
	
	{% elif ext_type == "ExternalPerimeter" and apa_vars.ext_prmtr > 0 %}
	{% if start_vars.apa_readback_enable == True %}
	RESPOND TYPE=COMMAND MSG="PA change APA setting Outer wall {apa_vars.ext_prmtr}"
	{% endif %}
	SET_PRESSURE_ADVANCE ADVANCE={apa_vars.ext_prmtr}
	
	
	{% elif ext_type == "ExternalPerimeter" and apa_vars.ext_prmtr == 0 %}
	{% if start_vars.apa_readback_enable == True %}
	RESPOND TYPE=COMMAND MSG="PA change default setting Outer wall {apa_vars.default}"
	{% endif %}
	SET_PRESSURE_ADVANCE ADVANCE={apa_vars.default}
	
	
	{% elif ext_type == "InternalInfill" and apa_vars.infill > 0 %}
	{% if start_vars.apa_readback_enable == True %}
	RESPOND TYPE=COMMAND MSG="PA change APA setting Sparse infill {apa_vars.infill}"
	{% endif %}
	SET_PRESSURE_ADVANCE ADVANCE={apa_vars.infill}
	
	
	{% elif ext_type == "InternalInfill" and apa_vars.infill == 0 %}
	{% if start_vars.apa_readback_enable == True %}
	RESPOND TYPE=COMMAND MSG="PA change default setting Sparse infill {apa_vars.default}"
	{% endif %}
	SET_PRESSURE_ADVANCE ADVANCE={apa_vars.default}
	
	
	{% elif ext_type == "SolidInfill" and apa_vars.sld_infill > 0 %}
	{% if start_vars.apa_readback_enable == True %}
	RESPOND TYPE=COMMAND MSG="PA change APA setting Internal solid infill {apa_vars.sld_infill}"
	{% endif %}
	SET_PRESSURE_ADVANCE ADVANCE={apa_vars.sld_infill}
	
	
	{% elif ext_type == "SolidInfill" and apa_vars.sld_infill == 0 %}
	{% if start_vars.apa_readback_enable == True %}
	RESPOND TYPE=COMMAND MSG="PA change default setting Internal solid infill {apa_vars.default}"
	{% endif %}
	SET_PRESSURE_ADVANCE ADVANCE={apa_vars.default}
	
	
	{% elif ext_type == "TopSolidInfill" and apa_vars.top_srfc > 0 %}
	{% if start_vars.apa_readback_enable == True %}
	RESPOND TYPE=COMMAND MSG="PA change APA setting Top surface {apa_vars.top_srfc}"
	{% endif %}
	SET_PRESSURE_ADVANCE ADVANCE={apa_vars.top_srfc}
	
	
	{% elif ext_type == "TopSolidInfill" and apa_vars.top_srfc == 0 %}
	{% if start_vars.apa_readback_enable == True %}
	RESPOND TYPE=COMMAND MSG="PA change default setting Top surface {apa_vars.default}"
	{% endif %}
	SET_PRESSURE_ADVANCE ADVANCE={apa_vars.default}
	
	
	{% elif ext_type not in ["Perimeter", "ExternalPerimeter", "InternalInfill", "SolidInfill", "TopSolidInfill"] %}
	{% if start_vars.apa_readback_enable == True %}
	RESPOND TYPE=COMMAND MSG="PA change default setting for other extrusion types {apa_vars.default}"
	{% endif %}
	SET_PRESSURE_ADVANCE ADVANCE={apa_vars.default}
	
	
	{% endif %}
	
	{% endif %}
	{% endif %}

[gcode_macro _APA_VARS]
variable_default = 0
variable_prmtr = 0
variable_ext_prmtr = 0
variable_infill = 0
variable_sld_infill = 0
variable_top_srfc = 0
variable_fil_type = "PLA"
variable_enable = False
variable_oapa = 0
gcode = 

[gcode_macro _APA_SET]
gcode = 
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	{% set apa_vars = printer["gcode_macro _APA_VARS"] %}
	
	{% if apa_vars.oapa == 1|int %}
	RESPOND TYPE=COMMAND MSG="Orca APA has been detected, Demon APA is now disabled!"
	
	{% elif apa_vars.oapa == 0|int %}
	{% if apa_vars.fil_type == 'PLA' and start_vars.pla_adaptive_pa_enable == True %}
	{% if start_vars.apa_readback_enable == True %}
	RESPOND TYPE=COMMAND MSG="Setting system for PLA APA"
	{% endif %}
	SET_GCODE_VARIABLE MACRO=_APA_VARS VARIABLE=enable VALUE=True
	SET_GCODE_VARIABLE MACRO=_APA_VARS VARIABLE=default VALUE={start_vars.pla_pa|float}
	SET_GCODE_VARIABLE MACRO=_APA_VARS VARIABLE=prmtr VALUE={start_vars.pla_inner_wall_pa|float}
	SET_GCODE_VARIABLE MACRO=_APA_VARS VARIABLE=ext_prmtr VALUE={start_vars.pla_outer_wall_pa|float}
	SET_GCODE_VARIABLE MACRO=_APA_VARS VARIABLE=infill VALUE={start_vars.pla_sparse_infill_pa|float}
	SET_GCODE_VARIABLE MACRO=_APA_VARS VARIABLE=sld_infill VALUE={start_vars.pla_solid_infill_pa|float}
	SET_GCODE_VARIABLE MACRO=_APA_VARS VARIABLE=top_srfc VALUE={start_vars.pla_top_surface_pa|float}
	
	{% if start_vars.apa_readback_enable == True %}
	_APA_READ
	{% endif %}
	
	{% elif apa_vars.fil_type == 'ASA' and start_vars.asa_adaptive_pa_enable == True %}
	{% if start_vars.apa_readback_enable == True %}
	RESPOND TYPE=COMMAND MSG="Setting system for ASA APA"
	{% endif %}
	SET_GCODE_VARIABLE MACRO=_APA_VARS VARIABLE=enable VALUE=True
	SET_GCODE_VARIABLE MACRO=_APA_VARS VARIABLE=default VALUE={start_vars.asa_pa|float}
	SET_GCODE_VARIABLE MACRO=_APA_VARS VARIABLE=prmtr VALUE={start_vars.asa_inner_wall_pa|float}
	SET_GCODE_VARIABLE MACRO=_APA_VARS VARIABLE=ext_prmtr VALUE={start_vars.asa_outer_wall_pa|float}
	SET_GCODE_VARIABLE MACRO=_APA_VARS VARIABLE=infill VALUE={start_vars.asa_sparse_infill_pa|float}
	SET_GCODE_VARIABLE MACRO=_APA_VARS VARIABLE=sld_infill VALUE={start_vars.asa_solid_infill_pa|float}
	SET_GCODE_VARIABLE MACRO=_APA_VARS VARIABLE=top_srfc VALUE={start_vars.asa_top_surface_pa|float}
	
	{% if start_vars.apa_readback_enable == True %}
	_APA_READ
	{% endif %}
	
	{% elif apa_vars.fil_type == 'ABS' and start_vars.abs_adaptive_pa_enable == True %}
	{% if start_vars.apa_readback_enable == True %}
	RESPOND TYPE=COMMAND MSG="Setting system for ABS APA"
	{% endif %}
	SET_GCODE_VARIABLE MACRO=_APA_VARS VARIABLE=enable VALUE=True
	SET_GCODE_VARIABLE MACRO=_APA_VARS VARIABLE=default VALUE={start_vars.abs_pa|float}
	SET_GCODE_VARIABLE MACRO=_APA_VARS VARIABLE=prmtr VALUE={start_vars.abs_inner_wall_pa|float}
	SET_GCODE_VARIABLE MACRO=_APA_VARS VARIABLE=ext_prmtr VALUE={start_vars.abs_outer_wall_pa|float}
	SET_GCODE_VARIABLE MACRO=_APA_VARS VARIABLE=infill VALUE={start_vars.abs_sparse_infill_pa|float}
	SET_GCODE_VARIABLE MACRO=_APA_VARS VARIABLE=sld_infill VALUE={start_vars.abs_solid_infill_pa|float}
	SET_GCODE_VARIABLE MACRO=_APA_VARS VARIABLE=top_srfc VALUE={start_vars.abs_top_surface_pa|float}
	
	{% if start_vars.apa_readback_enable == True %}
	_APA_READ
	{% endif %}
	
	{% elif apa_vars.fil_type == 'PETG' and start_vars.petg_adaptive_pa_enable == True %}
	{% if start_vars.apa_readback_enable == True %}
	RESPOND TYPE=COMMAND MSG="Setting system for PETG APA"
	{% endif %}
	SET_GCODE_VARIABLE MACRO=_APA_VARS VARIABLE=enable VALUE=True
	SET_GCODE_VARIABLE MACRO=_APA_VARS VARIABLE=default VALUE={start_vars.petg_pa|float}
	SET_GCODE_VARIABLE MACRO=_APA_VARS VARIABLE=prmtr VALUE={start_vars.petg_inner_wall_pa|float}
	SET_GCODE_VARIABLE MACRO=_APA_VARS VARIABLE=ext_prmtr VALUE={start_vars.petg_outer_wall_pa|float}
	SET_GCODE_VARIABLE MACRO=_APA_VARS VARIABLE=infill VALUE={start_vars.petg_sparse_infill_pa|float}
	SET_GCODE_VARIABLE MACRO=_APA_VARS VARIABLE=sld_infill VALUE={start_vars.petg_solid_infill_pa|float}
	SET_GCODE_VARIABLE MACRO=_APA_VARS VARIABLE=top_srfc VALUE={start_vars.petg_top_surface_pa|float}
	
	{% if start_vars.apa_readback_enable == True %}
	_APA_READ
	{% endif %}
	
	{% elif apa_vars.fil_type == 'TPU' and start_vars.tpu_adaptive_pa_enable == True %}
	{% if start_vars.apa_readback_enable == True %}
	RESPOND TYPE=COMMAND MSG="Setting system for TPU APA"
	{% endif %}
	SET_GCODE_VARIABLE MACRO=_APA_VARS VARIABLE=enable VALUE=True
	SET_GCODE_VARIABLE MACRO=_APA_VARS VARIABLE=default VALUE={start_vars.tpu_pa|float}
	SET_GCODE_VARIABLE MACRO=_APA_VARS VARIABLE=prmtr VALUE={start_vars.tpu_inner_wall_pa|float}
	SET_GCODE_VARIABLE MACRO=_APA_VARS VARIABLE=ext_prmtr VALUE={start_vars.tpu_outer_wall_pa|float}
	SET_GCODE_VARIABLE MACRO=_APA_VARS VARIABLE=infill VALUE={start_vars.tpu_sparse_infill_pa|float}
	SET_GCODE_VARIABLE MACRO=_APA_VARS VARIABLE=sld_infill VALUE={start_vars.tpu_solid_infill_pa|float}
	SET_GCODE_VARIABLE MACRO=_APA_VARS VARIABLE=top_srfc VALUE={start_vars.tpu_top_surface_pa|float}
	
	{% if start_vars.apa_readback_enable == True %}
	_APA_READ
	{% endif %}
	
	{% elif apa_vars.fil_type not in ["PLA", "ASA", "ABS", "PETG", "TPU"] %}
	{% if start_vars.apa_readback_enable == True %}
	RESPOND TYPE=COMMAND MSG="Unlisted filament file detected. SWITCHING APA OFF"
	{% endif %}
	SET_GCODE_VARIABLE MACRO=_APA_VARS VARIABLE=enable VALUE=False
	SET_GCODE_VARIABLE MACRO=_APA_VARS VARIABLE=default VALUE={printer.configfile.settings.extruder.pressure_advance|float}
	SET_GCODE_VARIABLE MACRO=_APA_VARS VARIABLE=prmtr VALUE=0
	SET_GCODE_VARIABLE MACRO=_APA_VARS VARIABLE=ext_prmtr VALUE=0
	SET_GCODE_VARIABLE MACRO=_APA_VARS VARIABLE=infill VALUE=0
	SET_GCODE_VARIABLE MACRO=_APA_VARS VARIABLE=sld_infill VALUE=0
	SET_GCODE_VARIABLE MACRO=_APA_VARS VARIABLE=top_srfc VALUE=0
	
	{% if start_vars.apa_readback_enable == True %}
	_APA_READ
	{% endif %}
	
	{% else %}
	SET_GCODE_VARIABLE MACRO=_APA_VARS VARIABLE=enable VALUE=False
	SET_GCODE_VARIABLE MACRO=_APA_VARS VARIABLE=default VALUE={printer.configfile.settings.extruder.pressure_advance|float}
	SET_GCODE_VARIABLE MACRO=_APA_VARS VARIABLE=prmtr VALUE=0
	SET_GCODE_VARIABLE MACRO=_APA_VARS VARIABLE=ext_prmtr VALUE=0
	SET_GCODE_VARIABLE MACRO=_APA_VARS VARIABLE=infill VALUE=0
	SET_GCODE_VARIABLE MACRO=_APA_VARS VARIABLE=sld_infill VALUE=0
	SET_GCODE_VARIABLE MACRO=_APA_VARS VARIABLE=top_srfc VALUE=0
	
	{% if start_vars.apa_readback_enable == True %}
	_APA_READ
	{% endif %}
	
	{% endif %}
	{% endif %}

[gcode_macro _APA_READ]
gcode = 
	{% set read_vars = printer["gcode_macro _APA_VARS"] %}
	RESPOND TYPE=COMMAND MSG="APA default {read_vars.default}"
	RESPOND TYPE=COMMAND MSG="APA prmtr {read_vars.prmtr}"
	RESPOND TYPE=COMMAND MSG="APA ext_prmtr {read_vars.ext_prmtr}"
	RESPOND TYPE=COMMAND MSG="APA infill {read_vars.infill}"
	RESPOND TYPE=COMMAND MSG="APA sld_infill {read_vars.sld_infill}"
	RESPOND TYPE=COMMAND MSG="APA top_srfc {read_vars.top_srfc}"
	RESPOND TYPE=COMMAND MSG="APA fil_type {read_vars.fil_type}"
	RESPOND TYPE=COMMAND MSG="APA enable {read_vars.enable}"
	RESPOND TYPE=COMMAND MSG="OAPA state {read_vars.oapa}"

[gcode_macro _ADAPTIVE_PA]
gcode = 
	_DEMON_ADAPTIVE_PA {rawprams}

[gcode_macro _PA_VERSION]
variable_demon_apa = "1.2.0"
gcode = 

[gcode_macro _AES_SYS]
variable_e_stop_armed = False
gcode = 

[gcode_macro _AES_READ]
gcode = 
	{% set aes_vars = printer["gcode_macro _AES_SYS"] %}
	
	{% if aes_vars.e_stop_armed == True %}
	RESPOND TYPE=COMMAND MSG="Homing Z AES System ARMED"
	SET_PIN PIN=AES_SYSTEM_ENABLE_-_KLIPPER_CONTROLLED VALUE=1.0
	{% else %}
	RESPOND TYPE=COMMAND MSG="AES System DISAMRED"
	SET_PIN PIN=AES_SYSTEM_ENABLE_-_KLIPPER_CONTROLLED VALUE=0.0
	{% endif %}

[gcode_macro _AES_VERSION]
variable_demon_aes_ver = "1.1.0"
gcode = 

[gcode_macro _BED_FAN_VARS]
variable_chamber_threshold = 22
variable_chamber_fan = 33
variable_high = 0.55
variable_low = 0.22
variable_cool = True
variable_cool_temp = 25
variable_enable = False
variable_chamber_fan_enable = True
variable_floating_monitor = True
variable_floating_max_speed = 0.50
variable_readback_value = 0
variable_previous_readback_value = 10
variable_previous_chamber_temp = 0
variable_mid_point_temp = 0
variable_mid_point_fan = 0
variable_current_fan_speed = 0.0
variable_previous_floating_fan = 0
variable_macro_used = False
gcode = 

[gcode_macro _FLOATING_FAN]
gcode = 
	{% set bed_vars = printer["gcode_macro _BED_FAN_VARS"] %}
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	{% set core_vars = printer["gcode_macro _CORE_VARS"] %}
	
	{% if core_vars.chamber_thermal_sensor == 0 %}
	{action_raise_error("This error is caused by no correctly named chamber_sensor or temperature controlled chamber_fan being available to the system! Check the system is setup correctly!")}
	
	{% elif core_vars.chamber_thermal_sensor == 1 %}
	{% set thermal_sensor = printer["temperature_fan chamber"].temperature %}
	
	{% elif core_vars.chamber_thermal_sensor == 2 %}
	{% set thermal_sensor = printer["temperature_sensor Chamber_Temp"].temperature %}
	
	{% endif %}
	
	
	{% if bed_vars.readback_value == bed_vars.previous_readback_value %}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=previous_readback_value VALUE={bed_vars.readback_value}
	
	
	
	
	{% if printer["fan_generic Bed_Fans"].speed|float < bed_vars.low|float - 0.01 or printer["fan_generic Bed_Fans"].speed|float > bed_vars.mid_point_fan|float + 0.01 %}
	RESPOND TYPE=COMMAND MSG="Bed Fans Monitor: Floating Fans, fan speed outside floating fans range detected"
	
	{% if bed_vars.previous_floating_fan == 0 %}
	SET_FAN_SPEED FAN=Bed_Fans SPEED={bed_vars.low}
	RESPOND TYPE=COMMAND MSG="Bed Fans Monitor: Floating Fans, resetting to low fan speed"
	
	{% elif bed_vars.previous_floating_fan >= bed_vars.low and bed_vars.previous_floating_fan <= bed_vars.mid_point_fan %}
	SET_FAN_SPEED FAN=Bed_Fans SPEED={bed_vars.previous_floating_fan}
	RESPOND TYPE=COMMAND MSG="Bed Fans Monitor: Floating Fans, resetting to previous fan speed"
	
	{% elif bed_vars.previous_floating_fan > bed_vars.mid_point_fan %}
	SET_FAN_SPEED FAN=Bed_Fans SPEED={bed_vars.mid_point_fan}
	RESPOND TYPE=COMMAND MSG="Bed Fans Monitor: Floating Fans, resetting to floating fan max speed"
	
	{% elif bed_vars.previous_floating_fan < bed_vars.low %}
	SET_FAN_SPEED FAN=Bed_Fans SPEED={bed_vars.low}
	RESPOND TYPE=COMMAND MSG="Bed Fans Monitor: Floating Fans, resetting to low fan speed"
	
	{% endif %}
	
	{% else %}
	
	{% if thermal_sensor <= bed_vars.mid_point_temp|float - 0.1 %}
	{% if start_vars.bed_fans_settings_readback == True %}
	RESPOND TYPE=COMMAND MSG="Bed Fans Monitor: Floating Fans, chamber is colder than mid point target temp"
	{% endif %}
	
	{% if thermal_sensor < bed_vars.previous_chamber_temp|float %}
	{% if start_vars.bed_fans_settings_readback == True %}
	RESPOND TYPE=COMMAND MSG="Bed Fans Monitor: Floating Fans, chamber is colder than previous run"
	{% endif %}
	
	{% if printer["fan_generic Bed_Fans"].speed < bed_vars.mid_point_fan %}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=previous_floating_fan VALUE={("%.2f " % (printer["fan_generic Bed_Fans"].speed))}
	SET_FAN_SPEED FAN=Bed_Fans SPEED={printer["fan_generic Bed_Fans"].speed|float + 0.01}
	
	{% if start_vars.bed_fans_settings_readback == True %}
	RESPOND TYPE=COMMAND MSG="Bed Fans Monitor: Floating Fans, under mid point target, increasing floating fan speed"
	{% endif %}
	{% endif %}
	{% endif %}
	
	{% elif thermal_sensor >= bed_vars.mid_point_temp|float + 0.1 %}
	{% if start_vars.bed_fans_settings_readback == True %}
	RESPOND TYPE=COMMAND MSG="Bed Fans Monitor: Floating Fans, chamber is warmer than mid point target temp"
	{% endif %}
	
	{% if thermal_sensor > bed_vars.previous_chamber_temp|float %}
	{% if start_vars.bed_fans_settings_readback == True %}
	RESPOND TYPE=COMMAND MSG="Bed Fans Monitor: Floating Fans, chamber is warmer than previous run"
	{% endif %}
	
	{% if printer["fan_generic Bed_Fans"].speed > bed_vars.low %}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=previous_floating_fan VALUE={("%.2f " % (printer["fan_generic Bed_Fans"].speed))}
	SET_FAN_SPEED FAN=Bed_Fans SPEED={printer["fan_generic Bed_Fans"].speed|float - 0.01}
	
	{% if start_vars.bed_fans_settings_readback == True %}
	RESPOND TYPE=COMMAND MSG="Bed Fans Monitor: Floating Fans, over mid point target, reducing floating fan speed"
	{% endif %}
	{% endif %}
	{% endif %}
	
	{% endif %}
	{% endif %}
	
	{% else %}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=previous_readback_value VALUE={bed_vars.readback_value}
	{% if start_vars.bed_fans_settings_readback == True %}
	RESPOND TYPE=COMMAND MSG="Bed Fans Monitor: Floating Fans, mode readback value does not equal previous readback value"
	{% endif %}
	
	{% if thermal_sensor < bed_vars.mid_point_temp|float %}
	SET_FAN_SPEED FAN=Bed_Fans SPEED={bed_vars.mid_point_fan}
	{% if start_vars.bed_fans_settings_readback == True %}
	RESPOND TYPE=COMMAND MSG="Bed Fans Monitor: Floating Fans, chamber under mid point target, setting floating fans to scaled maximum"
	{% endif %}
	{% else %}
	SET_FAN_SPEED FAN=Bed_Fans SPEED={bed_vars.low}
	{% if start_vars.bed_fans_settings_readback == True %}
	RESPOND TYPE=COMMAND MSG="Bed Fans Monitor: Floating Fans, chamber under over point target, setting floating fans to low speed scaled minimum"
	{% endif %}
	{% endif %}
	
	BED_FANS_THERMAL_INFO
	
	{% endif %}
	
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=macro_used VALUE=False

[gcode_macro BED_FANS_THERMAL_INFO]
description = Display chamber low & high temperature thresholds & target temp
gcode = 
	{% set bed_vars = printer["gcode_macro _BED_FAN_VARS"] %}
	RESPOND TYPE=COMMAND MSG="Bed Fans theraml thresholds. Mid point chamber target temp {("%.0fc" % (bed_vars.
	mid_point_temp))}. Minimum threshold is {("%.0fc" % (bed_vars.chamber_threshold))}, maximum threshold is {("%.0fc" % (bed_vars.chamber_fan))}."

[gcode_macro BED_FANS_SET_SPEED_INFO]
description = Display Bed Fans low & high power settings as well as Floating Fan
gcode = 
	{% set bed_vars = printer["gcode_macro _BED_FAN_VARS"] %}
	RESPOND TYPE=COMMAND MSG="Bed Fans power range. Low power {("%.0f" % (bed_vars.low|float * 100))}% to floating fans Max Speed {("%.0f" % (bed_vars.
	mid_point_fan|float * 100))}% if active. High speed boost of {("%.0f" % (bed_vars.high|float * 100))}%. Use macro button BED FANS SET SPEED to adjust LOW & HIGH settings"

[gcode_macro FLOATING_FANS_MAX_SPEED_INFO]
description = Display info on how to use Floating Fans Max Speed SCALED_POWER
gcode = 
	{% set bed_vars = printer["gcode_macro _BED_FAN_VARS"] %}
	RESPOND TYPE=COMMAND MSG="Bed Fans Monitor: Floating Fans Max Speed, use macro button for real-time adjustment within set range, this button uses a 0-100% range scaled between your Bed_Fans current low speed value of {("%.0f" % (bed_vars.
	low|float * 100))}%, & your high speed value of {("%.0f" % (bed_vars.high|float * 100))}%. Your current Floating Fans Max Speed is {("%.0f" % (bed_vars.
	mid_point_fan|float * 100))}%. This means your FLOATING FANS MAX SPEED macro button SCALED_POWER setting is {("%.0f" % (bed_vars.floating_max_speed|float * 100))}% of this scaled range."

[gcode_macro _FLOATING_INFO]
gcode = 
	{% set bed_vars = printer["gcode_macro _BED_FAN_VARS"] %}
	RESPOND TYPE=COMMAND MSG="Floating Fans Max Speed. SCALED_POWER value is {("%.0f" % (bed_vars.floating_max_speed|float * 100))}% which equals {("%.0f" % (bed_vars.
	mid_point_fan|float * 100))}% on the BED_FANS slider."

[gcode_macro FLOATING_FANS_MAX_SPEED]
description = Set the max speed made available to your Floating Bed Fans during the print
gcode = 
	{% set bed_vars = printer["gcode_macro _BED_FAN_VARS"] %}
	{% set float_max_speed = params.SCALED_POWER|default(65)|float %}
	
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=macro_used VALUE=True
	
	{% if bed_vars.floating_monitor == True %}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=floating_max_speed VALUE={float_max_speed / 100|float}
	
	
	{% else %}
	RESPOND TYPE=error MSG="Floating fans are not enabled, no changes made. Please check your Demon_user_settings file to enable!"
	{% endif %}

[gcode_macro BED_FANS_SET_SPEED]
description = Set Bed Fans High & Low speeds during the print
gcode = 
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	{% set low_speed = params.LOW_SPEED_PERCENT|default(25)|float %}
	{% set high_speed = params.HIGH_SPEED_PERCENT|default(65)|float %}
	
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=macro_used VALUE=True
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=low VALUE={low_speed / 100|float}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=high VALUE={high_speed / 100|float}

[gcode_macro _BED_FAN_READ]
gcode = 
	{% set bed_vars = printer["gcode_macro _BED_FAN_VARS"] %}
	
	RESPOND TYPE=COMMAND MSG="Bed fans threshold {bed_vars.chamber_threshold}c"
	RESPOND TYPE=COMMAND MSG="Bed fans upper limit {bed_vars.chamber_fan}c"
	RESPOND TYPE=COMMAND MSG="Bed fans high setting {bed_vars.high}"
	RESPOND TYPE=COMMAND MSG="Bed fans low setting {bed_vars.low}"
	RESPOND TYPE=COMMAND MSG="Bed fans Post print cooling {bed_vars.cool}"
	RESPOND TYPE=COMMAND MSG="Bed fans Post print cooling temp {bed_vars.cool_temp}c"
	RESPOND TYPE=COMMAND MSG="Bed fans enable for filament {bed_vars.enable}"
	
	RESPOND TYPE=COMMAND MSG="Bed fans readback value {bed_vars.readback_value}"
	RESPOND TYPE=COMMAND MSG="Bed fans previous readback value {bed_vars.previous_readback_value}"
	RESPOND TYPE=COMMAND MSG="Bed fans current fan {bed_vars.current_fan_speed}"
	RESPOND TYPE=COMMAND MSG="Bed fans actual speed {printer["fan_generic Bed_Fans"].speed}"
	
	RESPOND TYPE=COMMAND MSG="Bed fans temp mid point {bed_vars.mid_point_temp}c"
	RESPOND TYPE=COMMAND MSG="Bed fans previous fan {bed_vars.previous_floating_fan}"
	RESPOND TYPE=COMMAND MSG="Bed fans prev chamber temp {bed_vars.previous_chamber_temp}c"
	RESPOND TYPE=COMMAND MSG="Bed fans max floating fan {bed_vars.floating_max_speed}"
	RESPOND TYPE=COMMAND MSG="Bed mid point fan {bed_vars.mid_point_fan}"

[gcode_macro _BED_FAN_HELPER]
gcode = 
	{% set bed_vars = printer["gcode_macro _BED_FAN_VARS"] %}
	
	{% if bed_vars.readback_value == bed_vars.previous_readback_value %}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=previous_readback_value VALUE={bed_vars.readback_value}
	
	{% if bed_vars.chamber_fan_enable == True %}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=chamber_fan VALUE={printer["temperature_fan chamber"].target}
	{% endif %}
	
	{% if bed_vars.macro_used == True %}
	RESPOND TYPE=COMMAND MSG="Macro used to change Bed Fan speed"
	
	{% else %}
	{% if printer["fan_generic Bed_Fans"].speed|float == bed_vars.current_fan_speed %}
	
	{% elif printer["fan_generic Bed_Fans"].speed|float != bed_vars.current_fan_speed %}
	
	{% if printer["fan_generic Bed_Fans"].speed|float == 0 %}
	RESPOND TYPE=error MSG="The ZERO percent value can NOT be set or modified. To set fans to off use DISBALE_BED_FANS button!"
	
	{% elif printer["fan_generic Bed_Fans"].speed|float > 0.1 and printer["fan_generic Bed_Fans"].speed|float < 0.5 %}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=current_fan_speed VALUE={printer["fan_generic Bed_Fans"].speed|float}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=low VALUE={printer["fan_generic Bed_Fans"].speed|float}
	RESPOND TYPE=COMMAND MSG="Manual slider speed change of under 0.5 detected, applying to LOW_SPEED setting"
	
	{% elif printer["fan_generic Bed_Fans"].speed|float >= 0.5 %}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=current_fan_speed VALUE={printer["fan_generic Bed_Fans"].speed|float}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=high VALUE={printer["fan_generic Bed_Fans"].speed|float}
	RESPOND TYPE=COMMAND MSG="Manual slider speed change of over 0.5 detected, applying to HIGH_SPEED setting"
	
	{% endif %}
	
	{% endif %}
	
	{% endif %}
	
	{% elif bed_vars.readback_value != bed_vars.previous_readback_value %}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=previous_readback_value VALUE={bed_vars.readback_value}
	
	{% if bed_vars.chamber_fan_enable == True %}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=chamber_fan VALUE={printer["temperature_fan chamber"].target}
	{% endif %}
	
	_MONITOR_MESSAGE_READ
	
	{% endif %}
	
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=macro_used VALUE=False

[gcode_macro _MONITOR_FAN_SET]
gcode = 
	
	{% set bed_vars = printer["gcode_macro _BED_FAN_VARS"] %}
	
	{% if bed_vars.readback_value in [1, 4, 5, 7, 8, 9] %}
	SET_FAN_SPEED FAN=Bed_Fans SPEED=0
	
	{% elif bed_vars.readback_value == 2 %}
	SET_FAN_SPEED FAN=Bed_Fans SPEED={bed_vars.high}
	{% elif bed_vars.readback_value == 3 %}
	SET_FAN_SPEED FAN=Bed_Fans SPEED={bed_vars.low}
	
	{% elif bed_vars.readback_value == 6 %}
	SET_FAN_SPEED FAN=Bed_Fans SPEED={bed_vars.low}
	
	{% endif %}

[gcode_macro _MONITOR_MESSAGE_READ]
gcode = 
	
	{% set bed_vars = printer["gcode_macro _BED_FAN_VARS"] %}
	
	{% if bed_vars.readback_value == 1 %}
	RESPOND TYPE=COMMAND MSG="Bed Fans Monitor: Printing, too cold fans set to off while bed heats"
	{% elif bed_vars.readback_value == 2 %}
	RESPOND TYPE=COMMAND MSG="Bed Fans Monitor: Printing, temp under chamber threshold fans set to high speed {bed_vars.high * 100}%"
	{% elif bed_vars.readback_value == 3 %}
	RESPOND TYPE=COMMAND MSG="Bed Fans Monitor: Printing, fans set to low speed {bed_vars.low * 100}%"
	{% elif bed_vars.readback_value == 4 %}
	RESPOND TYPE=COMMAND MSG="Bed Fans Monitor: Printing, fans off due to high chamber temp >{bed_vars.chamber_fan|int}c"
	{% elif bed_vars.readback_value == 5 %}
	RESPOND TYPE=COMMAND MSG="Bed Fans Monitor: Paused, fans auto paused"
	{% elif bed_vars.readback_value == 6 %}
	RESPOND TYPE=COMMAND MSG="Bed Fans Monitor: Cooling post print, fans on low until <{bed_vars.cool_temp|int}c or printer state is changed to Standby"
	{% elif bed_vars.readback_value == 7 %}
	RESPOND TYPE=COMMAND MSG="Bed Fans Monitor: Stopped, fans off"
	{% elif bed_vars.readback_value == 8 %}
	RESPOND TYPE=COMMAND MSG="Bed Fans Monitor: Override on, fans manually paused"
	{% elif bed_vars.readback_value == 9 %}
	RESPOND TYPE=COMMAND MSG="Bed Fans Monitor: Stopped, fans off, Override off"
	
	{% endif %}

[gcode_macro _BED_FAN_SET]
gcode = 
	{% set bed_vars = printer["gcode_macro _BED_FAN_VARS"] %}
	{% set core_vars = printer["gcode_macro _CORE_VARS"] %}
	
	{% if core_vars.chamber_thermal_sensor == 0 %}
	{action_raise_error("This error is caused by no correctly named chamber_sensor or temperature controlled chamber_fan being available to the system! Check the system is setup correctly!")}
	
	{% elif core_vars.chamber_thermal_sensor == 1 %}
	{% set thermal_sensor = printer["temperature_fan chamber"].temperature %}
	
	{% elif core_vars.chamber_thermal_sensor == 2 %}
	{% set thermal_sensor = printer["temperature_sensor Chamber_Temp"].temperature %}
	
	{% endif %}
	
	{% if bed_vars.enable == True %}
	
	{% if printer.heater_bed.temperature < printer.heater_bed.target|int -40 %}
	
	{% if thermal_sensor <= bed_vars.chamber_fan %}
	SET_FAN_SPEED FAN=Bed_Fans SPEED={bed_vars.low}
	RESPOND TYPE=COMMAND MSG="Bed fans set to low while bed heats"
	
	{% elif thermal_sensor > bed_vars.chamber_fan %}
	SET_FAN_SPEED FAN=Bed_Fans SPEED=0
	RESPOND TYPE=COMMAND MSG="Bed fans set to off due to high chamber temp >{bed_vars.chamber_fan}c"
	
	{% endif %}
	
	{% elif printer.heater_bed.temperature >= printer.heater_bed.target|int -40 %}
	
	{% if thermal_sensor <= bed_vars.chamber_threshold %}
	SET_FAN_SPEED FAN=Bed_Fans SPEED={bed_vars.high}
	RESPOND TYPE=COMMAND MSG="Bed fans set to high speed for Heat Soak {bed_vars.high|float * 100.00}%"
	
	{% elif thermal_sensor > bed_vars.chamber_threshold %}
	{% if thermal_sensor <= bed_vars.chamber_fan %}
	SET_FAN_SPEED FAN=Bed_Fans SPEED={bed_vars.low}
	RESPOND TYPE=COMMAND MSG="Bed fans set to low speed {bed_vars.low|float * 100.00}%"
	
	{% elif thermal_sensor > bed_vars.chamber_fan %}
	SET_FAN_SPEED FAN=Bed_Fans SPEED=0
	RESPOND TYPE=COMMAND MSG="Bed fans set to off due to high chamber temp >{bed_vars.chamber_fan}c"
	
	{% endif %}
	
	{% endif %}
	
	{% endif %}
	
	{% else %}
	RESPOND TYPE=COMMAND MSG="Bed Fans disabled in settings"
	
	{% endif %}

[delayed_gcode _BED_FAN_MONITOR]
gcode = 
	{% set bed_vars = printer["gcode_macro _BED_FAN_VARS"] %}
	{% set core_vars = printer["gcode_macro _CORE_VARS"] %}
	
	{% if core_vars.chamber_thermal_sensor == 0 %}
	{action_raise_error("This error is caused by no correctly named chamber_sensor or temperature controlled chamber_fan being available to the system! Check the system is setup correctly!")}
	
	{% elif core_vars.chamber_thermal_sensor == 1 %}
	{% set thermal_sensor = printer["temperature_fan chamber"].temperature %}
	
	{% elif core_vars.chamber_thermal_sensor == 2 %}
	{% set thermal_sensor = printer["temperature_sensor Chamber_Temp"].temperature %}
	
	{% endif %}
	
	{% if bed_vars.enable == True %}
	{% if printer["output_pin DISABLE_BED_FANS"].value == 0 %}
	{% if printer.print_stats.state == "printing" %}
	{% if thermal_sensor < bed_vars.chamber_threshold %}
	{% if printer.heater_bed.temperature <= printer.heater_bed.target|int -5 %}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=readback_value VALUE=1
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=current_fan_speed VALUE=0
	_BED_FAN_HELPER
	_MONITOR_FAN_SET
	UPDATE_DELAYED_GCODE ID=_BED_FAN_MONITOR DURATION=10
	
	
	{% else %}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=readback_value VALUE=2
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=current_fan_speed VALUE={bed_vars.high}
	_BED_FAN_HELPER
	_MONITOR_FAN_SET
	UPDATE_DELAYED_GCODE ID=_BED_FAN_MONITOR DURATION=10
	
	
	{% endif %}
	
	{% elif thermal_sensor >= bed_vars.chamber_threshold %}
	{% if printer.heater_bed.temperature <= printer.heater_bed.target|int -5 %}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=readback_value VALUE=1
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=current_fan_speed VALUE=0
	_BED_FAN_HELPER
	_MONITOR_FAN_SET
	UPDATE_DELAYED_GCODE ID=_BED_FAN_MONITOR DURATION=10
	
	
	{% elif thermal_sensor <= bed_vars.chamber_fan %}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=readback_value VALUE=3
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=current_fan_speed VALUE={bed_vars.low}
	
	{% if bed_vars.floating_monitor == True %}
	
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=mid_point_fan VALUE={("%.2f " % (((bed_vars.high - bed_vars.low) * bed_vars.floating_max_speed) + bed_vars.low|float))}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=mid_point_temp VALUE={(bed_vars.chamber_threshold + bed_vars.chamber_fan) / 2|float}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=previous_chamber_temp VALUE={thermal_sensor|float}
	{% if bed_vars.chamber_fan_enable == True %}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=chamber_fan VALUE={printer["temperature_fan chamber"].target}
	{% endif %}
	_FLOATING_FAN
	
	{% else %}
	_BED_FAN_HELPER
	_MONITOR_FAN_SET
	{% endif %}
	
	UPDATE_DELAYED_GCODE ID=_BED_FAN_MONITOR DURATION=10
	
	
	{% elif thermal_sensor > bed_vars.chamber_fan %}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=readback_value VALUE=4
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=current_fan_speed VALUE=0
	_BED_FAN_HELPER
	_MONITOR_FAN_SET
	UPDATE_DELAYED_GCODE ID=_BED_FAN_MONITOR DURATION=20
	
	
	{% else %}
	M118 oops
	UPDATE_DELAYED_GCODE ID=_BED_FAN_MONITOR DURATION=10
	
	{% endif %}
	
	{% endif %}
	
	{% elif printer.print_stats.state == "paused" %}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=readback_value VALUE=5
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=current_fan_speed VALUE=0
	_BED_FAN_HELPER
	_MONITOR_FAN_SET
	UPDATE_DELAYED_GCODE ID=_BED_FAN_MONITOR DURATION=0
	
	
	
	{% elif printer.print_stats.state in ["complete", "cancelled", "error"] %}
	{% if bed_vars.cool == True and thermal_sensor >= bed_vars.cool_temp %}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=readback_value VALUE=6
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=current_fan_speed VALUE={bed_vars.low}
	_BED_FAN_HELPER
	_MONITOR_FAN_SET
	UPDATE_DELAYED_GCODE ID=_BED_FAN_MONITOR DURATION=10
	
	
	{% else %}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=readback_value VALUE=7
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=current_fan_speed VALUE=0
	_BED_FAN_HELPER
	_MONITOR_FAN_SET
	UPDATE_DELAYED_GCODE ID=_BED_FAN_MONITOR DURATION=0
	
	
	{% endif %}
	
	{% elif printer.print_stats.state == "standby" %}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=readback_value VALUE=7
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=current_fan_speed VALUE=0
	_BED_FAN_HELPER
	_MONITOR_FAN_SET
	UPDATE_DELAYED_GCODE ID=_BED_FAN_MONITOR DURATION=0
	
	
	{% endif %}
	
	{% elif printer["output_pin DISABLE_BED_FANS"].value == 1.0 %}
	{% if printer.print_stats.state in  ["printing", "paused"] %}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=readback_value VALUE=8
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=current_fan_speed VALUE=0
	_BED_FAN_HELPER
	_MONITOR_FAN_SET
	UPDATE_DELAYED_GCODE ID=_BED_FAN_MONITOR DURATION=10
	
	
	{% elif printer.print_stats.state in ["complete", "cancelled", "error"] %}
	{% if bed_vars.cool == True and thermal_sensor >= bed_vars.cool_temp %}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=readback_value VALUE=6
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=current_fan_speed VALUE={bed_vars.low}
	_BED_FAN_HELPER
	_MONITOR_FAN_SET
	UPDATE_DELAYED_GCODE ID=_BED_FAN_MONITOR DURATION=10
	SET_PIN PIN=DISABLE_BED_FANS VALUE=0.00
	
	
	{% else %}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=readback_value VALUE=9
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=current_fan_speed VALUE=0
	_BED_FAN_HELPER
	_MONITOR_FAN_SET
	UPDATE_DELAYED_GCODE ID=_BED_FAN_MONITOR DURATION=0
	SET_PIN PIN=DISABLE_BED_FANS VALUE=0.00
	
	
	{% endif %}
	
	{% elif printer.print_stats.state == "standby" %}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=readback_value VALUE=9
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=current_fan_speed VALUE=0
	_BED_FAN_HELPER
	_MONITOR_FAN_SET
	UPDATE_DELAYED_GCODE ID=_BED_FAN_MONITOR DURATION=0
	SET_PIN PIN=DISABLE_BED_FANS VALUE=0.00
	
	
	{% endif %}
	
	{% else %}
	UPDATE_DELAYED_GCODE ID=_BED_FAN_MONITOR DURATION=10
	
	
	{% endif %}
	
	{% else %}
	RESPOND TYPE=error MSG="Bed Fans disabled in settings"
	
	{% endif %}

[gcode_macro _BED_FANS_VERSION]
variable_demon_bed_fans = "1.3.0"
gcode = 

[gcode_macro _C_HEATER_VARS]
variable_min_thresold = 20
variable_mid_point = 40
variable_max_thresold = 60
gcode = 

[gcode_macro _CHAMBER_HEATER_READ]
gcode = 
	{% set core_vars = printer["gcode_macro _CORE_VARS"] %}
	{% set c_heater_vars = printer["gcode_macro _C_HEATER_VARS"] %}
	
	{% if core_vars.chamber_thermal_sensor == 0 %}
	{action_raise_error("This error is caused by no correctly named chamber sensor being available to the macro! Check the system is setup correctly!")}
	
	{% elif core_vars.chamber_thermal_sensor == 1 %}
	{% set Temp = printer["temperature_fan chamber"].temperature %}
	
	{% elif core_vars.chamber_thermal_sensor == 2 %}
	{% set Temp = printer["temperature_sensor Chamber_Temp"].temperature %}
	
	{% endif %}
	
	RESPOND TYPE=COMMAND MSG="Chamber Heater: Current chamber temp {Temp}c"
	RESPOND TYPE=COMMAND MSG="Chamber Heater: Minimum thresold {c_heater_vars.min_thresold}c"
	RESPOND TYPE=COMMAND MSG="Chamber Heater: Mid point {c_heater_vars.mid_point}c"
	RESPOND TYPE=COMMAND MSG="Chamber Heater: Maximum thresold {c_heater_vars.max_thresold}c"

[gcode_macro _CHAMBER_HEATER_MONITOR]
gcode = 
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	{% set core_vars = printer["gcode_macro _CORE_VARS"] %}
	{% set c_heater_vars = printer["gcode_macro _C_HEATER_VARS"] %}
	
	{% if core_vars.chamber_thermal_sensor == 0 %}
	{action_raise_error("This error is caused by no correctly named chamber sensor being available to the macro! Check the system is setup correctly!")}
	
	{% elif core_vars.chamber_thermal_sensor == 1 %}
	{% set Temp = printer["temperature_fan chamber"].temperature %}
	
	{% elif core_vars.chamber_thermal_sensor == 2 %}
	{% set Temp = printer["temperature_sensor Chamber_Temp"].temperature %}
	
	{% endif %}
	
	
	{% if start_vars.danger_will_robinson != True %}
	{action_raise_error("This error is caused by you not agreeing to full & sole reasonability/liability of using a chamber heater with these macros before first use. Check demon_user_settings file for variable_danger_will_robinson & agree to the terms!")}
	
	{% else %}
	
	{% if printer.print_stats.state not in ["printing", "busy"] %}
	SET_HEATER_TEMPERATURE HEATER=Chamber_Heater TARGET=0
	RESPOND TYPE=COMMAND MSG="Chamber Heater: Not Printing, Chamber Heater Control stopped, setting heater OFF"
	UPDATE_DELAYED_GCODE ID=_CHAMBER_HEAT_CONTROL DURATION=0
	{% if start_vars.heater_neo == True %}
	SET_LED LED="Chamber_Heater_Neopixel" RED=1.0 GREEN=0.0 BLUE=1.0 WHITE=0 SYNC=0 TRANSMIT=1
	{% endif %}
	
	{% else %}
	
	{% if printer["output_pin DISABLE_CHAMBER_HEATER"].value == 0 %}
	
	
	
	{% if Temp >= 23|int and core_vars.filament in ['PLA', 'PLA+'] %}
	SET_HEATER_TEMPERATURE HEATER=Chamber_Heater TARGET=0
	{% if start_vars.heater_neo == True %}
	SET_LED LED="Chamber_Heater_Neopixel" RED=0.0 GREEN=0.1 BLUE=1.0 WHITE=0 SYNC=0 TRANSMIT=1
	{% endif %}
	
	UPDATE_DELAYED_GCODE ID=_CHAMBER_HEAT_CONTROL DURATION=20
	
	{% elif Temp < c_heater_vars.min_thresold %}
	SET_HEATER_TEMPERATURE HEATER=Chamber_Heater TARGET={start_vars.heater_high}
	{% if start_vars.heater_neo == True %}
	SET_LED LED="Chamber_Heater_Neopixel" RED=1.0 GREEN=0.0 BLUE=0 WHITE=0 SYNC=0 TRANSMIT=1
	{% endif %}
	
	UPDATE_DELAYED_GCODE ID=_CHAMBER_HEAT_CONTROL DURATION=20
	
	{% elif Temp >= c_heater_vars.min_thresold and Temp <= c_heater_vars.mid_point %}
	SET_HEATER_TEMPERATURE HEATER=Chamber_Heater TARGET={start_vars.heater_mid}
	{% if start_vars.heater_neo == True %}
	SET_LED LED="Chamber_Heater_Neopixel" RED=1.0 GREEN=0.2 BLUE=0 WHITE=0 SYNC=0 TRANSMIT=1
	{% endif %}
	
	UPDATE_DELAYED_GCODE ID=_CHAMBER_HEAT_CONTROL DURATION=20
	
	{% elif Temp >= c_heater_vars.mid_point and Temp <= c_heater_vars.max_thresold - 5 %}
	SET_HEATER_TEMPERATURE HEATER=Chamber_Heater TARGET={start_vars.heater_low}
	{% if start_vars.heater_neo == True %}
	SET_LED LED="Chamber_Heater_Neopixel" RED=1.0 GREEN=0.6 BLUE=0 WHITE=0 SYNC=0 TRANSMIT=1
	{% endif %}
	
	UPDATE_DELAYED_GCODE ID=_CHAMBER_HEAT_CONTROL DURATION=20
	
	{% elif Temp > c_heater_vars.max_thresold - 2 %}
	SET_HEATER_TEMPERATURE HEATER=Chamber_Heater TARGET=0
	{% if start_vars.heater_neo == True %}
	SET_LED LED="Chamber_Heater_Neopixel" RED=0.0 GREEN=0.1 BLUE=1.0 WHITE=0 SYNC=0 TRANSMIT=1
	{% endif %}
	
	UPDATE_DELAYED_GCODE ID=_CHAMBER_HEAT_CONTROL DURATION=20
	
	{% endif %}
	
	{% elif printer["output_pin DISABLE_CHAMBER_HEATER"].value == 1 %}
	SET_HEATER_TEMPERATURE HEATER=Chamber_Heater TARGET=0
	{% if start_vars.heater_neo == True %}
	SET_LED LED="Chamber_Heater_Neopixel" RED=1.0 GREEN=0.0 BLUE=1.0 WHITE=0 SYNC=0 TRANSMIT=1
	{% endif %}
	
	UPDATE_DELAYED_GCODE ID=_CHAMBER_HEAT_CONTROL DURATION=20
	
	{% endif %}
	{% endif %}
	{% endif %}

[delayed_gcode _CHAMBER_HEAT_CONTROL]
gcode = 
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	
	{% if start_vars.danger_will_robinson != True %}
	{action_raise_error("This error is caused by you not agreeing to full & sole reasonability/liability of using a chamber heater with these macros before first use. Check demon_user_settings file for variable_danger_will_robinson & agree to the terms!")}
	
	{% else %}
	_CHAMBER_HEATER_MONITOR
	
	{% endif %}

[gcode_macro _CHAMBER_HEATER_VERSION]
variable_demon_chamber_heater_ver = "1.1.1"
gcode = 

[gcode_macro LOAD_CLEAN]
gcode = 
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	{% set clean_vars = printer["gcode_macro _CLEAN_VARIABLES"] %}
	{% set ceal = printer["gcode_macro CUSTOM_EXPANSION_ACTIVE_LIST"] %}
	{% set temp = params.TEMP|default(250)|float %}
	{% set speed = params.SPEED_MMsec|default(7)|float * 60 %}
	{% set max_velocity = printer.configfile.settings['extruder'].max_extrude_only_velocity * 60 %}
	
	_MAX_EXTRUDE_CHECK
	
	{% if clean_vars.have_you_set_this_up != True %}
	{action_raise_error("This error is caused by you not setting up this feature before first use. Check demon_user_settings file & set this feature up correctly for your printer!")}
	
	{% elif printer.print_stats.state in ['printing', 'paused'] %}
	RESPOND TYPE=error MSG="Request denied, current printer state is printing/paused"
	
	{% else %}
	
	{% if start_vars.nozzle_cleaner == True and start_vars.purge_bucket == True %}
	SAVE_GCODE_STATE NAME=load_clean_state
	_RUNOUT_SENSOR_CHECK
	M400
	
	{% if ceal.ceal_master_enable == True %}
	{% if ceal.pre_load_clean == True %}
	_CUSTOM_PRE_LOAD_CLEAN {rawparams}
	{% endif %}
	{% endif %}
	
	{% if start_vars.neopixel_led == True %}
	STATUS_HEATING
	{% endif %}
	
	M117 HEATING...
	SET_HEATER_TEMPERATURE HEATER=extruder TARGET={clean_vars.nozzle_pre_temp}
	TEMPERATURE_WAIT SENSOR=extruder MINIMUM={clean_vars.nozzle_pre_temp - 5} MAXIMUM={clean_vars.nozzle_pre_temp + 50}
	
	_CONDITIONAL_HOME
	
	G90
	M83
	{% if start_vars.neopixel_led == True %}
	STATUS_READY
	{% endif %}
	
	
	{% if printer.toolhead.position.z|float < 20 %}
	G0 Z20 F3600
	{% endif %}
	
	_random_spot
	G0 Z{clean_vars.purge_z_park} F3000
	M400
	M117 Heating to Load...
	{% if start_vars.neopixel_led == True %}
	STATUS_HEATING
	{% endif %}
	
	
	SET_HEATER_TEMPERATURE HEATER=extruder TARGET={temp}
	TEMPERATURE_WAIT SENSOR=extruder MINIMUM={temp - 2} MAXIMUM={temp + 5}
	
	M106 S255
	M117 LOADING.....
	{% if start_vars.neopixel_led == True %}
	STATUS_PRINTING
	{% endif %}
	
	_ENCODER_FEED_CHECK_PREP
	
	G92 E0
	G1 E{clean_vars.load_clean_load_dist} F{max_velocity}
	M400
	
	_ENCODER_FEED_CHECK
	
	G1 E{clean_vars.load_clean_purge_dist} F{speed}
	G4 P10000
	
	_random_spot
	
	M107
	
	G1 E-5 F300
	G4 P10000
	
	_random_spot
	
	M106 S255
	
	M400
	M117 Post Load Cooling...
	{% if start_vars.neopixel_led == True %}
	STATUS_HEATING
	{% endif %}
	
	SET_HEATER_TEMPERATURE HEATER=extruder TARGET={clean_vars.nozzle_post_temp}
	TEMPERATURE_WAIT SENSOR=extruder MINIMUM={clean_vars.nozzle_post_temp - 5} MAXIMUM={clean_vars.nozzle_post_temp + 10}
	_random_spot
	
	M107
	M118 WARNING Nozzle Cleaning 5 Seconds...
	M117 WARNING Nozzle Cleaning 5 Seconds...
	G4 P5000
	M118 Nozzle Cleaning...
	M117 Nozzle Cleaning...
	CLEAN_NOZZLE
	
	M400
	M117
	
	SET_HEATER_TEMPERATURE HEATER=extruder TARGET=0
	{% if start_vars.neopixel_led == True %}
	STATUS_READY
	{% endif %}
	
	{% if start_vars.runout_sensor == True %}
	SET_FILAMENT_SENSOR SENSOR=filament_sensor ENABLE=1
	{% endif %}
	
	{% if ceal.ceal_master_enable == True %}
	{% if ceal.post_load_clean == True %}
	_CUSTOM_POST_LOAD_CLEAN {rawparams}
	{% endif %}
	{% endif %}
	
	RESTORE_GCODE_STATE NAME=load_clean_state
	_SAVE
	
	{% else %}
	{action_raise_error("This error is caused by the nozzle_cleaner & purge_bucket both not being enabled Check demon_user_settings file!")}
	{% endif %}
	
	{% endif %}

[gcode_macro UNLOAD_CLEAN]
gcode = 
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	{% set clean_vars = printer["gcode_macro _CLEAN_VARIABLES"] %}
	{% set ceal = printer["gcode_macro CUSTOM_EXPANSION_ACTIVE_LIST"] %}
	{% set temp = params.TEMP|default(250)|float %}
	{% set speed = params.SPEED_MMsec|default(7)|float * 60 %}
	{% set max_velocity = printer.configfile.settings['extruder'].max_extrude_only_velocity * 60 %}
	
	_MAX_EXTRUDE_CHECK
	
	{% if clean_vars.have_you_set_this_up != True %}
	{action_raise_error("This error is caused by you not setting up this feature before first use. Check demon_user_settings file & set this feature up correctly for your printer!")}
	
	{% elif printer.print_stats.state in ['printing', 'paused'] %}
	RESPOND TYPE=error MSG="Request denied, current printer state is printing/paused"
	
	{% else %}
	
	{% if start_vars.nozzle_cleaner == True and start_vars.purge_bucket == True %}
	SAVE_GCODE_STATE NAME=unload_clean_state
	_RUNOUT_SENSOR_CHECK
	M400
	
	{% if ceal.ceal_master_enable == True %}
	{% if ceal.pre_unload_clean == True %}
	_CUSTOM_PRE_LOAD_CLEAN {rawparams}
	{% endif %}
	{% endif %}
	
	{% if start_vars.neopixel_led == True %}
	STATUS_HEATING
	{% endif %}
	
	M117 HEATING...
	SET_HEATER_TEMPERATURE HEATER=extruder TARGET={clean_vars.nozzle_pre_temp}
	TEMPERATURE_WAIT SENSOR=extruder MINIMUM={clean_vars.nozzle_pre_temp - 5} MAXIMUM={clean_vars.nozzle_pre_temp + 50}
	
	_CONDITIONAL_HOME
	
	{% if start_vars.runout_sensor == True %}
	SET_FILAMENT_SENSOR SENSOR=filament_sensor ENABLE=0
	{% endif %}
	
	G90
	M83
	{% if start_vars.neopixel_led == True %}
	STATUS_READY
	{% endif %}
	
	
	{% if printer.toolhead.position.z|float < 20 %}
	G0 Z20 F3600
	{% endif %}
	
	_random_spot
	G0 Z{clean_vars.purge_z_park} F3000
	M400
	M117 Heating to Unload...
	{% if start_vars.neopixel_led == True %}
	STATUS_HEATING
	{% endif %}
	
	SET_HEATER_TEMPERATURE HEATER=extruder TARGET={temp}
	TEMPERATURE_WAIT SENSOR=extruder MINIMUM={temp - 2} MAXIMUM={temp + 5}
	
	M117 UNLOADING.....
	{% if start_vars.neopixel_led == True %}
	STATUS_PRINTING
	{% endif %}
	
	_ENCODER_FEED_CHECK_PREP
	
	G92 E0
	G1 E{clean_vars.unload_clean_purge_dist} F{speed}
	M400
	
	_ENCODER_FEED_CHECK
	
	G4 P5000
	_random_spot
	G1 E-{clean_vars.unload_clean_unload_dist} F{max_velocity}
	M106 S255
	G4 P5000
	_random_spot
	
	M400
	M117 Post Unload Cooling...
	{% if start_vars.neopixel_led == True %}
	STATUS_HEATING
	{% endif %}
	
	SET_HEATER_TEMPERATURE HEATER=extruder TARGET={clean_vars.nozzle_post_temp}
	TEMPERATURE_WAIT SENSOR=extruder MINIMUM={clean_vars.nozzle_post_temp - 5} MAXIMUM={clean_vars.nozzle_post_temp + 10}
	
	M107
	M118 WARNING Nozzle Cleaning 5 Seconds...
	M117 WARNING Nozzle Cleaning 5 Seconds...
	G4 P5000
	M118 Nozzle Cleaning...
	M117 Nozzle Cleaning...
	CLEAN_NOZZLE
	
	M400
	M117
	
	TURN_OFF_HEATERS
	{% if start_vars.neopixel_led == True %}
	STATUS_READY
	{% endif %}
	
	{% if start_vars.runout_sensor == True %}
	SET_FILAMENT_SENSOR SENSOR=filament_sensor ENABLE=1
	{% endif %}
	
	{% if ceal.ceal_master_enable == True %}
	{% if ceal.post_unload_clean == True %}
	_CUSTOM_POST_UNLOAD_CLEAN {rawparams}
	{% endif %}
	{% endif %}
	
	RESTORE_GCODE_STATE NAME=unload_clean_state
	_SAVE
	
	{% else %}
	{action_raise_error("This error is caused by the nozzle_cleaner & purge_bucket both not being enabled. Check demon_user_settings file!")}
	{% endif %}
	
	{% endif %}

[gcode_macro _CLEAN_LOAD_VERSION]
variable_demon_clean_load = "1.9.1"
gcode = 

[gcode_macro _CORE_VARS]
variable_orca_bed_offset = 0.00
variable_offset_reset = False
variable_orca_surface = "High Temp Plate"
variable_filament = "PLA"
variable_layer = 0.2
variable_bed = 0
variable_chamber_thermal_sensor = 0
variable_heat_wait_temp = 10
variable_fan_speed = 0
variable_nm_fan_speed = 0
variable_last_known_z = 0
variable_no_home_z_move = False
gcode = 

[gcode_macro PRINT_START_HEATSOAK_TIMERS]
description = Choose the temps for your PRINT START heatsoak. Any changes not visable in saved file, only in active RAM. Use the readback macro to see current settings!
gcode = 
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	{% set lotimer = params.LOW_TEMP_TIMER|default(0)|int %}
	{% set hitimer = params.HI_TEMP_TIMER|default(0)|int %}
	{% set detimer = params.DEFAULT_TEMP_TIMER|default(0)|int %}
	
	{% if 'LOW_TEMP_TIMER' not in params and 'HI_TEMP_TIMER' not in params and 'DEFAULT_TEMP_TIMER' not in params %}
	RESPOND TYPE=error MSG="Please enter a value to change the setting!"
	
	{% else %}
	{% if 'LOW_TEMP_TIMER' in params %}
	{% if lotimer <= 0 %}
	RESPOND TYPE=COMMAND MSG="Print start heatsoak timer cannot be 0, value of 1 or higher can be accepted. Timer set for 1 minute."
	SET_GCODE_VARIABLE MACRO=_START_VARIABLES VARIABLE=lo_temp_timer VALUE=1
	
	{% elif lotimer >= 1 %}
	RESPOND TYPE=COMMAND MSG="Print start heatsoak. Low temp timer set to {lotimer|int} minutes"
	SET_GCODE_VARIABLE MACRO=_START_VARIABLES VARIABLE=lo_temp_timer VALUE={lotimer|int}
	{% endif %}
	
	{% else %}
	{% endif %}
	
	{% if 'HI_TEMP_TIMER' in params %}
	{% if hitimer <= 0 %}
	RESPOND TYPE=COMMAND MSG="Print start heatsoak timer cannot be 0, value of 1 or higher can be accepted. Timer set for 1 minute."
	SET_GCODE_VARIABLE MACRO=_START_VARIABLES VARIABLE=hi_temp_timer VALUE=1
	
	{% elif hitimer >= 1 %}
	RESPOND TYPE=COMMAND MSG="Print start heatsoak. High temp timer set to {hitimer|int} minutes"
	SET_GCODE_VARIABLE MACRO=_START_VARIABLES VARIABLE=hi_temp_timer VALUE={hitimer|int}
	{% endif %}
	
	{% else %}
	{% endif %}
	
	{% if 'DEFAULT_TEMP_TIMER' in params %}
	{% if detimer <= 0 %}
	RESPOND TYPE=COMMAND MSG="Print start heatsoak timer cannot be 0, value of 1 or higher can be accepted. Timer set for 1 minute."
	SET_GCODE_VARIABLE MACRO=_START_VARIABLES VARIABLE=default_temp_timer VALUE=1
	
	{% elif hitimer >= 1 %}
	RESPOND TYPE=COMMAND MSG="Print start heatsoak. Default temp timer for unassigned profiles set to {detimer|int} minutes"
	SET_GCODE_VARIABLE MACRO=_START_VARIABLES VARIABLE=default_temp_timer VALUE={detimer|int}
	{% endif %}
	
	{% else %}
	{% endif %}
	
	{% endif %}

[gcode_macro NEVERMORE_TOGGLE]
description = Toggle the use of your NEVERMORE fan on & off with each click of this button! State must be set BEFORE you start a print! If you dont have a fan you will get errors on use!
gcode = 
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	
	{% if start_vars.nevermore == False %}
	RESPOND TYPE=error MSG="NEVERMORE FAN ENABLED!"
	SET_GCODE_VARIABLE MACRO=_START_VARIABLES VARIABLE=nevermore VALUE=True
	
	{% elif start_vars.nevermore == True %}
	RESPOND TYPE=error MSG="NEVERMORE FAN DISABLED!"
	SET_GCODE_VARIABLE MACRO=_START_VARIABLES VARIABLE=nevermore VALUE=False
	{% endif %}

[gcode_macro ADAPTIVE_MESHING_TOGGLE]
description = Toggle the use of adaptive besh meshing on & off with each click of this button! State must be set BEFORE you start a print! Must have bed meshes built & stored!
gcode = 
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	
	{% if start_vars.adaptive_meshing == False %}
	RESPOND TYPE=error MSG="ADAPTIVE MESHING IS ON!"
	SET_GCODE_VARIABLE MACRO=_START_VARIABLES VARIABLE=adaptive_meshing VALUE=True
	
	{% elif start_vars.adaptive_meshing == True %}
	RESPOND TYPE=error MSG="ADAPTIVE MESHING IS OFF!"
	SET_GCODE_VARIABLE MACRO=_START_VARIABLES VARIABLE=adaptive_meshing VALUE=False
	{% endif %}

[gcode_macro PURGE_LINE_TOGGLE]
description = Toggle the printing of all PRINT_START purge lines on & off with each click of this button! State must be set BEFORE you start a print!
gcode = 
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	
	{% if start_vars.purge_lines == False %}
	RESPOND TYPE=error MSG="PURGE LINE PRINTING IS ON!"
	SET_GCODE_VARIABLE MACRO=_START_VARIABLES VARIABLE=purge_lines VALUE=True
	
	{% elif start_vars.purge_lines == True %}
	RESPOND TYPE=error MSG="PURGE LINE PRINTING IS OFF!"
	SET_GCODE_VARIABLE MACRO=_START_VARIABLES VARIABLE=purge_lines VALUE=False
	{% endif %}

[gcode_macro PRINT_START_QUICK_SETTINGS_READBACK]
description = Use this macro to see your live Quick Settings! Any changes to these Quick Settings are not visible in the saved macro files. Only in active RAM.
gcode = 
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	
	RESPOND TYPE=COMMAND MSG="Nevermore Enabled: {start_vars.nevermore}"
	RESPOND TYPE=COMMAND MSG="Default temperature heatsoak timer for unassigned profiles is set to {start_vars.default_temp_timer} minutes"
	RESPOND TYPE=COMMAND MSG="Low temperature heatsoak timer is set to {start_vars.lo_temp_timer} minutes"
	RESPOND TYPE=COMMAND MSG="High temperature heatsoak timer is set to {start_vars.hi_temp_timer} minutes"
	RESPOND TYPE=COMMAND MSG="Adaptive meshing is active: {start_vars.adaptive_meshing}"
	RESPOND TYPE=COMMAND MSG="Draw PRINT_START purge line is active: {start_vars.purge_lines}"
	RESPOND TYPE=COMMAND MSG="Heatsoak timer is to be skipped: {start_vars.start_my_print_already}"

[gcode_macro _INITIAL_SETUP]
gcode = 
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	{% set core_vars = printer["gcode_macro _CORE_VARS"] %}
	
	M220 S{start_vars.feed_rate}
	
	{% if core_vars.filament in ['PLA', 'PLA+'] and core_vars.layer|float <0.25%}
	{% if start_vars.disable_set_flow != True %}
	M221 S{start_vars.pla_flow_rate}
	{% endif %}
	SET_PRESSURE_ADVANCE ADVANCE={start_vars.pla_pa} SMOOTH_TIME={start_vars.pla_st}
	
	{% elif core_vars.filament == 'ASA' and core_vars.layer|float <0.25%}
	{% if start_vars.disable_set_flow != True %}
	M221 S{start_vars.asa_flow_rate}
	{% endif %}
	SET_PRESSURE_ADVANCE ADVANCE={start_vars.asa_pa} SMOOTH_TIME={start_vars.asa_st}
	
	{% elif core_vars.filament == 'ABS' and core_vars.layer|float <0.25%}
	{% if start_vars.disable_set_flow != True %}
	M221 S{start_vars.abs_flow_rate}
	{% endif %}
	SET_PRESSURE_ADVANCE ADVANCE={start_vars.abs_pa} SMOOTH_TIME={start_vars.abs_st}
	
	{% elif core_vars.filament in ['PET', 'PETG'] and core_vars.layer|float <0.25%}
	{% if start_vars.disable_set_flow != True %}
	M221 S{start_vars.petg_flow_rate}
	{% endif %}
	SET_PRESSURE_ADVANCE ADVANCE={start_vars.petg_pa} SMOOTH_TIME={start_vars.petg_st}
	
	{% elif core_vars.filament in ['FLEX', 'TPU'] and core_vars.layer|float <0.25%}
	{% if start_vars.disable_set_flow != True %}
	M221 S{start_vars.tpu_flow_rate}
	{% endif %}
	SET_PRESSURE_ADVANCE ADVANCE={start_vars.tpu_pa} SMOOTH_TIME={start_vars.tpu_st}
	
	{% elif core_vars.filament in ['PLA', 'PLA+'] and core_vars.layer|float >0.26%}
	{% if start_vars.disable_set_flow != True %}
	M221 S{start_vars.pla_hi_flow_rate}
	{% endif %}
	SET_PRESSURE_ADVANCE ADVANCE={start_vars.pla_pa} SMOOTH_TIME={start_vars.pla_st}
	
	{% elif core_vars.filament == 'ASA' and core_vars.layer|float >0.26%}
	{% if start_vars.disable_set_flow != True %}
	M221 S{start_vars.asa_hi_flow_rate}
	{% endif %}
	SET_PRESSURE_ADVANCE ADVANCE={start_vars.asa_pa} SMOOTH_TIME={start_vars.asa_st}
	
	{% elif core_vars.filament == 'ABS' and core_vars.layer|float >0.26%}
	{% if start_vars.disable_set_flow != True %}
	M221 S{start_vars.abs_hi_flow_rate}
	{% endif %}
	SET_PRESSURE_ADVANCE ADVANCE={start_vars.abs_pa} SMOOTH_TIME={start_vars.abs_st}
	
	{% elif core_vars.filament in ['PET', 'PETG'] and core_vars.layer|float >0.26%}
	{% if start_vars.disable_set_flow != True %}
	M221 S{start_vars.petg_hi_flow_rate}
	{% endif %}
	SET_PRESSURE_ADVANCE ADVANCE={start_vars.petg_pa} SMOOTH_TIME={start_vars.petg_st}
	
	{% elif core_vars.filament in ['FLEX', 'TPU'] and core_vars.layer|float >0.26%}
	{% if start_vars.disable_set_flow != True %}
	M221 S{start_vars.tpu_hi_flow_rate}
	{% endif %}
	SET_PRESSURE_ADVANCE ADVANCE={start_vars.tpu_pa} SMOOTH_TIME={start_vars.tpu_st}
	
	{% endif %}

[gcode_macro _CHAMBER_SENSOR_DEFINE]
gcode = 
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	{% set core_vars = printer["gcode_macro _CORE_VARS"] %}
	
	{% if start_vars.chamber_fan and start_vars.chamber_sensor == True %}
	{action_raise_error("This error is caused by multiple chamber thermal sensors being set for use in the demon_user_settings file, please disable one sensor & restart the print!")}
	
	{% elif ('temperature_sensor Chamber_Temp' not in printer.configfile.config) and ('temperature_fan chamber' not in printer.configfile.config) %}
	SET_GCODE_VARIABLE MACRO=_CORE_VARS VARIABLE=chamber_thermal_sensor VALUE=3
	
	{% elif ('temperature_fan chamber' in printer.configfile.config) %}
	SET_GCODE_VARIABLE MACRO=_CORE_VARS VARIABLE=chamber_thermal_sensor VALUE=1
	
	{% elif ('temperature_sensor Chamber_Temp' in printer.configfile.config) %}
	SET_GCODE_VARIABLE MACRO=_CORE_VARS VARIABLE=chamber_thermal_sensor VALUE=2
	
	{% endif %}

[gcode_macro _BED_FANS_SETUP]
gcode = 
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	{% set core_vars = printer["gcode_macro _CORE_VARS"] %}
	
	{% if core_vars.filament in ['PLA', 'PLA+'] %}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=chamber_threshold VALUE={start_vars.pla_min_chamber_temp}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=chamber_fan VALUE={start_vars.pla_max_chamber_temp}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=low VALUE={start_vars.pla_bed_fan_low_speed}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=high VALUE={start_vars.pla_bed_fan_high_speed}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=cool VALUE={start_vars.pla_bed_fan_cool}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=cool_temp VALUE={start_vars.post_print_cool}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=enable VALUE={start_vars.pla_bed_fan_enable}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=chamber_fan_enable VALUE={start_vars.chamber_fan}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=floating_monitor VALUE={start_vars.floating_bed_fans}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=floating_max_speed VALUE={start_vars.floating_bed_fans_max}
	M400
	
	{% elif core_vars.filament == 'ASA' %}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=chamber_threshold VALUE={start_vars.asa_min_chamber_temp}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=chamber_fan VALUE={start_vars.asa_max_chamber_temp}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=low VALUE={start_vars.asa_bed_fan_low_speed}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=high VALUE={start_vars.asa_bed_fan_high_speed}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=cool VALUE={start_vars.asa_bed_fan_cool}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=cool_temp VALUE={start_vars.post_print_cool}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=enable VALUE={start_vars.asa_bed_fan_enable}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=chamber_fan_enable VALUE={start_vars.chamber_fan}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=floating_monitor VALUE={start_vars.floating_bed_fans}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=floating_max_speed VALUE={start_vars.floating_bed_fans_max}
	M400
	
	{% elif core_vars.filament == 'ABS' %}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=chamber_threshold VALUE={start_vars.abs_min_chamber_temp}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=chamber_fan VALUE={start_vars.abs_max_chamber_temp}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=low VALUE={start_vars.abs_bed_fan_low_speed}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=high VALUE={start_vars.abs_bed_fan_high_speed}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=cool VALUE={start_vars.abs_bed_fan_cool}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=cool_temp VALUE={start_vars.post_print_cool}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=enable VALUE={start_vars.abs_bed_fan_enable}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=chamber_fan_enable VALUE={start_vars.chamber_fan}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=floating_monitor VALUE={start_vars.floating_bed_fans}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=floating_max_speed VALUE={start_vars.floating_bed_fans_max}
	M400
	
	{% elif core_vars.filament in ['PET', 'PETG'] %}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=chamber_threshold VALUE={start_vars.petg_min_chamber_temp}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=chamber_fan VALUE={start_vars.petg_max_chamber_temp}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=low VALUE={start_vars.petg_bed_fan_low_speed}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=high VALUE={start_vars.petg_bed_fan_high_speed}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=cool VALUE={start_vars.petg_bed_fan_cool}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=cool_temp VALUE={start_vars.post_print_cool}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=enable VALUE={start_vars.petg_bed_fan_enable}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=chamber_fan_enable VALUE={start_vars.chamber_fan}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=floating_monitor VALUE={start_vars.floating_bed_fans}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=floating_max_speed VALUE={start_vars.floating_bed_fans_max}
	M400
	
	{% elif core_vars.filament in ['FLEX', 'TPU'] %}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=chamber_threshold VALUE={start_vars.tpu_min_chamber_temp}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=chamber_fan VALUE={start_vars.tpu_max_chamber_temp}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=low VALUE={start_vars.tpu_bed_fan_low_speed}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=high VALUE={start_vars.tpu_bed_fan_high_speed}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=cool VALUE={start_vars.tpu_bed_fan_cool}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=cool_temp VALUE={start_vars.post_print_cool}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=enable VALUE={start_vars.tpu_bed_fan_enable}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=chamber_fan_enable VALUE={start_vars.chamber_fan}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=floating_monitor VALUE={start_vars.floating_bed_fans}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=floating_max_speed VALUE={start_vars.floating_bed_fans_max}
	M400
	
	{% else %}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=chamber_threshold VALUE={start_vars.default_min_chamber_temp}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=chamber_fan VALUE={start_vars.default_max_chamber_temp}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=low VALUE={start_vars.default_bed_fan_low_speed}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=high VALUE={start_vars.default_bed_fan_high_speed}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=cool VALUE={start_vars.default_bed_fan_cool}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=cool_temp VALUE={start_vars.post_print_cool}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=enable VALUE={start_vars.default_bed_fan_enable}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=chamber_fan_enable VALUE={start_vars.chamber_fan}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=floating_monitor VALUE={start_vars.floating_bed_fans}
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=floating_max_speed VALUE={start_vars.floating_bed_fans_max}
	M400
	
	{% endif %}

[gcode_macro _CHAMBER_HEATER_SETUP]
gcode = 
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	{% set core_vars = printer["gcode_macro _CORE_VARS"] %}
	
	{% if core_vars.filament in ['PLA', 'PLA+'] %}
	SET_GCODE_VARIABLE MACRO=_C_HEATER_VARS VARIABLE=min_thresold VALUE={start_vars.pla_min_chamber_temp}
	SET_GCODE_VARIABLE MACRO=_C_HEATER_VARS VARIABLE=max_thresold VALUE={start_vars.pla_max_chamber_temp}
	SET_GCODE_VARIABLE MACRO=_C_HEATER_VARS VARIABLE=mid_point VALUE={(start_vars.pla_min_chamber_temp + start_vars.pla_max_chamber_temp) / 2|float}
	M400
	
	{% elif core_vars.filament == 'ASA' %}
	SET_GCODE_VARIABLE MACRO=_C_HEATER_VARS VARIABLE=min_thresold VALUE={start_vars.asa_min_chamber_temp}
	SET_GCODE_VARIABLE MACRO=_C_HEATER_VARS VARIABLE=max_thresold VALUE={start_vars.asa_max_chamber_temp}
	SET_GCODE_VARIABLE MACRO=_C_HEATER_VARS VARIABLE=mid_point VALUE={(start_vars.asa_min_chamber_temp + start_vars.asa_max_chamber_temp) / 2|float}
	M400
	
	{% elif core_vars.filament == 'ABS' %}
	SET_GCODE_VARIABLE MACRO=_C_HEATER_VARS VARIABLE=min_thresold VALUE={start_vars.abs_min_chamber_temp}
	SET_GCODE_VARIABLE MACRO=_C_HEATER_VARS VARIABLE=max_thresold VALUE={start_vars.abs_max_chamber_temp}
	SET_GCODE_VARIABLE MACRO=_C_HEATER_VARS VARIABLE=mid_point VALUE={(start_vars.abs_min_chamber_temp + start_vars.abs_max_chamber_temp) / 2|float}
	M400
	
	{% elif core_vars.filament in ['PET', 'PETG'] %}
	SET_GCODE_VARIABLE MACRO=_C_HEATER_VARS VARIABLE=min_thresold VALUE={start_vars.petg_min_chamber_temp}
	SET_GCODE_VARIABLE MACRO=_C_HEATER_VARS VARIABLE=max_thresold VALUE={start_vars.petg_max_chamber_temp}
	SET_GCODE_VARIABLE MACRO=_C_HEATER_VARS VARIABLE=mid_point VALUE={(start_vars.petg_min_chamber_temp + start_vars.petg_max_chamber_temp) / 2|float}
	M400
	
	{% elif core_vars.filament in ['FLEX', 'TPU'] %}
	SET_GCODE_VARIABLE MACRO=_C_HEATER_VARS VARIABLE=min_thresold VALUE={start_vars.tpu_min_chamber_temp}
	SET_GCODE_VARIABLE MACRO=_C_HEATER_VARS VARIABLE=max_thresold VALUE={start_vars.tpu_max_chamber_temp}
	SET_GCODE_VARIABLE MACRO=_C_HEATER_VARS VARIABLE=mid_point VALUE={(start_vars.tpu_min_chamber_temp + start_vars.tpu_max_chamber_temp) / 2|float}
	M400
	
	{% else %}
	SET_GCODE_VARIABLE MACRO=_C_HEATER_VARS VARIABLE=min_thresold VALUE={start_vars.default_min_chamber_temp}
	SET_GCODE_VARIABLE MACRO=_C_HEATER_VARS VARIABLE=max_thresold VALUE={start_vars.default_max_chamber_temp}
	SET_GCODE_VARIABLE MACRO=_C_HEATER_VARS VARIABLE=mid_point VALUE={(start_vars.default_min_chamber_temp + start_vars.default_max_chamber_temp) / 2|float}
	M400
	
	{% endif %}

[gcode_macro _CHAMBER_TEMPS_HELPER]
gcode = 
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	{% set core_vars = printer["gcode_macro _CORE_VARS"] %}
	
	{% if core_vars.filament in ['PLA', 'PLA+'] %}
	SET_GCODE_VARIABLE MACRO=_CORE_VARS VARIABLE=heat_wait_temp VALUE={start_vars.pla_min_chamber_temp}
	{% if start_vars.chamber_fan == True %}
	SET_TEMPERATURE_FAN_TARGET temperature_fan="chamber" target={start_vars.pla_max_chamber_temp}
	RESPOND TYPE=COMMAND MSG="Setting Chamber Fan Temp: PLA {start_vars.pla_max_chamber_temp}c"
	{% endif %}
	
	{% elif core_vars.filament == 'ASA' %}
	SET_GCODE_VARIABLE MACRO=_CORE_VARS VARIABLE=heat_wait_temp VALUE={start_vars.asa_min_chamber_temp}
	{% if start_vars.chamber_fan == True %}
	SET_TEMPERATURE_FAN_TARGET temperature_fan="chamber" target={start_vars.asa_max_chamber_temp}
	RESPOND TYPE=COMMAND MSG="Setting Chamber Fan Temp: ASA {start_vars.asa_max_chamber_temp}c"
	{% endif %}
	
	{% elif core_vars.filament == 'ABS' %}
	SET_GCODE_VARIABLE MACRO=_CORE_VARS VARIABLE=heat_wait_temp VALUE={start_vars.abs_min_chamber_temp}
	{% if start_vars.chamber_fan == True %}
	SET_TEMPERATURE_FAN_TARGET temperature_fan="chamber" target={start_vars.abs_max_chamber_temp}
	RESPOND TYPE=COMMAND MSG="Setting Chamber Fan Temp: ABS {start_vars.abs_max_chamber_temp}c"
	{% endif %}
	
	{% elif core_vars.filament in ['PET', 'PETG'] %}
	SET_GCODE_VARIABLE MACRO=_CORE_VARS VARIABLE=heat_wait_temp VALUE={start_vars.petg_min_chamber_temp}
	{% if start_vars.chamber_fan == True %}
	SET_TEMPERATURE_FAN_TARGET temperature_fan="chamber" target={start_vars.petg_max_chamber_temp}
	RESPOND TYPE=COMMAND MSG="Setting Chamber Fan Temp: PETG {start_vars.petg_max_chamber_temp}c"
	{% endif %}
	
	{% elif core_vars.filament in ['FLEX', 'TPU'] %}
	SET_GCODE_VARIABLE MACRO=_CORE_VARS VARIABLE=heat_wait_temp VALUE={start_vars.tpu_min_chamber_temp}
	{% if start_vars.chamber_fan == True %}
	SET_TEMPERATURE_FAN_TARGET temperature_fan="chamber" target={start_vars.tpu_max_chamber_temp}
	RESPOND TYPE=COMMAND MSG="Setting Chamber Fan Temp: TPU {start_vars.tpu_max_chamber_temp}c"
	{% endif %}
	
	{% else %}
	SET_GCODE_VARIABLE MACRO=_CORE_VARS VARIABLE=heat_wait_temp VALUE={start_vars.default_min_chamber_temp}
	{% if start_vars.chamber_fan == True %}
	SET_TEMPERATURE_FAN_TARGET temperature_fan="chamber" target={start_vars.default_max_chamber_temp}
	RESPOND TYPE=COMMAND MSG="Setting Chamber Fan Temp: Default {start_vars.default_max_chamber_temp}c"
	{% endif %}
	
	{% endif %}

[gcode_macro _START_WAIT_AND_TIMER_HANDLING]
gcode = 
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	{% set core_vars = printer["gcode_macro _CORE_VARS"] %}
	
	{% if core_vars.chamber_thermal_sensor == 0 %}
	{action_raise_error("This error is caused by no correctly named chamber_sensor or temperature controlled chamber_fan being available to the system! Check the system is setup correctly!")}
	
	{% elif core_vars.chamber_thermal_sensor == 1 %}
	{% set thermal_sensor = printer["temperature_fan chamber"].temperature %}
	{% set wait_thermal_sensor = "temperature_fan chamber" %}
	
	{% elif core_vars.chamber_thermal_sensor == 2 %}
	{% set thermal_sensor = printer["temperature_sensor Chamber_Temp"].temperature %}
	{% set wait_thermal_sensor = "temperature_sensor Chamber_Temp" %}
	
	{% endif %}
	
	{% if start_vars.chamber_fan and start_vars.chamber_sensor == True %}
	{action_raise_error("This error is caused by you setting both the chamber_fan & chamber_sensor to true. Check demon_user_settings file & set these correctly for your printer!")}
	{% endif %}
	
	{% if start_vars.chamber_fan or start_vars.chamber_sensor == True %}
	{% if thermal_sensor < core_vars.heat_wait_temp %}
	
	{% if start_vars.chamber_temp_wait == True %}
	_Z_PARK
	SET_DISPLAY_TEXT MSG="Waiting For Chamber Temp: {core_vars.heat_wait_temp}c"
	RESPOND TYPE=COMMAND MSG="Waiting For Chamber Temp: {core_vars.heat_wait_temp}c"
	TEMPERATURE_WAIT SENSOR="{wait_thermal_sensor}" MINIMUM={core_vars.heat_wait_temp|float -1}
	RESPOND TYPE=COMMAND MSG="Chamber Temp Reached"
	
	_CONDITIONAL_CLEAN
	G28 Z
	
	{% else %}
	_Z_PARK
	{% if core_vars.filament in ['PLA', 'PLA+', 'PET', 'PETG', 'FLEX', 'TPU'] %}
	_HEAT_WAIT MINUTES={start_vars.lo_temp_timer}
	RESPOND TYPE=COMMAND MSG="Running Low Temp Chamber Timer via sensor"
	{% elif core_vars.filament in ['ASA', 'ABS'] %}
	_HEAT_WAIT MINUTES={start_vars.hi_temp_timer}
	RESPOND TYPE=COMMAND MSG="Running High Temp Chamber Timer via sensor"
	{% else %}
	_HEAT_WAIT MINUTES={start_vars.default_temp_timer}
	RESPOND TYPE=COMMAND MSG="Running Default Temp Chamber Timer via sensor"
	
	_CONDITIONAL_CLEAN
	G28 Z
	
	{% endif %}
	{% endif %}
	
	{% else %}
	SET_DISPLAY_TEXT MSG="Already up to {core_vars.filament} temp, heat soak skipped"
	RESPOND TYPE=COMMAND MSG="Already up to {core_vars.filament} temp, heat soak skipped"
	G4 P5000
	
	{% endif %}
	
	
	{% else %}
	
	{% if core_vars.filament in ['PLA', 'PLA+', 'PET', 'PETG', 'FLEX', 'TPU'] %}
	RESPOND TYPE=COMMAND MSG="Running Low Temp Chamber Timer via Filament Type"
	_Z_PARK
	_HEAT_WAIT MINUTES={start_vars.lo_temp_timer}
	
	{% elif core_vars.filament in ['ASA', 'ABS'] %}
	RESPOND TYPE=COMMAND MSG="Running High Temp Chamber Timer via Filament Type"
	_Z_PARK
	
	_HEAT_WAIT MINUTES={start_vars.hi_temp_timer}
	
	{% else %}
	{% if core_vars.bed|int < 90|int %}
	RESPOND TYPE=COMMAND MSG="Running Low Temp Chamber Timer via File Temps"
	_Z_PARK
	_HEAT_WAIT MINUTES={start_vars.lo_temp_timer}
	
	{% else %}
	RESPOND TYPE=COMMAND MSG="Running High Temp Chamber Timer via File Temps"
	_Z_PARK
	
	_HEAT_WAIT MINUTES={start_vars.hi_temp_timer}
	{% endif %}
	
	{% endif %}
	
	{% endif %}
	
	M107

[gcode_macro _MESH_HANDLING]
gcode = 
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	{% set core_vars = printer["gcode_macro _CORE_VARS"] %}
	
	{% if start_vars.adaptive_meshing == True %}
	
	{% if ('mcu eddy' in printer.configfile.config) or ('probe_eddy_current btt_eddy' in printer) or ('probe_eddy_current eddy' in printer) %}
	BED_MESH_CALIBRATE METHOD=rapid_scan ADAPTIVE=1 ADAPTIVE_MARGIN=10
	M400
	G0 Z{printer["gcode_macro _Z_PARK"].z_park} F3600
	
	{% else %}
	BED_MESH_CALIBRATE ADAPTIVE=1 ADAPTIVE_MARGIN=10
	M400
	{% if 'scanner' in printer %}
	CARTOGRAPHER_TOUCH
	{% endif %}
	{% endif %}
	
	{% if start_vars.klicky_probe == True and printer.configfile.settings.stepper_z.endstop_pin == 'probe:z_virtual_endstop' %}
	Dock_Probe_Unlock
	{% if start_vars.nozzle_cleaner == True %}
	CLEAN_NOZZLE
	{% endif %}
	{% elif start_vars.klicky_probe != True and printer.configfile.settings.stepper_z.endstop_pin == 'probe:z_virtual_endstop' %}
	{% if start_vars.nozzle_cleaner == True %}
	CLEAN_NOZZLE
	{% endif %}
	{% endif %}
	
	{% else %}
	{% if core_vars.filament in ['PLA', 'PLA+'] %}
	{% if 'bed_mesh default' in printer.configfile.config %}
	BED_MESH_PROFILE LOAD="default"
	RESPOND TYPE=COMMAND MSG="Default mesh loaded"
	{% else %}
	{action_raise_error("ERROR: There is no recognised default mesh available, please build & save one to continue!")}
	{% endif %}
	
	{% elif core_vars.filament == 'ASA' %}
	{% if 'bed_mesh ASA' in printer.configfile.config %}
	BED_MESH_PROFILE LOAD="ASA"
	RESPOND TYPE=COMMAND MSG="ASA mesh loaded"
	{% else %}
	{action_raise_error("ERROR: There is no recognised ASA mesh available, please build & save one to continue!")}
	{% endif %}
	
	{% elif core_vars.filament == 'ABS' %}
	{% if 'bed_mesh ABS' in printer.configfile.config %}
	BED_MESH_PROFILE LOAD="ABS"
	RESPOND TYPE=COMMAND MSG="ABS mesh loaded"
	{% else %}
	{action_raise_error("ERROR: There is no recognised ABS mesh available, please build & save one to continue!")}
	{% endif %}
	
	{% elif core_vars.filament in ['PET', 'PETG'] %}
	{% if 'bed_mesh PETG' in printer.configfile.config %}
	BED_MESH_PROFILE LOAD="PETG"
	RESPOND TYPE=COMMAND MSG="PETG mesh loaded"
	{% else %}
	{action_raise_error("ERROR: There is no recognised PETG mesh available, please build & save one to continue!")}
	{% endif %}
	
	{% elif core_vars.filament in ['FLEX', 'TPU'] %}
	{% if 'bed_mesh TPU' in printer.configfile.config %}
	BED_MESH_PROFILE LOAD="TPU"
	RESPOND TYPE=COMMAND MSG="TPU mesh loaded"
	{% else %}
	{action_raise_error("ERROR: There is no recognised TPU mesh available, please build & save one to continue!")}
	{% endif %}
	
	{% else %}
	{% if params.BED|float < 90 %}
	{% if 'bed_mesh default' in printer.configfile.config %}
	BED_MESH_PROFILE LOAD="default"
	RESPOND TYPE=COMMAND MSG="Default mesh by temp loaded"
	{% else %}
	{action_raise_error("ERROR: There is no recognised default mesh available, please build & save one to continue!")}
	{% endif %}
	
	{% else %}
	{% if 'bed_mesh ASA' in printer.configfile.config %}
	BED_MESH_PROFILE LOAD="ASA"
	RESPOND TYPE=COMMAND MSG="ASA mesh by temp loaded"
	
	{% elif 'bed_mesh ABS' in printer.configfile.config %}
	BED_MESH_PROFILE LOAD="ABS"
	RESPOND TYPE=COMMAND MSG="ABS mesh by temp loaded"
	
	{% elif 'bed_mesh ASA' not in printer.configfile.config and 'bed_mesh ABS' not in printer.configfile.config %}
	{action_raise_error("ERROR: There are no recognised high temperature meshes available, please build an ASA or ABS mesh & save it to continue!")}
	{% endif %}
	{% endif %}
	{% endif %}
	
	M400
	{% if 'scanner' in printer %}
	CARTOGRAPHER_TOUCH
	{% endif %}
	{% endif %}

[gcode_macro _ORCA_MULTI_SURFACE_HANDLING]
gcode = 
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	{% set surface = printer["gcode_macro _CORE_VARS"].orca_surface %}
	
	
	
	{% if start_vars.orca_multi_surface == True %}
	{% if surface == 'Cool Plate' %}
	SET_GCODE_VARIABLE MACRO=_CORE_VARS VARIABLE=orca_bed_offset VALUE={start_vars.orca_cool_plate}
	
	{% elif surface == 'High Temp Plate' %}
	SET_GCODE_VARIABLE MACRO=_CORE_VARS VARIABLE=orca_bed_offset VALUE={start_vars.orca_smooth_hi_temp_plate}
	
	{% elif surface == 'Textured PEI Plate' %}
	SET_GCODE_VARIABLE MACRO=_CORE_VARS VARIABLE=orca_bed_offset VALUE={start_vars.orca_textured_pei_plate}
	
	{% elif surface == 'Engineering Plate' %}
	SET_GCODE_VARIABLE MACRO=_CORE_VARS VARIABLE=orca_bed_offset VALUE={start_vars.orca_engineering_plate}
	
	{% elif surface == 'Textured Cool Plate' %}
	SET_GCODE_VARIABLE MACRO=_CORE_VARS VARIABLE=orca_bed_offset VALUE={start_vars.orca_textured_cool_plate}
	
	{% endif %}
	
	{% endif %}

[gcode_macro _Z_OFFSET_HANDLING]
gcode = 
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	
	{% set core_vars = printer["gcode_macro _CORE_VARS"] %}
	
	
	{% if start_vars.orca_multi_surface == True and start_vars.combine_offset == True %}
	{% if core_vars.orca_bed_offset >= -0.165 and core_vars.orca_bed_offset <= 0.165 %}
	{% if core_vars.filament in ['PLA', 'PLA+'] %}
	{% if core_vars.orca_bed_offset == 0.00 %}
	SET_DISPLAY_TEXT MSG="BED TYPE: {core_vars.orca_surface} selected. NO OFFSET APPLIED"
	RESPOND TYPE=COMMAND MSG="BED TYPE: {core_vars.orca_surface} selected. NO OFFSET APPLIED"
	{% elif core_vars.orca_bed_offset != 0.00 %}
	SET_GCODE_OFFSET Z_ADJUST={core_vars.orca_bed_offset} MOVE=1
	SET_DISPLAY_TEXT MSG="BED TYPE: Applying {core_vars.orca_surface} offset adjustment"
	RESPOND TYPE=echo MSG="BED TYPE: Applying {core_vars.orca_surface} offset adjustment"
	
	
	{% endif %}
	
	{% elif start_vars.high_temp_expansion_offset == True and core_vars.filament in ['ASA', 'ABS'] %}
	{% if start_vars.high_temp_offset >= -0.165 and start_vars.high_temp_offset <= 0.165 %}
	{% if core_vars.orca_bed_offset == 0.00 %}
	SET_GCODE_OFFSET Z_ADJUST={start_vars.high_temp_offset} MOVE=1
	SET_DISPLAY_TEXT MSG="REQUESTED HIGH TEMP OFFSET ADJUSTMENT APPLIED"
	RESPOND TYPE=echo MSG="REQUESTED HIGH TEMP OFFSET ADJUSTMENT APPLIED"
	{% elif core_vars.orca_bed_offset != 0.00 %}
	{% if (start_vars.high_temp_offset + core_vars.orca_bed_offset) >= -0.165 and (start_vars.high_temp_offset + core_vars.orca_bed_offset) <= 0.165 %}
	SET_GCODE_OFFSET Z_ADJUST={start_vars.high_temp_offset + core_vars.orca_bed_offset} MOVE=1
	SET_DISPLAY_TEXT MSG="BED TYPE: Applying {core_vars.orca_surface} & High Temp combined offset adjustment"
	RESPOND TYPE=echo MSG="BED TYPE: Applying {core_vars.orca_surface} & High Temp combined offset adjustment"
	{% else %}
	{action_emergency_stop("EMERGENCY STOP! EXCESSIVE HIGH TEMP OFFSET REQUESTED CORRECT IN USER SETTINGS FILE")}
	{% endif %}
	{% endif %}
	{% else %}
	{action_emergency_stop("EMERGENCY STOP! EXCESSIVE HIGH TEMP OFFSET REQUESTED CORRECT IN USER SETTINGS FILE")}
	{% endif %}
	G4 P10000
	
	{% elif start_vars.petg_anti_squish == True and core_vars.filament in ['PET', 'PETG'] %}
	{% if start_vars.petg_offset >= 0.0 and start_vars.petg_offset <= 0.165 %}
	{% if core_vars.orca_bed_offset == 0.00 %}
	SET_GCODE_OFFSET Z_ADJUST={start_vars.petg_offset} MOVE=1
	SET_DISPLAY_TEXT MSG="REQUESTED PETG OFFSET ADJUSTMENT APPLIED"
	RESPOND TYPE=echo MSG="REQUESTED PETG OFFSET ADJUSTMENT APPLIED"
	{% elif core_vars.orca_bed_offset != 0.00 %}
	{% if (start_vars.petg_offset + core_vars.orca_bed_offset) >= -0.165 and (start_vars.petg_offset + core_vars.orca_bed_offset) <= 0.165 %}
	SET_GCODE_OFFSET Z_ADJUST={start_vars.petg_offset + core_vars.orca_bed_offset} MOVE=1
	SET_DISPLAY_TEXT MSG="BED TYPE: Applying {core_vars.orca_surface} & PETG Anti Squish combined offset adjustment"
	RESPOND TYPE=echo MSG="BED TYPE: Applying {core_vars.orca_surface} & PETG Anti Squish combined offset adjustment"
	{% else %}
	{action_emergency_stop("EMERGENCY STOP! NEGATIVE OR EXCESSIVE OFFSET REQUESTED CORRECT IN USER SETTINGS FILE")}
	{% endif %}
	{% endif %}
	{% else %}
	{action_emergency_stop("EMERGENCY STOP! NEGATIVE OR EXCESSIVE OFFSET REQUESTED CORRECT IN USER SETTINGS FILE")}
	{% endif %}
	G4 P10000
	
	{% elif start_vars.tpu_anti_squish == True and core_vars.filament in ['FLEX','TPU'] %}
	{% if start_vars.tpu_offset >= 0.0 and start_vars.tpu_offset <= 0.165 %}
	{% if core_vars.orca_bed_offset == 0.00 %}
	SET_GCODE_OFFSET Z_ADJUST={start_vars.tpu_offset} MOVE=1
	SET_DISPLAY_TEXT MSG="REQUESTED TPU OFFSET ADJUSTMENT APPLIED"
	RESPOND TYPE=echo MSG="REQUESTED TPU OFFSET ADJUSTMENT APPLIED"
	{% elif core_vars.orca_bed_offset != 0.00 %}
	{% if (start_vars.tpu_offset + core_vars.orca_bed_offset) >= -0.165 and (start_vars.tpu_offset + core_vars.orca_bed_offset) <= 0.165 %}
	SET_GCODE_OFFSET Z_ADJUST={start_vars.tpu_offset + core_vars.orca_bed_offset} MOVE=1
	SET_DISPLAY_TEXT MSG="BED TYPE: Applying {core_vars.orca_surface} & TPU Anti Squish combined offset adjustment"
	RESPOND TYPE=echo MSG="BED TYPE: Applying {core_vars.orca_surface} & TPU Anti Squish combined offset adjustment"
	{% else %}
	{action_emergency_stop("EMERGENCY STOP! NEGATIVE OR EXCESSIVE OFFSET REQUESTED CORRECT IN USER SETTINGS FILE")}
	{% endif %}
	
	{% endif %}
	{% else %}
	{action_emergency_stop("EMERGENCY STOP! NEGATIVE OR EXCESSIVE OFFSET REQUESTED CORRECT IN USER SETTINGS FILE")}
	{% endif %}
	G4 P10000
	
	{% elif start_vars.high_temp_expansion_offset == False and core_vars.filament in ['ASA', 'ABS'] %}
	{% if core_vars.orca_bed_offset == 0.00 %}
	SET_DISPLAY_TEXT MSG="BED TYPE: {core_vars.orca_surface} selected. NO OFFSET APPLIED"
	RESPOND TYPE=echo MSG="BED TYPE: {core_vars.orca_surface} selected. NO OFFSET APPLIED"
	{% elif core_vars.orca_bed_offset != 0.00 %}
	SET_GCODE_OFFSET Z_ADJUST={core_vars.orca_bed_offset} MOVE=1
	SET_DISPLAY_TEXT MSG="BED TYPE: {core_vars.orca_surface} selected. REQUESTED BED TYPE OFFSET ADJUSTMENT APPLIED"
	RESPOND TYPE=echo MSG="BED TYPE: {core_vars.orca_surface} selected. REQUESTED BED TYPE OFFSET ADJUSTMENT APPLIED"
	{% endif %}
	
	{% elif start_vars.petg_anti_squish == False and core_vars.filament in ['PET', 'PETG'] %}
	{% if core_vars.orca_bed_offset == 0.00 %}
	SET_DISPLAY_TEXT MSG="BED TYPE: {core_vars.orca_surface} selected. NO OFFSET APPLIED"
	RESPOND TYPE=echo MSG="BED TYPE: {core_vars.orca_surface} selected. NO OFFSET APPLIED"
	{% elif core_vars.orca_bed_offset != 0.00 %}
	SET_GCODE_OFFSET Z_ADJUST={core_vars.orca_bed_offset} MOVE=1
	SET_DISPLAY_TEXT MSG="BED TYPE: {core_vars.orca_surface} selected. REQUESTED BED TYPE OFFSET ADJUSTMENT APPLIED"
	RESPOND TYPE=echo MSG="BED TYPE: {core_vars.orca_surface} selected. REQUESTED BED TYPE OFFSET ADJUSTMENT APPLIED"
	{% endif %}
	
	{% elif start_vars.tpu_anti_squish == True and core_vars.filament in ['FLEX','TPU'] %}
	{% if core_vars.orca_bed_offset == 0.00 %}
	SET_DISPLAY_TEXT MSG="BED TYPE: {core_vars.orca_surface} selected. NO OFFSET APPLIED"
	RESPOND TYPE=echo MSG="BED TYPE: {core_vars.orca_surface} selected. NO OFFSET APPLIED"
	{% elif core_vars.orca_bed_offset != 0.00 %}
	SET_GCODE_OFFSET Z_ADJUST={core_vars.orca_bed_offset} MOVE=1
	SET_DISPLAY_TEXT MSG="BED TYPE: {core_vars.orca_surface} selected. REQUESTED BED TYPE OFFSET ADJUSTMENT APPLIED"
	RESPOND TYPE=echo MSG="BED TYPE: {core_vars.orca_surface} selected. REQUESTED BED TYPE OFFSET ADJUSTMENT APPLIED"
	{% endif %}
	{% endif %}
	
	
	{% else %}
	{action_emergency_stop("EMERGENCY STOP! EXCESSIVE PLATE OFFSET REQUESTED CORRECT IN USER SETTINGS FILE")}
	{% endif %}
	
	
	{% elif start_vars.orca_multi_surface == True and start_vars.combine_offset == False %}
	{% if core_vars.orca_bed_offset >= -0.165 and core_vars.orca_bed_offset <= 0.165 %}
	{% if core_vars.orca_bed_offset == 0.00 %}
	SET_DISPLAY_TEXT MSG="BED TYPE: {core_vars.orca_surface} SELECTED. NO OFFSET APPLIED"
	RESPOND TYPE=COMMAND MSG="BED TYPE: {core_vars.orca_surface} SELECTED. NO OFFSET APPLIED"
	G4 P10000
	{% elif core_vars.orca_bed_offset != 0.00 %}
	SET_GCODE_OFFSET Z_ADJUST={core_vars.orca_bed_offset} MOVE=1
	SET_DISPLAY_TEXT MSG="BED TYPE: {core_vars.orca_surface} selected. REQUESTED BED TYPE OFFSET ADJUSTMENT APPLIED"
	RESPOND TYPE=echo MSG="BED TYPE: {core_vars.orca_surface} selected. REQUESTED BED TYPE OFFSET ADJUSTMENT APPLIED"
	G4 P10000
	{% endif %}
	
	{% else %}
	{action_emergency_stop("EMERGENCY STOP! EXCESSIVE PLATE OFFSET REQUESTED CORRECT IN USER SETTINGS FILE")}
	{% endif %}
	
	
	
	{% elif start_vars.orca_multi_surface == False and start_vars.combine_offset == True %}
	{action_raise_error("This error is caused by variable_orca_multi_surface being set to False when combine_offset is set to True! Check demon_user_settings file!")}
	
	{% elif start_vars.orca_multi_surface == False and start_vars.combine_offset == False %}
	
	{% if start_vars.high_temp_expansion_offset == True and core_vars.filament in ['ASA', 'ABS'] %}
	{% if start_vars.high_temp_offset >= -0.165 and start_vars.high_temp_offset <= 0.165 %}
	SET_GCODE_OFFSET Z_ADJUST={start_vars.high_temp_offset} MOVE=1
	SET_DISPLAY_TEXT MSG="REQUESTED HIGH TEMP OFFSET ADJUSTMENT APPLIED"
	RESPOND TYPE=echo MSG="REQUESTED HIGH TEMP OFFSET ADJUSTMENT APPLIED"
	G4 P10000
	
	{% else %}
	{action_emergency_stop("EMERGENCY STOP! EXCESSIVE HIGH TEMP OFFSET REQUESTED CORRECT IN USER SETTINGS FILE")}
	
	{% endif %}
	
	{% elif start_vars.petg_anti_squish == True and core_vars.filament in ['PET', 'PETG'] %}
	{% if start_vars.petg_offset >= 0.0 and start_vars.petg_offset <= 0.165 %}
	SET_GCODE_OFFSET Z_ADJUST={start_vars.petg_offset} MOVE=1
	SET_DISPLAY_TEXT MSG="REQUESTED PETG OFFSET ADJUSTMENT APPLIED"
	RESPOND TYPE=echo MSG="REQUESTED PETG OFFSET ADJUSTMENT APPLIED"
	G4 P10000
	
	{% else %}
	{action_emergency_stop("EMERGENCY STOP! NEGATIVE OR EXCESSIVE OFFSET REQUESTED CORRECT IN USER SETTINGS FILE")}
	
	{% endif %}
	
	{% elif start_vars.tpu_anti_squish == True and core_vars.filament in ['FLEX','TPU'] %}
	{% if start_vars.tpu_offset >= 0.0 and start_vars.tpu_offset <= 0.165 %}
	SET_GCODE_OFFSET Z_ADJUST={start_vars.tpu_offset} MOVE=1
	SET_DISPLAY_TEXT MSG="REQUESTED TPU OFFSET ADJUSTMENT APPLIED"
	RESPOND TYPE=echo MSG="REQUESTED TPU OFFSET ADJUSTMENT APPLIED"
	G4 P10000
	
	{% else %}
	{action_emergency_stop("EMERGENCY STOP! NEGATIVE OR EXCESSIVE OFFSET REQUESTED CORRECT IN USER SETTINGS FILE")}
	
	{% endif %}
	
	{% endif %}
	
	{% endif %}

[gcode_macro _ORCA_OFFSET_REMOVE]
variable_z = 0.00
gcode = 
	{% set core_vars = printer["gcode_macro _CORE_VARS"] %}
	
	{% if core_vars.orca_bed_offset != 0.00 %}
	SET_GCODE_OFFSET Z=0.00
	SET_DISPLAY_TEXT MSG="Resetting offset due to applied Orca offset modifer"
	RESPOND TYPE=COMMAND MSG="Resetting offset due to applied Orca offset modifer"
	{% endif %}

[gcode_macro _EDDY_OFFSET_REMOVE]
gcode = 
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	
	{% if 'mcu eddy' in printer and 'probe_eddy_current btt_eddy' in printer %}
	{% if printer.gcode_move.homing_origin.z != 0.00 %}
	SET_GCODE_OFFSET Z=0
	RESPOND TYPE=COMMAND MSG="Removing Eddy auto offset"
	{% endif %}
	
	{% else %}
	RESPOND TYPE=COMMAND MSG="USB Eddy probe not present"
	{% endif %}

[gcode_macro _OFFSET_RESET_CONTROL]
gcode = 
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	{% set core_vars = printer["gcode_macro _CORE_VARS"] %}
	
	{% if start_vars.orca_enable == True and core_vars.offset_reset == False %}
	_ORCA_OFFSET_REMOVE
	{% endif %}
	
	{% if core_vars.offset_reset == True %}
	SET_GCODE_OFFSET Z=0.0 MOVE=1
	{% endif %}
	
	{% if start_vars.auto_reset_eddy_offset == True %}
	_EDDY_OFFSET_REMOVE
	{% endif %}

[gcode_macro _START_POS]
gcode = 
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	
	{% if start_vars.start_x_position >= 50 or start_vars.start_y_position >= 50%}
	{action_emergency_stop("EMERGENCY STOP! EXCESSIVE START POSITION REQUESTED CORRECT IN USER SETTINGS FILE")}
	
	{% elif start_vars.purge_line_length|float > 150 %}
	{action_emergency_stop("EMERGENCY STOP! EXCESSIVE PURGE LENGTH REQUESTED CORRECT IN USER SETTINGS FILE")}
	
	{% endif %}
	
	SET_DISPLAY_TEXT MSG="Moving to Start Position"
	RESPOND TYPE=COMMAND MSG="Moving to Start Position"
	G0 Z25 F5000
	G0 X{start_vars.start_x_position} Y{start_vars.start_y_position} F5000
	
	
	G0 Z5.0 F5000
	G0 Z0.5 F150

[gcode_macro _PURGE_LINES]
gcode = 
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	{% set height = (printer.configfile.settings.extruder.nozzle_diameter * 0.75)|float %}
	{% set width = (printer.configfile.settings.extruder.nozzle_diameter * 1.25)|float %}
	{% set filament_area = 3.14159 * (printer.configfile.settings.extruder.filament_diameter ** 2) / 4 %}
	{% set rate = start_vars.purge_line_length * ((width * height) / filament_area) %}
	
	{% if start_vars.purge_lines == False %}
	G0 Z5.0
	SET_DISPLAY_TEXT MSG="Purge lines skipped, Print Start..."
	RESPOND TYPE=COMMAND MSG="Purge lines skipped, Print Start..."
	
	{% elif start_vars.adaptive_meshing == True and start_vars.purge_lines == True %}
	LINE_PURGE
	
	{% elif start_vars.use_kamp_adaptive_purge == True and start_vars.purge_lines == True %}
	LINE_PURGE
	
	{% else %}
	SET_DISPLAY_TEXT MSG="Printing Purge Lines"
	RESPOND TYPE=COMMAND MSG="Printing Purge Lines"
	G90
	G0 Z1.5 F9000
	
	G91
	{% if start_vars.purge_along_y == True %}
	G0 Y7 F9000
	{% else %}
	G0 X7 F9000
	{% endif %}
	
	G90
	G0 Z{height} F1500
	G91
	
	{% if start_vars.purge_along_y == True %}
	G1 Y{start_vars.purge_line_length} E{rate} F1500
	G0 X{width} F5000
	G1 Y-{start_vars.purge_line_length -15} E{rate} F1500
	
	
	{% else %}
	G1 X{start_vars.purge_line_length} E{rate} F1500
	G0 Y{width +0.4} F5000
	G1 X-{start_vars.purge_line_length -15} E{rate} F1500
	
	{% endif %}
	
	G0 Z{height} F9000
	G4 P2000
	G0 X5 Y5 F9000
	G90
	G92 E0.0
	M83
	G0 Z5.0 F9000
	M400
	SET_DISPLAY_TEXT MSG="Print Start..."
	RESPOND TYPE=COMMAND MSG="Print Start..."
	
	{% endif %}

[gcode_macro _NEVERMORE_POST_PRINT]
gcode = 
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	{% set core_vars = printer["gcode_macro _CORE_VARS"] %}
	
	{% if start_vars.nevermore_post_timer == False %}
	{% if start_vars.nevermore_leave_running == False %}
	SET_FAN_SPEED FAN=Nevermore SPEED=0
	RESPOND TYPE=COMMAND MSG="Nevermore post print, fan off."
	{% else %}
	RESPOND TYPE=COMMAND MSG="Nevermore post print, leaving fan on."
	{% endif %}
	
	{% else %}
	{% if core_vars.filament in ['PLA', 'PLA+', 'PET', 'PETG', 'FLEX','TPU'] and start_vars.nevermore_asa_abs_only == True %}
	{% if start_vars.nevermore_leave_running == False %}
	SET_FAN_SPEED FAN=Nevermore SPEED=0
	RESPOND TYPE=COMMAND MSG="Nevermore post print timer bypass, fan off."
	{% else %}
	RESPOND TYPE=COMMAND MSG="Nevermore post print timer bypass, leaving fan on."
	{% endif %}
	
	{% else %}
	RESPOND TYPE=COMMAND MSG="Nevermore post print chamber filteration process started, fan set to {("%.0f" % (start_vars.nevermore_post_speed|float * 100))}%"
	SET_FAN_SPEED FAN=Nevermore SPEED={start_vars.nevermore_post_speed|float}
	_HEAT_WAIT MSG="Nevermore post print chamber filtration timer..." MINUTES={start_vars.nevermore_post_run_time|int}
	M400
	{% if start_vars.nevermore_leave_running == False %}
	SET_FAN_SPEED FAN=Nevermore SPEED=0
	RESPOND TYPE=COMMAND MSG="Nevermore post print timer done, fan off."
	{% else %}
	RESPOND TYPE=COMMAND MSG="Nevermore post print timer done, leaving fan on."
	{% endif %}
	{% endif %}
	
	{% endif %}

[gcode_macro _GOODNIGHT]
gcode = 
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	
	{% if printer.extruder.temperature >= 50 %}
	M106 S255
	SET_DISPLAY_TEXT MSG="Cooling hotend for shutdown"
	RESPOND TYPE=COMMAND MSG="Cooling hotend for shutdown"
	TEMPERATURE_WAIT SENSOR=extruder MAXIMUM=49
	M400
	{% endif %}
	
	M107
	M117 GOODNIGHT...Zzzzzz
	M118 GOODNIGHT...Zzzzzz
	
	{% if start_vars.neopixel_led == True %}
	STATUS_OFF
	{% endif %}
	
	UPDATE_DELAYED_GCODE ID=_DELAY_OFF DURATION=5

[delayed_gcode _DELAY_OFF]
gcode = 
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	
	{% if start_vars.shutdown_relay == True %}
	{% if start_vars.all_in_one_pi == True or start_vars.host_shutdown == True %}
	{action_call_remote_method("shutdown_machine")}
	
	{% elif start_vars.all_in_one_pi == False and start_vars.host_shutdown == False %}
	{action_call_remote_method("set_device_power",device="Printer Power",state="off")}
	{% endif %}
	
	{% else %}
	{action_raise_error("Sorry you have not got a shutdown relay installed. Check the demon_user_settings file hardware options to enable it")}
	{% endif %}

[gcode_macro Power_Down]
description = If you have a mains power relay this will power the relay off & shutdown the client
gcode = 
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	
	{% if start_vars.shutdown_relay == True %}
	{action_call_remote_method("set_device_power",device="Printer Power",state="off")}
	{% else %}
	{action_raise_error("Sorry you have not got a shutdown relay installed. Check the demon_user_settings file hardware options to enable it")}
	{% endif %}

[gcode_macro _CONDITIONAL_CLEAN]
gcode = 
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	
	{% if start_vars.nozzle_cleaner == True %}
	{% if printer.configfile.settings.stepper_z.endstop_pin != 'probe:z_virtual_endstop' or 'smart_effector' in printer or
	('scanner' in printer) %}
	CLEAN_NOZZLE
	{% endif %}
	{% endif %}

[gcode_macro _step_control]
gcode = 
	{% set clean_vars = printer["gcode_macro _CLEAN_VARIABLES"] %}
	{% set rando_x_clean = range((clean_vars.clean_min_x|int), (clean_vars.clean_max_x|int))|random %}
	{% set rando_y_clean = range((clean_vars.clean_min_y|int), (clean_vars.clean_max_y|int))|random %}
	
	G90
	
	{% if clean_vars.random_clean_x == True and clean_vars.random_clean_y == True %}
	G0 X{rando_x_clean|int} Y{rando_y_clean|int} F{clean_vars.pass_spd * 60|int}
	
	{% elif clean_vars.random_clean_x == True and clean_vars.random_clean_y == False %}
	G0 X{rando_x_clean|int} Y{clean_vars.linear_clean_start_y|int} F{clean_vars.pass_spd * 60|int}
	
	{% elif clean_vars.random_clean_x == False and clean_vars.random_clean_y == True %}
	G0 X{clean_vars.linear_clean_start_x|int} Y{rando_y_clean|int} F{clean_vars.pass_spd * 60|int}
	{% endif %}

[gcode_macro _LINEAR_STEP_CONTROL_X]
gcode = 
	{% set clean_vars = printer["gcode_macro _CLEAN_VARIABLES"] %}
	
	G91
	{% if clean_vars.linear_clean_positive_dir == True %}
	G0 X{clean_vars.linear_clean_distance|int} F{clean_vars.pass_spd * 60|int}
	{% else %}
	G0 X-{clean_vars.linear_clean_distance|int} F{clean_vars.pass_spd * 60|int}
	{% endif %}
	G90
	G0 X{clean_vars.linear_clean_start_x|int} F{clean_vars.pass_spd * 60|int}

[gcode_macro _LINEAR_STEP_CONTROL_Y]
gcode = 
	{% set clean_vars = printer["gcode_macro _CLEAN_VARIABLES"] %}
	
	G91
	{% if clean_vars.linear_clean_positive_dir == True %}
	G0 Y{clean_vars.linear_clean_distance|int} F{clean_vars.pass_spd * 60|int}
	{% else %}
	G0 Y-{clean_vars.linear_clean_distance|int} F{clean_vars.pass_spd * 60|int}
	{% endif %}
	G90
	G0 Y{clean_vars.linear_clean_start_y|int} F{clean_vars.pass_spd * 60|int}

[gcode_macro _random_spot]
gcode = 
	{% set clean_vars = printer["gcode_macro _CLEAN_VARIABLES"] %}
	{% set rando_x = range((clean_vars.purge_min_x|int), (clean_vars.purge_max_x|int))|random %}
	
	G0 X{rando_x|int} Y{clean_vars.purge_y_park|int} F9000

[gcode_macro _klicky_check]
gcode = 
	query_probe
	_probe_state action={ params.ACTION }

[gcode_macro _probe_state]
gcode = 
	{% set query_probe_triggered = printer.probe.last_query %}
	{% set action  = params.ACTION|default('') %}
	
	{% if query_probe_triggered %}
	
	{% else %}
	Dock_Probe_Unlock
	{% endif %}

[gcode_macro _KLICKY_UNLOCKER]
gcode = 
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	
	{% if start_vars.klicky_probe == True and printer.configfile.settings.stepper_z.endstop_pin == 'probe:z_virtual_endstop'%}
	RESPOND TYPE=COMMAND MSG="UNLOCKING Klicky Probe!"
	Dock_Probe_Unlock
	{% endif %}

[gcode_macro _HOMING_HELPER]
gcode = 
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	
	{% if start_vars.klicky_probe == True %}
	{% if printer.configfile.settings.stepper_z.endstop_pin == 'probe:z_virtual_endstop' %}
	
	_SET_Z_PARK
	{% if "xyz" not in printer.toolhead.homed_axes %}
	{% if start_vars.neopixel_led == True %}
	STATUS_HOMING
	{% endif %}
	
	SET_DISPLAY_TEXT MSG="Homing..."
	RESPOND TYPE=COMMAND MSG="Homing..."
	G28 X Y
	ATTACH_PROBE_LOCK
	RESPOND TYPE=COMMAND MSG="Klicky Probe is now LOCKED!"
	G28 Z
	{% endif %}
	
	{% else %}
	_CONDITIONAL_HOME
	{% endif %}
	
	{% else %}
	_CONDITIONAL_HOME
	{% endif %}

[gcode_macro _CONDITIONAL_HOME]
gcode = 
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	
	_SET_Z_PARK
	{% if "xyz" not in printer.toolhead.homed_axes %}
	{% if start_vars.neopixel_led == True %}
	STATUS_HOMING
	{% endif %}
	
	SET_DISPLAY_TEXT MSG="Homing..."
	RESPOND TYPE=COMMAND MSG="Homing..."
	
	G28
	
	{% else %}
	{% if start_vars.klicky_probe == True %}
	_klicky_check
	{% endif %}
	{% endif %}
	M117
	M400

[gcode_macro M84]
rename_existing = M84.1
gcode = 
	_SAVE
	M400
	_Z_READER
	M84.1
	UPDATE_DELAYED_GCODE ID=_ACTIVE_Z_MONITOR DURATION=0

[delayed_gcode _ACTIVE_Z_MONITOR]
gcode = 
	{% set core_vars = printer["gcode_macro _CORE_VARS"] %}
	
	{% if 'z' in printer.toolhead.homed_axes and printer.print_stats.state not in ["printing", "paused"] %}
	{% if printer.toolhead.position.z != core_vars.last_known_z %}
	_SAVE
	UPDATE_DELAYED_GCODE ID=_ACTIVE_Z_MONITOR DURATION=10
	{% else %}
	UPDATE_DELAYED_GCODE ID=_ACTIVE_Z_MONITOR DURATION=10
	{% endif %}
	
	{% elif 'z' in printer.toolhead.homed_axes and printer.print_stats.state in ["printing", "paused"] %}
	{% if printer.toolhead.position.z != core_vars.last_known_z %}
	_SAVE
	UPDATE_DELAYED_GCODE ID=_ACTIVE_Z_MONITOR DURATION=30
	{% else %}
	UPDATE_DELAYED_GCODE ID=_ACTIVE_Z_MONITOR DURATION=30
	{% endif %}
	
	{% else %}
	UPDATE_DELAYED_GCODE ID=_ACTIVE_Z_MONITOR DURATION=0
	{% endif %}

[gcode_macro _LOAD]
gcode = 
	{% set svv = printer.save_variables.variables %}
	SET_GCODE_VARIABLE MACRO=_CORE_VARS VARIABLE=last_known_z VALUE={svv.last_known_z}
	RESPOND TYPE=COMMAND MSG="Z Tracker: Last known Z height was {svv.last_known_z}"

[gcode_macro _SAVE]
gcode = 
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	{% set core_vars = printer["gcode_macro _CORE_VARS"] %}
	{% set driver_vars = printer["gcode_macro _DRIVER_VARS"] %}
	{% set svv = printer.save_variables.variables %}
	
	{% if driver_vars.z_lift_move == True %}
	SAVE_VARIABLE VARIABLE=last_known_z VALUE={("%.2f " % (core_vars.last_known_z + start_vars.pre_home_lift))}
	SET_GCODE_VARIABLE MACRO=_CORE_VARS VARIABLE=last_known_z VALUE={("%.2f " % (core_vars.last_known_z + start_vars.pre_home_lift))}
	SET_GCODE_VARIABLE MACRO=_DRIVER_VARS VARIABLE=z_lift_move VALUE=False
	M400
	
	{% elif core_vars.no_home_z_move == True %}
	SAVE_VARIABLE VARIABLE=last_known_z VALUE={("%.2f " % (core_vars.last_known_z))}
	SET_GCODE_VARIABLE MACRO=_CORE_VARS VARIABLE=no_home_z_move VALUE=False
	M400
	
	{% elif 'z' not in printer.toolhead.homed_axes %}
	
	{% else %}
	SET_GCODE_VARIABLE MACRO=_CORE_VARS VARIABLE=last_known_z VALUE={("%.2f " % (printer.toolhead.position.z))}
	SAVE_VARIABLE VARIABLE=last_known_z VALUE={("%.2f " % (printer.toolhead.position.z))}
	
	{% endif %}

[gcode_macro _Z_READER]
gcode = 
	{% set core_vars = printer["gcode_macro _CORE_VARS"] %}
	
	
	RESPOND TYPE=COMMAND MSG="Z Tracker: Current Z height saved as {core_vars.last_known_z}"

[gcode_macro Z_ASCENDER]
description = Raise the toolhead by the selected distance if the printer is homed or not! 100mm max per activation USE WITH CAUTION!
gcode = 
	
	{% set core_vars = printer["gcode_macro _CORE_VARS"] %}
	{% set svv = printer.save_variables.variables %}
	{% set height = params.HEIGHT|default(15)|int %}
	
	{% if 'z' not in printer.toolhead.homed_axes %}
	RESPOND TYPE=COMMAND MSG="WARNING AXES RESET FOR Z LIFT!!"
	RESPOND TYPE=COMMAND MSG="EXTREME CAUTION! As the printer is NOT homed already Z0 will be the current toolhead position for the duration of this move! If commanded the Z axis will be able to pass Z maximum resulting in printer damage!!"
	SET_KINEMATIC_POSITION Z=0
	SET_GCODE_VARIABLE MACRO=_CORE_VARS VARIABLE=no_home_z_move VALUE=True
	M400
	G90
	{% if height in range (0, 101) %}
	{% if core_vars.last_known_z <= (printer.toolhead.axis_maximum.z|int - height|int) - 20 %}
	G0 Z{height} F800
	M400
	RESPOND TYPE=COMMAND MSG="Move complete, now disabling axes"
	SET_GCODE_VARIABLE MACRO=_CORE_VARS VARIABLE=last_known_z VALUE={("%.2f " % (core_vars.last_known_z + height))}
	M400
	M84
	
	{% else %}
	{action_raise_error("Request denied, operation cancelled! As the printer is NOT homed estimated toolhead height is too great for requested move!")}
	{% endif %}
	
	{% else %}
	{action_raise_error("Request denied, operation cancelled! Lift height not in range. The maximum single commanded movement range is 0-100mm")}
	{% endif %}
	
	{% else %}
	G90
	{% if height in range (0, 101) %}
	{% if printer.toolhead.position.z <= (printer.toolhead.axis_maximum.z|int - height|int) - 20 %}
	G0 Z{(printer.toolhead.position.z + height)} F800
	M400
	M400
	_SAVE
	RESPOND TYPE=COMMAND MSG="Move complete!"
	
	{% else %}
	{action_raise_error("Request denied, operation cancelled! Actual toolhead height is too great for requested move!")}
	{% endif %}
	
	{% else %}
	{action_raise_error("Request denied, operation cancelled! Lift height not in range. The maximum single commanded movement range is 0-100mm")}
	{% endif %}
	{% endif %}

[gcode_macro _Z_PARK]
variable_z_park = 30
gcode = 
	{% set x_park = printer.toolhead.axis_maximum.x|float / 2 %}
	{% set y_park = printer.toolhead.axis_maximum.y|float / 2 %}
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	
	{% if start_vars.klicky_probe == True and printer.configfile.settings.stepper_z.endstop_pin == 'probe:z_virtual_endstop' %}
	Dock_Probe_Unlock
	{% endif %}
	
	{% if start_vars.use_custom_park == False %}
	G0 X{x_park} Y{y_park} Z{z_park} F10000
	
	{% else %}
	{% if start_vars.system_choose_z == True %}
	G0 X{start_vars.custom_park_x} Y{start_vars.custom_park_y} Z{z_park} F10000
	{% else %}
	{% if start_vars.custom_park_z|int <= 1|int or start_vars.custom_park_z|int >= (printer.toolhead.axis_maximum.z|int - start_vars.pre_home_lift|int) - 10 %}
	{action_raise_error("Custom Z parking height is to low or too high, change height in the demon user settings file to contiune")}
	{% else %}
	G0 X{start_vars.custom_park_x} Y{start_vars.custom_park_y} Z{start_vars.custom_park_z} F10000
	{% endif %}
	{% endif %}
	{% endif %}
	M400
	_SAVE

[gcode_macro _SET_Z_PARK]
gcode = 
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	{% set zp_vars = printer["gcode_macro _z_park"] %}
	
	{% if start_vars.system_choose_z == True %}
	{% if 'bltouch' in printer.configfile.config %}
	SET_GCODE_VARIABLE MACRO=_Z_PARK VARIABLE=z_park VALUE=25
	
	{% elif 'scanner' in printer %}
	SET_GCODE_VARIABLE MACRO=_Z_PARK VARIABLE=z_park VALUE=25
	
	{% elif 'smart_effctor' in printer %}
	SET_GCODE_VARIABLE MACRO=_Z_PARK VARIABLE=z_park VALUE=25
	
	{% elif ('mcu eddy' in printer.configfile.config) or ('probe_eddy_current btt_eddy' in printer) %}
	SET_GCODE_VARIABLE MACRO=_Z_PARK VARIABLE=z_park VALUE=25
	
	{% elif start_vars.klicky_probe == True or printer.configfile.settings.stepper_z.endstop_pin != 'probe:z_virtual_endstop' %}
	SET_GCODE_VARIABLE MACRO=_Z_PARK VARIABLE=z_park VALUE=50
	
	{% else %}
	SET_GCODE_VARIABLE MACRO=_Z_PARK VARIABLE=z_park VALUE=5
	{% endif %}
	
	{% else %}
	SET_GCODE_VARIABLE MACRO=_Z_PARK VARIABLE=z_park VALUE={start_vars.custom_park_z}
	{% endif %}

[gcode_macro _ADAPTIVE_MANUAL_LEVELLING]
gcode = 
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	
	{% if start_vars.use_manual_levelling == True and ('bed_screws' in printer.configfile.config) and ('screws_tilt_adjust' not in printer.configfile.config) %}
	SET_DISPLAY_TEXT MSG="Manual Gantry Levelling: Bed Screws"
	RESPOND TYPE=COMMAND MSG="Manual Gantry Levelling: Bed Screws"
	{% if start_vars.neopixel_led == True %}
	STATUS_LEVELING
	{% endif %}
	BED_SCREWS_ADJUST
	
	{% elif start_vars.use_manual_levelling == True and ('screws_tilt_adjust' in printer.configfile.config) %}
	SET_DISPLAY_TEXT MSG="Manual Gantry Levelling: Screws Tilt Calculate"
	RESPOND TYPE=COMMAND MSG="Manual Gantry Levelling: Screws Tilt Calculate"
	{% if start_vars.neopixel_led == True %}
	STATUS_LEVELING
	{% endif %}
	SCREWS_TILT_CALCULATE
	
	{% else %}
	{action_raise_error("This error is caused by your printer not having bed_screws or screws_tilt_adjust defined! Please define these sections in the printer.cfg file")}
	
	{% endif %}
	M117

[gcode_macro _ADAPTIVE_LEVELLING]
gcode = 
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	
	{% if start_vars.use_manual_levelling == True %}
	SET_DISPLAY_TEXT MSG="Manaul levelling in use, Print_Start auto levelling bypassed"
	RESPOND TYPE=COMMAND MSG="Manaul levelling in use, Print_Start auto levelling bypassed"
	
	{% else %}
	{% if printer.configfile.settings.printer.kinematics == 'corexy' and ('z_tilt' in printer.configfile.config) %}
	{% if ('quad_gantry_level' not in printer.configfile.config) %}
	SET_DISPLAY_TEXT MSG="Gantry Levelling CoreXY Z Tilt"
	RESPOND TYPE=COMMAND MSG="Gantry Levelling CoreXY Z Tilt"
	{% if start_vars.neopixel_led == True %}
	STATUS_LEVELING
	{% endif %}
	Z_TILT_ADJUST
	M400
	{% endif %}
	
	{% elif printer.configfile.settings.printer.kinematics == 'corexy' and ('quad_gantry_level' in printer.configfile.config) %}
	SET_DISPLAY_TEXT MSG="Gantry Levelling"
	RESPOND TYPE=COMMAND MSG="Gantry Levelling"
	{% if start_vars.neopixel_led == True %}
	STATUS_LEVELING
	{% endif %}
	QUAD_GANTRY_LEVEL
	M400
	
	{% elif printer.configfile.settings.printer.kinematics == 'cartesian' and ('z_tilt' in printer.configfile.config) %}
	SET_DISPLAY_TEXT MSG="Gantry Levelling"
	RESPOND TYPE=COMMAND MSG="Gantry Levelling"
	{% if start_vars.neopixel_led == True %}
	STATUS_LEVELING
	{% endif %}
	Z_TILT_ADJUST
	M400
	
	{% elif printer.configfile.settings.printer.kinematics == 'cartesian' and ('z_tilt' not in printer.configfile.config) %}
	RESPOND TYPE=COMMAND MSG="Levelling system not available, skipping Gantry Levelling"
	
	{% else %}
	{action_raise_error("This error is caused by your printer not supporting this feature! Please enable Manual Levelling in the demon_user_settings.cfg file")}
	
	{% endif %}
	{% endif %}
	M117

[gcode_macro _DEMON_PAUSE]
variable_offset_reset = False
gcode = 
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	{% set ceal = printer["gcode_macro CUSTOM_EXPANSION_ACTIVE_LIST"] %}
	
	{% if printer.toolhead.position.z|float < 50 %}
	G0 Z50 F3600
	{% endif %}
	
	{% if start_vars.kill_fan_on_pause == True %}
	RESPOND TYPE=COMMAND MSG="Parts fan stopping for pause duration"
	SET_GCODE_VARIABLE MACRO=_CORE_VARS VARIABLE=fan_speed VALUE={("%.2f " % (printer["fan"].speed|float))}
	M107
	{% endif %}
	
	{% if ceal.ceal_master_enable == True %}
	{% if ceal.pause == True %}
	_CUSTOM_PAUSE {rawparams}
	{% endif %}
	{% endif %}
	
	_SAVE

[gcode_macro _DEMON_CANCEL]
variable_offset_reset = False
gcode = 
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	{% set core_vars = printer["gcode_macro _CORE_VARS"] %}
	{% set ceal = printer["gcode_macro CUSTOM_EXPANSION_ACTIVE_LIST"] %}
	
	{% if printer.print_stats.state != paused and printer.toolhead.position.z|float < 50 %}
	G0 Z50 F3600
	{% endif %}
	
	_OFFSET_RESET_CONTROL
	
	BED_MESH_CLEAR
	M220 S100
	M221 S100
	SET_VELOCITY_LIMIT ACCEL={printer.configfile.config.printer.max_accel}
	SET_VELOCITY_LIMIT VELOCITY={printer.configfile.config.printer.max_velocity}
	
	{% if start_vars.encoder_runout_sensor == True %}
	SET_FILAMENT_SENSOR SENSOR=encoder_sensor ENABLE=0
	{% endif %}
	
	{% if ceal.ceal_master_enable == True %}
	{% if ceal.cancel == True %}
	_CUSTOM_CANCEL {rawparams}
	{% endif %}
	{% endif %}
	
	_SAVE
	{% if start_vars.z_tracker_reduced_monitoring == False %}
	UPDATE_DELAYED_GCODE ID=_ACTIVE_Z_MONITOR DURATION=1
	{% endif %}

[gcode_macro _DEMON_RESUME]
gcode = 
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	{% set core_vars = printer["gcode_macro _CORE_VARS"] %}
	{% set resume = printer["gcode_macro RESUME"] %}
	{% set ceal = printer["gcode_macro CUSTOM_EXPANSION_ACTIVE_LIST"] %}
	
	{% if start_vars.chamber_heater == True %}
	UPDATE_DELAYED_GCODE ID=_CHAMBER_HEAT_CONTROL DURATION=1
	RESPOND TYPE=COMMAND MSG="Chamber Heater Monitor Active"
	{% endif %}
	
	{% if start_vars.bed_fans == True %}
	UPDATE_DELAYED_GCODE ID=_BED_FAN_MONITOR DURATION=1
	RESPOND TYPE=COMMAND MSG="Bed Fans Monitor Active"
	{% endif %}
	
	{% if start_vars.nevermore == True and resume.idle_state == True %}
	{% if core_vars.nm_fan_speed != 0 %}
	SET_FAN_SPEED FAN=Nevermore SPEED={core_vars.nm_fan_speed|float}
	RESPOND TYPE=COMMAND MSG="Restoring Nevermore fan speed"
	M400
	SET_GCODE_VARIABLE MACRO=_CORE_VARS VARIABLE=nm_fan_speed VALUE=0
	{% endif %}
	{% endif %}
	
	SET_DISPLAY_TEXT MSG="Resuming print!"
	RESPOND TYPE=COMMAND MSG="Resuming print!"
	
	{% if start_vars.kill_fan_on_pause == True %}
	M106 S{("%.0f " % (core_vars.fan_speed|float * 255))}
	RESPOND TYPE=COMMAND MSG="Restoring parts fan speed"
	{% endif %}
	
	{% if ceal.ceal_master_enable == True %}
	{% if ceal.resume == True %}
	_CUSTOM_RESUME {rawparams}
	{% endif %}
	{% endif %}

[gcode_macro _DEMON_IDLE_TIMEOUT]
gcode = 
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	
	{% if start_vars.nevermore == True and printer["fan_generic Nevermore"].speed != 0 %}
	SET_GCODE_VARIABLE MACRO=_CORE_VARS VARIABLE=nm_fan_speed VALUE={printer["fan_generic Nevermore"].speed|float}
	SET_FAN_SPEED FAN=Nevermore SPEED=0
	{% endif %}
	
	{% if printer.print_stats.state == "paused" %}
	{% if start_vars.infinite_pause == True %}
	SET_GCODE_VARIABLE MACRO=RESUME VARIABLE=idle_state VALUE=True
	M107
	SET_HEATER_TEMPERATURE HEATER=extruder TARGET=0
	SET_DISPLAY_TEXT MSG="Idle timeout: Infinite pause running, nozzle powered down, auto re-heat enabled. Waiting for user..."
	RESPOND TYPE=COMMAND MSG="Idle timeout: Infinite pause running, nozzle powered down, auto re-heat enabled. Waiting for user..."
	_SAVE
	
	{% else %}
	SET_DISPLAY_TEXT MSG="PRINT CANCELLED! Pause timed out! Please enable variable_infinite_pause in demon_user_settings.cfg to avoid this & restart your print"
	RESPOND TYPE=COMMAND MSG="PRINT CANCELLED! Pause timed out! Please enable variable_infinite_pause in demon_user_settings.cfg to avoid this & restart your print"
	SET_GCODE_VARIABLE MACRO=_CORE_VARS VARIABLE=nm_fan_speed VALUE=0
	CANCEL_PRINT
	M84
	{% if start_vars.timeout_power == True and start_vars.shutdown_relay == True %}
	_GOODNIGHT
	{% endif %}
	{% endif %}
	
	{% else %}
	SET_DISPLAY_TEXT MSG="Idle Timeout"
	RESPOND TYPE=COMMAND MSG="Idle Timeout"
	TURN_OFF_HEATERS
	M84
	{% if start_vars.timeout_power == True and start_vars.shutdown_relay == True %}
	_GOODNIGHT
	{% endif %}
	
	{% endif %}

[gcode_macro _FIL_CHANGE_PARK]
gcode = 
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	
	SET_DISPLAY_TEXT MSG="Moving to filament change position, use load/unload macros when ready!"
	RESPOND TYPE=COMMAND MSG="Moving to filament change position, use load/unload macros when ready!"
	PAUSE X={start_vars.filament_change_park_x} Y={start_vars.filament_change_park_y} Z_MIN={start_vars.filament_change_park_min_z} RESTORE=0
	_SAVE

[gcode_macro _MAX_EXTRUDE_CHECK]
gcode = 
	{% set max_velocity = printer.configfile.settings['extruder'].max_extrude_only_velocity * 60 %}
	
	{% if max_velocity == 7982.432411074328 %}
	{action_raise_error("Please set a feedrate mm per second max_extrude_only_velocity in your printer.cfg [extruder] section. e.g. max_extrude_only_velocity: 12")}
	{% endif %}
	
	{% if max_velocity > 1260 %}
	{action_raise_error("WARNING! Your printer's max_extrude_only_velocity setting is too high! The operation has been cancelled to prevent damage to your extruder! Reset to a feedrate value below 20mm/s in your printer.cfg [extruder] section")}
	{% endif %}

[gcode_macro _RUNOUT_SENSOR_CHECK]
gcode = 
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	
	{% if start_vars.runout_sensor == True %}
	{% if printer['filament_switch_sensor filament_sensor'].enabled == 1 %}
	{% if not printer["filament_switch_sensor filament_sensor"].filament_detected %}
	{action_raise_error("This error is caused by no being filament loaded! Please load filament & restart the print!")}
	{% else %}
	RESPOND TYPE=COMMAND MSG="Runout sensor: Enabled, filament check passed"
	{% endif %}
	
	{% elif printer['filament_switch_sensor filament_sensor'].enabled != 1 %}
	RESPOND TYPE=COMMAND MSG="Runout sensor: Disabled, filament check skipped"
	{% endif %}
	{% endif %}

[gcode_macro _ENCODER_FEED_CHECK_PREP]
gcode = 
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	
	{% if start_vars.encoder_runout_sensor == True %}
	{% if printer['filament_motion_sensor encoder_sensor'].enabled != 1 %}
	SET_FILAMENT_SENSOR SENSOR=encoder_sensor ENABLE=1
	{% endif %}
	{% endif %}

[gcode_macro _ENCODER_FEED_CHECK]
gcode = 
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	
	{% if start_vars.encoder_runout_sensor == True %}
	{% if not printer["filament_motion_sensor encoder_sensor"].filament_detected %}
	{% if printer.print_stats.state == "paused" %}
	RESPOND TYPE=error MSG="Encoder filament sensor triggered! This error is caused by the filament not being taken up by the extruder, or the nozzle is clogged! Please check filament state & try again!"
	{% else %}
	{action_raise_error("Encoder filament sensor triggered! This error is caused by the filament not being taken up by the extruder, or the nozzle is clogged! Please check filament state & try again!")}
	{% endif %}
	{% endif %}
	
	UPDATE_DELAYED_GCODE ID=_ENCODER_RUNOUT_CONTROL DURATION=5
	{% endif %}

[delayed_gcode _ENCODER_RUNOUT_CONTROL]
gcode = 
	
	{% if printer.print_stats.state not in ['printing', 'paused'] %}
	SET_FILAMENT_SENSOR SENSOR=encoder_sensor ENABLE=0
	UPDATE_DELAYED_GCODE ID=_ENCODER_RUNOUT_CONTROL DURATION=0
	
	{% elif printer.print_stats.state in ['printing', 'paused'] %}
	{% if printer.print_stats.info.current_layer in range(0, 2) %}
	SET_FILAMENT_SENSOR SENSOR=encoder_sensor ENABLE=0
	UPDATE_DELAYED_GCODE ID=_ENCODER_RUNOUT_CONTROL DURATION=10
	{% else %}
	SET_FILAMENT_SENSOR SENSOR=encoder_sensor ENABLE=1
	UPDATE_DELAYED_GCODE ID=_ENCODER_RUNOUT_CONTROL DURATION=0
	RESPOND TYPE=COMMAND MSG="Layer 1 complete, encoder runout sensor enabled"
	{% endif %}
	{% endif %}

[gcode_macro _RESET_FILE_STATE]
gcode = 
	
	{% if printer.print_stats.state not in ["printing", "paused", "busy"] %}
	SDCARD_RESET_FILE
	SET_DISPLAY_TEXT MSG="Printer State reset to Standby"
	G4 P5000
	M117
	{% else %}
	SET_DISPLAY_TEXT MSG="File reset denied, printer is busy"
	RESPOND TYPE=error MSG="File reset denied, printer is busy"
	{% endif %}

[gcode_macro PRINTER_STATUS]
description = Checks the current status of your system!
gcode = 
	{% if "xyz" != printer.toolhead.homed_axes%}
	RESPOND TYPE=COMMAND MSG="Homed Axes: None"
	{% else %}
	RESPOND TYPE=COMMAND MSG="Homed Axes: {printer.toolhead.homed_axes}"
	{% endif %}
	
	{% if printer.print_stats.state == "standby" and printer.idle_timeout.state == "Printing" %}
	RESPOND TYPE=COMMAND MSG="Printer timeout state: Busy"
	{% else %}
	RESPOND TYPE=COMMAND MSG="Printer timeout state: {printer.idle_timeout.state}"
	{% endif %}
	
	RESPOND TYPE=COMMAND MSG="Printer status: {printer.print_stats.state}"
	RESPOND TYPE=COMMAND MSG="Virtual SDcard is active: {printer.virtual_sdcard.is_active}"
	
	{% if printer.print_stats.state in ["printing", "paused"] %}
	RESPOND TYPE=COMMAND MSG="Virtual SDcard print progess in percent: {printer.virtual_sdcard.progress}"
	RESPOND TYPE=COMMAND MSG="File: {printer.print_stats.filename}"
	RESPOND TYPE=COMMAND MSG="Info: {printer.print_stats.info}"
	RESPOND TYPE=COMMAND MSG="{printer.print_stats.message}"
	{% endif %}

[gcode_macro SYSTEM_SENSORS]
description = Shows you the system names of available sensors on your printer
gcode = 
	{ action_respond_info(printer.heaters.available_heaters | join(' | ')) }
	{ action_respond_info(printer.heaters.available_sensors | join(' | ')) }

[delayed_gcode _welcome]
initial_duration = 2
gcode = 
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	{% set svv = printer.save_variables.variables %}
	
	{% if svv.using_shell == True %}
	_DISK_SPACE_CHECK
	{% else %}
	RESPOND TYPE=command MSG="Shell script extension not in use. Disk_Space_Check disbaled."
	{% endif %}
	
	_DEMON_VERSION
	_LOAD
	{% if printer.print_stats.state not in ['printing', 'paused'] %}
	SET_DISPLAY_TEXT MSG="{start_vars.screen_msg}"
	RESPOND TYPE=COMMAND MSG="{start_vars.console_msg}"
	{% endif %}

[delayed_gcode _USER_FILES_CHECK]
initial_duration = 10
gcode = 
	
	{% if not printer["gcode_macro _START_VARIABLES"] %}
	RESPOND TYPE=error MSG="WARNING: The demon_user_settings cfg file is NOT included in the system! Please include this file & set it up BEFORE you try to print!"
	SET_DISPLAY_TEXT MSG="WARNING: The demon_user_settings cfg file is NOT included in the system! Please include this file & set it up BEFORE you try to print!"
	
	{% elif not printer["gcode_macro _CLEAN_VARIABLES"] %}
	RESPOND TYPE=error MSG="WARNING: The demon_user_settings_cleaner_variables cfg file is NOT included in the system! Please include this file & set it up BEFORE you try to print!"
	SET_DISPLAY_TEXT MSG="WARNING: The demon_user_settings_cleaner_variables cfg file is NOT included in the system! Please include this file & set it up BEFORE you try to print!"
	
	{% elif not printer["gcode_macro CUSTOM_EXPANSION_ACTIVE_LIST"] %}
	RESPOND TYPE=error MSG="WARNING: The demon_custom_expansion cfg file is NOT included in the system! Please include this file & set it up BEFORE you try to print!"
	SET_DISPLAY_TEXT MSG="WARNING: The demon_custom_expansion cfg file is NOT included in the system! Please include this file & set it up BEFORE you try to print!"
	{% endif %}
	
	{% if 'force_move' not in printer.configfile.config %}
	RESPOND TYPE=error MSG="WARNING: The force_move printer.cfg section is missing. Please make sure it's correctly added to your printer.cfg!"
	SET_DISPLAY_TEXT MSG="WARNING: The force_move printer.cfg section is missing. Please make sure it's correctly added to your printer.cfg!"
	{% endif %}
	
	{% if 'respond' not in printer.configfile.config %}
	RESPOND TYPE=error MSG="WARNING: The respond printer.cfg section is missing. Please make sure it's correctly added to your printer.cfg!"
	SET_DISPLAY_TEXT MSG="WARNING: The respond printer.cfg section is missing. Please make sure it's correctly added to your printer.cfg!"
	{% endif %}
	
	{% if 'save_variables' not in printer.configfile.config %}
	RESPOND TYPE=error MSG="WARNING: The save_variables printer.cfg section is missing. Please make sure it's correctly added to your printer.cfg!"
	SET_DISPLAY_TEXT MSG="WARNING: The save_variables printer.cfg section is missing. Please make sure it's correctly added to your printer.cfg!"
	{% endif %}
	
	{% if 'exclude_object' not in printer.configfile.config %}
	RESPOND TYPE=error MSG="WARNING: The exclude_object printer.cfg section is missing. Please make sure it's correctly added to your printer.cfg!"
	SET_DISPLAY_TEXT MSG="WARNING: The exclude_object printer.cfg section is missing. Please make sure it's correctly added to your printer.cfg!"
	{% endif %}

[gcode_macro _DEMON_VERSION_MISMATCH]
gcode = 
	{action_raise_error("This error is caused by Demon_version mismatch please check and update your Demon Essentials Macro files!")}

[gcode_macro _DEMON_VERSION]
variable_demon_user_settings_version = "2.9.5"
variable_demon_clnvars_version = "1.1.0"
variable_demon_ceal_version = "1.0.1"
variable_demon_demon_vars_version = "1.0.0"
variable_demon_clean_load_version = "1.9.1"
variable_demon_setup_hlpr_version = "1.5.3"
variable_demon_z_cal_version = "1.6.1"
variable_demon_prpr_menu = "1.2.0"
variable_demon_mesh_bldr_version = "1.5.1"
variable_demon_apa_version = "1.2.0"
variable_demon_bed_fans_version = "1.3.0"
variable_demon_core_version = "1.4.0"
variable_demon_prnt_strt_version = "2.9.5"
variable_demon_chmbr_htr_version = "1.1.1"
variable_demon_aes_version = "1.1.0"
variable_demon_home_ctrl_version = "1.4.0"
gcode = 
	{% set dvv = printer["gcode_macro _DEMON_VERSION_VARS"] %}
	{% set svv = printer.save_variables.variables %}
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	{% set clean_load_ver = printer["gcode_macro _CLEAN_LOAD_VERSION"] %}
	{% set setup_helpers_ver = printer["gcode_macro _SETUP_HELPERS_VERSION"] %}
	{% set z_cal_ver = printer["gcode_macro _Z_CALIBRATION_VERSION"] %}
	{% set prepare_menu_ver = printer["gcode_macro _PREPARE_MENU_VERSION"] %}
	{% set mesh_builder_ver = printer["gcode_macro _MESH_BUILDER_VERSION"] %}
	{% set pa_vars = printer["gcode_macro _PA_VERSION"] %}
	{% set bed_fans_ver = printer["gcode_macro _BED_FANS_VERSION"] %}
	{% set core_ver = printer["gcode_macro _CORE_VERSION"] %}
	{% set print_start_ver = printer["gcode_macro _PRINT_START_VERSION"] %}
	{% set chamber_heater_ver = printer["gcode_macro _CHAMBER_HEATER_VERSION"] %}
	{% set aes_ver = printer["gcode_macro _AES_VERSION"] %}
	{% set home_ver = printer["gcode_macro _HOME_VERSION"] %}
	{% set clean_vars_ver = printer["gcode_macro _CLEAN_VARS_VER"] %}
	{% set ceal_ver = printer["gcode_macro _CEAL_VERSION"] %}
	
	{% if start_vars.demon_version|string != demon_user_settings_version|string %}
	{% if svv.using_shell == True %}
	{% if printer.print_stats.state not in ['printing', 'paused', 'busy'] %}
	_USER_SETTINGS_FILE_PROMPT
	{% else %}
	RESPOND TYPE=error MSG="DEMON_USER_SETTINGS VERSION_MISMATCH"
	_DEMON_VERSION_MISMATCH
	{% endif %}
	{% else %}
	RESPOND TYPE=error MSG="DEMON_USER_SETTINGS VERSION_MISMATCH"
	_DEMON_VERSION_MISMATCH
	{% endif %}
	
	{% elif clean_vars_ver.demon_clean_vars_ver|string != demon_clnvars_version|string %}
	{% if svv.using_shell == True %}
	{% if printer.print_stats.state not in ['printing', 'paused', 'busy'] %}
	_USER_CLEANER_FILE_PROMPT
	{% else %}
	RESPOND TYPE=error MSG="DEMON_USER_SETTINGS_CLEANER_VARIABLES_VERSION_MISMATCH"
	_DEMON_VERSION_MISMATCH
	{% endif %}
	{% else %}
	RESPOND TYPE=error MSG="DEMON_USER_SETTINGS_CLEANER_VARIABLES_VERSION_MISMATCH"
	_DEMON_VERSION_MISMATCH
	{% endif %}
	
	{% elif ceal_ver.demon_ceal|string != demon_ceal_version|string %}
	{% if svv.using_shell == True %}
	{% if printer.print_stats.state not in ['printing', 'paused', 'busy'] %}
	_USER_EXPANSION_FILE_PROMPT
	{% else %}
	RESPOND TYPE=error MSG="DEMON_USER_SETTINGS_CEAL_VERSION_MISMATCH"
	_DEMON_VERSION_MISMATCH
	{% endif %}
	{% else %}
	RESPOND TYPE=error MSG="DEMON_USER_SETTINGS_CEAL_VERSION_MISMATCH"
	_DEMON_VERSION_MISMATCH
	{% endif %}
	
	{% elif svv.version_dvars|string != demon_demon_vars_version|string %}
	{% if svv.using_shell == True %}
	{% if printer.print_stats.state not in ['printing', 'paused', 'busy'] %}
	_DEMON_VARS_PROMPT
	{% else %}
	RESPOND TYPE=error MSG="DEMON_VARS_VERSION_MISMATCH"
	_DEMON_VERSION_MISMATCH
	{% endif %}
	{% else %}
	RESPOND TYPE=error MSG="DEMON_VARS_VERSION_MISMATCH"
	_DEMON_VERSION_MISMATCH
	{% endif %}
	
	{% elif clean_load_ver.demon_clean_load|string != demon_clean_load_version|string %}
	RESPOND TYPE=error MSG="DEMON_CLEAN_LOAD_VERSION_MISMATCH"
	_DEMON_VERSION_MISMATCH
	
	{% elif setup_helpers_ver.demon_setup|string != demon_setup_hlpr_version|string %}
	RESPOND TYPE=error MSG="DEMON_SETUP_HELPERS_VERSION_MISMATCH"
	_DEMON_VERSION_MISMATCH
	
	{% elif z_cal_ver.demon_z_cal|string != demon_z_cal_version|string %}
	RESPOND TYPE=error MSG="DEMON_ZCAL_VERSION_MISMATCH"
	_DEMON_VERSION_MISMATCH
	
	{% elif prepare_menu_ver.demon_prepare_menu|string != demon_prpr_menu|string %}
	RESPOND TYPE=error MSG="DEMON_PREPARE_MENU_VERSION_MISMATCH"
	_DEMON_VERSION_MISMATCH
	
	{% elif mesh_builder_ver.demon_mesh_builder|string != demon_mesh_bldr_version|string %}
	RESPOND TYPE=error MSG="DEMON_MESH_BUILDER_VERSION_MISMATCH"
	_DEMON_VERSION_MISMATCH
	
	{% elif pa_vars.demon_apa|string != demon_apa_version|string %}
	RESPOND TYPE=error MSG="DEMON_PA_VERSION_MISMATCH"
	_DEMON_VERSION_MISMATCH
	
	{% elif bed_fans_ver.demon_bed_fans|string != demon_bed_fans_version|string %}
	RESPOND TYPE=error MSG="DEMON_BED_FANS_VERSION_MISMATCH"
	_DEMON_VERSION_MISMATCH
	
	{% elif core_ver.demon_core_ver|string != demon_core_version|string %}
	RESPOND TYPE=error MSG="DEMON_CORE_VERSION_MISMATCH"
	_DEMON_VERSION_MISMATCH
	
	{% elif print_start_ver.demon_start_ver|string != demon_prnt_strt_version|string %}
	RESPOND TYPE=error MSG="DEMON_PRINT_START_VERSION_MISMATCH"
	_DEMON_VERSION_MISMATCH
	
	{% elif chamber_heater_ver.demon_chamber_heater_ver|string != demon_chmbr_htr_version|string %}
	RESPOND TYPE=error MSG="DEMON_CHAMBER_HEATER_VERSION_MISMATCH"
	_DEMON_VERSION_MISMATCH
	
	{% elif aes_ver.demon_aes_ver|string != demon_aes_version|string %}
	RESPOND TYPE=error MSG="DEMON_AES_VERSION_MISMATCH"
	_DEMON_VERSION_MISMATCH
	
	{% elif home_ver.demon_home_ver|string != demon_home_ctrl_version|string %}
	RESPOND TYPE=error MSG="DEMON_HOME_VERSION_MISMATCH"
	_DEMON_VERSION_MISMATCH
	
	{% else %}
	RESPOND TYPE=COMMAND MSG="PRINTER CHECK: PASSED"
	
	{% endif %}

[gcode_macro _CORE_VERSION]
variable_demon_core_ver = "1.4.0"
gcode = 

[homing_override]
axes = xyz
gcode = 
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	{% set driver_vars = printer["gcode_macro _DRIVER_VARS"] %}
	{% set home_all = 'X' not in params and 'Y' not in params and 'Z' not in params %}
	
	{% if start_vars.klicky_probe == True %}
	{ action_raise_error("You appear to be using Klicky_probe but homing_override is defined in your demon_homing_control.cfg. Please comment out the entire [homing_override] macro to continue") }
	
	{% else %}
	
	_HOME_POWER_SAFETY
	RESPOND TYPE=COMMAND MSG="Homing requested"
	
	{% if driver_vars.definer_executed == False %}
	_DRIVER_DEFINER
	{% else %}
	{% if driver_vars.readback == True %}
	RESPOND TYPE=COMMAND MSG="XY Drivers previously defined"
	{% endif %}
	{% endif %}
	
	{% if start_vars.neopixel_led == True %}
	STATUS_HOMING
	{% endif %}
	
	_SET_Z_PARK
	
	{% if 'z' not in printer.toolhead.homed_axes %}
	{% if 'x' not in printer.toolhead.homed_axes or 'y' not in printer.toolhead.homed_axes %}
	{% if 'Z' in params %}
	{ action_raise_error("Request denied, operation cancelled! Home X & Y axes first before requesting homing Z") }
	
	{% else %}
	
	{% if 'x' in printer.toolhead.homed_axes or 'y' in printer.toolhead.homed_axes %}
	
	{% else %}
	
	
	_Z_LIFT
	
	{% endif %}
	{% endif %}
	{% endif %}
	
	{% else %}
	
	{% if printer.toolhead.position.z|float < 5 %}
	RESPOND TYPE=COMMAND MSG="Z axis <5mm. Raising for safe clearance prior to homing"
	_Z_LIFT
	{% endif %}
	{% endif %}
	
	{% if start_vars.home_y_first == True %}
	{% if home_all or 'Y' in params %}
	_HOME_Y
	{% endif %}
	
	{% if home_all or 'X' in params %}
	_HOME_X
	{% endif %}
	
	{% else %}
	{% if home_all or 'X' in params %}
	_HOME_X
	{% endif %}
	
	{% if home_all or 'Y' in params %}
	_HOME_Y
	{% endif %}
	{% endif %}
	
	{% if home_all or 'Z' in params %}
	
	{% if start_vars.aes_system == True %}
	SET_GCODE_VARIABLE MACRO=_AES_SYS VARIABLE=e_stop_armed VALUE=True
	_AES_READ
	{% endif %}
	
	{% if printer.configfile.settings.stepper_z.endstop_pin == 'probe:z_virtual_endstop' %}
	G90
	{% if start_vars.set_probe_point_default == True %}
	G0 X{printer.toolhead.axis_maximum.x|float / 2} Y{printer.toolhead.axis_maximum.y|float / 2} F{start_vars.homing_movement_travel_speed|int * 60}
	{% else %}
	G0 X{start_vars.set_probe_custom_x|float} Y{start_vars.set_probe_custom_y|float} F{start_vars.homing_movement_travel_speed|int * 60}
	{% endif %}
	
	{% else %}
	G90
	G0 X{start_vars.z_endstop_loaction_x|float} Y{start_vars.z_endstop_loaction_y|float} F{start_vars.homing_movement_travel_speed|int * 60}
	{% endif %}
	
	G28 Z
	M400
	
	{% if printer.configfile.settings.stepper_z.endstop_pin == 'probe:z_virtual_endstop' %}
	G0 Z10 F3600
	{% if 'mcu eddy' in printer.configfile.config or 'probe_eddy_current btt_eddy' in printer %}
	PROBE
	SET_Z_FROM_PROBE
	_Z_PARK
	
	{% else %}
	_Z_PARK
	{% endif %}
	
	{% else %}
	{% if start_vars.post_z_switch_backoff == True %}
	G0 Z{start_vars.post_z_switch_backoff_height|int} F{start_vars.z_lift_speed|int * 60}
	G91
	G0 Y-{start_vars.post_z_switch_backoff_y_dist|int} F{start_vars.homing_movement_travel_speed|int * 60}
	G90
	{% endif %}
	{% endif %}
	
	{% if start_vars.aes_system == True %}
	SET_GCODE_VARIABLE MACRO=_AES_SYS VARIABLE=e_stop_armed VALUE=False
	_AES_READ
	{% endif %}
	
	M400
	_SAVE
	{% if start_vars.z_tracker_reduced_monitoring == False %}
	UPDATE_DELAYED_GCODE ID=_ACTIVE_Z_MONITOR DURATION=1
	{% endif %}
	{% endif %}
	
	
	{% if start_vars.neopixel_led == True %}
	STATUS_READY
	{% endif %}
	
	M117
	
	{% endif %}
	G90

[gcode_macro _HOME_X]
gcode = 
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	{% set driver_vars = printer["gcode_macro _DRIVER_VARS"] %}
	
	{% if driver_vars.definer_executed == False %}
	{action_raise_error("Home_X cancelled. You appear to not have run the _DRIVER_DEFINER macro. This happens when you comment out the demon_homing_control_vx.x.cfg [homing_override] macro, example when using Klicky Probe. Please add _DRIVER_DEFINER to your currently active [homing_override] macro to continue")}
	
	{% elif driver_vars.definer_executed == True %}
	{% if driver_vars.tmc_found_x == True %}
	
	_HOME_POWER_SAFETY
	
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={start_vars.home_power|float}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={start_vars.home_power|float}
	
	G28 X
	G91
	
	{% if printer.configfile.settings.stepper_x.homing_positive_dir == False %}
	G0 X{start_vars.axis_backoff_distance|int} F{start_vars.axis_backoff_speed|int * 60}
	{% else %}
	G0 X-{start_vars.axis_backoff_distance|int} F{start_vars.axis_backoff_speed|int * 60}
	{% endif %}
	
	G4 P{start_vars.axis_register_clear_wait|float * 1000}
	
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={driver_vars.run_x|float}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={driver_vars.run_y|float}
	
	{% else %}
	
	G28 X
	G91
	
	{% if printer.configfile.settings.stepper_x.homing_positive_dir == False %}
	G0 X{start_vars.axis_backoff_distance|int} F{start_vars.axis_backoff_speed|int * 60}
	{% else %}
	G0 X-{start_vars.axis_backoff_distance|int} F{start_vars.axis_backoff_speed|int * 60}
	{% endif %}
	
	{% endif %}
	G90
	{% endif %}

[gcode_macro _HOME_Y]
gcode = 
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	{% set driver_vars = printer["gcode_macro _DRIVER_VARS"] %}
	
	{% if driver_vars.definer_executed == False %}
	{action_raise_error("Home_Y cancelled. You appear to not have run the _DRIVER_DEFINER macro. This happens when you comment out the demon_homing_control_vx.x.cfg [homing_override] macro, example when using Klicky Probe. Please add _DRIVER_DEFINER to your currently active [homing_override] macro to continue")}
	
	{% elif driver_vars.definer_executed == True %}
	{% if driver_vars.tmc_found_y == True %}
	
	_HOME_POWER_SAFETY
	
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={start_vars.home_power|float}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={start_vars.home_power|float}
	
	G28 Y
	G91
	
	{% if printer.configfile.settings.stepper_y.homing_positive_dir == False %}
	G0 Y{start_vars.axis_backoff_distance|int} F{start_vars.axis_backoff_speed|int * 60}
	{% else %}
	G0 Y-{start_vars.axis_backoff_distance|int} F{start_vars.axis_backoff_speed|int * 60}
	{% endif %}
	
	G4 P{start_vars.axis_register_clear_wait|float * 1000}
	
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={driver_vars.run_x|float}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={driver_vars.run_y|float}
	
	{% else %}
	
	G28 Y
	G91
	
	{% if printer.configfile.settings.stepper_y.homing_positive_dir == False %}
	G0 Y{start_vars.axis_backoff_distance|int} F{start_vars.axis_backoff_speed|int * 60}
	{% else %}
	G0 Y-{start_vars.axis_backoff_distance|int} F{start_vars.axis_backoff_speed|int * 60}
	{% endif %}
	
	{% endif %}
	G90
	{% endif %}

[gcode_macro _DRIVER_DEFINER]
gcode = 
	{% set driver_vars = printer["gcode_macro _DRIVER_VARS"] %}
	{% set cf = printer.configfile.config %}
	
	SET_GCODE_VARIABLE MACRO=_DRIVER_VARS VARIABLE=definer_executed VALUE=True
	
	{% if 'tmc2209 stepper_x' not in cf and 'tmc5160 stepper_x' not in cf and 'tmc2208 stepper_x' not in cf and 'tmc2226 stepper_x' not in cf and 'tmc2225 stepper_x'
	not in cf and 'tmc2130 stepper_x' not in cf and 'tmc2240 stepper_x' not in cf and 'tmc2660 stepper_x' not in cf %}
	RESPOND TYPE=COMMAND MSG="DRIVER_DEFINER: No supported UART connected TMC X axis driver detected"
	SET_GCODE_VARIABLE MACRO=_DRIVER_VARS VARIABLE=tmc_found_x VALUE=False
	{% endif %}
	
	{% if 'tmc2209 stepper_y' not in cf and 'tmc5160 stepper_y' not in cf and 'tmc2208 stepper_y' not in cf and 'tmc2226 stepper_y' not in cf and 'tmc2225 stepper_y'
	not in cf and 'tmc2130 stepper_y' not in cf and 'tmc2240 stepper_y' not in cf and 'tmc2660 stepper_y' not in cf %}
	RESPOND TYPE=COMMAND MSG="DRIVER_DEFINER: No supported UART connected TMC Y axis driver detected"
	SET_GCODE_VARIABLE MACRO=_DRIVER_VARS VARIABLE=tmc_found_y VALUE=False
	{% endif %}
	
	{% if 'tmc2209 stepper_x' in printer.configfile.config %}
	SET_GCODE_VARIABLE MACRO=_DRIVER_VARS VARIABLE=run_x VALUE={printer.configfile.config['tmc2209 stepper_x'].run_current|float}
	{% if driver_vars.readback == True %}
	RESPOND TYPE=COMMAND MSG="Defined TMC2209 driver X axis"
	{% endif %}
	
	{% elif 'tmc5160 stepper_x' in printer.configfile.config %}
	SET_GCODE_VARIABLE MACRO=_DRIVER_VARS VARIABLE=run_x VALUE={printer.configfile.config['tmc5160 stepper_x'].run_current|float}
	{% if driver_vars.readback == True %}
	RESPOND TYPE=COMMAND MSG="Defined TMC5160 driver X axis"
	{% endif %}
	
	{% elif 'tmc2208 stepper_x' in printer.configfile.config %}
	SET_GCODE_VARIABLE MACRO=_DRIVER_VARS VARIABLE=run_x VALUE={printer.configfile.config['tmc2208 stepper_x'].run_current|float}
	{% if driver_vars.readback == True %}
	RESPOND TYPE=COMMAND MSG="Defined TMC2208 driver X axis"
	{% endif %}
	
	{% elif 'tmc2226 stepper_x' in printer.configfile.config %}
	SET_GCODE_VARIABLE MACRO=_DRIVER_VARS VARIABLE=run_x VALUE={printer.configfile.config['tmc2226 stepper_x'].run_current|float}
	{% if driver_vars.readback == True %}
	RESPOND TYPE=COMMAND MSG="Defined TMC2226 driver X axis"
	{% endif %}
	
	{% elif 'tmc2225 stepper_x' in printer.configfile.config %}
	SET_GCODE_VARIABLE MACRO=_DRIVER_VARS VARIABLE=run_x VALUE={printer.configfile.config['tmc2225 stepper_x'].run_current|float}
	{% if driver_vars.readback == True %}
	RESPOND TYPE=COMMAND MSG="Defined TMC2225 driver X axis"
	{% endif %}
	
	{% elif 'tmc2130 stepper_x' in printer.configfile.config %}
	SET_GCODE_VARIABLE MACRO=_DRIVER_VARS VARIABLE=run_x VALUE={printer.configfile.config['tmc2130 stepper_x'].run_current|float}
	{% if driver_vars.readback == True %}
	RESPOND TYPE=COMMAND MSG="Defined TMC2130 driver X axis"
	{% endif %}
	
	{% elif 'tmc2240 stepper_x' in printer.configfile.config %}
	SET_GCODE_VARIABLE MACRO=_DRIVER_VARS VARIABLE=run_x VALUE={printer.configfile.config['tmc2240 stepper_x'].run_current|float}
	{% if driver_vars.readback == True %}
	RESPOND TYPE=COMMAND MSG="Defined TMC2240 driver X axis"
	{% endif %}
	
	{% elif 'tmc2660 stepper_x' in printer.configfile.config %}
	SET_GCODE_VARIABLE MACRO=_DRIVER_VARS VARIABLE=run_x VALUE={printer.configfile.config['tmc2660 stepper_x'].run_current|float}
	{% if driver_vars.readback == True %}
	RESPOND TYPE=COMMAND MSG="Defined TMC2660 driver X axis"
	{% endif %}
	
	{% endif %}
	
	{% if 'tmc2209 stepper_y' in printer.configfile.config %}
	SET_GCODE_VARIABLE MACRO=_DRIVER_VARS VARIABLE=run_y VALUE={printer.configfile.config['tmc2209 stepper_y'].run_current|float}
	{% if driver_vars.readback == True %}
	RESPOND TYPE=COMMAND MSG="Defined TMC2209 driver Y axis"
	{% endif %}
	
	{% elif 'tmc5160 stepper_y' in printer.configfile.config %}
	SET_GCODE_VARIABLE MACRO=_DRIVER_VARS VARIABLE=run_y VALUE={printer.configfile.config['tmc5160 stepper_y'].run_current|float}
	{% if driver_vars.readback == True %}
	RESPOND TYPE=COMMAND MSG="Defined TMC5160 driver Y axis"
	{% endif %}
	
	{% elif 'tmc2208 stepper_y' in printer.configfile.config %}
	SET_GCODE_VARIABLE MACRO=_DRIVER_VARS VARIABLE=run_y VALUE={printer.configfile.config['tmc2208 stepper_y'].run_current|float}
	{% if driver_vars.readback == True %}
	RESPOND TYPE=COMMAND MSG="Defined TMC2208 driver Y axis"
	{% endif %}
	
	{% elif 'tmc2226 stepper_y' in printer.configfile.config %}
	SET_GCODE_VARIABLE MACRO=_DRIVER_VARS VARIABLE=run_y VALUE={printer.configfile.config['tmc2226 stepper_y'].run_current|float}
	{% if driver_vars.readback == True %}
	RESPOND TYPE=COMMAND MSG="Defined TMC2226 driver Y axis"
	{% endif %}
	
	{% elif 'tmc2225 stepper_y' in printer.configfile.config %}
	SET_GCODE_VARIABLE MACRO=_DRIVER_VARS VARIABLE=run_y VALUE={printer.configfile.config['tmc2225 stepper_y'].run_current|float}
	{% if driver_vars.readback == True %}
	RESPOND TYPE=COMMAND MSG="Defined TMC2225 driver Y axis"
	{% endif %}
	
	{% elif 'tmc2130 stepper_y' in printer.configfile.config %}
	SET_GCODE_VARIABLE MACRO=_DRIVER_VARS VARIABLE=run_y VALUE={printer.configfile.config['tmc2130 stepper_y'].run_current|float}
	{% if driver_vars.readback == True %}
	RESPOND TYPE=COMMAND MSG="Defined TMC2130 driver Y axis"
	{% endif %}
	
	{% elif 'tmc2240 stepper_y' in printer.configfile.config %}
	SET_GCODE_VARIABLE MACRO=_DRIVER_VARS VARIABLE=run_y VALUE={printer.configfile.config['tmc2240 stepper_y'].run_current|float}
	{% if driver_vars.readback == True %}
	RESPOND TYPE=COMMAND MSG="Defined TMC2240 driver Y axis"
	{% endif %}
	
	{% elif 'tmc2660 stepper_y' in printer.configfile.config %}
	SET_GCODE_VARIABLE MACRO=_DRIVER_VARS VARIABLE=run_y VALUE={printer.configfile.config['tmc2660 stepper_y'].run_current|float}
	{% if driver_vars.readback == True %}
	RESPOND TYPE=COMMAND MSG="Defined TMC2660 driver Y axis"
	{% endif %}
	
	{% endif %}

[gcode_macro _Z_LIFT]
gcode = 
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	{% set core_vars = printer["gcode_macro _CORE_VARS"] %}
	{% set driver_vars = printer["gcode_macro _DRIVER_VARS"] %}
	
	{% if 'z' not in printer.toolhead.homed_axes %}
	{% if core_vars.last_known_z <= (printer.toolhead.axis_maximum.z|int - start_vars.pre_home_lift|int) - 20 %}
	RESPOND TYPE=COMMAND MSG="Raising Z axis for safe clearance prior to homing"
	RESPOND TYPE=COMMAND MSG="WARNING AXES RESET FOR Z LIFT!!"
	SET_KINEMATIC_POSITION Z=0
	SET_GCODE_VARIABLE MACRO=_DRIVER_VARS VARIABLE=z_lift_move VALUE=True
	M400
	G90
	{% if start_vars.pre_home_lift|int in range (0, 21) and start_vars.z_lift_speed|int in range (1, 26) %}
	G0 Z{start_vars.pre_home_lift|int} F{start_vars.z_lift_speed|int * 60}
	M400
	
	M84
	{% else %}
	M84
	{ action_raise_error("Request denied, operation cancelled! Lift height or speed not in range. See demon_user_settings.cfg DEMON HOME CONTROL SETTINGS") }
	{% endif %}
	
	{% else %}
	RESPOND TYPE=COMMAND MSG="Z Axis near maximum, lift skipped"
	{% endif %}
	
	{% else %}
	{% if printer.toolhead.position.z <= (printer.toolhead.axis_maximum.z|int - start_vars.pre_home_lift|int) - 20 %}
	G90
	{% if start_vars.pre_home_lift|int in range (0, 21) and start_vars.z_lift_speed|int in range (1, 26) %}
	RESPOND TYPE=COMMAND MSG="Raising Z axis for safe clearance prior to homing"
	G0 Z{start_vars.pre_home_lift|int} F{start_vars.z_lift_speed|int * 60}
	M400
	{% else %}
	{ action_raise_error("Request denied, operation cancelled! Lift height or speed not in range. See demon_user_settings.cfg DEMON HOME CONTROL SETTINGS") }
	{% endif %}
	{% else %}
	RESPOND TYPE=COMMAND MSG="Z Axis near maximum, lift skipped"
	{% endif %}
	{% endif %}

[gcode_macro _HOME_POWER_SAFETY]
gcode = 
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	
	{% if start_vars.override_home_power_safety == False and start_vars.home_power|float > 1.0 %}
	{ action_raise_error("Request denied, the operation has been cancelled! Your soft home power levels are too high! See demon_user_settings.cfg DEMON HOME CONTROL SETTINGS where you can override this message if you wish") }
	{% endif %}

[gcode_macro _DRIVER_VARS]
variable_readback = True
variable_definer_executed = False
variable_tmc_found_x = True
variable_tmc_found_y = True
variable_run_x = 0.8
variable_run_y = 0.8
variable_z_lift_move = False
gcode = 

[gcode_macro _HOME_VERSION]
variable_demon_home_ver = "1.4.0"
gcode = 

[gcode_macro QUICK_MESH]
description = Build a quick & dirty mesh at current temps. It will NOT level your machine first!! Choose profile name! Compatible with Eddy Probe!
gcode = 
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	{% set profile = params.PROFILE|default('QUICK_MESH')|string %}
	G90
	_SET_Z_PARK
	_HOMING_HELPER
	
	{% if start_vars.neopixel_led == True %}
	STATUS_MESHING
	{% endif %}
	
	{% if 'mcu eddy' in printer.configfile.config or 'probe_eddy_current btt_eddy' in printer %}
	BED_MESH_CALIBRATE PROFILE={profile} METHOD=rapid_scan
	
	{% else %}
	BED_MESH_CALIBRATE PROFILE={profile}
	{% endif %}
	
	_Z_PARK
	
	{% if start_vars.neopixel_led == True %}
	STATUS_READY
	{% endif %}
	
	M117

[gcode_macro HOT_MESH]
description = Build an accurate mesh with the proper full process. Choose profile name & more! Compatible with Eddy Probe!
gcode = 
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	{% set profile = params.PROFILE|default('HOT_MESH')|string %}
	{% set nozzle = params.NOZZLE|default(160)|int %}
	{% set bed = params.BED|default(60)|int %}
	{% set soak = params.HEATSOAK|default('Yes')|string %}
	{% set time = params.TIMER|default(10)|int %}
	
	G90
	_SET_Z_PARK
	{% if start_vars.neopixel_led == True %}
	STATUS_HEATING
	{% endif %}
	
	SET_DISPLAY_TEXT MSG="HEATING..."
	RESPOND TYPE=COMMAND MSG="HEATING..."
	SET_HEATER_TEMPERATURE HEATER=heater_bed TARGET={bed}
	SET_HEATER_TEMPERATURE HEATER=extruder TARGET={nozzle}
	
	SET_DISPLAY_TEXT MSG="Waiting for Nozzle temp..."
	RESPOND TYPE=COMMAND MSG="Waiting for Nozzle temp..."
	TEMPERATURE_WAIT SENSOR=extruder MINIMUM={nozzle|int - 5} MAXIMUM={nozzle|int + 5}
	
	_HOMING_HELPER
	
	SET_DISPLAY_TEXT MSG="Waiting for bed temp..."
	RESPOND TYPE=COMMAND MSG="Waiting for bed temp..."
	TEMPERATURE_WAIT SENSOR=heater_bed MINIMUM={bed|int -2} MAXIMUM={bed|int + 5}
	
	{% if soak|lower in ['yes', 'true'] %}
	RESPOND TYPE=COMMAND MSG="Running Heatsoak timer..."
	_HEAT_WAIT MSG="Hot Mesh heatsoak timer..." MINUTES={time|int}
	M400
	G28 Z
	
	{% elif soak|lower in ['no', 'false'] %}
	RESPOND TYPE=COMMAND MSG="Heatsoak timer skipped"
	
	{% else %}
	RESPOND TYPE=error MSG="Hot Mesh heatsoak timer skipped. User input not recognised! Please use yes/no or true/false"
	{% endif %}
	
	{% if start_vars.nozzle_cleaner == True %}
	CLEAN_NOZZLE
	{% endif %}
	
	{% if start_vars.neopixel_led == True %}
	STATUS_LEVELING
	{% endif %}
	
	{% if start_vars.use_manual_levelling == True %}
	_ADAPTIVE_MANUAL_LEVELLING
	
	{% else %}
	_ADAPTIVE_LEVELLING
	{% endif %}
	
	{% if start_vars.neopixel_led == True %}
	STATUS_MESHING
	{% endif %}
	
	
	{% if 'mcu eddy' in printer.configfile.config or 'probe_eddy_current btt_eddy' in printer %}
	G0 Z10
	BED_MESH_CALIBRATE PROFILE={profile} METHOD=rapid_scan
	G0 Z10
	
	{% else %}
	BED_MESH_CALIBRATE PROFILE={profile}
	{% endif %}
	
	_Z_PARK
	
	{% if start_vars.neopixel_led == True %}
	STATUS_READY
	{% endif %}
	
	TURN_OFF_HEATERS
	M117

[gcode_macro AUTO_BED_MESH_BUILDER]
description = Fully automated 5 mesh builder. Choose which meshes to build, if no values set defaults will used or settings in demon_user_settings! If chamber fan/sensor enabled macro uses TEMPERATURE_WAIT not timers. Compatible with Eddy Probe!
gcode = 
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	{% set mesh_vars = printer["gcode_macro _MESH_BUILDER_VARIABLES"] %}
	{% set x_park = printer.toolhead.axis_maximum.x|float / 2 %}
	{% set y_park = printer.toolhead.axis_maximum.y|float / 2 %}
	{% set build_pla = params.BUILD_PLA|default('Yes')|string %}
	{% set build_tpu = params.BUILD_TPU|default('Yes')|string %}
	{% set build_petg = params.BUILD_PETG|default('Yes')|string %}
	{% set build_asa = params.BUILD_ASA|default('Yes')|string %}
	{% set build_abs = params.BUILD_ABS|default('Yes')|string %}
	{% set nosoak = params.SKIP_HEATSOAK_WAITS|default('No')|string %}
	{% set lotimer = params.LOW_TEMP_TIMER|default(0)|int %}
	{% set hitimer = params.HI_TEMP_TIMER|default(0)|int %}
	{% set lothreshold = params.LO_TEMP_THRESHOLD|default(22)|int %}
	{% set hithreshold = params.HI_TEMP_THRESHOLD|default(42)|int %}
	{% set bedfans = params.USE_BED_FANS|default('No')|string %}
	
	
	
	_CHAMBER_SENSOR_DEFINE
	
	{% if bedfans|lower in ['yes', 'true'] and start_vars.bed_fans == True %}
	
	SET_GCODE_VARIABLE MACRO=_MESH_BUILDER_VARIABLES VARIABLE=use_bed_fans VALUE=True
	SET_GCODE_VARIABLE MACRO=_BED_FAN_VARS VARIABLE=enable VALUE=True
	RESPOND TYPE=COMMAND MSG="Use bed fans: True"
	
	{% elif bedfans|lower in ['yes', 'true'] and start_vars.bed_fans == False %}
	RESPOND TYPE=error MSG="Sorry no bed fans in the system to enable"
	
	{% elif bedfans|lower in ['no', 'false'] and start_vars.bed_fans == True %}
	SET_GCODE_VARIABLE MACRO=_MESH_BUILDER_VARIABLES VARIABLE=use_bed_fans VALUE=False
	RESPOND TYPE=COMMAND MSG="Use bed fans: False"
	
	{% elif bedfans|lower in ['no', 'false'] and start_vars.bed_fans == False %}
	SET_GCODE_VARIABLE MACRO=_MESH_BUILDER_VARIABLES VARIABLE=use_bed_fans VALUE=False
	RESPOND TYPE=COMMAND MSG="Use bed fans: False - no fans available!"
	
	{% else %}
	RESPOND TYPE=error MSG="Mesh Builder. Use bed fans, user input not recognised! Please use yes/no or true/false"
	
	{% endif %}
	
	{% if start_vars.chamber_fan == False and start_vars.chamber_sensor == False %}
	{% if 'LOW_TEMP_TIMER' not in params and 'HI_TEMP_TIMER' not in params %}
	RESPOND TYPE=error MSG="Mesh Builder. No macro button heatsoak timers set, using saved file values. See demon_user_settings"
	{% endif %}
	
	{% if 'LOW_TEMP_TIMER' in params %}
	{% if lotimer <= 0 %}
	RESPOND TYPE=COMMAND MSG="Mesh heatsoak timer cannot be 0, value of 1 or higher can be accepted. Timer set for 1 minute."
	SET_GCODE_VARIABLE MACRO=_MESH_BUILDER_VARIABLES VARIABLE=mesh_lo_temp_timer VALUE=1
	
	{% elif lotimer >= 1 %}
	RESPOND TYPE=COMMAND MSG="Mesh heatsoak. Low temp timer set to {lotimer|int} minutes"
	SET_GCODE_VARIABLE MACRO=_MESH_BUILDER_VARIABLES VARIABLE=mesh_lo_temp_timer VALUE={'LOW_TEMP_TIMER'|int}
	{% endif %}
	
	{% else %}
	{% endif %}
	
	{% if 'HI_TEMP_TIMER' in params %}
	{% if hitimer <= 0 %}
	RESPOND TYPE=COMMAND MSG="Mesh heatsoak timer cannot be 0, value of 1 or higher can be accepted. Timer set for 1 minute."
	SET_GCODE_VARIABLE MACRO=_MESH_BUILDER_VARIABLES VARIABLE=mesh_hi_temp_timer VALUE=1
	
	{% elif hitimer >= 1 %}
	RESPOND TYPE=COMMAND MSG="Mesh heatsoak. High temp timer set to {hitimer|int} minutes"
	SET_GCODE_VARIABLE MACRO=_MESH_BUILDER_VARIABLES VARIABLE=mesh_hi_temp_timer VALUE={hitimer|int}
	{% endif %}
	
	{% else %}
	{% endif %}
	
	{% elif start_vars.chamber_fan == True or start_vars.chamber_sensor == True %}
	RESPOND TYPE=error MSG="Mesh Builder. Chamber fan/sensor detected, using TEMPERATURE_WAIT instead of the timers!"
	
	{% if 'LO_TEMP_THRESHOLD' not in params and 'HI_TEMP_THRESHOLD' not in params %}
	RESPOND TYPE=error MSG="Mesh Builder. No macro button thresholds set, using saved file values. See demon_user_settings"
	{% endif %}
	
	{% if 'LO_TEMP_THRESHOLD' in params %}
	{% if lothreshold in range (15, 41) %}
	RESPOND TYPE=COMMAND MSG="Mesh Builder. Low temp chamber thershold set to {lothreshold|int}c"
	SET_GCODE_VARIABLE MACRO=_MESH_BUILDER_VARIABLES VARIABLE=lo_heat_soak_threshold VALUE={lothreshold|int}
	
	{% else %}
	RESPOND TYPE=error MSG="Mesh Builder. Low temp threshold outside of accepted range, values of 15-40c can be accepted. Low threshold set to saved value"
	{% endif %}
	{% endif %}
	
	{% if 'HI_TEMP_THRESHOLD' in params %}
	{% if hithreshold in range (40, 70) %}
	RESPOND TYPE=COMMAND MSG="Mesh Builder. HIGH temp chamber thershold set to {hithreshold|int}c"
	SET_GCODE_VARIABLE MACRO=_MESH_BUILDER_VARIABLES VARIABLE=hi_heat_soak_threshold VALUE={hithreshold|int}
	
	{% else %}
	RESPOND TYPE=error MSG="Mesh Builder. High temp threshold outside of accepted range, values of 40-70c can be accepted. High threshold set to saved value"
	{% endif %}
	{% endif %}
	
	{% endif %}
	
	{% if build_tpu|lower not in ['yes', 'true'] and build_pla|lower not in ['yes', 'true'] and build_petg|lower not in ['yes', 'true'] and build_asa|lower not in ['yes',
	'true'] and build_abs|lower not in ['yes', 'true'] %}
	{ action_raise_error("No mesh specified, operation cancelled") }
	{% endif %}
	
	
	{% if start_vars.printer_lights == True %}
	{% if printer["Printer_Lights"] != start_vars.printer_lights_print %}
	SET_PIN PIN=Printer_Lights VALUE={start_vars.printer_lights_print}
	{% endif %}
	{% endif %}
	
	SET_DISPLAY_TEXT MSG="Building Bed Meshes PLEASE WAIT...."
	RESPOND TYPE=echo MSG="NOTE: THIS IS A LONG MACRO! IT BUILDS 5 FULL MESHES! DO NOT PRESS SAVE CONFIG! THIS MACRO AUTO SAVES WHEN COMPLETE!! BUILDING WILL START SOON PLEASE WAIT..."
	G4 P20000
	G90
	M83
	SET_GCODE_OFFSET Z=0.0
	BED_MESH_CLEAR
	
	{% if start_vars.neopixel_led == True %}
	STATUS_HEATING
	{% endif %}
	
	{% if printer.configfile.settings.stepper_z.endstop_pin != 'probe:z_virtual_endstop' %}
	SET_HEATER_TEMPERATURE HEATER=extruder TARGET={start_vars.pla_noz_pre}
	TEMPERATURE_WAIT SENSOR=extruder MINIMUM={start_vars.pla_noz_pre|float -5} MAXIMUM={start_vars.pla_noz_pre|float + 5}
	
	{% else %}
	SET_HEATER_TEMPERATURE HEATER=extruder TARGET=90
	
	{% endif %}
	
	_CONDITIONAL_HOME
	
	
	
	{% if build_tpu|lower in ['yes', 'true'] %}
	RESPOND TYPE=COMMAND MSG="Building TPU mesh"
	SET_GCODE_VARIABLE MACRO=_CORE_VARS VARIABLE=filament VALUE='"TPU"'
	_Z_PARK
	{% if start_vars.neopixel_led == True %}
	STATUS_HEATING
	{% endif %}
	
	SET_DISPLAY_TEXT MSG="Waiting For TPU Mesh Bed Temp: {mesh_vars.mesh_tpu_bed_temp}c"
	RESPOND TYPE=echo MSG="Waiting For TPU Mesh Bed Temp: {mesh_vars.mesh_tpu_bed_temp}c"
	SET_HEATER_TEMPERATURE HEATER=heater_bed TARGET={mesh_vars.mesh_tpu_bed_temp}
	TEMPERATURE_WAIT SENSOR=heater_bed MINIMUM={mesh_vars.mesh_tpu_bed_temp|float -2} MAXIMUM={mesh_vars.mesh_tpu_bed_temp|float + 5}
	
	{% if nosoak|lower in ['yes', 'true'] %}
	RESPOND TYPE=error MSG="HEATSAOK SKIPPED this may lead to a less accurate mesh!"
	
	{% elif nosoak|lower in ['no', 'false'] %}
	_WAIT_HANDLING_LOW_TEMP
	
	{% else %}
	RESPOND TYPE=error MSG="Mesh heatsoak. User input not recognised! Running heatsoak. Please use yes/no or true/false"
	_WAIT_HANDLING_LOW_TEMP
	{% endif %}
	
	_PRE_MESH_LEVEL
	{% if start_vars.neopixel_led == True %}
	STATUS_MESHING
	{% endif %}
	
	SET_DISPLAY_TEXT MSG="TPU MESH BUILDING PLEASE WAIT"
	RESPOND TYPE=echo MSG="TPU MESH BUILDING PLEASE WAIT"
	G4 P5000
	
	{% if 'mcu eddy' in printer.configfile.config or 'probe_eddy_current btt_eddy' in printer %}
	BED_MESH_CALIBRATE PROFILE=TPU METHOD=rapid_scan
	{% else %}
	BED_MESH_CALIBRATE PROFILE=TPU
	{% endif %}
	
	SET_DISPLAY_TEXT MSG="DO NOT SAVE CONFIG - MACRO IS STILL RUNNING!"
	RESPOND TYPE=echo MSG="DO NOT SAVE CONFIG - MACRO IS STILL RUNNING!"
	G4 P10000
	
	{% elif build_tpu|lower in ['no', 'false'] %}
	RESPOND TYPE=COMMAND MSG="TPU mesh building skipped"
	
	{% else %}
	RESPOND TYPE=error MSG="TPU Mesh. User input not recognised! Please use yes/no or true/false"
	{% endif %}
	
	
	
	{% if build_pla|lower in ['yes', 'true'] %}
	RESPOND TYPE=COMMAND MSG="Building PLA mesh"
	SET_GCODE_VARIABLE MACRO=_CORE_VARS VARIABLE=filament VALUE='"PLA"'
	_Z_PARK
	{% if start_vars.neopixel_led == True %}
	STATUS_HEATING
	{% endif %}
	
	SET_DISPLAY_TEXT MSG="Waiting For PLA Mesh Bed Temp: {mesh_vars.mesh_pla_bed_temp}c"
	RESPOND TYPE=echo MSG="Waiting For PLA Mesh Bed Temp: {mesh_vars.mesh_pla_bed_temp}c"
	SET_HEATER_TEMPERATURE HEATER=heater_bed TARGET={mesh_vars.mesh_pla_bed_temp}
	TEMPERATURE_WAIT SENSOR=heater_bed MINIMUM={mesh_vars.mesh_pla_bed_temp|float -2} MAXIMUM={mesh_vars.mesh_pla_bed_temp|float + 5}
	
	{% if nosoak|lower in ['yes', 'true'] %}
	RESPOND TYPE=error MSG="HEATSAOK SKIPPED this may lead to a less accurate mesh!"
	
	{% elif nosoak|lower in ['no', 'false'] %}
	_WAIT_HANDLING_LOW_TEMP
	
	{% else %}
	RESPOND TYPE=error MSG="Mesh heatsoak. User input not recognised! Running heatsoak. Please use yes/no or true/false"
	_WAIT_HANDLING_LOW_TEMP
	{% endif %}
	
	_PRE_MESH_LEVEL
	{% if start_vars.neopixel_led == True %}
	STATUS_MESHING
	{% endif %}
	
	SET_DISPLAY_TEXT MSG="PLA MESH BUILDING PLEASE WAIT"
	RESPOND TYPE=echo MSG="PLA MESH BUILDING PLEASE WAIT"
	G4 P5000
	
	{% if 'mcu eddy' in printer.configfile.config or 'probe_eddy_current btt_eddy' in printer %}
	BED_MESH_CALIBRATE PROFILE=default METHOD=rapid_scan
	{% else %}
	BED_MESH_CALIBRATE PROFILE=default
	{% endif %}
	
	SET_DISPLAY_TEXT MSG="DO NOT SAVE CONFIG - MACRO IS STILL RUNNING!"
	RESPOND TYPE=echo MSG="DO NOT SAVE CONFIG - MACRO IS STILL RUNNING!"
	G4 P10000
	
	{% elif build_pla|lower in ['no', 'false'] %}
	RESPOND TYPE=COMMAND MSG="PLA mesh building skipped"
	
	{% else %}
	RESPOND TYPE=error MSG="PLA Mesh. User input not recognised! Please use yes/no or true/false"
	{% endif %}
	
	
	
	{% if build_petg|lower in ['yes', 'true'] %}
	RESPOND TYPE=COMMAND MSG="Building PETG mesh"
	SET_GCODE_VARIABLE MACRO=_CORE_VARS VARIABLE=filament VALUE='"PETG"'
	_Z_PARK
	{% if start_vars.neopixel_led == True %}
	STATUS_HEATING
	{% endif %}
	
	SET_DISPLAY_TEXT MSG="Waiting For PETG Mesh Bed Temp: {mesh_vars.mesh_petg_bed_temp}c"
	RESPOND TYPE=echo MSG="Waiting For PETG Mesh Bed Temp: {mesh_vars.mesh_petg_bed_temp}c"
	SET_HEATER_TEMPERATURE HEATER=heater_bed TARGET={mesh_vars.mesh_petg_bed_temp}
	TEMPERATURE_WAIT SENSOR=heater_bed MINIMUM={mesh_vars.mesh_petg_bed_temp|float -2} MAXIMUM={mesh_vars.mesh_petg_bed_temp|float + 5}
	
	{% if nosoak|lower in ['yes', 'true'] %}
	RESPOND TYPE=error MSG="HEATSAOK SKIPPED this may lead to a less accurate mesh!"
	
	{% elif nosoak|lower in ['no', 'false'] %}
	_WAIT_HANDLING_LOW_TEMP
	
	{% else %}
	RESPOND TYPE=error MSG="Mesh heatsoak. User input not recognised! Running heatsoak. Please use yes/no or true/false"
	_WAIT_HANDLING_LOW_TEMP
	{% endif %}
	
	_PRE_MESH_LEVEL
	{% if start_vars.neopixel_led == True %}
	STATUS_MESHING
	{% endif %}
	
	SET_DISPLAY_TEXT MSG="PETG MESH BUILDING PLEASE WAIT"
	RESPOND TYPE=echo MSG="PETG MESH BUILDING PLEASE WAIT"
	G4 P5000
	
	{% if 'mcu eddy' in printer.configfile.config or 'probe_eddy_current btt_eddy' in printer %}
	BED_MESH_CALIBRATE PROFILE=PETG METHOD=rapid_scan
	{% else %}
	BED_MESH_CALIBRATE PROFILE=PETG
	{% endif %}
	
	SET_DISPLAY_TEXT MSG="DO NOT SAVE CONFIG - MACRO IS STILL RUNNING!"
	RESPOND TYPE=echo MSG="DO NOT SAVE CONFIG - MACRO IS STILL RUNNING!"
	G4 P10000
	
	{% elif build_petg|lower in ['no', 'false'] %}
	RESPOND TYPE=COMMAND MSG="PETG mesh building skipped"
	
	{% else %}
	RESPOND TYPE=error MSG="PETG Mesh. User input not recognised! Please use yes/no or true/false"
	{% endif %}
	
	
	
	{% if build_asa|lower in ['yes', 'true'] %}
	RESPOND TYPE=COMMAND MSG="Building ASA mesh"
	SET_GCODE_VARIABLE MACRO=_CORE_VARS VARIABLE=filament VALUE='"ASA"'
	_Z_PARK
	{% if start_vars.neopixel_led == True %}
	STATUS_HEATING
	{% endif %}
	
	SET_DISPLAY_TEXT MSG="Waiting For ASA Mesh Bed Temp: {mesh_vars.mesh_asa_bed_temp}c"
	RESPOND TYPE=echo MSG="Waiting For ASA Mesh Bed Temp: {mesh_vars.mesh_asa_bed_temp}c"
	SET_HEATER_TEMPERATURE HEATER=heater_bed TARGET={mesh_vars.mesh_asa_bed_temp}
	TEMPERATURE_WAIT SENSOR=heater_bed MINIMUM={mesh_vars.mesh_asa_bed_temp|float -2} MAXIMUM={mesh_vars.mesh_asa_bed_temp|float + 5}
	
	{% if nosoak|lower in ['yes', 'true'] %}
	RESPOND TYPE=error MSG="HEATSAOK SKIPPED this may lead to a less accurate mesh!"
	
	{% elif nosoak|lower in ['no', 'false'] %}
	_WAIT_HANDLING_HIGH_TEMP
	
	{% else %}
	RESPOND TYPE=error MSG="Mesh heatsoak. User input not recognised! Running heatsoak. Please use yes/no or true/false"
	_WAIT_HANDLING_HIGH_TEMP
	{% endif %}
	
	_PRE_MESH_LEVEL
	{% if start_vars.neopixel_led == True %}
	STATUS_MESHING
	{% endif %}
	
	SET_DISPLAY_TEXT MSG="ASA MESH BUILDING PLEASE WAIT"
	RESPOND TYPE=echo MSG="ASA MESH BUILDING PLEASE WAIT"
	G4 P5000
	
	{% if 'mcu eddy' in printer.configfile.config or 'probe_eddy_current btt_eddy' in printer %}
	BED_MESH_CALIBRATE PROFILE=ASA METHOD=rapid_scan
	{% else %}
	BED_MESH_CALIBRATE PROFILE=ASA
	{% endif %}
	
	SET_DISPLAY_TEXT MSG="DO NOT SAVE CONFIG - MACRO IS STILL RUNNING!"
	RESPOND TYPE=echo MSG="DO NOT SAVE CONFIG - MACRO IS STILL RUNNING!"
	G4 P10000
	
	{% elif build_asa|lower in ['no', 'false'] %}
	RESPOND TYPE=COMMAND MSG="ASA mesh building skipped"
	
	{% else %}
	RESPOND TYPE=error MSG="ASA Mesh. User input not recognised! Please use yes/no or true/false"
	{% endif %}
	
	
	
	{% if build_abs|lower in ['yes', 'true'] %}
	RESPOND TYPE=COMMAND MSG="Building ABS mesh"
	SET_GCODE_VARIABLE MACRO=_CORE_VARS VARIABLE=filament VALUE='"ABS"'
	_Z_PARK
	{% if start_vars.neopixel_led == True %}
	STATUS_HEATING
	{% endif %}
	
	SET_DISPLAY_TEXT MSG="Waiting For ABS Mesh Bed Temp: {mesh_vars.mesh_abs_bed_temp}c"
	RESPOND TYPE=echo MSG="Waiting For ABS Mesh Bed Temp: {mesh_vars.mesh_abs_bed_temp}c"
	SET_HEATER_TEMPERATURE HEATER=heater_bed TARGET={mesh_vars.mesh_abs_bed_temp}
	TEMPERATURE_WAIT SENSOR=heater_bed MINIMUM={mesh_vars.mesh_abs_bed_temp|float -2} MAXIMUM={mesh_vars.mesh_abs_bed_temp|float + 5}
	
	{% if nosoak|lower in ['yes', 'true'] %}
	RESPOND TYPE=error MSG="HEATSAOK SKIPPED this may lead to a less accurate mesh!"
	
	{% elif nosoak|lower in ['no', 'false'] %}
	_WAIT_HANDLING_HIGH_TEMP
	
	{% else %}
	RESPOND TYPE=error MSG="Mesh heatsoak. User input not recognised! Running heatsoak. Please use yes/no or true/false"
	_WAIT_HANDLING_HIGH_TEMP
	{% endif %}
	
	_PRE_MESH_LEVEL
	{% if start_vars.neopixel_led == True %}
	STATUS_MESHING
	{% endif %}
	
	SET_DISPLAY_TEXT MSG="ABS MESH BUILDING PLEASE WAIT"
	RESPOND TYPE=echo MSG="ABS MESH BUILDING PLEASE WAIT"
	G4 P5000
	
	{% if 'mcu eddy' in printer.configfile.config or 'probe_eddy_current btt_eddy' in printer %}
	BED_MESH_CALIBRATE PROFILE=ABS METHOD=rapid_scan
	{% else %}
	BED_MESH_CALIBRATE PROFILE=ABS
	{% endif %}
	
	{% elif build_abs|lower in ['no', 'false'] %}
	RESPOND TYPE=COMMAND MSG="ABS mesh building skipped"
	
	{% else %}
	RESPOND TYPE=error MSG="ABS Mesh. User input not recognised! Please use yes/no or true/false"
	{% endif %}
	
	
	
	SET_DISPLAY_TEXT MSG="PARKING TOOLHEAD PLEASE WAIT..."
	RESPOND TYPE=echo MSG="PARKING TOOLHEAD PLEASE WAIT..."
	G4 P10000
	_Z_PARK
	M104 S0
	M140 S0
	M84 X Y E
	M400
	SET_DISPLAY_TEXT MSG="ALL BED MESHES BUILT. MACRO COMPLETE!"
	RESPOND TYPE=echo MSG="ALL BED MESHES BUILT. MACRO COMPLETE!"
	
	{% if mesh_vars.use_bed_fans == True %}
	SET_FAN_SPEED FAN=Bed_Fans SPEED=0
	{% endif %}
	
	
	{% if start_vars.chamber_fan == True %}
	SET_TEMPERATURE_FAN_TARGET temperature_fan="chamber" target={start_vars.post_print_cool}
	{% endif %}
	
	{% if start_vars.printer_lights == True %}
	{% if printer["Printer_Lights"] != start_vars.printer_lights_finish %}
	SET_PIN PIN=Printer_Lights VALUE={start_vars.printer_lights_finish}
	{% if start_vars.neopixel_led == True and start_vars.neopixel_off == True %}
	STATUS_OFF
	{% endif %}
	
	{% endif %}
	{% endif %}
	
	M400
	G4 P5000
	SET_DISPLAY_TEXT MSG="SAVING CONFIG PLEASE WAIT..."
	RESPOND TYPE=echo MSG="SAVING CONFIG PLEASE WAIT..."
	G4 P5000
	SAVE_CONFIG

[gcode_macro _WAIT_HANDLING_LOW_TEMP]
gcode = 
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	{% set mesh_vars = printer["gcode_macro _MESH_BUILDER_VARIABLES"] %}
	{% if start_vars.chamber_fan == True %}
	{% if printer["temperature_fan chamber"].temperature <mesh_vars.lo_heat_soak_threshold %}
	{% if start_vars.chamber_temp_wait == True %}
	{% if mesh_vars.use_bed_fans == True %}
	_BED_FANS_SETUP
	M400
	_BED_FAN_SET
	{% endif %}
	SET_DISPLAY_TEXT MSG="Waiting For Chamber Temp: {mesh_vars.lo_heat_soak_threshold}c"
	RESPOND TYPE=echo MSG="Waiting For Chamber Temp: {mesh_vars.lo_heat_soak_threshold}c"
	TEMPERATURE_WAIT SENSOR="temperature_fan chamber" MINIMUM={mesh_vars.lo_heat_soak_threshold|float}
	{% else %}
	_HEAT_WAIT MINUTES={mesh_vars.mesh_lo_temp_timer}
	{% endif %}
	
	{% else %}
	M117 Already up to temp, heat soak skipped
	G4 P5000
	{% endif %}
	
	{% elif start_vars.chamber_sensor == True %}
	{% if printer["temperature_sensor Chamber_Temp"].temperature <mesh_vars.lo_heat_soak_threshold %}
	{% if start_vars.chamber_temp_wait == True %}
	{% if mesh_vars.use_bed_fans == True %}
	_BED_FANS_SETUP
	M400
	_BED_FAN_SET
	{% endif %}
	SET_DISPLAY_TEXT MSG="Waiting For Chamber Temp: {mesh_vars.lo_heat_soak_threshold}c"
	RESPOND TYPE=echo MSG="Waiting For Chamber Temp: {mesh_vars.lo_heat_soak_threshold}c"
	TEMPERATURE_WAIT SENSOR="temperature_sensor Chamber_Temp" MINIMUM={mesh_vars.lo_heat_soak_threshold|float}
	{% else %}
	_HEAT_WAIT MINUTES={mesh_vars.mesh_lo_temp_timer}
	{% endif %}
	
	{% else %}
	M117 Already up to temp, heat soak skipped
	G4 P5000
	{% endif %}
	
	{% else %}
	_HEAT_WAIT MINUTES={mesh_vars.mesh_lo_temp_timer}
	
	{% endif %}
	
	{% if mesh_vars.use_bed_fans == True %}
	SET_FAN_SPEED FAN=Bed_Fans SPEED=0
	{% endif %}

[gcode_macro _WAIT_HANDLING_HIGH_TEMP]
gcode = 
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	{% set mesh_vars = printer["gcode_macro _MESH_BUILDER_VARIABLES"] %}
	{% if start_vars.chamber_fan == True %}
	{% if printer["temperature_fan chamber"].temperature <mesh_vars.hi_heat_soak_threshold %}
	{% if start_vars.chamber_temp_wait == True %}
	{% if mesh_vars.use_bed_fans == True %}
	M118 bed fans anyone?
	_BED_FANS_SETUP
	M400
	_BED_FAN_SET
	{% endif %}
	SET_DISPLAY_TEXT MSG="Waiting For Chamber Temp: {mesh_vars.hi_heat_soak_threshold}c"
	RESPOND TYPE=echo MSG="Waiting For Chamber Temp: {mesh_vars.hi_heat_soak_threshold}c"
	TEMPERATURE_WAIT SENSOR="temperature_fan chamber" MINIMUM={mesh_vars.hi_heat_soak_threshold|float -2}
	{% else %}
	_HEAT_WAIT MINUTES={mesh_vars.mesh_hi_temp_timer}
	{% endif %}
	
	{% else %}
	SET_DISPLAY_TEXT MSG="Already up to temp, heat soak skipped"
	RESPOND TYPE=COMMAND MSG="Already up to temp, heat soak skipped"
	G4 P5000
	{% endif %}
	
	{% elif start_vars.chamber_sensor == True %}
	{% if printer["temperature_sensor Chamber_Temp"].temperature <mesh_vars.hi_heat_soak_threshold %}
	{% if start_vars.chamber_temp_wait == True %}
	{% if mesh_vars.use_bed_fans == True %}
	_BED_FANS_SETUP
	M400
	_BED_FAN_SET
	
	{% endif %}
	SET_DISPLAY_TEXT MSG="Waiting For Chamber Temp: {mesh_vars.hi_heat_soak_threshold}c"
	RESPOND TYPE=echo MSG="Waiting For Chamber Temp: {mesh_vars.hi_heat_soak_threshold}c"
	TEMPERATURE_WAIT SENSOR="temperature_sensor Chamber_Temp" MINIMUM={mesh_vars.hi_heat_soak_threshold|float -2}
	{% else %}
	_HEAT_WAIT MINUTES={mesh_vars.mesh_hi_temp_timer}
	{% endif %}
	
	{% else %}
	SET_DISPLAY_TEXT MSG="Already up to temp, heat soak skipped"
	RESPOND TYPE=COMMAND MSG="Already up to temp, heat soak skipped"
	G4 P5000
	{% endif %}
	
	{% else %}
	_HEAT_WAIT MINUTES={mesh_vars.mesh_hi_temp_timer}
	
	{% endif %}
	
	{% if mesh_vars.use_bed_fans == True %}
	SET_FAN_SPEED FAN=Bed_Fans SPEED=0
	{% endif %}

[gcode_macro _PRE_MESH_LEVEL]
gcode = 
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	_CONDITIONAL_CLEAN
	{% if start_vars.neopixel_led == True %}
	STATUS_LEVELING
	{% endif %}
	
	G28 Z
	
	_ADAPTIVE_LEVELLING
	_CONDITIONAL_CLEAN
	G28 Z

[gcode_macro _MESH_BUILDER_VERSION]
variable_demon_mesh_builder = "1.5.1"
gcode = 

[gcode_macro Ready_UP_PLA]
description = Ready the printer for printing PLA
gcode = 
	{% set clean_vars = printer["gcode_macro _CLEAN_VARIABLES"] %}
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	
	{% if printer.print_stats.state != "standby" %}
	RESPOND TYPE=error MSG="Request denied, current printer state not Standby"
	
	{% else %}
	{% if start_vars.neopixel_led == True %}
	STATUS_HEATING
	{% endif %}
	
	{% if start_vars.chamber_fan == True or start_vars.chamber_sensor == True %}
	SET_TEMPERATURE_FAN_TARGET TEMPERATURE_FAN=chamber TARGET=28
	{% endif %}
	
	SET_HEATER_TEMPERATURE HEATER=heater_bed TARGET={clean_vars.ready_up_pla_bed}
	M109 S{clean_vars.ready_up_pla_noz}
	_CONDITIONAL_HOME
	
	_CONDITIONAL_CLEAN
	{% endif %}

[gcode_macro Ready_UP_ASA]
description = Ready the printer for printing ASA
gcode = 
	{% set clean_vars = printer["gcode_macro _CLEAN_VARIABLES"] %}
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	
	{% if printer.print_stats.state != "standby" %}
	RESPOND TYPE=error MSG="Request denied, current printer state not Standby"
	
	{% else %}
	{% if start_vars.neopixel_led == True %}
	STATUS_HEATING
	{% endif %}
	
	{% if start_vars.chamber_fan == True or start_vars.chamber_sensor == True %}
	SET_TEMPERATURE_FAN_TARGET TEMPERATURE_FAN=chamber TARGET=55
	{% endif %}
	
	SET_HEATER_TEMPERATURE HEATER=heater_bed TARGET={clean_vars.ready_up_asa_bed}
	M109 S{clean_vars.ready_up_asa_noz}
	_CONDITIONAL_HOME
	
	_CONDITIONAL_CLEAN
	{% endif %}

[gcode_macro Ready_UP_PETG]
description = Ready the printer for printing PETG
gcode = 
	{% set clean_vars = printer["gcode_macro _CLEAN_VARIABLES"] %}
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	
	{% if printer.print_stats.state != "standby" %}
	RESPOND TYPE=error MSG="Request denied, current printer state not Standby"
	
	{% else %}
	{% if start_vars.neopixel_led == True %}
	STATUS_HEATING
	{% endif %}
	
	{% if start_vars.chamber_fan == True or start_vars.chamber_sensor == True %}
	SET_TEMPERATURE_FAN_TARGET TEMPERATURE_FAN=chamber TARGET=28
	{% endif %}
	
	SET_HEATER_TEMPERATURE HEATER=heater_bed TARGET={clean_vars.ready_up_petg_bed}
	M109 S{clean_vars.ready_up_petg_noz}
	_CONDITIONAL_HOME
	
	_CONDITIONAL_CLEAN
	{% endif %}

[gcode_macro Ready_UP_TPU]
description = Ready the printer for printing TPU
gcode = 
	{% set clean_vars = printer["gcode_macro _CLEAN_VARIABLES"] %}
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	
	{% if printer.print_stats.state != "standby" %}
	RESPOND TYPE=error MSG="Request denied, current printer state not Standby"
	
	{% else %}
	{% if start_vars.neopixel_led == True %}
	STATUS_HEATING
	{% endif %}
	
	{% if start_vars.chamber_fan == True or start_vars.chamber_sensor == True %}
	SET_TEMPERATURE_FAN_TARGET TEMPERATURE_FAN=chamber TARGET=28
	{% endif %}
	
	SET_HEATER_TEMPERATURE HEATER=heater_bed TARGET={clean_vars.ready_up_tpu_bed}
	M109 S{clean_vars.ready_up_tpu_noz}
	_CONDITIONAL_HOME
	
	_CONDITIONAL_CLEAN
	{% endif %}

[gcode_macro Ready_UP_CUSTOM]
description = Ready the printer for printing with your settings
gcode = 
	{% set clean_vars = printer["gcode_macro _CLEAN_VARIABLES"] %}
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	{% set noz = params.NOZZLE|default(160)|int %}
	{% set bed = params.BED|default(60)|int %}
	{% set chamber = params.CHAMBER_FAN|default(50)|int %}
	{% set timeout = params.IDLE_TIMEOUT_MINUTES|default(60)|int %}
	{% set park = params.PARK_OVER_BED|default('Yes')|string %}
	
	{% if printer.print_stats.state != "standby" %}
	RESPOND TYPE=error MSG="Request denied, current printer state not Standby"
	
	{% else %}
	{% if start_vars.neopixel_led == True %}
	STATUS_HEATING
	{% endif %}
	
	SET_IDLE_TIMEOUT TIMEOUT={timeout * 60}
	
	{% if start_vars.chamber_fan == True or start_vars.chamber_sensor == True %}
	SET_TEMPERATURE_FAN_TARGET TEMPERATURE_FAN=chamber TARGET={chamber}
	{% endif %}
	
	SET_HEATER_TEMPERATURE HEATER=heater_bed TARGET={bed}
	M109 S{noz}
	_CONDITIONAL_HOME
	
	_CONDITIONAL_CLEAN
	
	{% if park|lower in ['yes', 'true'] %}
	_Z_PARK
	{% endif %}
	
	{% endif %}

[gcode_macro HEATSOAK_TOGGLE]
description = Toggle the PRINT_START Heatsoaks on & off with each click of this button! State must be set BEFORE you start a print!
gcode = 
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	
	{% if start_vars.start_my_print_already == False %}
	RESPOND TYPE=error MSG="PRINT_START HEATSOAKS WILL NOW BE SKIPPED!"
	SET_GCODE_VARIABLE MACRO=_START_VARIABLES VARIABLE=start_my_print_already VALUE=True
	
	{% elif start_vars.start_my_print_already == True %}
	RESPOND TYPE=error MSG="PRINT_START HEATSOAKS ARE NOW ACTIVE!"
	SET_GCODE_VARIABLE MACRO=_START_VARIABLES VARIABLE=start_my_print_already VALUE=False
	{% endif %}

[gcode_macro PRESENT_TOOLHEAD]
description = Moves the toolhead to a position for easy access & maintance
gcode = 
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	{% set x_present = printer.toolhead.axis_maximum.x|float / 2 %}
	{% set y_present = printer.toolhead.axis_minimum.y|float + 25 %}
	{% set z_present = printer.toolhead.axis_maximum.z|float / 2 %}
	
	{% if printer.print_stats.state != "standby" %}
	RESPOND TYPE=error MSG="Present Toolhead request denied, current printer state not Standby"
	
	{% else %}
	_CONDITIONAL_HOME
	{% if start_vars.present_use_default == True %}
	G0 X{x_present} Y{y_present} Z{z_present} F{start_vars.present_speed * 60}
	{% else %}
	{% if start_vars.present_toolhead_z|float < printer.toolhead.axis_maximum.z|float - 35 and
	start_vars.present_toolhead_z|float > printer.toolhead.axis_minimum.z|float + 5 %}
	G0 X{start_vars.present_toolhead_x} Y{start_vars.present_toolhead_y} Z{start_vars.present_toolhead_z} F{start_vars.present_speed * 60}
	
	{% else %}
	RESPOND TYPE=error MSG="Present Toolhead request denied, present_toolhead_z variable set not in accepted range. Please set above 5mm & 35mm less than max Z in the demon_user_settings file."
	{% endif %}
	
	{% endif %}
	
	{% if start_vars.neopixel_led == True %}
	STATUS_READY
	{% endif %}
	
	_SAVE
	
	{% endif %}

[gcode_macro STOW_TOOLHEAD]
description = Stows the toolhead back to a parking position. Uses the clean_vars.park_x/y/z variables in the demon_user_settings file!
gcode = 
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	
	{% if printer.print_stats.state != "standby" %}
	RESPOND TYPE=error MSG="Stow Toolhead request denied, current printer state not Standby"
	
	{% else %}
	{% if start_vars.stow_toolhead_z in range (5, 51) %}
	_CONDITIONAL_HOME
	G0 X{start_vars.stow_toolhead_x|float} Y{start_vars.stow_toolhead_y|float} Z{start_vars.stow_toolhead_z|int} F{start_vars.stow_speed|int * 60}
	{% if start_vars.neopixel_led == True %}
	STATUS_READY
	{% endif %}
	
	_SAVE
	
	{% else %}
	RESPOND TYPE=error MSG="Stow Toolhead request denied, stow_toolhead_z variable not in accepted range. Please set between 5-50mm in the demon_user_settings file."
	{% endif %}
	
	{% endif %}

[gcode_macro _PREPARE_MENU_VERSION]
variable_demon_prepare_menu = "1.2.0"
gcode = 

[gcode_macro PRINT_START]
gcode = 
	
	{% set first_layer_bed = params.BED|int %}
	{% set first_layer_extruder = params.EXTRUDER|float %}
	{% set layer_height = params.LAYER|default(0.2)|float %}
	{% set filament_type = params.FILAMENT|default('PLA')|string %}
	{% set exclude_object = params.EXCLUDE|default(0)|int %}
	{% set oapa = params.OAPA|default(0)|int %}
	{% set surface = params.SURFACE|default('High Temp Plate')|string %}
	
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	{% set ceal = printer["gcode_macro CUSTOM_EXPANSION_ACTIVE_LIST"] %}
	
	
	
	_DEMON_VERSION
	
	{% if ceal.ceal_master_enable == True %}
	{% if ceal.pre_start == True %}
	_CUSTOM_PRE_START {rawparams}
	{% endif %}
	{% endif %}
	
	{% if start_vars.orca_enable == True %}
	SET_GCODE_VARIABLE MACRO=_APA_VARS VARIABLE=fil_type VALUE='"{filament_type}"'
	SET_GCODE_VARIABLE MACRO=_APA_VARS VARIABLE=oapa VALUE={oapa}
	
	_APA_SET
	{% endif %}
	
	SET_GCODE_VARIABLE MACRO=_CORE_VARS VARIABLE=filament VALUE='"{filament_type}"'
	SET_GCODE_VARIABLE MACRO=_CORE_VARS VARIABLE=layer VALUE='"{layer_height}"'
	SET_GCODE_VARIABLE MACRO=_CORE_VARS VARIABLE=bed VALUE='"{first_layer_bed}"'
	
	{% if filament_type not in ['PLA', 'PLA+'] %}
	SET_GCODE_VARIABLE MACRO=_CORE_VARS VARIABLE=offset_reset VALUE=True
	{% endif %}
	
	{% if start_vars.orca_enable == True %}
	{% if start_vars.adaptive_meshing == True and exclude_object != 1%}
	{action_raise_error("This error is caused by the sliced file not having LABEL_OBJECT enabled or by your slicer's start Gcode not being setup correclty! Please disable Adaptive_Meshing in the demon_user_settings.cfg or re-slice the file with it enabled or your start Gcode corrected and restart the print!")}
	{% endif %}
	{% endif %}
	
	{% if start_vars.printer_lights == True %}
	{% if printer["Printer_Lights"] != start_vars.printer_lights_print %}
	SET_PIN PIN=Printer_Lights VALUE={start_vars.printer_lights_print}
	{% endif %}
	{% endif %}
	
	{% if start_vars.neopixel_led == True %}
	STATUS_BUSY
	{% endif %}
	
	
	
	G90
	M83
	M220 S100
	M221 S100
	SET_VELOCITY_LIMIT ACCEL={printer.configfile.config.printer.max_accel}
	SET_VELOCITY_LIMIT VELOCITY={printer.configfile.config.printer.max_velocity}
	{% if 'mcu eddy' not in printer and 'probe_eddy_current btt_eddy' not in printer %}
	SET_GCODE_OFFSET Z=0.0
	{% endif %}
	BED_MESH_CLEAR
	
	
	
	_INITIAL_SETUP
	_CHAMBER_SENSOR_DEFINE
	M400
	_CHAMBER_TEMPS_HELPER
	
	
	
	_RUNOUT_SENSOR_CHECK
	
	{% if start_vars.encoder_runout_sensor == True %}
	SET_FILAMENT_SENSOR SENSOR=encoder_sensor ENABLE=0
	UPDATE_DELAYED_GCODE ID=_ENCODER_RUNOUT_CONTROL DURATION=10
	{% endif %}
	
	
	
	{% if ceal.ceal_master_enable == True %}
	{% if ceal.pre_heating == True %}
	_CUSTOM_PRE_HEATING {rawparams}
	{% endif %}
	{% endif %}
	
	{% if start_vars.neopixel_led == True %}
	STATUS_HEATING
	{% endif %}
	
	SET_HEATER_TEMPERATURE HEATER=heater_bed TARGET={first_layer_bed}
	
	
	
	{% if filament_type in ['PLA', 'PLA+'] %}
	SET_DISPLAY_TEXT MSG="PLA File Detected Hotend Preheat: {start_vars.pla_noz_pre}c"
	RESPOND TYPE=COMMAND MSG="PLA File Detected Hotend Preheat: {start_vars.pla_noz_pre}c"
	SET_HEATER_TEMPERATURE HEATER=extruder TARGET={start_vars.pla_noz_pre}
	TEMPERATURE_WAIT SENSOR=extruder MINIMUM={start_vars.pla_noz_pre|float -2} MAXIMUM={start_vars.pla_noz_pre|float + 5}
	
	{% elif filament_type == 'ASA' %}
	SET_DISPLAY_TEXT MSG="ASA File Detected Hotend Preheat: {start_vars.asa_noz_pre}c"
	RESPOND TYPE=COMMAND MSG="ASA File Detected Hotend Preheat: {start_vars.asa_noz_pre}c"
	SET_HEATER_TEMPERATURE HEATER=extruder TARGET={start_vars.asa_noz_pre}
	TEMPERATURE_WAIT SENSOR=extruder MINIMUM={start_vars.asa_noz_pre|float -2} MAXIMUM={start_vars.asa_noz_pre|float + 5}
	
	{% elif filament_type == 'ABS' %}
	SET_DISPLAY_TEXT MSG="ABS File Detected Hotend Preheat: {start_vars.abs_noz_pre}c"
	RESPOND TYPE=COMMAND MSG="ABS File Detected Hotend Preheat: {start_vars.abs_noz_pre}c"
	SET_HEATER_TEMPERATURE HEATER=extruder TARGET={start_vars.abs_noz_pre}
	TEMPERATURE_WAIT SENSOR=extruder MINIMUM={start_vars.abs_noz_pre|float -2} MAXIMUM={start_vars.abs_noz_pre|float + 5}
	
	{% elif filament_type in ['PET', 'PETG'] %}
	SET_DISPLAY_TEXT MSG="PETG File Detected Hotend Preheat: {start_vars.petg_noz_pre}c"
	RESPOND TYPE=COMMAND MSG="PETG File Detected Hotend Preheat: {start_vars.petg_noz_pre}c"
	SET_HEATER_TEMPERATURE HEATER=extruder TARGET={start_vars.petg_noz_pre}
	TEMPERATURE_WAIT SENSOR=extruder MINIMUM={start_vars.petg_noz_pre|float -2} MAXIMUM={start_vars.petg_noz_pre|float + 5}
	
	{% elif filament_type in ['FLEX', 'TPU'] %}
	SET_DISPLAY_TEXT MSG="TPU File Detected Hotend Preheat: {start_vars.tpu_noz_pre}c"
	RESPOND TYPE=COMMAND MSG="TPU File Detected Hotend Preheat: {start_vars.tpu_noz_pre}c"
	SET_HEATER_TEMPERATURE HEATER=extruder TARGET={start_vars.tpu_noz_pre}
	TEMPERATURE_WAIT SENSOR=extruder MINIMUM={start_vars.tpu_noz_pre|float -2} MAXIMUM={start_vars.tpu_noz_pre|float + 5}
	
	{% elif not filament_type in ['PLA', 'PLA+', 'ASA', 'ABS', 'PET', 'PETG', 'FLEX', 'TPU'] %}
	{% if params.EXTRUDER|float <220 %}
	SET_DISPLAY_TEXT MSG="Hotend Preheat by file temp: {start_vars.default_lo_noz_pre}c"
	RESPOND TYPE=COMMAND MSG="Hotend Preheat by file temp: {start_vars.default_lo_noz_pre}c"
	SET_HEATER_TEMPERATURE HEATER=extruder TARGET={start_vars.default_lo_noz_pre}
	TEMPERATURE_WAIT SENSOR=extruder MINIMUM={start_vars.default_lo_noz_pre|float -2} MAXIMUM={start_vars.default_lo_noz_pre|float + 5}
	
	{% else %}
	SET_DISPLAY_TEXT MSG="Hotend Preheat by file temp: {start_vars.default_hi_noz_pre}c"
	RESPOND TYPE=COMMAND MSG="Hotend Preheat by file temp: {start_vars.default_hi_noz_pre}c"
	SET_HEATER_TEMPERATURE HEATER=extruder TARGET={start_vars.default_hi_noz_pre}
	TEMPERATURE_WAIT SENSOR=extruder MINIMUM={start_vars.default_hi_noz_pre|float -2} MAXIMUM={start_vars.default_hi_noz_pre|float + 5}
	{% endif %}
	{% endif %}
	
	M400
	
	
	
	{% if start_vars.chamber_heater == True %}
	_CHAMBER_HEATER_SETUP
	M400
	_CHAMBER_HEATER_READ
	_CHAMBER_HEATER_MONITOR
	UPDATE_DELAYED_GCODE ID=_CHAMBER_HEAT_CONTROL DURATION=1
	{% endif %}
	
	
	
	{% if start_vars.bed_fans == True %}
	_BED_FANS_SETUP
	M400
	_BED_FAN_SET
	{% endif %}
	
	
	
	{% if start_vars.nevermore == True %}
	
	{% if filament_type in ['PLA', 'PLA+'] %}
	SET_FAN_SPEED FAN=Nevermore SPEED={start_vars.pla_nevermore_start_speed}
	
	{% elif filament_type == 'ASA' %}
	SET_FAN_SPEED FAN=Nevermore SPEED={start_vars.asa_nevermore_start_speed}
	
	{% elif filament_type == 'ABS' %}
	SET_FAN_SPEED FAN=Nevermore SPEED={start_vars.abs_nevermore_start_speed}
	
	{% elif filament_type in ['PET', 'PETG'] %}
	SET_FAN_SPEED FAN=Nevermore SPEED={start_vars.petg_nevermore_start_speed}
	
	{% elif filament_type in ['FLEX', 'TPU'] %}
	SET_FAN_SPEED FAN=Nevermore SPEED={start_vars.tpu_nevermore_start_speed}
	
	{% else %}
	SET_FAN_SPEED FAN=Nevermore SPEED={start_vars.default_nevermore_start_speed}
	{% endif %}
	{% endif %}
	
	
	
	{% if ceal.ceal_master_enable == True %}
	{% if ceal.pre_homing == True %}
	_CUSTOM_PRE_HOMING {rawparams}
	{% endif %}
	{% endif %}
	
	_HOMING_HELPER
	
	
	
	{% if ceal.ceal_master_enable == True %}
	{% if ceal.pre_bed_heating_wait == True %}
	_CUSTOM_PRE_BED_HEATING_WAIT {rawparams}
	{% endif %}
	{% endif %}
	
	{% if start_vars.neopixel_led == True %}
	STATUS_HEATING
	{% endif %}
	
	{% if first_layer_bed != 0 %}
	SET_DISPLAY_TEXT MSG="Waiting For Bed Temp: {first_layer_bed}c"
	RESPOND TYPE=COMMAND MSG="Waiting For Bed Temp: {first_layer_bed}c"
	SET_HEATER_TEMPERATURE HEATER=heater_bed TARGET={first_layer_bed}
	TEMPERATURE_WAIT SENSOR=heater_bed MINIMUM={first_layer_bed|int -2} MAXIMUM={first_layer_bed|int + 5}
	RESPOND TYPE=COMMAND MSG="Bed Temp Reached"
	
	{% else %}
	SET_DISPLAY_TEXT MSG="Bed target is 0c, waiting for bed temp bypassed!"
	RESPOND TYPE=COMMAND MSG="Bed target is 0c, waiting for bed temp bypassed!"
	{% endif %}
	
	{% if start_vars.bed_fans == True %}
	_BED_FAN_SET
	M400
	{% endif %}
	
	{% if start_vars.chamber_heater == True %}
	_CHAMBER_HEATER_MONITOR
	{% endif %}
	
	{% if start_vars.start_my_print_already == False %}
	{% if first_layer_bed == 0 %}
	SET_DISPLAY_TEXT MSG="Bed target is 0c, all timers & waits bypassed!"
	RESPOND TYPE=COMMAND MSG="Bed target is 0c, all timers & waits bypassed!"
	{% else %}
	_START_WAIT_AND_TIMER_HANDLING
	{% endif %}
	
	{% else %}
	SET_DISPLAY_TEXT MSG="Start my print already is active! I'm in a rush, bypassing heat soak commands!"
	RESPOND TYPE=COMMAND MSG="Start my print already is active! I'm in a rush, bypassing heat soak commands!"
	{% endif %}
	
	{% if start_vars.bed_fans == True %}
	_BED_FAN_SET
	{% endif %}
	
	{% if start_vars.chamber_heater == True %}
	_CHAMBER_HEATER_MONITOR
	{% endif %}
	
	
	
	{% if ceal.ceal_master_enable == True %}
	{% if ceal.pre_level == True %}
	_CUSTOM_PRE_LEVEL {rawparams}
	{% endif %}
	{% endif %}
	
	
	
	
	
	
	_ADAPTIVE_LEVELLING
	_CONDITIONAL_CLEAN
	
	{% if 'probe_eddy_current eddy' in printer and 'probe_pressure' in printer %}
	_START_PROBE_PRESSURE
	CLEAN_NOZZLE
	_START_PROBE_PRESSURE
	{% endif %}
	
	G28 Z
	
	
	
	{% if ceal.ceal_master_enable == True %}
	{% if ceal.pre_mesh == True %}
	_CUSTOM_PRE_MESH {rawparams}
	{% endif %}
	{% endif %}
	
	_MESH_HANDLING
	
	
	
	
	
	{% if start_vars.orca_enable == True %}
	SET_GCODE_VARIABLE MACRO=_CORE_VARS VARIABLE=orca_surface VALUE='"{surface}"'
	_ORCA_MULTI_SURFACE_HANDLING
	{% endif %}
	
	_Z_OFFSET_HANDLING
	
	
	
	{% if start_vars.adaptive_meshing == True or start_vars.use_kamp_smart_park == True %}
	SMART_PARK
	
	{% else %}
	_START_POS
	{% endif %}
	
	
	SET_DISPLAY_TEXT MSG="Heating Hotend: {first_layer_extruder}c"
	RESPOND TYPE=COMMAND MSG="Heating Hotend: {first_layer_extruder}c"
	
	{% if start_vars.neopixel_led == True %}
	STATUS_HEATING
	{% endif %}
	
	SET_HEATER_TEMPERATURE HEATER=extruder TARGET={first_layer_extruder}
	TEMPERATURE_WAIT SENSOR=extruder MINIMUM={first_layer_extruder|float -2} MAXIMUM={first_layer_extruder|float + 5}
	
	
	
	{% if start_vars.nevermore == True %}
	
	{% if filament_type in ['PLA', 'PLA+'] %}
	SET_FAN_SPEED FAN=Nevermore SPEED={start_vars.pla_nevermore_print_speed}
	
	{% elif filament_type == 'ASA' %}
	SET_FAN_SPEED FAN=Nevermore SPEED={start_vars.asa_nevermore_print_speed}
	
	{% elif filament_type == 'ABS' %}
	SET_FAN_SPEED FAN=Nevermore SPEED={start_vars.abs_nevermore_print_speed}
	
	{% elif filament_type in ['PET', 'PETG'] %}
	SET_FAN_SPEED FAN=Nevermore SPEED={start_vars.petg_nevermore_print_speed}
	
	{% elif filament_type in ['FLEX', 'TPU'] %}
	SET_FAN_SPEED FAN=Nevermore SPEED={start_vars.tpu_nevermore_print_speed}
	
	{% else %}
	SET_FAN_SPEED FAN=Nevermore SPEED={start_vars.default_nevermore_print_speed}
	{% endif %}
	{% endif %}
	
	
	
	{% if ceal.ceal_master_enable == True %}
	{% if ceal.pre_print == True %}
	_CUSTOM_PRE_PRINT {rawparams}
	{% endif %}
	{% endif %}
	
	{% if start_vars.neopixel_led == True %}
	STATUS_PRINTING
	{% endif %}
	
	_PURGE_LINES
	
	{% if start_vars.chamber_heater == True %}
	UPDATE_DELAYED_GCODE ID=_CHAMBER_HEAT_CONTROL DURATION=2
	RESPOND TYPE=COMMAND MSG="Chamber Heater Monitor Active"
	{% endif %}
	
	{% if start_vars.bed_fans == True %}
	UPDATE_DELAYED_GCODE ID=_BED_FAN_MONITOR DURATION=1
	RESPOND TYPE=COMMAND MSG="Bed Fans Monitor Active"
	{% endif %}

[gcode_macro PRINT_END]
gcode = 
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	{% set core_vars = printer["gcode_macro _CORE_VARS"] %}
	{% set bed_fan_vars = printer["gcode_macro _BED_FAN_VARS"] %}
	{% set ceal = printer["gcode_macro CUSTOM_EXPANSION_ACTIVE_LIST"] %}
	
	{% if ceal.ceal_master_enable == True %}
	{% if ceal.pre_end == True %}
	_CUSTOM_PRE_END {rawparams}
	{% endif %}
	{% endif %}
	
	G91
	G1 E-2 F2700
	G1 E-2 Z0.2 F2400
	G0 X5 Y5 F12000
	G90
	
	{% if start_vars.encoder_runout_sensor == True %}
	SET_FILAMENT_SENSOR SENSOR=encoder_sensor ENABLE=0
	{% endif %}
	
	{% if printer.toolhead.position.z|float < 50 %}
	G0 Z50 F3600
	{% endif %}
	
	_OFFSET_RESET_CONTROL
	
	{% if start_vars.chamber_heater == True %}
	UPDATE_DELAYED_GCODE ID=_CHAMBER_HEAT_CONTROL DURATION=0
	RESPOND TYPE=COMMAND MSG="Chamber Heater Monitor deactivated, heater off"
	{% if start_vars.heater_neo == True %}
	SET_LED LED="Chamber_Heater_Neopixel" RED=1.0 GREEN=0.0 BLUE=1.0 WHITE=0 SYNC=0 TRANSMIT=1
	{% endif %}
	{% endif %}
	
	TURN_OFF_HEATERS
	
	{% if start_vars.chamber_fan == True %}
	SET_TEMPERATURE_FAN_TARGET temperature_fan="chamber" target={start_vars.post_print_cool}
	{% endif %}
	
	SET_DISPLAY_TEXT MSG="Print Complete!"
	RESPOND TYPE=COMMAND MSG="Print Complete!"
	_TOOLHEAD_PARK_PAUSE_CANCEL
	
	M84
	M220 S100
	M221 S100
	SET_VELOCITY_LIMIT ACCEL={printer.configfile.config.printer.max_accel}
	SET_VELOCITY_LIMIT VELOCITY={printer.configfile.config.printer.max_velocity}
	
	BED_MESH_CLEAR
	
	{% if start_vars.nevermore == True %}
	_NEVERMORE_POST_PRINT
	{% endif %}
	
	{% if ceal.ceal_master_enable == True %}
	{% if ceal.pre_shutdown == True %}
	_CUSTOM_PRE_SHUTDOWN {rawparams}
	{% endif %}
	{% endif %}
	
	{% if start_vars.shutdown_relay == True %}
	{% if printer["output_pin PRINTER_AUTO_OFF"].value == 1.0 %}
	_GOODNIGHT
	
	{% else %}
	M107
	M117
	{% if start_vars.neopixel_led == True %}
	STATUS_READY
	{% endif %}
	{% endif %}
	
	{% else %}
	M107
	M117
	{% if start_vars.neopixel_led == True %}
	STATUS_READY
	{% endif %}
	{% endif %}
	
	{% if start_vars.printer_lights == True %}
	{% if printer["Printer_Lights"] != start_vars.printer_lights_finish %}
	SET_PIN PIN=Printer_Lights VALUE={start_vars.printer_lights_finish}
	{% if start_vars.neopixel_led == True and start_vars.neopixel_off == True %}
	status_off
	{% endif %}
	{% endif %}
	{% endif %}
	
	{% if ceal.ceal_master_enable == True %}
	{% if ceal.post_end == True %}
	_CUSTOM_POST_END {rawparams}
	{% endif %}
	{% endif %}

[gcode_macro _RET_CALI_START]
gcode = 
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	
	_CHAMBER_SENSOR_DEFINE
	
	{% if start_vars.bed_fans == True %}
	_BED_FANS_SETUP
	M400
	_BED_FAN_SET
	{% endif %}
	
	G90
	M83
	SET_GCODE_OFFSET Z=0.0
	BED_MESH_CLEAR
	_CONDITIONAL_CLEAN
	G28 Z
	_ADAPTIVE_LEVELLING
	
	_CONDITIONAL_CLEAN
	G28 Z
	
	{% if start_vars.adaptive_meshing == True %}
	{% if ('mcu eddy' in printer.configfile.config) or ('probe_eddy_current btt_eddy' in printer) or ('probe_eddy_current eddy' in printer) %}
	BED_MESH_CALIBRATE METHOD=rapid_scan ADAPTIVE=1 ADAPTIVE_MARGIN=10
	{% else %}
	BED_MESH_CALIBRATE ADAPTIVE=1 ADAPTIVE_MARGIN=10
	{% endif %}
	
	{% else %}
	BED_MESH_PROFILE LOAD="default"
	{% endif %}
	
	{% if start_vars.neopixel_led == True %}
	STATUS_PRINTING
	{% endif %}
	
	{% if start_vars.adaptive_meshing == True or start_vars.use_kamp_smart_park == True %}
	SMART_PARK
	
	{% else %}
	_START_POS
	{% endif %}
	
	{% if start_vars.neopixel_led == True %}
	STATUS_PRINTING
	{% endif %}
	
	_PURGE_LINES
	
	{% if start_vars.chamber_heater == True %}
	_CHAMBER_HEATER_SETUP
	M400
	UPDATE_DELAYED_GCODE ID=_CHAMBER_HEAT_CONTROL DURATION=1
	RESPOND TYPE=COMMAND MSG="Chamber Heater Monitor Active"
	{% endif %}
	
	{% if start_vars.bed_fans == True %}
	UPDATE_DELAYED_GCODE ID=_BED_FAN_MONITOR DURATION=1
	RESPOND TYPE=COMMAND MSG="Bed Fans Monitor Active"
	{% endif %}
	
	M82
	G92 E0

[gcode_macro _PRINT_START_VERSION]
variable_demon_start_ver = "2.9.5"
gcode = 

[gcode_macro EDDY_TEMP_COMP]
description = Run the BTT Eddy thermal compensation routine. FOR USB/DUO EDDY ONLY!
gcode = 
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	{% set temp = params.NOZ_TEMP|default(220)|int %}
	{% set bedtemp = params.BED_TEMP|default(100)|int %}
	{% set e_tar = params.EDDY_TEMP_TARGET|default(56)|int %}
	{% set e_step = params.EDDY_TEMP_STEP|default(4)|int %}
	
	{% if 'mcu eddy' in printer and 'probe_eddy_current btt_eddy' in printer %}
	_CONDITIONAL_HOME
	G0 X{start_vars.eddy_park_x} Y{start_vars.eddy_park_y} Z20 F9000
	G0 Z5
	SET_IDLE_TIMEOUT TIMEOUT=36000
	SET_DISPLAY_TEXT MSG="Hotend heating..."
	RESPOND TYPE=COMMAND MSG="Hotend heating..."
	SET_HEATER_TEMPERATURE HEATER=extruder TARGET={temp}
	TEMPERATURE_WAIT SENSOR=extruder MINIMUM={temp|int -2} MAXIMUM={temp|int + 5}
	
	{% if start_vars.nozzle_cleaner == True %}
	CLEAN_NOZZLE
	G0 X{start_vars.eddy_park_x} Y{start_vars.eddy_park_y} Z20 F9000
	G0 Z5
	M400
	{% endif %}
	
	SET_DISPLAY_TEXT MSG="HEATING BED TO NEAR MAX...!"
	RESPOND TYPE=COMMAND MSG="HEATING BED TO NEAR MAX...!"
	SET_HEATER_TEMPERATURE HEATER=heater_bed TARGET={bedtemp}
	
	TEMPERATURE_PROBE_CALIBRATE PROBE=btt_eddy TARGET={e_tar} STEP={e_step}
	
	{% else %}
	RESPOND TYPE=error MSG="Operation canceled: USB/DUO BTT Eddy probe not present!"
	{% endif %}

[gcode_macro EDDY_CURRENT_CALIBRATION]
description = Run the BTT Eddy current calibration - Z AXIS MUST BE AT 20mm OFF THE BED!
gcode = 
	
	SET_DISPLAY_TEXT MSG="NOZZLE MUST BE AT 20mm OFF THE BED!"
	RESPOND TYPE=COMMAND MSG="NOZZLE MUST BE AT 20mm OFF THE BED!"
	LDC_CALIBRATE_DRIVE_CURRENT CHIP=btt_eddy

[gcode_macro EDDY_HEIGHT_SETUP]
description = Run the BTT Eddy height setup routine.
gcode = 
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	
	{% if 'xy' not in printer.toolhead.homed_axes %}
	G28 X Y
	{% endif %}
	BED_MESH_CLEAR
	G0 X{start_vars.eddy_park_x} Y{start_vars.eddy_park_y} F9000
	{% if 'z' not in printer.toolhead.homed_axes %}
	SET_KINEMATIC_POSITION Z={printer.toolhead.axis_maximum.z|int -1}
	{% endif %}
	PROBE_EDDY_CURRENT_CALIBRATE CHIP=btt_eddy

[gcode_macro Pressure_Advance_Test_Mode]
description = Automate the standard Klipper settings for testing PA. Click to ready & then print the Klipper PA test. DO NOT USE FOR ORCA SLICER PA TEST FILE!
gcode = 
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	
	_CONDITIONAL_HOME
	
	M117 PRESSURE ADVANCE TEST MODE ACTIVE! NOT FOR ORCA TEST
	M118 PRESSURE ADVANCE TEST MODE ACTIVE! NOT FOR ORCA TEST
	
	SET_VELOCITY_LIMIT SQUARE_CORNER_VELOCITY=1 ACCEL=500
	TUNING_TOWER COMMAND=SET_PRESSURE_ADVANCE PARAMETER=ADVANCE START=0 FACTOR=.005
	
	SET_DISPLAY_TEXT MSG="The KLIPPER pressure_advance value can then be calculated as pressure_advance = start +(plus) measured_height x(multiply) factor. For example, 0 +(plus) 12.90 x(multiply) .005 would be .258 THIS IS NOT FOR ORCA TEST"
	RESPOND TYPE=echo MSG="The KLIPPER pressure_advance value can then be calculated as pressure_advance = start +(plus) measured_height x(multiply) factor. For example, 0 +(plus) 12.90 x(multiply) .005 would be .258 THIS IS NOT FOR ORCA TEST"

[gcode_macro Stepper_Buzz_Cycle]
description = Run a full system or partial system stepper_buzz on each motor one after the other to check setup. Motors always move in a positive direction first then return.
gcode = 
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	{% set buzzX = params.X_BUZZ|default('Yes')|string %}
	{% set buzzY = params.Y_BUZZ|default('Yes')|string %}
	{% set buzzZ = params.Z_BUZZ|default('Yes')|string %}
	{% set buzzZone = params.Z1_BUZZ|default('Yes')|string %}
	{% set buzzZtwo = params.Z2_BUZZ|default('Yes')|string %}
	{% set buzzZthree = params.Z3_BUZZ|default('Yes')|string %}
	
	{% if buzzX|lower not in ['yes', 'true'] and buzzY|lower not in ['yes', 'true'] and buzzZ|lower not in ['yes', 'true'] and buzzZone|lower not in ['yes',
	'true'] and buzzZtwo|lower not in ['yes', 'true'] and buzzZthree|lower not in ['yes', 'true'] %}
	{ action_raise_error("No buzz specified, operation cancelled") }
	{% endif %}
	
	
	{% if start_vars.neopixel_led == True %}
	STATUS_BUSY
	{% endif %}
	
	{% if buzzX|lower in ['yes', 'true'] %}
	M117 Stepper X Buzz Cycle in 10 Seconds!
	M118 Stepper X Buzz Cycle in 10 Seconds!
	G4 P5000
	M117 5 Seconds!
	M118 5 Seconds!
	G4 P3000
	M117 Stepper X! READY GO!
	M118 Stepper X! READY GO!
	G4 P2000
	STEPPER_BUZZ STEPPER=stepper_x
	M400
	
	{% elif buzzX|lower in ['no', 'false'] %}
	RESPOND TYPE=COMMAND MSG="X_BUZZ skipped"
	
	{% else %}
	RESPOND TYPE=error MSG="X_BUZZ skipped. User input not recognised! Please use yes/no or true/false"
	{% endif %}
	
	
	{% if buzzY|lower in ['yes', 'true'] %}
	M117 Stepper Y Buzz Cycle in 10 Seconds
	M118 Stepper Y Buzz Cycle in 10 Seconds
	G4 P5000
	M117 5 Seconds!
	M118 5 Seconds!
	G4 P3000
	M117 Stepper Y! READY GO!
	M118 Stepper Y! READY GO!
	G4 P2000
	STEPPER_BUZZ STEPPER=stepper_y
	M400
	
	{% elif buzzY|lower in ['no', 'false'] %}
	RESPOND TYPE=COMMAND MSG="Y_BUZZ skipped"
	
	{% else %}
	RESPOND TYPE=error MSG="Y_BUZZ skipped. User input not recognised! Please use yes/no or true/false"
	{% endif %}
	
	
	{% if buzzZ|lower in ['yes', 'true'] %}
	M117 Stepper Z Buzz Cycle in 10 Seconds
	M118 Stepper Z Buzz Cycle in 10 Seconds
	G4 P5000
	M117 5 Seconds!
	M118 5 Seconds!
	G4 P3000
	M117 Stepper Z! READY GO!
	M118 Stepper Z! READY GO!
	G4 P2000
	STEPPER_BUZZ STEPPER=stepper_z
	M400
	
	{% elif buzzZ|lower in ['no', 'false'] %}
	RESPOND TYPE=COMMAND MSG="Z_BUZZ skipped"
	
	{% else %}
	RESPOND TYPE=error MSG="Z_BUZZ skipped. User input not recognised! Please use yes/no or true/false"
	{% endif %}
	
	
	{% if buzzZone|lower in ['yes', 'true'] %}
	{% if ('stepper_z1' in printer.configfile.config) %}
	M117 Stepper Z1 Buzz Cycle in 10 Seconds
	M118 Stepper Z1 Buzz Cycle in 10 Seconds
	G4 P5000
	M117 5 Seconds!
	M118 5 Seconds!
	G4 P3000
	M117 Stepper Z1! READY GO!
	M118 Stepper Z1! READY GO!
	G4 P2000
	STEPPER_BUZZ STEPPER=stepper_z1
	M400
	{% else %}
	M118 Stepper Z1 is not available to this system
	{% endif %}
	
	{% elif buzzZone|lower in ['no', 'false'] %}
	RESPOND TYPE=COMMAND MSG="Z1_BUZZ skipped"
	
	{% else %}
	RESPOND TYPE=error MSG="Z1_BUZZ skipped. User input not recognised! Please use yes/no or true/false"
	{% endif %}
	
	
	{% if buzzZtwo|lower in ['yes', 'true'] %}
	{% if ('stepper_z2' in printer.configfile.config) %}
	M117 Stepper Z2 Buzz Cycle in 10 Seconds
	M118 Stepper Z2 Buzz Cycle in 10 Seconds
	G4 P5000
	M117 5 Seconds!
	M118 5 Seconds!
	G4 P3000
	M117 Stepper Z2! READY GO!
	M118 Stepper Z2! READY GO!
	G4 P2000
	STEPPER_BUZZ STEPPER=stepper_z2
	M400
	{% else %}
	M118 Stepper Z2 is not available to this system
	{% endif %}
	
	{% elif buzzZtwo|lower in ['no', 'false'] %}
	RESPOND TYPE=COMMAND MSG="Z2_BUZZ skipped"
	
	{% else %}
	RESPOND TYPE=error MSG="Z2_BUZZ skipped. User input not recognised! Please use yes/no or true/false"
	{% endif %}
	
	
	{% if buzzZthree|lower in ['yes', 'true'] %}
	{% if ('stepper_z3' in printer.configfile.config) %}
	M117 Stepper Z3 Buzz Cycle in 10 Seconds
	M118 Stepper Z2 Buzz Cycle in 10 Seconds
	G4 P5000
	M117 5 Seconds!
	M118 5 Seconds!
	G4 P3000
	M117 Stepper Z3! READY GO!
	M118 Stepper Z3! READY GO!
	G4 P2000
	STEPPER_BUZZ STEPPER=stepper_z3
	M400
	{% else %}
	M118 Stepper Z3 is not available to this system
	{% endif %}
	
	{% elif buzzZthree|lower in ['no', 'false'] %}
	RESPOND TYPE=COMMAND MSG="Z3_BUZZ skipped"
	
	{% else %}
	RESPOND TYPE=error MSG="Z3_BUZZ skipped. User input not recognised! Please use yes/no or true/false"
	{% endif %}
	
	
	M117 CYCLE COMPLETE!
	M118 CYCLE COMPLETE!
	G4 P6000
	M117
	{% if start_vars.neopixel_led == True %}
	STATUS_READY
	{% endif %}

[gcode_macro PID_Tune_Mode]
description = Activates PID tests for the hotend & bed. Choose which to run! Macro auto saves after test. Long test!
gcode = 
	{% set ceal = printer["gcode_macro CUSTOM_EXPANSION_ACTIVE_LIST"] %}
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	{% set noz_temp = params.NOZZLE_TARGET|default(200)|float %}
	{% set bed_temp = params.BED_TARGET|default(60)|float %}
	{% set pid_noz = params.PID_NOZ|default('Yes')|string %}
	{% set pid_bed = params.PID_BED|default('Yes')|string %}
	{% set x_park = printer.toolhead.axis_maximum.x|float / 2 %}
	{% set y_park = printer.toolhead.axis_maximum.y|float / 2 %}
	
	
	
	{% if pid_noz|lower not in ['yes', 'true'] and pid_bed|lower not in ['yes', 'true'] %}
	{ action_raise_error("No PID specified, operation cancelled") }
	{% endif %}
	
	{% if ceal.ceal_master_enable == True %}
	{% if ceal.pre_pid_tune_mode == True %}
	_CUSTOM_PRE_PID_Tune_Mode {rawparams}
	{% endif %}
	{% endif %}
	
	{% if start_vars.neopixel_led == True %}
	STATUS_BUSY
	{% endif %}
	
	G90
	
	M117 PID Tune Mode! Long Test!
	M118 PID Tune Mode! Long Test!
	
	_CONDITIONAL_HOME
	
	M400
	{% if pid_noz|lower in ['yes', 'true'] %}
	G0 X{x_park} Y{y_park} Z5 F9000
	M106 S155
	{% if start_vars.neopixel_led == True %}
	STATUS_HEATING
	{% endif %}
	
	M117 EXTRUDER PID TUNE! PLEASE WAIT!
	M118 EXTRUDER PID TUNE! PLEASE WAIT!
	PID_CALIBRATE HEATER=extruder TARGET={noz_temp}
	M400
	M106 S0
	{% if start_vars.neopixel_led == True %}
	STATUS_BUSY
	{% endif %}
	{% endif %}
	
	{% if pid_bed|lower in ['yes', 'true'] %}
	M117 EXTRUDER TEST END! DONT SAVE YET!!
	M118 EXTRUDER TEST END! DONT SAVE YET!!
	G4 P10000
	G0 Z50 F9000
	{% if start_vars.neopixel_led == True %}
	STATUS_HEATING
	{% endif %}
	
	M117 HEAT BED PID TUNE! LONG TEST PLEASE WAIT!
	M118 HEAT BED PID TUNE! LONG TEST PLEASE WAIT!
	PID_CALIBRATE HEATER=heater_bed TARGET={bed_temp}
	M400
	{% if start_vars.neopixel_led == True %}
	STATUS_BUSY
	{% endif %}
	
	M117 HEAT BED TEST END!
	M118 HEAT BED TEST END!
	{% endif %}
	
	G4 P10000
	
	{% if ceal.ceal_master_enable == True %}
	{% if ceal.post_pid_tune_mode == True %}
	_CUSTOM_POST_PID_Tune_Mode {rawparams}
	{% endif %}
	{% endif %}
	
	M400
	SET_DISPLAY_TEXT MSG="SAVING CONFIG PLEASE WAIT..."
	RESPOND TYPE=echo MSG="SAVING CONFIG PLEASE WAIT..."
	G4 P5000
	SAVE_CONFIG

[gcode_macro Auto_Shaper_Calibrate]
description = Runs the auto shaper test for input shaping
gcode = 
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	
	
	
	_CONDITIONAL_HOME
	
	{% if start_vars.neopixel_led == True %}
	STATUS_BUSY
	{% endif %}
	
	_Z_PARK
	SHAPER_CALIBRATE

[gcode_macro Resonance_Test_X]
description = Runs the input shaper resonance test for the X axis
gcode = 
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	_CONDITIONAL_HOME
	
	{% if start_vars.neopixel_led == True %}
	STATUS_BUSY
	{% endif %}
	
	M117 Testing X axis please wait...
	TEST_RESONANCES AXIS=X
	M117
	{% if start_vars.neopixel_led == True %}
	STATUS_READY
	{% endif %}
	
	M118 To build graph paste this message into your SSH terminal ............................................ ~/klipper/scripts/calibrate_shaper.py /tmp/resonances_x_*.csv -o /tmp/shaper_calibrate_x.png

[gcode_macro Resonance_Test_Y]
description = Runs the input shaper resonance test for the Y axis
gcode = 
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	_CONDITIONAL_HOME
	
	{% if start_vars.neopixel_led == True %}
	STATUS_BUSY
	{% endif %}
	
	M117 Testing Y axis please wait...
	TEST_RESONANCES AXIS=Y
	M117
	{% if start_vars.neopixel_led == True %}
	STATUS_READY
	{% endif %}
	
	M118 To build graph paste this message into your SSH terminal ............................................ ~/klipper/scripts/calibrate_shaper.py /tmp/resonances_y_*.csv -o /tmp/shaper_calibrate_y.png

[gcode_macro _SETUP_HELPERS_VERSION]
variable_demon_setup = "1.5.3"
gcode = 

[gcode_macro MACHINE_LEVEL_COLD]
gcode = 
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	
	{% if printer.configfile.settings.stepper_z.endstop_pin != 'probe:z_virtual_endstop' and 'z' not in printer.toolhead.homed_axes %}
	SET_DISPLAY_TEXT MSG="Heating hotend for homing..."
	RESPOND TYPE=echo MSG="Heating hotend for homing..."
	SET_HEATER_TEMPERATURE HEATER=extruder TARGET={start_vars.pla_noz_pre}
	TEMPERATURE_WAIT SENSOR=extruder MINIMUM={start_vars.pla_noz_pre|float -5} MAXIMUM={start_vars.pla_noz_pre|float + 5}
	{% endif %}
	
	_HOMING_HELPER
	
	{% if printer.configfile.settings.stepper_z.endstop_pin != 'probe:z_virtual_endstop' %}
	M104 S0
	{% endif %}
	
	{% if start_vars.neopixel_led == True %}
	STATUS_LEVELING
	{% endif %}
	
	{% if start_vars.use_manual_levelling == True %}
	_ADAPTIVE_MANUAL_LEVELLING
	
	{% else %}
	_ADAPTIVE_LEVELLING
	
	{% endif %}
	
	_Z_PARK
	
	{% if start_vars.neopixel_led == True %}
	STATUS_READY
	{% endif %}

[gcode_macro MACHINE_LEVEL_HOT]
gcode = 
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	{% set z_cali_vars = printer["gcode_macro _Z_CALIBRATION_VARIABLES"] %}
	{% set bed_temp = params.BED_TEMP|default(60)|float %}
	{% set soak = params.HEATSOAK|default('Yes')|string %}
	{% set time = params.TIMER|default(10)|int %}
	
	G90
	SET_GCODE_OFFSET Z=0.0
	BED_MESH_CLEAR
	{% if start_vars.neopixel_led == True %}
	STATUS_HEATING
	{% endif %}
	
	M117 HEATING...
	SET_HEATER_TEMPERATURE HEATER=heater_bed TARGET={bed_temp}
	
	{% if start_vars.klicky_probe == True %}
	{% if start_vars.neopixel_led == True %}
	STATUS_HEATING
	{% endif %}
	
	SET_HEATER_TEMPERATURE HEATER=extruder TARGET={z_cali_vars.noz_pre_temp}
	TEMPERATURE_WAIT SENSOR=extruder MINIMUM={z_cali_vars.noz_pre_temp - 5} MAXIMUM={z_cali_vars.noz_pre_temp + 5}
	{% endif %}
	_HOMING_HELPER
	
	TEMPERATURE_WAIT SENSOR=heater_bed MINIMUM={bed_temp|int -2} MAXIMUM={bed_temp|int + 5}
	
	{% if soak|lower in ['yes', 'true'] %}
	RESPOND TYPE=COMMAND MSG="Running Heatsoak timer..."
	_HEAT_WAIT MSG="Levelling heatsoak timer..." MINUTES={time|int}
	
	{% elif soak|lower in ['no', 'false'] %}
	RESPOND TYPE=COMMAND MSG="Heatsoak timer skipped"
	
	{% else %}
	RESPOND TYPE=error MSG="Levelling heatsoak timer skipped. User input not recognised! Please use yes/no or true/false"
	{% endif %}
	
	{% if start_vars.nozzle_cleaner == True %}
	CLEAN_NOZZLE
	{% endif %}
	G28 Z
	M104 S0
	
	{% if start_vars.neopixel_led == True %}
	STATUS_LEVELING
	{% endif %}
	
	{% if start_vars.use_manual_levelling == True %}
	_ADAPTIVE_MANUAL_LEVELLING
	
	{% else %}
	_ADAPTIVE_LEVELLING
	
	{% endif %}
	
	_Z_PARK
	
	{% if start_vars.neopixel_led == True %}
	STATUS_READY
	{% endif %}

[gcode_macro Z_Switch_Calibrate_Cold]
gcode = 
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	{% set x_park = printer.toolhead.axis_maximum.x|float / 2 %}
	{% set y_park = printer.toolhead.axis_maximum.y|float / 2 %}
	
	
	
	{% if start_vars.klicky_probe == False or printer.configfile.settings.stepper_z.endstop_pin == 'probe:z_virtual_endstop' %}
	{action_raise_error("This error is caused by your printer not having a Z endstop switch, enable klicky_probe in user settings & define the pin if you have a Z endstop switch")}
	{% else %}
	M117 IMPORTANT! Ensure your nozzle is perfectly clean from filament!
	M118 IMPORTANT! Ensure your nozzle is perfectly clean from filament!
	
	{% if start_vars.neopixel_led == True %}
	STATUS_BUSY
	{% endif %}
	
	G90
	SET_GCODE_OFFSET Z=0.0
	BED_MESH_CLEAR
	
	_HOMING_HELPER
	{% if start_vars.neopixel_led == True %}
	STATUS_LEVELING
	{% endif %}
	
	M117 Gantry Levelling
	
	_ADAPTIVE_LEVELLING
	_Z_PARK
	M117 Time to get that piece of paper!
	
	{% if start_vars.neopixel_led == True %}
	STATUS_CALIBRATING_Z
	{% endif %}
	
	Z_ENDSTOP_CALIBRATE
	{% endif %}

[gcode_macro Z_Switch_Calibrate_Hot]
gcode = 
	
	{% set z_cali_vars = printer["gcode_macro _Z_CALIBRATION_VARIABLES"] %}
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	{% set noz_temp = params.NOZZLE_TEMP|default(200)|float %}
	{% set bed_temp = params.BED_TEMP|default(60)|float %}
	{% set x_park = printer.toolhead.axis_maximum.x|float / 2 %}
	{% set y_park = printer.toolhead.axis_maximum.y|float / 2 %}
	
	
	
	{% if start_vars.klicky_probe == False or printer.configfile.settings.stepper_z.endstop_pin == 'probe:z_virtual_endstop' %}
	{action_raise_error("This error is caused by your printer not having a Z endstop switch, enable klicky_probe in user settings & define the pin if you have a Z endstop switch")}
	{% else %}
	{% if start_vars.neopixel_led == True %}
	STATUS_BUSY
	{% endif %}
	
	G90
	SET_GCODE_OFFSET Z=0.0
	BED_MESH_CLEAR
	
	{% if start_vars.klicky_probe == True %}
	{% if start_vars.neopixel_led == True %}
	STATUS_HEATING
	{% endif %}
	
	SET_DISPLAY_TEXT MSG="Hotend Preheat: {z_cali_vars.noz_pre_temp}c"
	SET_HEATER_TEMPERATURE HEATER=extruder TARGET={z_cali_vars.noz_pre_temp}
	TEMPERATURE_WAIT SENSOR=extruder MINIMUM={z_cali_vars.noz_pre_temp - 5} MAXIMUM={z_cali_vars.noz_pre_temp + 5}
	{% endif %}
	
	_HOMING_HELPER
	
	M117 HEATING PRINTER! PLEASE WAIT!
	{% if start_vars.neopixel_led == True %}
	STATUS_HEATING
	{% endif %}
	
	M190 S{bed_temp}
	
	{% if start_vars.chamber_fan == True %}
	{% if printer["temperature_fan chamber"].temperature <z_cali_vars.heat_soak_threshold %}
	_Z_PARK
	_HEAT_WAIT MINUTES={z_cali_vars.heat_soak_timer}
	{% endif %}
	
	{% elif start_vars.chamber_sensor == True %}
	{% if printer["temperature_sensor Chamber_Temp"].temperature <z_cali_vars.heat_soak_threshold %}
	_Z_PARK
	_HEAT_WAIT MINUTES={z_cali_vars.heat_soak_timer}
	{% endif %}
	
	{% else %}
	_Z_PARK
	_HEAT_WAIT MINUTES={z_cali_vars.heat_soak_timer}
	
	{% endif %}
	
	M117 Heating Nozzle
	M109 S{noz_temp}
	
	_CONDITIONAL_CLEAN
	{% if start_vars.neopixel_led == True %}
	STATUS_LEVELING
	{% endif %}
	
	_ADAPTIVE_LEVELLING
	
	{% if start_vars.nozzle_cleaner == True %}
	CLEAN_NOZZLE
	{% endif %}
	_Z_PARK
	SET_DISPLAY_TEXT MSG="Time to get that piece of paper!"
	RESPOND TYPE=echo MSG="Time to get that piece of paper!"
	
	{% if start_vars.neopixel_led == True %}
	STATUS_CALIBRATING_Z
	{% endif %}
	
	Z_ENDSTOP_CALIBRATE
	{% endif %}

[gcode_macro Z_Probe_Calibrate_Cold]
gcode = 
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	{% set x_park = printer.toolhead.axis_maximum.x|float / 2 %}
	{% set y_park = printer.toolhead.axis_maximum.y|float / 2 %}
	
	
	
	M117 IMPORTANT! Ensure your nozzle is perfectly clean from filament!
	M118 IMPORTANT! Ensure your nozzle is perfectly clean from filament!
	
	{% if start_vars.neopixel_led == True %}
	STATUS_BUSY
	{% endif %}
	
	G90
	SET_GCODE_OFFSET Z=0.0
	BED_MESH_CLEAR
	
	_HOMING_HELPER
	
	{% if start_vars.neopixel_led == True %}
	STATUS_LEVELING
	{% endif %}
	
	_ADAPTIVE_LEVELLING
	_Z_PARK
	SET_DISPLAY_TEXT MSG="Time to get that piece of paper!"
	RESPOND TYPE=echo MSG="Time to get that piece of paper!"
	
	{% if start_vars.neopixel_led == True %}
	STATUS_CALIBRATING_Z
	{% endif %}
	
	{% if 'mcu eddy' in printer.configfile.config or 'probe_eddy_current btt_eddy' in printer %}
	PROBE_EDDY_CURRENT_CALIBRATE CHIP=btt_eddy
	
	{% elif 'scanner' in printer %}
	CARTOGRAPHER_CALIBRATE METHOD=manual
	
	{% else %}
	PROBE_CALIBRATE
	{% endif %}

[gcode_macro Z_Probe_Calibrate_Hot]
gcode = 
	
	{% set z_cali_vars = printer["gcode_macro _Z_CALIBRATION_VARIABLES"] %}
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	{% set noz_temp = params.NOZZLE_TEMP|default(200)|float %}
	{% set bed_temp = params.BED_TEMP|default(60)|float %}
	{% set x_park = printer.toolhead.axis_maximum.x|float / 2 %}
	{% set y_park = printer.toolhead.axis_maximum.y|float / 2 %}
	
	
	
	{% if start_vars.neopixel_led == True %}
	STATUS_BUSY
	{% endif %}
	
	G90
	SET_GCODE_OFFSET Z=0.0
	BED_MESH_CLEAR
	
	{% if start_vars.klicky_probe == True %}
	{% if start_vars.neopixel_led == True %}
	STATUS_HEATING
	{% endif %}
	
	SET_DISPLAY_TEXT MSG="Hotend Preheat: {z_cali_vars.noz_pre_temp}c"
	SET_HEATER_TEMPERATURE HEATER=extruder TARGET={z_cali_vars.noz_pre_temp}
	TEMPERATURE_WAIT SENSOR=extruder MINIMUM={z_cali_vars.noz_pre_temp - 5} MAXIMUM={z_cali_vars.noz_pre_temp + 5}
	{% endif %}
	
	_HOMING_HELPER
	
	SET_DISPLAY_TEXT MSG="HEATING PLEASE WAIT"
	RESPOND TYPE=echo MSG="HEATING PLEASE WAIT"
	{% if start_vars.neopixel_led == True %}
	STATUS_HEATING
	{% endif %}
	
	
	SET_HEATER_TEMPERATURE HEATER=heater_bed TARGET={bed_temp}
	TEMPERATURE_WAIT SENSOR=heater_bed MINIMUM={bed_temp|int -2} MAXIMUM={bed_temp|int + 5}
	
	{% if start_vars.chamber_fan == True %}
	{% if printer["temperature_fan chamber"].temperature <z_cali_vars.heat_soak_threshold %}
	_Z_PARK
	_HEAT_WAIT MINUTES={z_cali_vars.heat_soak_timer}
	{% endif %}
	
	{% elif start_vars.chamber_sensor == True %}
	{% if printer["temperature_sensor Chamber_Temp"].temperature <z_cali_vars.heat_soak_threshold %}
	_Z_PARK
	_HEAT_WAIT MINUTES={z_cali_vars.heat_soak_timer}
	{% endif %}
	
	{% else %}
	_Z_PARK
	_HEAT_WAIT MINUTES={z_cali_vars.heat_soak_timer}
	
	{% endif %}
	
	M117 Heating Nozzle
	M109 S{noz_temp}
	
	_CONDITIONAL_CLEAN
	
	{% if start_vars.neopixel_led == True %}
	STATUS_LEVELING
	{% endif %}
	
	_ADAPTIVE_LEVELLING
	
	SET_DISPLAY_TEXT MSG="Heating Nozzle"
	RESPOND TYPE=echo MSG="Heating Nozzle"
	SET_HEATER_TEMPERATURE HEATER=extruder TARGET={noz_temp}
	TEMPERATURE_WAIT SENSOR=extruder MINIMUM={noz_temp - 5} MAXIMUM={noz_temp + 5}
	
	{% if start_vars.nozzle_cleaner == True %}
	CLEAN_NOZZLE
	{% endif %}
	_Z_PARK
	
	SET_DISPLAY_TEXT MSG="Time to get that piece of paper!"
	RESPOND TYPE=echo MSG="Time to get that piece of paper!"
	
	{% if start_vars.neopixel_led == True %}
	STATUS_CALIBRATING_Z
	{% endif %}
	
	{% if 'mcu eddy' in printer.configfile.config or 'probe_eddy_current btt_eddy' in printer %}
	PROBE_EDDY_CURRENT_CALIBRATE CHIP=btt_eddy
	
	{% elif 'scanner' in printer %}
	CARTOGRAPHER_CALIBRATE METHOD=manual
	
	{% else %}
	PROBE_CALIBRATE
	{% endif %}

[gcode_macro Z_Probe_Accuracy_Cold]
gcode = 
	
	_CONDITIONAL_HOME
	{% if printer.toolhead.position.z|float < 20 %}
	G0 Z20 F3600
	{% endif %}
	_Z_PARK
	PROBE_ACCURACY

[gcode_macro Z_Probe_Accuracy_Hot]
gcode = 
	{% set z_cali_vars = printer["gcode_macro _Z_CALIBRATION_VARIABLES"] %}
	{% set start_vars = printer["gcode_macro _START_VARIABLES"] %}
	{% set temp = params.TEMP|default(60)|float %}
	
	G90
	SET_GCODE_OFFSET Z=0.0
	BED_MESH_CLEAR
	
	{% if start_vars.klicky_probe == True %}
	{% if start_vars.neopixel_led == True %}
	STATUS_HEATING
	{% endif %}
	
	SET_DISPLAY_TEXT MSG="Hotend Preheat: {z_cali_vars.noz_pre_temp}c"
	SET_HEATER_TEMPERATURE HEATER=extruder TARGET={z_cali_vars.noz_pre_temp}
	TEMPERATURE_WAIT SENSOR=extruder MINIMUM={z_cali_vars.noz_pre_temp - 5} MAXIMUM={z_cali_vars.noz_pre_temp + 5}
	{% endif %}
	
	_CONDITIONAL_HOME
	{% if printer.toolhead.position.z|float < 20 %}
	G0 Z20 F3600
	{% endif %}
	
	{% if start_vars.klicky_probe == True %}
	M104 S0
	{% endif %}
	
	_Z_PARK
	{% if start_vars.neopixel_led == True %}
	STATUS_HEATING
	{% endif %}
	
	SET_DISPLAY_TEXT MSG="HEATING PLEASE WAIT"
	RESPOND TYPE=echo MSG="HEATING PLEASE WAIT"
	SET_HEATER_TEMPERATURE HEATER=heater_bed TARGET={temp}
	TEMPERATURE_WAIT SENSOR=heater_bed MINIMUM={temp - 5} MAXIMUM={temp + 5}
	{% if start_vars.neopixel_led == True %}
	STATUS_BUSY
	{% endif %}
	
	
	{% if start_vars.chamber_sensor == True %}
	_WAIT_HANDLING_LOW_TEMP
	{% else %}
	_HEAT_WAIT MINUTES={start_vars.lo_temp_timer}
	{% endif %}
	
	PROBE_ACCURACY
	{% if start_vars.neopixel_led == True %}
	STATUS_READY
	{% endif %}

[gcode_macro _Z_CALIBRATION_VERSION]
variable_demon_z_cal = "1.6.1"
gcode = 

[display_template _print_status]
text = 
	{% if printer.display_status.message %}
	{ printer.display_status.message }
	{% elif printer.idle_timeout.printing_time %}
	{% if printer.print_stats.filename %}
	{ printer.print_stats.filename.split('/')[-1] }
	{% else %}
	DEMONWARE Online
	{% endif %}
	{% else %}
	DEMONWARE Online
	{% endif %}

[menu __main __tune __chamber_fan_target]
type = input
name = ChmbrFanTrgt:{'%3d' % (menu.input)}%
enable = {printer["gcode_macro _START_VARIABLES"].chamber_fan == True}
input = {printer["temperature_fan chamber"].target}
input_min = 0
input_max = 100
input_step = 1
gcode = 
	SET_TEMPERATURE_FAN_TARGET temperature_fan="chamber" target={'%d' % (menu.input)}

[menu __main __tune __printer_lights]
type = input
name = LED Pwr: {'%03.0f' % (menu.input)}
input = {printer['output_pin Printer_Lights'].value*100}
input_min = 0
input_max = 100
input_step = 1
gcode = 
	SET_PIN PIN=Printer_Lights VALUE={'%03.2f' % (menu.input/100)}

[menu __main __tune __neo_scrn_printing]
type = command
name = Neo Scrn Print
gcode = 
	STATUS_PRINTING

[menu __main __tune __neo_scrn_off]
type = command
name = Neo Scrn off
gcode = 
	STATUS_OFF

[menu __main __DEMON]
type = list
enable = {not (printer.print_stats.state == "paused" or printer.idle_timeout.state == "Printing")}
index = 1
name = DEMON

[menu __main __DEMON __Heatsoak]
type = input
name = Heatsoak: {'OFF' if menu.input else 'ON'}
input = {printer["gcode_macro _START_VARIABLES"].start_my_print_already}
input_min = 0
input_max = 1
input_step = 1
gcode = 
	SET_GCODE_VARIABLE MACRO=_START_VARIABLES VARIABLE=start_my_print_already VALUE={True if menu.input else False}

[menu __main __DEMON __Adptv_Mesh]
type = input
name = Adptv_Mesh: {'ON' if menu.input else 'OFF'}
input = {printer["gcode_macro _START_VARIABLES"].adaptive_meshing}
input_min = 0
input_max = 1
input_step = 1
gcode = 
	SET_GCODE_VARIABLE MACRO=_START_VARIABLES VARIABLE=adaptive_meshing VALUE={True if menu.input else False}

[menu __main __DEMON __clean_nozzle]
type = command
enable = {printer["gcode_macro _START_VARIABLES"].nozzle_cleaner == True}
name = Clean Nozzle
gcode = 
	CLEAN_NOZZLE

[menu __main __DEMON __present]
type = command
name = Present_Tlhead
gcode = 
	PRESENT_TOOLHEAD

[menu __main __DEMON __stow]
type = command
name = Stow Tlhead
gcode = 
	STOW_TOOLHEAD

[menu __main __DEMON __zascender]
type = input
name = Z Ascender: {'%3d' % (menu.input)}%
input = 15
input_min = 0
input_max = 50
input_step = 1
gcode = 
	Z_ASCENDER HEIGHT={'%d' % (menu.input)}

[menu __main __prepare __rdy_up_cstm]
type = command
name = ReadyUp Custom
index = 1
gcode = 
	READY_UP_CUSTOM

[menu __main __timer]
type = list
enable = {not (printer.print_stats.state == "paused" or printer.idle_timeout.state == "Printing")}
index = 3
name = Timer

[menu __main __timer __timer_start]
type = input
name = Timer Min: {'%3d' % (menu.input)}
input = 10
input_min = 0
input_max = 60
input_step = 1
gcode = 
	TIMER_Start MINUTES={'%d' % (menu.input)}

[menu __main __timer __timer_stop]
type = command
name = Timer Stop
gcode = 
	TIMER_Stop

[menu __main __levelling __probe_cal]
type = command
name = Probe Calibrate
index = 0
gcode = 
	Z_PROBE_CALIBRATE_COLD

[menu __main __levelling __machine_lvl_cld]
type = command
enable = {('quad_gantry_level' in printer)}
name = Machine Lvl Cld
index = 1
gcode = 
	M117 Machine Level Cold
	MACHINE_LEVEL_COLD

[menu __main __levelling __machine_lvl_hot]
type = command
enable = {('quad_gantry_level' in printer)}
name = Machine Lvl Hot
index = 2
gcode = 
	M117 Machine Level Hot
	MACHINE_LEVEL_HOT

[menu __main __levelling __qik_mesh]
type = command
enable = {('bed_mesh' in printer)}
name = Quick Mesh
index = 3
gcode = 
	M117 Quick Mesh
	QUICK_MESH

[menu __main __levelling __hot_mesh]
type = command
enable = {('bed_mesh' in printer)}
name = Hot Mesh
index = 4
gcode = 
	M117 Hot Mesh
	HOT_MESH

[menu __main __control2 __chamber_fan_target]
type = input
name = ChmbrFanTrgt:{'%3d' % (menu.input)}%
enable = {printer["gcode_macro _START_VARIABLES"].chamber_fan == True}
input = {printer["temperature_fan chamber"].target}
input_min = 0
input_max = 100
input_step = 1
gcode = 
	SET_TEMPERATURE_FAN_TARGET temperature_fan="chamber" target={'%d' % (menu.input)}

[menu __main __filament __load_clean]
type = command
enable = {printer["gcode_macro _START_VARIABLES"].nozzle_cleaner == True and printer["gcode_macro _START_VARIABLES"].purge_bucket == True}
name = Load Clean
gcode = 
	LOAD_CLEAN

[menu __main __filament __unload_clean]
type = command
enable = {printer["gcode_macro _START_VARIABLES"].nozzle_cleaner == True and printer["gcode_macro _START_VARIABLES"].purge_bucket == True}
name = Unload Clean
gcode = 
	UNLOAD_CLEAN

[menu __main __lighting]
type = list
index = 7
name = Lighting

[menu __main __lighting __printer_lights]
type = input
name = LED Pwr: {'%03.0f' % (menu.input)}
input = {printer['output_pin Printer_Lights'].value*100}
input_min = 0
input_max = 100
input_step = 1
gcode = 
	SET_PIN PIN=Printer_Lights VALUE={'%03.2f' % (menu.input/100)}

[menu __main __lighting __neo_scrn_rdy]
type = command
name = Neo Scrn Rdy
gcode = 
	STATUS_READY

[menu __main __lighting __neo_scrn_printing]
type = command
name = Neo Scrn Print
gcode = 
	STATUS_PRINTING

[menu __main __lighting __neo_scrn_off]
type = command
name = Neo Scrn off
gcode = 
	STATUS_OFF

[menu __main __power]
type = list
index = 8
name = Power

[menu __main __power __klipper_rstrt]
type = command
name = Klipper Restart
gcode = 
	RESTART

[menu __main __power __host_reboot]
type = command
name = Host Reboot
gcode = 
	{action_call_remote_method("restart_machine")}

[menu __main __power __host_off]
type = command
name = Host ShutDown
gcode = 
	{action_call_remote_method("shutdown_machine")}

[gcode_macro CUSTOM_EXPANSION_ACTIVE_LIST]
variable_ceal_master_enable = False
variable_pre_start = False
variable_pre_heating = False
variable_pre_homing = False
variable_pre_bed_heating_wait = False
variable_pre_level = False
variable_pre_mesh = False
variable_pre_print = False
variable_pre_end = False
variable_pre_shutdown = False
variable_post_end = False
variable_pre_load = False
variable_post_load = False
variable_pre_unload = False
variable_post_unload = False
variable_pre_load_clean = False
variable_post_load_clean = False
variable_pre_unload_clean = False
variable_post_unload_clean = False
variable_pre_pid_tune_mode = False
variable_post_pid_tune_mode = False
variable_pause = False
variable_resume = False
variable_cancel = False
gcode = 

[gcode_macro _CUSTOM_PRE_START]
gcode = 

[gcode_macro _CUSTOM_PRE_HEATING]
gcode = 

[gcode_macro _CUSTOM_PRE_HOMING]
gcode = 

[gcode_macro _CUSTOM_PRE_BED_HEATING_WAIT]
gcode = 

[gcode_macro _CUSTOM_PRE_LEVEL]
gcode = 

[gcode_macro _CUSTOM_PRE_MESH]
gcode = 

[gcode_macro _CUSTOM_PRE_PRINT]
gcode = 

[gcode_macro _CUSTOM_PRE_END]
gcode = 

[gcode_macro _CUSTOM_PRE_SHUTDOWN]
gcode = 

[gcode_macro _CUSTOM_POST_END]
gcode = 

[gcode_macro _CUSTOM_PRE_LOAD]
gcode = 

[gcode_macro _CUSTOM_POST_LOAD]
gcode = 

[gcode_macro _CUSTOM_PRE_UNLOAD]
gcode = 

[gcode_macro _CUSTOM_POST_UNLOAD]
gcode = 

[gcode_macro _CUSTOM_PRE_LOAD_CLEAN]
gcode = 

[gcode_macro _CUSTOM_POST_LOAD_CLEAN]
gcode = 

[gcode_macro _CUSTOM_PRE_UNLOAD_CLEAN]
gcode = 

[gcode_macro _CUSTOM_POST_UNLOAD_CLEAN]
gcode = 

[gcode_macro _CUSTOM_PRE_PID_Tune_Mode]
gcode = 

[gcode_macro _CUSTOM_POST_PID_Tune_Mode]
gcode = 

[gcode_macro _CUSTOM_PAUSE]
gcode = 

[gcode_macro _CUSTOM_RESUME]
gcode = 

[gcode_macro _CUSTOM_CANCEL]
gcode = 

[gcode_macro _CEAL_VERSION]
variable_demon_ceal = "1.0.1"
gcode = 

[gcode_macro _CLEAN_VARIABLES]
variable_have_you_set_this_up = True
variable_random_clean_x = True
variable_random_clean_y = True
variable_clean_travel_speed = 200
variable_pass_spd = 250
variable_end_position_x = 351
variable_end_position_y = 359
variable_park_x = 324
variable_park_y = 360
variable_park_z = 25
variable_linear_pass_count = 6
variable_linear_clean_start_x = 315
variable_linear_clean_start_y = 360
variable_linear_clean_start_z = 0.5
variable_linear_clean_axis = "X"
variable_linear_clean_positive_dir = True
variable_linear_clean_distance = 28
variable_pass_count = 40
variable_start_x = 315
variable_start_y = 360
variable_start_z = 0.5
variable_clean_min_x = 324
variable_clean_max_x = 345
variable_clean_min_y = 358
variable_clean_max_y = 360
variable_nozzle_pre_temp = 180
variable_nozzle_post_temp = 180
variable_load_clean_load_dist = 120
variable_load_clean_purge_dist = 30
variable_unload_clean_unload_dist = 100
variable_unload_clean_purge_dist = 20
variable_purge_min_x = 307
variable_purge_max_x = 340
variable_purge_y_park = 352
variable_purge_z_park = 8
variable_ready_up_pla_noz = 180
variable_ready_up_pla_bed = 60
variable_ready_up_asa_noz = 180
variable_ready_up_asa_bed = 100
variable_ready_up_petg_noz = 180
variable_ready_up_petg_bed = 75
variable_ready_up_tpu_noz = 180
variable_ready_up_tpu_bed = 70
gcode = 

[gcode_macro _CLEAN_VARS_VER]
variable_demon_clean_vars_ver = "1.1.0"
gcode = 

[gcode_macro _START_VARIABLES]
variable_orca_enable = True
variable_orca_multi_surface = True
variable_combine_offset = True
variable_floating_bed_fans = True
variable_floating_bed_fans_max = 0.85
variable_disable_set_flow = False
variable_use_manual_levelling = False
variable_adaptive_meshing = True
variable_use_kamp_adaptive_purge = True
variable_use_kamp_smart_park = True
variable_auto_reset_eddy_offset = False
variable_eddy_park_x = 100
variable_eddy_park_y = 170
variable_z_tracker_reduced_monitoring = False
variable_eddy_verbose = True
variable_apa_readback_enable = False
variable_bed_fans_settings_readback = False
variable_orca_cool_plate = 0.00
variable_orca_engineering_plate = 0.00
variable_orca_smooth_hi_temp_plate = 0.00
variable_orca_textured_pei_plate = -0.03
variable_orca_textured_cool_plate = 0.00
variable_pla_flow_rate = 100
variable_pla_hi_flow_rate = 100
variable_pla_noz_pre = 160
variable_pla_min_chamber_temp = 18
variable_pla_max_chamber_temp = 25
variable_pla_bed_fan_enable = True
variable_pla_bed_fan_cool = True
variable_pla_bed_fan_low_speed = 0.25
variable_pla_bed_fan_high_speed = 0.60
variable_pla_nevermore_start_speed = 1
variable_pla_nevermore_print_speed = 0.5
variable_pla_pa = 0.035
variable_pla_st = 0.03
variable_pla_adaptive_pa_enable = True
variable_pla_inner_wall_pa = 0.030
variable_pla_outer_wall_pa = 0.031
variable_pla_sparse_infill_pa = 0.032
variable_pla_solid_infill_pa = 0.033
variable_pla_top_surface_pa = 0.034
variable_asa_flow_rate = 100
variable_asa_hi_flow_rate = 100
variable_asa_noz_pre = 180
variable_asa_min_chamber_temp = 42
variable_asa_max_chamber_temp = 55
variable_asa_bed_fan_enable = True
variable_asa_bed_fan_cool = False
variable_asa_bed_fan_low_speed = 0.25
variable_asa_bed_fan_high_speed = 0.65
variable_asa_nevermore_start_speed = 1
variable_asa_nevermore_print_speed = 0.5
variable_asa_pa = 0.035
variable_asa_st = 0.03
variable_asa_adaptive_pa_enable = False
variable_asa_inner_wall_pa = 0.030
variable_asa_outer_wall_pa = 0.031
variable_asa_sparse_infill_pa = 0.032
variable_asa_solid_infill_pa = 0.033
variable_asa_top_surface_pa = 0.034
variable_abs_flow_rate = 100
variable_abs_hi_flow_rate = 100
variable_abs_noz_pre = 190
variable_abs_min_chamber_temp = 42
variable_abs_max_chamber_temp = 55
variable_abs_bed_fan_enable = True
variable_abs_bed_fan_cool = False
variable_abs_bed_fan_low_speed = 0.25
variable_abs_bed_fan_high_speed = 0.55
variable_abs_nevermore_start_speed = 1
variable_abs_nevermore_print_speed = 0.5
variable_abs_pa = 0.035
variable_abs_st = 0.03
variable_abs_adaptive_pa_enable = False
variable_abs_inner_wall_pa = 0.030
variable_abs_outer_wall_pa = 0.031
variable_abs_sparse_infill_pa = 0.032
variable_abs_solid_infill_pa = 0.033
variable_abs_top_surface_pa = 0.034
variable_high_temp_expansion_offset = False
variable_high_temp_offset = -0.03
variable_petg_flow_rate = 100
variable_petg_hi_flow_rate = 100
variable_petg_noz_pre = 180
variable_petg_min_chamber_temp = 18
variable_petg_max_chamber_temp = 35
variable_petg_bed_fan_enable = True
variable_petg_bed_fan_cool = True
variable_petg_bed_fan_low_speed = 0.25
variable_petg_bed_fan_high_speed = 0.60
variable_petg_nevermore_start_speed = 1
variable_petg_nevermore_print_speed = 0.5
variable_petg_pa = 0.035
variable_petg_st = 0.03
variable_petg_adaptive_pa_enable = True
variable_petg_inner_wall_pa = 0.030
variable_petg_outer_wall_pa = 0.031
variable_petg_sparse_infill_pa = 0.032
variable_petg_solid_infill_pa = 0.033
variable_petg_top_surface_pa = 0.034
variable_petg_anti_squish = True
variable_petg_offset = 0.015
variable_tpu_flow_rate = 100
variable_tpu_hi_flow_rate = 100
variable_tpu_noz_pre = 160
variable_tpu_min_chamber_temp = 18
variable_tpu_max_chamber_temp = 27
variable_tpu_bed_fan_enable = True
variable_tpu_bed_fan_cool = True
variable_tpu_bed_fan_low_speed = 0.25
variable_tpu_bed_fan_high_speed = 0.6
variable_tpu_nevermore_start_speed = 1
variable_tpu_nevermore_print_speed = 0.5
variable_tpu_pa = 0.035
variable_tpu_st = 0.03
variable_tpu_adaptive_pa_enable = True
variable_tpu_inner_wall_pa = 0.030
variable_tpu_outer_wall_pa = 0.031
variable_tpu_sparse_infill_pa = 0.032
variable_tpu_solid_infill_pa = 0.033
variable_tpu_top_surface_pa = 0.034
variable_tpu_anti_squish = True
variable_tpu_offset = 0.013
variable_default_lo_noz_pre = 180
variable_default_hi_noz_pre = 200
variable_default_chamber_temp = 25
variable_default_temp_timer = 10
variable_default_min_chamber_temp = 20
variable_default_max_chamber_temp = 30
variable_default_bed_fan_enable = True
variable_default_bed_fan_cool = True
variable_default_bed_fan_low_speed = 0.25
variable_default_bed_fan_high_speed = 0.6
variable_default_nevermore_start_speed = 1
variable_default_nevermore_print_speed = 0.5
variable_home_y_first = False
variable_override_home_power_safety = False
variable_home_power = 0.7
variable_pre_home_lift = 20
variable_z_lift_speed = 18
variable_axis_backoff_speed = 35
variable_axis_backoff_distance = 20
variable_axis_register_clear_wait = 2.5
variable_homing_movement_travel_speed = 200
variable_set_probe_point_default = True
variable_set_probe_custom_x = 100
variable_set_probe_custom_y = 100
variable_post_z_switch_backoff = True
variable_post_z_switch_backoff_y_dist = 15
variable_post_z_switch_backoff_height = 25
variable_z_endstop_loaction_x = 8888
variable_z_endstop_loaction_y = 8888
variable_use_custom_park = False
variable_system_choose_z = True
variable_custom_park_x = 8888
variable_custom_park_y = 8888
variable_custom_park_z = 8888
variable_infinite_pause = True
variable_kill_fan_on_pause = True
variable_present_use_default = True
variable_present_toolhead_x = 50
variable_present_toolhead_y = 50
variable_present_toolhead_z = 200
variable_present_speed = 60
variable_stow_toolhead_x = 323
variable_stow_toolhead_y = 340
variable_stow_toolhead_z = 20
variable_stow_speed = 60
variable_filament_change_park_x = 10
variable_filament_change_park_y = 10
variable_filament_change_park_min_z = 50
variable_load_length = 125
variable_load_purge_length = 25
variable_unload_length = 100
variable_unload_purge_length = 25
variable_start_my_print_already = False
variable_chamber_temp_wait = True
variable_post_print_cool = 25
variable_lo_temp_timer = 10
variable_hi_temp_timer = 15
variable_danger_will_robinson = False
variable_heater_neo = False
variable_heater_low = 55
variable_heater_mid = 75
variable_heater_high = 90
variable_nevermore_asa_abs_only = True
variable_nevermore_post_speed = 0.6
variable_nevermore_post_run_time = 5
variable_nevermore_post_timer = True
variable_nevermore_leave_running = False
variable_all_in_one_pi = False
variable_host_shutdown = False
variable_timeout_power = True
variable_feed_rate = 100
variable_printer_lights_print = 1
variable_printer_lights_finish = 0.2
variable_neopixel_off = True
variable_purge_lines = True
variable_purge_along_y = True
variable_start_x_position = 0.6
variable_start_y_position = 12
variable_purge_line_length = 150
variable_klicky_probe = False
variable_chamber_fan = False
variable_chamber_sensor = False
variable_chamber_heater = False
variable_bed_fans = False
variable_runout_sensor = True
variable_encoder_runout_sensor = False
variable_nevermore = False
variable_shutdown_relay = False
variable_printer_lights = False
variable_neopixel_led = False
variable_nozzle_cleaner = True
variable_purge_bucket = False
variable_aes_system = False
variable_screen_msg = "DEMONWARE Online"
variable_console_msg = "Welcome to Demon Essentials! Happy printing! These macros were written by a human, no AI was used in their creation!"
variable_demon_version = "2.9.5"
gcode = 

[gcode_macro _MESH_BUILDER_VARIABLES]
variable_mesh_pla_bed_temp = 60
variable_mesh_asa_bed_temp = 100
variable_mesh_abs_bed_temp = 100
variable_mesh_petg_bed_temp = 75
variable_mesh_tpu_bed_temp = 50
variable_lo_heat_soak_threshold = 22
variable_hi_heat_soak_threshold = 42
variable_mesh_lo_temp_timer = 10
variable_mesh_hi_temp_timer = 10
variable_use_bed_fans = False
gcode = 

[gcode_macro _Z_CALIBRATION_VARIABLES]
variable_noz_pre_temp = 180
variable_heat_soak_timer = 10
variable_heat_soak_threshold = 25
gcode = 

[mcu]
serial = /dev/serial/by-id/usb-Klipper_stm32f103xe_38FFDA053347533828642451-if00
restart_method = command

[mcu extra_mcu]
serial = /dev/serial/by-id/usb-Klipper_stm32f103xe_51FF6B064849824914310967-if00
restart_method = command

[mcu eddy]
serial = /dev/serial/by-id/usb-Klipper_rp2040_50445059389DA01C-if00@
restart_method = command

[probe_eddy_ng btt_eddy]
sensor_type = btt_eddy
i2c_mcu = eddy
i2c_bus = i2c0f
x_offset = -16
y_offset = 11.5

[temperature_sensor btt_eddy_mcu]
sensor_type = temperature_mcu
sensor_mcu = eddy
min_temp = 10
max_temp = 100

[temperature_sensor btt_eddy]
sensor_type = Generic 3950
sensor_pin = eddy:gpio26

[printer]
kinematics = corexy
max_velocity = 700
max_accel = 8200
max_accel_to_decel = 4500
max_z_velocity = 20
max_z_accel = 500
square_corner_velocity = 5.0

[stepper_x]
step_pin = PE2
dir_pin = !PE0
enable_pin = !PE3
rotation_distance = 40
microsteps = 16
full_steps_per_rotation = 200
endstop_pin = tmc2209_stepper_x: virtual_endstop
position_min = 0
position_endstop = 355
position_max = 355
homing_speed = 30
homing_retract_dist = 0
homing_positive_dir = True

[tmc2209 stepper_x]
uart_pin = PE1
interpolate = True
run_current = 1.1
sense_resistor = 0.150
stealthchop_threshold = 0
uart_address = 3
driver_sgthrs = 70
diag_pin = PE15

[stepper_y]
step_pin = PB8
dir_pin = !PB6
enable_pin = !PB9
rotation_distance = 40
microsteps = 16
full_steps_per_rotation = 200
endstop_pin = tmc2209_stepper_y: virtual_endstop
position_min = 0
position_endstop = 364
position_max = 364
homing_speed = 30
homing_retract_dist = 0
homing_positive_dir = true

[tmc2209 stepper_y]
uart_pin = PB7
interpolate = True
run_current = 1.1
sense_resistor = 0.150
stealthchop_threshold = 0
uart_address = 3
driver_sgthrs = 70
diag_pin = PE13

[stepper_z]
step_pin = PC0
dir_pin = PE5
enable_pin = !PC1
rotation_distance = 40
gear_ratio = 80:12
microsteps = 16
endstop_pin = probe:z_virtual_endstop
position_max = 347
position_min = -5
homing_speed = 15.0
homing_retract_dist = 5.0
homing_retract_speed = 15.0
second_homing_speed = 10.0

[tmc2209 stepper_z]
uart_pin = PE6
interpolate = true
run_current = 0.55
sense_resistor = 0.150
stealthchop_threshold = 999999
uart_address = 3

[stepper_z1]
step_pin = PD3
dir_pin = !PD1
enable_pin = !PD4
rotation_distance = 40
gear_ratio = 80:12
microsteps = 16

[tmc2209 stepper_z1]
uart_pin = PD2
interpolate = true
run_current = 0.55
sense_resistor = 0.150
stealthchop_threshold = 999999
uart_address = 3

[stepper_z2]
step_pin = PD7
dir_pin = PD5
enable_pin = !PB5
rotation_distance = 40
gear_ratio = 80:12
microsteps = 16

[tmc2209 stepper_z2]
uart_pin = PD6
interpolate = true
run_current = 0.55
sense_resistor = 0.150
stealthchop_threshold = 999999
uart_address = 3

[stepper_z3]
step_pin = PD11
dir_pin = !PD9
enable_pin = !PD12
rotation_distance = 40
gear_ratio = 80:12
microsteps = 16

[tmc2209 stepper_z3]
uart_pin = PD10
interpolate = true
run_current = 0.55
sense_resistor = 0.150
uart_address = 3
stealthchop_threshold = 999999

[thermistor my_thermistor_e]
temperature1 = 25
resistance1 = 110000
temperature2 = 100
resistance2 = 7008
temperature3 = 220
resistance3 = 435

[extruder]
step_pin = extra_mcu:PA8
dir_pin = extra_mcu:PB8
enable_pin = !extra_mcu: PB11
rotation_distance = 6.5
microsteps = 16
full_steps_per_rotation = 200
nozzle_diameter = 0.400
filament_diameter = 1.75
max_extrude_only_distance = 150
max_extrude_only_velocity = 15
max_extrude_cross_section = 5
heater_pin = extra_mcu:PB9
sensor_type = my_thermistor_e
pullup_resistor = 11500
sensor_pin = extra_mcu:PA5
min_temp = 5
max_temp = 305
max_power = 1.0
min_extrude_temp = 5
pressure_advance = 0.025
pressure_advance_smooth_time = 0.035
control = pid
pid_kp = 29.480
pid_ki = 2.656
pid_kd = 81.805

[tmc2209 extruder]
uart_pin = extra_mcu:PB10
interpolate = True
run_current = 0.8
uart_address = 3
sense_resistor = 0.150

[verify_heater extruder]
max_error = 120
check_gain_time = 30
hysteresis = 5
heating_gain = 2

[filament_switch_sensor filament_sensor]
pause_on_runout = True
event_delay = 3.0
pause_delay = 0.5
switch_pin = PE9

[thermistor my_thermistor]
temperature1 = 25
resistance1 = 100000
temperature2 = 50
resistance2 = 18085.4
temperature3 = 100
resistance3 = 5362.6

[heater_bed]
heater_pin = PA0
sensor_type = my_thermistor
sensor_pin = PC5
max_power = 1.0
min_temp = 5
max_temp = 105
control = pid
pid_kp = 64.154
pid_ki = 0.997
pid_kd = 1032.072

[verify_heater heater_bed]
max_error = 120
check_gain_time = 40
hysteresis = 5
heating_gain = 2

[probe]
pin = extra_mcu:PB6
x_offset = -17
y_offset = 10
z_offset = 2.412

[probe_pressure]
pin = ^!PE12
x_offset = 0
y_offset = 0
z_offset = 0
speed = 1.0

[bed_mesh]
speed = 350
horizontal_move_z = 5
mesh_min = 10,10
mesh_max = 333,340
probe_count = 11,11
algorithm = bicubic
bicubic_tension = 0.4
split_delta_z = 0.01
mesh_pps = 3,3
adaptive_margin = 5
fade_start = 0
fade_end = 10
fade_target = 0

[quad_gantry_level]
gantry_corners = 
	-60,-10
	410,420
points = 
	36,10
	36,320
	346,320
	346,10
speed = 350
horizontal_move_z = 5
retry_tolerance = 0.01
retries = 5
max_adjust = 10

[multi_pin fan_pins]
pins = extra_mcu:PA7, extra_mcu:PB1

[fan]
pin = multi_pin: fan_pins
max_power = 1.0
shutdown_speed = 0
kick_start_time = 0.5
off_below = 0.10

[controller_fan MCU_fan]
pin = PA1
max_power = 1
kick_start_time = 0.5
fan_speed = 1
idle_timeout = 300
heater = extruder, heater_bed
stepper = stepper_x, stepper_y

[heater_fan hotend_fan]
pin = extra_mcu:PA6
max_power = 1.0
kick_start_time = 0.5
heater = extruder
heater_temp = 50
tachometer_pin = extra_mcu:PA1
tachometer_ppr = 1
tachometer_poll_interval = 0.0013

[gcode_arcs]
resolution = 1.0

[output_pin Printer_Lights]
pin = PA3
pwm = 1
value = 1
cycle_time = 0.01
shutdown_value = 0

[temperature_sensor mcu_temp]
sensor_type = temperature_mcu
min_temp = 0
max_temp = 100

[temperature_sensor Host_temp]
sensor_type = temperature_host
min_temp = 0
max_temp = 110

[temperature_sensor Toolhead_Temp]
sensor_type = temperature_mcu
sensor_mcu = extra_mcu

[adxl345]
cs_pin = extra_mcu:PB12

[resonance_tester]
accel_chip = adxl345
probe_points = 
	175, 175, 30
accel_per_hz = 50
min_freq = 1
max_freq = 100
max_smoothing = 0.2
hz_per_sec = 0.5

[input_shaper]
damping_ratio_x = 0.001
damping_ratio_y = 0.001
shaper_type_x = mzv
shaper_freq_x = 35
shaper_type_y = mzv
shaper_freq_y = 35

[idle_timeout]
gcode = 
	_DEMON_IDLE_TIMEOUT
timeout = 3600

[exclude_object]

[bed_mesh default]
version = 1
points = 
	0.525938, 0.345938, 0.232500, 0.221250, 0.207188, 0.205313, 0.193125, 0.224063, 0.260625, 0.341250, 0.468750
	0.381563, 0.235313, 0.204375, 0.180938, 0.174375, 0.162188, 0.162188, 0.201563, 0.239063, 0.300000, 0.358125
	0.308438, 0.206250, 0.154688, 0.126563, 0.115313, 0.109688, 0.126563, 0.146250, 0.184688, 0.260625, 0.322500
	0.306563, 0.209063, 0.144375, 0.098438, 0.071250, 0.060000, 0.076875, 0.090938, 0.146250, 0.225938, 0.311250
	0.318750, 0.210938, 0.127500, 0.074063, 0.039375, 0.034688, 0.045938, 0.075938, 0.140625, 0.229688, 0.333750
	0.359063, 0.225000, 0.126563, 0.069375, 0.030000, 0.022500, 0.028125, 0.068438, 0.130313, 0.225938, 0.365625
	0.334688, 0.215625, 0.131250, 0.071250, 0.025313, 0.027188, 0.031875, 0.070313, 0.138750, 0.224063, 0.349688
	0.291563, 0.198750, 0.106875, 0.048750, 0.010313, -0.000937, -0.001875, 0.035625, 0.113438, 0.201563, 0.320625
	0.265313, 0.151875, 0.069375, 0.002813, -0.046875, -0.063750, -0.061875, -0.011250, 0.061875, 0.157500, 0.278438
	0.361875, 0.184688, 0.098438, 0.020625, -0.036562, -0.067500, -0.069375, -0.023437, 0.051563, 0.151875, 0.343125
	0.530625, 0.320625, 0.169688, 0.082500, 0.022500, 0.009375, 0.015938, 0.064688, 0.144375, 0.259688, 0.488438
x_count = 11
y_count = 11
mesh_x_pps = 3
mesh_y_pps = 3
algo = bicubic
tension = 0.4
min_x = 10.0
max_x = 332.9
min_y = 10.0
max_y = 340.0
=======================
Declaration of '__main' hides previous menuitem declaration
Declaration of '__main __tune' hides previous menuitem declaration
Declaration of '__main __tune __speed' hides previous menuitem declaration
Declaration of '__main __tune __flow' hides previous menuitem declaration
Declaration of '__main __sdcard' hides previous menuitem declaration
Declaration of '__main __control' hides previous menuitem declaration
Declaration of '__main __control __disable' hides previous menuitem declaration
Declaration of '__main __control __home' hides previous menuitem declaration
Declaration of '__main __control __move_10mm' hides previous menuitem declaration
Declaration of '__main __control __move_10mm __axis_x' hides previous menuitem declaration
Declaration of '__main __control __move_10mm __axis_y' hides previous menuitem declaration
Declaration of '__main __control __move_10mm __axis_z' hides previous menuitem declaration
Declaration of '__main __control __move_10mm __axis_e' hides previous menuitem declaration
Declaration of '__main __control __move_1mm' hides previous menuitem declaration
Declaration of '__main __control __move_1mm __axis_x' hides previous menuitem declaration
Declaration of '__main __control __move_1mm __axis_y' hides previous menuitem declaration
Declaration of '__main __control __move_1mm __axis_z' hides previous menuitem declaration
Declaration of '__main __control __move_1mm __axis_e' hides previous menuitem declaration
Declaration of '__main __control __move_01mm' hides previous menuitem declaration
Declaration of '__main __control __move_01mm __axis_x' hides previous menuitem declaration
Declaration of '__main __control __move_01mm __axis_y' hides previous menuitem declaration
Declaration of '__main __control __move_01mm __axis_z' hides previous menuitem declaration
Declaration of '__main __control __move_01mm __axis_e' hides previous menuitem declaration
Declaration of '__main __filament' hides previous menuitem declaration
Declaration of '__main __setup' hides previous menuitem declaration
Declaration of '__main __setup __tuning' hides previous menuitem declaration
Declaration of '__main __setup __restart' hides previous menuitem declaration
Declaration of '__main __octoprint' hides previous menuitem declaration
Declaration of '__main __temp' hides previous menuitem declaration
Declaration of '__main __filament __hotend0_target' hides previous menuitem declaration
Declaration of '__main __filament __loadf' hides previous menuitem declaration
Declaration of '__main __filament __loads' hides previous menuitem declaration
Declaration of '__main __filament __unloadf' hides previous menuitem declaration
Declaration of '__main __filament __unloads' hides previous menuitem declaration
Declaration of '__main __filament __feed' hides previous menuitem declaration
Hello from ProbeEddyNG
LDC1612ng btt_eddy oid: 1 i2c_oid 0
Using thermistor beta 4340.002 in heater heater_bed
Extruder max_extrude_ratio=2.078758
Config error
Traceback (most recent call last):
  File "/home/biqu/klipper/klippy/klippy.py", line 130, in _connect
    self._read_config()
  File "/home/biqu/klipper/klippy/klippy.py", line 127, in _read_config
    pconfig.check_unused_options(config)
  File "/home/biqu/klipper/klippy/configfile.py", line 497, in check_unused_options
    self.validate.check_unused(config.fileconfig)
  File "/home/biqu/klipper/klippy/configfile.py", line 446, in check_unused
    raise error("Option '%s' is not valid in section '%s'"
configparser.Error: Option 'pin' is not valid in section 'probe'
webhooks client 281473616803632: New connection
webhooks client 281473616803632: Client info {'program': 'Moonraker', 'version': 'v0.9.3-73-g5ee0adc'}
